  Woah, when did that flip happen. Mega oops.  <!-- Thanks for submitting a pull request! Please provide enough information so that others can review your pull request. The two fields below are mandatory. -->

**Summary**

Switch from Node 7 to Node 8 on all of our CIs.
I took the opportunity to refactor our failure tests to only include failure messages (`assert.doesNotThrow` now throws extra message without additional dot, they probably fixed a typo).

**Test plan**

CI green Nice! Thank you.  thanks @sandersky !  cc @kittens  If your config is not in the root of the project you must temporarily add `"rootDir": "../path/to/your/root"`. This is a known bug in current Jest version. See https://github.com/facebook/jest/issues/3613  `jquery-form` is looking for globally installed `$`. You must run `import $ from 'jquery'` before you import anything that runs it. You can try importing it from your setup file: http://facebook.github.io/jest/docs/configuration.html#setupfiles-array
And may also want to attach it to window like `window.$ = $` for some plugins I think.

Hope that helps, but if please be aware it's not a help forum here. If you don't get answers on Discord, try again, with better repro. Honestly this error of yours doesn't tell much without the code you're using.   Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!

**If you are contributing on behalf of someone else (eg your employer)**: the individual CLA is not sufficient - use https://developers.facebook.com/opensource/cla?type=company instead. Contact cla@fb.com if you have any questions. Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks!  jsdom is used automatically. Don't import it in your test.  Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!

**If you are contributing on behalf of someone else (eg your employer)**: the individual CLA is not sufficient - use https://developers.facebook.com/opensource/cla?type=company instead. Contact cla@fb.com if you have any questions. Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks!  When passed a snapshot file, Jest should print the correct test name related to it and run the proper tests.  We don't require `babel-polyfill` automatically any more because it lead to memory leaks. Please call it yourself in setupFiles.  How about
```js
.catch(done.fail)
```  i'm cleaning up Jasmine references form our codebase so it's easier to switch to another framework in the future. Can we call it `jest.setTimeout`? Actually, I'd be ok with `setTestTimeout`.  using `expect` api directly rather than through the jasmine alias  üëç  Are you gonna run these codemods at FB too? @cpojer i don't have a choice :)  See the top sentence here: http://facebook.github.io/jest/docs/en/cli.html#content

"Every one of Jest's Configuration options can also be specified through the CLI."  i think that's expected. since you first require your `./lib` file (that captures the value of `Object.create` at the moment when you require it) and then you try to mock your global variable (which should not change anything, since `globalScope` variable is already defined inside your `lib` module if you want to mock globals before you require the module you'll need to do something like this:
```js

beforeEach(jest.resetModules);

test('111', () => {
  global.myVariable = 111;
  const lib = require('./lib');
  // ...
});  Thank you!  I merged this even though it currently accesses some private fields. We already do duck-typing for the immutable types and that could change any time, the private fields aren't any different. However, it would be great if immutable had an official introspection API for debugging. If it does, or if it gets added, we should switch to that asap. yep, you are right. We are trying not to require immutable at all. If the introspective API was available through objects from immutable so we can avoid requiring immutable (or any one version of immutable) directly, then we can use them.  Hey! Would you like to implement it? It should be straight forward once you see how other Immutable entities are written. You'll find the code in plugins directory of pretty-format :)  Looks good to me.
```js
const ABRecord = Immutable.Record({a: 1, b: 2}, 'ABRecord');
prettyPrint(new ABRecord());
// => Immutable.Record "ABRecord" {a: 1, b: 2}
// or
// => Immutable.Record["ABRecord"] {a: 1, b: 2}
```
How about this?

Also I just checked out how it looks in [`pretty-immutable`](https://github.com/glenjamin/pretty-immutable/blob/f4dc6b09558721224ca383a74f2e8a1897cfa3c9/test/test.js), would go like: 
```js
const ABRecord = Immutable.Record({a: 1, b: 2}, 'ABRecord');
prettyPrint(new ABRecord());
// => Immutable.ABRecord {a: 1, b: 2}
```

Pick whatever makes more sense to you.  that's correct. it uses deep equality function to compare the values. good catch! thanks!
and for the strict equality, i honestly never felt a need in this matcher, but it's always possible to add a custom matcher that does that  <!-- 
THIS IS NOT A HELP FORUM. 
If you are experiencing problems with setting up Jest, please make sure to visit our Help page: 
https://facebook.github.io/jest/help.html
-->
<!-- 
Before creating an issue please check the following:
* you are using the latest version of Jest
* try re-installing your node_modules folder 
* run Jest once with `--no-cache` to see if that fixes the problem you are experiencing. 
-->

**Do you want to request a *feature* or report a *bug*?**
*bug*?

**What is the current behavior?**
When deleting something from the global `window` scope during 2 test runs, the behavior is different when using for example Node.js `7.4.0` _(2nd test passes)_ and `7.9.0`/`7.10.0` _(2nd test fails)_.

**If the current behavior is a bug, please provide the steps to reproduce and either a repl.it demo through https://repl.it/languages/jest or a minimal repository on GitHub that we can `yarn install` and `yarn test`.**
https://repl.it/IVBE/7

**What is the expected behavior?**
I don't know what the expected behavior should be, but I guess the one on newer Node.js versions where the second test is failing because the key was deleted seems to be the right one. That might not be even a Jest related issue, or an issue at all?

```
 FAIL  src\add-test.js
  ‚óè require ‚Ä∫ case 2

    TypeError: Cannot read property 'value' of undefined

      at Object.<anonymous> (src/add-test.js:12:28)
      at Promise.resolve.then.el (node_modules/p-map/index.js:42:16)
      at process._tickCallback (internal/process/next_tick.js:109:7)
```

**Please provide your exact Jest configuration and mention your Jest, node, yarn/npm version and operating system.**
Jest: `19.0.2` and `20.0.4`
Node.js: `7.4.0` (working) and `7.9.0`/`7.10.0` (not working) Have rewritten the example so that it really only focuses on the here stated problem.  hm.. that really depends on your configuration.
The function that defines whether the file should be instrumented or not is defined here https://github.com/facebook/jest/blob/master/packages/jest-runtime/src/shouldInstrument.js

i tried it locally (you can look at this commit https://github.com/dmitriiabramov/jest/commit/7fd98e6cab6e1054dbfe95cb93f4f8a699ac87e9) and it collected coverage
<img width="762" alt="screen shot 2017-05-29 at 2 40 33 pm" src="https://cloud.githubusercontent.com/assets/940133/26562638/e8d9a9e4-447c-11e7-954d-e331cea1df6a.png">


 Please note this issue tracker is not a help forum. We recommend using StackOverflow or our [discord channel](http://facebook.github.io/jest/en/help.html) for questions. Thank you :) @ljharb how are you testing it if it's not required?
 @ljharb ah.. i see. Yeah, that might be a bug.
we get the list of all files in the project from the haste map instance, and haste map only looks for file extensions specified in `moduleFileExtensions` config option. So for extensionless files it will not work out of the box.
The only thing i can think of is renaming the file to `.sh` and adding `sh` to the list of module file extensions in Jest config  This was an intentional behavior change. Please don't rely on `this` in your tests.  I would prefer to make this the default, but have a way to opt-out of the feature. The reason we need this not to fail at FB is because our internal test runner currently sees more tests than Jest sees, so it would invoke Jest on files that aren't actual tests. Do you mind inverting this and making the default throw?  Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!

**If you are contributing on behalf of someone else (eg your employer)**: the individual CLA is not sufficient - use https://developers.facebook.com/opensource/cla?type=company instead. Contact cla@fb.com if you have any questions. Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks!  Shouldn't this already work together? @rogeliog   Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!

**If you are contributing on behalf of someone else (eg your employer)**: the individual CLA is not sufficient - use https://developers.facebook.com/opensource/cla?type=company instead. Contact cla@fb.com if you have any questions. Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks! Thank you!  I apologize for the large PR. I spent 8 hours on the plane with no wifi :)

This PR replaces Jasmine with `jest-circus`

## why

Jasmine always made it hard for us to move fast. Since we don't own the codebase, it is hard to introduce new features, fix existing bugs, make design changes and just debug the code. On top of that Jasmine's codebase is not flow typed, which make the integration harder.


The goal of this PR is to replace Jasmine with a framework that mirrors the functionality, but at the same time simplifies the things as much as possible.

## Design
This new framework is built using FLUX architecture (pretty much Redux, but with mutable data).

- The core data model of this framework is located in `jest-circus/src/state.js` where it defines the initial state.
- The API is exposed in `jest-circus/src/index.js`
- None of the API functions work with the state directly, but rather dispatch actions that describe "what happened in the framework"
- everything that happens in the framework is handled in `jest-circus/src/eventHandler.js`
- Every piece of data that flows through the framework is typed and all types located here `jest-circus/types.js`


## Benefits of the approach
1. Preventing errors. We can be more strict in our test runners. For example here https://github.com/facebook/jest/blob/master/packages/jest-matchers/src/__tests__/toThrowMatchers-test.js#L114-L130 we define `it` inside another `it`. Jasmine won't even complain about it, and just skip this test, but in fact, after i fixed the definition of this test, i found that this test is actually broken. There is many other bad things that we'll be able to prevent during the runtime (examples are: nested before/after hooks, adding describe/test/beforeEach during the test run, etc...)

2. Debugging. Having a single event handler, we can add a single `console.log` statement to it and see everything what happens in our test run.
example:
<img width="726" alt="screen shot 2017-05-26 at 5 59 09 pm" src="https://cloud.githubusercontent.com/assets/940133/26516707/94af55d8-423f-11e7-811a-39a2409c2542.png">
Previously, every time we have a broken test that stalls i would spend hours trying to understand where exactly it happens.

3. Extensibility.  Because we don't have control over Jasmine, adding features to it is pain. Snapshot functionality is built on hacks and monkeypatches. And every new feature is harder and harder to add (we have a plan to introduce interactive snapshot updating). But with FLUX architecture all we need to do is to add another handler. e.g. snapshot logic looks like this right now:
```js
const {addEventHandler} = require('jest-circus');

const eventHandler = event => {
  switch (event.name) {
    case 'test_start': {
      setExpectState({currentTestName: getTestID(event.test)});
      break;
    }
    case 'test_success':
    case 'test_failure': {
      addSnapshotErrorsToTestResult(event.test);
      break;
    }
  }
};

addEventHandler(eventHandler);
```

## TODO:
All tests are currently passing.
To run the test suite with the new framework run:
```
./jest --testRunner '<rootDir>/packages/jest-circus/build/legacy_code_todo_rewrite/jest-adapter.js'
```

Although, there are a few cases that we don't have tests for that i still need to fix:

- [ ] Write better integration with the rest of Jest (remove/refactor old code in `legacy_code_todo_rewrite/` folder)
- [ ] Throw if `describe, test, beforeEach, ...` is used when the tests are already running
- [x] Add configurable timeouts
- [ ] add `console`, `sourceMap` values to `TestResult`
- [ ] Make sure all requires within framework are internal and required once per worker only when needed?
- [x] `test.concurrent`
- [x] filter tests when run with  `--testNamePattern`
- [x] snapshot files in tests aren't being cleaned up properly
- [x] Assertion counts




 Holy shit! This is really, really good. I think we'll probably need to roll this out incrementally. The testFramework option is already customizable but cannot be changed per-test. We could make it so that the framework can be configured within a test file (`@jest-test-runner <name>`) or using an array of globs in the config. What do you think?

More thorough review coming later this week.
 Yep, it'll get published separately. @yangshun thanks for catching that! > I spent 8 hours on the plane with no wifi

Oh man, all I do on planes is watch episodes of TV shows that I've already seen, and unsuccessfully try to sleep. You seem much more productive üòõ 

> Having a single event handler

Will this make it easier to attach custom reporters? For example, we're using an AppVeyor reporter to properly show test runs in AppVeyor: https://github.com/facebook/jest/blob/9b157c3a7c325c3971b2aabbe4c8ab4ce0b0c56d/testSetupFile.js#L15-L18. I guess removing Jasmine will mean we need to write our own reporters rather than reusing existing open-source Jasmine reporters, but this could tie in nicely with #3536 if we could ship said reporters out-of-the-box. @Daniel15 i haven't looked into how `jasmine-reporters` work yet, but i assume it reports (sends a POST request?) for each test file separately?

Because of the way we run tests in Jest (multiple files in parallel, which means multiple Jasmine instances in parallel) we have two layers that we can report from:
1. from a single test file. This will report info about how many tests passed/failed/skipped within a single `*-test.js` file.
2. from Jest process (aggregated results). This will report  the same data as # 1, but for each `-test.js`. So it'll report things like: how many tests failed/passed/skipped across all of `*-test.js` files, how many `*.-test.js` files sucessfully ran, how many `-test.js` files had failed test or execution failures.

I believe that 99% of the time we want to use the second type of reporting, and that was enabled by https://github.com/facebook/jest/pull/3349
I see reporting from Jasmine (or now `jest-framework`) to be useful mostly for debugging purposes. Like sticking a console.log into dispatcher and seeing what's going on in the run step-by-step @dmitriiabramov - looks like `jasmine-reporters`' AppVeyor reporter caches the results internally and batches them 50 at a time when calling AppVeyor's API: https://github.com/larrymyers/jasmine-reporters/blob/master/src/appveyor_reporter.js#L223-L225. On the other hand, the XUnit implementation does no batching and sends them one by one: https://github.com/xunit/xunit/blob/560c77c3a48571fef3e4f129d93107f57b673261/src/xunit.runner.reporters/AppVeyorClient.cs#L103

I agree with you - It might be easier to take the second approach you mentioned (processing the aggregated results). I completely missed #3349 - Thanks for the information! Sounds like we can already build these custom reporters even before switching away from Jasmine. @ArtemGovorov yeah! you'll definitely be able to hook into the framework. and probably even create an adapter that'll keep the interface consistent with all your custom reporters that you're using right now.

the only thing you won't get is the `actual`, `expected` objects, but this part wasn't being populated since we rewrote jasmine matchers (back in august 2016), so most likely it won't be a problem > probably even create an adapter that'll keep the interface consistent with all your custom reporters that you're using right now

This is a really good idea - Maintain backwards compatibility with Jasmine reporters by including an adapter that exposes the old Jasmine API. @ArtemGovorov oh wow! yeah, that totally makes sense. and yes, the `test_failed` event accepts a `Test` object that has `errors: Array<Exception>` property :) so it shouldn't cause you too much trouble!  Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!

**If you are contributing on behalf of someone else (eg your employer)**: the individual CLA is not sufficient - use https://developers.facebook.com/opensource/cla?type=company instead. Contact cla@fb.com if you have any questions. Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks! Thank you! That sounds good :)  restarted the build. it sometimes happens on node 4 :( Nice! This is better.  Yes, feel free to build this. There is jest-editor-support in this repo and vscode-jest which you can extend to add this feature. We will not build this feature at this time, sorry.  Unfortunately, this is not a help forum and there's too little information about the issue. 
Please setup a repro case and ask for help on forums listed here: https://facebook.github.io/jest/en/help.html
Closing. I can reopen if you can prove this is a bug. Repo or it didn't happen. I could triage this on UNIX and then ask for help on Windows (it may be Windows specific)  Please feel free to implement your own matcher with this feature using `expect.extend`.  Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!

**If you are contributing on behalf of someone else (eg your employer)**: the individual CLA is not sufficient - use https://developers.facebook.com/opensource/cla?type=company instead. Contact cla@fb.com if you have any questions. Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks! Thank you!  @sandersky you should update your `.gitconfig` to have your email :) or add it to your github profile  Nope, Jest will not look into `node_modules`, as by default this dir is included as `testPathIgnorePatterns`.  You can fork jest-environment-jsdom and build your own version of it that uses another version of jsdom :) Then use that using `testEnvironment`. @flaviut yes, Jest still supports Node 4, that's why we can't really use jsdom@10+. I'll close this issue, but will definitely revisit after we drop Node 4, probably near its EOL which is in a year.  Jest already can do that :). See http://facebook.github.io/jest/docs/en/expect.html#tobeclosetonumber-numdigits I don't see the reason we should add this kind of matcher, as this use case is very specific. 
And Jest also has `expect.extend` just for such occasions ‚Äî to create your own matcher, useful inside your tests.   Please note this issue tracker is not a help forum. We recommend using StackOverflow or our [discord channel](http://facebook.github.io/jest/en/help.html) for questions. Thank you :)  I don't think we'll support this for now as it doesn't seem like a necessary core feature. There is nothing that stops you from building your own wrapper for this feature, though :)  If you can think of any other valid example, you're more than welcome to do so! üôÇ  Just wait for @cpojer to review :)   Jest stays in this mode, that's normal. If you'd like to not run all the tests, press `o` once. Jest doesn't switch mode automatically.  This is not a help forum. Try running Jest once with `--no-cache` and make sure to upgrade to the latest version of Jest.  @jwbay thanks for looking into it!
@pedrombafonso move `identity-obj-proxy` to `moduleNameMapper` and it will work.  Run with --no-cache flag once.   thank you!  Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!

**If you are contributing on behalf of someone else (eg your employer)**: the individual CLA is not sufficient - use https://developers.facebook.com/opensource/cla?type=company instead. Contact cla@fb.com if you have any questions. thank you!  thank you!  <!-- Thanks for submitting a pull request! Please provide enough information so that others can review your pull request. The two fields below are mandatory. -->

**Summary**
I can fix spelling mistakes and I am a pro in git.

<!-- Explain the **motivation** for making this change. What existing problem does the pull request solve? -->

**Test plan**
I write perfect code, just kidding - there's nothing like that in the world.

<!-- Demonstrate the code is solid. Example: The exact commands you ran and their output, screenshots / videos if the pull request changes UI. -->
 Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!

**If you are contributing on behalf of someone else (eg your employer)**: the individual CLA is not sufficient - use https://developers.facebook.com/opensource/cla?type=company instead. Contact cla@fb.com if you have any questions. Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks! thank you!  thank you!  Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!

**If you are contributing on behalf of someone else (eg your employer)**: the individual CLA is not sufficient - use https://developers.facebook.com/opensource/cla?type=company instead. Contact cla@fb.com if you have any questions. thanks @msquaredh!
do you mind signing the CLA? Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks!  thank you!  Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!

**If you are contributing on behalf of someone else (eg your employer)**: the individual CLA is not sufficient - use https://developers.facebook.com/opensource/cla?type=company instead. Contact cla@fb.com if you have any questions. thank you!
@Damine0n do you mind signing the CLA?  you fixed them all! :)  Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!

**If you are contributing on behalf of someone else (eg your employer)**: the individual CLA is not sufficient - use https://developers.facebook.com/opensource/cla?type=company instead. Contact cla@fb.com if you have any questions. thank you!
@brad-kaiser can you sign the CLA? Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks!  thank you!  List of small tasks that we can work on during our OSS workshop (cc @caabernathy)
(i ran a spellchecker on Jest source code comment blocks)

| What to fix | Where to fix |
| - | - |
| typo: occured -> occurred | https://github.com/facebook/jest/blob/9b157c3a7c325c3971b2aabbe4c8ab4ce0b0c56d/packages/jest-cli/src/reporters/BaseReporter.js#L42 |
| typo: occured -> occurred | https://github.com/facebook/jest/blob/5f9c1f93ef88a2bc5c41c01613c5a0a03197b1d5/packages/jest-cli/src/TestRunner.js#L343 |
| typo: Vaidation -> Validation | https://github.com/facebook/jest/blob/2a0001d36b5b75be94bffcc8727a468921a94ee3/packages/jest-config/src/reporterValidationErrors.js#L22 |
| typo: retreive -> retrieve | https://github.com/facebook/jest/blob/005ac8c9e46996320c949a0107b57b2f12402bf3/packages/jest-config/src/vendor/jsonlint.js#L298 |
| typo: acccessors -> accessors | https://github.com/facebook/jest/blob/9b157c3a7c325c3971b2aabbe4c8ab4ce0b0c56d/packages/jest-editor-support/src/parsers/BabylonParser.js#L107 |
| typo: mulitple -> multiple | https://github.com/facebook/jest/blob/9b157c3a7c325c3971b2aabbe4c8ab4ce0b0c56d/packages/jest-editor-support/src/parsers/BabylonParser.js#L108 |  Does it happen on Jest v20? Reinstall node_modules and it should be fine   <!-- Thanks for submitting a pull request! Please provide enough information so that others can review your pull request. The two fields below are mandatory. -->

**Summary**

Bumps `jsdom` to latest version. 
However we may want to wait with this PR somewhere closer to Jest 21, upgrading JSDOM may potentially break peoples' tests.

**Test plan**

Nothing breaks We still support node4, jsdom10 dropped support for node4 so we cannot upgrade at this point. Oh snap... but we can revisit after Node4 EOL in early 2018 :D  This came out as one of the breaking changes during our internal refactor of Jasmine and is completely intentional. Use variables reassignment instead of relying on `this`. 
Wonder if we could codemod it? cc: @skovhus  Still doable:
```js
// We can have this as a helper function somewhere.
function useSinon(mySinon) {
    beforeEach(function() {
        mySinon = sinon.sandbox.create();
    })
    afterEach(function() {
        mySinon.restore();
    })
}

describe('feature', function() {
    let mySinon;
    // By calling useSinon in this level, each test case does not have to duplicate mocking.
    useSinon(mySinon);

    it('has mock support', function() {
        mySinon.stub(...);
        ....
    })
})
``` Thank you!  `document` is forbidden to be mocked with `jest.mock`. You can monkey-patch it in your test file or a setup file. Feel free to send a PR with the adjustments :)  Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!

**If you are contributing on behalf of someone else (eg your employer)**: the individual CLA is not sufficient - use https://developers.facebook.com/opensource/cla?type=company instead. Contact cla@fb.com if you have any questions. Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks! If you are using create-react-app, please do *not* install Jest manually. It is already part of CRA. Just run `yarn test` or `npm test`.  You use wrong regex. It should be:
```json
"transformIgnorePatterns": [
  "<rootDir>/node_modules/(?!lodash-es/)"
],
```  See http://facebook.github.io/jest/docs/en/cli.html#content and http://facebook.github.io/jest/docs/en/configuration.html#testmatch-array-string  
<!--
  0 failure: 
  1 warning:  Please ensure tha...
  
  
-->


<table>
  <thead>
    <tr>
      <th width="50"></th>
      <th width="100%" data-danger-table="true">Warnings</th>
    </tr>
  </thead>
  <tbody><tr>
      <td>:warning:</td>
      <td>Please ensure that <code>@flow</code> is enabled on: <a href='https://github.com/gaearon/jest/blob/node-path-fix/integration_tests/node_path/src/path/file.js'>integration_tests/node_path/src/path/file.js</a></td>
    </tr>
  </tbody>
</table>



<p align="right">
  Generated by :no_entry_sign: <a href="http://github.com/danger/danger-js/">dangerJS</a>
</p>
 Hm, what bothers me is that `integration_tests/__tests__/node_path-test.js` breaks `packages/jest-cli/src/reporters/__tests__/CoverageWorker-test.js` if ran first, like NODE_PATH would leak from `runJest` ü§î 
 This seems reasonable to me, please fix CI :) This is very much appreciated @gaearon. Thank you!  @orta mind making sure that `yarn lint` is successful?  I don't like that they are encoded there, but oh well. I don't think they'll change much.  You are using a buggy node.js version (around 7.3.0). Please upgrade it, that one isn't good.  It's unlikely that we'll be able to write documentation for this module at this point, I'm sorry. However, anything that we export from the code, you are free to use. If we end up changing the API, you'll notice when we release the next major release and we put it into our release notes normally :)  Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!

**If you are contributing on behalf of someone else (eg your employer)**: the individual CLA is not sufficient - use https://developers.facebook.com/opensource/cla?type=company instead. Contact cla@fb.com if you have any questions. Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks! You can configure the "haste" config option to add "platforms" manually:
```
"haste": {
  "platforms": [‚Ä¶]
}
```

that should work for you, no?  You'll need to pass it through `Handlebars.compile()` and then run assertions on returned object.
Also, please ask such questions on Stack Overflow or Discord, as this is issue tracker, not a help forum. 
Good luck! If you need to substitute `.hbs` files with a mock JS file, you should find this section helpful: http://facebook.github.io/jest/docs/en/webpack.html#handling-static-assets

With `testPathIgnorePatterns` you tell Jest not to treat `.hbs` files as test files (which is most likely already done). What you need to do is to _map_ `.hbs` file to something different, and the config option which allows you to do it is `moduleNameMapper`.  Can you provide a repro please?  The problem is that your test is likely setting up some intervals, network connections or db connections and you aren't shutting them down properly after your tests. Jest doesn't know how to clean those up for you. Seems like whatever you do in afterEach isn't doing enough.  Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!

**If you are contributing on behalf of someone else (eg your employer)**: the individual CLA is not sufficient - use https://developers.facebook.com/opensource/cla?type=company instead. Contact cla@fb.com if you have any questions. Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks!  If we want to do it, jest-docblock seems better tool to use. You can see how it's used with `testEnvironment`. 
Cc @cpojer  I don't think I'm interested in supporting this use-case. Importing via glob patterns is bad because you cannot statically analyze your dependencies. If your transforms aren't idempotent, then I suggest changing them in a way that makes them idempotent.  Can you check roughly which files are called and if there are duplicate calls? A repo where we could dive in would also be helpful. I'm curious on how it performs on clean project. 
But I have a feeling it may be connected to how many files Angular is calling during test bed initialization and resetting its modules on every beforeEach. 
Nevertheless there's probably an opportunity to improve this with some finer caching or memoization.  Yes, this is bad. We'd like to address this by building a high-performance version of resolve: #2925. Yeah this is definitely odd. Node's resolution algorithm is inherently slow because it goes to the filesystem a lot, but this seems excessive. We gotta replace `resolve`, especially since we know a lot of metadata about most files anyway. Closing this, but we shall discuss it further in #2925, is that ok @urish?  Thanks Eli!  `once` package is currently conflicting with one of the internal fb modules.
i think it's safe to remove it from here since we're only wrapping `resolve` and after a promise is fulfilled calling `resolve` results in noop.

cc @wtgtybhertgeghgtwtg  closing for now  Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!

**If you are contributing on behalf of someone else (eg your employer)**: the individual CLA is not sufficient - use https://developers.facebook.com/opensource/cla?type=company instead. Contact cla@fb.com if you have any questions. Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks! Thanks!  We could add prettier options!  Would be nice to get a repo with a repro! Change `node-modules` to `node_modules` üòâ   Yea, I think it makes sense to add such behavior on CI environments.  Would you mind providing a repo with this failing case of reading Jest config this way? As a workaround for now you may want to set `"rootDir": "../../"` or so. And it works when config is set from package.json? Hm, maybe one of your libs are conflicting with regenerator-runtime?   Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!

**If you are contributing on behalf of someone else (eg your employer)**: the individual CLA is not sufficient - use https://developers.facebook.com/opensource/cla?type=company instead. Contact cla@fb.com if you have any questions. https://xkcd.com/327/ I can understand that it may be confusing. I also think "Bobby Marley" is funny. I'll miss our little Bobby Tables though, farewell!  Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!

**If you are contributing on behalf of someone else (eg your employer)**: the individual CLA is not sufficient - use https://developers.facebook.com/opensource/cla?type=company instead. Contact cla@fb.com if you have any questions. Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks! Thank you!  Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!

**If you are contributing on behalf of someone else (eg your employer)**: the individual CLA is not sufficient - use https://developers.facebook.com/opensource/cla?type=company instead. Contact cla@fb.com if you have any questions. @rubenazevedoff I'm sad to tell this, but that's duplicate of https://github.com/facebook/jest/pull/3431 You made the pull request and I closed it, because there's #3431 already open. We can't keep 2 PRs fixing the same issue. Not sure if you missed this, but if there's a PR referencing the issue, it gets highlighted, like this:

<img width="790" alt="screen shot 2017-05-16 at 10 44 57" src="https://cloud.githubusercontent.com/assets/5106466/26097426/ccc8d5d4-3a24-11e7-9b73-29625ddbf6fe.png">

And before proposing your own fix, you need to check if someone else haven't tackled this earlier.  i wonder if it's related to this issue https://github.com/facebook/jest/issues/3186
where some of the modules were leaking from the outer scope of Jest (master process) hence shared between test runs. Core modules aren't created specifically for Jest, they are actually pulled in from the parent context. What I recommend you to do is `jest.mock('core-module')` and then call jest.resetModules() and re-require the world ‚Äì that should work? @kentcdodds it will preserve all methods and replace them with mock functions. I'd rather mock and reset it explicitly instead of doing it before every run.

However, to avoid such confusion, we _could_ reset all core module mocks before every test suite run. I think that's doable, but we may run into some quirks too. Something we would need to test very carefully.  See https://github.com/yarnpkg/yarn/pull/3401#pullrequestreview-38106823  What about creating a node module supporting that first? As soon as it gets stable enough we could merge it into Jest   What's the output of `jest --showConfig`?  <!-- Thanks for submitting a pull request! Please provide enough information so that others can review your pull request. The two fields below are mandatory. -->

**Summary**

Bump flow to latest version. Also turned on `strict_call_arity` to ease migration to 0.47.0 in the future (it will be turned on by default there). More details: https://github.com/facebook/flow/releases/tag/v0.46.0

**Test plan**

CI passes.
  You need to feed Resolver with some data in constructor (e.g. `moduleNameMapper` option). If you find this test hard to do, you can always write an integration test. When on your branch you should be good with:
```bash
git pull -r upstream master
```
Assuming `upstream` is the name of original Jest remote.
You can look it up with `git remote -v`. Exactly Meh, just push it then. Hey @lindgr3n, I've fixed some little nits and rebased your work on top of master properly, hope you don't mind. We still need to figure out why some errors are having duplicated messages, but it's definitely not in scope of this PR. 

You'll be better off to hard reset to this branch to avoid local conflicts: 
```
git reset --hard origin issue-1888
``` `git reset --hard origin/issue-1888` should fix that  Feel free to stamp it and @cpojer will merge soon. We could cut a patch release for that I think, but would need to double check for breaking changes  Yes we can do a patch with this tomorrow. Seems like this diff has lint errors, though. Can you fix them up and make CI pass? Although I'm not super happy we use a third party until just for that, but didn't have time to check what it does, maybe it's reasonable.  Yeah, it's only used in the test file ‚Äì can we inline it rather than adding a dependency?

Why can't we use `require('jest-regex-util').replacePathSepForRegex;` in the test as well? Can we just inline this in the test? The function is not needed outside the test itself.

Proposal:
* Inline the function.
* Run `yarn lint` locally and fix the CI issues.  Because of the way Lerna works, you need to now reset your lockfile and run yarn install from project root  This is the diff I get, when I run `yarn` on your repo:
```diff
diff --git a/packages/jest-runtime/yarn.lock b/packages/jest-runtime/yarn.lock
index c0121df..4eaff68 100644
--- a/packages/jest-runtime/yarn.lock
+++ b/packages/jest-runtime/yarn.lock
@@ -654,6 +654,13 @@ private@^0.1.6:
   version "0.1.7"
   resolved "https://registry.yarnpkg.com/private/-/private-0.1.7.tgz#68ce5e8a1ef0a23bb570cc28537b5332aba63ef1"

+proper-lockfile@^2.0.1:
+  version "2.0.1"
+  resolved "https://registry.yarnpkg.com/proper-lockfile/-/proper-lockfile-2.0.1.tgz#159fb06193d32003f4b3691dd2ec1a634aa80d1d"
+  dependencies:
+    graceful-fs "^4.1.2"
+    retry "^0.10.0"
+
 randomatic@^1.1.3:
   version "1.1.6"
   resolved "https://registry.yarnpkg.com/randomatic/-/randomatic-1.1.6.tgz#110dcabff397e9dcff7c0789ccc0a49adf1ec5bb"
@@ -713,6 +720,10 @@ require-main-filename@^1.0.1:
   version "1.0.1"
   resolved "https://registry.yarnpkg.com/require-main-filename/-/require-main-filename-1.0.1.tgz#97f717b69d48784f5f526a6c5aa8ffdda055a4d1"

+retry@^0.10.0:
+  version "0.10.1"
+  resolved "https://registry.yarnpkg.com/retry/-/retry-0.10.1.tgz#e76388d217992c252750241d3d3956fed98d8ff4"
+
 "semver@2 || 3 || 4 || 5", semver@^5.3.0:
   version "5.3.0"
   resolved "https://registry.yarnpkg.com/semver/-/semver-5.3.0.tgz#9b2ce5d3de02d17c6012ad326aa6b4d0cf54f94f"
``` As for destructuring, it doesn't seem to work very well (despite babel transform used, dunno) on Node 4, so we use `Array#concat` instead Let's just wait for @cpojer or @dmitriiabramov to review this :) hey @Vanuan! how did you test this?
i tried to stress test the transform logic (asynchronously write 100000 files) and wasn't able to reproduce.
This is probably the most annoying bug that i was never able to reproduce :)
my thought were that some of the OS have some kind of locks already that prevent this from happening and some of them don't i don't think coverage will be collected for this part, because most of the time we run Jest in subprocesses without any instrumentation  @Vanuan this won't work, because you have to build the project (run Jest code through Babel). What you need to do is to publish your npm package (change `"name": "jest"` to `"name": "Vanuan/jest"` or so). Yarn or npm, whatever: https://docs.npmjs.com/cli/publish  Looks good! I think you can safely add `node_modules/jest-validate` to `.flowconfig`'s ignore Do you mind rebasing? Thank you!  You either have to make them a test or ignore them. There are already features to do this, `testPathIgnorePatterns` like you pointed out, is one of them. I'm unsure what you are asking for. In your tests, you either have test files that run as tests or files that aren't tests that you should exclude using `testMatch` or `testPathIgnorePatterns`. What else could we possibly do? With Jest 20 you can use jest.config.js to compose configurations. That can also work for you.

________________________________
From: Donald Pipowitch <notifications@github.com>
Sent: Friday, May 12, 2017 12:21:32 PM
To: facebook/jest
Cc: Christoph Pojer; State change
Subject: Re: [facebook/jest] Can I configure "Your test suite must contain at least one test." so it not a failure? (#3558)


I'd like to share a common config over several projects at our company, but I don't want to be too restrictive about how they structure their code, but I also don't want them to maintain their own testPathIgnorePatterns. I could say prefix non-test files with an underscore, but that surely is something I need to explain.

In my experiences tests can often be restructured, are commented out, helper functions are extracted and so. This happens in a dynamic way which I can't predict a lot.

We had more strict file name patterns some years ago (with Angular and Karma) and it was more a hassle than useful.

(And as a personal opinion I'm not interested to know if a test file is empty or not. Someone could have written it('', () => {}) in it or whatever. I don't know if the test is good without looking into it.)

‚Äî
You are receiving this because you modified the open/close state.
Reply to this email directly, view it on GitHub<https://github.com/facebook/jest/issues/3558#issuecomment-301051539>, or mute the thread<https://github.com/notifications/unsubscribe-auth/AAA0KMAPOB_gsa7ZBchRCULeF9wvyAI2ks5r5EC8gaJpZM4NZIvw>.
    Not super sure, but this might get fixed with https://github.com/facebook/jest/pull/3554  This is great! Could you add an integration test in the integration_tests folder. this is awesome! thank you! 
i added a test here https://github.com/facebook/jest/pull/3557  _It's not a bug, it's a feature_. 
Seriously it is, Jest is not Jasmine and restricts context to test/before/after function scope. Use shared variables outside of test function scope.
```js
let hello;
beforeEach(function () {
  hello = 'hi';
});

afterEach(function () {
  console.log(hello);
});

describe('context', () => {
  it('should work', function () {
    console.log(hello);
  });
});
``` Apologies, we rewrote Jasmine and this happened as a result of that :(  **Do you want to request a *feature* or report a *bug*?**
Bug

**What is the current behavior?**
Tests pass on first run or with `--no-cache` flag, otherwise one of them fails.

**Repro**
See following issues for details:
1. https://github.com/facebook/jest/issues/2029
2. https://github.com/facebook/jest/issues/3550
  Thank you. This one totally happened to me *twice* :D  Looks like we hit similar problem as here: https://github.com/facebook/jest/issues/2029 Closing due to: https://github.com/facebook/jest/issues/3552  Does it happen on Jest@20?  Thanks @SimenB. This is great.  Can you provide a simple repro? ~So this seems like issue to be resolved by [`jsdom`](https://github.com/tmpvar/jsdom), can you describe it there?~
Missed that it's `--env=node`, so definitely unrelated to `jsdom`.  **Summary**

When publishing Jest 20, this was quite the funny error on CI ;)

**Test plan**

jest + when a version is published, this test won't fail.  Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!

**If you are contributing on behalf of someone else (eg your employer)**: the individual CLA is not sufficient - use https://developers.facebook.com/opensource/cla?type=company instead. Contact cla@fb.com if you have any questions. Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks!  

**Summary**

Exposes translated tagline on landing pages

**Test plan**

Verified by manually checking 'yarn test' build files for /index.html /en/index.html /pt-BR/index.html and /docs/pt-BR/timer-mocks.html  This should fix it: https://github.com/facebook/jest/pull/3538 (except for `testEnvironment` issue) Hm, not sure about that, we need to test nested configs more thoroughly after recent rewrite. 
In one project with config being in different dir than root, I had to explicitly set `"rootDir": "../path/to/root"`. So I'll keep this open.  That's a bug.  It can! Since jest 20 you can do:
```
jest --transform='{".*.js": "babel-jest"}'
```
You can also override any config option through CLI args now. Oh, now I see what you wanted to achieve. Nope, we're not going to support CLIs as transform value, it's just too much work supporting that. Having this as a module / function as it is now allows us to support every compile to js language out there. With CLI we're limited to a fixed set which we'd also had to maintain.  I agree, we aren't going to support this. You can wrap your binary in a js transformer.  

**Summary**

The Portuguese Brazilian community has worked hard to get the majority of translation work done! I am excited to switch this on!

**Test Plan**
This change enables the processing of pt-BR language files from Crowd In. No test is needed, but a manual check will be performed. üáßüá∑‚ù§Ô∏è!  <!-- Thanks for submitting a pull request! Please provide enough information so that others can review your pull request. The two fields below are mandatory. -->

**Summary**

Fixes regressions described in #3535 and #3499

**Test plan**

Update `normalize-test.js` accordingly.
  <!-- Thanks for submitting a pull request! Please provide enough information so that others can review your pull request. The two fields below are mandatory. -->

**Summary**

This PR adds support for absolute resolution of files with custom extension in haste packages.

Jest support so-called "haste packages" which allow to place `package.json` with a `name` property providing a custom namespace for modules inside directory it resides. Since resolution for these haste packages use `require.resolve`, it doesn't support absolutely resolving custom extensions, like `.ios.js` or `.android.js`, it's just working with `.js` files. 
Such resolution mechanism works in React Native, I think it would be nice for Jest to support it.

Fixes #3342.

**Test plan**

Integration test.
  Thank you! This is actually a regression and we'll fix it in a patch release. We should also fix that one, yes. Thanks for mentioning it. Fixed in the latest patch.  Hi!
Unfortunately this is not a help forum. Please ask such questions on StackOverflow or Reactiflux, you'll find details on our [Help](https://facebook.github.io/jest/en/help.html) page.

But just a quick look ‚Äì while using reducers to and pure components (without state) you're good to only test your reducers, no need to render component each time imo (but Flow should take care of props validation).  You see, the problems you're facing aren't coming from the testing framework but libraries you use, and probably lack of sufficient beginner-centric documentation on certain issues to overcome (if you have ideas on how to improve it for newcomers, please do so by creating an issue or, better, sending a PR to this library!). 

Programming, testing and learning new concepts in general _will_ be hard, especially when you start. We all just try to build tools that won't get you in the way too often.

Also, I see quite comprehensive responses to your questions on Reactiflux. Please note this is Open Source community and we try to help each other out as often as possible, but everybody is doing this in their free time ‚Äì no one is getting paid for 24/7 support, and only few fortunate ones do it as a day job. 

So please complain less, read more, and be grateful for all the time OSS community spends on building better software and fixing your issues for free. If this is something that would have helped you save some time, feel free to send them a PR with these adjustments, I'm sure they'll appreciate :)  Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!

**If you are contributing on behalf of someone else (eg your employer)**: the individual CLA is not sufficient - use https://developers.facebook.com/opensource/cla?type=company instead. Contact cla@fb.com if you have any questions. Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks!  This is a duplicate of (quite a long standing!) issue: https://github.com/facebook/jest/issues/1888.   I just wanna say, I love this idea. We should make this happen together with headless-chrome. In Jest 20, matchers can be async, using `await expect(Promise.resolve(foo)).resolves.toMatchImageSnapshot()` for example.  Would you like to improve the docs for that? :)
Until the next major release we can discuss if we'd like to change that behavior. What are your concerns?  See: https://github.com/facebook/jest/pull/3527#issuecomment-300144065 I think you could even copy the whole function for now. We just don't want `jest-config` to be dependent on rather unrelated `jest-matcher-utils` library.

@cpojer what do you think about extracting similar shared helper functions into `jest-helpers` or `jest-shared` package? This one should be jest-get-type or something? ;) We're OK with having a package for a single function?  yes, this is JavaScript. sindresorhus style, yea  Thanks! I'm going to merge this but at the same time, jest-config shouldn't import getType from matcher-utils. cc @thymikee.  It doesn't work this way in Jest 19 (at least for me). In which Jest version do you get `coverage.txt` report?
cc @dmitriiabramov  A repo with this working would be nice then :)   I think this is undocumented breaking change. We've redesigned script transformation and now it takes fourth parameter with `instrument` flag: 
```js
function process(src, path, projectConfig, {instrument: true) {
  // stuff
}
exports.process = process;
```  Would you be interested in sending PR with the enhancement? :)  What's exactly **broken**? Is the page not rendering, HTTP status code? Have tried it on 2 different machines with different OS languages and browsers, seems to be working fine.  Cannot repro, fails with exit code 1 for 3 different projects. Have you tried purging node_modules? cc @dmitriiabramov   You need to catch the error and call `done.fail()`. This is how it works :(
However this is not an issue, if you're returning a promise from test. 
See docs on that: http://facebook.github.io/jest/docs/en/asynchronous.html#promises  Seems like a nice enhancement, although we need to keep in mind this is a breaking change.  You are right! It should throw ‚Äì do you want to send a pull request for us? :)  Would you like to send a PR with a fix? üôÇ  @scottrangerio in `jest-regex-util` there's a `replacePathSepForRegex` function, I think you'll be better off using it :)

The test may be fixed with `slash`:
```js
const slash = require('slash');
expect(slash(argv.testPathPattern)).toMatchSnapshot();
```
We use it to normalize paths in tests on Unix/Windows platforms.  I don't think we'll add this; I prefer the ignore patterns to be explicit. You can put them into your Jest configuration. I understand keeping them in sync may not be awesome, but reading the patterns from multiple places is even more confusing.  Please read this comment on StackOverflow:
http://stackoverflow.com/a/23200062/6176714  <!-- Thanks for submitting a pull request! Please provide enough information so that others can review your pull request. The two fields below are mandatory. -->

**Summary**

While working on Angular integration I bumped into this issue: https://github.com/thymikee/jest-preset-angular/issues/30.
For some weird reasons (probably Zone.js) `error.message` is not present in `error.stack` for _some_ errors like it is normally on Node.

Turns errors with _malformed_ stack trace from this:

<img width="489" alt="screen shot 2017-05-08 at 11 55 06" src="https://cloud.githubusercontent.com/assets/5106466/25799436/3dcb5ff4-33e5-11e7-92ce-06b4aa7c64d5.png">

into this:

<img width="491" alt="screen shot 2017-05-08 at 11 55 11" src="https://cloud.githubusercontent.com/assets/5106466/25799443/4238c78e-33e5-11e7-9bc7-adba3b24e810.png">

**Test plan**

Integration test.
  Can you please provide a repro? I mean, it would be nice to have a repository where I could checkout and triage the issue :) This shouldn't be an issue unless you are using npm2, maybe.  Maybe just use [asymmetric matchers](http://facebook.github.io/jest/docs/expect.html#expectarraycontainingarray)?  You can use it, as long as you compare primitives. It's just as you said and it works this way: http://facebook.github.io/jest/docs/expect.html#tocontainitem. And changing it to work with objects would be a breaking change (there's a chance somebody relies on this strict comparison behaviour).
Just use `toContainEqual()`, it's made just for that case and it's not that hard to change, right?  So you should be able to hack it like that:
```js
expect.extend({
    toContain(collection, value) {
      // code for toContainEqual
    }
})
```
Implementation is [here](https://github.com/facebook/jest/blob/master/packages/jest-matchers/src/matchers.js#L403). 
And [here's](http://facebook.github.io/jest/docs/expect.html#expectextendmatchers) more on `expect.extend` Since Jest 20 you can use `this.equals`

Highly unstable solution, but it works:
```js
expect.extend({
  toContain(collection, value) {
    return require('jest-matchers/build/matchers.js').toContainEqual(
      collection,
      value
    );
  }
});

expect([{a: 'a'}]).toContain({a: 'a'});
``` Please don't overwrite `toContain`. We will not be renaming the matcher. @cpojer I guess this is about comparing Jest vs Karma+Jasmine and see what's faster/better, so I see it as a temporary hack. But obviously you're right!  <!-- Thanks for submitting a pull request! Please provide enough information so that others can review your pull request. The two fields below are mandatory. -->

**Summary**
This PR fixes a problem with the website's launching sequence on Windows when running `yarn start`. In some cases it seems to be necessary to replace the `\n` character with the OS' specific one through node's `os.EOL` constant because the `\r` character remains if just `\n` gets replaced on a Windows (10) machine.

The change in `feed.js` (`TypeError: Cannot read property '1' of null`) actually brings the site back up whereas the change in `convert.js` displays the blog post preview texts (not displayed without the change).

<!-- Explain the **motivation** for making this change. What existing problem does the pull request solve? -->

**Test plan**
N/A, only clicked it through on a Windows and Mac.

<!-- Demonstrate the code is solid. Example: The exact commands you ran and their output, screenshots / videos if the pull request changes UI. -->
 Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!

**If you are contributing on behalf of someone else (eg your employer)**: the individual CLA is not sufficient - use https://developers.facebook.com/opensource/cla?type=company instead. Contact cla@fb.com if you have any questions. Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks!    I prefer not to support chaining for now. The workaround sounds good to me; if you need the values multiple times, I recommend calling await on the actual thing rather than the matcher.  <!-- Thanks for submitting a pull request! Please provide enough information so that others can review your pull request. The two fields below are mandatory. -->

**Summary**
I have tried to edit an existing page in the documentation and landed on GitHub's 404 page because the edit link was missing the language code. This PR is adding those to problematic links.

_I have not touched any references in older blog posts or changelogs, but can also do this if you want._

As a side note it might be good to add canonical/hreflang tags to improve search engine indexing. At least a redirect from non-en to en might be helpful since these pages are now already indexed and users who come from there will still land on these pages _(the sidebar isn't fully rendered there for some reason)_.

<!-- Explain the **motivation** for making this change. What existing problem does the pull request solve? -->

**Test plan**
N/A

<!-- Demonstrate the code is solid. Example: The exact commands you ran and their output, screenshots / videos if the pull request changes UI. --> Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!

**If you are contributing on behalf of someone else (eg your employer)**: the individual CLA is not sufficient - use https://developers.facebook.com/opensource/cla?type=company instead. Contact cla@fb.com if you have any questions. Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks!  <!-- Thanks for submitting a pull request! Please provide enough information so that others can review your pull request. The two fields below are mandatory. -->

**Summary**

Currently the `this` context we're passing in `before/after` (although here `this` is undefined, and I didn't even try to investigate why) and `it/test` functions is preserved across consequent `test` runs, which makes it confusing to use (see #3505). 

As a workaround I propose passing empty object as a context for each function. This way we can still use `this` in `test` but it will be unique for each test function.

Fixes #3505.

**Test plan**

I'll add an integration test later, after we agree this is the right solution.
  Looks like a regression after rewriting our Jasmine bindings. 
As a workaround for now, don't use `this` in your tests or reset the values. It currently gets shared between functions in the same describe block, so your `this.instance = 'bar'` set in first test is preserved in a following one, where you assume it to be empty (that's why it pass as a single test).
 Closing, we'll discuss this in relevant PR.  cc @dmitriiabramov  Something similar happening here https://circleci.com/gh/thymikee/jest-preset-angular/79?utm_campaign=vcs-integration-link&utm_medium=referral&utm_source=github-build-link  There's new config option called [`mapCoverage`](http://facebook.github.io/jest/docs/configuration.html#mapcoverage-boolean) added to Jest 20, which takes care of source maps, e.g. for TypeScript transforms. Does that fix it for you? Awesome!  No, it was removed accidentally. Thanks for bringing it back!  Duplicate of https://github.com/facebook/jest/issues/3495
Will be fixed in next patch release. By this time please install `ansi-regex` explicitly.  Yes this is definitely a bug. We need to spend some time fixing up the new config resolution. Addressed in #3538   <!-- Thanks for submitting a pull request! Please provide enough information so that others can review your pull request. The two fields below are mandatory. -->

**Summary**

Fixes #3495 
 Thank you. We'll publish a patch release soon.   Ah, this is a good idea but I feel like we cannot do this. We use `retainLines: true` in babel to keep the line numbers roughly the same, which makes it a lot easier to debug built Jest code and mapping it to the real source.  <!-- Thanks for submitting a pull request! Please provide enough information so that others can review your pull request. The two fields below are mandatory. -->

**Summary**

Couple of stylistic adjustments to blog post and changelog. Also changed collapsing watch mode from bugfix to new feature.
  I'll fix this as soon as possible, for now please explicitly install this dependency.

________________________________
From: Blake Embrey <notifications@github.com>
Sent: Saturday, May 6, 2017 9:03:52 PM
To: facebook/jest
Cc: Subscribed
Subject: [facebook/jest] Missing dependency with v20 (#3495)


It looks like the dependency for https://github.com/facebook/jest/blob/a9fdec85651c5ed5d9fc67d11317aa12ba0663e1/packages/pretty-format/src/plugins/ConvertAnsi.js#L15 is missing with the latest release of pretty-format, which results in broken node 4 builds which use the non-flat dependency tree: blakeembrey/node-bit-string-mask#1<https://github.com/blakeembrey/node-bit-string-mask/pull/1>.

‚Äî
You are receiving this because you are subscribed to this thread.
Reply to this email directly, view it on GitHub<https://github.com/facebook/jest/issues/3495>, or mute the thread<https://github.com/notifications/unsubscribe-auth/AAA0KO3s4ECdMJ7K0rBTlO2U6A1-cpz0ks5r3MQYgaJpZM4NS30b>.
  Can you please bring back build to gitignore? It's hard to even scroll through so many lines and see what's changed in the source :( Thank you, it's much better now ‚ù§Ô∏è  This is really great and I'm all for this change. 
Some of the tests are failing, but I can see that's expected.

What's best ‚Äì I ran `yarn jest -- snapshot` (that's the quickest I got to successfully run all test suites):
* master:
<img width="288" alt="screen shot 2017-05-06 at 23 51 12" src="https://cloud.githubusercontent.com/assets/5106466/25776153/edb4c296-32b6-11e7-864b-0d5df0378ce6.png">

* this diff:
<img width="291" alt="screen shot 2017-05-06 at 23 51 06" src="https://cloud.githubusercontent.com/assets/5106466/25776154/f57c3856-32b6-11e7-9252-27a4ad3f4c86.png">

That's DOUBLE the speed, wow.
cc: @cpojer @zertosh  I have the worst Internet here in Berlin at JSConf but this is super duper awesome

One thought: can we somehow verify that we always apply this optimization? I would like us to codemod all of Jest to imports at some point and use the inline-imports transform then but we also need to make sure that once we do that, we aren't breaking this and slowing Jest down a lot. @SimenB mind sending me an email to cpojer@fb.com so I get your email address, I'd like to invite you to our #jest-core channel. You've been doing stellar work on this project and we appreciate it a lot.  Oh yeah, definitely gotta filter out that number. Silly issue :D Thanks for the PR.  i checked the raw `json` coverage, and it doesn't seem to be any different from older versions. Might be just a report generation issue.
see https://github.com/istanbuljs/istanbuljs/issues/51  Finally! Tag was published just now, sorry about that!  I'm sorry that you ran into an issue after you probably copy-pasted this piece of code. Thanks for sending us a PR to fix it for everyone else :)  Hmm, I'll take a look at this. This is how we generate the TOC. Perhaps the string got mangled. Closing for now.  Thanks! It looks to me like the pngs look quite pixelated. Is there a reason why it is that way? Meh, I think it's not that big deal   **Summary**

Localized base folders weren't being converted (es-ES).

Due to how files and folders get removed prior to building webpages the base localization folder wasn't being created prior to being converted into html. This PR aims fixes that.

**Test plan**

Run through build process, check that Spanish landing page loads.  **Summary**

This fixes configs, again. This is a can of worms, I'm unhappy about the new feature as much as I am happy about it :(

This has one behavior change:
* For running Jest in subfolders, it correctly prints the relative path for each test again.
* For running Jest in parent folders by traversing up the tree to find a package.json, it now shows relative paths for tests rather than the path from the root directory. I could argue both are ok and I may reconsider changing this again. Right now, I don't have enough time to find the one that makes the most sense, tbh.

**Test plan**

* `cd ../; jest --projects jest` works again.  Thanks @bclinkinbeard -- I'll be pushing some changes today to better integrate localization. this issue should go away once the build hits master and deploys. I'll check back and close once I verify. #3475 resolved this and properly publishes pages. Thanks for reporting!  Fixed.  **Summary**

When there was no cache, we failed to create a new cache object and instead created a new object for every call to `getCache` which means we'll never end up with a proper cache file. I didn't notice probably because when I built this, I had a valid cache file.

**Test plan**

* See newly added test  Ah, thank you so much! I noticed this today as well but didn't get a chance to fix it yet :) I need to revert this. The language metadata piece must be supplied to the routing logic otherwise they will be clashes in the lookup table. I'll submit a PR.  <!-- Thanks for submitting a pull request! Please provide enough information so that others can review your pull request. The two fields below are mandatory. -->

**Summary**

Make sure we don't render unnecessary whitespace between tags and around text nodes.

**Test plan**

jest
  Thanks! Instead of adding a config option, I would suggest you to simply wrap `babel-jest`. We will not be supporting babel specific configuration options in Jest.

Here is an alternative:
```js
//myTransformer.js
module.exports = require('babel-jest').createTransformer({plugins: myPlugins});
```

config:
```js
transform: {
  "‚Ä¶": "<rootDir>/myTransformer.js"
}
```

Thank you for your contribution though! I'm sorry that it doesn't fit into the overall architecture of Jest, though. Please don't let that discourage you to contribute in the future :) You can also simply use the `test` `env` in your babelrc for that and it will work just fine.   This integration test uncovered two bugs in total and I found a third one by probing around. Super useful, thanks @dmitriiabramov. Smart to name the folder `jest.config.js` to test whether Jest will read it ;) oh wow.i  actually broke something :) oh! hey @scamden! this is random üòÑ  
glad to see you here!

yeah, we don't run any transforms on config files. I think it's possible to do, although it'll add a significant overhead to startup time (require babel, parse, transpile, etc..)  Seems reasonable :) Published `jest@19.3.0-alpha.85402254` just for you. If I remember correctly, the problem is that `chalk` and `ansi-styles` assume they have `process` global available. This is how they handle it on Prettier docs (prettier uses `jest-validate` with `chalk` included) ‚Äì https://github.com/prettier/prettier/blob/master/docs/rollup.config.js.  
**Summary**

Fixes the dropdown box so it renders at proper location on web and mobile.  **Summary**

This allows `--projects` to take either a js file, a json file, a package.json file or any folder where it will traverse the tree to find a `jest.config.js` or `package.json` file. Also enabled me to roll up the function to find configs into a single one.

**Test plan**

* Tried it at FB.
* Modified `yarn test-examples` to have a mix of directory names and configs specified in `package.json`.
* Totally still needs an integration test. #yolo  Get the flow coverage up by adding types for `chalk` and friends.  We don't have any control over this because it is handled by istanbul and it seems like an issue exists on that tracker already.  **Summary**

This was previously exposed through `jasmine.matcherUtils.equals`. It's now part of the custom matcher API so that it can be used in libraries like Relay.

**Test plan**

See added test.  **Summary**

A recent crowdin change removed folder hierarchy of files causing duplicate files to be uploaded. This setting enabled it so files are stored properly.
 
**Test plan**

Verified locally.  Thank you!  You are right, snapshotting should not crash but the problem here is likely that Jest is inspecting something in the rendered component tree which, when accessed, produces an error. There is not really anything we can do about this and it is probably better to go hunting for the issue in the other library.  In Jest 20 you'll be able to define `jest.config.js` or pass a JS file to `--config` option. We target this week  Fixed on master, will be released soon in Jest 20.  Yes, just be a little more patient. It should happen in a week or so.  Thanks @SimenB and thanks @vjeux for the patch.  **Summary**

Moving the Languages drop down from far left.

**Test Plan**

Verified by building site locally.  Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!

**If you are contributing on behalf of someone else (eg your employer)**: the individual CLA is not sufficient - use https://developers.facebook.com/opensource/cla?type=company instead. Contact cla@fb.com if you have any questions. Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks!  No, there isn't. You'll find the list of all available matchers here: https://facebook.github.io/jest/docs/en/expect.html

You can also use plain JavaScript or helper library like `lodash` for that:
```js
test('name', () => {
  // array
  expect(Array.isArray(['value'])).toBe(true);
  // string
  expect(typeof 'value').toBe('string');
  // object
  expect({value: 'value'}).toBeTruthy();
  expect(typeof {value: 'value'}).toBe('object');
})
```  **Summary**

When running on a CI environment or with `--ci`, Jest will now refuse to write new snapshots. This is so that on CI, uncommitted snapshots will fail rather than pass by writing new files every time.

I introduced a `--ci` field and changed the `updateSnapshot` field into one of three states: `none`, `all` or `new`. None won't write any snapshot files, `all` will write all and clean snapshots up and `new` will only create new snapshots.

<img width="962" alt="screen shot 2017-05-03 at 8 18 33 pm" src="https://cloud.githubusercontent.com/assets/13352/25677440/dd695aee-303d-11e7-882c-2a1fa38ef880.png">

**Test plan**

* `jest` In the last commit, there are some unrelated changes because prettier was being funny. I think it's all fixed now and those are the properly printed values. Sorry for the churn there. It seems like you aren't adding snapshots to your CI and therefore using snapshots wrongly. The documentation is on the website: http://facebook.github.io/jest/docs/en/snapshot-testing.html#snapshots-are-not-written-automatically-on-continuous-integration-systems-ci  Fixes: https://github.com/facebook/jest/issues/3453

**Summary**

Defaults the string in sidebar to the one in the document's frontmatter. This will default rendering strings that haven't been included yet in the i18n/en.json file as English.  Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!

**If you are contributing on behalf of someone else (eg your employer)**: the individual CLA is not sufficient - use https://developers.facebook.com/opensource/cla?type=company instead. Contact cla@fb.com if you have any questions. Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks! Thank you!
  Ah thanks for finding this. This is a new page and needs an entry added to the en.json file with the page id and string (for localization). @bhongy https://github.com/facebook/jest/pull/3455 modifies the translation logic for the sidebar to use the existing metadata if a translation is missing, also added the string to translation file. Thanks for reporting this!
  Look over here: https://github.com/facebook/jest/pull/3421 In the next release of Jest, you can do `@jest-environment node` in the docblock header of your file.  Of course it is acceptable! :) 
<!--
  0 failure: 
  1 warning:  Changes were made...
  
  
-->


<table>
  <thead>
    <tr>
      <th width="50"></th>
      <th width="100%" data-danger-table="true">Warnings</th>
    </tr>
  </thead>
  <tbody><tr>
      <td>:warning:</td>
      <td>Changes were made to package.json, but not to yarn.lock - <i>Perhaps you need to run `yarn install`?</i></td>
    </tr>
  </tbody>
</table>



<p align="right">
  Generated by :no_entry_sign: <a href="http://github.com/danger/danger-js/">dangerJS</a>
</p>
 The node 7.3 thing, I don't care any more. That was reverted and we don't need it. We can tell people to either downgrade Jest or upgrade node if it happens.  You'll need to create your own mock for web workers. This is an unsupported feature and should either be part of your own mocks or part of jsdom, but not Jest. Feel free to make a mock and put it on npm for other people to use as well :)  **Summary**

This fixes `yarn test-examples` on master. Previously, it traversed up the tree until it found a jest config in package.json, now it stops when it finds a `package.json` as that can be considered the root of an app.

**Test plan**

`yarn test` works again. Tests to come in a follow-up, I just wanna unbreak master.  It really depends on your setup, but `this.resolve` actually does node resolution so that it can track dependencies within the system. For watch mode, it would be awesome if we could make this step incremental rather than process everything on every change. At Facebook, we are looking at similar times on a monorepo that is orders of magnitude bigger, so I'm a bit unsure what's causing the slow time for you.

Can you try to change Jest to turn this to true and see if that affects things: https://github.com/facebook/jest/blob/master/packages/jest-resolve/src/index.js#L138? We could take a look at this if you create a mock-repo on github where we could run Jest and test performance for ourselves.

Otherwise, we do have a plan to build a faster resolver, see #2925 for details, but there is no timeline attached to it. Would you be able to share the dependencies (relative paths as they are in `require`) with us? You can of course obfuscate the names a bit.

I'm not sure where you are getting n^2 from, it should be O(n*m) where n is the number of files and m is the avg number of dependencies per file, roughly. We should be able to speed it up by using more aggressive caching; as it stands it is doing too many filesystem reads, which is because of how the node resolution algorithm works :(

I'm assuming the reason why this is so much faster at FB is because we use global module ids (which is the point of jest-haste-map). ~95% of all dependencies are O(1) lookups Jest's ModuleMap.  **Summary**

New release with supposedly better printing.

**Test plan**

* `yarn test` I feel like there are some things that print worse than before, which is a shame, but there is no way to stop the prettier train, so we'll have to wait and see if the prettier team fixes some things for the next release.   Good work @dmitriiabramov.  In the interest of time, I made a few adjustments to ship this. Thanks @Xion.  Reverts facebook/jest#3416  Does it happen in v20? And have you tried it with watchman (`brew install watchman`)?  Any chance for a repro? It's hard to debug without it :(  @thymikee already sent a PR for this and we merged it!  <!-- Thanks for submitting a pull request! Please provide enough information so that others can review your pull request. The two fields below are mandatory. -->

**Summary**

Fixes flow typecheck

**Test plan**

yarn lint
 ![screen shot 2017-05-02 at 2 11 13 pm](https://cloud.githubusercontent.com/assets/13352/25619019/352176c0-2f41-11e7-8e0d-a80ec4df64b5.png)

<3  Could you please reset these lock files and run `yarn install` once more from project's root? 
We're using Lerna to link `packages` to themselves, thus linked packages are not visible in `yarn.lock`s. But if you run yarn from packages itself, then lockfile is updated like in your PR. This is probably something Lerna or Yarn Workspaces will need to fix in the future, but until then please only run `yarn` or `yarn install` from project root  Thanks @thejameskyle.

This is interesting. Could we instead fix babel-node? This package only works on node4+, which should have a correct Map/Set implementation and won't need the polyfill at all.

If you are running Jest, you shouldn't load babel-node ‚Äì is this for use outside of Jest? In that case, I'm ok merging this but please add a test. To make it into the next release, we'd need to merge this today or tomorrow :) You can do that in the test, though:

```
let prettyFormat;
beforeEach(() => {
  jest.resetModules();
  Map.prototype.toJSON = 'garbage';
  prettyFormat = require('prettyFormat');
});
```
 Closing due to inactivity, happy to merge this with a proper test.  This is great, but what about testing indentation (e.g. in CLI output)? I wonder if we could add options object as an argument for snapshot matchers, something like:
```js
expect(diff).toMatchSnapshot({whitespace: true});
``` Yeah, but I'm not so sure how to deal with it properly. It's still just a diff, so snapshots wouldn't be affected (on the filesystem), but it may be weird for user to see Jest tests passing and having whitespace differences in their commit. I mean this would require to be extra careful while giving code review. 
And for regular matchers, our whole test suite for `pretty-format` would become obsolete, because we test whitespace regular way, not with snapshots. Am I right?  Thanks for your PR! 
The test should compare 1 large string (eg. 'jest'.repeat(100000)) to smaller one, and two of similar sizes (something around 10000 chars each).   In Jest 20, we will be collapsing watch usage. In Jest 19 we added `--expand` for diffs. Are you using an earlier version than Jest 19? Yes it should, please give master a try! :) I'll close this issue but please feel free to let me know if I should reopen it once Jest 20 is out (soon!).  Hey @SimenB. I thought about this PR a bit over the past two days and have concluded that we shouldn't merge it. I think the maintenance cost is higher than the value it provides. For these functions, when they are invoked improperly, Jest will simply throw and crash the test. I think that is ok.

The alternative here is to surface such mistakes earlier but at the cost of us having to maintain this API changes in two places. I'd prefer to not take on this cost right now but I'm happy to consider different viewpoints and may reopen if you feel strongly that we should do this.  I made a few small adjustments but this is great, thanks for the help @MicheleBertoli.  <!-- Thanks for submitting a pull request! Please provide enough information so that others can review your pull request. The two fields below are mandatory. -->

**Summary**

This PR aims to refactor how we translate config from CLI.

Notes:
* Set default CLI boolean options to `undefined`, so yargs doesn't default them to `false` (defaults are handled in `defaults.js` so I put `watchman` and `cache` there)
* Thanks to that `setFromArgv` is now more generic, translating any value (with some exceptions) to new config _before_ normalizing (makes some weird hacks around config/argv unnecessary).
* Renamed `setState` within `jest-cli` to `updateArgv` because that's what it does.
* Types within `normalize` are a bit loosened now (they didn't really work fully, which we need to update in a followup)

Fixes #3403.

**Test plan**

jest
 I'm still planning more testing for this tomorrow, forgot to mention that. Right now I just wanted to have feature parity. Thanks for looking into it!  @thymikee this is super awesome, I didn't think we'd get this done before Jest 20. I really appreciate you taking this on and will give a more thorough review tomorrow.

One thing that I like about all of the rewrites we did for Jest 20 is that the entire codebase became a lot more approachable and everything makes much more sense. We now have a clear flow from:

DefaultOptions + User specified options + Argv -> InitialOptions -> ProjectConfig & GlobalConfig

That's beautiful. @cpojer Addressed all the requests
@SimenB can you test it now? YES. Great work @thymikee.  Seems like this one conflicts with pretty much everything, so we'll need to redo this PR :( Woohoo, thanks!  Thanks! I simplified it a little bit to only include the minimal info.  
<!--
  0 failure: 
  1 warning:  Changes were made...
  
  
-->


<table>
  <thead>
    <tr>
      <th width="50"></th>
      <th width="100%" data-danger-table="true">Warnings</th>
    </tr>
  </thead>
  <tbody><tr>
      <td>:warning:</td>
      <td>Changes were made to package.json, but not to yarn.lock - <i>Perhaps you need to run `yarn install`?</i></td>
    </tr>
  </tbody>
</table>



<p align="right">
  Generated by :no_entry_sign: <a href="http://github.com/danger/danger-js/">dangerJS</a>
</p>
 I'm holding off on this one right before Jest 20 but it'll be one of the first PRs after that release I'm gonna look at :) Let's do it! #yolo

@skovhus what are the next steps? How close are we to renaming Jest matchers to expect? @skovhus I published jest@19.2.0-alpha.993e64af which is the latest version of master. It should be auto loaded by Jest  Oh, right. In this case you need to add regenerator runtime to global scope as @SimenB said.  Could you explicitly add regeneratorRuntime to the deps of the project you are testing and see if that unblocks you? It's already in deps, as that project uses npm 4. He needs to require/import it. @thymikee really? Is it part of installing `jest-matchers@19.2.0-alpha.993e64af`? Looks like this. Apparently we use `async/await` syntax somewhere in `jest-matchers` and the regenerator is not called there (because we add it to require queue in normalization step). That project only use `jest-matchers`. Totally agree, we should find a way. @skovhus there's only [one place](https://github.com/facebook/jest/blob/master/packages/jest-matchers/src/index.js#L132), so that's doable. We should also write an eslint rule which would forbid to use async there. https://twitter.com/left_pad/status/860193246852648960 ?  Yeah, we should do this. Make an async "setup" function in both TestEnvironment's and wait for it in the code. If you can send a PR tomorrow, we can include it into Jest 20. Ideally we would change it to async, in v20 or v21. If we can't get it into 20, we may release a minor version with 2 possible ways, along with proper depreciation warning.   I would keep the constructor, you can't get rid of a constructor anyway and add the setup function as an optional hook. If the function is present, call it and wait for the promise to resolve. If it isn't there, just do what we do now.  Can you let us know what `console.log(require.resolve('cliui'))` in your test outputs? This seems like an odd test. Do you have a repository that we can install and see this error?  <!-- Thanks for submitting a pull request! Please provide enough information so that others can review your pull request. The two fields below are mandatory. -->

**Summary**

Couple of files were not covered by Flow (took them from https://github.com/facebook/jest/issues/3169 but not all)

**Test plan**

CI
 Nice! Increasing flow coverage is super rewarding long term.  **Summary**

This PR adds Localization support for Jest.

**Test plan**

This PR includes changes to circle.yml that tests the website build process.

Once tests pass, the lines will be removed, and the test lines will be removed.

I was able to login to an SSH CI session and simulate the CrowdIn upload, download, and website build steps. 
<!--
  2 failure:  New JS files do n..., Please ensure tha...
  1 warning:  Please ensure tha...
  
  
-->

<table>
  <thead>
    <tr>
      <th width="50"></th>
      <th width="100%" data-danger-table="true">Fails</th>
    </tr>
  </thead>
  <tbody><tr>
      <td>:no_entry_sign:</td>
      <td>New JS files do not have the Facebook copyright header: <a href='https://github.com/ericnakagawa/jest/blob/master/website/core/JestHelp.js'>website/core/JestHelp.js</a>, <a href='https://github.com/ericnakagawa/jest/blob/master/website/core/JestIndex.js'>website/core/JestIndex.js</a>, <a href='https://github.com/ericnakagawa/jest/blob/master/website/core/JestUsers.js'>website/core/JestUsers.js</a>, <a href='https://github.com/ericnakagawa/jest/blob/master/website/core/Thing.js'>website/core/Thing.js</a>, <a href='https://github.com/ericnakagawa/jest/blob/master/website/languages.js'>website/languages.js</a>, <a href='https://github.com/ericnakagawa/jest/blob/master/website/server/translationPre.js'>website/server/translationPre.js</a>, <a href='https://github.com/ericnakagawa/jest/blob/master/website/src/jest/en/help.js'>website/src/jest/en/help.js</a>, <a href='https://github.com/ericnakagawa/jest/blob/master/website/src/jest/en/index.js'>website/src/jest/en/index.js</a>, <a href='https://github.com/ericnakagawa/jest/blob/master/website/src/jest/en/support.js'>website/src/jest/en/support.js</a> and <a href='https://github.com/ericnakagawa/jest/blob/master/website/src/jest/en/users.js'>website/src/jest/en/users.js</a></td>
    </tr>
  
<tr>
      <td>:no_entry_sign:</td>
      <td>Please ensure that <code>'use strict'</code> is enabled on: <a href='https://github.com/ericnakagawa/jest/blob/master/website/core/JestIndex.js'>website/core/JestIndex.js</a>, <a href='https://github.com/ericnakagawa/jest/blob/master/website/core/JestUsers.js'>website/core/JestUsers.js</a>, <a href='https://github.com/ericnakagawa/jest/blob/master/website/core/Thing.js'>website/core/Thing.js</a>, <a href='https://github.com/ericnakagawa/jest/blob/master/website/languages.js'>website/languages.js</a>, <a href='https://github.com/ericnakagawa/jest/blob/master/website/src/jest/en/help.js'>website/src/jest/en/help.js</a>, <a href='https://github.com/ericnakagawa/jest/blob/master/website/src/jest/en/index.js'>website/src/jest/en/index.js</a>, <a href='https://github.com/ericnakagawa/jest/blob/master/website/src/jest/en/support.js'>website/src/jest/en/support.js</a> and <a href='https://github.com/ericnakagawa/jest/blob/master/website/src/jest/en/users.js'>website/src/jest/en/users.js</a></td>
    </tr>
  </tbody>
</table>


<table>
  <thead>
    <tr>
      <th width="50"></th>
      <th width="100%" data-danger-table="true">Warnings</th>
    </tr>
  </thead>
  <tbody><tr>
      <td>:warning:</td>
      <td>Please ensure that <code>@flow</code> is enabled on: <a href='https://github.com/ericnakagawa/jest/blob/master/website/src/jest/en/help.js'>website/src/jest/en/help.js</a>, <a href='https://github.com/ericnakagawa/jest/blob/master/website/src/jest/en/index.js'>website/src/jest/en/index.js</a>, <a href='https://github.com/ericnakagawa/jest/blob/master/website/src/jest/en/support.js'>website/src/jest/en/support.js</a> and <a href='https://github.com/ericnakagawa/jest/blob/master/website/src/jest/en/users.js'>website/src/jest/en/users.js</a></td>
    </tr>
  </tbody>
</table>



<p align="right">
  Generated by :no_entry_sign: <a href="http://github.com/danger/danger-js/">dangerJS</a>
</p>
 @ericnakagawa let me know when this is ready to merge :) Alright, let's give this a go.  Thank you!  Duplicate of #2059.  Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!

**If you are contributing on behalf of someone else (eg your employer)**: the individual CLA is not sufficient - use https://developers.facebook.com/opensource/cla?type=company instead. Contact cla@fb.com if you have any questions. Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks! Thanks for your contribution, this is great.  **Summary**

This is a follow-up to @dmitriiabramov's PR from an open source contributor.

* `onRunComplete` has to be run sequentially, not concurrently so that we always print messages in the same order.
* Add ability to run untested coverage in-band when workers is <= 1.
* `--bail` also has to wait for the response from reporters before continuing with the test run, otherwise tests will run while it tries to clean up.
* Fixed up code style.

**Test plan**
jest  <!-- Thanks for submitting a pull request! Please provide enough information so that others can review your pull request. The two fields below are mandatory. -->

**Summary**

Fixes #3409.

**Test plan**

Add new test for object without a prototype.
 Nice one!  <!-- Thanks for submitting a pull request! Please provide enough information so that others can review your pull request. The two fields below are mandatory. -->

**Summary**

Bumps flow to the latest version.
They said something about perf wins in 0.43.1 and 0.44, but it actually takes 2s more for `flow check` now :(

**Test plan**

flow
  based on https://github.com/facebook/jest/pull/3309
i had to resolve some conflicts (multi runner/config splitting touched the same files)    You're right, docs should add the same note about `babel-jest` ‚Äì would you like to send a PR? üôÇ 

To make it opt-in, just define empty `"transform": {}` property. We cannot change that behavior, as it would break out-of-box babel integration, which we don't want to happen.  The Localization step caused a breakage in the main website. This reverts Localization effort.

I will submit a new PR with full confirmation that crowdin sync and website build step succeeds as expected.

There were several PRs merged throughout my commits. Three files that had clashes were:

packages/jest-runtime/src/shouldInstrument.js
packages/babel-jest/src/index.js
packages/jest-cli/src/runJest.js

Please review that these three files are as expected after the revert.  - [x] Write changelog.
- [x] Write Blog Post.
- [x] Add talk videos to website.
- [x] Write documentation for `--projects`.
- [x] Write documentation for new CLI behavior.
- [x] Get ready to present at JSConfEU.
- [x] Test compatibility with React/Relay/FB.  **Summary**

As discussed in the team meeting today, this makes the `--project` option work via the cli or `"project"` via the configuration system. It uses globs as well, so many projects can easily be specified.

I will send a follow-up PR with a test for the config option but I'm quite a bit tired right now ;)

**Test plan**

Add 
```js
"projects": [
  "<rootDir>"
  "<rootDir>/examples/react*",
  "<rootDir>/examples/snapshot"
],
```

into the top level packag.json and it will actually, really, work. Amazing.  **Summary**

Fixes https://github.com/facebook/jest/issues/3284 by not bypassing the user defined transform pipeline.

This also enables proper typing for pretty-format plugins within the Jest repo and stops reaching into `build` files, which Jest should never do, by exporting the plugins directly.

**Test plan**

jest  **Summary**

This makes dynamic requires be typed properly and connects different packages in Jest better.

**Test plan**

flow  **Summary**

No reason not to use yarn properly for these. cc @dmitriiabramov 

**Test plan**

jest command should be faster on the Jest repo. It saves about 13 seconds. i feel like that might introduce some issues in future :( It's no different from any other dependencies in the project and we manage them all with Yarn. The only other solution I recommend is to hoist the deps to the top level like we do for examples and not run yarn at all within the integration test folders. What do you think? is there a way to setup recurring task of updating dependencies? we can do it for packages, examples and integration tests together (Dmitrii said it was fine to merge this)  **Summary**

@jeanlauliac pointed out that it is confusing that yarn prints "Done in *time*" multiple times because all our scripts invoke Yarn. @bestander recommended adding `--silent`. It makes the `package.json` file bigger but the output more sane.

**Test plan**
* Run all the commands from scripts
* Wait for CI 
<!--
  0 failure: 
  1 warning:  Changes were made...
  
  
-->


<table>
  <thead>
    <tr>
      <th width="50"></th>
      <th width="100%" data-danger-table="true">Warnings</th>
    </tr>
  </thead>
  <tbody><tr>
      <td>:warning:</td>
      <td>Changes were made to package.json, but not to yarn.lock - <i>Perhaps you need to run `yarn install`?</i></td>
    </tr>
  </tbody>
</table>



<p align="right">
  Generated by :no_entry_sign: <a href="http://github.com/danger/danger-js/">dangerJS</a>
</p>
  Added missing crowdin.yaml configuration environment variable.  Working to resolve this right now. PR is here: https://github.com/facebook/jest/pull/3395 This still didn't solve the issue so I am reverting.  Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!

**If you are contributing on behalf of someone else (eg your employer)**: the individual CLA is not sufficient - use https://developers.facebook.com/opensource/cla?type=company instead. Contact cla@fb.com if you have any questions. Thank you! I don't think that's the correct prettier update. Do you mind running `yarn` and reverting the change to babel-jest? Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks! Thank you!  This issue got introduced by #3327 

**Summary**

The position of the cursor is wrong in some terminals like Terminal.app, but not in other terminals that do support clearScreen

**Test plan**

Here is the before and after
![filters-issue](https://cloud.githubusercontent.com/assets/574806/25506777/2a124a80-2b5d-11e7-8d93-69ffabd00d13.gif)
 I trust you that this makes sense.

![5399f8caf0a80d8c9eb95c941e10d3eae4f3242712bdbde58d6deac99babe7ec](https://cloud.githubusercontent.com/assets/13352/25508455/12296df2-2baa-11e7-8a0d-335f162a45b6.jpg)
  You are right, we should actually be using `~` for all deps. Seems like the folks on lerna recommend against this. https://github.com/lerna/lerna/issues/76#issuecomment-193000680

If you'd like a specific version of Jest, install `jest-cli`. The reason we have this split is because we didn't own `jest` in the past and we simply made it to forward. You can also install `jest-cli` directly if you'd like. Got it. I'm sorry for causing you churn. That particular breaking change happened accidentally because node.js made a breaking change two days before Christmas and I was on vacation trying to push out a hotfix, which accidentally published a change that shouldn't have gone out. We normally don't do this ;) Oh... dependencies.  Have been having an issue where the website build step does not run unless deployed on a master branch.

I have moved the website build code into the test step to allow final configuration changes to the website build process.

Please do not accept this PR until then.

Update: Build properly configured.  **Summary**

On top of https://github.com/facebook/jest/pull/3376, this now finalizes the split of "InitialOptions" into "ProjectConfig" and "GlobalConfig". The only overlap between the two is `rootDir`, which should be alright. I have about five more PRs coming that clean up various things, but this one makes everything that is tested by Jest work. I'm sure I missed one or two things that aren't properly typed, but we have a fully week to stabilize this :)

**Test plan**

jest
  Fixes #2589  

This puts a lot of the typeahead logic inside the prompt class, but we should move it to a typeahead module eventually.

Still needs to be tested in Windows and other terminals

We still need to do all of these as part of a follow up PR
- [x] Clean up a lot of the code
- [x] Extract  all the scrolling logic into its own typeahead component.

**Summary**
Also, do we even want to move forward with this?

![filters-2](https://cloud.githubusercontent.com/assets/574806/25493784/2ffe1d2e-2b2c-11e7-9e03-085b539c37ff.gif)
 Yes! It looks awesome  
<!--
  2 failure:  New JS files do n..., Please ensure tha...
  0 warning: 
  
  
-->

<table>
  <thead>
    <tr>
      <th width="50"></th>
      <th width="100%" data-danger-table="true">Fails</th>
    </tr>
  </thead>
  <tbody><tr>
      <td>:no_entry_sign:</td>
      <td>New JS files do not have the Facebook copyright header: <a href='https://github.com/rogeliog/jest/blob/add-arrows-to-typeahead/packages/jest-cli/src/lib/__tests__/scrollList-test.js'>packages/jest-cli/src/lib/__tests__/scrollList-test.js</a></td>
    </tr>
  
<tr>
      <td>:no_entry_sign:</td>
      <td>Please ensure that <code>'use strict'</code> is enabled on: <a href='https://github.com/rogeliog/jest/blob/add-arrows-to-typeahead/packages/jest-cli/src/lib/__tests__/scrollList-test.js'>packages/jest-cli/src/lib/__tests__/scrollList-test.js</a></td>
    </tr>
  </tbody>
</table>




<p align="right">
  Generated by :no_entry_sign: <a href="http://github.com/danger/danger-js/">dangerJS</a>
</p>
 This is really fantastic. There is one bug that we found about the arrow selection scrambling the results but other than that it looks really solid. There are a few more things we could do, like using composition instead of inheritance and some stricter flow types (ie. not using Function) but given that we are pressed on time here, I would suggest merging it after fixing the one bug and then, if we have time, improving it further once @rogeliog is back. @thymikee and @rogeliog both, this is awesome.  @ericnakagawa it seems like this PR: https://github.com/facebook/jest/pull/3372/files#diff-61879546a4ef93f654f1883d00f827dd modified the favicon. Do you mind reverting that change and sending a PR? Sorry I missed it. I'll take a look at this. I have a modified an actual favico.ico in my next PR. I'll take a look at the page's meta info.  Thanks, that makes sense :)  On last master build, crowdin-cli could not access the ENV variable CROWDIN_API_KEY. I was able to workaround this by replacing the two yarn commands ("yarn crowdin-upload" and "yarn crowdin-download") in circle.yml with their full commands. Let's see if this one works. Ok, I'm going to rearrange the circle.yml and have the build step run in the next PR, versus master. I'll give you a heads up once all changes are made so that it succeeds.  There's no such version as `19.2.1` for `jest-cli`.
What does it mean that "jenkins crash during the build project". How is build connected to running tests? What's the error message? 
Also, I think you forgot to provide a repro which you're describing. Would you mind providing that? :) No need for me to see your private code, just a minimal case so we can repro, although I don't have experience with Jenkins so it would be problematic to setup whole thing on my machine.

What you can try (just to test it) is to run `npm test -- --forceExit` or you can split your tests and run them under separate commands, maybe there's something in your code which causes problems. So maybe that's something with the version of enzyme and e.g. `enzyme-to-json` you use. Hard to tell without an example.  **Summary**

In the interest of time, I skipped CI on @jeanlauliac's diff. I fixed it up to make flow and eslint happy. We need to ship this at FB asap.

**Test plan**

jest This was published as jest-config 19.0.3 on this branch: https://github.com/facebook/jest/tree/jest-config-19-0-3  cc: @mxstbr  Alright, I fixed everything up and made the flow typing a bit better so that all of this is actually working properly :) @SimenB yes! @anilreddykatta do you wanna send a PR for the eslint plugin change? :)  Thank you for your pull request. We require contributors to sign our Contributor License Agreement, and yours has expired.

Before we can review or merge your code, **we need you to email cla@fb.com** with your details so we can update your status. Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks! We actually have a lint rule in `eslint-plugin-jest` that prevents you from having two tests with the same name. I recommend using that instead ‚Äì will that work for you? Actually what's wrong with adding just one extra property?  You can have the same test name but not within the same describe block, of course.

________________________________
From: Jordan Harband <notifications@github.com>
Sent: Friday, April 28, 2017 5:57:08 PM
To: facebook/jest
Cc: Christoph Pojer; State change
Subject: Re: [facebook/jest] Include fullName in formattedAssertion (#3378)


(To clarify; I'm saying that requiring "it"s to be unique makes no sense and runs counter to the entire point of BDD-style test frameworks like jasmine, jest, and mocha)

‚Äî
You are receiving this because you modified the open/close state.
Reply to this email directly, view it on GitHub<https://github.com/facebook/jest/pull/3378#issuecomment-298051206>, or mute the thread<https://github.com/notifications/unsubscribe-auth/AAA0KGMIEgnWGrdofyksXr2DRdSRMY4jks5r0hpkgaJpZM4NJaVH>.
 Yes, if you send some tests for it :)

________________________________
From: Jordan Harband <notifications@github.com>
Sent: Friday, April 28, 2017 6:23:57 PM
To: facebook/jest
Cc: Christoph Pojer; State change
Subject: Re: [facebook/jest] Include fullName in formattedAssertion (#3378)


Ah, that makes much more sense. :-)

In that case the linter rule seems very useful; but it'd still be useful to include this additional context in the output. Could it be reopened?

‚Äî
You are receiving this because you modified the open/close state.
Reply to this email directly, view it on GitHub<https://github.com/facebook/jest/pull/3378#issuecomment-298057420>, or mute the thread<https://github.com/notifications/unsubscribe-auth/AAA0KC3D69g8Vi9IKKa_GlZ3xl5ICFCrks5r0iCtgaJpZM4NJaVH>.
 You just go and send a new PR.  I think there's a good value in that, especially if we're more sinon compatible, it would be easier to migrate.   **Summary**

This diff starts to actually separate configs into two individual ones with distinct keys rather than overlaps. It requires a bunch of rewrites because some config fields were passed into the wrong places in the first place. For example, I made it so we passed "watch" to babel-jest, which should not know anything about how it is being used. I had to rewrite the entire transform pipeline (`transform.js` to `ScriptTransformer.js`) to cache transform specific data (like the location of .babelrc) per test rather than globally. However, I think it was worth it. The new ScriptTransformer makes much more sense than the spaghetti file we had there before.

There'll be more diffs on top of this, I recommend reviewing this in the order of the commits, with the last one being the biggest one. There'll be many more diffs to separate configs more.

**Test plan**

jest I renamed the transform-test.js file. Thanks for that recommendation and the thorough review!  yeah, this really sucks and shows why `test.concurrent` is flawed. The main problem is that your tests are doing network requests. If you stop doing that, you can run them serially.

I'm not opposed to adding `test.serial` that queues all tests to be run after the concurrent ones, however it's unlikely we have enough time at the moment to work on this. In the meantime, you can put the serial test that requires a different env into a different file.

You may want to try defining the serial test as last test in your suite, that may actually work :) In that case changing the environment variable should be fine.  **Summary**

We are encountering some errors on our CI machines, but the error message is not clear about the exact reason making it impossible to write the cache file. This changeset aims to expose the inner error message, that includes the errno code, that could be for example EACCESS or ENOENT.

**Test plan**

Automated testing.
  This adds a line to add crowdin through wget and dpkg.

Testing plan:

Confirmed on Ubuntu instance. How do we know it'll work?  Awesome! Great to see you contributing to Jest :)

* I'm a bit unsure why the yarn lockfile changed in jest-runtime, that's odd.
* Check out the existing expect.assertions tests in `integration_tests`. Short story: we have tests that invoke a Jest test run and then ensure the right thing happens. Jestception. @mxstbr I'll close this in favour of https://github.com/facebook/jest/pull/3379  This PR resolve issues relating to file templates that generate files with 4-spaces. I also added a required CLI "crowdin-cli" to allow for two way syncing of docs during CI build step. Awesome!  You should need to use this, so you can disable it for the "test" env in your babelrc. Otherwise, the setup you have seems reasonable.  Thank you! I feel like there should be something within babel that gives us this information, but oh well, we can keep this in our own code for now.  **Summary**

Next diff in the sea of diffs to split up configs. This removes the Config type completely. I have follow-ups where I start to pull things apart properly and remove fields from either ProjectConfig or GlobalConfig.

**Test plan**

jest Right now, the return value of `normalize` returns an "options" object which is `GlobalConfig & ProjectConfig` (basically what `Config` was). We should change this over time and we'll have to fix up many tests that rely on this (see the rename of `.config` to `options`). I made the minimal changes to make the tests work and it seems to be good enough for now. In the interest of time, I'm gonna go forward with this. If there are any concerns with this direction, please let me know and I'll revert or fix.  If you use `done` callback, calling it is mandatory (this is the part where Jasmine takes over). You should just do:
```js
test('test name', () => {
  return source.token.promise
    .then(reason => {
      expect(reason).toBeInstanceOf(Cancel)
      expect(reason.message).toBe('foo')
      expect(reason.toString()).toBe('Cancel: foo')
      console.log('Complete')
    })
});
``` Yes, first parameter of test callback is considered `done`, you can name it whatever you like, Jest doesn't check how it's named.  This is by design. Do you wanna send us a PR for updating the docs? :) I'd write about this in mock section and mention it in `setupTestFrameworkScriptFile`, seems ok?  Update Jest to Jest 19. Try `expect.stringMatching`.  This seems like an issue with the History API, unrelated to Jest.  Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!

**If you are contributing on behalf of someone else (eg your employer)**: the individual CLA is not sufficient - use https://developers.facebook.com/opensource/cla?type=company instead. Contact cla@fb.com if you have any questions. Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks! Thank you!  We should definitely add a "browser" field and a build-step that bundles up `jest-matchers` into a single file that ships with ES5 ‚Äì that would work, right? If you specify `"browser": "build-es5/index.js"` in package.json and you compile es5 into that folder, browser-builds will use that instead of the ES6 version in `build`. So it's just a matter of setting up the build script!  I feel like it makes everything more brittle. I prefer people to be explicit in their intent. I think it's going to be easy to forget the number (lint rule may help). But I like the idea. Or we could introduce something like `hasAssertions()`  Yep, I'd also be ok with a separate function. Yeah, check out how .assertions is implemented. I believe it lives mostly in the `jest-jasmine2` package, somewhere around jest-expect.js. This'll be in the next release. Thanks everyone for working on this :)  Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!

**If you are contributing on behalf of someone else (eg your employer)**: the individual CLA is not sufficient - use https://developers.facebook.com/opensource/cla?type=company instead. Contact cla@fb.com if you have any questions. Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks! this is awesome! thank you!  <!-- Thanks for submitting a pull request! Please provide enough information so that others can review your pull request. The two fields below are mandatory. -->

**Summary**

Fixes #3272.
cc: @bestander 
 According to [this article](https://yarnpkg.com/blog/2016/11/24/lockfiles-for-all/#libraries-vs-applications) it doesn't matter, they're ignored anyway, but we ship less files to npm.
Lockfiles are around in Jest packages regardless if they're gitignored or not. 
Have you tried to file an issue in their GitHub on that linking problem?  fantastic!  I couldn't merge this one so I took it and pushed it to master. Thanks @SimenB. Man, Jest 20 is going to be so awesome.  This is great Simen! I fixed it up a bit and addressed the instanceof checks and made custom types for them.  <!-- Thanks for submitting a pull request! Please provide enough information so that others can review your pull request. The two fields below are mandatory. -->

**Summary**

Fixes #3330 and #3316. 
Mutation of `contexts.config` object causes some unexpected behaviors, such as retaining `updateSnapshots` flag. Removing mutation resolves the issue, so that `overrideConfig` only overrides the config for following run.

**Test plan**

jest
 I have a PR coming in which will make this obsolete. Sorry about being slow.  <!-- Thanks for submitting a pull request! Please provide enough information so that others can review your pull request. The two fields below are mandatory. -->

**Summary**

Update Prettier to 1.2.2. This required a little change in `prettier.js` script, so be sure to check that.
I've also unified `runCommand`'s `args` argument to always be an array, as passing a space-separated string caused problems when filename had a space in it.

**Test plan**

CI green. Rebased and disabled `computed-property-spacing` eslint rule. awesome!  This is a problem with your babel transforms. It's hard to tell what's wrong without your `.babelrc` file or Jest config. Please check the tutorial on Babel [here](http://facebook.github.io/jest/docs/getting-started.html#using-babel) on Webpack [here](http://facebook.github.io/jest/docs/webpack.html#a-webpack-example). You can also seek help on the Discord channel.
Closing as it's not a bug in Jest.  Thanks @jwbay!  i rebased/resolved/squashed https://github.com/facebook/jest/pull/3064 which grew uncontrollably big.
also fixed a few issues and resolved conflicts with multi runner feature

cc @abdulhannanali  Bunch of comments but feel free to merge it after one more iteration. Please don't forget to document the reporters option in the docs and adding "Available in Jest 20.0.0" like we do for other things (Like the expect.resolves API). I left a few comments inline. The one missing piece is that the `<rootDir>` replacement and proper resolution using `jest-resolve` (we do this in normalize.js for all other fields) must be added, otherwise resolving reporters works differently from every other config option. Mind adding that? Alright, good to go.  This should be pretty straight-forward change in `babel-jest` package, so I'll tag it as "Good first task" :)  **Summary**

This is the first diff that introduces a ProjectConfig, which is the same as "Config" right now and it fixes lots of code up to split things into Global/Project config but there are many more diffs and cleanups after this one to make this work well. I didn't want to make this diff too big though :P

**Test plan**

jest approved by @thymikee from an airplane.  Thank you!  This is great, I was hoping for this change for a while but nobody got around to it. Thank you very much.  cc @hramos ‚Äì can we add "API" to the docs sidebar? cpojer @gaearon @orta We could merge the 'reference' and 'docs' document chains into one and have the API or Reference link at top link directly to Api/Globals. I have a PR that adds API to the docs, but depends on my PR #3337 being accepted since the file routes change. The separation was meant to minimize clutter in the sidebar, but in practice I've run into the same issues raised by @gaearon. Let's display both in the sidebar.  Actually I cannot reproduce it on a simple project (without react-native). Can you provide a repro? It looks like problem with `resolve` package, we'll see how it goes.
See: https://github.com/substack/node-resolve/issues/127  Is it happening only on Circle? What about other CIs?  If you have some time, could you please setup a repo with a simple test case like this:
```js
test('date', () => {
  Date.now = jest.fn(() => 1490760656000);
  const date1 = Date.now();
  const date2 = Date.now();
  expect(Date.now).toHaveBeenCalled();
  expect(date1).toEqual(date2);
});
```
and add Circle and Travis running this code on different Node versions?  Awesome, glad you figured out what's wrong :)  Thank you!  **Summary**

I'll make some bigger changes to this module, first I'm gonna move everything into one file and remove the unnecessary indirection that's present here.

**Test plan**

jest  One some CI systems it may be beneficial to know which tests Jest would run based on changed files before actually deciding to run tests. This feature should print all tests as JSON:

```
$ jest --listTests --findRelatedTests path/to/test
["path/to/__tests__/a.js", "path/to/__tests__/b.js", ‚Ä¶]
```

This task requires:
* Print the tests here: https://github.com/lo-tp/jest/blob/bugfix/transformRefresh/packages/jest-cli/src/runJest.js#L168
* Exit
* An integration test in the integration_tests folder.
 Hey @anilreddykatta, that doesn't really matter as much. We actually have somebody at FB working on this, so please don't waste any time on it in particular :)

Also, btw., I'm super excited to see you contributing to Jest. We have a discord channel where we all hang out, please join us! http://facebook.github.io/jest/help.html See PR.  **Summary**

This PR adds localization support for the Jest website. It adds a new dropdown on the website to allow selecting the desired language. Localization is provided by CrowdIn. Languages shall be synchronized in the CI build step.

I have added a couple pre-processing steps: 1) strings were moved to /i18n/en.json to allow localization of string content on the landing page and from navigation. 2) I convert this json file into a .js file. These files are then included in SiteConfig.js and referenced throughout the localized pages.

The localized content is not stored in the repo. Instead, all localized content is stored on a public translation project in the [Jest Crowd In project](https://crowdin.com/project/jest).

By default, only English is supported. Languages can be enabled as more translations are contributed by editing website/languages.js and switching the desired language's `enabled` variable to `true`. Can you rebase to master? This is nice, you're  fast!  @thymikee I rebased and resolved a couple conflicts from my previous PR updating examples. PTAL Awesome, much better!  
<!--
  2 failure:  New JS files do n..., Please ensure tha...
  1 warning:  Please ensure tha...
  
  
-->

<table>
  <thead>
    <tr>
      <th width="50"></th>
      <th width="100%" data-danger-table="true">Fails</th>
    </tr>
  </thead>
  <tbody><tr>
      <td>:no_entry_sign:</td>
      <td>New JS files do not have the Facebook copyright header: <a href='https://github.com/ericnakagawa/jest/blob/master/website/core/JestHelp.js'>website/core/JestHelp.js</a>, <a href='https://github.com/ericnakagawa/jest/blob/master/website/core/JestIndex.js'>website/core/JestIndex.js</a>, <a href='https://github.com/ericnakagawa/jest/blob/master/website/core/JestUsers.js'>website/core/JestUsers.js</a>, <a href='https://github.com/ericnakagawa/jest/blob/master/website/core/Thing.js'>website/core/Thing.js</a>, <a href='https://github.com/ericnakagawa/jest/blob/master/website/languages.js'>website/languages.js</a>, <a href='https://github.com/ericnakagawa/jest/blob/master/website/server/translationPre.js'>website/server/translationPre.js</a>, <a href='https://github.com/ericnakagawa/jest/blob/master/website/src/jest/en/help.js'>website/src/jest/en/help.js</a>, <a href='https://github.com/ericnakagawa/jest/blob/master/website/src/jest/en/index.js'>website/src/jest/en/index.js</a>, <a href='https://github.com/ericnakagawa/jest/blob/master/website/src/jest/en/support.js'>website/src/jest/en/support.js</a> and <a href='https://github.com/ericnakagawa/jest/blob/master/website/src/jest/en/users.js'>website/src/jest/en/users.js</a></td>
    </tr>
  
<tr>
      <td>:no_entry_sign:</td>
      <td>Please ensure that <code>'use strict'</code> is enabled on: <a href='https://github.com/ericnakagawa/jest/blob/master/website/core/JestIndex.js'>website/core/JestIndex.js</a>, <a href='https://github.com/ericnakagawa/jest/blob/master/website/core/JestUsers.js'>website/core/JestUsers.js</a>, <a href='https://github.com/ericnakagawa/jest/blob/master/website/core/Thing.js'>website/core/Thing.js</a>, <a href='https://github.com/ericnakagawa/jest/blob/master/website/languages.js'>website/languages.js</a>, <a href='https://github.com/ericnakagawa/jest/blob/master/website/src/jest/en/help.js'>website/src/jest/en/help.js</a>, <a href='https://github.com/ericnakagawa/jest/blob/master/website/src/jest/en/index.js'>website/src/jest/en/index.js</a>, <a href='https://github.com/ericnakagawa/jest/blob/master/website/src/jest/en/support.js'>website/src/jest/en/support.js</a> and <a href='https://github.com/ericnakagawa/jest/blob/master/website/src/jest/en/users.js'>website/src/jest/en/users.js</a></td>
    </tr>
  </tbody>
</table>


<table>
  <thead>
    <tr>
      <th width="50"></th>
      <th width="100%" data-danger-table="true">Warnings</th>
    </tr>
  </thead>
  <tbody><tr>
      <td>:warning:</td>
      <td>Please ensure that <code>@flow</code> is enabled on: <a href='https://github.com/ericnakagawa/jest/blob/master/website/src/jest/en/help.js'>website/src/jest/en/help.js</a>, <a href='https://github.com/ericnakagawa/jest/blob/master/website/src/jest/en/index.js'>website/src/jest/en/index.js</a>, <a href='https://github.com/ericnakagawa/jest/blob/master/website/src/jest/en/support.js'>website/src/jest/en/support.js</a> and <a href='https://github.com/ericnakagawa/jest/blob/master/website/src/jest/en/users.js'>website/src/jest/en/users.js</a></td>
    </tr>
  </tbody>
</table>



<p align="right">
  Generated by :no_entry_sign: <a href="http://github.com/danger/danger-js/">dangerJS</a>
</p>
 Super awesome! It does seem like lint is quite unhappy, mind fixing them up using `yarn lint` and some manual editing? @cpojer I'll work through all the lint errors today!  Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!

**If you are contributing on behalf of someone else (eg your employer)**: the individual CLA is not sufficient - use https://developers.facebook.com/opensource/cla?type=company instead. Contact cla@fb.com if you have any questions. Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks! Thank you. Automocking is still a feature of Jest, so I would prefer to keep this for people who use automocking.  Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!

**If you are contributing on behalf of someone else (eg your employer)**: the individual CLA is not sufficient - use https://developers.facebook.com/opensource/cla?type=company instead. Contact cla@fb.com if you have any questions. Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks! Thank you! I removed some of the changes you made and took a note to update this code soon because we are refactoring how configurations are working.  Unfortunately this is not a reasonable bug report and we cannot act based on it. Please provide a full repro that we can try on our machines.  **Summary**

This adds a "GlobalConfig" type as a first step to separate configs into a "GlobalConfig" and "ProjectConfig". GlobalConfig works better than SharedConfig because it isn't actually shared ‚Äì I think the two configs will end up having almost no overlap, if any at all, so that makes more sense.

Right now it is not an exact type yet and it is still exactly the same value as before, this diff only changes typings but I'd like to ship this incrementally in smaller PRs :)

**Test plan**

yarn typecheck  This is part of set of polish PRs for the typeaheads #2595

**Summary**

This adds the ability to clear the "active filters" and it also makes them work better together.

**Test plan**

Added some tests

![filters](https://cloud.githubusercontent.com/assets/574806/25201525/e6a8a642-2506-11e7-919d-1e909a6722d8.gif)


This PR still has a UI issue that needs to be resolved... The test summary also shows the active filters... what do you think that it is the best way to move forward with this?
<img width="536" alt="screen shot 2017-04-19 at 1 49 00 pm" src="https://cloud.githubusercontent.com/assets/574806/25201554/fea00042-2506-11e7-8b1b-1948fc6a22f3.png">



 What should be the correct UI for this? Please make sure to use the right prettier configuration (run with `yarn prettier`, for example, see package.json).

How about we change the summary in watch mode to show "Active filters: ‚Ä¶" instead of "Ran all test suites"? That way you don't have to repeat yourself when typing "w" and it doesn't add any more text to the watch mode. But if we just change the test summary copy, how would it work when the screen has been cleared?  Hmm, that's a good point :(  This is an issue with a wrong version of react, react-native or react-test-renderer. Make sure to update them all to the proper versions.  **Summary**

The examples are now run using the multi-project runner, which serves as an integration test.

**Test plan**

yarn test-examples  Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!

**If you are contributing on behalf of someone else (eg your employer)**: the individual CLA is not sufficient - use https://developers.facebook.com/opensource/cla?type=company instead. Contact cla@fb.com if you have any questions. Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks! Thank you for bringing this to our attention! I changed the language a little bit to flip it around and recommend to install test utils only on older versions of React :)  Jest does this once you have enough test files for this to actually be useful, like 20 test suites or so.  <!-- Thanks for submitting a pull request! Please provide enough information so that others can review your pull request. The two fields below are mandatory. -->

**Summary**

Fixes [failing CircleCI](https://circleci.com/gh/facebook/jest/947?utm_campaign=vcs-integration-link&utm_medium=referral&utm_source=github-build-link) by linking to `.../node_modules/*` instead of `.../node_modules/`. This prevents permission issues while linking existing packages.
I've also adjusted the console output a little (display only example name and get rid of extra indentation for command after `cd`, it's just easier to read it this way):

<img width="875" alt="screen shot 2017-04-18 at 19 45 44" src="https://cloud.githubusercontent.com/assets/5106466/25161252/a930c23c-246f-11e7-8e1f-a06f88f78884.png">


**Test plan**
`yarn test-examples` pass on all CI servers
 I don't believe the `*` method will work, can you go into what you are thinking? What does `mkdirp.sync('node_modules/*')` do?

I do like the indentation change though. Sorry, it just worked on my machine ¬Ø\_(„ÉÑ)_/¬Ø. 
The reason it fails is because after installation `react-native/node_modules/babel-jest` already exists and I found no extra options in manual to prevent that error.

So we have at least 2 options:
* try/catch `ln` to silence the error (just sent a fix with this)
* link before running `yarn --production` Ok, let's do this: install, then rimraf babel-jest and symlink it. Done  Are you willing to send a PR with the wording? üôÇ   Can't believe we never noticed ;) Thank you.  That is an issue with your React dependencies and/or enzyme, not Jest. Please update those deps.  We should probably try to import flow AST types from somewhere else and use those to fix the flow issue. Thanks again @SimenB.  Really small polish on the footer of the typeahed


**Before**
<img width="510" alt="screen shot 2017-04-18 at 9 59 18 am" src="https://cloud.githubusercontent.com/assets/574806/25143134/2bdc9c58-241e-11e7-9a6c-037b93dd3a01.png">

**After**
<img width="616" alt="screen shot 2017-04-18 at 10 00 52 am" src="https://cloud.githubusercontent.com/assets/574806/25143133/2bd8bb4c-241e-11e7-8f20-9068b066b1da.png">
  **Summary**

This fixes all the major issues with syntax I had. Yay.

**Test plan**

jest  This seems like a babel issue and nothing we can do about in Jest :(  this is beautiful! how much faster was it able to run on your project? Can you run `rm -rf examples/*/node_modules` and check it again? It's fixed now, you can rebase once more.  Thanks for reporting! I'll take a look a this later. If you have any ideas on how to make contributing guide more comprehensive, please send a PR :)  Let's just wait until Dmitrii finds some time to review this. In the meantime it's pretty ok to ping him once in a couple of days, so he'll eventually get there :D sorry :) i'll be updating Jest internally at fb again in a couple of days and i'll test this feature!
The code looks awesome :) i had to resolve some issues with the current master (we kinda rewrote everything in those files üôÇ)
here's a PR that i based on this one https://github.com/facebook/jest/pull/3407  Can you change the base of this commit to a different branch that has this commit? If not, I guess I can cherry-pick manually. What's the base commit? Shipped on a different branch.  Thanks @SimenB   Reduces requirements for this feature to work.

Touches docs.  I updated the examples to use a new version of Babel's 'env' preset. I also added .babelrc to examples that were missing one. Thanks Eric!  Thank you!  Jest uses JSDOM to emulate browser environment and it doesn't actually work in real browsers currently. Currently we render [nothing](https://github.com/facebook/jest/blob/10e492754fd9f2f0280c625f15800fb8f3347558/packages/jest-environment-jsdom/src/index.js#L28) as a document, hence the quirk mode.

@cpojer any special reason, why we're doing this?

changing `undefined` to `'<!DOCTYPE html>` should fix this and doesn't break anything in our test suite.
```js
this.document = require('jsdom').jsdom('<!DOCTYPE html>', {
  url: config.testURL,
});
``` @edemaine would you like to send a PR with that fix?  Duplicate of https://github.com/facebook/jest/issues/2460  <!-- Thanks for submitting a pull request! Please provide enough information so that others can review your pull request. The two fields below are mandatory. -->

**Summary**

Fixes #3297.

**Test plan**

Adds a very basic test for `runJest`. To be updated after #3156.
 Seems like the test is failing on AppVeyor? Skipped this on windows, because I have no idea what's wrong. We should come back to it after #3156 is merged  cc @orta ‚Äì we may need to make the code in jest-editor-support work with older releases prior to 20.  Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!

**If you are contributing on behalf of someone else (eg your employer)**: the individual CLA is not sufficient - use https://developers.facebook.com/opensource/cla?type=company instead. Contact cla@fb.com if you have any questions. Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks! Thank you so much for fixing this! I'm sorry for the thrash on that issue, my mistake and I apologize.  There are many questions here, one of them in this issue #1965.  cc @bcoe  I can repro it with the Jest repo, although I get a similar behavior without `--coverage`

### With coverage

```
‚ùØ node --expose-gc ./packages/jest-cli/bin/jest.js --coverage --no-cache --i --logHeapUsage packages
 PASS  packages/jest-util/src/__tests__/FakeTimers-test.js (55 MB heap size)
 PASS  packages/jest-matchers/src/__tests__/matchers-test.js (67 MB heap size)
 PASS  packages/jest-haste-map/src/__tests__/index-test.js (69 MB heap size)
 PASS  packages/jest-config/src/__tests__/normalize-test.js (71 MB heap size)
 PASS  packages/pretty-format/src/__tests__/ImmutablePlugins-test.js (78 MB heap size)
 PASS  packages/jest-mock/src/__tests__/jest-mock-test.js (81 MB heap size)
 PASS  packages/pretty-format/src/__tests__/React-test.js (85 MB heap size)
 PASS  packages/jest-cli/src/__tests__/SearchSource-test.js (92 MB heap size)
 ...
 ...
 ...
 PASS  packages/jest-editor-support/src/__tests__/parsers/BabylonParser-test.js (403 MB heap size)
 PASS  packages/jest-test-typescript-parser/src/__tests__/TypeScriptParser-test.js (420 MB heap size)
 PASS  packages/jest-resolve-dependencies/src/__tests__/__fixtures__/file-test.js (423 MB heap size)
 PASS  packages/jest-resolve-dependencies/src/__tests__/__fixtures__/related-test.js (425 MB heap size)
 PASS  packages/jest-jasmine2/src/__tests__/it_to_test_alias-test.js (424 MB heap size)
```

### Without coverage

```
‚ùØ node --expose-gc ./packages/jest-cli/bin/jest.js --no-cache --i --logHeapUsage packages
 PASS  packages/jest-util/src/__tests__/FakeTimers-test.js (45 MB heap size)
 PASS  packages/jest-matchers/src/__tests__/matchers-test.js (47 MB heap size)
 PASS  packages/jest-haste-map/src/__tests__/index-test.js (43 MB heap size)
 PASS  packages/jest-config/src/__tests__/normalize-test.js (47 MB heap size)
 PASS  packages/pretty-format/src/__tests__/ImmutablePlugins-test.js (48 MB heap size)
 PASS  packages/jest-mock/src/__tests__/jest-mock-test.js (47 MB heap size)
 PASS  packages/pretty-format/src/__tests__/React-test.js (47 MB heap size)
 PASS  packages/jest-cli/src/__tests__/SearchSource-test.js (54 MB heap size)
 PASS  packages/pretty-format/src/__tests__/pretty-format-test.js (58 MB heap size)
 PASS  packages/jest-cli/src/reporters/__tests__/VerboseReporter-test.js (59 MB heap size)
 PASS  packages/jest-runtime/src/__tests__/transform-test.js (68 MB heap size)
 PASS  packages/jest-haste-map/src/crawlers/__tests__/watchman-test.js (71 MB heap size)
 ...
 ...
 ...
 PASS  packages/jest-editor-support/src/__tests__/parsers/BabylonParser-test.js (243 MB heap size)
 PASS  packages/jest-test-typescript-parser/src/__tests__/TypeScriptParser-test.js (256 MB heap size)
 PASS  packages/jest-resolve-dependencies/src/__tests__/__fixtures__/file-test.js (255 MB heap size)
 PASS  packages/jest-resolve-dependencies/src/__tests__/__fixtures__/related-test.js (254 MB heap size)
 PASS  packages/jest-jasmine2/src/__tests__/it_to_test_alias-test.js (251 MB heap size)
``` Can confirm this behaviour on Jest repo, although it doesn't happen on thousands of tests suite like that:
```js
describe('test', function() {
  beforeAll(function() {
    global.gc();
  });

  it('work', function() {
    expect(1).toBe(1);
  });
});
``` I use `gc` for debugging just to be sure that there are no leftovers in memory. Please note it degrades perf A LOT. Calling `global.gc()` is *not* a workaround and will not clean up memory leaks. @danieljuhl any updates? Can you also try if it happens on Jest 20?  Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!

**If you are contributing on behalf of someone else (eg your employer)**: the individual CLA is not sufficient - use https://developers.facebook.com/opensource/cla?type=company instead. Contact cla@fb.com if you have any questions. Not sure what's going on here but we already have this in the docs as of yesterday: http://facebook.github.io/jest/docs/configuration.html#testenvironment-string

Thanks for contributing, I'm unclear why GitHub isn't showing a merge conflict or something.  **Summary**

Part of https://github.com/facebook/jest/pull/3156, pulled out for easier review and more incremental shipping.

cc @thymikee @zouxuoz 

**Test plan**
jest  **Summary**
Pulling out commit #2 from https://github.com/facebook/jest/pull/3156 to make the other diff easier to review as I add more stuff on top of it. This is changing how reporters work a little bit but there may be some more changes later.

cc @abdulhannanali 

**Test plan**
jest  See https://github.com/facebook/jest/pull/3156/files#diff-8006e39142c24851115752df17e9c1c0R51 Like `--debug` but it shows the config and exits right away? yes, a json-parseable config would be good. Maybe even this:

```
{
version: '‚Ä¶',
config: {‚Ä¶},
}
```

+ adjusting jest-editor-support to use this new command. Perfect, so I guess also `testFramework` right? Nah, nobody needs that. Can we make it so `--debug` also outputs its data as JSON the same way `--show-config` does (except without exiting)? The whole `=` is really weird. @wyze sure, let me know if I can help with anything  This is not a help forum. Please see http://facebook.github.io/jest/help.html for how to get help :)  Not sure if that's causing a problem (because Jest cannot resolve the name, not some unknown tokens in read file), but `transformIgnorePatterns` takes an array of RegExps, not globs. You rather need to use it like this:
```json
{
  "transformIgnorePatterns": [
    "node_modules/(?!react-native|my-linked-module)/"
  ]
}
```
Also, could you provide a repo with the issue? You could add linking step to npm scripts. @zurgul Interesting, I use it with a scoped package `@ngrx` [here](https://github.com/thymikee/jest-preset-angular/blob/master/jest-preset.json#L21) and it works just fine. Are you able to provide a repository with a repro? cc: @cpojer   Thanks for reporting!
You can try using [expect.addSnapshotSerializer()](http://facebook.github.io/jest/docs/expect.html#expectaddsnapshotserializerserializer) in the mean time I don't think that you can call from the `setupFiles`... I think that passing it in the config would be the only way This is definitely a bug! @Daniel15 you can use [`setupTestFrameworkScriptFile`](http://facebook.github.io/jest/docs/configuration.html#setuptestframeworkscriptfile-string) just for that, but I guess you probably already solved that üòÑ.  Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!

**If you are contributing on behalf of someone else (eg your employer)**: the individual CLA is not sufficient - use https://developers.facebook.com/opensource/cla?type=company instead. Contact cla@fb.com if you have any questions. Thanks! Please take a look at how we do it here: http://facebook.github.io/jest/docs/expect.html#expectstringcontainingstring ‚Äì mind adjusting your PR to match that? Thanks!  This feature hasn't been shipped yet. It will ship in about a month. Ah, would you mind sending us a PR that adds "available in 20.0.0" just like we do in other parts of the docs? :)  Thanks for your contribution! However, we'll be merging this PR soon, so I think the two are incompatible: https://github.com/facebook/jest/pull/3201 Sorry about the confusion here.  The Jest chat is there, the channel is #jest.

From: andyl <notifications@github.com>
Reply-To: facebook/jest <reply@reply.github.com>
Date: Tuesday, April 11, 2017 at 2:13 AM
To: facebook/jest <jest@noreply.github.com>
Cc: Subscribed <subscribed@noreply.github.com>
Subject: [facebook/jest] Can't access Discord (#3277)


I'd like to join the Jest discord chat, but the chat link on the bottom of the page doesn't work for me.

I've had good success joining 'rectiflux' from this page:
https://www.reactiflux.com/<https://urldefense.proofpoint.com/v2/url?u=https-3A__www.reactiflux.com_&d=DwMCaQ&c=5VD0RTtNlTh3ycd41b3MUw&r=aFhQMFmdCAmrM__WP0c73w&m=ZblBPhyxJ9tpeECelq2exAf7gcE16HrJ5s1-nMcqXlw&s=1-CQRx6RbbA2PneM5YAFIAD2X78fhaMOSMSZUhz-LN4&e=>

Is there some trick to getting on the Jest chat ??

‚Äî
You are receiving this because you are subscribed to this thread.
Reply to this email directly, view it on GitHub<https://github.com/facebook/jest/issues/3277>, or mute the thread<https://github.com/notifications/unsubscribe-auth/AAA0KHBRhDajzmwZ2HdoyKqCfe9mRMx3ks5rutPXgaJpZM4M5gGI>.
  Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!

**If you are contributing on behalf of someone else (eg your employer)**: the individual CLA is not sufficient - use https://developers.facebook.com/opensource/cla?type=company instead. Contact cla@fb.com if you have any questions. Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks!  Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!

**If you are contributing on behalf of someone else (eg your employer)**: the individual CLA is not sufficient - use https://developers.facebook.com/opensource/cla?type=company instead. Contact cla@fb.com if you have any questions. Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks! Thanks!  <!-- Thanks for submitting a pull request! Please provide enough information so that others can review your pull request. The two fields below are mandatory. -->

**Summary**
<!-- Explain the **motivation** for making this change. What existing problem does the pull request solve? -->

A lint error occurs as a `props` never get reassigned within `website/core/center.js` and the variable for it is declared using a `let`, which leads to a lint error and tests not getting passed 100% within the application. I have made a slight change in `website/core/center.js` on how we are using the `let` and `const` within our application. 

**Test plan**
<!-- Demonstrate the code is solid. Example: The exact commands you ran and their output, screenshots / videos if the pull request changes UI. -->
This PR solves a lint error, and doesn't make any change to the UI or output in any way.   I think this is now resolved with #3201. If you think there is more we can do here, please send a PR :)  Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!

**If you are contributing on behalf of someone else (eg your employer)**: the individual CLA is not sufficient - use https://developers.facebook.com/opensource/cla?type=company instead. Contact cla@fb.com if you have any questions. Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks!  This is probably coming from Enzyme (related PR https://github.com/airbnb/enzyme/pull/876) or other library. This test also doesn't feature any React code, and yet it logs the error? Something somewhere has to reference it, and it's certainly not a fault of Jest.  Thank you for your contribution! I made some small amends to make sure the Contributing guide only contains what most people actually need. Hey! Please keep it up and feel free to contribute anything you want :)  yes! we absolutely need this!
We inherited this behavior from jasmine, but now since we started the migration away from it we can actually fix it.  Shouldn't you call `connection.end()` somewhere? E.g. in `afterAll()` hook. It's possible, that mocha's default behaviour is similar to Jest with `--forceExit`. But as you can see this can lead to leaky tests. Glad you solved the problem üôÇ   i agree that would be nice! The report is generated by istanbul and there's nothing really we can do here.
It would be nice to have some nice custom html report generator, but i don't think we have any plans for this in the nearest future  <!-- Thanks for submitting a pull request! Please provide enough information so that others can review your pull request. The two fields below are mandatory. -->

**Summary**

Fixes https://github.com/facebook/jest/issues/3262

**Test plan**

```
$ npm test
Snapshot Summary
 ‚Ä∫ 1 obsolete snapshot found, run with `npm test -- -u` to remove them.
```

<img width="512" alt="screen shot 2017-04-05 at 20 12 51" src="https://cloud.githubusercontent.com/assets/5106466/24720114/4dc7667c-1a3c-11e7-8db7-4de3552703d3.png">

```
$ yarn test
Snapshot Summary
 ‚Ä∫ 1 obsolete snapshot found, run with `yarn test -- -u` to remove them.
```

<img width="518" alt="screen shot 2017-04-05 at 20 12 47" src="https://cloud.githubusercontent.com/assets/5106466/24720113/4dac1796-1a3c-11e7-8975-553f2cb28cde.png">
 Awesome, thanks for fixing those small things :) Lovely!  Thank you for your efforts on bringing development easier to Windows users! I've left some inline comments.
I'd like @wtgtybhertgeghgtwtg to have a look. Closing in favor of #3267  this is likely related to some other packages that were updated (istanbul, babel)

if you look at the detailed coverage
<img width="1304" alt="screen shot 2017-04-05 at 11 18 22 am" src="https://cloud.githubusercontent.com/assets/940133/24720332/b191e916-19f1-11e7-9302-5cf5d43d0298.png">
the newer version does a better job instrumenting the file and taking into account additional lines (the red highlight is messed up because of all the babel transformation. we can't really do much about it yet üòû) @lucasbento i'd say it looks more like the issue was fixed, and now you get a more accurate coverage report :)
If you have a threshold on your CI it probably makes sense to lower it (if it's failing right now)
  Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!

**If you are contributing on behalf of someone else (eg your employer)**: the individual CLA is not sufficient - use https://developers.facebook.com/opensource/cla?type=company instead. Contact cla@fb.com if you have any questions. Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks! @orta do you mind looking at this? thank you!
@anarresk can you resolve conflicts? :)  thank you! This is nice! Thank you @cpenarrieta.  `'hello'` is not an instance of String. `new String('hello')` is. 

You can test types like this:
```js
expect(typeof expected).toBe('string')
```  Fixes #3250

  <!-- Thanks for submitting a pull request! Please provide enough information so that others can review your pull request. The two fields below are mandatory. -->

**Summary**

Bumps Flow to 0.43. Fixes some small things.

**Test plan**

CI
 yay!  This means there is no space on your drive. Please cleanup your disk. Unfortunately we do not have resources to debug this on Linux. If you have time and you could take a look and help us with a pull request to fix it, that would be greatly appreciated. Thanks for investigating, if you install watchman, it should work.  <!-- Thanks for submitting a pull request! Please provide enough information so that others can review your pull request. The two fields below are mandatory. -->

**Summary**

This is a compromise we agreed on for #2978. Let's hide it from regular users until it's solid.
cc: @gaearon @zouxuoz @rogeliog  @dmitriiabramov if we don't have breaking changes in master, we could roll v19.1 release. üéâ 

Should we put it behind a flag? Also, so it is "available" we are just hiding it from the UI I'd prefer to fix this up for 20 and not hide it for the next release. @gaearon #3287 and #2595 are tracking the work that needs to be done to make the test name filter more usable.

I've been working on #3327 which better integrates the filename and the test name filtering....

I've also been experimenting with #2589, which is my attempt to make it easier to target tests with the test name filter(Just a PoC, still a lot of work left on this one)
![filters-2](https://cloud.githubusercontent.com/assets/574806/25400407/50ea8e9a-29a7-11e7-9761-a31420571960.gif)
  Does this help? https://github.com/facebook/jest/issues/3044 Glad it helped! üôÇ   Hm, something like this might be handy. 
cc: @dmitriiabramov @rogeliog  Yeah, this is a really good point... Even if Jest was not clearing the console, I think that the default `UnhandledPromiseRejectionWarning` is not super intuitive and makes it a bit hard to figure out the error yea! I remember we already thought about it in the past, but couldn't implement it because of Jasmine dependency. Now that we started migrating away from jasmine i think it'd be pretty easy to implement! i think the easiest way to implement something like this is to have a global handler and save all unhandled errors to a test state.
then when all tests are done, check the state, if there's any errors, fail the test and log them  You just need to return the promise and Jest will handle all async work inside:
```js
test('the data is peanut butter', () => {
  return fetchData().then(value => {
    expect(value).toBe('peanut butter')
  })
});
``` I didn't notice that there's only `resolves` in docs now. We should definitely bring back the old-fashioned way of testing promises. @tlubz v20 is the next major of Jest, which will be rolled out from `master` branch. cc: @hramos    you should return the promise from the test to make it fail
On Mon, Apr 3, 2017 at 5:42 PM YULONG SONG <notifications@github.com> wrote:

> *Do you want to request a feature or report a bug?*
> bug
> *What is the current behavior?*
> tests are always passing
>
> *If the current behavior is a bug, please provide the steps to reproduce
> and either a repl.it <http://repl.it> demo through
> https://repl.it/languages/jest <https://repl.it/languages/jest> or a
> minimal repository on GitHub that we can yarn install and yarn test.*
>
> *What is the expected behavior?*
> jest should mark the test as failure
> *Please provide your exact Jest configuration and mention your Jest, node,
> yarn/npm version and operating system.*
>
> import MockAdapter from 'axios-mock-adapter';
> import axios from 'axios';
> import actions from '../ActivationActions';
> import actionTypes from '../ActivationActionTypes';
> import Apis from '../Apis';
>
> const mock = new MockAdapter(axios);
>
> const mockDataSuccess = {
>     api: Apis.getActivationApi(99),
>     data: {activation_code: 12345},
>     status: 200,
>     response: {data: 'success'},
>     header: {'Content-Type': 'application/x-www-form-urlencoded'}
> };
> const mockDataError = {
>     api: Apis.getActivationApi(98),
>     data: {activation_code: 54321},
>     status: 500,
>     response: {data: 'error'},
>     header: {'Content-Type': 'application/x-www-form-urlencoded'}
> };
> mock.onPost(mockDataSuccess.api, mockDataSuccess.data)
>         .reply(mockDataSuccess.status, mockDataSuccess.response, mockDataSuccess.header);
> mock.onPost(mockDataError.api, mockDataError.data)
>         .reply(mockDataError.status, mockDataError.response, mockDataError.header);
>
> const successPromise = actions.activate(99, 12345).payload.promise;
> const errorPromise = actions.activate(98, 54321).payload.promise;
>
> describe('Activation actions', () => {
>
>
>     it('should fail to activate', () => {
>         errorPromise.then(() => {
>             expect(false).toEqual(true);
>         }, (error) => {
>             expect(error.response.status).toEqual(500);
>             expect(false).toEqual(true);
>         });
>     });
> });
>
>
> [image: screen shot 2017-04-03 at 8 37 37 pm]
> <https://cloud.githubusercontent.com/assets/4540917/24637266/cc4764ba-18ad-11e7-9402-3ddc206a71c3.png>
>
> ‚Äî
> You are receiving this because you are subscribed to this thread.
> Reply to this email directly, view it on GitHub
> <https://github.com/facebook/jest/issues/3249>, or mute the thread
> <https://github.com/notifications/unsubscribe-auth/AA5YZatiuFl2hQKfJ1xksMt6oVvSLGZ6ks5rsZIQgaJpZM4MyQsd>
> .
>
-- 
Dmitrii Abramov
www.abramov.io
 With every promise. `expect` throws an Error, so you either have to catch it with returned promise, or with `done()/done.fail()` callback, since this is an async test.    hm. i'm not sure if we can do this right now, but i'm sure we can have it after the custom reporters work is done (https://github.com/facebook/jest/pull/3064) and when @wtgtybhertgeghgtwtg replaces jasmine :) You can use `testResultsProcessor` for this.  thanks @danharper!
i din't realize that you actually maintain this plugin üòÉ   Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!

**If you are contributing on behalf of someone else (eg your employer)**: the individual CLA is not sufficient - use https://developers.facebook.com/opensource/cla?type=company instead. Contact cla@fb.com if you have any questions. Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks!  This a duplicate of https://github.com/facebook/jest/issues/2059. Expect throws, so done cannot be reached. For now you need to catch the error and call done.fail.    Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!

**If you are contributing on behalf of someone else (eg your employer)**: the individual CLA is not sufficient - use https://developers.facebook.com/opensource/cla?type=company instead. Contact cla@fb.com if you have any questions. Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks! thank you!
  <!-- Thanks for submitting a pull request! Please provide enough information so that others can review your pull request. The two fields below are mandatory. -->

**Summary**

Fixes `done.fail()` not passing arguments. Arrow functions don't bind `arguments`, so I used a regular function instead. 
Thanks @jwbay.

**Test plan**

Added a test for that.
  Thanks for this PR! For now let's hold off with working on it until @cpojer is back with some guidance. Hey @wyze, it's great to see you pop up here.

I agree it sucks when you pre compile your code that you couldn't use snapshots because those artifacts in a build folder would be ignored. I think your solution here is reasonable but I'm still hesitant and would like things to be less configurable rather than more. One of the problems is that all the tooling that we are building (for example Nuclide integration for Jest that can preview snapshots) will have to know about these configuration options. Can you walk me through how the reason compiler works? Is there any conceivable way that Reason could be just another transformer similar to babel-jest? That way snapshot files could simply be next to your `.re` files.

cc @chenglou

To @wesleyhall, the reason you are forced to use this is because that is the convention I decided on. I don't get paid to make things customizable because for some subjective reason you find double underscores ugly. If you would like to change this, I suggest you send a PR instead of continuing to whine about it here and in the other issue. Thank you. I don't necessarily disagree, however I have frequently voiced my concern about the complexity of supporting the customizability and I almost no value add to customizing the folder name. What wyze brought up about Reason, does make some sense however.

I would like my concerns to be addresses first. Further, what's important is that Jest keeps snapshot states consistent, for example if a test file gets removed, it will demand removing the snapshot file which requires this feature to have a reverse lookup from snapshot files to test files, making the implementation less trivial. After all this, adding two configuration options to map from test files to snapshots, to map from snapshots to test files and another one as proposed in this PR, seems quite the overkill and I'm unsure whether I'm willing to support the complexity of this if it doesn't add real value to users. Alright, I'm gonna close this PR for now and will wait for @wyze to respond to decide whether we'll want to reopen it. Hope that's ok with all of you :) Keep us up to date! Awesome, glad to hear it.  Use [mocking function](https://facebook.github.io/jest/docs/mock-functions.html#content) `jest.fn()`:
```js
console.warn = jest.fn(warn => {
  throw new Error(warn);
});
``` i just tried it and it worked:

```js
// test file
test('lol', () => {
  return new Promise((resolve) => {
    console.log('lol');
    resolve();
  });
});
```

```js
// setup file
global.console.log = () => {
  throw new Error('hey!');
};
```

result:
```
 __tests__/test-test.js
  ‚úï lol (3ms)

  ‚óè lol

    hey!

      at CustomConsole.Object.<anonymous>.global.console.log (setup.js:2:9)
      at resolve (__tests__/test-test.js:3:13)
      at Object.<anonymous>.test (__tests__/test-test.js:2:10)
      at process._tickCallback (internal/process/next_tick.js:109:7)

Test Summary
 ‚Ä∫ Ran all tests.
 ‚Ä∫ 1 test failed, 0 tests passed (1 total in 1 test suite, run time 0.661s)
```  <!-- Thanks for submitting a pull request! Please provide enough information so that others can review your pull request. The two fields below are mandatory. -->

**Summary**

Replace `...args` with function call to `arguments`

**Test plan**

CI green
  Just as @jwbay said (thanks ‚ù§Ô∏è). Use `require()`, it's definitely not _"non-standard"_.  You need to mount ([render into document](https://facebook.github.io/react/docs/test-utils.html#renderintodocument)) your component. You can also do it with [enzyme](https://github.com/airbnb/enzyme/blob/master/docs/api/mount.md)    It looks like some modules are not transformed through babel properly. I think you should reach out to react native repo, as they're maintaining preset with Jest configuration.  There's an answer on SO: https://stackoverflow.com/questions/43137058/jest-with-react-native-getting-issue  I like this idea, `-w` feels natural for watch mode... Breaking change, but really interesting I don't think it's necessary to break this. How about mapping "yarn w" to "jest --watch" in the scripts section?

________________________________
From: Rogelio Guzman <notifications@github.com>
Sent: Friday, March 31, 2017 3:00:48 PM
To: facebook/jest
Cc: Subscribed
Subject: Re: [facebook/jest] Feature request: replace "-w" CLI option to be "--watch" shorthand (#3233)


I like this idea, -w feels natural for watch mode... Breaking change, but really interesting

‚Äî
You are receiving this because you are subscribed to this thread.
Reply to this email directly, view it on GitHub<https://github.com/facebook/jest/issues/3233#issuecomment-290624534>, or mute the thread<https://github.com/notifications/unsubscribe-auth/AAA0KEB6H6mcWugNWEmSBjkfx0tOePHdks5rrJaQgaJpZM4MvIW7>.
  This projects use Jest v17. Can you tell if this happens on Jest v19? Does it work without `--watch`? I mean just `jest` in non watch mode and without `sudo` What happens when you do `--no-watchman`? @xin-nie any updates on this?  * What was the decision to use "HTMLDivElement" instead of "div"? Can we instead simply use `node.tagName`?
* Do you mind adding this plugin everywhere in Jest where prettyFormat is called?
 Thanks for doing this!  This should be a wontfix. I recommend you to call `jest.unmock('path/to/add')`.  Not sure if it was complete, but that looks good to me, we can add more tests later   Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!

**If you are contributing on behalf of someone else (eg your employer)**: the individual CLA is not sufficient - use https://developers.facebook.com/opensource/cla?type=company instead. Contact cla@fb.com if you have any questions. Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks! thank you!  Hey, thanks for reporting this!

I'm having some trouble reproducing it, can you provide a bit more info about version, env, etc? I'm still having some trouble reproducing it, am I missing something?

![kent](https://cloud.githubusercontent.com/assets/574806/24483310/1d443402-14ac-11e7-94fb-b6685f32f4f7.gif)
  hey @mrharel 
sorry, i'm not familiar with dynamic requires.
where is this functionality coming from?
```js
require(['./mod2'], (validate) => {
            res(validate(val));
        });
```

original node `require` takes only one argument and it's always a string, and so does Jest's implemenation of `require`, and i assume this is the reason your test is not working.

If you're using something else, then you'll probably need to mock the implementation of your `require` It looks like RequireJS ‚Äì http://requirejs.org/ so is it some kind of trasform plugin that converts these calls to something else? Please don't compile your code before running Jest on it. Jest should operate on your source files.

________________________________
From: Amir Harel <notifications@github.com>
Sent: Friday, March 31, 2017 2:47:15 AM
To: facebook/jest
Cc: Subscribed
Subject: Re: [facebook/jest] Failed to mock dynamic require call (#3219)


you can learn more about it here: https://webpack.github.io/docs/code-splitting.html<https://urldefense.proofpoint.com/v2/url?u=https-3A__webpack.github.io_docs_code-2Dsplitting.html&d=DwMCaQ&c=5VD0RTtNlTh3ycd41b3MUw&r=aFhQMFmdCAmrM__WP0c73w&m=FAKuP04Vy5OUali4sc8hQOQJPoA471YBsvFQIBV-Mos&s=NG4bf30aYikXKPOYjF5LK8Gt7NquwQOu0Gh-E4ncrVs&e=>

‚Äî
You are receiving this because you are subscribed to this thread.
Reply to this email directly, view it on GitHub<https://github.com/facebook/jest/issues/3219#issuecomment-290488128>, or mute the thread<https://github.com/notifications/unsubscribe-auth/AAA0KCL357Al88bFxISq4a-YkC88coktks5rq-qjgaJpZM4MrvlJ>.
  You're having 1 test suite, of course Jest is gonna be slower, because it pays the cost of environment virtualization/sandboxing and as far as I remember mocha doesn't. 
Try adding 100-1000 more files each and come back with the results, as thanks to virtualization Jest can run tests in parallel, while mocha runs them serially. Consider running in watch mode, which is likely much faster for re-running tests and faster/similar to mocha. It often doesn't matter how long your full suite takes but it does matter how long it takes to run tests after a file change.  hey @kentcdodds 
i also added a few snapshot tests for node assertion errors https://github.com/facebook/jest/pull/3225
you can use it to test your changes here, just update the snapshots when you change the messages :) @kentcdodds i was thinking that we should probably pull this functionality out into a separate module that's responsible for node assert errors only.
so in the jasmine hook that you used it will be:

```js
const assertionErrorMessage = formatNodeAssertionError(error);
if (assertionErrorMessage) {
  return this.addExpectationResult(
    false,
    {
      matcherName: SOME_CONSTANT_THAT_HAS_AN_ASSERTION_MATCHER_VALUE,
      message: assertionErrorMessage,
      passed: false,
      // ...
    },
  );
} else {
  // do wathever the default jasmine behavior is
}
```

this way whenever we kill jasmine (it is happening) we can still reuse the logic and it'll be fairly independent.

further on the assertion formatting, i think we can create a completely separate set of messages for each of the assertion failures.

i tried to throw a few errors in the console using this:
```js
try { assert.deepEqual(false, 1) } catch (error) { console.log(error) }
```

and i found that you can differentiate them using the `operator` property:

<img width="599" alt="screen shot 2017-03-29 at 3 22 10 pm" src="https://cloud.githubusercontent.com/assets/940133/24479323/955bcb9e-1493-11e7-85e0-1ffe72df1ff7.png">


so i think we can format messages like:
```
assert.equal(first, secord)

Asserted first value:
  'abc'
to equal second value:
  'cde'
Difference:
  <DIFF>
```

what do you think? hm. it looks like the entire message is dimmed. I'm not sure, but i think the reset ASCII code should fix it. (`chalk.reset`) @kentcdodds just a heads-up ‚Äì I'm working on refining this PR so that errors have proper stack traces and indenting. Will update it tomorrow or so.

Here's a preview:

<img width="543" alt="screen shot 2017-04-06 at 00 30 09" src="https://cloud.githubusercontent.com/assets/5106466/24729824/4e194cc0-1a60-11e7-9cf8-0ffe4dcda52e.png">
 I've taken all possible functions from [Assert docs](https://nodejs.org/api/assert.html). 

Since there's no way to differentiate form `assert.equal()` `assert()` and its alias `assert.ok` I've came up with this hint:

<img width="403" alt="screen shot 2017-04-06 at 11 14 36" src="https://cloud.githubusercontent.com/assets/5106466/24746681/5659b744-1aba-11e7-81b6-630a755dd22c.png">

This is how I print custom message assertion message:

<img width="334" alt="screen shot 2017-04-06 at 11 15 39" src="https://cloud.githubusercontent.com/assets/5106466/24746765/8d066e86-1aba-11e7-8191-2e558fc03f0a.png">

And more complex matchers:

<img width="325" alt="screen shot 2017-04-06 at 11 17 49" src="https://cloud.githubusercontent.com/assets/5106466/24746835/bfabcd0e-1aba-11e7-9542-253f92ce5ded.png">

They now look pretty similar to our `expect` messages ‚Äì this is why I've put the `assertionErrorMessage` function in `jest-matchers`.

Not so happy with `assert.ifError` `assert.doesNotThrow` and `assert.throws` but at least we have helpful stack trace:

<img width="468" alt="screen shot 2017-04-06 at 11 20 18" src="https://cloud.githubusercontent.com/assets/5106466/24746956/148d14cc-1abb-11e7-8cfb-54751a812a0a.png">
 Got support for throwing matchers:

<img width="549" alt="screen shot 2017-04-06 at 18 10 45" src="https://cloud.githubusercontent.com/assets/5106466/24764364/67c9677e-1af4-11e7-8df9-264b5a0cec34.png">

@kentcdodds thanks! I think this is ready for a review.
cc: @dmitriiabramov  This is nice! I would recommend not to put it into jest-matchers, though. It's a jest feature, not a jest-matchers feature (to be renamed to expect). Updated the messaging and moved `assert-support` to `jest-jasmine2`.  Let's do it.  Yeah, I bumped into it lately, but it doesn't show up on neither of our CIs, wonder why. That's odd. Which version of node is this? All versions we support :( https://github.com/facebook/jest/pull/3222 that should fix it. had the same issue locally, but both CIs passed just fine :/  I'd prefer not to do this. -i is an escape hatch. It would be better to find a way to run the tests in parallel.


________________________________
From: James McGuigan <notifications@github.com>
Sent: Tuesday, March 28, 2017 6:24:32 AM
To: facebook/jest
Cc: Subscribed
Subject: [facebook/jest] Feature Request: Add --runInBand to package.json options (#3215)


This is a feature request.

I currently have a setup that involves jest tests asyncronously creating and re-aliasing elasticsearch indices and part of their setup and tear down routines.

The tests run perfectly fine if I specify jest --runInBand on the command line.

If I run them without --runInBand I get random test failures due to the inherent race conditions with running these tests asynchronously.

What I would like is an option in package.json:

{
  "jest": {
    "runInBand": true
  }
}


Such that the flag is automatically applied to jest (like all the other package.json settings), without needing to manually specify it on the command line each time.

The lack of this feature may potentially confuse other developers on my team who attempt to run the jest tests without being explicitly aware the tests are dependent on the --runInBand flag being present, thus observing a broken test suite.

package.json is the correct place to document this configuration dependancy

Thank you.

‚Äî
You are receiving this because you are subscribed to this thread.
Reply to this email directly, view it on GitHub<https://github.com/facebook/jest/issues/3215>, or mute the thread<https://github.com/notifications/unsubscribe-auth/AAA0KI5INcWs1BFGWPxPeoYDHKjg1uQrks5rqCkQgaJpZM4Mq2Fy>.
 Create a npm script and don't think about it?
```json
"test:es": "jest -i"
``` @dickeyxxx you can put your configuration into a JS file and set `process.env.CI=true` since Jest 20, maybe that helps?  Do you have `git` installed and available through terminal?  Hi! Thanks for reporting this üôÇ ... It seems like a duplicate of #2959 right?   Can we potentially get rid of checking for .babelrc entirely? I think there is now a `*` option in babylon which will simply include anything.  It won't log the message, because Jest buffers all `console` calls so they can be displayed after test results reporters, and since `setTimeout()` delegates `console.log()` further into the function call queue, it's apparently called after we can collect it, which results in message not being logged.

To overcome it, you can either use [fake timers](http://facebook.github.io/jest/docs/timer-mocks.html):
```js
it('mock setTimeout test', () => {
  jest.useFakeTimers();
  setTimeout(() => {console.log('TIME IS UP');}, 1000);
  jest.runAllTimers();
});
```
or use `done` callback:
```js
it('mock setTimeout test', (done) => {
  setTimeout(() => {
    console.log('TIME IS UP');
    done();
  }, 1000);
});
``` Does it happen on Jest 19? Sorry but I cannot repro this. Can you setup a github repo with the case?
Also, what did you expect from second test? `setTimeout()` (and `done` inside) will be evaluated after the `expect()` call so it fails for obvious reasons. Cool, have fun testing! üòÑ   > Possibly this issue should be submitted to flow/flow-typed repo

Yup. `flow-typed` is the right place to address this.  This is quite interesting We should simply detect if "CI" is present. If it is, don't offer to write snapshots initially unless -u is specified. This should be the default. Happy to receive PRs for this :) there's a other things that are different on CI,
we should just have `--ci` flag that adds these defaults This'll be in Jest 20. See #3456.  It's already addressed, thanks! 
PR: https://github.com/facebook/jest/pull/3183  thanks!  Can you setup a repo with the case?  @robinpokorny thanks for helping improve the documentation. I agree with @excitement-engineer, let's keep the old examples around. We aren't deprecating the old way of testing for promises, we are only introducing a second way to test promises. We should also make sure to use `expect.assertions` for any async test ‚Äì it should become part of the mindset when people write tests :) @robinpokorny are you planning on addressing the feedback from my review? Yeah, let's add it to every async test to educate people about it :) Whether they'll use it in the end is not our problem then :D We did our best! Hey @robinpokorny, do you think you can give this another final pass? Thanks @robinpokorny, this is great :)  Hard to tell anything without a test case. Can you provide such?  Hm, this would be easy if we could load JS config instead of JSON. About js config? Here's a PR with a proposal: https://github.com/facebook/jest/pull/2445.  Can confirm it works this way. Should we treat this as bug? I guess so.
cc: @cpojer @dmitriiabramov  This is the bug in `node-resolve` package.

```js
require.resolve('./foo') // 'foo.js'
require.resolve('./foo/') // 'foo/index.js'

resolve.sync('./foo') // 'foo.js'
resolve.sync('./foo/') // 'foo.js'
```

Sent a PR to fix this directly in there ‚Äì https://github.com/substack/node-resolve/pull/124
Once it gets merged, we can bump the version in Jest.

Hey @thymikee üòÑ  Hey @kamilogorek! Thanks for fixing this :) Thanks for releasing `1.3.3` @ljharb! @cpojer do you think it's work it to bump the version in `packages/jest-resolve`, or keep it as it is, as it'll already match `1.3.3` during installation?

@pavelkucera you can reinstall `jest` and it should already grab fixed module :)  cc: @jkimbo  We'll keep both updated. The globals package isn't great and adds maintenance burden to the owner of that package. It's not really that much overhead to keep the list of globals in sync, especially as we are trying to reduce the amount of globals. The globals should be in sync in both packages. I think making one depend on the other just adds unnecessary complexity. I also recall that a while ago the plan was to kill the globals package or put it in maintenance mode, so that is why the jest plugin provides an alternative.  `wrapper.find(Icon)`? Closing, as this is not a Jest issue. If you need help setting up things with Jest, don't bother to ask on Discord, or Stack Overflow: https://facebook.github.io/jest/help.html  Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!

**If you are contributing on behalf of someone else (eg your employer)**: the individual CLA is not sufficient - use https://developers.facebook.com/opensource/cla?type=company instead. Contact cla@fb.com if you have any questions. Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks! @thymikee  did we have plans to remove `spyOn` from global variables?
anyway, right now it is still in `global` so we should probably add it here We will remove this global. We don't officially support it. We are diverging from Jasmine to build a better test runner. The current set of globals that is in our documentation is the only official interface. Anything else may change at any time.  @aaddaamm does this help?
https://facebook.github.io/react/blog/#mocking-refs-for-snapshot-testing Nope, we don't automock `refs`. I can see it's a pain, but it's rather `react-test-renderer` or other react addons responsibility to make it as smooth as possible. Good luck üëç!  I'm not sure if we want it, but if we do, it's a "Good first task" case. cc: @cpojer  Thanks for looking into this! But before you start any work, I'd like to wait for @cpojer to confirm we actually want this feature.

The logic controlling watch mode is inside jest-cli package (watch.js file) so you could start from that place. I imagine we could add another key listener and invoke a function which will spawn asynchronously one of these commands, depending on OS: open, xdg-open, start. As an argument you'd pass a path to coverage directory (from config).  Yeah, now that we collapse usage, I'm not super opposed to this. We can show it only if `config.coverage` is true, as well. @anilreddykatta this is because `coverageDirectory` was not set explicitly and defaulted to "coverage"   Test pass because nothing throws inside `it`. UnhandledPromiseRejectionWarning is a warning, not thrown error. And it's probably problem in your code. This blog post should help you with tracking the root cause: http://2ality.com/2016/04/unhandled-rejections.html  @thejameskyle could you review? Please hold off on this, let's not change around the licenses until we're sure we're doing the right thing. It's been confusing in other situations to have multiple licenses within a single repository so there may be some other way of peacefully resolving this. I will follow up with folks offline.  unfortunately it's not possible now because that will be very very hard to implement.

the coverage is generated by instrumenting the code that's being run with runtime coverage checks + exporting the results after the process is finished. This process is not generic at all, and since pretty much anything can be run as a child process, there's no possible way we can collect coverage from these processes. yeah, it's definitely possible and `nyc` is very generic and independent to do this. But in Jest i think we're a little far from it. 
Our transformation (and instrumentation) logic heavily depends on jest environment and test configuration. It provides a lot of benefits, but also makes it hard to work on things like this one Closing this as wontfix for now, it is unlikely we'll get to this.  I think we could apply ISC license to `pretty-format` and add ownership notes, is that right/ok? @thejameskyle: I understand there was an agreement between you and Christoph at the time.
Since no one else but you two knows what the agreement was about, we need him to handle this with you.
This means there might be some delays as @cpojer is on PTO right now (marriage and all the stuff).  `resolver` is not officially released yet, it will be in Jest v20. Also, @amasad can you please update Jest to v19.0.2 on repl.it? Yeah awesome! Thank you. We already do something like that (but with various luck, as you can see üòÑ): here's corresponding PR #3191.  In 3-4 weeks, after @cpojer returns from his PTO. btw, you can use `jest@next` to get some features ahead of time. I also encourage you to send a PR with the availability note ([like here](http://facebook.github.io/jest/docs/expect.html#resolves)) if we missed something. Unfortunately not. You need to ask @dmitriiabramov  cc: @hramos   Oh, in this case you should discard usage of snapshot for stack trace and use regular matchers instead.  i haven't looked deep into the issue, but what i found interesting is:
```
~/tmp/jest-arraybuffer-issue > yarn test
 FAIL  ./test.js
  ‚óè fetch ‚Ä∫ should fetch a document

    expect(value).toBeInstanceOf(constructor)

    Expected value to be an instance of:
      "ArrayBuffer"
    Received:
      []
    Constructor:
      "ArrayBuffer"

      at test.js:8:26
      at process._tickCallback (internal/process/next_tick.js:109:7)

  fetch
    ‚úï should fetch a document (372ms)

Test Suites: 1 failed, 1 total
Tests:       1 failed, 1 total
Snapshots:   0 total
Time:        0.531s, estimated 1s
Ran all test suites.
```

and right after that
```
dabramov-mbp ~/tmp/jest-arraybuffer-issue master* ./node_modules/.bin/jest
 PASS  ./test.js
  fetch
    ‚úì should fetch a document (398ms)

Test Suites: 1 passed, 1 total
Tests:       1 passed, 1 total
Snapshots:   0 total
Time:        1.136s
Ran all test suites.
``` ok. sorry, i missed `--env node`, now i can reproduce it consistently fails on all node versions that i tried, even without Jest.
```
dabramov-mbp ~/tmp/jest-arraybuffer-issue master* nvm use 6.2.2
Now using node v6.2.2 (npm v3.9.5)
dabramov-mbp ~/tmp/jest-arraybuffer-issue master* node
> require('isomorphic-fetch'); fetch('https://google.com').then(response => response.buffer()).then(buf => console.log(buf.constructor.name));
Promise { <pending> }
> Buffer
```

This is probably related to this change:
https://github.com/bitinn/node-fetch/commit/f0d0675d00845c59ac4bac58d8c9b89d2a39d38e ah. i know what's going on there.
Because we run tests in a separate isolated context (inner scope) we end up with two instances of `ArrayBuffer` (one from the inner scope, and one from the outer scope, where the Jest runner runs itself).
Both are exactly the same, both have `constructor.name === 'ArrayBuffer'`, but they come from different node environments so they are two different objects and `instanceof` will return `false`.

The change that you suggested would fix the issue, since the it will share the same object between two environments.

We don't share all properties between outer and inner context, because if a test modifies something shared `like Array.prototype.toString = () => 'lol'` that will affect other test files (and that's really bad).

one thing i'm not sure is why `fetch` returns an instance of `ArrayBuffer` from the outer scope, rather than from the inner scope of the test. ok. i'm not sure what exactly is going on, but it seems like the `Buffer` that's created here
https://github.com/bitinn/node-fetch/blob/f0d0675d00845c59ac4bac58d8c9b89d2a39d38e/src/body.js#L269
is an instance of an outer scope `Buffer` and not inner scope. that's why the check fails  when is this used in Jest?
i remember only one place here https://github.com/facebook/jest/blob/master/packages/jest-jasmine2/src/setup-jest-globals.js#L33
but that returns the result.
I remember it used to be coupled to jasmine matchers, but we don't have them any more either :) i wonder if we can kill this function completely and just add a placeholder with `throw new Error('deprecated')` or something. But i guess it can be the next step Good stuff, @wtgtybhertgeghgtwtg.  Please provide a repro, this doesn't tell much i can't tell much about your project based on your stack trace, but the problem seems to be in this file `validateCreationStepComplete (src/utils/Something.js:93:1424)` since it says it's `1424 column` which seems off.

If your original file is not minified, that probably means that there's some minification transformation.

there's a `retainLines` option in babel, we set it by default, but you can try force setting it to see if it helps So it's not a Jest issue, but Babel's. Look at their issue tracker: https://github.com/babel/babel/issues?q=is%3Aissue+is%3Aopen+comments+label%3A%22comment+attachment%22  Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!

**If you are contributing on behalf of someone else (eg your employer)**: the individual CLA is not sufficient - use https://developers.facebook.com/opensource/cla?type=company instead. Contact cla@fb.com if you have any questions. Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks! Don't worry about it. We need to deal with a segfault on Node 4 happening randomly for unknown reason. 

Anyways, thank you for your time on making docs better! Much appreciated :)   @cpenarrieta Please don't hate me. I forgot to tell you I've tackled the issue in this PR https://github.com/facebook/jest/pull/3180. Sorry about that.  @bcoe thanks for taking care of this!
i'm really happy that istanbul is finally moving to monorepo! :)  Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!

**If you are contributing on behalf of someone else (eg your employer)**: the individual CLA is not sufficient - use https://developers.facebook.com/opensource/cla?type=company instead. Contact cla@fb.com if you have any questions.  I think it's made on purpose, because you may want to run the tests once more. See the messaging:
<img width="381" alt="screen shot 2017-03-24 at 19 16 13" src="https://cloud.githubusercontent.com/assets/5106466/24307949/61d2b93e-10c6-11e7-824f-c2850255fd4a.png">
cc: @mikaelbr  If we exit the process, then these messages under "Show" won't make sense. Wonder how can we improve it. Get rid of it completely and only leave "Close"?
Ideas welcome! Then I strongly recommend the watch mode üòÑ. I like the idea of `notifyType`, but just thinking it can be too much. I wonder if anybody uses "Run again" option from notifications.  @mikaelbr did you have any suggestions for this?  @wtgtybhertgeghgtwtg can you weigh in?  @rogeliog mind looking at this? @timjacobi I think that it's an interesting point.

Right now pressing 'a' would run all of the tests, but I agree that it might be a bit confusing... One solution that I can think of is to pass different [configs](http://facebook.github.io/jest/docs/configuration.html#options) for each.

For example:

```
// package.json
 "scripts": {
    "test:watch": "jest --watch --config jest.config.unit.js",
    "test:e2e": "jest --watch  --config jest.config.e2e.js"
  }
```

```
// jest.config.unit.js

module.exports = { /* config for unit test */ }
```

```
// jest.config.e2e.js

module.exports = { /* config for e2e test */ }
```

Maybe overriding a key like [testMatch](http://facebook.github.io/jest/docs/configuration.html#testmatch-array-string) might work  Thank you. Shouldn't there be spaces around the dash? Thanks for the clarification. :)  This one needs patching our test runner. Which means, we would need to further alter Jasmine code (which is ok I guess, because we're currently rewriting it). So, I would wait for @dmitriiabramov to weigh in on this before sending a PR. 

The code you'll likely need to change sits [here](https://github.com/facebook/jest/blob/d1fd996cd48573e30168a72bbb349278ae55e49d/packages/jest-jasmine2/src/jasmine/Spec.js#L119) (be aware that @wtgtybhertgeghgtwtg is going to refactor this module to a class). You'll need to adjust the error and build similar messages to [these](https://github.com/facebook/jest/blob/v19.0.2/packages/jest-matchers/src/matchers.js#L100). Formatting methods like `matcherHint` or `printExpected` will be available, since `jest-jasmine2` depends on `jest-matcher-utils`.
 ah yeah. i ran into the same issue with eslint a while ago. and yes, we need to catch assertion errors (they're pretty easy to distinguish from all other errors) and pretty-print/re-throw them with better formatting!

previous issues:
https://github.com/facebook/jest/issues/2237
https://github.com/facebook/jest/issues/1230 >I'm working on this right now (just fudging with my local node_modules to start)

Oh, please don't do it to yourself! You'll be better of forking Jest and linking it (instructions in [CONTRIBUTING.md](https://github.com/facebook/jest/blob/master/CONTRIBUTING.md)), because since last release we rewritten our Jasmine fork to be modular.  @cpojer I think we should start making prereleases (e.g. from master), like Yarn does. On board with pre-releases but the next major for Jest may be in a month from now unfortunately.  Some of our docs note that features became available in Jest 19, would you mind adding the same note for these with "Jest 20"? :) These are markdown-only changes, I don't think the Travis failures are related.  This doesn't make any sense.  * Make a list of all files that do not use @flow.
* Potentially add @flow to all files.
* Audit if there are files that do not use "use strict"
* Check whether babel inserts it automatically. If not, make babel insert it automatically.
* Remove "use strict" from all files and the check from dangerfile.js I think our code works with strict mode, given that it is only 13 files that don't have it, it is best to add the transform and remove "use strict". It's fine to operate on `packages/` for now. Oh, and test files don't need flow annotations at this point. fyi i'm also trying to integrate https://github.com/gajus/eslint-plugin-flowtype to our pipeline to keep flowtypes strict  i think @wtgtybhertgeghgtwtg is working on the jasmine part right now @mpontus Are you planning on submitting a pull request for these things? :) Thanks @mpontus, this is great. I'll probably open another issue some day about increasing flow coverage across Jest.  Thanks!  We do not support node 4.0.0. Please upgrade to the latest version of node 4.x or the latest version of unstable (node 7.x).  This is great. It's ironic how we took a single file build of Jasmine, pretty-printed it and now we are turning it back into a set of modules.  Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!

**If you are contributing on behalf of someone else (eg your employer)**: the individual CLA is not sufficient - use https://developers.facebook.com/opensource/cla?type=company instead. Contact cla@fb.com if you have any questions. Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks! Love it!  Thanks @andrewimm. As a follow-up, I feel like it may make sense to turn the platforms object into a Set in the constructor so that lookups will be faster. Would you be interested in sending a PR for this?  There is a "coverageReporters" config option that can be used for this. i think the alternative option was to implement `.js` based configs, so it's possible to do something like
```js
const baseConfig = require('./base-config');

module.exports = {
   ...baseConfig,
  coverage: true,
};
``` @dmitriiabramov there's a PR for that: https://github.com/facebook/jest/pull/2445  The problem:
Jest needs to support different platforms when it prints its output (terminal, nuclide, html, terminal with no color support, snapshots)

There's a few ways we can implement that, but after our discussion with @kentaromiura we focused more on investigating some universal jest format.
Here's my thought on what it may look like:

1. A `jest-print-utils` package that will export the following API:
```js
type JestFormatedString = string;

type JestPrintUtils = {
  green: (input: string) => JestFormatedString,
  red: (input: string) => JestFormatedString,
  bold: (input: string) => JestFormatedString,
  dim: (input: string) => JestFormatedString,
 // ...
};
```

`JestFormattedString` type is jest a string that follows jest specific print format (a string with XML-like tags describing fonts)

Example:

```js
import {red, green} from 'jest-print-utils';

const jestFormattedString = `hey, i'm ${green('green')}. and i'm ${red('red')}`;
console.log(jestFormattedString);
// hey i'm <JEST_GREEN_TAG_UUID>green</JEST_GREEN_TAG_UUID>. and i'm <JEST_RED_TAG_UUID>red</JEST_RED_TAG_UUID>
```

where UUID tags can be found in a common constant definition (to make sure they're unique and don't overlap with hmtl markup or similar)

```js
JEST_UUID_TAGS: {
  RED: `RED_${uuid.gen()}`,
  GREEN: `GREEN_${uuid.gen()},
  // ...
}
```

2. A `jestFormattedString` converters that can convert `JestFormattedString` type to any other string types (html, ASCII, strip tags completely, or something else)
Example:
```js
import {green, toHTML, toASCII, toNoColors, toSnapshotFormat} from 'jest-print-utils';

const str = `i'm ${green('green')}` // => 'i'm <JEST_GREEN_UUID>green</JEST_GREEN_UUID>

toHTML(str); // i'm <span style='color: green'>green</span>
toASCII(str); // i'm 0[m21green (or whatever the format is)
toNoColors(str) // i'm green
toSnapshotFormat(str) // i'm <green>green</green>
```

cc @kentaromiura @thymikee  A couple of thoughts:
* Let's please not call it "util". I hate "util"s. I want to get rid of all the files and packages called "util" in Jest.
* If we do this, we gotta stop using `red` and `green` and give semantic meaning to the way we format text. Instead of red, we should use `error`. This will also allow to change what that looks like in different places, like Nuclide.
* I'm a bit worried that the end result here is a slightly more structured string format that we'll regex over to turn it from one format to another, the added value isn't actually that much. How about we start using JSX with different renderers? That seems to me like the best way to build a structured data format for Jest. Are we seriously considering JSX to format messages? If so, I think I could give it a try and implement this (after we settle this is actually a good idea).

I imagine formatting message like this:
```js
const {JestFormat, Default, Error} = require('jest-format');
const jsx = <Default>Some <Error>text</Error> message</Default>;
```
Which then would go through Babel to output something like this:
```js
const jsx = JestFormat.createElement(
  Default,
  null,
  'Some ',
  JestFormat.createElement(Error, null, 'text'),
  ' message',
);
```
Which would format to something like this:
```js
JestFormat.createElement = function(type, props, children) {
  const result = {
    $$typeof: Symbol.for('JEST_FORMAT'),
    props,
    type: Default,
  };
  return result;
};
```

This way we could easily write recursive renderers for html, ansi, etc and custom ones for editors support, as they would need to deal with JSON only.

Let me know what you think @dmitriiabramov @kentaromiura  Yeah I think this could work. We don't need React, we just needn't JSX with the @jsx pragma. Curious what this would look like. that actually looks amazing. How will we send serialized objects to other processes though? A message will be JSON data after all, so it shouldn't be problematic. As per Christoph suggestion, using the [jsx pragma](https://babeljs.io/docs/plugins/transform-react-jsx/) it will be possible to create a function like:
```js
/** @jsx format */

const format = (type, _, ...parts) => {
  return {
    type,
    parts,
    [Symbol.for('custom-format')]: true
  }
}


var message = (
  <message>
    Error: expected value to be (using ===):
    <expected>"bar"</expected>
    Received:
    <received>"foo"</received>
  </message>
);
```

Then we could just feed pretty-format the most appropriate plugin to have that message output how we wants;
and example of the html render might be similar to this:
```js
{
    test: x => x[Symbol.for('custom-format')],
    print: (val,print,opt,color) => (
      '<span class="jest-'+ val.type +'">' + val.parts.map(val => {
        if (typeof val === 'string') return val;
        return print(val, print, opt, color)
      }).join('') + '</span>')
}
```
https://jsfiddle.net/fjfuabya/ @kentaromiura that looks amazing!
we only need to fix the whitespace. but i think we can just add some padding to elements like `<expected>` and `<received>` Actually we could adjust whitespace and indentation in props:
```js
<message indent={1}>
    Error: expected value to be (using ===):
    <expected indent={1}>"bar"</expected>
    Received:
    <received indent={1}>"foo"</received>
</message>
```

Also, it's going to be a ton of work to change all the messages üòê  and what about newlines? :)
how to we tell
```
this is <green>green</green>
```
from 
```
this is
<green>green</green>
```  This is great. Can we do this:

* Move all the jasmine files into `src/jasmine` so we have a clear split between the test runner code and the jest adapter?
* Add the Facebook copyright header on top of the Jasmine one. These files only use the algorithms from Jasmine but we are going to move away from them entirely.

Maybe something like:
```
// jest's copyright header
// This file is a heavily modified fork of Jasmine. The original license of the code:
// Jasmine license.
```

  `npm test` is a special command for npm scripts. Does it fail if you run `npm run coverage`?  Unfortunately I'm not able to clone it (out of my workstation for a couple days). You can try running without verbose, and reinstall node_modules. If it still breaks, please add information about your environment (node version, OS, etc). 
Good luck!  I think it might be related to how Istanbul wraps functions Yes, likely the istanbul problem @rogeliog is pointing out. I think https://github.com/gotwarlost/istanbul/issues Thanks for commenting back with the root cause, this is really good for people reading this thread in the future! üôÇ  **Summary**

Adds Deezer to the list of jest users.
 Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!

**If you are contributing on behalf of someone else (eg your employer)**: the individual CLA is not sufficient - use https://developers.facebook.com/opensource/cla?type=company instead. Contact cla@fb.com if you have any questions. Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks! Moved to correct alphabetical location. It looks like you added two entries now. Will reopen once it is fixed.  **Summary**

Context: #2970 

This diff is the initial RFC for the multi-project runner. This is the proposal that merges all functionality into jest-cli which will make Facebook's internal multi-runner obsolete. The initial draft changes the Jest CLI to operate on a list of `TestContext`s, which is a new name for HasteContexts with the configuration object added to it. This is basically the entire extent of the added complexity to make this work, the rest is refactors that should be made regardless.

The refactoring of the TestSequencer, runCLI and usage of async/await alone make the codebase actually easier to understand and concerns are separated better with this diff applied. These changes were already landed as part of this PR.

![20-multi-runner](https://cloud.githubusercontent.com/assets/13352/23987088/ff3b9ec8-0a6a-11e7-8e36-bf4e04ec6a49.gif)

**TODO**
* We need to make it so that there is an overall config that is used for the multi-runner. Currently this is the first one it finds but I believe the right way to go about it is an entirely separate configuration object that only defines behavior rather than tests to run.
* Make watch mode work with this. I wanted to get to a MVP asap, so I left this one alone for now.
* The printed information on the CLI doesn't show the proper paths to tests because it uses the wrong config object to determine the root. It should be the working directory or the root of the fake configuration.
* We need a customization option for the reporter output per test so that we know which project/config a test belongs to. Not sure yet how to best customize it and what information to show, given that we only have one line.
* I left a few TODOs in the code.

**Test plan**

* `cd examples`
* `jest --experimentalProjects */ --no-cache`
 I would like to take a moment to celebrate. Please take a look at my afternoon's journey through the attached diffs. This issue has been on my mind for an entire year now and is a result of all the work that went into Jest by all of you, the community members as well as the countless discussions I had about this with @dmitriiabramov. I finally made a breakthrough over the last couple of weeks after being forced by @ljharb (and some other people who insulted me) to organize my thoughts. I couldn't have done it without you.

I was also guided only by Flow and prettier (which is an amazing workflow, btw.) and did an occasional sanity check that Jest wasn't broken on the way. After I was done with the last line of code after a couple hours of intense focus, everything worked on the first try. I'm happy, given that I haven't written any real code in months. üéâ Not at all! Appreciate any of your comments, please do it more often. Rebased. I shipped all the code that was done as preparatory work including tests in #3165 and #3166 so that this PR can focus on the actual multi-project runner. RFC updated. All tests are passing with this and there are no more major issues but there is a lot of work that still needs to be done before we should ship it. The changes up to now fix a number of things on top of the initial RFC:

* The "No tests found" message now lists each project individually instead of printing "No tests found" multiple times.
* Reporters now receive a "Test" object instead of the config. Every action on a test now uses the appropriate context and the "TestRunner" instance doesn't receive a singular context any more.
* Remove "runnerContext" and pass a set of all contexts based on the tests that were passed to TestRunner on to reporters. This makes snapshot updates work properly as well as coverage reporting.
* Cleanups around how patterns are dealt with.

More TODOs:
* Refactor the use of configs into a global and context local config.
* Add "Ran all test suites [‚Ä¶] in X projects."
* Watch mode.
* Add an integration test for the multi-runner (although the examples folder can act as such an integration test.
* See TODOs above in the original comment.

Note: I'm getting married this week and will be on my honeymoon soon, so it'll be a while until this diff is done. I do appreciate intermediate reviews up until this point though as well as suggestions if this could be broken up into smaller pieces, something I currently can't conceive. Nevertheless, this diff isn't as big as I thought it would be. Also happy if anybody wants to build on top of this PR to work on any of the TODOs that I outlined. Are we thinking of adding a way to specify projects that are in the same root but that use different config? 

```
- jest.config.someOtherStuff.json
- jest.config.e2e.json
- jest.config.json
```

Or would I need to trick Jest by nesting each config into its own directory and then setting the root of them to `../`? Pulling things out of this PR to make the things I add on top of the existing code easier to review over time: https://github.com/facebook/jest/pull/3289 Done:
* Watch mode now works.
* Added "Ran all test suites [‚Ä¶] in X projects."

Todo:
* The CLI doesn't show the proper paths because we are using the wrong config object to determine the root, this also makes the pattern mode highlight a bit broken right now I believe.

Follow-up before Jest 20, but shouldn't block this PR (it would get way too big):
* Integration test using the examples folder.
* Refactor the use of configs into a global and context local config. Right now everything uses the first config it finds, which is not ideal.
* Need a customization option for the reporter output per test so that we know which project/config a test belongs to. Not sure yet how to best customize it and what information to show, given that we only have one line.

@thymikee @rogeliog ready for another round of review! Wonder if this commit `Refactor watch mode prompts.` could be extracted to separate PR? Alright, the two other diffs were pulled out and are merged and we are fully rebased. Now we are back down to a manageable +500 -500 diff :) Ok, addressed all of Dmitrii's concerns except the config split which we agreed we'll do in a follow-up. Also made the paths relative to `process.cwd()` instead of the individual rootDirs when running with multiple configs.

This diff is now ready for a final review (minus some CI issue that I'll fix :) ).  Jest is completely test runner agnostic. For example, Jest can wrap other test runners entirely and for a while we shipped with both jasmine1 and jasmine2. However, we have never capitalized on the difference between Jest "the test-framework runner" and the test runner (currently Jasmine) itself.

TODO:
* Fix up runTest.js and make it more generic. This piece is re-used in jest-runtime and it should be more reusable.
* Solidify the API between things like `jest-jasmine2` and `runTest.js`/`TestRunner.js`. Currently the API is `jestJasmine2(‚Ä¶).then(results => ‚Ä¶)`. The result currently looks like this: https://github.com/cpojer/jest/blob/master/types/TestResult.js#L126 which comes from Jasmine. We should rename these things to make more sense and normalize the results we get from Jasmine.
* Make modules in `jest-jasmine2` generic so that the setup-pieces can be shared across test runner adapters.
* Figure out which test runners we want to wrap officially.
* Build a complete replacement for Jasmine.

cc @MarcoWorms  @jeanlauliac mentioned it would be great if Jest could come with a kick-ass fs mock out of the box.

* This would work well for integration tests.
* We can potentially provide the same for other data sources (http, sockets etc.)

Goal:
* Ships as part of Jest, no configuration.
* Easy way to enable it (Similar to `jest.mock('fs')`?). I was thinking about the same thing, this would be great! FS and HTTP requests sound like a great idea @ide has a proposal for this! In my mind, it'd be great to just have a simple mock API where using `fs.writeFile` writes to a pure memory filesytem instead of disk, and where `fs.readFile` allows to read files that have been written as such. Of course everything else would also work on that memory fs, such as `fs.createReadStream`, `fs.open`, `fs.watch`, etc. In practice, tests could write necessary files in `beforeEach`, call the code to be tested, and possibly verify content of files afterwards.

```js
fs.mockMemoryFS('posix');
const fs = require('fs');
const smth = require('../smth');

it('works', () => {
  fs.writeFileSync('/var/test_file', 'foo');
  smth('/var/test_file');
  expect(fs.readFileSync('/var/test_file', 'utf8')).toMatchSnapshot();
});
```

We could imagine supporting explicitely posix/win environment no matter the real host OS, and having the mock automatically create traditional posix directories such as `/tmp`.

(As for sockets/HTTP, that'd be amazing to be able to create a completely virtual network of machines and being able to test client/server interactions, etc.)  thanks @ErnestoLCortez!
circle CI is currently failing because the snapshots for the tests need to be regenerated and added to the repo as well!
you should run `jest` with `-u` flag

you can read about snapshot testing here: https://facebook.github.io/jest/docs/snapshot-testing.html#content thanks @ErnestoLCortez!  Hi! Thanks for reporting this

I think it has to do with `vm`, which is what Jest uses for the environment https://github.com/facebook/jest/blob/master/packages/jest-environment-node/src/index.js

This is what I get when running it in a Node repl
![screen shot 2017-03-17 at 4 03 32 pm](https://cloud.githubusercontent.com/assets/574806/24065841/4c51bf1a-0b2b-11e7-858a-3d854fb057ac.png)
 looks like it has been fixed here https://github.com/nodejs/node/pull/11266 yeah. i can confirm that it works on node `7.7.3`

```
dabramov-mbp ~ node -v
v7.7.3
dabramov-mbp ~ node
> const sb = {a: 1, b: 2, c: 3}
undefined
> vm.createContext(sb)
{ a: 1, b: 2, c: 3 }
> vm.runInContext('delete this.a;', sb)
true
> sb
{ b: 2, c: 3 }
``` @gdborton that would be the easiest! 
  Nice!  Thanks for bringing this up. For now, we have no plans to change this behavior, though.  Although, `jest/valid-expect` is merged(https://github.com/facebook/jest/commit/e886064828f8f2517581ccc0ced49ee47716a3c3), I think it hasn't been released since it was merged after the 19.0.2 release... cc: @cpojer  This will be officially in the next Jest release, probably in 4 weeks from now. Sorry about the confusion.  I don't know what this issue is or why it is posted on our issue tracker. It seems like a question. Please ask on stackoverflow or on our discord channel. Thanks! The problem is in your code, not in Jest or jscodeshift. Can't reproduce it on Node 4, 6, 7. Tried master of your repo.  oh yayy!  cc @wtgtybhertgeghgtwtg 

It doesn't look like this test is failing on appveyor on master, so I'm not sure what the problem here is?  Let's merge this and iterate on it over time. While there are some caveats, we have shipped inline requires at Facebook and it was a TTI win for facebook.com, so it may even be beneficial outside of tests. @voideanvalue can elaborate on the wins.  Can we bring back the removed test and make sure that it works with regular slashes? I don't think we have this test anywhere else. Nice!  This is not how it works. You have to use `jest.resetModules()` and re-require the mocked module. I also believe this is what clearMocks does; you shouldn't use it together with resetMocks.  Hmm, this is interesting but I believe this metadata should be kept in source control or on the code review platform rather than directly inside of the snapshot. The update comments will grow and become irrelevant over time and they are just going to be clutter. Also, if a snapshot file gets deleted or a test gets renamed, keeping track of this metadata may be annoying. i think with the amount of snapshots some people work every day it'll be very hard to maintain all this metadata and provide messages. I can easily update 100 snapshots in one diff with various api changes, and providing messages for each would be a disaster :)
i think for special cases we can always use a snapshot name.
```js
expect(abc).toMatchSnapshot('explain what i\'m doing');
``` I'll close this for now. It's an interesting idea and I'd be curious to see a POC in or outside of Jest but I doubt we'll get to work on this.  See #2547.  eslint-plugin-jest 19.1 (will be released later this week) will have a lint rule that will warn for this use-case. you can install eslint-plugin-jest@next for now.  Jest has `beforeAll`.  Not sure your explanation makes sense but the docs change is ok. Thank you!  Cannot repro, both tests pass in my case (I use `transform-async-to-generator`).  **Summary**

This enables prettier for the types and integration tests folders. Unfortunately it isn't easy to exclude node_modules from the CLI when matching against the integration tests folder so I changed it to filter first and pass the entire list to the prettier CLI. At this point it occurs to me that we should probably just use the prettier API directly.

**Test plan**

yarn test  **Summary**

This diff enables prettier as a lint step for Jest on CI. We are now officially using prettier for Jest.

**Test plan**

* Change a file, run `yarn lint-prettier` and see a human-readable error that tells you what to do. Run `yarn prettier` and commit your change. Now `yarn lint-prettier` should succeed.
* I changed a bunch of other modules and what they print to look nicer and cleaned up the scripts folder in general.
 I would like to add two thoughts:

* I despise commit hooks which is why I opted to make this a lint step during `yarn test`. I don't believe in blocking commits even though arguable it may be a better user experience if they don't run tests locally because they have to wait for CI to yell at them. People should run `yarn test` locally though and this way the experience is the same as using eslint.
* I made this a JS script so that it hopefully also works on Windows.  Try to run Jest with `--no-cache` once when you change `.babelrc`.  **Summary**
Fully switch the codebase over to prettier.

**Test plan**
yarn test  **Summary**

#impact

**Test plan**

yarn test  This doesn't repro locally on our CI or locally. Maybe there is something wrong with your version of npm? I just bumped into this issue! 

@mpontus @okonet you can use `jest@next` where it's fixed or otherwise you need install `babel-polyfill`. 

Jest used to autoinclude `babel-polyfill` (and still does it in 19.0.2), but since it caused memory leaks, we moved to using `regenerator-runtime` only, which ships with our transitive deps (so since Jest v20 if you're using npm >=3 or yarn you don't need to install anything for async/await support). 

The problem is that we eradicated `babel-polyfill` from docs, but forgot to include this diff https://github.com/facebook/jest/pull/2755 in `19.0.2` and didn't roll out a decent release since then (only `jest@next` tag). 
Sorry about the inconvenience!   Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!

**If you are contributing on behalf of someone else (eg your employer)**: the individual CLA is not sufficient - use https://developers.facebook.com/opensource/cla?type=company instead. Contact cla@fb.com if you have any questions. Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks! Thanks but we'll be leaving this in for a while. It is only available in the latest version of node and it isn't LTS.  Personally I don't see the need for those particular matchers, but I think [`expect.extend`](http://facebook.github.io/jest/docs/expect.html#expectextendmatchers) is something that you might want to look at. `.toBeTrue` doesn't provide any value over `toBe(true)`. Normally custom matchers are used for better messages but there isn't anything better that we could print when using `toBe(true)`, so a custom matcher doesn't make much sense.  **Do you want to request a *feature* or report a *bug*?**
enhancement!

**What is the current behavior?**
We skip a lot of tests on Windows.

**What is the expected behavior?**
To fully (or as much as possible) support Jest on Windows.

@wtgtybhertgeghgtwtg is already making some awesome work to make that happen. 
This issue is created to have a track on what's left to fix.
  Since this is currently a regex, we'd have to turn this into fuzzy matching. If there is an incredibly fast library that can do fuzzy matching, I'd be happy to support a PR that changes the regex for both the test path and test name patterns into fuzzy matchers.

cc @rogeliog @zouxuoz cc @rogeliog  I'll close this issue in favor of https://github.com/facebook/jest/issues/3120 This is #3120  <!-- Thanks for submitting a pull request! Please provide enough information so that others can review your pull request. The two fields below are mandatory. -->

**Summary**

Storing ANSI characters in snapshots of `jest-matchers` isn't very helpful and adds unnecessary noise, making it harder to review. This is a proposal to change it to something more human-readable like `<green>` or `<red>` or `</>` for color reset sequence. 

**Test plan**

Look at snapshots diff
 cc: @dmitriiabramov  Lovely! This makes snapshot files a lot more readable. Can we make this a utility function somewhere and use it for all the matcher snapshots? I think we also do this in other files. @kentaromiura advised that it may be a good idea to write a custom `snapshotSerializer` so we don't have to create new matchers. What do you think @cpojer? I like the idea overall but tagging Jest code with `Symbol.for('toThrowErrorMatchingSnapshot')` simply to make our own tests better doesn't seem like a great way to go about it :( i wonder if it would make sense to go the other direction.
Use XML-like tags for coloring our text and then convert them to the weird ANSI sequences. This way we could probably make it more compatible with other platforms (like generating HTML reports) üéâ 
 
<!--
  0 failure: 
  1 warning:  Changes were made...
  
  
-->


<table>
  <thead>
    <tr>
      <th width="50"></th>
      <th width="100%" data-danger-table="true">Warnings</th>
    </tr>
  </thead>
  <tbody><tr>
      <td>:warning:</td>
      <td>Changes were made to package.json, but not to yarn.lock - <i>Perhaps you need to run `yarn install`?</i></td>
    </tr>
  </tbody>
</table>



<p align="right">
  Generated by :no_entry_sign: <a href="http://github.com/danger/danger-js/">dangerJS</a>
</p>
  No, we won't be changing this. We rely on this heavily at Facebook.

`jest.mock` signals your intent to mock a module, it is not concerned with requiring that module and will not actually act until the module is explicitly required.  üëç Just curious, does it have noticeable impact on startup perf? Sweet cleanup.  I remember having similar issue when using different versions of Jest linked to local copy, which was somehow coupled with `testEnvironment` config option. Can you try to remove it if present (defaults to `jsdom`)? That worked for me back then.  Why is your Jest dependency empty? You only need one, either jest or jest-cli. Are you sure you have the latest versions of all Jest packages of version 19? This might break if you have some Jest 18 and some Jest 19 packages. Oh wow, this is not great. Every single one of those packages should be 19.x. Would you mind inspecting the "dependencies" fields in some of those packages and see if they point to 18.x? That may point to an issue with lerna when publishing.  Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!

**If you are contributing on behalf of someone else (eg your employer)**: the individual CLA is not sufficient - use https://developers.facebook.com/opensource/cla?type=company instead. Contact cla@fb.com if you have any questions. Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks! Thanks! For the time being we aren't explicitly mentioning Yarn on the website. We assume most people who use Yarn will know how to convert npm commands to yarn.  You could look at the Jest repo itself for a start! You cannot overwrite the Jest config for now, for that we may build the multi-config runner #2970.  This will be fixed in the next release next week: https://github.com/facebook/jest/pull/3006  cc @amasad. (closing here as it is a repl.it issue, but hoping Amjad can help resolve this)  Do you mind rebasing this?  Try using `--no-cache` once.  This would need some extra love to get moving. I'll close for now because the rate at which eng. are getting this error is pretty low, and can be solved by clearing the cache. I'll focus on other priorities for the moment but I'm open to take this over some time later.

I think `jest-haste-map` may benefit from more larger refactors eventually as there are other issues such as with the blacklist not being reapplied on cached data.  Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!

**If you are contributing on behalf of someone else (eg your employer)**: the individual CLA is not sufficient - use https://developers.facebook.com/opensource/cla?type=company instead. Contact cla@fb.com if you have any questions. Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks! We can figure something out for clean-all in a follow-up, I guess. 
<!--
  0 failure: 
  1 warning:  Changes were made...
  
  
-->


<table>
  <thead>
    <tr>
      <th width="50"></th>
      <th width="100%" data-danger-table="true">Warnings</th>
    </tr>
  </thead>
  <tbody><tr>
      <td>:warning:</td>
      <td>Changes were made to package.json, but not to yarn.lock - <i>Perhaps you need to run `yarn install`?</i></td>
    </tr>
  </tbody>
</table>



<p align="right">
  Generated by :no_entry_sign: <a href="http://github.com/danger/danger-js/">dangerJS</a>
</p>
  kill it with fire!  Can you send a PR with a fix? :) I think this will be sufficient (if it works on windows):
```
yarn run build && node ./scripts/watch.js
```
as it will make sure `yarn run build` was successfully finished  Oh yeah, this is interesting. I think `jest-file-exists` made more sense when `fs.existsSync` was deprecated and we were meant to use `fs.accessSync` instead. I also hoped to optimize the best-case-runtime of this with `hasteFS.exists` in more places but seems like that wasn't the case :)

Would you mind sending a follow-up PR that actually removes jest-file-exists from the Jest repo? It seems like it is past its lifetime :) No, it's fine. If we are not using it within Jest and will never update it ever again, we can simply drop it.  Nice!  thanks <3  Nice! Thanks for the cleanup.  Wohoo!  This seems like something to bring up with istanbul-plugin-babel or the destructuring plugin in babel.  It's because your testRegex is broken and it tries to run .snap files as tests. What do you mean reproduce on repl? The problem is that snapshot files are not test files but they are regular JS files. Jest will run them as a test and then realize there are no tests defined in it. Ah, I see, sorry about that. We also have `jest-repl` which is a separate project. Thanks @gaearon.  If istanbul spits out invalid code, that probably goes here: https://github.com/istanbuljs/babel-plugin-istanbul  You must return that promise  This is a problem with the mock inside of react-native, not a Jest issue. Please file an issue there or send a PR.  Wohoo! This is great.

cc @Daniel15 who is probably excited about this :D  Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!

**If you are contributing on behalf of someone else (eg your employer)**: the individual CLA is not sufficient - use https://developers.facebook.com/opensource/cla?type=company instead. Contact cla@fb.com if you have any questions. Thank you for using Jest. Please read the comment here: https://github.com/facebook/jest/pull/3085/files#diff-c272134cac3612b41f93893bbaa34d24L9

I may have to go and remove a few lesser known companies from this list, since we introduced this rule after the fact.  Thanks for bringing this up, this is an interesting proposal. I agree there is a lot we could do here to improve mocking, however from my experience and as you pointed out, there are a lot of edge cases and issues that we'll have to think about first. I encourage you to look at the entire mock of a module and make a proposal for all of the types of data that could be in there and how you'd serialize them.

At one point, we actually had this in Jest at FB. It didn't really speed things up though and introduced a lot of issues in a huge codebase, which is probably why I'd push back on this until you can iron out all of the details. The big issue was that FB, sometimes our modules depend on global state. For example, some modules do something like `module.exports = global.FOO + 5;`. The tests would do something like `global.FOO = 10; require('MyModule')` which means that, depending on when tests run, the cached mock objects had different values. There isn't really an easy way around this and it lead to a lot of flakiness.

One thing that could help you, however, are the inline-requires or inline-imports transforms. We use these at FB and they have the potential to speed up your tests by about 50 %. It will inline require/import statements in-place of where they are used. If you have a large module that requires a lot of modules but only in the functions that it defines lazily, you won't be paying for the cost of all the dependencies any more when using automocking. This may work for you and actually also give you a speed-up in your app's load time ;)

See https://github.com/facebook/fbjs/blob/master/packages/babel-preset-fbjs/plugins/inline-requires.js or https://github.com/zertosh/babel-plugin-transform-inline-imports-commonjs @jwbay sounds great. Can you start a PR that expands the documentation for this with thorough examples? :)  That's a good one! Thanks.  Yes, please lets split this up. The `not.toEqual` change makes sense to me.

I'm a bit worried about linting against the actual matchers. There is `expect.extend` and there is no way to know ahead of time which matchers are actually available so unfortunately this approach kinda breaks down with slightly more advanced usage :( Yeah, I think it is a cool idea but I don't think we should limit the API like that and require people to manually add matchers in some config. I'm fine with this being available, of course, I just don't think it is a good idea to ship it out of the box.

I like the other two suggestions though. Would you mind sending a separate PR for those? I think I'd prefer this rule to live outside the Jest repo for now. If many people adopt it and it is useful, then we can discuss adopting it inside this repo.  <!-- Thanks for submitting a pull request! Please provide enough information so that others can review your pull request. The two fields below are mandatory. -->

**Summary**
Lint all the examples including `examples/react-native`. For some reason, `examples/react-native` was added in `.eslintignore` and wasn't being linted. I have removed it from `.eslintignore` and fixed all the lint errors thrown out by examples/react-native. Now all the examples are guaranteed linted, as there are no remaining example folder in `.eslintignore`. 

This emerged from the discuss here https://github.com/facebook/jest/pull/3047#issuecomment-284344520 with @cpojer

<!-- Explain the **motivation** for making this change. What existing problem does the pull request solve? -->

**Test plan**

<!-- Demonstrate the code is solid. Example: The exact commands you ran and their output, screenshots / videos if the pull request changes UI. -->
`yarn run lint` works  Woah, thanks! This is great.  It seems like this is not a Jest issue but rather a Windows issue? What happens if you do `--no-watchman`?  Nice work! Thanks.  Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!

**If you are contributing on behalf of someone else (eg your employer)**: the individual CLA is not sufficient - use https://developers.facebook.com/opensource/cla?type=company instead. Contact cla@fb.com if you have any questions. Thanks!  Does it happen on `node` environment? http://facebook.github.io/jest/docs/configuration.html#testenvironment-string So it's probably connected with Jest running in VM context: https://github.com/facebook/jest/issues/2549  Closing as a duplicate.  @HyperSimon Can you please be a little bit more clear on what you intend to say. As this doesn't help anyone in resolving the issue you are facing. Otherwise feel free to close it to save other people's time. :)   <!-- Thanks for submitting a pull request! Please provide enough information so that others can review your pull request. The two fields below are mandatory. -->

**Summary**

<!-- Explain the **motivation** for making this change. What existing problem does the pull request solve? -->
This PR fixes the `.addReporter .removeReporter` test in TestRunner-test.js which was not right in it's .addReporter test implementation. 

Whenever the TestRunner.js is called two default reporters are automatically right now `DefaultReporter` and `SummaryReporter`, we can't test the add reporter on the reporters that are there by default. 

I set the `_reporters` to an empty array for truly testing if `.addReporter` works fine.  
 Weird, this test isn't broken for me and I don't see reporters added after creating a TestRunner instance. Would you mind elaborating this a bit more? hey @abdulhannanali 
we actually expect the end reporter list `.toContain` the newly added reporter. This will find the exact instance of the summary reporter that was just added and won't match the SummaryReporter that was they by default. So it's ok to have default reporters there already as long as we can verify that we're adding a new one! to improve the test you can add a length matcher.
```js
expect(runner._dispatcher._reporters).toHaveLength(2);
// add reporter
expect(runner._dispatcher._reporters).toHaveLength(3);
// remove reporter
expect(runner._dispatcher._reporters).toHaveLength(2);
``` @dmitriiabramov Cool, I will add this matcher. Thanks a lot! :+1:     I didn't know that this won't affect the previously added summary reporter. Seems like toContain is clever enough to figure out :+1:  Seems like this test is still passing?

@dmitriiabramov I don't like that this test is testing private properties in the first place :( @cpojer agree! but it does the job! :)
although an integration test should be enough here @cpojer If you don't mind me asking, I read this yesterday http://blog.thecodewhisperer.com/permalink/integrated-tests-are-a-scam . Are they really a scam?  People have strong opinions on how to write tests. I recommend ignoring them and just pushing forward by working on making testing actually easier. People can have opinions on top of what we do, but it shouldn't discourage us. @abdulhannanali i actually really like this talk, but unfortunately it is very biased and focuses only on one side of the problem and ignores the rest. For people who are just starting to test this talk can give a very wrong idea I'll close this one for now. Please reopen or send a new PR when this becomes current.  Yeah this sounds good. Would you mind sending a PR for this? :)  @dmitriiabramov Interesting stuff would love to take a look into it and help resolve this bug. This seems to be an issue probably with jest-resolve or jest-mock. However, I'll definitely give a shot at resolving this. 
  cc @wanderley who's been working on jest-resolve  This is really super awesome. I didn't expect that we could find such an elegant solution not just for `toThrow` but for all matchers. Nice!

We should iterate on this and ship it. One thing I noticed is that this implementation does more work than what we do currently. Could we potentially turn `.resolves` and `.rejects` into a lazy getter or a function (`.resolves()`?) so that we do all this work only when requested? Note that the function body for `expect` really does a lot of work for every single call to it. If we could optimize this, I think that may help with Jest's performance a bit :)

Overall I wish there was an easier way to support this API. I'd love to be able to simply do `await expect(foo).toThrow(‚Ä¶)` but we cannot know upfront whether a function was supposed to be invoked synchronously or asynchronously, of course. `resolves` and `rejects` aligns nicely with the Promise API and is probably better than `resolves` and `catches`.

For `toResolve` ‚Äì I'm not opposed to it but it seems to me like your diff makes that proposal obsolete. We'll have all matchers available rather than checking whether a promise resolves or rejects. Is it valuable to know whether a promise resolves/rejects without testing for any other data? It seems similar to me like `toThrow()` without arguments, which arguably is a bad API that we inherited from Jasmine.

Before we go further into this, here are some proposals of what the API could look like:

* `await expect(banana).resolves.toBe(‚Ä¶)` ‚Äì your proposal.
* `await expect(banana).resolvesToBe(‚Ä¶)` ‚Äì this looks less like chai. I may actually prefer this one.
* `await expect(banana).resolves().toBe(‚Ä¶)` ‚Äì explicit function call.
* `await expect(banana).<insertProposalHere>.toBe(‚Ä¶)` ‚Äì is there anything else we can come up with?

What do you think? I think when I'm reading it, `toResolveToBe` is more confusing than `resolvesToBe`. Hm, unsure about `.not.resolvesToBe`, I think that works as well? I may need to pull in a native speaker to help us out with this :D Thanks everyone for your input.

@Phoenixmatrix you are actually making a good point. What is the incremental value that is added when doing something with one of the more complex matchers. For example returning a mock function from a Promise and calling

```js
await expect(Promise.resolve(jest.fn())).resolves.toBeCalledWith('foo')`
// vs
const result = await Promise.resolve(jest.fn());
expect(result).toBeCalledWith();
```

And the answer is probably: not that much. However, as julien-f pointed out, this is much more useful when something is supposed to throw. If we are adding helpers to make it easier to check whether promises fail it doesn't seem like it increases the API surface too much to add checks for proper resolution.

@excitement-engineer I still prefer `resolvesToBe()` etc. better. That's the last bit to iron out. I think perf should be fine either way ‚Äì one thing I was thinking is we could move the `Object.keys(allMatchers)` call to `expect.extend` because that's the only time it can change. That should pretty much normalize performance in the average case here.

Your argument about `.not.resolvesToBe` makes sense, which is probably why we should go with your proposal. However, I'm not entirely sure whether `.resolves.not.toBe(‚Ä¶)` makes sense either. Can you explain when I would write a test like that? I'm wondering if we should even get rid of the negated matchers from resolves/rejects but that of course also means that we'd definitely go with the dot-syntax proposal.

Please make the CI pass, too :) (don't worry in case you see a segfault, that's a node issue, but everything else should be green).

As a follow-up PR, it would be awesome to add documentation for this feature to the Expect API docs page.

What do you think? @robinpokorny I think this comes mostly from the executor of the Promise function having arguments commonly called "resolve" and "reject". I think it makes sense to stick with what people use colloquially even if it isn't 100 % technically correct. This will fail on node >4. And I've fixed this a while ago. Can you rebase to master? Yes please Ok, let's add this to Jest. Everyone, thanks for weighing in here. We are going with the original proposal but I'm looking forward to pointing people to this PR when they ask about this API and the decisions we made.

@excitement-engineer thanks for building this. Would you mind sending a PR to add all of this to the docs? @ljharb would you mind explaining your argument a bit better? You said that function calls are:

* cleaner
* easier to lint against
* MUCH more performant (getters and setters are slow)
* more readable

than the current implementation. We aren't using getters/setters, we only benchmarked it, so that falls away. I assume that "cleaner" and "more readable" is both the same thing and is very subjective and your last argument is that it is easier to lint against, which I don't quite understand given that we are talking about a slight AST difference between the two. As I see it, the added parenthesis serve no value here. Can you elaborate?  @SimenB I adjusted it a little bit, what do you think of that? Concretely I updated the message for `expect(foo).toBeDefined`. That rule now won't trigger if you don't have a matcher at all (like `expect(‚Ä¶)`) which already shows a different error, as well as it includes the name of the matcher. Does this make sense to you? Nice! Thanks @SimenB for building this.  
<!--
  0 failure: 
  1 warning:  Changes were made...
  
  
-->


<table>
  <thead>
    <tr>
      <th width="50"></th>
      <th width="100%" data-danger-table="true">Warnings</th>
    </tr>
  </thead>
  <tbody><tr>
      <td>:warning:</td>
      <td>Changes were made to package.json, but not to yarn.lock - <i>Perhaps you need to run `yarn install`?</i></td>
    </tr>
  </tbody>
</table>



<p align="right">
  Generated by :no_entry_sign: <a href="http://github.com/danger/danger-js/">dangerJS</a>
</p>
 Thanks @SimenB.  It seems like you don't have the spread plugin activated in babel. The spread operator in object literals is not part of node yet. If you believe this is a problem with Jest, please provide a repo on github that shows this problem. That seems like an issue with create-react-app then.  <!-- Thanks for submitting a pull request! Please provide enough information so that others can review your pull request. The two fields below are mandatory. -->

**Summary**
This PR adds the ability to specify custom reporter to be used with Jest. Right now, there's no way for the user to specify the custom reporter they want to use, without tinkering the internals. This let's them specify the Custom reporter(s) if any users want to use with their tests.

This PR relies heavily on the work @dmitriiabramov did in #2115 for adding XUnitReporter. Right now, only the interface through which we can use different reporters has been developed. Reporters such as Nyan and XUnitReporter are work in progress. 

<!-- Explain the **motivation** for making this change. What existing problem does the pull request solve? -->
This PR reuses 

**Test plan**

<!-- Demonstrate the code is solid. Example: The exact commands you ran and their output, screenshots / videos if the pull request changes UI. -->
 Integration tests for custom reporters are work in progress.  The first custom reporter is going to be a Nyan Cat, as it's trivial to implement @thymikee I am interested in knowing how we can add a better validation check for the Reporters being imported, @dmitriiabramov  In a Test Suite, Can we consider the the fullPath of the test as the value for the `classname` and `package` attribute within tescase and testsuite tag.?  Not adding it in this PR as @dmitriiabramov suggested, but here's the initial version of XUnitReporter written to be used a Custom Reporter. Any feedback is welcomed. https://gist.github.com/abdulhannanali/6560aa5f53e65ca3cf92fb9ad0836d02 . I was going to push this too, but thanks to @dmitriiabramov  for pointing it out that it should be a separate PR. One of the major concern I need to clear out is how the path resolution for the reporters will work. I am currently working on Integration Tests for Custom reporters and for this purpose I am writing a simple reporter, which just checks if the whole integration of reporters work fine. @dmitriiabramov The Reporters in the Jest extend from a BaseReporter, but in Mocha the biggest difference is that the BaseReporter is responsible for keeping track of the whole progress of the tests within it's stats object while the BaseReporter within the Jest is just exposing two more methods and removing the `preRunMessage`.

We can even remove the BaseReporter. However, it has a few advantages, as the code in the TestRunner would break if the reporters don't implement all of the methods on the base reporter. Also, we can additionally check in the code if the reports are inheriting from BaseReporter, adding kind of a validation check, but we definitely need a way to expose BaseReporter to the application.  @abdulhannanali super excited you are working on this! Would you mind also including the Nyan reporter example in this diff so that we can see what it may look like? We should make sure that the API that Jest exposes to add reporters is actually useful and won't change too often. Btw. there is also this proposal: https://github.com/js-reporters/js-reporters ‚Äì I'm not sure if we should integrate with this. @cpojer Thank you for sharing this `js-reporters` proposal seems quite nice of Qunit team. Something similar also came up in my mind after seeing the Mocha's Test Reporter interface, which is based on an EventEmitter, instead of calling methods on a class.

The EventEmitter interface really has it's advantages regarding the flexibility and making the TestDispatcher independent from how the reporters are implemented. Major parts in the TestRunner regarding the dispatching of methods and the existing runners will need to be updated for this to happen.  I still doubt if we can totally implement the proposal as we'll need to change concept around Suites too. However, it seems exciting, looking forward to get more feedback on this..

I am totally up for making implementing an EventEmitter interface though :)  @bookman25 IMO, It's too compicated to support this as a CLI option for now, how about first implementing it as a Config option and finalizing how we deal with it.  @cpojer js-reporters seems outdated, and popular frameworks such  Jasmine doesn't seem to be following this. It can be an overkill following this implementaiton. Jasmine's interface is actually quite similar to what we are already doing. Both of them aren't using EventEmitter for their functionality. It's also very much focused on Testing frameworks that can be run client side. In order to reuse the reporters there.  @abdulhannanali sounds good. Let's build our own standard for reporters then ;) @dmitriiabramov The only reason we seem to have a `BaseReporter` is to make sure all the methods exists so we can save us from method not found errors when we call the method on the given reporter, but  as we move towards custom reporters, a more flexible approach might be needed here. 

The `aggregatedResults` provided by the TestRunner itself, is already doing the work of what Mocha does in it's Base.js class, similar to BaseReporter. So, for the standard reporters it might be okay to extend the BaseReporter class, but do we need to extend in the same way for other reporters. 

We can have a `_validateReporter` method which checks if the given methods exist on the reporter, and if doesn't we just throw an error, or maybe we don't do this too, cos  the reporters should be flexible to implement only the methods they want which is the case when we are implementing simple reporters, if we implement the second approach we'll call 

I am trying this `_validateReporter` approach, let me know if we need this here. Interested in hearing your thoughts about this. Thanks a lot! 

- [x] add _validateReporter method in `TestRunner`

Sorry everyone for the delay.  @cpojer Can I take all these AggregatedResults related method and form them into one `AggregatedResult class` to be used by `TestRunner.js`? 
<!--
  2 failure:  New JS files do n..., Please ensure tha...
  1 warning:  Please ensure tha...
  
  
-->

<table>
  <thead>
    <tr>
      <th width="50"></th>
      <th width="100%" data-danger-table="true">Fails</th>
    </tr>
  </thead>
  <tbody><tr>
      <td>:no_entry_sign:</td>
      <td>New JS files do not have the Facebook copyright header: <a href='https://github.com/abdulhannanali/jest/blob/reporter-config/integration_tests/custom_reporters/__tests__/add-fail-test.js'>integration_tests/custom_reporters/__tests__/add-fail-test.js</a>, <a href='https://github.com/abdulhannanali/jest/blob/reporter-config/integration_tests/custom_reporters/__tests__/add-test.js'>integration_tests/custom_reporters/__tests__/add-test.js</a> and <a href='https://github.com/abdulhannanali/jest/blob/reporter-config/integration_tests/custom_reporters/add.js'>integration_tests/custom_reporters/add.js</a></td>
    </tr>
  
<tr>
      <td>:no_entry_sign:</td>
      <td>Please ensure that <code>'use strict'</code> is enabled on: <a href='https://github.com/abdulhannanali/jest/blob/reporter-config/integration_tests/custom_reporters/__tests__/add-fail-test.js'>integration_tests/custom_reporters/__tests__/add-fail-test.js</a>, <a href='https://github.com/abdulhannanali/jest/blob/reporter-config/integration_tests/custom_reporters/__tests__/add-test.js'>integration_tests/custom_reporters/__tests__/add-test.js</a>, <a href='https://github.com/abdulhannanali/jest/blob/reporter-config/integration_tests/custom_reporters/add.js'>integration_tests/custom_reporters/add.js</a> and <a href='https://github.com/abdulhannanali/jest/blob/reporter-config/packages/jest-config/src/reporterValidationErrors.js'>packages/jest-config/src/reporterValidationErrors.js</a></td>
    </tr>
  </tbody>
</table>


<table>
  <thead>
    <tr>
      <th width="50"></th>
      <th width="100%" data-danger-table="true">Warnings</th>
    </tr>
  </thead>
  <tbody><tr>
      <td>:warning:</td>
      <td>Please ensure that <code>@flow</code> is enabled on: <a href='https://github.com/abdulhannanali/jest/blob/reporter-config/packages/jest-config/src/reporterValidationErrors.js'>packages/jest-config/src/reporterValidationErrors.js</a></td>
    </tr>
  </tbody>
</table>



<p align="right">
  Generated by :no_entry_sign: <a href="http://github.com/danger/danger-js/">dangerJS</a>
</p>
 @jest-bot will do, thanks for informing.  @dmitriiabramov @cpojer I have pushed the working version containing the tests. The custom reporters right now are reusing much of the Reporter functionality Jest already has for it's own reporters. The API to implement custom reporters is exactly the same. It's kind of really providing the hook with which you can add your own custom reporter. 

In order for the reporters to confirm to the standard, I implemented a `_validateReporters` method which validates the reporter by checking if various methods are implemented for sure, but since this makes it very unflexible I removed it. 

I would like to know any other suggestions, I have removed the [WIP] prefix from this PR too. 

Thank you for your help everyone :heart:  Circle CI build is failed for some weird yarn reason, I have nothing to do with  @bookman25 As discussed before, this PR will only add the capability for the `jest-config`. A separate PR should be opened if we want to add the capability to CLI too. However, I haven't given a lot of thought to it, right now, even though Karma and Ava already does it.. Will think about it once this one is merged.  closing in favor of https://github.com/facebook/jest/pull/3349  Can you provide a repro?   <!-- Thanks for submitting a pull request! Please provide enough information so that others can review your pull request. The two fields below are mandatory. -->

**Summary**
<!-- Explain the **motivation** for making this change. What existing problem does the pull request solve? -->
Disables default JavaScript validation in Visual Studio Code to support the flow validation. By default, VS Code only supports types in .ts file extension which is not true for many libraries using Flow. In order to benefit from linting features of packages such as [flowtype/flow-for-vscode](https://github.com/flowtype/flow-for-vscode), it's required to disable the default JS Validation. This will save time for the VS Code users. This is something opinionated. 

**Test plan**
No code changes
<!-- Demonstrate the code is solid. Example: The exact commands you ran and their output, screenshots / videos if the pull request changes UI. -->
 I think I was not in sense, when I opened this issue. Closing this one, as the developer environments are the user's own preference, and it's better to not make them opinionated. Also, this PR helps us in streamlining the behavior if we are using VSCode's Flow extension, but we can't impose it on every VSCode user.Sorry for bothering.  Yea, we should either use a meaningful vscode settings file (with flow, js validation disabled and prettier support) or delete it entirely. @thymikee I can take this up, since I already have a file I use for my development.   Thanks for following up!  I like this idea!  oh, ok.
  You shouldn't look outside your rootDir, change your config to something like this:

```
roots: [
  "<rootDir>/myRootDir",
  "<rootDir>/shared"
]
```  Circle fails but it's unrelated  That's what `--forceExit` is for but it's an escape hatch. If Jest doesn't exit, it means you are not cleaning up properly after your tests (use `afterAll`).  <3  I don't think we want to change that behaviour.  Why would you import test to a test?  Can you provide a repro on github that we can try out? This should work, actually (regardless of whether that is good or not). @MarcoWorms thanks for answering! Tests cannot be scheduled dynamically. They need to be scheduled synchronously. That's a limitation coming from Jasmine unfortunately. We are hoping to replace Jasmine with something better eventually and lift this restriction. You could help with that! :) I'm gonna start one early next week :) We started to fork Jasmine. Feel free to hack on the jest-jasmine2 package!  What does the test look like? Which OS do you use? can you provide a repro? You **must** wrap it with `test` or `it`, otherwise it's not a test. Please provide a repository with repro, otherwise there's little we can do to triage this issue. This is not a bug in Mongoose, nor in Jest. Your test is just wrong. 

Please take a look at resources on how test Mongoose. I believe there's no good article on how to pair it with Jest, but there's something for Jasmine: http://www.mattritter.me/?p=1 and a lot for Mocha (which should work for Jest too without many changes), so there's a lot to pick ideas from. Good luck! :) Try changing [`testEnvironment`](http://facebook.github.io/jest/docs/configuration.html#testenvironment-string) to `node` then Yea, this is a pain right now and we're working on multi-config runner to solve this exact problem. 
I don't know really why `jsdom` bugs Mongosse, but you can open an issue in `jsdom` repo and ask there (and come back with the answers)!  @jozsi we landed this PR https://github.com/facebook/jest/pull/2859 so it will be possible to change test environment on the file basis in the next release üôÇ   Can you provide a repro? Ok, I think this is not a Jest issue. Feel free to ask more on the Jest discord channel and respond here if you can create a repro so if there is a bug in Jest we can fix it.  This is good! Thank you for adding clarifications.  Can you post before/after screenshots just for reference? Thanks! I wish we could remove the entire nav toggler on mobile and have a simpler navigation system there, though.  Yay! Nice work @wtgtybhertgeghgtwtg.  <!-- Thanks for submitting a pull request! Please provide enough information so that others can review your pull request. The two fields below are mandatory. -->

**Summary**

Review highly appreciated. I use real files from `__fixtures__` instead of mocks, because it was easier for me this way (behaves more like integration test though). 

**Test plan**

jest
 Yay, it works on Windows! Solid, thanks for following through!  <!-- Thanks for submitting a pull request! Please provide enough information so that others can review your pull request. The two fields below are mandatory. -->

**Summary**
Currently when using --json the failureMessages stacktrace shows all the internal jasmine call sites.
Jest cli [already filters those](https://github.com/facebook/jest/blob/master/packages/jest-message-util/src/messages.js#L21-L24) but the json still contains them.
This causes jest-editor-support to pass the whole stacktrace:
<img width="578" alt="screen shot 2017-03-01 at 8 55 25 pm" src="https://cloud.githubusercontent.com/assets/87300/23480977/c573d6c4-fec1-11e6-98b7-f5d7c7969165.png">
After the change:
<img width="581" alt="screen shot 2017-03-01 at 9 24 04 pm" src="https://cloud.githubusercontent.com/assets/87300/23482032/84a7a176-fec5-11e6-8c05-a5bb9c2676d2.png">

This change has a side effect:
the filename in the stacktrace will be surrounded by chalk.dim.start and chalk.dim.end, 
I this is actually better as it gives a clear start and end of where the path starts inside the stacktrace.


<!-- Explain the **motivation** for making this change. What existing problem does the pull request solve? -->

**Test plan**
`yarn jest`
To reproduce:
Break a test
run `jest --json` and look for `jasmine`
Tested results inside the editor. 
<!-- Demonstrate the code is solid. Example: The exact commands you ran and their output, screenshots / videos if the pull request changes UI. -->
 Also, see the documentation I linked to you last week about this feature: https://github.com/v8/v8/wiki/Stack-Trace-API#customizing-stack-traces ‚Äì we can extract a lot of useful information. Let's figure out how to best highlight it.

We can also hide some of the more complex data behind the `--expand` flag. How about making this configurable? There are libraries, like Zone.js in Angular, polluting stack traces A LOT, which would benefit from custom stack filtering.

We could introduce `filterStacktracePattern: string` (or `filterStacktracePatterns: Array<string>`) config option and pass it to `setPrepareStackTrace` as a second argument. 
This would work by extending our default filtering, e.g.:
```js
// jest-environment-*
...
setPrepareStackTrace(global.Error, config.filterStacktracePattern);
```
```js
// stacktrace.js
...
const patterns = [FILTER_NOISE, filterStacktracePattern];
const filterNoise = (
  filename: string,
  index: number,
  patterns: Array<string>
) => index !== 0 && patterns.map(pattern => pattern.test(filename));
```

Does that make sense?  This is expected. In your example you are not defining all the tests upfront, which is necessary for Jest to know which tests are available and to make sure snapshots don't get marked as obsolete that shouldn't.  This is non-actionable without a repro. Can you run again? The second run should normally be 2x faster because everything will be cached. We haven't observed any slowdown with Jest so if you think this is a problem with the framework please come with with a proper repro. Please find a way to provide a repro so we can help you. Can you also check this on Node 6 or 7? 
From what I remember, there's a noticeable difference in performance between these versions and it's possible we've introduced code which is not optimised in Node 4, but it is in 6 and 7. Thanks @solomon23, that's useful. It does seem like there may be a minor regression. Do you think there is any way you could help us bisect it?

Something like:
* Clone the Jest repo.
* npm link packages/jest-cli and packages/jest
* Put it into bisect mode
* Run `yarn` within the Jest repo for every commit and then `jest` on your codebase and find the diff that is slow. Could you please sort the commits chronologically? @solomon23 are you saying that a 5 second slowdown is coming from https://github.com/facebook/jest/commit/b2b203903ef28df92a1f912c6f334be6df82756e ?  **Summary**

Uses Yarn for lerna: https://github.com/lerna/lerna/releases/tag/v2.0.0-beta.38

**Test plan**

it's a lot faster now! It doesn't work on CI :( cc @hzoo  <!-- Thanks for submitting a pull request! Please provide enough information so that others can review your pull request. The two fields below are mandatory. -->

**Summary**
<!-- Explain the **motivation** for making this change. What existing problem does the pull request solve? -->

Adding the directions for the additional workflow to be followed, if changes are made to the Website or Documentation in [CONTRIBUTING.md](CONTRIBUTING.md). This will save maintainers in providing out directions again, in case some issue occurs with PR. Thanks! Emerged from my discussion with Dmitrii [here](https://github.com/facebook/jest/pull/3023#issuecomment-283163149) 

**Test plan**
<!-- Demonstrate the code is solid. Example: The exact commands you ran and their output, screenshots / videos if the pull request changes UI. -->

Not needed Thanks @cpojer made the pointed out changes   <!-- Thanks for submitting a pull request! Please provide enough information so that others can review your pull request. The two fields below are mandatory. -->

**Summary**

Fixes #2530 

**Test plan**

pictures!

<img width="1118" alt="screen shot 2017-02-28 at 23 15 07" src="https://cloud.githubusercontent.com/assets/5106466/23436719/e2b83916-fe0b-11e6-8cc9-b0ebe16671cd.png">
<img width="793" alt="screen shot 2017-02-28 at 23 15 45" src="https://cloud.githubusercontent.com/assets/5106466/23436720/e2b8b95e-fe0b-11e6-8b8c-f54661f5fa62.png">

 üëç   Feel free to send a PR to make the code more consistent with the standard in the Jest codebase itself. Thanks @cpojer for the purpose of the Markdown examples, can we set the status of `--no-undef` rule to `0=OFF`. 
As the variables might not be defined within same code snippet for examples. Or should it be `1=WARN`. The ON status will be hard to manage as it's going throw so many errors. 

We can have ON, but in that case, we'd have to maintain the index of all the globals we are using in our example and mention them explicitly in our .eslintrc file.  yeah, that seems fine, as long as it stays on for the rest of the codebase. There should be some standardization, regarding how we are writing our JSON configurations in Jest Documentation. The formats that are commonly being used for partial json configurations are

```json
{
  ...
  {
    "cat": {
      "purr": true,
      "meow": true
    } 
  }
  ...
}
```

and the other one is

```json
"cat": {
  "purr": true,
  "meow": true
} 
```

For partial JSON configurations, there can be consistency among how we represent partial configurations. If it's something, contributors think should be fixed, do let me know. Also, JSON configurations within `js` code blocks should be discouraged, as they are going to cause breaks. ESLint has been finally added. Thank you for the guidance @cpojer Closing this issue  I also get the same error: https://ci.appveyor.com/project/Daniel15/jest/build/2321. Some packages may not be included in package.json

Other than that, it's awesome that you moved it forward ‚ù§Ô∏è  Bumping `jest-*` packages to `19.0.2` fixes the issue for me. But I'm not sure why it occurs, I have almost no experience with lerna. Wow, this is really impressive ‚Äì great work! Unfortunately it doesn't work locally for me; mind rebasing on the latest version of Jest, running `yarn clean-all` and then `yarn` and see if that works for you? :)

Overall, the big question we have to answer here is whether we want all of this to live within jest-cli or whether we want a separate CLI (`jest-benchmark`) for this. I'm thinking that the latter may be the more viable solution long-term and that it will result in less clutter. It comes down to how much stuff we want to ship out of the box, like, should watch mode work for benchmarks? If it makes everything more complex, then probably not. Personally I'm a bit worried about expanding everything around the jest-cli, like SearchSource, to support two concepts "benchmarks" and "tests" rather than N amount of arbitrary things that can be run, which would essentially turn Jest into a task runner. To answer this, the question is how much of the existing infrastructure can be changed to support both tests and benchmarks rather than extending them directly. Can SearchSource work as a source for any *pattern*  rather than hardcoding them? If yes, I'd strongly recommend to refactor this all and make `jest-benchmark` a separate cli runner for benchmarks.

Given that plans we have to support a multi-config runner in #2970, we could conceivable find a way to run both tests and benchmarks with the same config in the same run without doing it directly inside of jest-cli.

What do you think? I'll close this because we'll be taking a different direction. We can reopen when you push to it or let's take it to a new PR.  <!-- Thanks for submitting a pull request! Please provide enough information so that others can review your pull request. The two fields below are mandatory. -->

**Summary**

Fixes #2843.
Feel free to close it, if we don't want such behaviour, but I think it's nice.

**Test plan**

`jest-resolve-dependencies` has no tests :(. If we eventually want to merge it, I'll add some. 
 Yap, this is definitely a step in the right direction to make `-o` more useful! Nice work as always @thymikee. I think we should consider doing something unpopular: create a `jest-snapshot-support` package that has all the constants and utility functions. I don't want all of the snapshot package to end up all over Jest but it seems like we copied constants around and sharing those would be useful. What do you think? Agreed, `jest-snapshot-support` may come in handy and it wouldn't require to load whole `jest-snapshot` I've tested this on your repo. Are you sure you're using latest master build?

![snap](https://cloud.githubusercontent.com/assets/5106466/23455053/a50d1f7e-fe6e-11e6-9b68-3ff648495ff6.gif)
 I use LICEcap http://www.cockos.com/licecap/ This is odd, same is working for me. I tend to build using `yarn` or `yarn install` on Jest repo ‚Äì maybe that helps? And what happens when you run `jest -o`? Yeah! Awesome to hear that. btw, there's `npm run clean-all` to purge all node_modules, just in case üôÇ  And once you `npm link` a package you need to be extra careful with unlinking it from local and global deps. It's a pain. Hopefully the whole process will be easier with `yarn knit` https://twitter.com/cpojer/status/836730384620617729  Thanks! Unfucking the whole path handling in Jest is very impactful. If you can do more of that, I'd be very happy.  awesome work @abdulhannanali!

to test your changes you should do the following:
1. go to `website/` directory
2. run `yarn run test`
3. run `yarn run start` (that will start the website server)
4. go to `http://localhost:8080/jest/docs/api.html` and see if your documentation is there also after you're done with the changes you should run `yarn test` to see if `lint`, `flow` and `tests` are passing  @abdulhannanali that should probably be a separate pull request! change the argument to `keyPath` in both documentation and the matcher function itself and we're good to go! :) @dmitriiabramov Cool! Sorry for the delay! Will do this right now  Changes added! Thanks for merging @dmitriiabramov  `it` is an alias for `test`. It's used in variety of test frameworks to make tests read like a prose, e.g.
```js
it('renders nicely', () => {}) // reads like "It renders nicely."
```  Seems like we don't have a test for this :O Thank you!  <!-- Thanks for submitting a pull request! Please provide enough information so that others can review your pull request. The two fields below are mandatory. -->

**Summary**

Fixes #2946.
We should warn if an `actual` value of any of `toThrowMatchers` is not a function, as `toThrow()` matcher can pass a supposed-to-be-failing test because of Jest's internal error (in the issue attached it's a TypeError when trying to call `actual()` on a string).

Here's a screenshot of what it looks like:

<img width="546" alt="screen shot 2017-02-27 at 22 09 32" src="https://cloud.githubusercontent.com/assets/5106466/23380017/763f56ac-fd39-11e6-8287-4986ad8dd457.png">

**Test plan**

jest
  This means that your tests are leaking memory and not cleaning up after themselves, this is a wontfix for now unfortunately as there are also bugs in node's vm implementation which cause it to retain more memory than necessary. To be honest, I'm quite confident that Jest is also leaking small amounts of memory after every run. You could make an empty test and analyze how memory grows over time and see what is retained; then we can work on reducing leaks in watch mode :)  I'm not sure if we should exclude scriptFiles and setupFiles by default. You can always configure coverage: http://facebook.github.io/jest/docs/configuration.html#collectcoveragefrom-array As far as I can tell, we're not using static analysis of tests and related modules to check if which files we should instrument. If you're curious, [here's a module](https://github.com/facebook/jest/blob/master/packages/jest-runtime/src/shouldInstrument.js) that determines this.

I think @dmitriiabramov could shed some light in the topic. @Yayuro the coverage is collected any time the file is being executed, not only if we have tests for it.
so in your case if you just require your `setupFile` it will be instrumented and measured as well as all other files!


> At the same time the whole coverage in terminal is way larger.

are you talking about `DataStore.js` file that has `45%` in one case and `100%` in another case?
if you run exactly the same test suite then it's indeed strange! is it an open source project that i can look into?
 hey @Yayuro!
this is actually expected behavior!

regarding the `"collectCoverageFrom": ["!./jestsetup.js"]` issue.

we use https://github.com/sindresorhus/multimatch for matching files and according to their docs
> Positive patterns (e.g. foo or *) add to the results, while negative patterns (e.g. !foo) subtract from the results.
>
> Therefore a lone negation (e.g. ['!foo']) will never match anything ‚Äì use ['*', '!foo'] instead.

so in your case it is expected for it to return empty coverage.

although, when you specify `collectCoverageFrom` and list all the globs, it will measure coverage for files that are not tested, this is also expected, because a lot of times people forget to test files but their reports say that the project is 100% covered (which is not true and gives a false sense of stability).

if you don't use `collectCoverageFrom` it will only measure coverage for files that were executed during the test run (and that's probably what you're looking for), but the same time it will include everything (like setup files, vendor files, minified js, etc.)  What is `waitsFor()` and `runs()`? It's not a part of Jest, that's for sure waitsFor is jasmine1, not part of Jest indeed. Please ask such kind of questions on Stack Overflow or on our Discord channel. This is an issue tracker, not a help forum. @eldyvoon Please join us on discord: http://facebook.github.io/jest/help.html ‚Äì there is a community of Jest users that can help you out with things like this, more quickly.  `../__mocks__/request ` Is `request.js` adjacent to `__mocks__` directory? If not, it should have. Then you'll be able to call it just with `../request`. More on manual mocks: http://facebook.github.io/jest/docs/manual-mocks.html#content It works, because if you have directory structure like this:
```
src
‚îú‚îÄ‚îÄ __mocks__
‚îÇ¬†¬† ‚îî‚îÄ‚îÄ left-pad.js
‚îú‚îÄ‚îÄ __tests__
‚îÇ¬†¬† ‚îî‚îÄ‚îÄ left-pad.test.js
‚îî‚îÄ‚îÄ left-pad.js # we require this
```
Jest knows, that whenever something is calling `src/left-pad.js` file, and from `src/left-pad.test.js` you're calling `jest.mock('../left-pad)`, if there's a `src/__mocks__/left-pad.js` file present, it will be used as implementation of `src/left-pad.js` module.

Please read the docs more thoroughly.  Unfortunately we're not maintaining these packages. I advice you to open this issue in React's repo as a more appropriate place and update us on the progress. But as for now I'm closing this.   We're emulating console, and this may not work, but I hadn't check myself. Would you mind sending a PR with a fix?  :)  So I've had a look now and console features like `%d` or `%s` are working just fine with Jest. But FWIW, `%c` is not a part of Console in Node. Seems like this is only available in browsers, so I'd say it's a wontfix. This should be done in nodejs directly: https://github.com/nodejs/node/pull/10308  Thank you @benmccormick   This is a duplicate of #1705   Thanks @thejameskyle. I think we can only make this work if we find a way to pass `config.rootDir` from Jest into this. We could potentially do something like:

```
expect.addSnapshotSerializer(createFilepathSerializer(config.rootDir));
```

however, we don't have the `rootDir` available in user code either, so I'm not entirely sure how to make it work :( Not a huge fan of breaking this but I guess we could keep backwards compatibility. With your proposal, we could thread some Jest config options through to pretty-format which then gets passed to plugins. I like it! @thejameskyle are you planning on working on a way to pass the rootDir in? sounds good. Can we just call it "root"? I really dislike "rootDir" within Jest :)

We'll also need to find a way to thread this through; tests don't expose the config/rootDir at the moment and I'd like to keep it that way. Happy to reopen if we decide to ship this inside of Jest with the iterated version, closing for now.  Seems like this fails on travis, you might need to sort something there. Thanks! Would you mind auditing the other places we use micromatch in to make sure we cover everything?  Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!

**If you are contributing on behalf of someone else (eg your employer)**: the individual CLA is not sufficient - use https://developers.facebook.com/opensource/cla?type=company instead. Contact cla@fb.com if you have any questions. Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks! Thank you but I'm not really interested in supporting this. `--forceExit` is an escape-hatch that should only be used if your tests aren't properly cleaning up after themselves and for some reason you don't have control over it. I don't think we want to make it easier to use this behavior and the recommendation is to control tested code better. Use `afterAll`. You could probably use the testResultsProcessor for something like this.


________________________________
From: Matt Krick <notifications@github.com>
Sent: Monday, February 27, 2017 3:40:37 AM
To: facebook/jest
Cc: Christoph Pojer; Mention
Subject: Re: [facebook/jest] check for forceExit in the config (#3004)


@cpojer<https://github.com/cpojer> correct me if i'm wrong, but afterAll is suite-level, which means that if i have 100 test files, i'd be filling & draining the pool 100 times. When running concurrently, the odds of draining the pool while a connection is still alive seems pretty high, right? I need something that only drains the pool once when all the tests are complete.

‚Äî
You are receiving this because you were mentioned.
Reply to this email directly, view it on GitHub<https://github.com/facebook/jest/pull/3004#issuecomment-282620993>, or mute the thread<https://github.com/notifications/unsubscribe-auth/AAA0KI4TXo-TpH9N_tFyF9fx3HOZZrkSks5rgkW1gaJpZM4MMJ2N>.
  Thanks @wyze! Thanks for helping out on Jest.  cc @mikaelbr Closing this from the Jest side. Thanks @mikaelbr for working on this!  You are right. Do you mind removing "browser: false"? It doesn't really do anything and confuses me :) 
<!--
  0 failure: 
  1 warning:  Please ensure tha...
  
  
-->


<table>
  <thead>
    <tr>
      <th width="50"></th>
      <th width="100%" data-danger-table="true">Warnings</th>
    </tr>
  </thead>
  <tbody><tr>
      <td>:warning:</td>
      <td>Please ensure that <code>@flow</code> is enabled on: <a href='https://github.com/wtgtybhertgeghgtwtg/jest/blob/use-is-builtin-module/packages/jest-resolve/src/__test__/resolve-test.js'>packages/jest-resolve/src/__test__/resolve-test.js</a></td>
    </tr>
  </tbody>
</table>



<p align="right">
  Generated by :no_entry_sign: <a href="http://github.com/danger/danger-js/">dangerJS</a>
</p>
  Would you mind providing a repo with the case with all the absolute/relative paths set up?  @holi-java this is not the way we add issues. Please add this as a comment in relevant place, e.g: https://github.com/facebook/jest/issues/2136
Also, you can still comment on closed issues, unless they're locked.  you need to compile ES modules to commonJS in your test env setting. Just read the docs ;) http://facebook.github.io/jest/docs/webpack.html#using-with-webpack-2 Does it happen when you run `jest --no-cache`? `--no-cache` flag must be passed whenever you alter your babel config, because we cache the transforms. Have you read the docs I've shared with you? If you scroll up the page, you'll find a configuration jest needs to handle loading image assets and styles.  Feel free to ignore the examples on Windows for now. @wtgtybhertgeghgtwtg if you have some time to get our Windows test suite to work well and enable more tests on appveyor, I think that could massively help with stability going forward.  It seems like that is an issue for react-native.  We weren't planning on supporting this. `expect(typeof foo).toBe('number')` seems fine to us. `toBeA` doesn't provide any additional value on top of this.  It's not a snapshot issue, but a renderer. Try `shallow` if you're using `enzyme` or `renderer.create` from `react-test-renderer` You should find this piece of React's documentation useful: https://facebook.github.io/react/docs/test-utils.html#shallow-rendering  Nice! Please make sure the tests pass on CI :)  I don't think there is anything in the pipeline here that we control or could fix. This is a TypeScript + React problem, not a Jest one. With `babel-preset-jest`, we hoist `jest.mock` calls above `import` calls. If you are using TypeScript (without ts-jest?), this will not happen.

cc @orta how are you solving this?  This is expected. Mocking works by subclassing things in Jest.  This is kind of an odd problem. `--forceExit` exists so that Jest kills your tests and exits if you aren't cleaning up your resources properly. If you change afterAll to properly tear down your handlers, you won't need forceExit.  > why couldn't let jest do this?

Because it's just not that simple. Every time `done` callback is involved we defer work to Jasmine and rely on how it handles such cases. Which is bad and we need to fix it.
Although this doesn't happen if you can return a Promise from your test (then Jest handles it and catches the error as a promise's rejection).

I'll close this, because this issue is known and we'll try to push it forward to the next release or so.
Related issues: https://github.com/facebook/jest/issues/2059, https://github.com/facebook/jest/issues/2136  ```
git clone https://github.com/facebook/react.git
cd react
yarn
npm test -- --watch Perf

t
returns <Enter>
```

<img width="542" alt="screen shot 2017-02-22 at 6 27 29 pm" src="https://cloud.githubusercontent.com/assets/810438/23226191/9a40c9fc-f92c-11e6-8489-37914b996357.png">

The watch mode crashes:

```
 FAIL  src/renderers/dom/shared/__tests__/ReactBrowserEventEmitter-test.js
  ‚óè Test suite failed to run

    ProcessTerminatedError: cancel after 2 retries!
      
      at Farm.<anonymous> (node_modules/worker-farm/lib/farm.js:81:25)
      at Array.forEach (native)
      at Farm.<anonymous> (node_modules/worker-farm/lib/farm.js:75:36)
      at ontimeout (timers.js:365:14)
      at tryOnTimeout (timers.js:237:5)
      at Timer.listOnTimeout (timers.js:207:5)
      

A worker process has quit unexpectedly! Most likely this an initialization error.


 RUNS  src/renderers/dom/shared/__tests__/findDOMNode-test.js
 RUNS  src/renderers/dom/shared/__tests__/ReactBrowserEventEmitter-test.js
 RUNS  eslint-rules/__tests__/warning-and-invariant-args-test.js
 RUNS  src/renderers/__tests__/ReactMockedComponent-test.js

Test Suites: 79 skipped, 10 passed, 10 of 126 total
Tests:       1469 skipped, 19 passed, 1488 total
Snapshots:   0 total
Time:        6snpm ERR! Test failed.  See above for more details.
```

If I just run `npm test -- --watch ReactBrowserEventEmitter` I can't reproduce this. I think it was not introduced in Jest 19, I can repro it in the React's master branch which is still using Jest 18.0.0 `npm test -- -t returns` >I can repro it in the React's master branch which is still using Jest 18.0.0 

React master definitely uses Jest 19: https://github.com/facebook/react/pull/9034.
Also, Jest 18 didn't have this feature in the first place, did it? Oh sorry, I was in an "old" master üòû 

Yeah is was added in [Jest 16 ](https://facebook.github.io/jest/blog/2016/10/03/jest-16.html) as a CLI flag `--testNamePattern|-t`, but it was not exposed in watch mode until Jest 19 üòÑ  Interesting. In any case, even if the failure is on jsdom's side, the watch mode shouldn't crash and exit. The problem is not just that the test fails, but that it also brings down the watcher.  This is definitely odd and Jest shouldn't crash in this case. Yep, I agree I can't repro this with Jest on master.  I run `p` to choose a file:

<img width="591" alt="screen shot 2017-02-22 at 6 21 07 pm" src="https://cloud.githubusercontent.com/assets/810438/23225949/bdc0a22c-f92b-11e6-8160-32e437692a8d.png">

Then I wanted to filter to a single test with `t`:

<img width="506" alt="screen shot 2017-02-22 at 6 21 53 pm" src="https://cloud.githubusercontent.com/assets/810438/23225982/dbe3043e-f92b-11e6-9a10-380f7a5cd539.png">

From this screen, it *seems* like it would only run this test. But nope, it seemingly runs the match on all files:

<img width="843" alt="screen shot 2017-02-22 at 6 22 41 pm" src="https://cloud.githubusercontent.com/assets/810438/23225995/f2b7dd1a-f92b-11e6-9b67-fc7baf6787e5.png">

I'm not sure if this is intentional behavior or not, but it makes test pattern mode much less useful to me because I can never guess how many tests in other files may happen to share the same substring in their name. It's also never useful to me to filter all tests in the codebase by a word. I'd rather have <Enter> take the exact match I chose with arrows than using the pattern I entered. Currently, it only shows the name of the tests that are already cached. I agree that it makes the "t" pattern mode unpredictable... I wonder if we could add some messaging around it to make it less ambiguous üòÑ  Is it ever useful to run all tests matching a name globally?

I understand why it's convenient to *search* tests globally by their descriptions, but once I've found the one I need, I just want to select that test alone and focus on it. (As an alternative to writing `fit`.)

Fuzzy search for files make sense (e.g. if you use common prefixes or want to run all tests in a directory). But test descriptions are usually human readable so patterns don't work that well on them. Why not just treat Enter as *selecting* a test rather than running all tests that match entered pattern? I agree with @gaearon but I preferred to get this feature out so we can collect ideas on how to optimize it in future releases. There are two questions we need to answer here:

* When a pattern is entered to match files, should it stay applied when filtering for files and should we only show tests that match those files? How should we show this in the UI and should there be an escape hatch? (Like "press <Something> to clear the pattern"?).
* Fuzzy search for tests instead of regex: we lose the consistency of the two typeaheads (both expect a regex) but it may still result in a much better user experience. At least we should make it work so that when you type a space, it converts it into `\s` behind the scenes.

cc @zouxuoz  I like that idea, it sounds really interesting  I agree that the testNamePattern still needs more exploration to find the best UX What about hiding it form _Watch Usage_ prompt until we make it work flawlessly? It would still be there but just hidden, because it's like still experimental feature? Yeah, but it still tells you how to exit :D Or, maybe it makes sense to change the wording?
```
 ‚Ä∫ Press t to filter by a test name regex pattern (experimental).
``` PR addressed. btw, with next release space won't be a big deal

<img width="267" alt="screen shot 2017-04-04 at 22 27 37" src="https://cloud.githubusercontent.com/assets/5106466/24677126/fe8224c8-1985-11e7-9fe0-f25d3588af93.png">
 We should bring back this mode and fix it before actually releasing Jest 20 (which is still a little while off, it seems :) ). We are probably not going to make another release to Jest 19. This will be fixed in Jest 20.  üëç love your work! @pedrottimark thanks for the replies. I'm unclear whether you were going to make some changes to the code though? Thanks for the update. Would you mind running the performance test suite before and after your change to know whether the typeof check affects performance at all? Try `yarn test-pretty-format-perf`. I merged another change by @thejameskyle so I'm afraid I need to ask you to rebase one more time. I'm sorry. <img width="342" alt="screen shot 2017-02-27 at 21 22 10" src="https://cloud.githubusercontent.com/assets/5106466/23378191/d627e0f4-fd32-11e6-827b-9cd045c01c88.png">
Changes from the future  **Summary**

This is the first diff to try out prettier on the Jest repo. Our code style aligns with that of prettier for the most part, so I'm quite excited about this opportunity to disable most of eslint and get past code style discussions.

There are a bunch of blockers that imho make it a bit harder to fully adopt it (See https://github.com/prettier/prettier/issues/768 ) but I was thinking I'd try to send a diff with a small set of less controversial code style updates and see what people think.

This was generated by running ` node_modules/.bin/prettier --write "packages/*/src/**.js" --single-quote --trailing-comma --bracket-spacing=false --parser=flow` and then manually staging lines/files that I thought had few or appropriate changes.

**Test plan**

CI still works correctly. Whoa, finally read through all of this üëÄ.  
Overall I'm pretty happy with the results. Lots of small inconsistencies have been fixed. Even some Flow code was improved (and fixed too).
I'm curious what how `prettier`'s maintainers will respond to our findings and proposals üòÑ  Shall we go for this? Shall I revert some of the smaller issues you noticed?

I am hoping that we can convert the remaining files one by one until running prettier won't produce any changed output but I think that also depends a bit on prettier improving :) It's really hard to decide, but after all I'd halt with merging this right now. 

The PR did a good job an resulted in finding few bugs:
* https://github.com/prettier/prettier/issues/771
* https://github.com/prettier/prettier/issues/772

And couple of discussions:
* https://github.com/prettier/prettier/issues/773
* https://github.com/prettier/prettier/issues/774
 Awesome, we'll hold off for a bit.

See my comment here: https://github.com/prettier/prettier/issues/768#issuecomment-281742910  thanks!  Move the typescript parser outside of `jest-editor-support`
to `jest-test-typescript-parser`

<!-- Thanks for submitting a pull request! Please provide enough information so that others can review your pull request. The two fields below are mandatory. -->

**Summary**
Makes babylon parser the default for jest-editor-support, create a second package that contains the code for the typescript parser
<!-- Explain the **motivation** for making this change. What existing problem does the pull request solve? -->

**Test plan**
Tests pass
<!-- Demonstrate the code is solid. Example: The exact commands you ran and their output, screenshots / videos if the pull request changes UI. -->
  Similar issue was discussed here: https://github.com/facebook/jest/issues/2965.  @jackfranklin docs PRs are always welcome! I don't like the naming either. The definitions seems ok üëç  Feel free to open a separate issue just for that, so we can discuss.   Right now, `jest-cli` is great at watching and running a single config for a single project. However, at Facebook we have many projects within one repo and we have a (bad!) internal runner that can merge configs and run them all within one run. It also doesn't support the watch mode.

We spent the past year separating modules for Jest, open sourcing more parts of our internal infra as well as rewriting Jest to support this use case in open source and bring it back in. This issue is to start the discussion as to what this may look like and how we could implement it. I can see this be implemented in two ways:

* `jest-all` a package to run multiple configs within one run.
* Expand `jest-cli` to accept multiple configs.

On first glance, the former seems easier than the latter. We could pull out the remaining pieces from jest-cli to make it really lightweight, separate the watch mode into a separate re-usable package and built a second test runner for the Jest testing platform. Most people will keep using `jest-cli` but for large companies, `jest-all` would become the default.

The second solution is also exciting, however. The technical challenge here is, and this was set up deliberately to execute on this specific issue, how to go from one SearchSource, TestRunner and watch mode to many SearchSources that can pass tests to one TestRunner instances and the watch mode. Basically I can see an implementation of this work that changes the architecture like this:

* n SearchSources for n configurations that create n HasteMaps
* TestRunner, instead of taking a config and a pair of configuration, will be refactored into the general TestRunner and an API that takes a `{config, path}` pair and runs those tests. The refactor is much harder than adding the ability to schedule tests with different configs within one TestRunner instance.
* Watch mode would have to listen to many change events from different HasteMap instances. Instead of `HasteMapInstance` we'd operate on a `Set {HasteMap1, HasteMap2, ‚Ä¶}`.

I'm curious to hear other people's opinions on what they think is the best way forward to make this happen. The end goal will be to remove our legacy internal runner and replace it with this open source piece that we are building here. That will not work for Facebook. The configurations are very different, even in the same codebase :( We don't have package.json files for our monorepo and some projects are a subset of others. I believe what you are proposing is orthogonal to what we are trying to accomplish here. @japhar81 that won't work for us because we have setups where projects are actually nested with different includes/excludes patterns. It's a bit complicated :( As discussed yesterday at our team sync, the first step to this may be how we can separate our config system from global into local configs. There are a number of global settings, like whether to collect coverage, verbose printing, number of workers etc. as well as a ton of local configs, like the roots, all haste map and ignore patterns and which transform to apply. We probably need an RFC for that first before we continue with further decisions. I apologize for not explaining myself better earlier and not sharing enough about this exploration. There is no legacy component that motivates solving this problem besides our internal Jest CLI which is a piece of legacy code that is hard to maintain. This issue is about offering a path forward for our internal infrastructure which isn't scaling as well and falling behind the open source version of Jest as well as open sourcing it because it may be of use to others. I'm trying to source ideas and write up what that multi-runner in open source may look like which may live inside of `jest-cli` or outside of it. This is undecided currently. I'm happy to listen to more ideas to make this a reality but the previous two comments seem orthogonal to the problem we attempting to solve.

To provide a more concrete use case: assume Jest's `examples/` config folder. We would like to build a CLI that can run all examples in a single test run and show an aggregate coverage report for all tests that were run across projects. At Facebook it gets more complicated because we end up including the same test in multiple projects with different configs, however we can ignore that use case in the initial proof of concept. This is happening in the next version of Jest. We discussed a bunch more stuff in the team meetings and we are currently cleaning up things.  `descibe` => `describe` and it will work Please provide more information about when it happens ‚Äì your OS, Node version, your Jest configuration. It's best to provide a repo with actual bug so we can get into it. Maybe the problem is with the cache. Jest only know test names after first successful watch run and caches them. Have you tried run watch on all/just these files and try to match test names again? 

I'm trying this on 2 different projects (including Jest itself) and it doesn't repro. I'll close this, but we can keep the discussion going and reopen if you actually find a bug. Get some rest and let me know how it goes tomorrow üôÇ   Have you tried [`jest.clearAllMocks`](http://facebook.github.io/jest/docs/jest-object.html#jestclearallmocks)? I recommend setting up your spy and resetting it in beforeEach every time.  Thanks!  Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!

**If you are contributing on behalf of someone else (eg your employer)**: the individual CLA is not sufficient - use https://developers.facebook.com/opensource/cla?type=company instead. Contact cla@fb.com if you have any questions. Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks! Actually, the correct path should be `react-native/jest/mockComponent` ‚Äì mind updating to that?  @cj thanks for reporting üëç 

Do you mind providing a bit more details of your setup, or maybe a minimal repository on GitHub so that we can better investigate the issue? Is this also happening when running `--watch` without `--coverage`? We released `19.0.1`, it should be fixed now üòÑ   You can use "CI=true jest --watch" which should work for this use-case. > it would be cool to make the interactive element (press p to filter by a filename... etc.) optional as well

This will be resolved in the next release: https://github.com/facebook/jest/pull/3078
 So currently there's no option to do that in watch mode, because of this line: https://github.com/facebook/jest/blob/v19.0.2/packages/jest-cli/src/watch.js#L101

Maybe we could make it configurable, what do you think @cpojer? I'm sorry, I meant to add some context but got side-tracked. I don't think at this point we'll be adding support for this feature, so I closed this issue. Hmm, that's not great. Maybe we should figure out what workaround might work for you. I'm a bit unsure why "CI=true jest --watch" didn't work. That may actually be a Jest bug, so I'm gonna reopen this issue but we'd appreciate PRs to fix this.  Just noticed a missing space.

![](https://scontent-lhr3-1.xx.fbcdn.net/v/t34.0-12/16839640_375810699456622_1347584771_n.jpg?_nc_log=1&oh=0812ac6ac93753dd5af615c193e7fc6f&oe=58AF613D)

This should fix it.
Another occurrence of the message in `warnings.js` is not affected because it already has the space. Thanks for the fix. Thanks @gaearon.  Thanks! Shouldn't we use `modulePathIgnorePatterns` instead? Hmm, in Jest, `modulePathIgnorePatterns` means Jest will actually ignore those files for real. `jest-haste-map` also doesn't know anything about "tests" because the module doesn't have anything to do with tests. I'd prefer to change it to that; which also means the change will be more minimal (you can add a new "ignorePattern" option; which is a bit redundant but will probably be ok). I suggest create-react-app to change once this change has landed. Ping @ro-savage! Wait, are you sure this version works? Sane uses `anymatch` with the `ignored` option but `ignorePattern` is a regex, not a glob. Would you mind double checking whether a duck-typed RegEx will also work? We are using it here: https://github.com/facebook/react-native/blob/0cb2bc104f9958dfea2a7e22b229a19abeb59fca/packager/src/node-haste/index.js#L105

Arguably that's not a great use of this API, but we had to make it work. If this doesn't work, we have to change the code in react-native to support it somehow :) Mainly because we couldn't change react-native. react-native needs a function to evaluate this instead of a regex and we need to make sure this use-case continues to work. We can type `ignorePattern` as `Function | RegExp` from now on and forward that to anymatch. That way, all we need to do is change react-native to pass the ignorePattern directly instead of the duck-typing, right? That's because the only use of the pattern is here: https://github.com/cpojer/jest/blob/master/packages/jest-haste-map/src/index.js#L687

Would you mind changing the flow types to also accept a function instead and change the code to call `.test` if it is a regex, otherwise call the `ignorePattern` directly? The latter, yes! You still need to update the one place inside of jest-haste-map where we call test directly to check for function/regex and do the right thing. Ah ok, for this one, you can do `// $FlowFixMe`. This is currently a known limitation in Flow, unfortunately. Let's do it. Thanks @ro-savage   Can you format the text correctly? I hardly can tell what you're trying to render.
Also, you're using Enzyme's `shallow` renderer, which will render components only 1 level deep. Not really, as far as I can tell. This is what I see:

<img width="603" alt="screen shot 2017-02-21 at 15 07 03" src="https://cloud.githubusercontent.com/assets/5106466/23168161/706bc1b2-f847-11e6-928d-ed5398ca9e36.png">

It doesn't have information about which component you're trying to snapshot. But from the snapshot output it looks like you're rendering a component which returns `<main />`.
You can use `mount` instead of `shallow` from Enzyme if you'd like to see the whole tree (but be aware that you'll have to update that snapshot frequently, which easily leads to bugs)

Also there are better places to get help, like Stack Overflow, you should definitely check it out üëç   <!-- Thanks for submitting a pull request! Please provide enough information so that others can review your pull request. The two fields below are mandatory. -->

**Summary**
Fixes a bug preventing the babylon parser to correctly parse files with uninitialized variables:
**Test plan**
Add a test to reproduce the bug:
![screen shot 2017-02-21 at 11 48 23 am](https://cloud.githubusercontent.com/assets/87300/23163861/3bd02580-f82c-11e6-98c1-a0c741b21f97.png)
After the fix the test passes.
<!-- Demonstrate the code is solid. Example: The exact commands you ran and their output, screenshots / videos if the pull request changes UI. -->
  Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!

**If you are contributing on behalf of someone else (eg your employer)**: the individual CLA is not sufficient - use https://developers.facebook.com/opensource/cla?type=company instead. Contact cla@fb.com if you have any questions. Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks! thanks!  Yes, we will roll out a patch soon after this is merged https://github.com/facebook/jest/pull/2964, hopefully today.  <!-- Thanks for submitting a pull request! Please provide enough information so that others can review your pull request. The two fields below are mandatory. -->

**Summary**

Feel free to adjust the description
cc: @cpojer
 Awesome! I expanded it a tiny bit. Great, love it.  **Summary**

Biggest Jest release ever. @rogeliog and @thymikee wrote this blog post.

**Test plan**

We'll do it live, tomorrow. cc @skratchdot @kjbekkelund thanks for the review. I fixed the mistakes.

@rogeliog that part was written by @thymikee and I also initially thought it was a mistake :P  Looks like your Vue files are not properly transformed by Babel. Have you tried reaching help at [jest-vue-preprocessor](https://github.com/vire/jest-vue-preprocessor) repo? Without an example repo I'm afraid I can't help much. But you can also check @kentaromiura's article on Vue with Jest: https://medium.com/@kentaromiura_the_js_guy/jest-for-all-episode-1-vue-js-d616bccbe186#.iqyr0k9rj This is unlikely a Jest issue, as @thymikee probably an issue with the preprocessor or your code.  Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!

**If you are contributing on behalf of someone else (eg your employer)**: the individual CLA is not sufficient - use https://developers.facebook.com/opensource/cla?type=company instead. Contact cla@fb.com if you have any questions. Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks! I didn't realize there is a difference in server and client for watchman. For what we are doing, I assume `--version` is going to be enough.

See https://facebook.github.io/watchman/docs/cmd/version.html

Thanks.  Nice catch! If you happen to find some time to add types here, that would be lovely. @pedrottimark thank you for fixing this.  Nice!  Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!

**If you are contributing on behalf of someone else (eg your employer)**: the individual CLA is not sufficient - use https://developers.facebook.com/opensource/cla?type=company instead. Contact cla@fb.com if you have any questions. Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks!  We can't really pass variables by polluting `global` like this. Instead, we could return 
`{hasWarnings, hasDeprecations}` or just `{hasWarnings}` object from `validate()`, if it detects any, otherwise return `true` as we do it already.  Techinically it's a breaking change (but not affecting `prettier`), but it would work for most cases, as object is truthy.

Then we could pass it to `normalize` and make it return `{config, hasWarnings}` instead of `config`.

cc: @cpojer  Or without modifying `normalize`, we could call this upgraded `validate` in watch mode and set a local flag. The second approach would be simpler, but we would have to call `validate` twice. 
The first one would require passing the variable down to jest-cli, which I'm not sure how we could achieve right now. Its sole purpose is to output things to console or throw (that's why it's so easy to use and simplicity is what we aim with this tool). But it doesn't prevent us from returning an object with config and warnings. yeah I think what @thymikee proposed makes sense. We can break the API as well, since Jest 19 is a new major. I think this looks good! One more thing ‚Äì can you update README of jest-validate so it reflects change in `deprecated` method and also note, that `validate` returns?

I think something like this will suffice for return value (just update last line):
```js
import {validate} from 'jest-validate';

validate(
  config: Object,
  options: ValidationOptions,
) // => {config: Object, hasDeprecationWarnings: boolean}
``` Stellar work @zouxuoz. This really makes the developer experience a lot better when people use Jest for the first time since an upgrade.

I think the next step is to refactor the `watch` function to not take 7 arguments or so but instead group them into an object so we have "named parameters".  Thanks!  The line @cj linked to is not responsible for loading data, it is merely used as a cache key.

If you are using information from package.json, make sure your `.babelrc` is deleted and run Jest with `--no-cache` once.  Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!

**If you are contributing on behalf of someone else (eg your employer)**: the individual CLA is not sufficient - use https://developers.facebook.com/opensource/cla?type=company instead. Contact cla@fb.com if you have any questions. Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks! Happens sometimes, it's not your fault. I've restarted the build  <!-- Thanks for submitting a pull request! Please provide enough information so that others can review your pull request. The two fields below are mandatory. -->

**Summary**

It was removed from `jest-runtime`, but it's actually used there: https://github.com/facebook/jest/blob/master/packages/jest-runtime/src/transform.js#L22

Fixes https://github.com/facebook/jest/issues/2935

**Test plan**

clean install 
 This is why we do pre-releases! Thanks everyone for fixing this, I had a hunch this exact thing may happen. Happy to see the suspicion confirmed, @wtgtybhertgeghgtwtg don't blame yourself, it's alright, these things happen :)  Thanks! It was removed from `jest-resolve` but it's actually used there. We need to fix this  ![screen shot 2017-02-17 at 11 03 18 am](https://cloud.githubusercontent.com/assets/165856/23079208/bf37671e-f500-11e6-998a-e1d3b139502c.png)
  Which version of Flow do you run? If you learned something that's not waste üôÇ uh oh. Fixed on master.  <!-- Thanks for submitting a pull request! Please provide enough information so that others can review your pull request. The two fields below are mandatory. -->

**Summary**

Fix unhandled promise rejection by returning a Promise from SearchSource tests

**Test plan**

jest thank you!  We are using an embedded repl.it in https://facebook.github.io/jest/ and repl.it listens to CMD + L for   jumping between lines, which prevents the usage of CMD + L for focusing in the address bar.

I wonder if we should prevent the initial focus in the repl.it console to provide better accessibility support.

![a16z](https://cloud.githubusercontent.com/assets/574806/23076579/f66423ae-f4f5-11e6-908d-a29869028940.gif)
 I reached out to repl.it to see what we can do here. Awesome, CMD+F has the same issue
 Thank you @amasad!  This doesn't happen for core modules, like `fs`. You have to manually call `jest.mock('fs')` on them. They don't exclusively work for node modules. They also work for haste modules which is Facebook's custom module system.  **Summary**

This unbreaks node 4 on travis which doesn't have function name inference and therefore had outdated snapshots.

cc @bestander 

**Test plan**

yarn test on node 4.  In Jest, we use `jest-resolve` to resolve modules. However, it shells out to two other dependencies, `resolve` and `browser-resolve`. `resolve` hasn't been maintained as much as I'd like, we have a hacky workaround inside of `jest-resolve` and we actually have knowledge of the entire filesystem (minus directories) in "HasteFS" (currently not passed to jest-resolve but that can be changed as the places it is created already passes a "ModuleMap" which is also coming from `jest-haste-map`). 

The idea is to take the synchronous part of `resolve` and put it inside of `jest-resolve`. Then rewrite it and fine-tune it for performance (cc @trueadm) and use "HasteFS" to optimize the best case scenario (you can use `jest-file-exists` which is O(1) in the best case and fs.stat in the worst case).

The end state should be for Jest not to depend on `resolve` any longer. We do not need the asynchronous part of resolve.

Call to resolve: https://github.com/cpojer/jest/blob/master/packages/jest-resolve/src/index.js#L84
See: https://github.com/substack/node-resolve/blob/master/lib/sync.js

Follow-up: We should also aim at replacing browser-resolve and making it configurable so that our resolution algorithm can look at any field in package.json to re-route resolution to a module. This can be done in a follow-up, because this is already a big task :)
browser-resolve: https://github.com/defunctzombie/node-browser-resolve

cc @dmitriiabramov @wanderley  There was (still present in 18.1) a config option to adjust `__mocks__` directory but it never really worked well and we decided to kill it, so from Jest 19 it will not be configurable at all. 

But you can still nest `__mocks__` whatever you like.  **Summary**

@thymikee I changed my mind. I hope you are ok with this.

**Test plan**

yarn test @orta you are the native speaker. Mind sending a PR with better wording?  Duplicate of #1874.  This is not a bug, it's intended behaviour and it tells you exactly this. You can however require the module directly from a mock implementation. Exactly, you should use require within your mock implementation. Think of the function you pass to `jest.mock` as a separate module factory as if it were in a separate file.  This should be a three column layout:

![screen shot 2017-02-16 at 12 36 42 pm](https://cloud.githubusercontent.com/assets/165856/23040018/a2049eb2-f444-11e6-8bc4-adcfd004f01f.png)

I'm self-assigning this as I last updated this page. Hah, I like that the `website` label matches the website's new colors. üëç   looks good, thanks for following up :)  this is failing, can I merge it anyway?  Seems like we should throw a real error, we aren't really supporting this usage.  Thank you for this PR. I'm torn about this. I think the reasoning was this:
* We want to ensure that the intention in a call to `test` is encoded: do you intent to make it async or not?
* We wanted to make it easy to have something like `beforeEach(() => reset())` to work and didn't think like the return value mattered so much here.

I appreciate your attempt at unifying this code, however I don't really see the value that we provide by making this breaking change except that people will have to use more curly braces and fix up their existing tests. Do you have any thoughts on that? I think unification is great overall, but in this case it would cause more trouble than it's worth. Especially that we break a lot in this version. Maybe we could postpone such change?
E.g. in Jest 20. We had a discussion about this and for now we think this is thrashing users of Jest too much with little benefit so we aren't going to merge it. If you want to clean up the code without changing behavior, I'll be happy to accept it :)  thanks! I might have been a bit too optimistic with my merge:

<img width="432" alt="screen shot 2017-02-16 at 1 29 37 pm" src="https://cloud.githubusercontent.com/assets/13352/23023147/0460ae1e-f44c-11e6-8377-7f0ccb69891e.png">
  We are trying to add information where we can. We added "Available from Jest 19" or something to other options (like testMatch). Please feel free to send a PR to add this to clearAllMocks.  This image alone is not very informative. Please add more info on how to reproduce it and ask this on [Stack Overflow](https://stackoverflow.com/unanswered/tagged/jestjs) as this is not a help forum.
Good luck!  Hm, I think it would be worth to add all Immutable collections instead of just 2.  Also, how about calling it `ImmutableJSPlugin` and store it in one file?  Oh, I didn't remember that. Now after reading this thread again I'm not super sure using `Immutable.toString()` is best here, as it would cause troubles with rendering nested data structures we already pretty-print, like React components.
Maybe lets wait for @cpojer to weigh in here.  @thymikee if I remember correctly I made that exact same comment on the previous PR. We cannot use Immutable.toString here because of the problem you mentioned. I don't think we should call toString and materialize the entire immutable object just to know which type it is.

cc @leebyron can you help us out a bit? What's the best way to find out whether a value is from immutable.js and what type it is without explicitly requiring immutable.js? @cpenarrieta the way you test for Immutable is totally OK. 

It's just `Immutable#toString` is not as powerful as we'd like it to be, but maybe it's good for starters? BTW, can you test how it renders a set of react components?

It's also great that you use `Immutable` as a devDependency, because it's only needed for tests (although most of them could be replaced with snapshots IMO). Nice! cc @leebyron do you have any comments about this? :) Looks good to me Solid work, thanks @cpenarrieta!  `jest.spyOn` will land in the next release: https://github.com/facebook/jest/pull/2413  Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!

**If you are contributing on behalf of someone else (eg your employer)**: the individual CLA is not sufficient - use https://developers.facebook.com/opensource/cla?type=company instead. Contact cla@fb.com if you have any questions. Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks! Yea, I think this is a good idea. The one thing I'm not 100% sure is using `yarn link`. I remember having some troubles with it in the past. Does it work correctly now? Thank you.  This should work in Jest 19.  thank you!  I like the idea. Would you be willing to send a PR with the implementation?  We prefer not to expose this there. If you need custom setup, use beforeAll in your specific test file.  I think this is a good way to solve this for now. Great work!  We won't be adding this feature. Eventually we are hoping to merge `setupFiles` and `setupTestFrameworkScriptFile` into a single config. `setupFiles` already accepts an array; the only difference is that it runs *before* jasmine and expect are loaded. you can always use ENV variables to decide what to load in your `setupTestFrameworkScriptFile`:

```
if (process.env.LOAD_THIS_SCRIPT) {
  require('Foo');
}
``` Those files are run within the context of a test, so you can require anything you want normally.  Seems like the website stuff is a bit unhappy indeed. so, how are we feeling about this one? that's ok, I'll deal with that during the day today. 
<!--
  0 failure: 
  1 warning:  Changes were made...
  
  
-->


<table>
  <thead>
    <tr>
      <th width="50"></th>
      <th width="100%" data-danger-table="true">Warnings</th>
    </tr>
  </thead>
  <tbody><tr>
      <td>:warning:</td>
      <td>Changes were made to package.json, but not to yarn.lock - <i>Perhaps you need to run `yarn install`?</i></td>
    </tr>
  </tbody>
</table>



<p align="right">
  Generated by :no_entry_sign: <a href="http://github.com/danger/danger-js/">dangerJS</a>
</p>
 who is eslint-bot? Cool, so assuming this passes, we are good to go? awesome, thank you so much @bestander   Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!

**If you are contributing on behalf of someone else (eg your employer)**: the individual CLA is not sufficient - use https://developers.facebook.com/opensource/cla?type=company instead. Contact cla@fb.com if you have any questions. Hi Haroen! Thank you :) Hey Haroen, can you take a look: http://facebook.github.io/jest/users.html it doesn't look that great! Can you send another PR? :) sure! you can test the website by running "npm start" inside of the website/ folder.  Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!

**If you are contributing on behalf of someone else (eg your employer)**: the individual CLA is not sufficient - use https://developers.facebook.com/opensource/cla?type=company instead. Contact cla@fb.com if you have any questions. Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks! Thank you so so much for using Jest at Coursera. I love what you are doing and I'm happy to help.  Thanks for keeping the docs in a good state. This is super important for everyone who uses Jest. Thanks for this, looks good!   I recommend using regular functions for now. We don't expose state currently but we should consider this in the future for a testing library rewrite.  Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!

**If you are contributing on behalf of someone else (eg your employer)**: the individual CLA is not sufficient - use https://developers.facebook.com/opensource/cla?type=company instead. Contact cla@fb.com if you have any questions. Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks! Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks! thank you!  This looks really good and ready to be merged. If you could rename `expectedType` to `getExpectedType` in a follow-up, that would be nice but I didn't want to block the merge because of this. Thank you again, Mark! Hm, can you do `yarn clean-all && yarn` and then try again? I updated to flow-bin 0.39 on master just a few hours ago.  **Summary**
Introducing an optional `HasteImpl` of type `{getHasteName(filePath: string): (string|void)}` that returns the haste name for a module at `filePath` if it is a haste module or `undefined` otherwise.

I'm going to add a similar injectable config to React Native Packager.

This allows us to inject a custom implementation of haste's module id resolution.

**Test plan**

`npm test`  thank you!  I wonder if it happens anywhere else?
But you do following:
1) remove warnings from your codebase
2) mock `console.warn` Closing due to inactivity.  This is not a help forum. Please ask on Stackoverflow! You can probably do something like:

```
jest.mock('Dimensions', () => ({
      window: {
        fontScale: 2,
        height: 1334,
        scale: 2,
        width: 750,
      },
    }
}));
```  Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!

**If you are contributing on behalf of someone else (eg your employer)**: the individual CLA is not sufficient - use https://developers.facebook.com/opensource/cla?type=company instead. Contact cla@fb.com if you have any questions. thanks!  thanks!  thanks.  Is this still a wip?

I originally intended to push back on this because pify is bigger than our promisify function but I guess if it is already loaded then it doesn't matter. Yeah, can you reconcile the fs mock with the other one in the repo or use `modulePathIgnorePatterns` for one of them (if the other one isn't used in the main test suite)? 
<!--
  0 failure: 
  1 warning:  Changes were made...
  
  
-->


<table>
  <thead>
    <tr>
      <th width="50"></th>
      <th width="100%" data-danger-table="true">Warnings</th>
    </tr>
  </thead>
  <tbody><tr>
      <td>:warning:</td>
      <td>Changes were made to package.json, but not to yarn.lock - <i>Perhaps you need to run `yarn install`?</i></td>
    </tr>
  </tbody>
</table>



<p align="right">
  Generated by :no_entry_sign: <a href="http://github.com/danger/danger-js/">dangerJS</a>
</p>
  `--bail` in Jest works across test suites, not individual tests. If you'd like to focus on a specific test that you are fixing, use `-t` or `fit`/`it.only`. Please feel free to change Jest/our fork of Jasmine to implement this feature but this is never how bail worked for Jest. I'd be open to merge a PR if you'd like to change behavior here. I didn't add a link. This change would have to be made somewhere in jest-jasmine2 or jasmine itself.  Thank you for your pull request. We require contributors to sign our Contributor License Agreement, and yours has expired.

Before we can review or merge your code, **we need you to email cla@fb.com** with your details so we can update your status. Unfortunately this is not an appropriate fix because the `cacheDirectory` can be inside of the project root, which is why it is part of the ignore patterns currently. We could change things around to exclude the generated cache dir from inside jest-haste-map but not from the outside.  Travis tells a different story:
<img width="708" alt="screen shot 2017-02-11 at 23 14 20" src="https://cloud.githubusercontent.com/assets/5106466/22857913/e1fc7302-f0af-11e6-8f4d-d9d4702746c5.png">
Make sure you install deps correctly This isn't enough. You also need to pass it on here: https://github.com/cpojer/jest/blob/master/packages/jest-config/src/setFromArgv.js#L11 There is an integration_tests folder in which you can write such tests. It would be great if you could follow-up with one but for now I believe you that this works ;)  Which node version and OS? IT works on Travis for latest build and locally on mac.
Try running `npm run clean-all` and run `npm install again`. Make sure you're on Node >=4 same setup, but on 10.12 So I've actually installed a fresh clone right now and `npm install` passes, `npm run jest` too, but it fails Flow with this error:

```
$ flow check
../jest/packages/eslint-plugin-jest/src/rules/__tests__/no-focused-tests-test.js:15
 15: const RuleTester = require('eslint').RuleTester;
                        ^^^^^^^^^^^^^^^^^ This modules resolves to "<<PROJECT_ROOT>>/../jest/node_modules/eslint/package.json", which is outside both your root directory and all of the entries in the [include] section of your .flowconfig. You should either add this directory to the [include] section of your .flowconfig, move your .flowconfig file higher in the project directory tree, or move this package under your Flow root directory.
``` Which is caused by `yarn link eslint-plugin-jest` resolving to already exisiting link ‚Äì I'm not sure if this is expected behaviour. cc: @cpojer 
`npm link eslint-plugin-jest` fixes this, so we're probably having problems with linking...
Otherwise it works for me. works for me :O :( latest mac os, latest node, through brew. > same setup

This means `nvm` just like you did, version 7.5 Cannot repro, happy to help more if you cannot figure it out.  You can use `testResultsProcessor` for this and output data in the way you want. Alternatively you can run `jest --json` and further process the data.  cc @thymikee he is the expert on this :) @pedrottimark it should have both, but e.g. for `pretty-format` plugin we depend on `$$typeof`, so I'd like you to go with that. 

I think the main problem with displaying diff here is that we can't sort (or can we as special a case?) arrays just like we do with objects. Maybe we can think of better representation of diff for asymmetric matchers? I kinda like the diff for objects, where it actually is quite helpful Maybe we could improve this by only showing parts that didn't match? I'm not sure how hard will it to get to implement though.  I don't know. Do you want to find out and send a PR if it doesn't? cc @dmitriiabramov wrote all of the coverage support, he may be able to help you out. hey @ljharb!
i actually think it's possible to do it with the regular `.json` report that istanbul produces in Jest, we merge some of our coverage in Jest already. I'm not sure what `.raw.json` is, but here's how we report our coverage https://github.com/facebook/jest/blob/master/packages/jest-cli/src/reporters/CoverageReporter.js#L72-L73  You can't really, you'd have to use `--config=JSONstring` to make that work. You can send a PR to expose this to the CLI. No policy, just tragic technical debt from almost six years of development. I'm open to any and all changes here; we can also still make breaking changes before Jest 19 goes out.  Nice! I guess we could make the change to jest-rutnime in a follow-up. The idea was to change jest-runtime to accept a `cacheFS` property in the constructor which is just a map from `path -> source`. Then inside of `_execModule` we could pass on the source that we already read to the `transform` function somehow. Basically we could do `transform(‚Ä¶, {source: this._cacheFS[pathToFile] || null})` ‚Äì does that make sense? Not a todo, but maybe an issue here that links to this PR :) Really solid work @SimenB. Thank you!  üëç   @rubenmoya @cpojer so I've had a moment to take a look at that and it turns out that everything's fine with snapshots making obsolete tests. What's not right, is that `-u` flag is not passed to `examples` and some of our `integration_tests`. 
This is something that we should fix, but it's not relevant to this PR.

As a workaround run `jest -u` in these dirs:
```
examples/react-native
integration_tests/transform/multiple-transformers
``` Ohhh yes, I get what you are saying, you are right. Thanks so much for digging in, phew, no bugs in Jest then, just our set up. Thanks @rubenmoya for working on this!  Node 4 and 5 doesn't support destructuring well. You should either transform it with `transform-es2015-destructuring` or just don't use it  http://node.green/#destructuring--declarations  `mockReset()` will wipe out all data from that mock (the naming is a bit confusing). In Jest 19 (next week probably) there will be `mockClear()` available which will work the way you expect.
Related PR: https://github.com/facebook/jest/pull/2771  Please ask for this on the react-native issue tracker. Jest doesn't do anything special for react-native.  We discussed adding a header like:

```
// Jest Snapshot v1
```

and then validate Jest and throw if the snapshot version doesn't match, like:

```
Error: The snapshot file associated with this project is for version 1 but Jest 25 expects version 2.
``` @anilreddykatta no, it's a version that we define in jest-snapshot, like:

```
const SNAPSHOT_VERSION = '1';

// later:
writeSnapshot() {
  const content = `// Jest Snapshot v${SNAPSHOT_VERSION}, <short url description>`
}

// readSnapshot
const content = readSnapshot();
if (snapshotVersionFromFirstLine < SNAPSHOT_VERSION) {
  throw new Error('update your snapshots!');
}
```

does that make sense? Yes. This is just to let you know, that there's a change in snapshot formatting, which you should just update, because it breaks your tests can we add something like 
```
exports['Schema Version'] = 1;
```
Instead of a comment? (as it's easier to get it for checks later) What about naming collision, when someone names the snapshot the same way? I think a comment is way more correct for this use case.


________________________________
From: Micha≈Ç Pierzcha≈Ça <notifications@github.com>
Sent: Friday, February 10, 2017 6:20:32 PM
To: facebook/jest
Cc: Christoph Pojer; Mention
Subject: Re: [facebook/jest] Jest Snapshot Version Header (#2853)


What about naming collision, when someone names the snapshot the same way?

‚Äî
You are receiving this because you were mentioned.
Reply to this email directly, view it on GitHub<https://github.com/facebook/jest/issues/2853#issuecomment-279023472>, or mute the thread<https://github.com/notifications/unsubscribe-auth/AAA0KAJACWu5BsHNvPbHRfhiM8ZUZYT9ks5rbKpwgaJpZM4L8fDc>.
 Maybe for first version we should not throw an error? We could just save the information about the version 1 in Jest 19 and error on future changes, what do you think? It should definitely throw an error in the first version. If Jest doesn't detect this header, throw -> it means you are pre Jest 19 and the snapshot must be updated. BTW, I'll be working on this tomorrow, but if anyone has time to deal with it today, don't hesitate!  <!-- Thanks for submitting a pull request! Please provide enough information so that others can review your pull request. The two fields below are mandatory. -->

**Summary**

This is a followup of https://github.com/facebook/jest/pull/2731.

I didn't want to alter serialisation improvements which @vjeux introduced, so I thought it would be safer to bring back an `unescape` in a little different form and use it only to generate un-escaped output to diff tool. Thanks to this we avoid having extra backslashes in console output.

Given test:
```js
test('snap', () => {
  expect('coca cola "yoko \\son (*)\d o".').toMatchSnapshot();
  expect(/some-regex('\"\))\\.x/).toMatchSnapshot();
});
```

<!-- Explain the **motivation** for making this change. What existing problem does the pull request solve? -->
Before:

<img width="493" alt="screen shot 2017-02-09 at 18 30 47" src="https://cloud.githubusercontent.com/assets/5106466/22796220/dd259faa-eef9-11e6-8516-a62b59e45f0e.png">

After: 

<img width="488" alt="screen shot 2017-02-09 at 18 30 15" src="https://cloud.githubusercontent.com/assets/5106466/22796219/dd23be42-eef9-11e6-9594-ca9cb3251827.png">

**Test plan**

jest
cc: @cpojer @vjeux 
 @vjeux I thought a bit about _evaling_ these snapshot, but it would be problematic for jsx and regexp at least. We also cannot really use `received` instead `receivedSerialized` for diffing, because the latter is processed through `pretty-format` with all the React plugins.

I know it's not ideal, but it works for now ü§∑‚Äç‚ôÇÔ∏è  @rubenmoya We're kind of rushing things for the next release, hence we decided to rebase your commit and apply it here as you were not responding for couple of days, so I'm sorry! (but we made sure to put your name on the commit!)

And I'm thankful for your work, it's great. Hope we'll get to merge something from you in the future üôÇ  Keep getting knowledge while you're motivated and make it a habit so you can keep doing it when motivation passes :) wow our travis queues are really fucked. I'm gonna merge this and deal with a fix on master if necessary.  sweet!  Which version of Jest was that? @Matzielab would you mind providing a repro or a PR with failing test?  closing as duplicate.  You can do "transform: {}" in Jest or customize your transformers.

http://facebook.github.io/jest/docs/configuration.html#content  
<!--
  0 failure: 
  1 warning:  Changes were made...
  
  
-->


<table>
  <thead>
    <tr>
      <th width="50"></th>
      <th width="100%" data-danger-table="true">Warnings</th>
    </tr>
  </thead>
  <tbody><tr>
      <td>:warning:</td>
      <td>Changes were made to package.json, but not to yarn.lock - <i>Perhaps you need to run `yarn install`?</i></td>
    </tr>
  </tbody>
</table>



<p align="right">
  Generated by :no_entry_sign: <a href="http://github.com/danger/danger-js/">dangerJS</a>
</p>
 Ohh I love this. We'll probably not merge it in time for Jest 19 but I'll get back to this PR soon. I think this feature is very valuable to have for Jest, especially as it expands to different types of testing, like e2e tests. If you then end up writing end-to-end tests, unit tests and integration tests in one file, you'll probably want to tag the e2e tests so that you can skip them from local runs.

I'd like to find out if there is a different API we could use for this: I'm worried that this new feature will cause our static analysis in `jest-editor-support` (to find out the location of all `it` calls) will be more complex. cc @orta for thoughts. Hm, what about this syntax:
```js
describe('functionality', () => {
  tag('tagged', () => {
    test('should pass', () => {})
  });
});
```
Would it be hard to change @Venkat-18?
cc: @dmitriiabramov  @thymikee that will probably involve some changes in jasmine, sing we'll have to have something like `currentTag` global I really want to figure out how we can support this, but I think for now there is no clear idea about what the API might look like, so I'll close this PR for now.  Unfortunately we don't have the bandwidth to support windows. We recognize the support isn't always great but if you'd like to see this fixed, you'll probably have to help us with a PR.  it does.  `testPathDirs` is going to be renamed to `roots`, which is a more accurate name.

We actually just disabled running watch mode when snapshots change: https://github.com/facebook/jest/pull/2833 ‚Äì otherwise we may trigger re-runs while updating snapshots. Oh I see what you mean. That is indeed a bug. I'm curious how we could resolve this. @SimenB can't repro on Jest 19. Can you try it? If you happen to find some time, please provide a repo with this, so we can investigate. So this is kind of an edge case. Jest is partially right about that: _"No tests found related to files changed since last commit."_, because there are no *tests* that have changed, but snapshot is indeed a related file. 

We have the information, that the snap file is changed, so technically, thanks to `__snapshots__` being adjacent to test suite, we could fix it.  thanks!  Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!

**If you are contributing on behalf of someone else (eg your employer)**: the individual CLA is not sufficient - use https://developers.facebook.com/opensource/cla?type=company instead. Contact cla@fb.com if you have any questions. Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks! Thanks!  Have you tried `moduleNameMapper`? Here's [example usage](http://facebook.github.io/jest/docs/webpack.html#handling-static-assets). There was a discussion a while back to have default moduleNameMappers. I'm a bit worried how that might go. @thymikee ever thought about that? Yes I've seen that discussion with Dan, and I like the idea. https://github.com/facebook/jest/issues/1528 I think we could make it so there are some defaults, which gets totally wiped and overwritten if set explicitly by user.  You can send a PR to react native. This is quite interesting. We could also include this somewhere in our docs   Yes this is certainly possible but we need to figure out at what level this makes the most sense. I've been thinking about this for a long time and would love to see this implemented.

Should it simply be a "resolve" config option that is a simple function or shall we allow to subclass `jest-resolve` or `jest-resolve-dependencies` and overwrite all behavior in Jest?

The second thought I had, I actually wanted to take the `resolve` npm package and rewrite the sync part for performance inside of jest-resolve. Currently it isn't really optimized and we have more info about the file system that we could use to speed up Jest itself. This is a really good follow-up fun project for anybody who wants to contribute to Jest :) Yes so the question is what that interface would look like? `jest-resolve-dependencies` is used for features like `jest -o` but it uses `jest-resolve` to do the actual resolution. I think if the interface to swap out is `jest-resolve`, then this would work well. The only thing I'm not sure about is if that is too much, like should we start out by supporting an interface smaller than what jest-resolve currently provides? Let's try it, as long as it can be composed this may work :)  Thanks for bringing this up. Good to see you, @zalun. Are you willing to work on a PR for this? It's unlikely we'll add support for this from our side. Sounds good. Since this is not actionable this way (nobody will work on it in the foreseeable future), I'll close the issue. If you intent to work on it, please send us a PR.  This doesn't seem like a Jest issue. This is not a help forum. Please ask on stack overflow. Check `transformIgnorePatterns`, you may need to customize that. The problem then might be that you are trying to run tests outside of your rootDir, which is not advised. Note that `testPathDirs` will be renamed to `roots` in the next release, because that is what it actually is. I recommend you to set your rootDir to something one level up and simplify your config by limiting what "testPathDirs" looks at. How can Jest find it if you omit it in modulePaths? I think you should include it:
```
  "modulePaths": [
    "<rootDir>",
    "<rootDir>/client",
    "<rootDir>/shared"
  ]
```  It's 'react', not 'React'.  Fixes #2760

It does not rerun the tests when the the 'change' event was caused only by `.snap` files

I still want to verify some things tomorrow before moving forward with this üòÑ  Should we just filter them out completely?

```
eventsQueue = eventsQueue.filter(snapshots);
if (eventsQueue.length) {
  // re-run
}
``` @cpojer I'm not sure that I understood, aren't they achieving the same thing?

```javascript
const onlySnapFileEvents  = eventQueue.every(isSnapshot)
if (!onlySnapFileEvents) {}
``` 

vs

```javascript
eventsQueue = eventsQueue.filter(snapshots);
if (eventsQueue.length) {}
}
```

I went for the `every` option because it will short circuit and return early if the array is large(which I have no idea if that is common or not)

 Oh, yeah, you are right. I guess this morning I was a bit confused when I got up and saw this. Is this ready to be merged?  Nice work! Thanks for sending a PR to Jest to help make testing better for everyone :)  This seems reasonable, especially that this style is also pretty popular thanks to Airbnb eslint config. 
Although it would be a breaking change. 
Would you like to adjust `pretty-format`'s React plugin to render this way? üôÇ 

@cpojer what do you think? We could pass that easily within Jest 19 release, as we're breaking snapshots anyway. Yeah this was brought up before. I think I'd be ok with this change for Jest 19, yes.

@chrisbujok would you be interested in sending a PR for this? The change needs to be made in packages/pretty-format.  We could mention `npm link` method for sure. This is what I like to use

```bash
$ cd packages/jest-cli
$ npm link
$ cd /path/to/your/project
$ jest // runs `jest` from `packages/jest-cli/bin/jest.js`
```
to unlink:

```bash
$ npm unlink jest-cli
```

I think it may require `sudo` if you're having global node modules in a protected dir.

@pedrottimark I don't know why it fails for `--env` ü§∑‚Äç‚ôÇÔ∏è  Yea, seems like `--global` is the way to go as `npm unlink jest-cli` unlinks local module, didn't know about this, thanks!
Building Jest on `npm test` is on purpose, just to be sure you're running latest build.  This error indicates that the test file itself (a "suite" in Jest's terminology) doesn't contain any calls to `it` or `test`. I understand this may be a tiny bit confusing given that we use Jasmine under the hood.  It doesn't seem like this is related to Jest, but more to React or react-router.  Can you setup a brief repro of the issue? I'm not sure if these can be unloaded. I don't think we are able to do so, as you pointed out in the node.js issue you linked to. Maybe it's worth to close it and reopen when the issue is resolved on Node side? I think this is something we would like to know works with Jest Yeah I'm gonna close this out for now. If anybody has creative ideas on how to solve this, please let me know. Yeah, it should work with a custom test environment as long as you only create one instance.

Another solution could be to add a "__resetForTest" method to your native module that resets it in C++.  Unfortunately this is most probably problem with your user (or process like `node`) permissions, not with Jest.  As a workaround you can create the directory manually or with some kind of script with right permissions.  This works for me also on mac os. It may be an odd ubuntu thing, @avaly do you mind investigating further? works for me on slackware64 14.2 tried with both node 6.9.4,  and 7.5.0 :-/  Yes, we are doing that going forward (waiting for a website push) to Jest 19 and beyond, we won't be doing it for older versions.  Thanks for sending a PR!  Would you like to send a PR to fix this? :)  Your regular expressions are intersecting with each other, so e.g. `assets/test.png` will match both. One of them will take over and hence the behaviour. 
You need to consider making these regexps a bit stricter.  Allow to pass a custom invoker to jest-editor-support Runner/Setting to support spawning Jest on a remote server

<!-- Thanks for submitting a pull request! Please provide enough information so that others can review your pull request. The two fields below are mandatory. -->

**Summary**
This adds an optional options to the constructor of both Runner and Setting (as both run Jest using Process).
<!-- Explain the **motivation** for making this change. What existing problem does the pull request solve? -->
This will allow to pass a custom Process object in creation, and will allow support for remote projects.

**Test plan**
run jest on jest-editor-support
<!-- Demonstrate the code is solid. Example: The exact commands you ran and their output, screenshots / videos if the pull request changes UI. -->
 Looks good! Let's rename to createProcess.  Thank you!  whoa this is a long name for a function! Frankly I don't know, but I personally don't like such long names. Could you please provide a sample usage? It would be easier to think about this. I don't think this is something we'd like to support inside of Jest directly at this point. Maybe you can build a snapshot extension library using `expect.extend`? :)  Yes, this is a bug in docs. Would you mind fixing that and send a PR? It should go like that:

```js
  expect(randomCoolNames()).toEqual(
    expect.arrayContaining([
      expect.stringMatching(coolRegex)
    ])
  );
``` I'll be more than happy to assist :). Make sure to read CONTRIBUTING.md doc. yup, you can now send a pull request against master branch Oh, that's right. 
You just need to fork Jest repository (with GitHub interface) and then clone your own repository.  Tests try to run and show the thrown error, so all the information is there. 
This is intended and I don't think we need to change this behaviour.  Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!

**If you are contributing on behalf of someone else (eg your employer)**: the individual CLA is not sufficient - use https://developers.facebook.com/opensource/cla?type=company instead. Contact cla@fb.com if you have any questions. Thank you for your PR but `test` is an alias for `it` and it's perfectly valid to use both.  
<!--
  0 failure: 
  1 warning:  Please ensure tha...
  
  
-->


<table>
  <thead>
    <tr>
      <th width="50"></th>
      <th width="100%" data-danger-table="true">Warnings</th>
    </tr>
  </thead>
  <tbody><tr>
      <td>:warning:</td>
      <td>Please ensure that <code>@flow</code> is enabled on: <a href='https://github.com/mikaelbr/jest/blob/patch-2804/scripts/_runCommand.js'>scripts/_runCommand.js</a></td>
    </tr>
  </tbody>
</table>



<p align="right">
  Generated by :no_entry_sign: <a href="http://github.com/danger/danger-js/">dangerJS</a>
</p>
 thank you! cool!  thanks  @mikaelbr fixed something similar recently. Could you help here? @josalmi does it work with `testRegex`? It may be an issue with `testMatch` on Windows  It's impossible to troubleshoot this without a real example and all the code. This is not a help forum, please ask this question on stackoverflow. Thank you!  Is this the recommended way of shipping eslint plugins?

Don't worry about breaking things, this plugin is officially new with version 19. @cpojer this is how our `eslint-plugin-jest` or `eslint-config-react-app` do it, and it's pretty reasonable that you need `eslint` so you can "plug" something in. Sure, if all the experts agree!  `this` as context is not supported in Jest.  Console logs are buffered and released at the end of test suite, so this can happen. You should use it like @chrisbujok pointed, as setImmediate is async.  When writing tests asynchronously, you either use `done` callback or return a Promise. 
Or you can mock timers and call `jets.runAllTimers` if that's suitable.  thanks! I guess this is still fairly new and people don't know so much about it yet.  Legit oh, thanks!  I'll have look over the weekend, but love the idea of simplifying this!
cc: @pedrottimark who might be interested as well good work!  @thymikee is the architect you need to convince. I'm for separation of concerns, especially if it's reasonable, but `normalize` is actually used in couple of places in `jest-config`, so I'm not sure what's the benefit here? Or maybe I'm missing something? No worries! I love all the work you're doing to get rid of unnecessary code in Jest ‚ù§Ô∏è   Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!

**If you are contributing on behalf of someone else (eg your employer)**: the individual CLA is not sufficient - use https://developers.facebook.com/opensource/cla?type=company instead. Contact cla@fb.com if you have any questions. Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks! For now I prefer not to make any changes here. We'll consider how to improve this in the future.  I like this!  I don't currently have enough time to review this PR specifically but this is definitely something I want and we should make it happen before publishing Jest 19. cc @mjackson @vjeux when we ship Jest 19, we should be able to rename jest-matchers to expect now!  Jest will ship with `eslint-plugin-jest` in the next version, which at least takes care of lint rules for tests. Testing is usually considered as separate from linting, so people are right: this is outside of the scope of Jest. I appreciate you brought this up ‚Äì if you have more ideas on how Jest can help engineers write more correct code, please reach out again.  These benchmark times will be heavily affected by the load on Travis servers, so I'm worried this will be unreliable Thanks!

We'll probably try to see if the new benchmarking feature inside of Jest may work for this: https://github.com/facebook/jest/pull/3026 and then come back to your PR. I'm super interested to see if CI is stable enough to track this long-term.  thanks, again!  Have you tried using [modulePathIgnorePatterns](http://facebook.github.io/jest/docs/configuration.html#modulepathignorepatterns-array-string)? What machine are you on and what's under the hood? How do you run Jest? 
Some info would be helpful  Closing this, but we can keep the discussion about the speed going.  thanks!  This looks good, thanks for the PR! Nice work! I just want to say, this was really good. @nfarina, great first contribution. @thymikee, great work on helping Nick through this. Looking forward to using this in Jest 19 myself!  thanks for the follow up Mark!  Maybe it's some kind of regression in Node, but nothing I've heard before. Yup, that's a node issue. Let's look past this and never speak of Node 7.3 and Node 7.4 again.  This is great! Would you mind also updating examples/async?  This is quite not hard to implement, so if you (or anyone there) are interested in contributing to Jest, I'm glad to help :) Summary of what needs to be done (directory of interest: `packages/jest-matchers`):
* export `asymmetricMatch` from `jasmine-utils` module
* import `asymmetricMatch` and `isUndefined` from it into `matchers.js`
* mimic the usage of `asymmetricMatch` method from `jasmine-utils`' `eq` function and use it in `toMatchObject`
* possible improvements to the existing code: extract helper functions of `toMatchObject` to upper scope for perf Every time a function is called, the code inside it is re-evaluated for various reasons. So if you put some functions inside, they're read/evaluated too. 

But if these helpers are pure functions and you know it, you can hoist them above, so their code is evaluated just once and can be reused by a compiler across all `toMatchObject` calls. 

It's possible that V8 is able to optimise this in some cases (e.g. it can tell that no variables outside the function are being used), but I'm not so sure about it.   This is not a help forum. Please ask on stackoverflow.  **Summary**
As mentioned in #2600.

* Adding mocksPattern was a poor decision on my part. We used to have "testsPattern" but I didn't realize then that we actually hardcoded some paths for mocks, so it never worked. I'm removing it with no replacement to pay down this technical debt.
* People mis-use testPathDirs to limit the tests they are using but it shouldn't be used for that, renaming it to roots.

**Test plan**
jest finally managed to find some time to fix things here.  **Summary**
We didn't have the README for those packages. Adding a few keywords and README. Updated the logo for the README too. I removed the logo, I think we are fine without it there. It's called sabotage! ;] 
And seriously speaking people can use phrases like "mocha js alternative" or similar, so I'm ok with that @pascalduez I'm just copying what these other frameworks are doing. ü§∑‚Äç‚ôÄÔ∏è  thanks! Thank you!  Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!

**If you are contributing on behalf of someone else (eg your employer)**: the individual CLA is not sufficient - use https://developers.facebook.com/opensource/cla?type=company instead. Contact cla@fb.com if you have any questions. Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks! lol, this is strange, there should be a "Details" button like for Travis, but it disappeared Awesome work, @rodrigopr. Really impressed, also thanks for @thymikee for reviewing this.  Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!

**If you are contributing on behalf of someone else (eg your employer)**: the individual CLA is not sufficient - use https://developers.facebook.com/opensource/cla?type=company instead. Contact cla@fb.com if you have any questions.  <!-- Thanks for submitting a pull request! Please provide enough information so that others can review your pull request. The two fields below are mandatory. -->

**Summary**

<!-- Explain the **motivation** for making this change. What existing problem does the pull request solve? -->
TypeScript is a 20Mb dependency of editor-support, this should allow using editor-support without TypeScript and not incur into any penalties.
A better way to do this will be to require to pass a parser to editor-support.
**Test plan**

<!-- Demonstrate the code is solid. Example: The exact commands you ran and their output, screenshots / videos if the pull request changes UI. -->
 cc @orta 

we realized that optionalDependencies are always installed and typescript is like 22 megs big. I think peerDependencies are fine as a solution here. I think that's ok, no? :) NPM and Yarn should show you a brief info of how much network bandwidth did that peerDep saved you üòÑ  I'm gonna merge this. Since this is only shown to implementors, they can either install typescript if they need it or ignore the message. It won't be shown to users.

I agree that the better way to do this would be to make the parser configurable but that just pushes the problem one level higher-up and nobody seems interested to make this change.  Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!

**If you are contributing on behalf of someone else (eg your employer)**: the individual CLA is not sufficient - use https://developers.facebook.com/opensource/cla?type=company instead. Contact cla@fb.com if you have any questions. thanks!  Just run Jest without any arguments (ie. remove -o). It's the default.  @kentaromiura  The RSS feeds are generated by the `convert.js` script which is only used during local development. The deploy script only runs `generate.js`, so these are missing from the GitHub Pages deploys. I'm looking into it. These feeds should be back up now, but we'll need #2769 to be merged in order to fix this on all future deploys.  Will land in Jest 19. Here's a diff: https://github.com/facebook/jest/pull/2593  You're not returning anything from this mock.
Something like this should work:

```js
jest.mock(testConfigPath, () => {
      return {
            value: 'kappa'
      }
}, {virtual: true});
```  In Jest, we actually call a file a test suite. We aren't using the Jasmine terminology. For us, "describe" doesn't mean anything, it is just a way to group together things.  Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!

**If you are contributing on behalf of someone else (eg your employer)**: the individual CLA is not sufficient - use https://developers.facebook.com/opensource/cla?type=company instead. Contact cla@fb.com if you have any questions.  Doesn't it work right now? I think we don't strip comments while transforming, so `istanbul` should receive the information. Yeah!  <!-- Thanks for submitting a pull request! Please provide enough information so that others can review your pull request. The two fields below are mandatory. -->

**Summary**

Drop auto-including of `babel-polyfill` if available. Fixes #2693

**Test plan**

jest
 Huh, didn't notice that warning, thanks! Fallback to use `babel-polyfill` in that example for simplicity So.. this means regeneratorRuntime will be missing‚Ä¶ :( Hm, so why this passes locally on all node versions? Can you wipe away all the node modules folders in examples folders and re-run yarn test? Removed couple of times from async example. Now tried again but for all examples and it fails indeed üòÑ Fixed by importing `babel-polyfill` explicitly (this is not a great practice because it's huge, but it's easy to grasp for sure) I don't think that's great; I would expect a lot of people are using regeneratorRuntime. The alternative is to force people to compile async to generator (instead of async to generator to regenerator) but we'd need to make it so that this works in the CLI without breaking anybody or by suggesting how to do it from the CLI. > compile async to generator (instead of async to generator to regenerator)

This may be tricky, because lots of folks out there are using `babel-preset-es2015` which transforms to regenerator under the hood. 

Not sure how to make it better. So maybe we could replace `babel-polyfill` with `regenerator-runtime` only? But then again it would also affect users who rely on patching some ES6 methods with `core-js` instead of babel presets and plugins. I don't know. Yeah I think that would solve most use-cases. Everything in babel-polyfill is basically already in node4+. For sure there is, but we don't know why it happens and it's only on node 4 Oh wow this is odd. Honestly, I thought I merged this into Jest 19. @thymikee mind rebasing so CI runs again? Rebased Provides a runtime for generators. You also need a babel transform. There's a tutorial on Jest documentation   just ran into this issue on www.

in a test like
```js
console.log('TEST');
throw 'error';
test(() => /* ... */);
```

`console.log` never prints unless jest is run with `--verbose` mode. That can be very confusing when trying to debug a failing suite.
I added a repro and failing test case.

@wanderley do you want to look into it? I think we could use a reference array/object for this and push to that instead of receiving it at the end, something like this:

```
// runTest.js
const consoleMessages = [];
testEnvironment(..., consoleMessages)

// jest-jasmine2 or wherever
result.console = consoleMessages;

// in the console class, pass consoleMessages along
consoleMessages.push(message);
```

That way, when an error is thrown, runTests will simply have the data available in a local variable. I think that makes the most sense. This isn't really actionable as a PR without a fix. Closing for now.  Can you please share the details of the browser where it happens?  Do you use Chrome, Safari, Firefox, Edge, IE or something else?  Pardon my last question, didn't see the first comment  This is unintentional. This was actually fixed earlier but it looks like it didn't make it to master. Actually, this is working for me. You're probably still been served an older CSS file. Is the issue still there after clearing the cache?

Update: I see - the issue is in an older blog post where the repl.it iframe isn't using the new CSS class name.  This one is actually necessary; jest-jasmine2 is bundled by default with Jest but not loaded directly (loaded through `require(config.testRunner)`. Yes, and jest-environment-node.  This is resolved now with https://github.com/facebook/jest/commit/71e7ffda4ed6b53328f3392e0e6981cb677f1bfc.
Thanks for catching! Send thanks to @hramos and @lacker üòâ   Works for me, are you still experiencing this? Thanks for tracking bugs! Appreciated  This looks good. Do you mind:

* Moving `expect.addSnapshotSerializers` to jest-jasmine2.
* Adding documentation for `expect.addSnapshotSerializers`? We published the new website and it is on master again, now, so it can be done in the same PR. Nice work @pedrottimark  Ohhh, no actually we have to fix that. I missed the comment I guess, I was too hasty.  <!-- Thanks for submitting a pull request! Please provide enough information so that others can review your pull request. The two fields below are mandatory. -->

**Summary**

There's a growing number of "help me" issues. Maybe we should stress a bit more that Jest issue tracker is not a help forum and point users to Support page, which includes links to SO and Discord?
 Oh man, I was thinking exactly the same! ‚ù§Ô∏è This can be merged now, since @hramos released new docs üëç   Sorry, this is not a help forum but an issue tracker. I'm unsure what is going on here, but you may want to ask on stackoverflow or try to create a repro on repl.it or a repository on github that shows this problem.  thanks!  Looks like problem with `npm` not resolving  everything correctly, it happens sometimes ü§∑‚Äç‚ôÇÔ∏è   Please do, all files in this repo must have it. Do you mind also moving the types from jest-mock directly into types/Mock and using types/Mock within jest-mock? I think that's better than the current indirection. Oh I see, in that case, nevermind.  We could hoist the types into the `types/` folder in the root, then drop the jest-runtime dependency on jest-mock.  you are awesome.  Maybe you'll find this thread interesting? https://github.com/facebook/jest/issues/1652 Also cc: @orta  This is actually expected behaviour for Jest. That's why we advise to install `babel-jest` next to `jest` itself [when working with Babel](https://facebook.github.io/jest/docs/getting-started.html#using-babel), because we support Node 4, which ships with npm 2 resolving dependencies this way. This is not needed in npm 3 and 4 or Yarn, because they flatten dependencies.

Maybe we could warn better about this? So you include `jest` and `babel-jest` as `"devDependencies"` and it doesn't work? I only see `jest` in your repo. @orta can you advise on the next steps here? Anything we need to do?  Oh yeah, this was removed here when @rogeliog rewrote watch mode.  Nice!  Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!

**If you are contributing on behalf of someone else (eg your employer)**: the individual CLA is not sufficient - use https://developers.facebook.com/opensource/cla?type=company instead. Contact cla@fb.com if you have any questions. Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks!  This is great. Thank you so much for working on this!  You can only have one manual mock per module. We will eventually introduce a way to configure it better that will continue to work with how we use mocks at FB (@ColCh has a PR for this). For now, I consider manual mocks broken and they aren't great. If anybody can conceive a model that will work better and enables us to codemod current manual mocks, I'm happy to hear it.

As far as customizing the folder location or name goes, Jest is opinionated about a few things and I'm not interested in supporting complexity around these things. @ljharb totally agree that's disappointing! It's absolutely my own subjective decision to be opinionated about this. If you are willing to build and maintain this feature, for the long-term, to customize both the mocks folder and snapshot folders, with all that comes with it, please be my guest. I won't stop you and I will probably merge it, but I have reservations regarding the necessary complexity this might add. Thanks @ljharb, that is very much appreciated. Just for the record: both mocks and snapshots should be configurable and snapshots need to be configurable so you can look up a test from the snapshot file and vice-versa. Also, keep in mind that this cannot be a breaking change.  Thank you!  We are rewriting the docs right now, this will be fixed in a few days.  Thanks! Seems like a leftover from the days before jest-diff existed :) thank you!  I'd depends on your build system, you can run linter before the watch or coverage script, e.g. through npm scripts. Either way it has nothing to do with Jest.  You can try chokidar to do it for you easily through npm scripts without any webpack, gulp or something. Good luck!   I'd definitely be interested in the buttons!  Actually testPathDirs is used for more than just mocks and tests, it is also used for regular files. I'm planning on renaming it in Jest 19. Thank you for your contribution.  Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!

**If you are contributing on behalf of someone else (eg your employer)**: the individual CLA is not sufficient - use https://developers.facebook.com/opensource/cla?type=company instead. Contact cla@fb.com if you have any questions. Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks! thanks!  While speaking with some devs on a JS meetup I got this feeling, that many of them are struggling with testing JS with specific frameworks like Angular 1.x/2 Ember or Vue.

I think it would be a good idea to find some reliable blog posts on successful integrations with these frameworks and link it from our documentation.

Tutorials on Jest + framework / lib:
- [x] [Vue.js](https://medium.com/@kentaromiura_the_js_guy/jest-for-all-episode-1-vue-js-d616bccbe186#.d573vrce2)
- [x] [Angular 1.x](https://medium.com/aya-experience/testing-an-angularjs-app-with-jest-3029a613251#.eyisdnohl)
- [x] [Angular](https://www.xfive.co/blog/testing-angular-faster-jest/)
- [ ] Ember ‚Äì This is tough, because it runs on QUnit and there's lot of magic going on, but I'll try to revisit this somewhere soon. No luck finding anything relevant in the wild
- [x] [MobX](https://semaphoreci.com/community/tutorials/how-to-test-react-and-mobx-with-jest)
- [x] [Redux](http://redux.js.org/docs/recipes/WritingTests.html) Here's great @kentaromiura post about Vue.js integration. So good! https://medium.com/@kentaromiura_the_js_guy/jest-for-all-episode-1-vue-js-d616bccbe186#.d573vrce2 @abdulhannanali you're more than welcome! @thymikee We can include Redux's Documentation part [Writing Tests](http://redux.js.org/docs/recipes/WritingTests.html) as it prefers Jest for JavaScript Testing. However, It uses enzyme for testing React Components. I've also tried it couple of months ago without luck, but will try to tackle it some time soon, although I'm not so optimistic. We'll see!  This is how jasmine behaves, I'm afraid this is a wontfix for now. btw cc @dmitriiabramov who wants this changed.  Pretty sure that's not a Jest issue. Can you provide a repository with a repro? maybe something is wrong with the regex.  This is not possible, Jest transforms when a module is being required (like "require('Foo')") which has to be synchronous.  Isn't this related? https://github.com/facebook/jest/pull/2467 Are you able to provide a minimal repro for this case? Thank you!  Dude, this code is mixing so many of `beforeEach` and `beforeAll` in different contexts that I'm not even sure which should be invoked when. 

Running `jest.useFakeTimers();` in `beforeEach()` of the `runPlatformDependentTests` fixes the problem. But generally you shouldn't call `beforeAll` in the function that is being called from another `describe` call. It's hard to read, hard to understand, and as we see it now, leads to "buggy" behaviour. Glad you solved it!   Use `<rootDir>`:
```js
"transform": {
  "^.+\\.js$": "<rootDir>/jest-transformer.js"
}
```  
<!--
  0 failure: 
  1 warning:  Changes were made...
  
  
-->


<table>
  <thead>
    <tr>
      <th width="50"></th>
      <th width="100%" data-danger-table="true">Warnings</th>
    </tr>
  </thead>
  <tbody><tr>
      <td>:warning:</td>
      <td>Changes were made to package.json, but not to yarn.lock - <i>Perhaps you need to run `yarn install`?</i></td>
    </tr>
  </tbody>
</table>



<p align="right">
  Generated by :no_entry_sign: <a href="http://github.com/danger/danger-js/">dangerJS</a>
</p>
 This is fantastic. Thanks for doing this. I honestly don't think it's that big of a deal!

Here are two suggestions that I think we should do to take it over the finish line:

* Remove "mocksPattern" from everywhere in Jest. It shouldn't be configurable. Make it a constant in `jest-haste-map` and it should point to "__mocks__". It was never supposed to be configurable and it just adds unnecessary complexity. If people don't like it, I'm ok if they stop using Jest over it.
* If the mock doesn't match globalMocks, I don't think you need to add it to the haste map at all. jest-runtime/jest-resolve should be able to look for the local mocks already. Can you just try that to confirm my suspicion? I think the jest-haste-map mocks are only really needed at FB. Finally, I believe at Facebook we will need to keep allowing all mocks that are currently in the system. Can you think of a way to make it so it can work the same way as it did before? Otherwise we'd have to add hundreds of folders to this config at Facebook. That's right, you can have just one type for user provided config in `jest-validate`. But there are number of places (e.g. `transform`) where user config is translated into completely different type. You just need to provide a valid example in `jest-config/src/validConfig.js` Ok, I think we need to find a different solution to this and we should be looking at it, but haven't had enough time recently to do so. I'll close this PR for now because it is quite outdated at this point.  
<!--
  0 failure: 
  1 warning:  Please ensure tha...
  
  
-->


<table>
  <thead>
    <tr>
      <th width="50"></th>
      <th width="100%" data-danger-table="true">Warnings</th>
    </tr>
  </thead>
  <tbody><tr>
      <td>:warning:</td>
      <td>Please ensure that <code>@flow</code> is enabled on: <a href='https://github.com/yaycmyk/jest/blob/module-field/examples/module-field/sample/correct.js'>examples/module-field/sample/correct.js</a> and <a href='https://github.com/yaycmyk/jest/blob/module-field/examples/module-field/sample/wrong.js'>examples/module-field/sample/wrong.js</a></td>
    </tr>
  </tbody>
</table>



<p align="right">
  Generated by :no_entry_sign: <a href="http://github.com/danger/danger-js/">dangerJS</a>
</p>
 Hey @yaycmyk. Thanks for your PR. Can you go into more detail where this is used and how this is a standard?

We are planning on releasing Jest 19 next week but I'm afraid if you want to get this in, I'd ask you to make a breaking change to Jest to make sure we aren't adding more options. I would be happy to support this feature and the browser resolution feature if they are merged into one config, like this:

```
packageResolution: ['module', 'browser']
```

This would prefer the "module" field over the "browser" field or the default. This will also enable things like react-native support, this way:

```
packageResolution: ['react-native', 'module']
```

What do you think?  Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!

**If you are contributing on behalf of someone else (eg your employer)**: the individual CLA is not sufficient - use https://developers.facebook.com/opensource/cla?type=company instead. Contact cla@fb.com if you have any questions. Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks! Thanks for the PR. You need to make sure that Flow is happy, please.

I'm not sure if this is really helpful. This way you don't know what is going on at all. I'd prefer the --summary reporter to show the currently running tests for example or a progress bar or something. We could have a dot reporter that prints one "." for every passed test and a red "e" or "f" (or something else) for a failed test. I don't really think this PR provides value for CI. Jest only shows the failed test summary if more than 20 assertions failed. With your change, if less than 20 tests fail, the user will not be able to know which tests those were. @dmitriiabramov knows a lot about reporters. I'd like to hear his perspective on this. what i was thinking:
1. we definitely need custom reporters, because every project usually has different requirements (because of their build pipeline, CI integration, etc...). and there's no universal way to report.
2. Adding a cli flag for every variation seems too much.


i think the best way to approach it is to have a config option with a default value:
```js
reporters: [
  'default',
  'summary'
]
```

later we can configure reporters:
```js
reporters: [
  'default',
  'nyan-cat',
  ['jest-xunit-reporter', {outputFile: '/reports/jest.xml'}]
]
```

i wrote a quick prototype a while ago, but never had a chance to finish it https://github.com/facebook/jest/pull/2115

cc @wanderley  > IMO, this is more valid as a CI reporter.

For CI, it would be good to have machine-readable output. JUnit's XML format is the de-facto standard for this, and most CI systems have functionality to parse it. A pluggable way of configuring reporters (as @dmitriiabramov alluded to above) would be the best way of handling it.

For what it's worth, Jasmine's reporters do seem to work with Jest today. We're actually using an AppVeyor reporter for Jest itself: https://github.com/facebook/jest/pull/1602. I know @cpojer had plans to remove Jasmine one day, so I guess this wouldn't continue working forever, and we'd want to have something that's configurable before removing Jasmine from Jest.  Are you interested in shipping a PR with this? :) Awesome üòé   Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!

**If you are contributing on behalf of someone else (eg your employer)**: the individual CLA is not sufficient - use https://developers.facebook.com/opensource/cla?type=company instead. Contact cla@fb.com if you have any questions. Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks! Thanks for bringing this up. I think this may be confusing: what if the text would be a valid regex but I want to match against a real string? I'm thinking we may need to either make a breaking change here and/or introduce a separate API for string/regex matching.

@thymikee what do you think? To me, since it's `stringMatching` not a `stringContaining`, it implies that is should be rather a RegExp or glob match. 

Maybe we could introduce `stringContaining` or `stringIncluding` (since theres String#includes method available in Node 4)? I'm ok adding expect.stringContaining. @wsmd, are you open to change your PR to add this API?  üëç  @wsmd nope, @vjeux moved asymmetricMatchers to Jest internals and we refactored them to suit our needs better, so no worries about `jest-jasmine` solid work! Thanks for doing this.  I'm not sure if there's an easy way to do it right now, but we should definitely investigate into handling such cases (if possible) Can you provide a repro, @dirkmc.  It would be great to have a 3rd party library like `browser-test-mocks` or `browser-api-mocks` complementary to `jsdom`, which would store such implementations (it would require tremendous amounts of work, but as a OSS project, every missing piece could be patched incrementally with PRs).

But I'm not convinced this should be a part of Jest.

I'll close the issue for now, but I'd like to keep the discussion going! How I see it, is when this library would be solid enough, we could merge it into Jest as another package and further maintain it, just like it was with `pretty-format` or `eslint-plugin-jest` (coming in next major)  Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!

**If you are contributing on behalf of someone else (eg your employer)**: the individual CLA is not sufficient - use https://developers.facebook.com/opensource/cla?type=company instead. Contact cla@fb.com if you have any questions. Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks!  Can you provide a repro for this on GitHub?

```
jest.mock('path/to/module', () => {‚Ä¶})
import {thing} from 'path/to/module';
```

this should definitely work if you are using babel-jest.

(Closing because this is a question)  Snapshots are used to compare against a previous result with the expectation that it will not change, so while I like this proposal we cannot really use snapshots here as the result will most probably vary per run.

I think something like https://github.com/facebook/jest/issues/1705 might work here though.  Let's use the inline-requires and inline-imports transform (cc @zertosh do we have a combined transform yet? Otherwise, where are the two separate ones?).

How to measure:
* Measure the time it takes to run the first piece of Jest ("runJest") and bring that down.
* Measure the time it takes for the first "RUNS" to show up on a warm cache.

More startup performance wins:
* What else shall we do? - [x] drop auto-inclusion of `babel-polyfill` (https://github.com/facebook/jest/issues/2693) Also, @zertosh has a handy script here: https://gist.github.com/zertosh/1486c709fa7683c7bf1e165f114d2875  Also see https://github.com/facebookincubator/create-react-app/issues/1183

We should focus on reducing the amount of dependencies that are shipped with Jest. Is there somebody that could do an analysis? ah, it sucks that all of these are transitive dependencies and that we don't really have much control over it. note-notifier dropped the cli: https://github.com/facebook/jest/pull/2718 Nice! Nice work, thanks @wtgtybhertgeghgtwtg for working on this and getting back with more data :)  The changed files only mode is "best-effort". Sometimes Jest cannot accurately predict what the dependency graph will look like. In this case, I think you might have either had a local change that triggered this (like a change to Radium or something) or that there is some other confusion.  @dmitriiabramov is this the issue you had with babel and bigger files? That message should be unrelated and is coming from babel. It seems like there is an issue with your code here and without a repro (a github repo that can be cloned and `npm test`ed) we are unable to help. @thymikee should not be related.

i just ran tests on the repro repo and all of the test ran for me (there were other unrelated errors though)

@fdeitelhoff can you try running jest with `--no-cache` flag?  This should work fine if you are actually using 18.x of Jest. Are you sure.  This is probably not an issue in Jest, it is likely that your tests aren't cleaning up network resources, timers or other intervals.  I think this is already addressed somewhere here https://github.com/facebook/jest/issues/1873#issuecomment-265573783 and here https://github.com/facebook/jest/issues/2059.

There are workarounds for that, but we should provide much better DX on this. @capaj please send us a PR to address this.  Hmm, that's interesting. I'm not sure if we can make this behavior change at this point and I don't know if it makes sense to use this default. A lot of the fake timer methods also don't advance the clock at all but rather simply execute timer functions, so we wouldn't know what date we'd end up with. I think you can also still advance calls to `Date.now` manually or write your own wrapper that both advances fake timers and sets a new value for time. I'd be curious to see what this looks like in a PR. Maybe we can make it work? Would you be willing to try adding this to FakeTimers?  I'm not sure this is something we are willing to support in Jest. Consider the following use-case:

```
// A.js
module.exports = 42;

// B.js
module.exports = require('A') + 1;

// C.js
const B = require('B');
jest.resetModule('A');
jest.doMock('A', () => 43);
console.log(B) // Still 43, instead of 44
```

I think currently similar things are possible when resetting the entire module registry which is confusing enough. Adding this feature may make Jest even more confusing to people.

If you'd like to reset a single module, I recommend you to require all your modules in the top-level and then requiring the single module you want in `beforeEach` right after a `resetModules` call. This has the same effect and makes it clear you are opting in to this confusing behavior.

Happy to reopen if you convince me that this is useful. I recommend against using imports in this case, using resetModules and then re-requiring the modules you need. I honestly don't see how that can be a blocker for Jest but regardless, even if it is, that doesn't change that this API will definitely be confusing to many users which is why I'm inclined to not support it.  Good question. Jest's environment's should definitely stay in a separate package and, unless you can see any point in having an environment that handles mock resets differently, shouldn't have to know how to deal with these. It may make more sense to keep it in jest-runtime (Option 1) but I'm not opposed to Option 2 if you can find a clean way to do it.

(Closing as it isn't a real issue, happy to continue discussing this).  Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!

**If you are contributing on behalf of someone else (eg your employer)**: the individual CLA is not sufficient - use https://developers.facebook.com/opensource/cla?type=company instead. Contact cla@fb.com if you have any questions. Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks! Nice. Performance improvements in this code are definitely always very welcome. Love that you are doing this.  Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!

**If you are contributing on behalf of someone else (eg your employer)**: the individual CLA is not sufficient - use https://developers.facebook.com/opensource/cla?type=company instead. Contact cla@fb.com if you have any questions. Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks! fantastic work, keep it up! I just changed "foo in object" to "object[foo]" because we don't allow falsy values here anyway.  What you can do right now, it's changing your test generator to make a single test file per expectation. 
Another option could be using `beforeAll` and `afterAll` to manually setup the environment like you describe:
```
beforeAll(joinAllSnapshots)
afterAll(splitAllSnapshots)
```
where `splitAllSnapshots` can just require the generated snapshot file and then write each exports down in parts in a folder and then delete the main snapshot file.
`joinAllSnapshots` can just do a dir list with `fs.readdirSync` and create a single snap file where Jest will expect it to be.

This way you can keep the `.split` files on your version controlled system and Jest will just work as intended, I think as long as you don't use .snap as extension for the split file should work ok. I'm heavily against this because it will make tracking of snapshot files harder and would require more static analysis. There are two questions you should ask yourself:

* Do I really need snapshots that are this big?
* Can I split these huge snapshots up into multiple test files that share common test utilities?

Answering one or both of these questions should lead to smaller snapshot files. Especially the second one is essentially a "user-land implementation" of your feature that comes at no additional complexity for Jest.

Also, SSDs don't suffer the longevity issues any more, so that isn't really a concern here. I feel like the correct answer here would then be to write a diff engine that will make it so that your snapshot will only capture the difference between the items, rather than all the content. @xixixao actually just asked about this at FB last week. I remember @pedrottimark was discussing somewhere about `diffSnapshot` thing. I will eventually catch up to @pedrottimark's awesome issues where he discusses these things, mostly with himself (sorry I haven't been able to keep up, please keep posting issues. I see them :D ) See #2197 and #2202.  It's only automatically loaded because of how npm3/yarn work. If we were to change the algorithm to lay out node modules in Yarn, it would suddenly break everyone. We'll keep this note. babel-jest should be an explicit dependency in your package.json file.  <!-- Thanks for submitting a pull request! Please provide enough information so that others can review your pull request. The two fields below are mandatory. -->

**Summary**
Fixes #2673

<img width="390" alt="screen shot 2017-01-23 at 16 10 02" src="https://cloud.githubusercontent.com/assets/5106466/22209349/76e27c5c-e186-11e6-8b4c-ba54605dcd63.png">

**Test plan**
I may want to add a test for this
  Jest was not matching any tests when the pattern was a directory

![pattern-match](https://cloud.githubusercontent.com/assets/574806/22187848/12130fe0-e0c2-11e6-8e9e-7eb07063f943.gif)
 nice fix!  Don't use testPathDirs for this, it actually means "roots". We should eventually rename this option. `testRegex` for now, yes. We will also add a glob option soon. #2359  Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!

**If you are contributing on behalf of someone else (eg your employer)**: the individual CLA is not sufficient - use https://developers.facebook.com/opensource/cla?type=company instead. Contact cla@fb.com if you have any questions. @wanderley wow, this is awesome. I definitely have always and will always appreciate refactors for the sake of refactors if it improves the overall architecture of the system. In this specific case it hasn't occurred to me that we should do this, so it's definitely interesting. I like that you moved the "global" cache into the instance of the resolver, that makes a lot of sense to me. However, I would prefer jest-resolve not to depend on jest-util. 

It sucks a bit that virtualMocks has to be the first arg to `getModuleID` because it isn't what the method is about. I wish we could move it to an optional third argument but I guess it doesn't improve anything, so let's keep it.
 Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks!  We are not adding support for this. It seems like you aren't properly transforming generators in this example, this is not a Jest error.  <!-- Thanks for submitting a pull request! Please provide enough information so that others can review your pull request. The two fields below are mandatory. -->

**Summary**

Partially fixes #2656 (nav only)

<img width="400" alt="screen shot 2017-01-21 at 17 14 50" src="https://cloud.githubusercontent.com/assets/5106466/22175827/67f9daee-dffd-11e6-8b8f-b56dbbe6caa2.png">

 Currently the header and nav are fixed to the top of the viewport. Since its getting bigger, maybe we should un-fix it, and leave on the top of the document, like as on [React](https://facebook.github.io/react/) page? It is sooo pretty and so much nicer. You are awesome. Is there any more CSS we can kill/cleanup in jest.css? It's such a mess. For sure there is. It would also be great to split css into components and shared parts. Right now it's really difficult to edit that file in 2 separate PRs A day later, looking at this, I still think this is amazing. The new website is gonna be so good.  Check out http://facebook.github.io/jest/docs/tutorial-webpack.html#content

EDIT: new link is https://jestjs.io/docs/en/webpack  <!-- Thanks for submitting a pull request! Please provide enough information so that others can review your pull request. The two fields below are mandatory. -->

**Summary**

Fixes #2657

<img width="1199" alt="screen shot 2017-01-21 at 16 11 19" src="https://cloud.githubusercontent.com/assets/5106466/22175419/bbd39758-dff4-11e6-93b1-72faf1fc6df3.png">

<img width="376" alt="screen shot 2017-01-21 at 16 15 03" src="https://cloud.githubusercontent.com/assets/5106466/22175426/cefd7baa-dff4-11e6-85f9-a764c9f9a29b.png">

 This is so much better than the current website. Nice work @thymikee.

@vjeux any recommendations? Looks really good indeed, great job!

My recommendation is to get rid of the hamburger on mobile. This is the primary navigation of the website so it should be hidden behind a tap + animation. Yeah I agree! I hate it too. Mike got you covered: https://github.com/facebook/jest/pull/2664 Omg!!! This looks so good! Can't wait for it to ship <3  Yep, this looks like cache. Thanks @jwbay!  Are you only talking about debugging? You can debug your tests using `--debug-brk`, see http://facebook.github.io/jest/docs/troubleshooting.html#tests-are-failing-and-you-don-t-know-why

You can also use `node --inspect` which will eventually become the standard but doesn't enable breakpoints to work inside of tests yet because of a bug in node's vm module that is actively being worked on.

There is an ongoing discussion here about running Jest directly in the browser: https://github.com/facebook/jest/issues/848  @capaj would you mind sending us a pull request for this? :)  Thanks for this PR, but we're rewriting the docs and this is already addressed there, as TOC is autogenerated based on sections headings.  You should be using
```js
"setupFiles": [ "<rootDir>/config/polyfills.js" ]
```
Jest will automatically adjust slashes based on OS. @dinukadesilva any updates?  Thank you!  You should pass a `done` callback because this is async code
```js
test('event "onload" is not fired', function(done) {
    // test code...
    reader.addEventListener("load", function(event) {
        console.log("'load' event has been fired!");
        try {
          expect(expected).toEqual(received);
          done();
        } catch(error) {
          done.fail(error);
        }
    });
}
```

Since `expect` can throw error, you need to wrap in try/catch clause, so `done` can be always called.  You can do `require.requireActual('my-mock')` in Jest to get the real module. You also need to call `jest.resetModules()`.  I think exposing `require('jest-snapshot').addPlugins` as `expect.addSnapshotSerializer` makes sense. Would you mind sending a PR for this use-case? I think right now it would be in `setupTestFrameworkScriptFile` or after (in the test file), so "setupTests" will work. In the long-term, setupFiles should work for this as well, from a Jest perspective.

This array is specific to each individual test file, so adding to it will only work per test and has to be repeated per test file :) Yes! Actually, I think the API should be expect.addSnapshotSerializer(plugin). Ie. it should be a singular API and expect a plugin, not a path to a plugin. yeah sounds good. It seems to me like you could potentially remove addPlugin and change this: https://github.com/cpojer/jest/blob/master/packages/jest-jasmine2/src/setup-jest-globals.js#L101

to something like:

```
snapshotSerializers.forEach(serializer => addSerializer(require(serializer)))
```

that way you aren't increasing the API surface of jest-snapshot by making it more generic. Finally, I'd recommend to call it `addSerializer`, the "snapshot" part is redundant coming from `jest-snapshot`. I still suggest `expect.addSnapshotSerializer` though, I'm just talking about the module boundary. No, I think it should be something like this:

```
config.snapshotSerializers.forEach(serializer => addSerializer(require(serializer)));

expect(getSerializers()).toEqual(
  config.snapshotSerializers.map(serializer => addSerializer(require(serializer)))
);
```

does that make sense?
  You should be able do to something similar with `jest --watch --bail`? I love this idea. I think the Jest team has been thinking about building these kind of integrations on top of `jest-editor-support` in the future. @rogeliog and @kentaromiura have been talking about this. As we make jest-editor-support more awesome, it can serve as a platform for alternative watch implementations as well as editor integration. The thought is that Jest will keep shipping with a simple watch mode but there may be separate watchers on top of it, using fancy things like react-blessed etc.

I don't think we'll add this fix mode to the basic watch mode anytime soon so I'm going to close this issue but I'm happy to hear more thoughts you may have.  The latest version of it hasn't been shipped yet from this repo. We will tag version 19 in two weeks and make it actually official.  <!-- Thanks for submitting a pull request! Please provide enough information so that others can review your pull request. The two fields below are mandatory. -->

**Summary**
Fixes danger not correctly skipping __tests__.
<!-- Explain the **motivation** for making this change. What existing problem does the pull request solve? -->

**Test plan**

Works on my machine.
<!-- Demonstrate the code is solid. Example: The exact commands you ran and their output, screenshots / videos if the pull request changes UI. -->
  I might have been confused about something in the original issue but imho I don't think these matchers add a lot of value given how they extend the surface areas. I'd be more supportive if the error messages would provide more value but they are already good for the base matcher.

If you really want these, I recommend adding these matchers to a separate project that can be loaded as part of "setupFiles".  Thank you but I literally just merged this: https://github.com/facebook/jest/pull/2638  Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!

**If you are contributing on behalf of someone else (eg your employer)**: the individual CLA is not sufficient - use https://developers.facebook.com/opensource/cla?type=company instead. Contact cla@fb.com if you have any questions.  Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!

**If you are contributing on behalf of someone else (eg your employer)**: the individual CLA is not sufficient - use https://developers.facebook.com/opensource/cla?type=company instead. Contact cla@fb.com if you have any questions. @eskimoblood we're in the middle of rewriting docs. Can you please check if its already fixed on `new-docs` branch and if no, address this PR there? Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks! Please send it against the new-docs branch. We'll merge it into master any day now.  Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!

**If you are contributing on behalf of someone else (eg your employer)**: the individual CLA is not sufficient - use https://developers.facebook.com/opensource/cla?type=company instead. Contact cla@fb.com if you have any questions. Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks! Thank you for your help!  cc @hramos 

can you check out the new-docs branch (live here: https://jest-bot.github.io/jest/ ). We are rewriting the docs currently and it may answer many things already. Cool! Would you mind sending a PR against that branch?

* cli options are preferred over config options
* There aren't other options for test runners right now. We used to support jasmine 1 but dropped it. I'd like to support many more, like ava's API for example which is awesome but nobody has built that yet. It shouldn't be *too* hard to build another one :)
* You cannot combine jsdom and node currently but jsdom is effectively a superset of the node environment. There are no others but you can point the option to any package similar to the testRunner option (I'm also hoping that somebody will make Jest run in a real version of Electron, btw).
* TestEnvironment is created once per test. I don't really understand the question. There is a "globals" config option too, btw. Why do you need this?
* The cache is using absolute paths, yes. I recommend using watchman on your CI server, that would allow it to re-use a cache from a previous version and will only do the delta of changes necessary.
* Silent doesn't affect performance. This is honestly at this point way more about how fast your tests are rather than the overhead of Jest. Jest's overhead isn't all that big any more. The fastest way to get feedback is the watch mode (will be much faster on file changes in the next release).

Let me know if you have any more questions! * This is what an env looks like: https://github.com/facebook/jest/blob/master/packages/jest-environment-node/src/index.js
* This is what a test runner looks like: https://github.com/facebook/jest/blob/master/packages/jest-jasmine2/src/index.js This is definitely very complex and would need much better documentation on what expected output it should have.

testEnvironment would work: you can do the setup once, when the first environment instance is created and just keep it around. You can potentially compose your own env from the node environment which should work. However, note that we aim to isolate tests from each other so that they don't conflict. Does every single test in your system really need everything from this 5 second setup process?

I'm closing this in favor of the PR you opened but happy to continue answering questions.  Good catch üëç 
@dmitriiabramov can you tell if this supposed to be exposed (and fixed), or we can remove it?

Looks like AVA is using `jest-snapshot` successfully without this method. Leftover from the initial implementation. Thanks for cleaning up! Curious: why did you dig into this code? Oh yeah that's great. I'm not sure if snapshots will work for this or whether we'll need a separate system for fixtures but this is definitely something that we'd like to support in some way: record a fixture and use it unless it is being explicitly updated. My guess is this is very similar to snapshots but still very different in some fundamental ways. I think there is code that can be shared but maybe not all of it. Feel free to join the #jest channel on discord's reactiflux server to discuss more.  This is unrelated to coverage. You are trying to import an svg file which you cannot do in node.js. Check out the tutorial here: http://facebook.github.io/jest/docs/tutorial-webpack.html#content  <!-- Thanks for submitting a pull request! Please provide enough information so that others can review your pull request. The two fields below are mandatory. -->

**Summary**

Add "did you mean" to warnings with the help of Levenshtein. I'm also exporting a helper function to create that message, so it can be used in other warnings and errors (like CLI ones)

<img width="624" alt="screen shot 2017-01-18 at 22 44 27" src="https://cloud.githubusercontent.com/assets/5106466/22085138/1498e222-ddd3-11e6-8b67-98590401c856.png">

This PR also adds quotation marks around config keys, as I thought this is useful for terminals without bolding enabled:

<img width="434" alt="screen shot 2017-01-18 at 23 08 59" src="https://cloud.githubusercontent.com/assets/5106466/22085200/47d2e78c-ddd3-11e6-853c-3d1abb22a403.png">

**Test plan**

jest cc @vjeux  @cpojer after this is merged, I'd like you to publish this as 18.2.0 How does this work with the other PR where you added the same feature? Does this new one go in first? Yep, the other PR will be blocked by this one for now Ok I'll try to review and merge it tomorrow morning. Looks good except for the return value on `.some`.  <!-- Thanks for submitting a pull request! Please provide enough information so that others can review your pull request. The two fields below are mandatory. -->

**Summary**
Cross editor support for getting snapshot metadata from a test file
<!-- Explain the **motivation** for making this change. What existing problem does the pull request solve? -->
This will enable extending various editor to show something similar to this
![https://twitter.com/kentaromiura/status/821459907408859136](https://images.discordapp.net/.eJwVyUEOgyAQQNG7cAAGEWXwNgQpkqpDmOmiaXp3dfPzkv9Tn76rRW0ijReAtXKivmoW6rFkXYjKnmOrrBMdEEVi2o58CoOdDU5hRHQzegzWIVhvgnfjMNww0z098Jnj-9ue6FJf6n8Bm2Qkew.1ldm_GXR9ofHkZuyLcdK-7c86wE)

**Test plan**

<!-- Demonstrate the code is solid. Example: The exact commands you ran and their output, screenshots / videos if the pull request changes UI. -->
I've add a couple of tests, I might have missed something (that's why I've add WIP on the title) but seems pretty solid.

**how to use it**
look at SnapshotSupport-test.js
I've add a small configuration that should enable to change the parser if in the future we or someone else needs it, as well as the plugin array @orta we are still getting the missing @flow annotations on test files :( Once danger support is solid it would be nice to add it to the lint script in the package.json. Nice! I think we are getting closer to something we can ship! :) @bookman25 is right, Snapshot should be exported in index.js. :( Feel free to bring back this pull request and address all the outstanding comments, we are more than happy to merge it! :)  I'm generally scared of supporting these things because `getOwnPropertyDescriptor` etc. is really really slow over things like "Object.keys" and in 99% of the cases it isn't what people want or expect.  `jest.fn` creates a new function every time. It seems like you made a mistake somewhere with your memoization function. Note that this is not a help forum; please ask on stackoverflow or on our discord channel. You can also create a repro here: https://repl.it/languages/jest and share that to stackoverflow or discord.  Running Jest with `--bail` will prevent other test _suites_ from executing. 
In your case there's only 1 test suite (1 file), that's why it checks all other cases.

@cpojer I think we should stress this better in the documentation, right? This should be fixed in master, we fixed yet another issue with bail.  We are rewriting docs on the new-docs branch. Would you mind taking a look there and adding this there? :) Thank you! Sorry about that! Thanks for your PR though :)  Compare New:
![screen shot 2017-01-18 at 12 18 13 pm](https://cloud.githubusercontent.com/assets/13352/22063745/6aa5ec9c-dd78-11e6-906c-431f1a4fb0c7.png)

With Old:
![screen shot 2017-01-18 at 12 18 35 pm](https://cloud.githubusercontent.com/assets/13352/22063741/631d9c36-dd78-11e6-81b6-6c5d208b13d9.png)

Further changes may happen once I merge this into the new docs branch. Merged into new-docs.  Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!

**If you are contributing on behalf of someone else (eg your employer)**: the individual CLA is not sufficient - use https://developers.facebook.com/opensource/cla?type=company instead. Contact cla@fb.com if you have any questions. thanks!  Which version of Jest are you using? This was already fixed in Jest 16 https://facebook.github.io/jest/blog/2016/10/03/jest-16.html#snapshot-updates Can you use `printFunctionName: false` option?:
```js
require('pretty-format')(f, {printFunctionName: false})
``` Great! If you think this should be documented more clearly (e.g. mentioning `[Function fnName]`), please send a PR.

Here's the README of `pretty-format`: https://github.com/facebook/jest/tree/master/packages/pretty-format#api

Closing. Disabling `printFunctionName` should result in always displaying `[Function]` for Node 4 and 6. So can you add some detail on what's wrong?  This is already disabled in Jest since v16, see: https://github.com/facebook/jest/blob/642df0db2128cd87cce67c17eafb188dd1be05b3/packages/jest-snapshot/src/utils.js#L65

I assumed you use `pretty-format` somewhere in your code to print something, and then pass it to Jest to be snapshoted.  <!-- Thanks for submitting a pull request! Please provide enough information so that others can review your pull request. The two fields below are mandatory. -->

**Summary**

`jest-validate` had a circular dev dependency of `jest-config` for testing purposes. Removed this in favour of fixtures.

**Test plan**

jest
  This is kind of critical for Jest's ongoing success.

<img width="848" alt="screen shot 2017-01-16 at 9 59 06 pm" src="https://cloud.githubusercontent.com/assets/13352/22000452/0c0d38a8-dc37-11e6-803b-916b06cc159c.png">
  It's on the new website which we'll publish soon: https://jest-bot.github.io/jest/docs/cli.html#notify

Feel free to send a PR to the new-docs branch if you'd like to improve the content of the docs. Please feel free to amend it with more appropriate text. Please send a PR with more appropriate text! @vvo I believe it depends on distro, but it should work in general  <!-- Thanks for submitting a pull request! Please provide enough information so that others can review your pull request. The two fields below are mandatory. -->

**Summary**

Fixes #2599 

Preview:
<img width="476" alt="screen shot 2017-01-16 at 17 19 47" src="https://cloud.githubusercontent.com/assets/5106466/21991001/3cf1f77c-dc11-11e6-82e9-a957daed488c.png">

**Test plan**

Needs tests. I'm assuming most of the time it will be only a single invalid option. Do you think we could use levenshtein to figure out what the user intended?

https://www.npmjs.com/package/levenshtein

`Unrecognized option "vebose". Did you mean "verbose"?` I can experiment with levenshtein, seems legit for the use case <img width="604" alt="screen shot 2017-01-17 at 16 43 42" src="https://cloud.githubusercontent.com/assets/5106466/22027660/d1987d60-dcd4-11e6-94c2-7457c40235ac.png">
 Can we move the "Did you mean" into jest-validate? @vjeux was asking for it for `prettier`. I can do that Currently blocked by https://github.com/facebook/jest/pull/2630 Please rebase! Rebased. nice work!  Thanks!  <!-- Thanks for submitting a pull request! Please provide enough information so that others can review your pull request. The two fields below are mandatory. -->

**Summary**

Fixes #2610 

Before:
<img width="277" alt="screen shot 2017-01-16 at 15 44 55" src="https://cloud.githubusercontent.com/assets/5106466/21987201/c761e656-dc02-11e6-9ec6-01b30f0af50e.png">

After:
<img width="436" alt="screen shot 2017-01-16 at 15 44 22" src="https://cloud.githubusercontent.com/assets/5106466/21987176/af4b84f0-dc02-11e6-9c82-fea88f488122.png">


**Test plan**

jest
  If you have failures like this I generally recommend using focused tests or `-t` to only run the test that failed. Given that you have to re-run anyway I don't see how `--failures-only` would particularly improve the situation. I'd rather not add this complexity but feel free to convince me :)

cc @kentaromiura this is an area where the Nuclide integration can potentially help.  Can you provide a minimal repro for this issue? As a workaround you can mock `iconv-lite` or this lazy-loaded module with 
```js
jest.mock('lazy-module', () => 'some MOCK')
``` Seems like a problem with that module.  Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!

**If you are contributing on behalf of someone else (eg your employer)**: the individual CLA is not sufficient - use https://developers.facebook.com/opensource/cla?type=company instead. Contact cla@fb.com if you have any questions. Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks!  Since Jest 15 automocking is disabled by default, so nothing gets mocked unless you tell Jest to do so. You can have another folder for integration tests, e.g. look at `integration_tests` dir inside Jest repo. 

Also nothing prevents you to create `test` and `test-integration` npm scripts, running different configs with `--config` flag. @kentaromiura talked about this before, it's similar to snapshots: find a way to record remote data through Jest. @reggi can you design an API that makes sense either within Jest or as a third-party module?  I think it is time for emoji. We should double down on üÉè. I think üö´ and üöß are specifically nice for `jest-validate`. We need to detect windows (see "Yarn") because it doesn't support emoji and add a --emoji flag (so it can be disabled through --no-emoji).

Examples:

‚úÖ PASS
üö® FAIL
üèÉüèª‚Äç‚ôÄÔ∏è RUNS

In the summary on the bottom, if all tests pass, we could signal that with "üÉè" ‚Äì like you have a joker in your hand and we could use ü§° if your tests didn't pass (indicating that your code is clowny).

Where do you think we could add emoji in a way that they aren't annoying yet provide good signal for what's going on?
 I also wouldn't change pass/fail/runs, because I love how they display right now, same with ‚úì and √ó. 

However I'm pretty good with subtle things like:
```
üÉè Determining test suites to run...
üÉè Ran all test suites
‚ö†Ô∏è Jest Deprecation Warning
‚ùå Jest Validation Error
``` I think emojis are great add could add a delightful touch, but I agree with @thymikee on the places that might make sense to add them... I'll try to hack a prototype to see how the experience feels and post a gif of it I think it's overkill to add it instead of PASS etc. but I think showing the üÉè on a successful run is cool :) It's 2017.  _crawl should be super fast if you have watchman installed: it will only look at the delta of the filesystem since the last time you invoked Jest. I'm curious how your idea would work: when would we reconcile changes in the file system. One simple example is adding a test file, before the haste map is built, we don't know which tests are available in the system so we need to wait for the haste-map to be built completely to know which tests to run.

Note that in Jest 19 we'll have a much faster watch mode that is based on jest-haste-map that doesn't run crawl on every change. I don't think that will make any difference but I'm curious to see a proof-of-concept that keeps everything consistent in the same way and is faster.

One thing to note; you don't actually need more than one HasteMap instance. It supports a "roots" argument, which is an Array and it can watch all of these at the same time. Did you try that?  When the screen is too small the typeahead results wrap making it really hard to read.
<img width="462" alt="screen shot 2017-01-13 at 5 59 01 pm" src="https://cloud.githubusercontent.com/assets/574806/21949699/085a40d6-d9ba-11e6-9d3f-c0bd5681a8c5.png">

We could truncate the results based on the terminal width so that they always fit

<img width="494" alt="screen shot 2017-01-13 at 5 59 20 pm" src="https://cloud.githubusercontent.com/assets/574806/21949700/085fced4-d9ba-11e6-9e68-7e98207b7d1d.png">

NOTE: Git does a similar thing

<img width="591" alt="screen shot 2017-01-13 at 6 01 44 pm" src="https://cloud.githubusercontent.com/assets/574806/21949757/68911c5e-d9ba-11e6-9f5e-23cfcdeca81b.png">
 I agree this would be nice to have. Although I like the git output better (with `.../path` instead of `...ath`)
How do we plan to show that pattern is matched in a stripped part? I think highlighting the `...` would be sufficient here.  Currently typeahead only support keys like printable characters, backspace and enter.

We should make it work with copy/paste, ctrl-a, ctrl-b, left arrow, right arrow, etc.
  Issues:
- [x] Truncate typeahead results when there is not enough space #2597 
- [x] Fix findMatchingTests for directories #2671 
- [x] Make testNamePatter and testPathPattern play better together #3327 
- [ ] Improve keyboad support in typeahead(copy/paste, `ctrl-a`, `ctrl-b`, etc) #2596 
- [x] Typeahead Arrow selection #2589 

Open questions:
- Do we want to update how we show each "row" of the results?
- Should we use regex or fuzzy search?
- How can we make sure that we show the correct number of matching tests?
 thanks for creating this issue to track typeahead improvements. I removed this milestone from Jest 20. We'll be able to do all but one (better keyboard support). I don't want to block the release because of that.  Yay this is so much better. I'm sure @gaearon will love this.

Can we make the following changes:
* If `--expand` is passed, we should print the full output like we do now.
* Can we print `‚Éù 5 skipped tests` as last items if there were skipped tests? That way we still give some signal that tests are ignored in that file. This is awesome.

>Can we print ‚Éù 5 skipped tests as last items if there were skipped tests? That way we still give some signal that tests are ignored in that file.

üëç  `1 skipped tests` should be `1 skipped test` (we should look at the number and choose either singular or plural form).

Also, what do you think about writing `skipped N tests` instead of `N skipped tests`? I agree with Dan! Also the way this is printed right now it doesn't dim the number ‚Äì we should dim everything just like in the normal status lines too. One last note: why are we not highlighting skipped test number on the bottom in yellow? I thought we were doing this in the past. I thought it was pretty helpful. I was curious about this one too, but it's probably @zouxuoz terminal color for bold yellow I think. Or am I wrong? Looks awesome! Looks great! One last question then: can/should we make the circle itself yellow? Just like checkmark is green and cross is red. (That might be inherent to symbols, I don't know. But would be nice to it there too.) I agree with @gaearon. I thought we did that before, we definitely put some color on it here: https://github.com/facebook/jest/pull/2593/files#diff-e5f523a1bc6c24b503edaf3a96d10afeR87 Awesome. I don‚Äôt have any other complaints. Thank you for your contribution to Jest!  You need to adjust `transformIgnorePatterns` to whitelist those node modules. By default, Jest doesn't transform files in node modules folders.  This isn't a help forum. Please ask on stackoverflow or discord. Thank you!  thank you!  You should be able to mock `console.warn` and `window.crypto` for every test for the this particular test suite or even test case you can do something like:
```js
const warn = console.warn;
console.warn = jest.fn(); // mock console
// tests...
console.warn = warn // restore console
```

You should be able to mock node-uuid too:
```js
jest.mock('node-uuid', () => {
  return {
    v4: jest.fn(() => 1)
  };
});
``` If you're interested in creating something like this, feel free to send a PR. 
But it won't be high on our priorities list I guess.
@cpojer what do you think? > But it won't be high on our priorities list I guess.

I mean implementing such feature by us, not your PR ‚Äì pull requests are always welcome, but it's often good to discuss the topic before diving in. We could add:

```
/**
 * @testEnvironment jsdom
 */
```

and toggle based on the specified value. I'd be supportive of such a change to Jest. @SimenB it's right here: https://github.com/cpojer/jest/blob/master/packages/jest-cli/src/runTest.js#L32 you have the path to the test file and this is where the env is created.  Unfortunately without more info there is nothing at all we can do to help. Please send us a repro.

At Facebook we use coverage on thousands of test suites and we have not experienced similar issues. However, @dmitriiabramov did run into some issues with babel in the latest version of Jest. Does this repro in Jest 18.0.0? Also @dmitriiabramov is working on async coverage reporters which should make it even faster for larger test suites, but it's just a start: https://github.com/facebook/jest/pull/2512 some of the reasons why coverage can be slow:
1. it's a cold run and cache is not generated, so we're transforming/instrumenting every file from scratch (next run should be faster)
2. you have a lot of vendor files (or maybe node_modules that are included for some reason) and they all get instrumented. you can use `collectCoverageFrom` config to specify where you can collect coverage from
3. You use `collectCoverageFrom` and there's a lot of files that are missing tests, these will be staticly analyzed and covered, but unfortunately there's no way to parallelize those and it has to be done in one thread, which is slow. but as @thymikee mentioned we might be able to fix it soon.
4. There is a babel issue with code formatting that eats a lot of memory (https://github.com/babel/babel/issues/5081) but i don't think it's the case here actually it doesn't look like you're covering a lot of files, so i assume it's either the cache issue or a bug on our side. 
What kind of machine are you running it on? how many cores? is it still slow if you run it again? is it the same slow if you run it with `--no-cache` flag? @bcoe we cache transform results after the first run in Jest as well, so we are doing all of this already. Also, weren't you supposed to be on vacation? ;D there's one thing we can improve actually.
Right now we would transform the same file multiple times if it's required in multiple worker processes at the same time.

here's an example:

| worker 1 | worker 2 |
| - | -|
| `require('react')` | `require('react')` |
| check cache | check cache |
| no cache entry found | no cache entry found |
| start transforming | start transforming |
| finish transforming | finish transforming |
| write cache file | |
| | write cache file again |
| execute | execute |

so in some cases we transform the same file multiple time. we can probably fix it by using a file system lock.

| worker 1 | worker 2 |
| - | -|
| `require('react')` | `require('react')` |
| check cache | check cache |
| no cache entry found | no cache entry found |
| check for `react.lock` file | |
| not found, create `react.lock` file | |
| | check for `react.lock` file |
| | found. transform the next file in the queue, wait for `react` to be transformed by other worker |
| transform react | |
| write cache file | |
| execute | |
| | check `react.lock` again |
| | check cache |
| | `react` cache found |
| | execute | @dmitriiabramov we should probably do that; yes, but at the same time I don't think that has significant impact on performance. I guess it can be tested easily by running Jest with `-i`.  You mean like GitHub Badge? Nope, we don't have anything like that.  Let's discuss this topic in this issue: https://github.com/facebook/jest/issues/2209 since it refers to the same problem, but with different solutions. You shouldn't rely on this behaviour, use `toThrow`/`toThrowError`/`toThrowErrorMatchingSnapshot` instead. Reopening this so it can be discussed further.  @cpojer what do you think? >You shouldn't rely on this behaviour, use toThrow/toThrowError/toThrowErrorMatchingSnapshot instead.

I wasn‚Äôt aware of that, and Create React App has shipped for many versions with test cases that rely on crash failing the test. Is this no longer how it works? Why? Do we need to tell thousands of users to change their test cases? Since which version of Jest has this behavior changed? Oh, I missed the discussion in #2209, sorry. I got the impression that this wasn't implemented.
So do we need to change anything in CRA? I'm a bit confused by this thread. @gaearon cool, nothing has changed üòÑ. What I mean is that the behaviour of empty tests or tests without expects may change in the future. 

As for `toThrow` or `not.toThrow` I just personally find it more verbose, but based on this comment https://github.com/facebook/jest/issues/2209#issuecomment-264595440 you **can** rely on the behaviour currently used in CRA, as expects throw anyway.

#2209 wasn't implemented and is still discussed.
 Now as I look at this, I like simpler approach of CRA better than `not.toThrow`.  Thanks for clarifying! @ashtonsix I understand your confusion around the behavior change we made to make tests without a provided function skipped but I don't think we should make it so empty functions are skipped based on the source. It doesn't seem like a reliable method especially when we have an officially supported way for it. I'm sorry you got confused by the feature we added:

```
test('skipped test');
```

Also, we will always support tests that simply throw. They will turn into a failing test.  Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!

**If you are contributing on behalf of someone else (eg your employer)**: the individual CLA is not sufficient - use https://developers.facebook.com/opensource/cla?type=company instead. Contact cla@fb.com if you have any questions. Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks! Thanks! I think this is nice. 
I'd like to see what others would say about this, before we start a review. This is great and I agree it's a good thing to have. I'm however worried that most people won't use this and I'm also worried of putting roadblocks in their way if we enabled this by default.

You are right: unit tests shouldn't go to the network but there are tons of valid use cases where Jest could make a connection to a database, a browser or other external resources. We specifically changed Jest to be about "Painless JavaScript Testing" when previously it was "Painless JavaScript Unit Testing". There is also things like using Jest with Nightmare (by @nhunzaker: https://www.viget.com/articles/acceptance-testing-react-apps-with-jest-and-nightmare ).

What is your recommendation to move forward with this? I think an optional global flag to turn off all external access isn't really going to improve things for most people. A way to disable it per test (or enable it as an escape hatch) seems much more sensible to me. Instead of adding this directly to Jest, this could also be integrated using `setupFiles`, no? Seems like Twitter agrees this shouldn't be part of Jest directly: https://twitter.com/cpojer/status/820595155052986369

I'm going to close this for now then but if you end up building a third-party library that integrates with Jest (as setupFile) then I'm happy to see a PR from you adding it to our website. It's definitely a use-case that should be supported in some form :)  `jest.mock` calls are automatically hoisted to the top of the file with babel-jest transform. You can omit this behaviour with `jest.doMock`. Have you tried that? Could you provide a repro of this in a GH repository? So `jest.mock` is being hoisted to the function scope, that's why it won't work with `require`s (and definitely not `import`s which are hoisted to module scope) if you call it inside a  function other than `describe` (which is treated specially by Jasmine).
Your `jest.mock` call will be hoisted to the top of that very function (not the module), that's why it won't work the way you expect. 

Generally we advise to setup different mocks in `beforeEach` and `afterEach` if you want them different across test cases. 

@cpojer could elaborate on this in detail, and if we want to hoist the calls to the upper scopes. This is because you are requiring your modules when the module initializes (using import). `jest.mock` gets called way later. The way to solve this is:

```js
beforeEach(() => { // or the specific test
  jest.mock('MyModule', () => ‚Ä¶);
  const MyModule = require('MyModule');
  ‚Ä¶
});
```

etc.  @maher-stripe Does it happen in Jest 19?  I thought it was a bug, but we actually have this behaviour on purpose: https://github.com/facebook/jest/blob/master/packages/jest-snapshot/src/utils.js#L65

@cpojer why would we do that? The problem is that function names are not reliable and they also aren't visible in the real user output. It's like testing a private function of a module ‚Äì if it is important, you should expose it somehow.

Concrete examples where this creates issues:
* node 4 and node 6 have different function name inference
* coverage messes with the function names, so snapshots break when using coverage

See http://facebook.github.io/jest/blog/2016/10/03/jest-16.html#snapshot-updates  


<table>
  <thead>
    <tr>
      <th width="50"></th>
      <th width="100%" data-danger-table="true">Warnings</th>
    </tr>
  </thead>
  <tbody><tr>
      <td>:warning:</td>
      <td>Please ensure that <code>@flow</code> is enabled on: <a href='https://github.com/kwonoj/jest/blob/feat-multi-result/integration_tests/testResultsProcessor/secondProcessor.js'>integration_tests/testResultsProcessor/secondProcessor.js</a></td>
    </tr>
  </tbody>
</table>



<p align="right">
  Generated by :no_entry_sign: <a href="http://github.com/danger/danger-js/">dangerJS</a>
</p>
 Hey! Thanks for your PR, it looks pretty good however I feel like this is overly complex from a design perspective. Right now, if you'd like to use multiple results processors you could create a third processor that uses composition to bring the other two together. I believe that's the better approach and with Jest 18 where the results processor requires to return the modified value it will work better. I'm happy to reopen this if you can convince me it's better to turn this option into an array as generally singular values are always more problematic than array configurations.  This is by design. We do exactly what node does here and that is requiring JSON files by stripping BOM and calling JSON.parse on it. That is true. Mainly because there haven't been any use cases to modify JSON files. I'm not opposed to it, just saying it is not a use case that benefits us at Facebook so we'll relying on the community to fix this :)  Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!

**If you are contributing on behalf of someone else (eg your employer)**: the individual CLA is not sufficient - use https://developers.facebook.com/opensource/cla?type=company instead. Contact cla@fb.com if you have any questions. We are rewriting the documentation right now on the new-docs branch. Would you mind re-sending this PR against that branch? Thank you!  <!-- Thanks for submitting a pull request! Please provide enough information so that others can review your pull request. The two fields below are mandatory. -->

**Summary**

Collect coverage only from `jest-*`, `eslint-*` and `pretty-format` packages, as the rest (`babel-*`, `jest`) is tested through integration tests hence not covered in the report 


<table>
  <thead>
    <tr>
      <th width="50"></th>
      <th width="100%" data-danger-table="true">Warnings</th>
    </tr>
  </thead>
  <tbody><tr>
      <td>:warning:</td>
      <td>Changes were made to package.json, but not to yarn.lock - <i>Perhaps you need to run `yarn install`?</i></td>
    </tr>
  </tbody>
</table>



<p align="right">
  Generated by :no_entry_sign: <a href="http://github.com/danger/danger-js/">dangerJS</a>
</p>
  


<table>
  <thead>
    <tr>
      <th width="50"></th>
      <th width="100%" data-danger-table="true">Warnings</th>
    </tr>
  </thead>
  <tbody><tr>
      <td>:warning:</td>
      <td>Please ensure that <code>@flow</code> is enabled on: <a href='https://github.com/ArtemGovorov/jest/blob/matcherResultTests/packages/jest-snapshot/src/__tests__/matcher-test.js'>packages/jest-snapshot/src/__tests__/matcher-test.js</a></td>
    </tr>
  </tbody>
</table>



<p align="right">
  Generated by :no_entry_sign: <a href="http://github.com/danger/danger-js/">dangerJS</a>
</p>
 It has! Thanks to @vjeux it's now a part of Jest thank you for following up with tests. This is great.  Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!

**If you are contributing on behalf of someone else (eg your employer)**: the individual CLA is not sufficient - use https://developers.facebook.com/opensource/cla?type=company instead. Contact cla@fb.com if you have any questions. Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks! Thanks for catching this! Since we're rewriting documentation, could you please point this change to `new-docs` branch?  Oh, we are actually not explicitly recommending yarn yet. There was some discussion about it, so I guess your PR is obsolete with the new-docs branch. Thank you for sending it though and I'm hoping you'll help us improve our docs going forward :)  Thanks for posting the issue, but this is not a bug in Jest, I'm not sure which library is shallow from, but it's shared between these cases in this suite and it seems to keep the IDs. Let us know how it goes!   thanks! This makes sense to me and I guess it was a bug.  @zouxuoz are you getting back to this? @zouxuoz Sorry that I haven't reviewed your latest changes, I've been really busy but I'll try to get to it as soon as possible üòÑ  Hey! What's the status of this? @zouxuoz is this ready for review? I'd like to get it in for Jest 19.

Also, as a follow-up, it would be cool to cache the test names after the first run so we can also use pattern mode for this after the initial run! This is kickass. OMG this is exactly what I was thinking of. Can we maybe have the name of the test file there as well?

```
transform-test.js > it will work
transform-test.js > it tests this feature
```

and if there is ambiguity (two files with the same name), do:

```
.../jest-runtime/transform-test.js > it will work
.../jest-haste-map/transform-test.js > it will work too
```

what do you think? We have a way to shorten path names, we can simply re-use it. Hmm.. yeah you are right. How does this feel:

* If only a single file matches, don't show the filename
* If multiple file names match, show only the filename
* If multiple file names have the same name, show the file name and path

? I left a bunch of inline comments. I think this is impressive work, if you go around and make the updates @rogeliog and I are asking for, we should be good to merge this. Thanks for all the great work! I'm really excited about this üòÑ !

Here are a couple of UX issues that I noticed: 

When the pattern matches a `describe` block it outputs all of the describe function and not just the  test name.

<img width="881" alt="screen shot 2017-02-08 at 9 05 17 pm" src="https://cloud.githubusercontent.com/assets/574806/22770111/cf7f81fc-ee42-11e6-80fb-0e897e1a47c7.png">

---------
When running the tests for the first time it says `Pattern matches no tests.` even though it is matching some tests. I understand that we still don't have that info in cache but the text seems a bit misleading. I wonder if we could show something that informs the user that the pattern might match some tests, but we don't have enough info at the moment to show which tests are going to match. cc: @cpojer 

<img width="454" alt="screen shot 2017-02-08 at 9 04 27 pm" src="https://cloud.githubusercontent.com/assets/574806/22770135/ef8bb376-ee42-11e6-82b7-f6c764759cf7.png">

---------
When the terminal screen is not wide enough the results are not getting truncated correctly some results are wrapping

<img width="484" alt="screen shot 2017-02-08 at 9 15 03 pm" src="https://cloud.githubusercontent.com/assets/574806/22770247/cfda0f2c-ee43-11e6-8c64-67c1005e8e00.png">

---------

I love the idea of adding that extra context of the file, but there are some small polish items that I'm still not sure how to solve, but they should help us get the best user experience.

File names are taking up different number of characters which results in the divider(`>`) being in different position in each row. I feel that this makes is a bit hard to glance at the results and identify where does the test name start. I have no idea what is the best way to solve this, it could be something like https://github.com/facebook/jest/pull/2568#issuecomment-278302817 or other ways to deemphasize the file names cc: @cpojer 

<img width="1055" alt="screen shot 2017-02-08 at 9 15 24 pm" src="https://cloud.githubusercontent.com/assets/574806/22770261/edbe3900-ee43-11e6-860d-200adbf44ed4.png">

 Don't you think showing file names, grouping, etc is an overkill? The feature is to filter *test names* ‚Äì so we should support that as first priority. If we really like to show extra info, I'd like it to be greyed-out after the test name. @thymikee I requested this, basically as a tie-breaker if you have tests with the same name. I explained it somewhere up top.

@zouxuoz awesome work, man, thank you so much for doing this. I'd like to get this PR in asap and then polish it before the release. Here is what I think we should do in this PR:

* Don't show code or more than one line in the results. Rogelio's repro above that shows that the code that is shown for the eslint plugin is very confusing. We could either truncate, remove the newlines or replace newlines with `‚èé` and truncate them at the end of the line.
* Please also truncate the line if it doesn't fit the terminal window.

Next steps (can be done separately):
* I'll think more about how to better present the results with regards to the filename.
* I'll spend some time thinking about the null-state message.

Again, thank you for your work on this. This is great. @zouxuoz any chance you could polish this up with my recommendations soon so we can ship this for Jest 19? :) beautiful, lets do this. I'm seeing an issue where the the pattern matches tests but they don't execute

![test-name-bug](https://cloud.githubusercontent.com/assets/574806/22858814/30a142c2-f07d-11e6-9044-0a50a4c9c752.gif)
 I'm not sure why but I'm getting a `MaxListenersExceededWarning` that shows up at the bottom of the runner. Might be unrelated.

![flickery](https://cloud.githubusercontent.com/assets/574806/22858830/a13a2724-f07d-11e6-8258-bfc351b47140.gif)
 This is awesome work @zouxuoz. There are definitely ways we can make this even better but I think it is ready to be merged. We can do small follow-ups to make this really solid ‚Äì looking forward to more of your contributions. If you don't mind, please send me your email address: cpojer@fb.com so I can invite you to our jest-core chat.  you need to do this:

```
jest.mock(`Picker`, () => {
  const React = require('react');
});
```

This used to be a bug that we fixed. In a mock you can only require things locally and you aren't allowed to access external variables. To explain why: With `jest.resetModules()` you may reset all currently available modules, so when you call require, you'll get a new version of each module. If you use React from the top level, you'll end up having potentially two copies of React. This one usage is ok and there is an escape hatch for it. Call your variable `mockFoo`. yes.  thanks ‚ù§Ô∏è  yeah this seems reasonable to me. Can you add a test for this that fails on the current master? 


<table>
  <thead>
    <tr>
      <th width="50"></th>
      <th width="100%" data-danger-table="true">Warnings</th>
    </tr>
  </thead>
  <tbody><tr>
      <td>:warning:</td>
      <td>Please ensure that <code>@flow</code> is enabled on: <a href='https://github.com/richardscarrott/jest/blob/bug/strip-bom/packages/jest-runtime/src/__tests__/test_root/UTF8WithBOM.js'>packages/jest-runtime/src/__tests__/test_root/UTF8WithBOM.js</a></td>
    </tr>
  </tbody>
</table>



<p align="right">
  Generated by :no_entry_sign: <a href="http://github.com/danger/danger-js/">dangerJS</a>
</p>
 thanks!  Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!

**If you are contributing on behalf of someone else (eg your employer)**: the individual CLA is not sufficient - use https://developers.facebook.com/opensource/cla?type=company instead. Contact cla@fb.com if you have any questions. Hey @EugeneChu, thanks for this contribution, but it's already addressed on `new-docs` branch. 
10 minutes ago I closed the same fix: https://github.com/facebook/jest/pull/2561  Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!

**If you are contributing on behalf of someone else (eg your employer)**: the individual CLA is not sufficient - use https://developers.facebook.com/opensource/cla?type=company instead. Contact cla@fb.com if you have any questions. Hey @lobut, thanks for your contribution. We're in the middle of rewriting docs on `new-docs` branch, and this issue is already addressed ‚Äì as you can see here, it's autogenerated now https://raw.githubusercontent.com/facebook/jest/new-docs/docs/ExpectAPI.md  Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!

**If you are contributing on behalf of someone else (eg your employer)**: the individual CLA is not sufficient - use https://developers.facebook.com/opensource/cla?type=company instead. Contact cla@fb.com if you have any questions. Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks! Nope, this is a "good old" segmentation fault we hit on Travis once in a while on Node 4. We're not sure why this happens. thanks!  Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!

**If you are contributing on behalf of someone else (eg your employer)**: the individual CLA is not sufficient - use https://developers.facebook.com/opensource/cla?type=company instead. Contact cla@fb.com if you have any questions.  Does it work when set like this?
```js
"setupTestFrameworkScriptFile": "<rootDir>/scripts/jest/setup.js",
``` It's supposed to be `./scripts/jest/setup.js` or what @thymikee proposes. The previous config you used was actually only possible because of a bug that we fixed.  **Summary**

Fixes #2501. I've also removed `colors` from `normalize.js`, because it's not a valid config option and added a note about switching colors off. This may need linguistic adjustments though.

**Test plan**

works on my machine
  Yeah that is actually reasonable in this instance. Not usually the right fix but we are at most waiting for one tick of the loop. Thanks.  

<table>
  <thead>
    <tr>
      <th width="50"></th>
      <th width="100%" data-danger-table="true">Fails</th>
    </tr>
  </thead>
  <tbody><tr>
      <td>:no_entry_sign:</td>
      <td>New JS files do not have the Facebook copyright header: <a href='https://github.com/orta/jest/blob/flowtype_def/packages/jest/src/jest.flow.js'>packages/jest/src/jest.flow.js</a></td>
    </tr>
  </tbody>
</table>


<table>
  <thead>
    <tr>
      <th width="50"></th>
      <th width="100%" data-danger-table="true">Warnings</th>
    </tr>
  </thead>
  <tbody><tr>
      <td>:warning:</td>
      <td>Please ensure that <code>@flow</code> and <code>'use strict'</code> are enabled on: <a href='https://github.com/orta/jest/blob/flowtype_def/packages/jest/src/jest.flow.js'>packages/jest/src/jest.flow.js</a></td>
    </tr>
  </tbody>
</table>



<p align="right">
  Generated by :no_entry_sign: <a href="http://github.com/danger/danger-js/">dangerJS</a>
</p>
 Merging this but we really need to work on the danger integration. Right now it is really noisy. Also an integration test would be nice. actually, travis is unhappy with this :P  Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!

**If you are contributing on behalf of someone else (eg your employer)**: the individual CLA is not sufficient - use https://developers.facebook.com/opensource/cla?type=company instead. Contact cla@fb.com if you have any questions. Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks! It doesn't seem like this was added in all places. You need to add the type here: https://github.com/cpojer/jest/blob/master/types/Config.js#L15 and then let flow tell you how to flow (hah!) it through your code.

Honestly, I'm still going back and forth on this. If we set this to true it can have significant slowdowns in Jest. I'd much rather have a way to whitelist certain node modules folders we know aren't going to be huge. :( See #2796.  <!-- Thanks for submitting a pull request! Please provide enough information so that others can review your pull request. The two fields below are mandatory. -->

**Summary**
Updates the circle ci yml configuration to run Jest tests
<!-- Explain the **motivation** for making this change. What existing problem does the pull request solve? -->

**Test plan**
See if the changes works

<!-- Demonstrate the code is solid. Example: The exact commands you ran and their output, screenshots / videos if the pull request changes UI. -->
 Let's send a new PR or reopen this when it works.  Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!

**If you are contributing on behalf of someone else (eg your employer)**: the individual CLA is not sufficient - use https://developers.facebook.com/opensource/cla?type=company instead. Contact cla@fb.com if you have any questions. thank you.  Checkout this thread: https://github.com/facebook/jest/issues/2488 Not the same but it looks like the reason is the same ‚Äì code from `react-icons` doesn't get transpiled (its package.json desn't provide a "main" field, maybe that's the case), so you have to explicitly tell jest to transpile it with babel transform For now try setting this:
```js
"transformIgnorePatterns": [
  "node_modules/?!(react-icons)"
]
```

You can also check this thread on customising `.babelrc`: https://github.com/facebook/jest/issues/2442#issuecomment-269654883 This error shouldn't have happend. Try to type it instead of copying, maybe you've copied some whitespace.
In the meantime file an issue in `react-icons` about missing [`"main"`](https://docs.npmjs.com/files/package.json#main) field. They're building the files on `prepublish` but don't link to it, so node doesn't know where to look for compiled output. Are you trying this under `jest` key? Maybe it's a bug in CRA then @meetbabu if you want to whitelist `@swish` so it gets transformed, use:
```json
"transformIgnorePatterns": [ "<roodDir>/node_modules/(?!@swish)" ]
```

`(?!)` is a regex negative lookahead, you can go to http://regexr.com/ and tweak your regex as you like :) Include JS files in your transform:
```json
"transform": {
  "^.+\\.(js|jsx|ts|tsx)$": "<rootDir>/jest/jestpreprocessor.js"
},
```  We can't pull in the data structures from the parent context because we want to sandbox every test. If you guys could enumerate the places where these foreign objects are coming from, we can wrap those places and emit the correct instances. For example, if `setTimeout` throws an error, then we can wrap that and re-throw with an Error from the vm context. It's one of the guarantees of Jest that two tests cannot conflict with each other, so we cannot change it. The question is where you are getting your Error and Arrays from that are causing trouble. Ah, hmm, that's a good point. It works for primitives but not that well for errors or arrays :( meh, I'm not sure I love that :( I'm ok if this feature only works in newer versions of node. It seems much cleaner to me; assuming it doesn't have negative performance implications. Yeah, that sounds like a good start.  We're rewriting the docs in `api-docs` branch. Can you check if it's fixed there? And thanks for letting us know! Ah yes, it's `new-docs`, pardon moi. 

It's autogenerated, you can see comment here: https://raw.githubusercontent.com/facebook/jest/new-docs/docs/ExpectAPI.md
```
<AUTOGENERATED_TABLE_OF_CONTENTS>
```

Let's assume it's fixed then, since it's built based on headlines and fix this issue. 

If it still happens after new docs merge, please let me know and I'll be more than happy to reopen.
Thanks!  Use [`expect.extend`](http://facebook.github.io/jest/docs/api.html#extending-jest-matchers) I don't think we want to expose the original matchers; they are not supposed to compose. However, we expose a bunch of methods on `this` that you can help to create your own matchers. What functionality are you looking for exactly? It basically means we have to maintain a certain API for them when I consider them an implementation detail. I think I'd prefer to compose them like this:

```
myMatcher = (received, expected) => {
  expect(received).toBe(expected);
  
  // Do my own custom stuff.
};
```

if you want to customize the output, you can try-catch the expect call. @dmitriiabramov do you have any thoughts? @yoavniran if you return a raw matcher result, wouldn't you end up with wrong error messages?
like.. in your example if you call it as `myMatcher(1, 2)`
the message will say `received: 1, expected: 3` should we just add those shortcuts to the core matchers? :)
i really don't see many other use cases for that. most of the time it's easier to just create a new matcher and share code internally, rather than through some API that exposes raw matchers I still agree with @dmitriiabramov that I don't see the value. Can you explore exposing the functionality you need through other ways? exposing just "one more simple thing" always creates a lot of edge cases that need to be accounted for. That usually creates a pretty big overhead when adding new features or refactoring, so i'd rather not expose anything extra unless we really need to.
@cpojer what do you think about creating `calledOnce` types of matchers?  Are you talking about --watch mode? I guess this is a duplicate of https://github.com/facebook/jest/issues/1860 If we implement this, it should respect the argument coming from the cli.  Currently Jest installed on [repl.it](https://repl.it/languages/jest) runs on version 17.0.3 instead of 18.1.0. 

How do we upgrade that? Thank you @amasad!  rebase pls. I'm gonna wait for CI this time.  `lodash.includes` should be an explicit dependency of the `package.json` file in the danger folder.  This seems odd, why is your file name so long? Can you set a "name" field in your Jest config or package.json? If there is no name in your package.json or config, Jest has to find a way to identify what to use as the cache key. The only thing we have available at that point is the path to the project. If you send a PR that hashes that, I'm ok with it. I'd prefer to hash the path. Package names may not be unique (maybe you have two checkouts of the same project).  **Summary**

Fixes #2534

**Test plan**

Added tests for this 
 


<table>
  <thead>
    <tr>
      <th width="50"></th>
      <th width="100%" data-danger-table="true">Warnings</th>
    </tr>
  </thead>
  <tbody><tr>
      <td>:warning:</td>
      <td>Please ensure that <code>@flow</code> and <code>'use strict'</code> are enabled on: <a href='https://github.com/rogeliog/jest/blob/add-spyOn/packages/jest-runtime/src/__tests__/Runtime-jest-spyOn-test.js'>packages/jest-runtime/src/__tests__/Runtime-jest-spyOn-test.js</a></td>
    </tr>
  </tbody>
</table>



<p align="right">
  Generated by :no_entry_sign: <a href="http://github.com/danger/danger-js/">dangerJS</a>
</p>
 @orta I did add the copyright header, did I miss something? I think this is going to break because I just merged the other PR but I'll fix it up.  thanks! This is a lot safer :) 

<table>
  <thead>
    <tr>
      <th width="50"></th>
      <th width="100%" data-danger-table="true">Fails</th>
    </tr>
  </thead>
  <tbody><tr>
      <td>:no_entry_sign:</td>
      <td>New JS files do not have the Facebook copyright header: <a href='https://github.com/orta/jest/blob/danger/dangerfile.js'>dangerfile.js</a></td>
    </tr>
  </tbody>
</table>


<table>
  <thead>
    <tr>
      <th width="50"></th>
      <th width="100%" data-danger-table="true">Warnings</th>
    </tr>
  </thead>
  <tbody><tr>
      <td>:warning:</td>
      <td>Please ensure that <code>@flow</code> and <code>'use strict'</code> are enabled on: <a href='https://github.com/orta/jest/blob/danger/dangerfile.js'>dangerfile.js</a></td>
    </tr>
  
<tr>
      <td>:warning:</td>
      <td>Changes were made to package.json, but not to yarn.lock - <i>Perhaps you need to run `yarn install`?</i></td>
    </tr>
  </tbody>
</table>



<p align="right">
  Generated by :no_entry_sign: <a href="http://github.com/danger/danger-js/">dangerJS</a>
</p>
 ok, let's try this one! Thanks so much @orta.  Yeah, you should create one plugin for each type from immutable we'd like to pretty-print. Note: the library is called "immutable" not "inmutable".

I'll close this PR for now as it will likely need a couple of iterations to get ready. Feel free to push to this one and notify me by commenting here or create a new PR when you are ready :) I'm also not sure if we want add extra dependency of `pretty-immutable`. I think this can be a good base. But we need to prefix this with "Immutable" and make sure it behaves well with `min` option  Min set to true will behave like immutable.toString. When set to false it will render each value in new line. You can see this behaviour when testing arrays in Jest  <!-- Thanks for submitting a pull request! Please provide enough information so that others can review your pull request. The two fields below are mandatory. -->

**Summary**

As discussed with @cpojer, we should to track coverage for all packages we expose.
This dramatically lowers coverage, which imply we need to write more tests. cc @dmitriiabramov  for most of our packages it doesn't really make sense to write unit tests, because we test them using integration_tests. but unfortunately we can't collect coverage from our integration_tests (because we run another jest in subprocess). @dmitriiabramov I'd rather have a low coverage that we can improve but is correct than a selective coverage we have to maintain over time. @cpojer agree. honestly, i think jest is a kind of a project that won't benefit much from any coverage metric. I just like the fact that we're dogfooding our own product :)  **Summary**

I changed this from using yarn to using npm but forgot the `-d` flag, which is why it was suddenly breaking. Turns out we don't need npm3 for the tests on node 4 any more?

cc @kentaromiura 

**Test plan**

travis passes Note: had to clear the travis cache to make this work; otherwise the npm module wouldn't go away. Ok, there is a bunch of issues here that we need to resolve:

@bestander file dependencies are a mess in yarn. We need to fix it. master without this PR applied, yarn fails because of the jest-runtime file dependency (Cannot call split on undefined).
@orta All of Jest being dev dependencies of Jest cause a lot of trouble. It seems like lerna may need a way to link packages into the top level but for now I think it makes more sense if you create a "danger" folder with its own package.json where you run `npm install`. Basically we need to make it so that Jest's own modules are not part of the top level install, otherwise it might significantly confuse developers when the wrong module is used. Would you mind re-sending the danger PR? That way you can also use the real dependencies of danger. I understand the Jest project is a bit unique here and we are creating somewhat of a cycle.  **Summary**

Fixes https://github.com/facebook/jest/issues/2496

**Test plan**

- [x] extract validation to separate file `validate.js`
- [x] create valid config example for handy tips on broken config
- [x] revamp config error/warning messages
- [x] remove static validation checks from `normalize.js`
- [x] write tests for `validate.js`
- [x] handle deprecation warnings separately
- [x] further refactor/flow `normalize.js`
- [x] make it generic and extract to `jest-config` package

**Preview**

All new errors and warnings on one screen, caught in action:

<img width="679" alt="screen shot 2017-01-07 at 09 58 28" src="https://cloud.githubusercontent.com/assets/5106466/21740643/e328f8ce-d4bf-11e6-8f3a-034ee60152ae.png">
 I think this is pretty much ready for review üëç  cc: @dmitriiabramov on refactoring `normalize.js` done in this PR. **Not ready to review.**
Need to setup Flow correctly for `normalize.js`, will let you know when I'm finished with it. this is so much more declarative! Added missing test for `preset` setup, which I found while refactoring (caused Travis to fail on RN example).

I still have mixed feelings about `Config` type. While normalizing, jest config changes few `Objects` into `Array<[string, Path]>`, which is problematic while type-checking normalization and validation process, so I fallback to plain `config: Object` for now.

I'm thinking about setting another flow type `UserConfig` which is non-exact Object with types from documentation (e.g. having `transform: {[key: string]: Path}` instead of `transform: Array<[string, Path]>`).

@cpojer what do you think? 


<table>
  <thead>
    <tr>
      <th width="50"></th>
      <th width="100%" data-danger-table="true">Warnings</th>
    </tr>
  </thead>
  <tbody><tr>
      <td>:warning:</td>
      <td>Please ensure that <code>@flow</code> is enabled on: <a href='https://github.com/thymikee/jest/blob/adjustment/validate-config/packages/jest-validate/src/__tests__/validate-test.js'>packages/jest-validate/src/__tests__/validate-test.js</a></td>
    </tr>
  </tbody>
</table>



<p align="right">
  Generated by :no_entry_sign: <a href="http://github.com/danger/danger-js/">dangerJS</a>
</p>
 So, this is pretty large diff, I know. I'll try to guide you here a little @cpojer.

**Changes to `jest-config` package**:
* add`jest-validate` as dependency to validate configuration.
* remove most tests responsible for config validation.
* add test for `config.preset`.
* introduce `deprecated.js` ‚Äì a file with information about deprecated config options, used by `jest-validate`.
* introduce `validConfig.js` ‚Äì a file with information about all config options with valid samples, used by `jest-validate` to provide handy error messages.
* replace old error formating to new one.
* refactor `normalize.js` ‚Äì this is where @dmitriiabramov comes in for review. I moved utility functions into `utils.js` and make the code more declarative. Added Flow. 

**Changes to `types/Config`**:
* introduce `InitialConfig` type as a non-exact object with optional keys, couldn't come up with anything better...

**New package: `jest-validate`**:
* README with basic API usage ‚Äì **read it before review**, to see what's the idea behind the package
* `deprecated.js`, `errors.js`, `warnings.js` ‚Äì these are functions used to print warnings and errors, can be overwritten.
* `condition.js` ‚Äì condition to validate config object ‚Äì can be overwritten.  wow this looks good. I added some inline comments but here is some high-level feedback:

* I think we can grow `jest-validate` as a separate project within Jest just like we do with things like `jest-haste-map` and `jest-snapshot`. I love this style of displaying configuration warnings, deprecations, errors and examples. This was a fantastic idea from you.
* Please never use `chalk.white` but instead use `chalk.reset` and `chalk.dim` instead of `chalk.gray`.
* I'd like @dmitriiabramov to take another look after your next changes. I'll review the whole thing one more time after the next iteration and then merge it.
* I'm a little bit worried about breaking existing configurations although I believe your work is pretty thorough.
* I think it is time for emojis. We should double down on üÉè. I think üö´ and üöß are specifically nice for jest-validate. We need to detect windows (see "Yarn") because it doesn't support emoji and add a `--emoji` flag (so it can be disabled through `--no-emoji`). I'll create a task for that, let's do it in a follow-up and not in this diff :) I decided to change the `options` a bit. Since the errors and warnings are quite generic, most of the time users of this package would change only titles and footer, hence new options:
```js
validate(config, validConfigSample, deprecatedConfig, {
  titleDeprecation: 'Custom Deprecation',
  titleError: 'Custom Error',
  titleWarning: 'Custom Warning',
  footer: '  Documentation: http://custom-docs.com'
});
```

I also decided to go red with errors, as it looks more obvious that's something's wrong is going on and looks far better on light-themed terminals.

Light theme:

<img width="820" alt="screen shot 2017-01-14 at 21 12 55" src="https://cloud.githubusercontent.com/assets/5106466/21957756/6dc06e66-da9e-11e6-9658-81c8d3efa0d7.png">

Dark theme:

<img width="809" alt="screen shot 2017-01-14 at 21 13 20" src="https://cloud.githubusercontent.com/assets/5106466/21957757/6dc0d93c-da9e-11e6-87fc-b8904ae68d31.png">

`jest-validate` now, next to revamped `ValidationError`, also exports `logValidationWarning` function, which can be used to style warnings in the same style. Alright I think this is good to go, just a few more improvements to the overall API and we can ship it. pls rebase. Ok I think this is ready. I have one more comment on the example suggestions but I think we can merge this now and it can be improved in a follow-up. Nice work, @thymikee.  Thanks for the detailed description. I think what makes the most sense is to add `cancelAnimationFrame` to react-native. If it is present in the real environment but not in the tests, put it in https://github.com/facebook/react-native/blob/master/jest/setup.js ‚Äì I'm a bit confused as to why `requestAnimationFrame` would be available in Jest but not `cancelAnimationFrame`. Can you find out where it comes from?

(Closing this issue but happy to discuss to resolve it. Feel free to open the same one for RN, though) It may be because of `jest.resetModules()` which will re-evaluate those module factories. If that's not it, then it is an issue with how react-native is set up. As I've consistently pointed out, this seems like something that should be fixed in the react-native repo.  It looks like you didn't install `babel-jest`? This would not be a problem if you used npm 3/4 or yarn. It is probably because `test1.spec.js` is not getting transpiled, which is why it gives a syntax error with the `import`

Which version of Jest are you using? You can also print the whole config object by running Jest with `--debug`

Unfortunately that error in Node 4 is not super helpful. See here for more info https://github.com/facebook/jest/issues/2488#issuecomment-270027383   We use [`npm_lifecycle_event`](https://medium.com/@brianhan/use-this-npm-variable-as-a-flag-for-your-build-scripts-31069f5e2e57#.p7r0m1vz2) to determine that, so I guess npm's issue tracker would be more proper place to put this? Yeah, I don't think npm is giving us all the information we need to print the accurate version of this. @kentcdodds hm, I didn't thought it could be disheartening, sorry if you felt this way @xjamundx! 

So... while writing this response I realised that I misread the `npm start` thus my logic was flawed.

Reopening this. 
@xjamundx if you feel like working on fixing this, if possible, I'm glad to help. @kentcdodds Jest is operating under extremely limited resources. We simply cannot keep up on issues. We'd like to keep our bug tracker useful and we aggressively (sometimes too aggressively) close issues if we believe that the team cannot or will not resolve them within the next 3 months or so. We are always happy to keep the discussion going and reopen issues if necessary.

For this issue in particular, I agree it is an odd setup but if npm isn't giving us the necessary information, we'd probably have to do something hacky to get to the real command. I'd also like to call out that we don't print `yarn test -u` yet because we have no code to detect yarn yet. @xjamundx is there any particular reason why are you using `npm start test.server` command? `npm start` is intended to just run `start` script. `npm run test.server` should be used instead and in this scenario, Jest works correctly.
There's no clean way to detect your variant right now. Ah! Gotcha! I'll take a look in the afternoon. Thanks Kent @kentcdodds after taking a look at `nps`, it appears that `npm start test.server -- -u` won't work at all here. In order to make it work, `jest` would have to say `npm start "test.server -u"` instead.  This should fix it: https://github.com/facebook/jest/pull/2362 Jest 19 is out now.  **Summary**
@bestander told me this now works out of the box.

**Test plan**
travis passes  Hey, I have no idea what I'm doing but happy to help. What are you concretely asking for? A README in packages/jest and packages/jest-cli? If yes, would you mind sending us a PR (maybe with a link to the website or something?) Oh, we don't publish from the top level repo, we publish each folder in packages individually: https://github.com/facebook/jest/tree/master/packages/jest I will not object as long as you help us out with a PR, I would go so far as to say I'd welcome it very much :) Maybe take some inspiration of the stuff in the new-docs branch? ‚ù§Ô∏è enjoy your time off Benjamin. This should be fixed some time soon with #2774  See https://github.com/facebook/jest/pull/2509#issuecomment-270687481 We should also move the markdown files from the eslint plugin package into the website and remove them from the package.  I'll get the access data for the jest-bot and will report back when I added the token.

A few things that would be nice (I will add more ideas some time):
* Fails if there are merge commits in the PR.
* Fails if there are changes to package.json without changes to yarn.lock.

Does Danger have any form of state? Can we potentially use it to compare the performance of the test run to master? @orta I added the token to travis using `jest-bot`. Is there anything else I need to do? I set the "Display value in build log" to "on". Is there something else I need to do? done! 

<table>
  <thead>
    <tr>
      <th width="50"></th>
      <th width="100%" data-danger-table="true">Fails</th>
    </tr>
  </thead>
  <tbody><tr>
      <td>:no_entry_sign:</td>
      <td>New JS files do not have the Facebook copyright header: <a href='https://github.com/orta/jest/blob/danger/dangerfile.js'>dangerfile.js</a></td>
    </tr>
  </tbody>
</table>


<table>
  <thead>
    <tr>
      <th width="50"></th>
      <th width="100%" data-danger-table="true">Warnings</th>
    </tr>
  </thead>
  <tbody><tr>
      <td>:warning:</td>
      <td>Please ensure that <code>@flow</code> and <code>'use strict'</code> are enabled on: <a href='https://github.com/orta/jest/blob/danger/dangerfile.js'>dangerfile.js</a></td>
    </tr>
  </tbody>
</table>



<p align="right">
  Generated by :no_entry_sign: <a href="http://github.com/danger/danger-js/">dangerJS</a>
</p>
 Awesome! Let me know when it's ready and doesn't spam people so much any more ;) @orta the Flow link warning has a link to `@flow` => https://github.com/flow.... should it be in backticks instead? or should it link to the Flow website?  Hey! We won't be adding this feature unless you have time to build this. We simply don't have resources to spend time on it at Facebook.

We are however rewriting the documentation on the new-docs branch (cc @hramos) and what you are proposing is a great idea. If you'd like to help us out, please let's keep this conversation going. I'll close it for now because it's nothing we are actively tracking.

Another thing we were hoping of doing is to add a note when new features get introduced; we simply haven't added any features since we decided to do this :D  @ismay are you willing to ship a PR on that? Cool, take your time, no worries! üôÇ   Thanks! We are currently rewriting the website documentation on the new-docs branch where this is already fixed.  Hey! Would you mind rebasing this PR?  Update to Jest 18.1.  Thanks! We are currently rewriting our documentation. Would you mind resending this PR against the `new-docs` branch?  Thanks for this fix and the thorough investigation. Surprised this never came up.  These things happen from time to time. If you'd like explicit dependencies I encourage you to use Yarn and yarn lockfiles.

The proper fix for issues such as this is for istanbul to also run Jest as part of their integration testing. Maybe file an issue with them to ask about this! :) It's not harsh, I appreciate feedback but I think it is not Jest's job to manage dependencies. I am in favor of auditing all of Jest's dependencies and loosen and tighten version ranges where it makes sense and will welcome a PR that does so but I don't believe exact dependencies are a solution to the problem you were experiencing.

I understand a bad patch release of a transitive dependency can break your entire test suite and that is unfortunate. The reason we are unaffected of issues like this at Facebook is precisely because we are using yarn lockfiles and an [offline mirror](https://yarnpkg.com/blog/2016/11/24/offline-mirror). Version updates are always explicit and run through our entire CI system to make sure they are safe. If you are scared of patch or minor version updates breaking your product, I suggest fixing it in a similar way. I'm open to listen to actual workable solutions to this problem and especially pull requests that don't compromise how semver is supposed to work rather than expressing your disappointment. @bcoe thanks for the perspective, this is much appreciated. I think running `yarn test` inside of the Jest repo *may* have caught this; I guess it shouldn't be too hard to verify.

`bundled-dependencies` is interesting; I wasn't aware it is a thing. I still do want users to receive patch updates for most things, though.

One thing I was planning on doing is to figure out the biggest dependencies of Jest and how we can trim the fat a bit. Jest is growing and I would like to make sure we don't regress on install times and startup performance. Ah, I believe the node maintainers said that Jest isn't compatible with citgm because of the monorepo we are using. That seems like something we should figure out so that we don't repeat the node 7.3 + console.log fiasko (OT for this issue).  For deleting and keeping the state that's what we do in Jest, and it's not as straightforward because there are exceptions, I remember @dmitriiabramov added some code to catch when one runs a focused test (eg a real case scenario might be while debugging an issue or writing a brand new test) and in that case you don't want to delete all the snapshots. 
Also if a test fail you don't want to delete the associated snapshot.
I think everything we know about a test run should now be handled by the State object here: https://github.com/facebook/jest/blob/master/packages/jest-snapshot/src/State.js

Edit: I think this is the commit I was thinking about https://github.com/facebook/jest/commit/26478b544ff6154c71049e38749fec9fafd25ad1 We spent a ton of time at Facebook to get the UX for snapshot testing just right. I think we did well, even though I think we are still at the beginning ‚Äì there is so much more we can do. I believe it is critical to make the snapshot feature more generic so that bringing snapshots to other frameworks will also result in a great experience. My main worry of adopting jest-snapshot in other projects has been that the integration may not be as great as in Jest and it would steer people away from using this assertion for the wrong reasons. Thanks @lithin for bringing this up, here are my thoughts:

* **Reporting:** I believe we now already return the expected and received values so you can do your own pretty-printing. If not, that should be easy to add.
* **Deleting:** Jest does a ton of work to keep individual snapshots and snapshot files consistent. We designed the feature so that you never end up having either a test file without a snapshot file, a snapshot file without a test file or with obsolete snapshots within a file. I believe that keeping a project consistent is really imperative for the snapshot feature to be attractive. One thing we haven't gotten to right now is that when an obsolete snapshot (file) is detected, we fail the test run but we don't fail the individual test (if available) that should be failing ‚Äì this would be good to troubleshoot which snapshot Jest has a problem with. Cleanup and consistency checks can be supported if we make the cleanup interface generic: https://github.com/cpojer/jest/blob/master/packages/jest-snapshot/src/index.js#L30. As Cristian points out, the state management for individual snapshots associated with a test should already be exposed and it is up to the test library to decide how to handle failures and skipped tests.
* **Watch:** the watch mode is specific to Jest and can potentially be extracted to be re-used by ava. We are rewriting it in #2362 and there is nothing that prevents it from being extracted into a separate jest-watch package (cc @rogeliog). This of course is only going to work if you are ok with taking on `jest-haste-map` as a dependency (this is what does all the static analysis for Jest).
* **Summary:** While extracting the watch mode would be cool, I think it is much more important to also extract the code from the summary reporter that shows the status of snapshots in the project. See https://github.com/cpojer/jest/blob/master/packages/jest-cli/src/reporters/SummaryReporter.js#L123 ‚Äì can we find a way to make this generic so it can be consumed by other frameworks? I think there is value in sharing the same status report.

There are also a ton more things we'd like to add to the snapshot feature, as well as an interactive update mode but that should be discussed in a separate issue.  thanks! Sorry for the delay  <!-- Thanks for submitting a pull request! Please provide enough information so that others can review your pull request. The two fields below are mandatory. -->

**Summary**
Provides a better error for invalid `transform` config option. Fixes https://github.com/facebook/jest/issues/2228

<img width="659" alt="screen shot 2017-01-03 at 22 48 13" src="https://cloud.githubusercontent.com/assets/5106466/21625152/914fb16c-d20a-11e6-8e97-d6aace11b37e.png">

**Test plan**
jest
  See https://github.com/facebook/jest/issues/2461  This seems like a problem with a transitive dependency, not something we can do anything about. If you upgrade to npm3/4 this should go away.  Killing the main process while the tests are still running causes this error in the workers

```
(node:56445) UnhandledPromiseRejectionWarning: Unhandled promise rejection (rejection id: 1): Error: channel closed
```

**Before**

![interruption-before](https://cloud.githubusercontent.com/assets/574806/21596604/cb80a87c-d102-11e6-8e94-7858481db09e.gif)

**After**

![interruption-after](https://cloud.githubusercontent.com/assets/574806/21596603/cb7a3e24-d102-11e6-814c-99b2c79388d8.gif)

* @cpojer Does this look like enough to fix #2385?
* Is there a more appropriate way of fixing this?

**Test plan**

I'm not sure what is the best way to add tests to this type of issues. Meh, It's a shame we don't have cancellable promises üò¢  oh sweet. I think this seems pretty appropriate imho. If the parent is dead, the children shouldn't attempt send anything back.  Have you tried [`modulePaths`](http://facebook.github.io/jest/docs/configuration.html#modulepaths-array-string)?  **Do you want to request a *feature* or report a *bug*?**
Enhancement request (so feature, I guess?)

**What is the current behavior?**
Given a test like this:
```js
const Immutable = require('immutable');
it('compares Immutable-js collections', () => {
  expect(Immutable.OrderedSet(['foo'])).toEqual(['foo']);
});
```

The failure message is a bit confusing:
```
 FAIL  html/js/ads/utils/__tests__/SomeTest-test.js
  √¢‚Äî compares Immutable-js collections

    expect(received).toEqual(expected)

    Expected value to equal:
      ["foo"]
    Received:
      ["foo"]

    Difference:

    Comparing two different types of values:
      Expected: array
      Received: object

      at Object.<anonymous> (html/js/ads/utils/__tests__/SomeTest-test.js:38:50)
      at process._tickCallback (internal/process/next_tick.js:103:7)
```

**What is the expected behavior?**
Maybe something like this:
```
    Comparing two different types of values:
      Expected: array
      Received: Immutable.OrderedSet
```

Or this:
```
    Expected value to equal:
      ["foo"]
    Received:
      Immutable.OrderedSet("foo")
```

**Please provide your exact Jest configuration and mention your Jest, node, yarn/npm version and operating system.**
Whichever version of Jest we use internally at Facebook.  We could definitely create a `pretty-format` plugin for that @ttmarek great! Of course you can take it. 

For the Jest part you can start with looking at how to write a plugin for [pretty-format](https://github.com/facebook/jest/tree/master/packages/pretty-format) package and how to detect that the value passed to it is coming from Immutable library. 
Then you'll need to update prettyFormat calls with `plugins` option in Jest codebase. This will be in the next version of Jest thanks to @cpenarrieta.  You're probably using Node 4. On Node 6 & 7 Babel supports better errors for this kind of issues:
```shell
import Drawer from './Components/vendor/react-native-drawer';
^^^^^^
SyntaxError: Unexpected token import
```

Not sure how we can fix this.
cc: @cpojer  It seems that Jest is not transforming `native-base`. The React Native tutorial in the Jest website has a section about [transformIgnorePatterns customization](https://facebook.github.io/jest/docs/tutorial-react-native.html#transformignorepatterns-customization), which might be helpful

> By default the jest-react-native preset only processes the project's own source files and react-native. Thank you @rogeliog!  Ask the question on react native repo ;)  Sure, react native maintains its preset, which you're probably using.   Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!

**If you are contributing on behalf of someone else (eg your employer)**: the individual CLA is not sufficient - use https://developers.facebook.com/opensource/cla?type=company instead. Contact cla@fb.com if you have any questions. Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks! wow, thanks for this fix! This use-case wasn't considered when we added this feature. Really awesome that you decided to send a PR with a fix instead of opening an issue :)  Currently there's no way to do it. #2460 is related, but there's no guaranty it will be implemented. Although we could add a `"jsdomConfig": {}` option in configuration, which would allow to do just that. Feel welcome to send a PR on this if you like :).

Related files I can think of: 
* https://github.com/facebook/jest/blob/master/packages/jest-environment-jsdom/src/index.js#L29
* whole https://github.com/facebook/jest/blob/master/packages/jest-config

Closing for now. I think it makes more sense to expose `global.jsdom = jsdom` or something like it. Also, `require('jsdom')` may just work, no? I'd prefer not to add a config option like this, I think adding `testURL` was a bad design decision on my part early on.  This looks good. Thanks @MicheleBertoli.

Instead of exporting it on `HasteMap`, can we make it a separate module called `getMockName`? That makes it testable and it will still be kind of "hidden" from the exported API. 

<table>
  <thead>
    <tr>
      <th width="50"></th>
      <th width="100%" data-danger-table="true">Fails</th>
    </tr>
  </thead>
  <tbody><tr>
      <td>:no_entry_sign:</td>
      <td>New JS files do not have the Facebook copyright header: <a href='https://github.com/MicheleBertoli/jest/blob/manual-mocks-nested-folders/packages/jest-runtime/src/__tests__/test_root/__mocks__/nested1/nested2/nested3.js'>packages/jest-runtime/src/__tests__/test_root/__mocks__/nested1/nested2/nested3.js</a> and <a href='https://github.com/MicheleBertoli/jest/blob/manual-mocks-nested-folders/packages/jest-runtime/src/__tests__/test_root/nested1/nested2/nested3.js'>packages/jest-runtime/src/__tests__/test_root/nested1/nested2/nested3.js</a></td>
    </tr>
  </tbody>
</table>


<table>
  <thead>
    <tr>
      <th width="50"></th>
      <th width="100%" data-danger-table="true">Warnings</th>
    </tr>
  </thead>
  <tbody><tr>
      <td>:warning:</td>
      <td>Please ensure that <code>@flow</code> is enabled on: <a href='https://github.com/MicheleBertoli/jest/blob/manual-mocks-nested-folders/packages/jest-haste-map/src/__tests__/getMockName-test.js'>packages/jest-haste-map/src/__tests__/getMockName-test.js</a> and <a href='https://github.com/MicheleBertoli/jest/blob/manual-mocks-nested-folders/packages/jest-runtime/src/__tests__/test_root/nested1/nested2/nested3.js'>packages/jest-runtime/src/__tests__/test_root/nested1/nested2/nested3.js</a></td>
    </tr>
  </tbody>
</table>



<p align="right">
  Generated by :no_entry_sign: <a href="http://github.com/danger/danger-js/">dangerJS</a>
</p>
 Alright, would you mind adding the copyright header to all files and @flow to all non-test files? Ignore the ones in `test_root`. We will make danger ignore those. This is great. We'll deprecate mocksPattern with Jest 19. #2600  There were many issues with snapshot test escaping:
 - When escaping backtick, it didn't escape backslash
 - Double quote escaping was overzealous and also escaped single quotes
 - JSX text didn't use HTML escaping
 - Regex escaping didn't escape all the control characters that should be

Because of the first one, you couldn't do eval(snapshot) and get the correct value, in order to make it kind of work, an unescape function was created that did ... something. Now that escaping is done properly we don't need it anymore.

This is a breaking change as all the double quotes now need to be escaped which triggers a ton of failures.

Fixes #1789 I actually tried making the quotes be backticks but then it looks really weird.

```
<div className=`my-class` />
```
or

```
{key: `some string`}
```

But, now that you mention it, I'm not really sure why everything is wrapped in a backtick string. If the value is a string, we could just write that string instead of writing a string that contains a string and pay the cost of escaping twice. Right now, `.toMatchSnapshot('this " is a quote ')` generates

```js
exports['key'] = `
"this \" is a quote"
`;
```

What I'm suggesting is to instead output

```js
exports['key'] = 
`this " is a quote`;
```
 How is that going to work for snapshots dealing with objects or arrays that have strings in them?
  Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!

**If you are contributing on behalf of someone else (eg your employer)**: the individual CLA is not sufficient - use https://developers.facebook.com/opensource/cla?type=company instead. Contact cla@fb.com if you have any questions. Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks! thanks!  This is not a help forum! Please ask questions on Stackoverflow. Thank you.  The description should be in `title`, not in `summary`. I'm unsure what the summary field from Jasmine is supposed to be.  Is this the same problem? https://github.com/facebook/jest/issues/1789 Yes it is. Unfortunately it seems like we need to define better escaping rules. Now that pretty-format is merged into Jest, we can potentially make this happen if somebody wants to work on it.  ```
[TestCase1, TestCase2].forEach(case => test(case.name, case.fn))
```

I don't think it is necessary to add an API for this specifically. You can build it yourself based on the above construct.  **Summary**

- [x] Provide a basic proof of concept
- [x] Extract asymmetric-matchers: `any`, `anything`, `arrayContaining`, `objectContaining`, `stringMatching` from `jasmine-utils` into separate module
- [x] Rename `<jasmine.asymmetricMatcherName>` to just `<asymmetricMatcherName>`
- [x] Refactor `asymmetric-matchers`
- [x] Improve Flow coverage
- [x] Create `AsymmetricMatchers` plugin for `pretty-format`
- [x] Use the plugin instead of basic proof of concept
- [x] Tests

Fixes https://github.com/facebook/jest/issues/2397
 Added tests for asymmetric-matchers, as they are our responsibility now. 


<table>
  <thead>
    <tr>
      <th width="50"></th>
      <th width="100%" data-danger-table="true">Warnings</th>
    </tr>
  </thead>
  <tbody><tr>
      <td>:warning:</td>
      <td>Please ensure that <code>@flow</code> is enabled on: <a href='https://github.com/thymikee/jest/blob/fix/asymmetric-matchers/packages/jest-matchers/src/__tests__/asymmetric-matchers-test.js'>packages/jest-matchers/src/__tests__/asymmetric-matchers-test.js</a> and <a href='https://github.com/thymikee/jest/blob/fix/asymmetric-matchers/packages/pretty-format/src/__tests__/AsymmetricMatcher-test.js'>packages/pretty-format/src/__tests__/AsymmetricMatcher-test.js</a></td>
    </tr>
  </tbody>
</table>



<p align="right">
  Generated by :no_entry_sign: <a href="http://github.com/danger/danger-js/">dangerJS</a>
</p>
 Here's a preview of how it looks.

<img width="283" alt="screen shot 2017-01-12 at 12 49 00" src="https://cloud.githubusercontent.com/assets/5106466/21888670/9338f3e6-d8c5-11e6-98ae-470b024ddf56.png">
<img width="397" alt="screen shot 2017-01-12 at 12 49 11" src="https://cloud.githubusercontent.com/assets/5106466/21888671/93396b82-d8c5-11e6-99ec-35da96d09937.png">
 I'm a bit unsure about the printing here. Could we simplify it and get rid of what Jasmine does? How about:

```
ArrayContaining [

]
```

```
ObjectContaining {

}
```

and similar. What do you think? Overall this looks really great! yes!!!!! ‚ù§Ô∏è 
This should also look good on diffs I'll iterate over the PR sometime today Alright, I think if we can improve how we print this, this is ready to go. Rendering of ArrayContaining, ObjectContaining and StringMatching is now moved to `pretty-format` plugin, without "regexping" anything. Stellar work! Thanks for sticking with me through the iterations.  I think I'd be supportive of such a change. This would be for dependencies in node_modules specifically, right? Closing this in favor of the PR (I'll get to it next week).  copypasta, thanks!  Looks like this is the only place, where `any` is used for `argv`, anywhere else is `Object` as you say, so you should be good with that!
You can also use `Path` instead of `string`: 
```js
import type {Path} from 'types/Config';
``` Actually, we could add the same typings for sibling `loadFromPackage` function. Would you mind adding that?  Thank you, nice catch! 
@cpojer do you think we we need a test for that, or maybe it will be sufficient to add typings to `loadFromFile` and make second argument mandatory?  Let's move the discussion to related PR   @jlongster thanks for adding this issue. Something similar was already discussed here: #2292 and there's also a temporary solution: https://github.com/facebook/jest/issues/2292#issuecomment-266610605 while we don't have `--simple-output` or `--no-interactive` or `--no-status` As a workaround you can redirect stderr (which holds results) to stdout
```shell
CI=true npm test 2>&1 | grep fail -i
```

But having --no-status, or --no-interactive would still be great to have  Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!

**If you are contributing on behalf of someone else (eg your employer)**: the individual CLA is not sufficient - use https://developers.facebook.com/opensource/cla?type=company instead. Contact cla@fb.com if you have any questions. Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks! Hey! We are rewriting the documentation for Jest on the new-docs branch. Would you mind sending the same PR agains that branch? :) thank you!  Context was controversial when it was added in #1632. We are currently rewriting the documentation of Jest and were analyzing the globals we add and realized context was almost entirely unused so we decided to remove this alias again. If you'd like to bring it back, you can do `global.context = describe` in a `setupTestFrameworkScriptFile` setting.

As to why this happened in a minor, here is what happened:
* We made a ton of changes on master.
* Right before Christmas, node 7.3 came out which has some buggy behavior which broke a ton of timer and console related things in Jest.
* I was happily on a vacation and noticed that everything now sucks for our users so I decided to spend some time fixing it.
* I tagged 18.1 because I didn't think the current amount of changes warranted a major release.
* I did not tag 18.0.1 from an 18.x branch because this project doesn't have the resources to support branches like that. If you'd like to help out with release management on Jest, please let me know ‚Äì I'd love to have your support! Thanks for your response. ‚ù§Ô∏è  <!-- Thanks for submitting a pull request! Please provide enough information so that others can review your pull request. The two fields below are mandatory. -->

**Summary**
Fake timers are implemented as mocks. When defined in `package.json` with `"timers": "fake"` they set up mocking functions and work properly. However when combined with `"resetMocks": true` they're not restored and completely gone. 

This is just a naive fix to the problem, but we can think of a better solution where we're actually in control of _resetting_ mocks instead of wiping them out. Not sure how to approach it though.

PR includes integration test with these conflicting options.

Fixes #2455. 

**Test plan**
Integration test
 @thymikee what's the status of this PR? It's finished, and should fix the problem with timers along with `"reset": true` config. 

For this:
> This is just a naive fix to the problem, but we can think of a better solution where we're actually in control of resetting mocks instead of wiping them out. Not sure how to approach it though.

we now have `clearMocks` back. 
<!--
  2 failure:  New JS files do n..., Please ensure tha...
  1 warning:  Please ensure tha...
  
  
-->

<table>
  <thead>
    <tr>
      <th width="50"></th>
      <th width="100%" data-danger-table="true">Fails</th>
    </tr>
  </thead>
  <tbody><tr>
      <td>:no_entry_sign:</td>
      <td>New JS files do not have the Facebook copyright header: <a href='https://github.com/thymikee/jest/blob/timers-with-resetMocks/integration_tests/timer-resetMocks/with_resetMocks/timer_with_mock.test.js'>integration_tests/timer-resetMocks/with_resetMocks/timer_with_mock.test.js</a></td>
    </tr>
  
<tr>
      <td>:no_entry_sign:</td>
      <td>Please ensure that <code>'use strict'</code> is enabled on: <a href='https://github.com/thymikee/jest/blob/timers-with-resetMocks/integration_tests/timer-resetMocks/with_resetMocks/timer_with_mock.test.js'>integration_tests/timer-resetMocks/with_resetMocks/timer_with_mock.test.js</a></td>
    </tr>
  </tbody>
</table>


<table>
  <thead>
    <tr>
      <th width="50"></th>
      <th width="100%" data-danger-table="true">Warnings</th>
    </tr>
  </thead>
  <tbody><tr>
      <td>:warning:</td>
      <td>Please ensure that <code>@flow</code> is enabled on: <a href='https://github.com/thymikee/jest/blob/timers-with-resetMocks/integration_tests/timer-resetMocks/with_resetMocks/index.js'>integration_tests/timer-resetMocks/with_resetMocks/index.js</a> and <a href='https://github.com/thymikee/jest/blob/timers-with-resetMocks/integration_tests/timer-resetMocks/with_resetMocks/timer_with_mock.test.js'>integration_tests/timer-resetMocks/with_resetMocks/timer_with_mock.test.js</a></td>
    </tr>
  </tbody>
</table>



<p align="right">
  Generated by :no_entry_sign: <a href="http://github.com/danger/danger-js/">dangerJS</a>
</p>
  Expose the `collectCoverageOnlyFrom` option on the cli
==

The option was already available through configuration,
I've exposed it and add an integration test for testing it.

The option accept an array, so it can be called in multiple ways:
`jest <...> --coverage --collectCoverageOnlyFrom fileA.js fileB.js -- <testPattern>`
if we don't like using the `--` delimeter it's possible to use the coverage flag _after_ collectCoverageOnlyFrom:
`jest <...> --collectCoverageOnlyFrom fileA.js fileB.js --coverage <testPattern>`

**Test plan**
I've add an integration test.
`yarn test`

<!-- Demonstrate the code is solid. Example: The exact commands you ran and their output, screenshots / videos if the pull request changes UI. -->
 I didn't know that arrays could be specified like this. That's nice! One thing to notice is that we had problems with arc when many (1000+) files got changed where it would bail out because it can't pass the arguments to the command via bash and this effectively doubles the number of bytes we are sending to arc when using this feature. We should probably add a filter for this in our phabricator integration: If N files change, just run all the tests and collect coverage for everything.

@hramos for documentation support: Can you add this to the new-docs branch? Also afaik is possible to pass an array by repeating the `--collectCoverageOnlyFrom` multiple times, some tools that generates it programmatically might prefer that way, honestly I don't like it too much.

For the `__proto__`, that's the official ES2015 way to specify it. 
I'll use Object.create for consistency then. Before merging this, here is a question: This will undoubtedly be used together with `--findRelatedTests`, right? We already list all the files we care about when this flag is turned on, can we instead add a flag that works together with `--findRelatedTests` so we don't have to pass all the options twice? What do you think about that as an alternative? This might be used with findRelated (for phabricator it will for sure) but it might not, someone might want to run jest on all tests but only gather specific coverage, or use the flag to override the default configuration. 
I think for consistency we should keep this working as it works like now when in the configuration file.
I don't like too much the idea of adding an additional flag for coverage as we already have too many and it start being confusing. @kentaromiura can you switch the PR to the `new-docs` branch? I can do it here on GitHub but that may throw off your local changes.  Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!

**If you are contributing on behalf of someone else (eg your employer)**: the individual CLA is not sufficient - use https://developers.facebook.com/opensource/cla?type=company instead. Contact cla@fb.com if you have any questions. Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks! thank you!  **Summary**
Alternative fix for #2457.

**Test plan**
jest passes on node 7.3 again.  Let's wait for @cpojer or @dmitriiabramov to leave a comment on the topic. yeah this looks like a bug and it would be good to create a failing test for it. Yes please! :smile: There's a CONTRIBUTING.md file in the repo, which should point you in the right direction. For the repository and check it out   Is this a request for `pretty-format` package or Jest diffs? Feel free to send a pull request. We aren't taking feature requests for pretty-format like this. You can use `min: true` option to display Array in a single line
```js
const minArray = prettyFormat(array, {min: true});
``` Why not check the type of the object?
E.g.:
```js
options.min = Array.isArray(array) ? true : false;
prettyFormat(array, options);
``` I don't think we'll add this complexity to pretty-format. You should be able to use the plugin architecture to extend pretty-format and print things to your liking. If that doesn't work for arrays for some reason, please feel free to send us a pull request to fix it.  Use `jest.mock('path/to/file', () => { ‚Ä¶ }, {virtual: true})` to create virtual mocks.  This is a question/discussion topic.

While discussing this issue #2453 and earlier conversation here #890 I came to conclusion that it may be worth exposing `jsdom` somehow to the environment. What do you think?

@cpojer @dmitriiabramov  `window.location` can be changed using `Object.defineProperty(window, 'location', {value: '‚Ä¶'})`. There is no need to expose jsdom for this.  Since RN v0.38 you should no longer use `jest-react-native`, see the docs: http://facebook.github.io/jest/docs/tutorial-react-native.html

If it's related to RN, please file this issue there, as Jest is now a part of React Native.
Closing. Looks like @fasibio found a workaround to this https://github.com/facebook/react-native/issues/11659#issuecomment-270633877  It's failing, because this call:
```js
import {BaseClass} from "BaseClass";
```
will look for global node nodule named BaseClass. What you probably want to do is loading the module from corresponding file:
```js
import {BaseClass} from "./baseClass";
``` Happens :). Have a great time using Jest!   I think I'd prefer moving this out of jest-cli into the appropriate packages so that the creator function is a stateless module rather than something we pass around.

Just updated to node 7.3 and it seems indeed that logging is broken in that version using jsdom. Ugh, that's annoying. Maybe it is a regression in node that needs to be fixed? @italoacasas thanks. I created an issue here: https://github.com/nodejs/node/issues/10492 but I'm on vacation right now and don't have time to create a more succinct and detailed repro. :( I put up an alternative fix that's a bit simpler based on @dairyisscary's comments. It simply uses a non-strict module to set the console. This is a bit hacky and I expect this to break again in the future but it seems to me like this is a node/vm or jsdom issue as console should definitely be assignable or at least writable through `Object.defineProperty`, no? I realized this doesn't just expand to `console` but also applies to `setTimeout`, `setImmediate` and all other timer globals. I applied the same hacky fix for now to make sure Jest works again and will publish 18.1 shortly. @dairyisscary thank you so much for this PR and figuring out all these issues. I went ahead merging my own PR, which also fixes this issue for timers in node 7.3 and is a bit more minimal. Publishing 18.1 now but I'm hoping that this can be fixed in node or jsdom properly soon.  Hey @benweissmann thanks for catching this! 
I've just opened a PR with a fix proposition, we'll see how it goes ;)  I'm not sure if we can do anything about that. @cpojer what do you think? Yes, Jest uses `jsdom` and what I'm quite sure, this is not a bug in Jest ‚Äì this can be a lack of feature/API flexibility though. 
Although it may be a bug in `jsdom` lib, so please file an issue there and we'll see how it goes. Closing this for now. But happy to discuss it of course! Glad you worked this out!
Currently we're not exposing `jsdom` to environment, so you don't have access to it. Happy to review the PR if you're willing to work on this, as long as it doesn't introduce breaking changes :).
I'll create a new issue just for that.  @afaayerhan this regex is correct and can be copy-pasted into your config. 
Although the whole expression is wrapped in extra parentheses, which may cause confusion if copied "too fast". 

@hramos @lacker what do you think, should we remove those extra parens: `(default: ...)` in new docs, to avoid ambiguousness? I'd personally go for that. This seems annoying. I'll figure out a different way of showing defaults here. These are RegExp `matching groups`, here's a version with added newlines:
```
(
  /__tests__/.* | 
  (\\.|/)
  (test|spec) 
)
\\.jsx?$
```  Thanks for reporting this, but that's a duplicate of #2166 and happens on Node 6 too (but not so often I guess, based on the number of issues relating this with v7). Feel free to discuss it in the relevant thread. Help is greatly appreciated! üòÉ  Got a fix for this: https://github.com/facebook/jest/pull/2464 will publish 18.1 @thymikee these are actually separate issues! Yeah, sorry for missing this :/  I moved it to a more appropriate place in 29285ad59fe29007e456bd236e81040e2f771d8c.  Just curious ‚Äì have you tried linking with npm instead of yarn?  Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!

**If you are contributing on behalf of someone else (eg your employer)**: the individual CLA is not sufficient - use https://developers.facebook.com/opensource/cla?type=company instead. Contact cla@fb.com if you have any questions. Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks! seems like one of the snapshot tests needs to be updated, can you run with `-u`? :) nevermind, seems to be an issue on master.  @stephencookdev are you still planning to work on this feature?
I wonder if we could add https://github.com/facebook/jest/issues/1206 in a followup PR Awesome! Thank you  Currently I'm undecided. I'm not against it but I don't see the clear value proposition yet. There is also a larger issue about a multi-config runner #2970 which may have implications. `--config` already supports being passed JSON, fyi. @bookman25 yea, that's a good point as well; similar to how the multi-config runner may have implications on the design of the `.jestrc` system. I prefer to hold off on merging a solution too early if we are unsure about how it will work long term, that's the reason this PR hasn't been merged yet. I hope you all understand. This will be in Jest 20, soon. This is just a default and it is optional, you can always specify `--config=<path>`. In fact, that's what we do at Facebook.  Would you also like that to be actually tweeted?  I've tried this boilerplate: https://github.com/cloud-walker/frontend-boilerplate, changed `System.import() -> import()` and it doesn't work for me in any of the cases. Webpack bundle is still working though. 

Looks like `babel-plugin-dynamic-import-node` helps to resolve that. Managed to get it working by adding the following to babel config:
```json
  "env": {
    "test": {
      "plugins": [
        "babel-plugin-dynamic-import-node"
      ]
    }
  }
```

Make sure you run jest with `--no-cache` flag every time you make a change to babel config (http://facebook.github.io/jest/docs/troubleshooting.html#caching-issues).  Thanks for reporting this, but that's a duplicate of #2166 and happens on Node 6 too.  @thisissami it seems like your test or code isn't running then. Jest's test suite passes on node 4 and node 6 which makes sure console printing works fine and we are working on a fix for 7.3. If it was working earlier today for you and isn't any more, you must have made an update or broken something yourself. We didn't publish a Jest release in two weeks. It seems like you updated to node 7.3. We have some fixes up for that. Please note this issue tracker is not a help forum; use stackoverflow for questions :) The test suite of Jest tests this behavior on node 4, node 6 and node 7.3. It works for 4 and 6 but was broken in 7.3. I'm fixing this for node 7.3 and will publish a new release of Jest shortly: https://github.com/facebook/jest/pull/2464

If Jest's own test suite using node 4 fails for you, then something is likely wrong with your setup. These just indicate you don't have mercurial (hg) installed, unrelated to your issue. It seems like the test suite passes for you and as said; we explicitly test for the logging behavior in the test suite so it must be something going wrong with your code or setup. @davidgilbertson does it happen on v18.1? That's quite aggressive @halis. We are doing this because Jest parallelizes tests and many tests may log to the terminal at the same time, meaning that Jest's output becomes useless. We actually used to do that. If you are using `--verbose`, we don't actually buffer anything and write straight to the console.

If that doesn't work for you, maybe you can help us by sending a PR to Jest and improving this behavior. That's great. Don't let JavaScript tools ruin your Fridays üòÄ @richburdon for async tests using `done` callback you need to cover failing case with `done.fail()` ```js
test('async', (done) => {
  setTimeout((() => {
    expect(1).toEqual(2);
    try {
      throw new Error();
    } catch (error) {
      done.fail(error);
    }
    done();
  }), 1000);
});
```
I get that this is not ideal, but this is how it currently works. It's worth to note, that it's not a problem, when tested function [returns a Promise](http://facebook.github.io/jest/docs/en/tutorial-async.html). There are couple of issues affected by this behavior, such as https://github.com/facebook/jest/issues/2136 or https://github.com/facebook/jest/issues/2059. If you have an idea on how to improve it, we'd love to review a PR and make it happen. 

But this is not a relevant issue to discuss it, you can post your ideas elsewhere.  Upgrade to the latest version of nodejs, please. It's a known issue in node ~7.3.  In the new-docs branch there is an entire guide about snapshot testing and at the bottom we added a few practical links. Would you mind sending a PR against that branch and adding the video there? :)  This should already be fixed in the new-docs branch where we are auto-generating this :) Thanks!  We are rewriting the website docs on the new-docs branch. If you feel like this is still applicable, would you mind sending a PR agains that branch? Thank you!  Hey @sapegin, this is already addressed here in this issue #2166.  No worries! :) Actually this was a different issue and we fixed it in 18.1.  The workaround makes sense to me. You are loading an html file, and Jest interprets it so you either need to mock the file, transform it or make sure that code is not run.

One thing you could do is use the `transform` config option and build a transformer for `*.\.html` files that returns something like `module.exports = 'something for html files';` which would also make them not throw.  We actually have thousands of logs at FB and it is terrible, silencing them doesn't really solve anything here other than giving you peace of mind. There are a few possible solutions:

* Fix the library not to warn or throw in the first place. Why is it logging something if everything is correct?
* In your test (or setupFile), set `console.log = jest.fn()` so that tests cannot print to the console. You could even add an `afterAll` hook to make the test fail if anything logged to the console.

One thing we could add to Jest is to add `--highlight=some.*pattern` which would specifically highlight certain log messages so that it is easier to find them if a lot of errors are logged, but I think that's not really solving the same issue. Happy to keep the discussion going but I think the two proposed solutions solve your issue.  hmm.. I'm worried a bit about keeping them up-to-date with the flow types but I guess we can survive. Mind adding the FB copyright header from other files?  The documentation as well as the example point out you have to call `jest.useFakeTimers()` to make it work. I think you are confused a bit ‚Äì the example and docs are correct. You can use `"timers": "fake"` in the config to make every test use fake timers by default.  yeah the input is quite "custom" so it doesn't provide all the nice features it should. I'll merge this for now. Can you rebase https://github.com/facebook/jest/pull/2362 on top of this diff? I like all your ideas, we should figure out if we can make the arrows work properly later on.  Link to the API docs.

![screen shot 2016-12-21 at 6 19 32 pm](https://cloud.githubusercontent.com/assets/165856/21413156/2434db4e-c7aa-11e6-8d8d-cde460914c89.png)

  Expand the More Resources section.
Reduce number of CTAs on the home page.
Do not use single-character aliases in examples.

Fixes #2383   This PR broke the website generation script:

```
/Users/hramos/git/react/jest/website/server/generate.js:11
  let is_executing = false;
  ^^^

SyntaxError: Block-scoped declarations (let, const, function, class) not yet supported outside strict mode
    at exports.runInThisContext (vm.js:53:16)
    at Module._compile (module.js:373:25)
    at Object.Module._extensions..js (module.js:416:10)
    at Module.load (module.js:343:32)
    at Function.Module._load (module.js:300:12)
    at Function.Module.runMain (module.js:441:10)
    at startup (node.js:139:18)
    at node.js:968:3
Error: generate failed
``` @hramos what is your node version?  i just tried on node@4 and yeah. it broke.
can we drop node@4 support for the website? Ah, I'm using Node 4 by default. We use 6 when deploying the website so this should be fine. Confirmed that this runs successfully on 6.    @jwbay thanks for helping out on Jest's issue tracker.  Change your exported mock to use `jest.fn`, like `export default jest.fn(function fetch() { ‚Ä¶ });` and then `require('isomorphic-fetch')` should just work. It will give you a mock function that can be used together with matchers like `toHaveBeenCalled` etc.  Two docs for the introduction. Testing async code just explains the basics of callbacks / promises / async/await. Setup and teardown explains the after/before stuff.  @dmitriiabramov do we have anything for this? I think this could be pretty handy if we decide to kill our internal runner. it's actually pretty easy to do with istanbul as long as you have a `.json` coverage report.
we do something similar to this here:
https://github.com/facebook/jest/blob/master/scripts/mapCoverage.js
 @dmitriiabramov shall we make mapCoverage into a `jest-map-coverage` package so that it can be re-used? @cpojer might be a good idea. Istanbul already provides everything needed for that, but it's not documented and requires some additional configuration.

were you thinking about something like this?
```js
const {mergeCoverage} = require('jest-map-coverage');

merge(
  'file1.json',
  'file2.json',
).replacePaths(path => path.toLowerCase());
```  Does it work for you through `window.Thrift` or `global.Thrift`? I may be wrong, but currently we don't have easy way to achieve loading global objects from files. One thing I can think of is to write your custom [`testEnvironment`](http://facebook.github.io/jest/docs/configuration.html#testenvironment-string).

You will find example here: https://github.com/facebook/jest/blob/master/packages/jest-environment-jsdom/src/index.js

I'd copy it and adjust this part:
```js
    this.document = require('jsdom').jsdom(/* markup */undefined, {
      url: config.testURL,
    });
```

to be:
```js
    this.document = require('jsdom').jsdom(/* markup */undefined, {
      url: config.testURL,
      scripts: ['link/to/your/file.js']
    });
```
More reference here: https://github.com/tmpvar/jsdom#easymode-jsdomenv

Then pass it to config like this:
```js
"testEnvironment": "path/to/your/environment"
```

Good luck! btw, let me know if this works. We could add this feature (just like `testURL`) and write a guid for using Jest with non-AMD and non-CommonJS dependencies. So maybe put the script tag as a markup?
```js
    this.document = require('jsdom').jsdom('<script src="link/to/file.js"></script>', {
      url: config.testURL,
    });
``` Thanks for your investigation. We'll see what can be done here, but unfortunately this is not a priority :<. I'll keep the issue open. Sure! I'll be very pleased to review it üòÉ  I'm not really interested in supporting this use case as I don't think the complexity is worth it. I recommend going with your workaround, which seems to work, or loading it in `setupFiles` using something like this:

```
const content = fs.readFileSync('Thrift.js');
eval(content + '; global.Thrift = Thrift');
```

that seems to me like a reasonable solution.  Isn't it the same? https://github.com/facebook/jest/issues/2357 Great, thank you!  <!-- Thanks for submitting a pull request! Please provide enough information so that others can review your pull request. The two fields below are mandatory. -->

**Summary**

Fixes #2412

**Test plan**

Snapshots
 Nice work! I have a couple of questions inline. Ready for another review. nice work!  There are no plans for us to do this but depending on what this will look like, we are happy to support incoming Pull Requests. Feel free to continue to use this issue to discuss a potential integration if you'd like to work on it but I'll close it for now as it's not something we'll contribute to specifically.  Heavily inspired by expect one: https://github.com/mjackson/expect/blob/master/modules/SpyUtils.js#L96-L112
 We probably need some documentation on this eh. Is this just a new method on mock functions? For context, I'm trying to get feature parity with expect.

Example use case:
```
const spy = mock.spyOn(window, 'setInterval');
window.setInterval(fn, 10);
expect(spy).toHaveBeenCalled();
spy.mockRestore();
``` Thanks @vjeux. It seems like the Jasmine version of this has ".and.callThrough()" which seems kinda odd. Can you think of a simpler API that allows to use spyOn and call the original implementation?

tbh it really is odd to me, when calling "spyOn" I'd expect the original function to be called too, that's what a "spy" is supposed to do but all testing libraries seem to have agreed on the opposite behavior. Do you think it is worth breaking behavior here, like this:

* `jest.spyOn(foo, 'fn')` will run the original function.
* `jest.mockFn(foo, 'fn')` will take the new spyOn behavior. This is really just the same as `foo.fn = jest.fn()` but it will work if the test file is using flow.  Maybe this will work.  Right now it returns a class that you've got to instantiate which is not the API we want. This PR makes it return an instance and adds the ModuleMocker class as an attribute.

Test Plan:
Make sure tests are passing

Also make sure that we can write this :)
```js
var mock = require('jest-mock');
const fn = mock.getMockFn();
```
 uhh.. soo I don't think we actually can live with this global state :( Two tests in the same process *may* run at the same time; we don't have a guarantee that they won't and I don't really wanna take this risk. :( Should I rename the existing package `jest-mock-internal` and make a `jest-mock` that just does

```js
const ModuleMocker = require('jest-mock-internal');
module.exports = new ModuleMocker(this);
```

or do you have other suggestions? yay Just updated the commit and message to add ModuleMocker to the instance  Create a standalone snapshot testing guide, based on the excellent [release blog post](https://facebook.github.io/jest/blog/2016/07/27/jest-14.html).

![screencapture-localhost-8080-jest-docs-snapshot-testing-html-1482281714980](https://cloud.githubusercontent.com/assets/165856/21373630/3cd6ddb2-c6d5-11e6-937d-829103ff3832.png)
 Can you say more explicitly what `jest -u` does? Like just that you run jest with -u and it updates all the snapshots to their current behavior. (Is that correct? Hm.)

Should this guide go after the "testing react apps" and "testing react native apps" guides? This looks just fantastic, @hramos. A separate guide for this makes it stand out so much more.

A couple of suggestions (can be done individually):

* Shall we document that snapshots can be used with any serializable value? Common examples are snapshotting CLI output (see `integration_tests/__tests__`) or API responses.
* Snapshots must not include platform specific or other non-deterministic data. We could explain that if you are trying to snapshot a component that uses `Date.now` it can be mocked by doing something like `Date.now = jest.fn(() => 13232342)`  to make the value consistent.

I also think instead of linking to the blog post only, we should maybe also link to this blog post: http://benmccormick.org/2016/09/19/testing-with-jest-snapshots-first-impressions/ ‚Äì it's really good and gives people a sense for when they should use it. Yeah, I really like the idea of documenting that this can be used with any serializable value. It's great that we have an actual example of this in action in `integration_tests`.

Separating this into its own guide allows us to be verbose. I'll add the above, as well as notes on dealing with platforms and so on, and dedicate more space to `--updateSnapshot`. Just checked: `jest -u` will update *all* _failed_ snapshots to their current behavior. So, this should only be used when we know each and every failed snapshot test is due to an intentional change.  Updated with feedback. I feel like the "additional uses" section can be expanded further in a subsequent PR - I simply linked to the actual integration test that demonstrates capturing the CLI's output - but I want to move on to updating other docs before coming back to this. Going to merge this in to start tidying everything up. If there's any additional feedback let me know and I can address in a new PR.  This is not Jest, this is your code or some of your dependencies attaching the same listener to `process` over and over again.  Use `moduleNameMapper`.  Our docs use both terms, ES2015 and ES6. While ES2015 is technically correct, ES6 has emerged as the more popular term. To avoid confusing people, let's always use ES6 unless when referring to a particular thing (e.g. `babel-preset-es2015`). Hmm, I disagree with this. I'd prefer to use the technical term "ES2015". I'm also happy if it is called "ES2015 (previously ES6)" in the beginning.

How about we simply call it by feature-name, given that many features are still receiving new features?

Example: "ES classes" instead of "ES2015 classes" unless we are actually talking about the specific feature. Hmm, `es6` is by far more commonly used than `es2015`. See [es6 vs es2015](https://www.google.com/trends/explore?q=es6,es2015) (es6 is blue):

![screen shot 2016-12-20 at 3 50 36 pm](https://cloud.githubusercontent.com/assets/165856/21372491/3e514082-c6cc-11e6-8c59-5fcc3589b33f.png) @hramos you are right but should we go for popularity or for the correct technical terms? I'll leave it up to you, because I don't feel strongly. I'm simply pointing out that the official names are ES3, ES5, ES2015, ES2016 and ES2017 so I'd prefer to use that rather than colloquial names. I feel strongly about sticking to one term, and I'm fine with using ES2015. One last argument pro-ES6, if I may: it's what we ended up using in both the React and React Native docs refresh, and using ES6 here as well would ensure we're being consistent across doc sites. consistency wins, let's go with ES6 then, if that's what we do on our other major open source projects :) I'd argue that that may create confusion because we include the es2015 preset, not the ES6 preset.
I guess ES6 is more dominant in the web since the name was decided at the very end at the standardization process so all discussion and blog posts were talking about ES6 at that time.
Let you guys decide but, as you probably can see from my comment, I' m against using ES6. #bikeshed  Another data point: our [own docs](https://facebook.github.io/jest/docs/tutorial-webpack.html#content) recommend using a [ES2015 Proxy](https://github.com/keyanzhang/identity-obj-proxy) but `identity-obj-proxy` refers to it as a ES6 proxy.

We know in this thread that the term can be interchangeable, but in the interest of making the docs more accessible to more users we should opt for the popular term. @pedrottimark <3  Did they fail because of the react or because of the Jest update? Have you tried using `babel-jest` v18? Are you sure your tests works on Jest 17?
I've just checkout your branch, check Jest 18 and 17 and both throw the same error. Nope, no changes besides Jest. I think RN repo will be a better place to tackle this. Thanks!  Based on this [test](https://github.com/facebook/jest/blob/ec782b567bf343d9d278cd79265a1af2bfc3e83c/integration_tests/__tests__/regex-\(char-in-path-test.js) it's a known limitation.

@cpojer do we have plans on fixing Windows issues like this? yeah this should be made to work on windows. The integration tests are disabled on windows mostly because nobody had time to go through and fix/enable the tests. cc @Daniel15 do you have any time to help?  * Updated team name.
* Made the troubleshooting item shorter to fit on one line on a small screen, to align better with the other items in the same section.

<img width="1148" alt="screen shot 2016-12-20 at 4 29 43 pm" src="https://cloud.githubusercontent.com/assets/13352/21358741/904df6b4-c6d1-11e6-93e5-a1affaf2ba71.png">
  <!-- Thanks for submitting a pull request! Please provide enough information so that others can review your pull request. The two fields below are mandatory. -->

**Summary**

Fixes #2277
Generates both rss and atom in the step in the convert step

**Test plan**

running `yarn start`
<img width="575" alt="screen shot 2016-12-20 at 11 24 57 am" src="https://cloud.githubusercontent.com/assets/87300/21347024/38955f90-c6a7-11e6-86b1-e391f9966f53.png">
<img width="583" alt="screen shot 2016-12-20 at 11 25 23 am" src="https://cloud.githubusercontent.com/assets/87300/21347025/3899b3c4-c6a7-11e6-9e2e-a8db1070f16d.png">
<img width="825" alt="screen shot 2016-12-20 at 11 26 35 am" src="https://cloud.githubusercontent.com/assets/87300/21347026/389a0680-c6a7-11e6-8b39-3f21b86cc795.png">
  hell yeah! Nice work, thanks @bookman25   @cpojer are we good with `yarn.lock` in examples? I think this is great @ericvicenti! I'm a bit worried the whole setup process takes away from learning how to test async/await and promise based code. Can we potentially move the setup with compilation to ES5 to the bottom and add a link on top that sends people to the bottom of the page in case they don't know how to use async/await? I think that's sensible.

Also, let's remove the yarn.lock file. I actually want the latest versions installed for examples, not whatever is in yarn lock ‚Äì we run these examples on CI and if they turn red, we want to know about it and potentially hotfix Jest to work better with those tools. Yeah, I get that this is confusing, which is why it would be great to push it out from our tutorial and focus on what matters for Jest: how do you write an effective async test. I would honestly even prefer it if we could push the setup part out of the Jest website and say "This is the guide for using async/await. If you don't know what that is or want to set up async/await, click here, otherwise just continue reading this guide."

btw. one thing that also makes sense here is to recommend using `expect.assertions(number)` at the beginning of the test. This will check at the end whether the predefined number of assertions was actually made, which is really useful to ensure everything runs, especially when errors are thrown in a promise etc. (might be silent). `expect.assertions(number)` eh - that seems totally undocumented right now ;-) @lacker sorry, it just came out with Jest 18 :) Could you use `test` instead of `it` in this doc so that we are standardized? FWIW I think this doc is turning into more of a "guide". Because this is really for people who are using async/await, rather than basic stuff that everyone needs to know. We could do it in a later PR but I theorize we should stick this in guides. OK - we chatted in person and it sounds like "Guides" is the right place. Maybe we could rename it to be a bit more precise, call it something like "An Async Example" ? Can you change the base branch to new-docs prior to merging this in when it's ready? I know I can do this via the GitHub interface but I don't want to change this while you're still working on the branch locally. ping!  The word "support" may imply short turnaround time for answers to any questions, when in reality this is a community supported project. This change does not change the kind of support the project is provided but does try to better set expectations.

This will require a redirect prior to merging with master.

Fixes #2271.

![screencapture-localhost-8080-jest-help-html-1482191853481](https://cloud.githubusercontent.com/assets/165856/21333333/e6c59200-c603-11e6-992a-230072ee218e.png)
 wow this is great.  Fixes #2269. WIP.

- [x] Add missing logos.
- [x] Add introductory paragraph.
- [x] Link from homepage and nav bar. nice! two teams at MS also use it, but I don't know if it makes sense to include them. This is now ready for review. A small showcase is visible at the bottom of the homepage, and the full showcase is now linked to from the navbar.

Homepage:
![screencapture-localhost-8080-jest-1483737489682](https://cloud.githubusercontent.com/assets/165856/21733352/de5ab7a4-d412-11e6-826a-d0da0f36b2bd.png)

Full showcase:
![screencapture-localhost-8080-jest-users-html-1483737480000](https://cloud.githubusercontent.com/assets/165856/21733356/e1fac17e-d412-11e6-8884-172ac453127a.png)

 looks lovely. Thank you so much.  I went to fix the problems reported in the "update API reference" task and did some fixing which is included here. I alphabetized unalphabetized stuff, fixed some broken links, updating some weird sentences, added a bit of missing info. Really there are more problems with this page though - there are a lot more missing parts, and this one doc is becoming somewhat of a grab bag where people add more crap to it. Updates to APIReference LGTM. Did you mean to also include that update to the RN tutorial?  Let's tighten up the landing page at facebook.github.io/jest a bit. 

- [ ] Move "React Testing", "React Native Testing", and "API Reference" out of the red hero banner at the top. This leaves us with a single "Get Started" call-to-action.

- [ ] The "Get Started" CTA links to a section further down in the homepage. Let's add the "React Testing", "React Native Testing", and "API Reference" CTAs here.

- [ ] Update "Getting Started" introduction. Reader should be be presented the option to "Get Started with React Native Testing", or "Get Started with React Testing", etc (see previous checkbox). Or, user can proceed through "Getting Started" section using the embedded repl.it.

- [ ] Update the three featured items at the top. New ones are: "Easy and Familiar", "Performance", "Snapshot Testing". Update the accompanying text as needed.

- [ ] Replace snapshot testing section with a link to the new [Snapshot Testing guide](https://github.com/facebook/jest/issues/2282) and some introductory text.

- [ ] Replace babel section with a link to the new Babel configuration guide and some introductory text.

 @tijs checkout the `new-docs` branch. Have you tried setting [transformIgnorePatterns](http://facebook.github.io/jest/docs/tutorial-react-native.html#transformignorepatterns-customization)? 

>The transformIgnorePatterns option can be used to whitelist or blacklist files from being transformed with babel. Many react-native npm modules unfortunately don't pre-compile their source code before publishing.

>By default the jest-react-native preset only processes the project's own source files and react-native. If you have npm dependencies that have to be transformed you can customize this configuration option by whitelisting modules other than react-native: Yes, there's a note on the beginning about deprecating `jest-react-native` but it's present throughout the tutorial. @hramos we need to address that.

To ignoring: by default whole `node_modules` directory is not transformed for react-native (ignored). In the docs, there's a regular expression which tells to ignore all paths that are inside node_modules but `react-native` or `my-project` or `react-native-button`:
```
node_modules/(?!react-native|my-project|react-native-button)
``` Sadly I don't have that knowledge about `react-native`. But looking at their [package.json](https://github.com/facebook/react-native/blob/master/package.json#L41) it seems like they ignore lots of `fbjs` files, so I guess it is OK if Babel preset fixes this for you.

If you have any ideas how to improve this tutorial, feel free to send a PR against `new-docs` branch. @tijs #2272 is up for grabs if you'd like to take a stab at this.  Thanks! Basically it would be great if our guides, instead of saying "here is how you set up Jest", could tell the story of "Here is why testing is useful, why Jest is going to support you along your journey and here is how you get the most value out of it". For react-native specifically it would be great to point out that no additional setup is needed because Jest comes pre-configured with react-native, explain how to test an app, explain RN specific things like how to mock out native pieces and then possibly refer to external guides on how to test specific things like reducers.  With this change we don't store the haste map on disk before starting to run tests. This means if Jest would like to run tests in parallel, we need to persist the haste map or pass it through to the workers, otherwise new files that get added can't be run and will fail.

I spent some time running some benchmarks on passing data to and back from the worker, see https://gist.github.com/cpojer/488c85f2cf86cacc3f4cc378be3f68eb This version takes about 6s on my mbp and about 1.3s when only sending data to the worker only (like we'd do in Jest). This is still a lot of overhead. One issue with persisting the state is also that the watchman clocks aren't updated through the file watcher ‚Äì this means that storing the haste map as is will result in a recrawl of the file system on the next startup. There are a number of ways to address this:

* Ignore the overhead this incurs. Fast tests will run in the same process and slow tests (3+ seconds or so) run in parallel. The added overhead isn't that big of a deal on an already slow test run. This could be optimized by only sending the data of the module map (about half the amount of data).
* Split up the module map and haste fs data into separate cache files and only write the module map one. This should allow to properly reconcile the cached data with information from watchman on the next startup.

I'm inclined to go with the first solution and benchmarking it on our internal react-native codebase, which is relatively big, to see what the performance will look like. Either way, I need to find a way to write tests for this as it is easy to break. I'll push directly to this PR and merge it once done. @rogeliog nice work on making this all happen! Ok I tested this and it works now. @rogeliog mind checking my code before I merge this?

Here is what this solves:

* Make it so all tests are run in parallel (Set https://github.com/cpojer/jest/blob/833dc59d3b2393c368c3c503d362e42b9f77d8ba/packages/jest-cli/src/TestRunner.js#L254 to false)
* Add `require('HasteModule')` anywhere in a test.
* `jest --watch` that test. It will fail.
* Create a file with the content from below.
* When saving, the test will pass.

HasteModule.js
```
/**
 * @providesModule HasteModule
 */
module.exports = () => 'banana';
```

Without my last commit, even after creating the "HasteModule.js" file, the test would fail and be unable to locate the new haste module (haste is Facebook's module resolution system) because we don't persist the haste map to disk so when we read it in the worker thread, it is still missing. My change makes it so that in watch mode, the module map is always passed to the workers and it is only read from disk in the regular mode.

One thing I haven't had time to do is write tests. It would be good to create some tests with some of the env mocked, like a `worker-farm` mock (similar to the tests in jest-haste-map) and a test that ensures that when TestWatcher's state is set to watch mode, it passes the raw module map and otherwise it doesn't. @rogeliog is this something you could help out with to get this PR over the finish line? @cpojer Code looks good, I've been working on adding the tests that you mentioned and doing some good progress there...  @cpojer is this an issue with automatic Lerna publish? Can you send a PR to jest updating the README for pretty-format in `packages/pretty-format`? ugh. I noticed this a lot previously with npm packages. Why is this happening? Closing this to manage the queue, but happy to discuss why npm is doing that  ¬Ø\_(„ÉÑ)_/¬Ø  There is some issue with eslint on travis, I'll figure it out. @pugnascotia thanks for working on this, it'll take me a bit longer to get to this PR as there are currently 20+ open requests and I'm still catching up with work at FB after my vacation. Do you mind rebasing this? Are you sure you rebased against Jest's master branch? It doesn't seem like it. @pugnascotia maybe you fetched from your fork's master, happens to me sometimes üòÑ  
<!--
  0 failure: 
  1 warning:  Changes were made...
  
  
-->


<table>
  <thead>
    <tr>
      <th width="50"></th>
      <th width="100%" data-danger-table="true">Warnings</th>
    </tr>
  </thead>
  <tbody><tr>
      <td>:warning:</td>
      <td>Changes were made to package.json, but not to yarn.lock - <i>Perhaps you need to run `yarn install`?</i></td>
    </tr>
  </tbody>
</table>



<p align="right">
  Generated by :no_entry_sign: <a href="http://github.com/danger/danger-js/">dangerJS</a>
</p>
 Finally had some time to look at this. Am I understanding this correctly ‚Äì it'll support both testGlob and testRegex and have the following behaviors:

* Use both testGlob and testRegex if they are specified.
* Print a deprecation warning for testRegex.

? I feel like we shouldn't show the deprecation warning for testRegex yet. Instead, I'd recommend this:

* warn/throw if both testGlob and testRegex are given.
* don't warn about use of testRegex. We'll visibly deprecate it in two majors from now to reduce the churn.

Are there any better names than "testGlob"? Any way we can drop the "glob" from it? I don't like it, especially as we'll be ending up with a singular option in the future :) maybe `testPattern`? But this may be misleading, as we use the word `pattern` in watch mode and it's for regex. 

edit:
or `testMatch` Thank you for working on this and for being so thorough. Sorry for the delay in reviews. This will be in Jest 19.  I think this is pretty much connected: #2166  Let's move the discussion there!  Thanks for filing an issue, but this is a problem with [`ts-jest`](https://github.com/kulshekhar/ts-jest) package. I can confirm that it works for Jest 17, but doesn't on Jest 18 as in example you provided. You should probably downgrade to Jest 17 until `ts-jest@18` is released and file and issue there.  Wow, that's cool you're working on that. Just tried and looks like the warning is gone. Good luck with releasing new version! (You can submit a PR when you're done) thanks @bcoe.  Use [`"resetMocks": true`](http://facebook.github.io/jest/docs/configuration.html#resetmocks-boolean) if you'd like to reset your mocks before every test. Does it help? Feel free to submit a PR with proper changes to the documentation üòÄ. Make sure you check the `new-docs` branch and target your changes there if necessary. 
Closing. Theres also this issue https://github.com/facebook/jest/issues/2134 which discuss bringing back `clearMocks` which you might also be interested in  <!-- Thanks for submitting a pull request! Please provide enough information so that others can review your pull request. The two fields below are mandatory. -->

**Summary**
Fix the typo and add a return value to example custom `toBe` implementation.
 nice!  Since this is mostly a printing issue, shall we make it so that only if two objects don't match, the diff we generate will contain all properties, including non-enumerable ones? That way we do this work only if necessary (when a test fails). I guess it means that we need to recursively descend twice though, so it may not be that great after all.  Call `jest.unmock(‚Ä¶)`! :)  See @orta's PR who merged this change already.  <!-- Thanks for submitting a pull request! Please provide enough information so that others can review your pull request. The two fields below are mandatory. -->

**Summary**
Introduce highlighting of trailing whitespace. Kinda fixes #2287 I guess.

<img width="372" alt="screen shot 2016-12-16 at 16 38 00" src="https://cloud.githubusercontent.com/assets/5106466/21268311/7ca5237e-c3ae-11e6-806d-326353c92eea.png">

**Test plan**
jest

 We had long conversations about this with @dmitriiabramov and @gaearon and decided to invert the colors, assuming that what is stored on disk is always the source of truth. oh this is so nice!
this bug annoyed me for so long :) I don't mind changing the snapshot colors but it needs to be done consistently.
Don't forget we have these views as well:

<img width="544" alt="screen shot 2016-12-16 at 17 32 46" src="https://cloud.githubusercontent.com/assets/810438/21272114/b8d239de-c3b5-11e6-9410-d663d2c0822d.png">

<img width="352" alt="screen shot 2016-12-16 at 17 32 15" src="https://cloud.githubusercontent.com/assets/810438/21272113/b8b02a60-c3b5-11e6-89fa-8ab54e0dc7cc.png">

What colors do you propose for them? The second one also uses a diff so I would expect it to be colored the same way as snapshots. However this would make the "good" (expected) value red and the "bad" (actual) value green. Which, when also applied to the first screen, would be pretty confusing.

I agree it could be improved but I'd like to see a consistent proposal addressing all these points.
"Red is failure" is relatively easy to remember and currently works consistently.  It's very likely this is your project retaining memory and not Jest if it happens at such a low number of tests. Please update to Jest 18 which uses less memory for code coverage.

Duplicate of #2179, which also contains a lot of relevant pointers.  @bolinfest is going to love you for this. Thank you!  Yeah, we should fix this. I'd actually prefer to use `jest --version` for this and then match against the output of that. We can also just simply expose something that gives you the config object for a given root, right? Are you willing to add this? We actually need this for Nuclide too; cc @kentaromiura 

One of the problems here is that some people may actually run Jest with `--config=‚Ä¶` so I'm unsure what the best way is to detect whether we are in a Jest project or not. Do you have any suggestions for that? We cannot really make `jest config` work because right now, in the jest repo, that will run all tests matching `config`. Not sure how we'd turn Jest into a command system. Maybe `jest --show-config`? This'll be in Jest 20.  @ArtemGovorov I would encourage you to submit tests for the two PRs you submitted that make sure this behavior doesn't break in the future. I'm happy to merge this but without tests it may break anytime. I guess we could also make it _Flow_?  We use [`istanbul`](https://github.com/gotwarlost/istanbul) to generate the coverage, so maybe it's better to file an issue there? cc: @dmitriiabramov unfortunately we instrument already transpiled code, so there can be a lot of invisible things that mess up the coverage report like that. 
i really hope this https://github.com/facebook/jest/pull/2290 will solve this isuue @migueloller i have an idea of what the resulting code looks like and there's nothing we can really do now.
good thing is that it usually only messes up the top of the file (imports) and they are not that important. 
Does it provide a readable coverage report for the rest of the file for you? @migueloller  let's wait for https://github.com/facebook/jest/pull/2290 and see if it fixes it :)  Why is micromatch better than minimatch? fair enough! Thanks for the thorough implementation. @dmitriiabramov what do you think? thank you! i wanted to do this for so long! <3  Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!

**If you are contributing on behalf of someone else (eg your employer)**: the individual CLA is not sufficient - use https://developers.facebook.com/opensource/cla?type=company instead. Contact cla@fb.com if you have any questions. Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks! This is great but I honestly don't think I want to take `jsonlint` on as a dependency. It also brings in nomnom and through that underscore which we simply don't need. Can we instead vendor jsonlint without any additional stuff inside of this repo or put it on npm without any external dependencies? It seems like we only want this one file: https://github.com/zaach/jsonlint/blob/master/lib/jsonlint.js Yeah that seems great! Thank you.
 @mark0978 thanks for your contribution. It seemed like this PR was a bit of a simpler approach than yours. The reason I asked to ship jsonlint together with Jest is because I do not want to take on the dependencies of jsonlint itself (nomnom, underscore etc.). Everything we add to Jest adds more code and makes installs and load times slower so I wanna make sure for small features like this that only a few people actually see we don't regress on performance and size.  I'm sorry, I wrote this at 3am last night :( I promise it won't happen again.  Also #2336.
Christopher Podger should be more careful! üòÑ  Sorry, it was 3am when I wrote this :( @dmitriiabramov‚Äôs video sneaking into the notes was awesome though. üòõ  At least somebody read it! :) @gaearon i still don't understand how it got there haha! üòÄ  thank you! What's the most recent one? Can we update to that?  Thanks for your report! This is probably connected: #1874. I'll close this one and lets continue there.  No worries :). Hope we can isolate a case when it happens more frequently and fix it. Any help on this is greatly appreciated   You can use `-w` to create as many processes as you'd like but given that most tests are CPU bound (unless they go to the network), this may actually be harmful for performance. We don't have a way to parallelize across machines but I would absolutely support a PR for this kind of stuff as it has the potential for massive impact at FB. Do you have a plan to build this?  Currently snapshots cannot collide; however with the new named snapshot feature, they may and we have no guarantee that they won't, which might lead to confusion.

cc @ericclemmons  Actually, I didn't realize that we add the key to custom names as well. I think this makes sense and I appreciate your help in troubleshooting this so much! Thank you, I think this is fine as is. I need to reopen this. One problem here could be when disabling tests:

```
test('snapshot 1', () => {
  expect(true).toMatchSnapshot('custom-name');
});

test.only('snapshot 2', () => {
  expect(true).toMatchSnapshot('custom-name');
});
```

It seems like that would cause the first snapshot overwritten with the second and reporting one snapshot as obsolete. Seems like we need to change this to make sure names are unique when we store them and throw otherwise? yeah, that makes sense! And if it does fires twice per key it should throw in the second matcher; that way we never get two snapshots with a potential collision in the first place. @gaelduplessix thanks for editing your post to reflect what I was going to propose ;)  but now flow is unhappy! Thanks for pushing this through. I'm a bit worried still about the parsing; at FB we don't have a `.babelrc` for example. I think the way to go for this is to add a method `parse` to the transformers like `babel-jest` to allow hooking in a customized parse function. I was also wondering whether `babylon.parse` can read `.babelrc` files automatically just like babel.transform does?

cc @kentaromiura who'll likely be the one who has to figure this one out :)  Lol I literally just saw your comment on the issue and there is already a PR. Oh man. Let me see‚Ä¶ Ok, so this is really cool! You did point out the question about how expensive creating an instance of `jest-haste-map` is (through `Runtime.createHasteContext`) and this is really what this comes down to and why I recommended the refactor: In our internal codebases this takes upwards of 1-3 seconds, which is crazy long.

However, we implemented file-watching in `jest-haste-map` (using a watch argument) and we can actually change our watch mode here to use that, which will make the watch mode a ton faster for any mid to large project and will help us massively at FB.

Originally I was thinking the watch mode should be its own separate package but I don't think we need to go that far. If we split out the watch mode into a separate file within `jest-cli`, I'm fine with it too. You were able to figure out how it works really well but the current implementation is quite a mess and all the CLI code is just mixed in this one `jest.js` file. I don't have a strong opinion whether it should be its own package or not but the potential for it is that other test frameworks could potentially use the `jest-watch` package and get the same watch mode that we have, which would be pretty awesome!

So, to lay out the steps:
* Refactor this watch mode into its own file.
* Currently jest.js has its own watch feature and creates a haste context object inside of `runJest`. We need to invert this to create the haste context based on the configuration, set the watch flag to true in jest-haste-map and then use the change event to re-run Jest. This will also allow us to remove a bunch of duplicated code in jest.js.
* Once we inverted this, running tests after a file change will be instant because we won't have to wait for jest-haste-map to reconcile with the file system. Basically instead of re-creating a haste context for each run, we'll have one in memory and get an updated version of `hasteFS` and `moduleMap` and a list of changed files with every file change event.

See https://github.com/facebook/react-native/blob/master/packager/react-packager/src/node-haste/index.js#L211-L216 for how the watch feature is used in react-native's packager.

After that we can consider:
* How do we polish this typeahead? It may even make sense to get rid of the "usage" or condense the usage information, which can get pretty long and annoying.
* How do we test all of this? Currently it is all manual; in the past we were thinking we could potentially use snapshot tests for this.
* I think it would be pretty cool if we could highlight the matched parts in the test names with color, what do you think?

Again, I'd like to invite you to our discord channel ( http://facebook.github.io/jest/support.html ) and I'm also happy to have a chat over google hangouts or something to walk you through in person.

Let me know what you think about this plan! I love that you started on this and this refactor is going to make Jest a ton faster for engineers at FB :) Alright, now that watch mode was rewritten, I believe we can pretty easily make this work with a great experience!

Some thoughts:

* I'd recommend against a `testPatternTypeahead` option for now.
* Can we highlight the matched parts in the typeahead? @thymikee is an expert on pretty cli printing now. Any suggestions?
* cc @gaearon and @tomocchino who are UX experts on this. Do you have any thoughts about what this should feel like? I'm a big fan of highlighting search phrases. I believe yellow bg with dark text would be more than enough here, just like with Ctrl+F on Chrome  That may work well, yeah! The other option I can think of is dim vs reset for matches, which is more subtle. Here are some gifs of how each of the highlighting options could look :)

![typeahead-dim](https://cloud.githubusercontent.com/assets/574806/21782771/411b4d7c-d67a-11e6-92e7-4b11b0118367.gif)
![typeahead-yellow](https://cloud.githubusercontent.com/assets/574806/21782772/411e49fa-d67a-11e6-98c1-03e327b3b6fa.gif)
 I would personally prefer the less aggressive dimming.
(I got a bit confused by the Twitter poll and what everybody referred to as ‚Äúhighlighting‚Äù.)

Chrome does highlighting because you need to find these words *between other words* on the page. In this case, all results are displayed below, and you don‚Äôt really need to interact with them anyway. I‚Äôm not convinced we need to use a bright color here but YMMV. I agree with @gaearon. I think dimming is fine for this. I'm also happier with dimming/highlighting text instead of background highlight üôÇ  Alright, @rogeliog let's go with the dimming for now and see how people react to the next release. 


<table>
  <thead>
    <tr>
      <th width="50"></th>
      <th width="100%" data-danger-table="true">Warnings</th>
    </tr>
  </thead>
  <tbody><tr>
      <td>:warning:</td>
      <td>Please ensure that <code>@flow</code> is enabled on: <a href='https://github.com/rogeliog/jest/blob/typeahead/packages/jest-cli/src/__tests__/watch-pattern-mode-test.js'>packages/jest-cli/src/__tests__/watch-pattern-mode-test.js</a> and <a href='https://github.com/rogeliog/jest/blob/typeahead/packages/jest-cli/src/lib/__tests__/highlight-test.js'>packages/jest-cli/src/lib/__tests__/highlight-test.js</a></td>
    </tr>
  </tbody>
</table>



<p align="right">
  Generated by :no_entry_sign: <a href="http://github.com/danger/danger-js/">dangerJS</a>
</p>
 Alright I think this looks good. The one problem I noticed is when my terminal output pushes me down to the bottom of the screen because of some failures. Typing feels a bit odd then, not sure if we can fix that? Shall we wipe away everything on the screen when entering pattern mode?

@rogeliog was there anything else you wanted to do on this diff? @cpojer I think it is in a good shape now, apart of the issue when there is not enough room in the terminal. We probably do need to find a good solution for it before merging, because it currently breaks really badly üòû  Do you have any ideas for that one? What about clearing the terminal when entering pattern mode? @cpojer Yeah I think we are going to have to do something like that.

Here are some of my thoughts on this

### 1) Clear the terminal and only show pattern mode
 ```
pattern ‚Ä∫ 


```
I like how clean this option is but it might also be a bit confusing. We could add a `Press ESC to show usage`
 ```
‚Ä∫ Press ESC to show usage.

pattern ‚Ä∫ 


```


### 2) Clear the terminal  and show both usage and pattern mode
```
Watch Usage
 ‚Ä∫ Press a to run all tests.
 ‚Ä∫ Press o to only run tests related to changed files.
 ‚Ä∫ Press p to filter by a filename regex pattern.
 ‚Ä∫ Press q to quit watch mode.
 ‚Ä∫ Press Enter to trigger a test run.

 pattern ‚Ä∫


```
This one might end up in a more familiar experience for current Jest users.


### Some issues

#### Losing test results
One problem I see with either of this solutions is that we lose the test results
```
Test Suites: 2 passed, 2 total
Tests:       6 passed, 6 total
Snapshots:   9 passed, 9 total
Time:        0.209s, estimated 1s
Ran all test suites related to changed files.
```

#### Handle small terminals

Regardless of which one we choose we might still need to handle the case where the terminal height is less than the number of lines printed by pattern mode. Depending on which solution we choose this might not be as much of an issue.

 I think showing watch usage only when going into pattern mode might be the least complex and most sensible solution for now. Let's not worry too much about small terminals. @cpojer, @gaearon here a gif of the experience as of the latest commit in this PR

![pattern-mode-final](https://cloud.githubusercontent.com/assets/574806/21902988/a5d9987c-d8c3-11e6-96b3-29662cc46795.gif)

After we decide to merge this, there are a couple polish items that I would like to focus on to make the typeahead experience as smooth as is should be. For example: Handling screen resizes by truncateing(...) the results appropiately and investigate a way allow the use of arrows...

Also, I took some decisions on the copy for the "Pattern mode", feedback is more than welcome üòÑ  
 Let's do it. @rogeliog do you care to create a master issue (+ smaller issues referenced from it) to track further polish work? This is a really delightful experience and I'm looking forward to further improvements. So nice.  `--runInBand` works across test files and runs test files serially, not tests. We have `test.concurrent` which parallelizes promise based tests within one test file but it has a few downsides, like you cannot use `toMatchSnapshot` and a few other minor things with it that have state.  I don't think it's a bug. 
The tutorial clearly states that we don't want to go into Network in our tests, so we use mocks to make the test pass our expectations.

Also, are you sure you're going to get that 'end' event? See the Node docs: https://nodejs.org/api/http.html#http_http_get_options_callback
 I'm unsure whether this is a Jest issue tbh. We aren't doing anything to pause or close any streams so I'm unsure what's happening here.

@thymikee regardless of the recommended practice, sometimes it makes sense for tests to go to the network and a lot of people are ok with the slow test runs; we should support this even if we don't recommend it. @cpojer thanks for pointing that out!  @awel-light were you able to fix this?  Thank you very much for your investigation! It may be useful to someone in the future having similar issues. Closing then.  Thank you for bringing this up and yes, this sucks but your last sentence isn't very productive.

We don't have the time nor the resources to build a better system with versioned docs. We'll make a major release soon which will help alleviate this problem and in the future we'll add a note to new API methods indicating they aren't released. Yep! We'll do that. In the future, it probably is easier for you to send a PR that changes our docs to say something is unreleased will help the maintainers a ton, build a relationship and is probably the same amount of work as creating this issue :)  I would recommend option 2; you can specify a JSON value to the `--config` argument that you can generate from any place you like. Generally, these kind of things make static analysis harder and it's non trivial to support them ‚Äì so when you run `jest --watch`, Jest will be unable to figure out which tests it needs to run based on changed files because Jest cannot walk the dependency graph properly. Between `moduleDirectories` and `moduleNameMapper` I believe we expose a bunch of hooks to influence the resolution code but if you have a concrete suggestion that you could turn into a PR to customize module resolution, please let me know. I'd prefer not to make a breaking change to moduleNameMapper at this point and I'm with people having to maintain two separate configs. We have discussed building a `.jestrc` system that will be plain JavaScript and export a (serializable) config. This way you can build up the config the way you want and it should solve your problem as well ‚Äì is this something you'd like to help out? I'll close this in favor of #2203 which I just retitled around .jestrc.  I don't think this needs to be in Jest, does it? Can you create your own wrapper using Jest's JS API that you build a socket around it to see what that would look like? If this is something super useful to many, we can think about integrating this into the Jest repo. There isn't any documentation. I also recommend you to look at `jest-editor-support` which uses the watch mode for editor integration and may already do what you need. I'll close this issue out but happy to continue the discussion and reopen if necessary.  I think making retainAllFiles configurable through the `haste` config field in Jest makes sense and should potentially work. If not, we'll have to find something else solution.

I honestly don't know yet what the right solution should really be as I haven't had time to think about it beyond pointing out that the solution in this PR is not appropriate. It would be best to pick this up sometime after New Years, as I'm on vacation right now. Did anybody else have thoughts on this? As is, this PR isn't a good solution. @julien-f and @rovansteen are you saying this is already working? I'm happy if somebody makes a PR that makes that work. This one doesn't yet, though. I don't think that is appropriate, @julien-f. Not every project uses git, for example we use `hg` at Facebook. No it isn't yet and we haven't made any progress on this in a while. It doesn't seem like this PR isn't being worked on right now.  sure! Is there any way we can reconcile the types like we discussed, even if that means breaking changes? We are planning on a major release on Thursday.
  <!-- Thanks for submitting a pull request! Please provide enough information so that others can review your pull request. The two fields below are mandatory. -->

**Summary**

Adding `jest-phabricator-coverage` that contains both the `testResultsProcessor` we use to create the coverage map needed by Phabricator and a reference implementation of a `JestUnitTestEngine`.

**Test plan**

Requires https://github.com/facebook/jest/pull/2265 with the change I suggested;
Running `arc unit` with the reference implementation shows now a table of the files executed with the coverage next to it;
see https://twitter.com/cpojer/status/806235376058712065/photo/1 for an example of how `arc diff` looks once integrated into Phabricator. cc @ide is this something you are interested in trying out to see if it works with your version of phabricator? This seems to have a lot of flow errors. To unblock shipping 18, I did the extraction in #2332. Can you rebase on top of that? Thanks flow, I've forgot to add a file to my previous commit with a very little change to bypass that flow error, rebasing right now. I think we can make this more efficient and less hacky, back to you for another iteration :)  This is not actionable. Can you provide a repository that shows this issue? Jest does not support requirejs. If you'd like to support it, you'll likely need to build your own transformer that injects requirejs like functionality into specific files.

In your specific case it seems like you have automocking set to true, which we advice against. It seems like dustjs or some other modules cannot be automocked (because of their use of generics or something similar), so I advice to either not use mocking for these kind of modules or provide a manual mock.  wow this is great! Thank you.  Jest creates a coverage folder with an HTML report.  Would you mind providing a repo with that so we can reproduce the issue? @mordaha https://facebook.github.io/jest/blog/2017/02/21/jest-19-immersive-watch-mode-test-platform-improvements.html#snapshot-updates  As you can see from its [package.json](https://github.com/facebook/jest/blob/master/packages/babel-jest/package.json) `babel-jest` is mostly responsible for integration with Istanbul (code coverage) and `babel-preset-jest` having `babel-plugin-jest-hoist` which will hoist your mocks above `import`s and `require`s (that's the _magic_ behind Jest mocking system). 

Of course you can set this up yourself pretty easily, but `babel-jest` is just a helper to reduce the configuration boilerplate.

And here's documentation mentioning `babel-jest` https://github.com/facebook/jest/blob/master/docs/API.md#jestmockmodulename-factory-options

We could provide some brief description of what it does in the readme though.

@cpojer anything else you'd like to add?

 Because babel-jest is now also a dependency of jest-runtime, when using Yarn or npm3+, it implicitly is also available as a top-level node_module because of how the algorithms flatten dependencies. Jest then finds babel-jest. If for some reason the de-duping doesn't work, you may lose babel-jest and it will break. I recommend to always explicitly install babel-jest.  This is definitely problem with your Node installation. You could check if `n` for some reason installs node in folder which requires administrative rights (check working path with `which node`). 
Otherwise you can also try `nvm` which installs in your home dir. 
Good luck!  Can you post an example of how --watch doesn't work? Jest cannot trace all modules, like when you are using dynamic requires. I'm pretty sure what Jest is doing works well unless you are actually preventing the static analysis from working by using dynamic requires etc. Unfortunately that is not actionable. Please provide a repository that shows this issue so we can repro. Does it work when doing `./NpmDataProvider` in your test file? Also check if watchman is not your issue: #1767 Yea, this is confusing. Maybe we should use `rootDir` for watcher instead of `testPathDirs`? Or introduce `watchDir` which defaults to `<rootDir>` And @rogeliog thanks for catching that! Are you interested in sending a PR with the fix for this? In either of the cases this should be a `good first bug`, so great way to start contributing to Jest! üòÑ 
cc @cpojer  This is a silly convention in Jest. `testPathDirs` has always been `roots`. I'm happy to rename this and deprecate `testPathDirs`. @cpojer would you mind closing this and create a new issue with explanation what's needed to deprecate `testPathDirs`?  We have a failure on node 4 and I'm unsure why. yep, this was mostly an issue with our CI and we only test in 4 and 6.  Have you tried removing node_modules and install deps again? If this is using the `react-native` preset, the issue is in react-native, not in Jest. We merged the preset in and it is now part of rn.  Jest doesn't support dynamic requires or any custom require extensions because it makes it impossible to compute inverse dependencies necessary for watch mode or `-o`.  You can do it like here: #2098.

Set `setupFiles`, in Jest config, e.g.:
```js
"setupFiles": ["<rootDir>/setupFile.js"]
```

```js
// setupFile.js
Object.defineProperty(document, 'currentScript', {
  value: document.createElement('script'),
});
```  thanks!  You are right, this is a bug!  @rogeliog sweet, thanks for your answer! Closing this. @rogeliog I totally agree we should have `--no-interactive` or `--no-status`, especially also to disable the concurrent runner output. If anybody wants to send a PR for this it would be greatly appreciated. go for it!  oh wow, this is indeed cool! That will make ts-jest a lot nicer I'm sure. and what about the performance? is it much slower to do the mapping? This will only affect performance when doing `jest --no-cache --coverage`, right? Can you take a few samples before and after and give us some numbers? This may make sense on the Jest repo itself. @jwbay i don't think it's possible to clean up on the fly, because you don't know if there's going to be more coverage coming for a specific file until the end of the test suite. But we definitely need to make sure we only collect source map for files we intend to cover and that we provide an option to disable mapping (at fb souce maps will be gigabytes of data üòÑ ) i'm super excited about this RP, i'll try to test in on the internal FB repo and see how much memory it eats this is currently blocked by https://github.com/babel/babel/issues/5081
@bcoe maybe you can give some input on this one too! hey @jwbay 
i was actually able to rollback some dependencies and make jest run on fb without freezing the process. I'll try to test your PR agains fb codebase on thursday and let you know if everything works fine! @jwbay i tried it on fb codebase today, but couldn't get it to work with our custom preprocessor. The source maps were being generated, but i couldn't map them correctly. I'll try to debug it.

I think it's still cool to have this option available though, but probably disable it by default. Smaller projects will still benefit from this feature @jwbay do you think passing `compact` option to babel when mapping coverage will help?
it shouldn't matter any more since we're mapping line numbers anyway I'd prefer to hold off until after Jest 19 with this one. i tested it locally and it works really nice!
no luck with www, but it's because of our monstrous transform pipeline (i don't think it's a blocker since it'll not affect www and we won't be able to use it right now anyway) @jwbay thank you so much for working on it! and sorry it took so long :)
This is going to be a game changer for TS projects!  They way I understand this it also supports describe.only and test.only, right?  Can you add them? :)  I don't think this is a Jest issue. We don't have any issues with jsdom starting to hang with thousands of tests, so it may be your test code. Is there a reason you cannot use Jest's provided jsdom environment? no, we don't expose those. It may be that your test is not cleaning up old instances of jsdom properly if you can only use 12 instances of jsdom. Yeah, there might be some issue *somewhere* but it isn't really something we actively support so we'll have to rely on your pull requests to help us out :)   Filed a PR for that. This is the simplest implementation I could think of. Does this satisfy your need? Closing this in favor of the PR.  While working on these fixes, you'd be better off using `npm run jest jest-mock-test` for your tests. And `npm test` before commit. All tests should pass. 
In case of some "weird" problems, `npm run clean-all && yarn && npm test` usually helps ping @tjmehta. Are you still able to work on this? Personally I can't really see the clear value of this. It seems like it's a special case that can easily be solved in a utility function, like:

`module.exports = (fn, value) => fn.mockReturnValue(Promise.resolve(value));`

If we special case Promise, should we also add special helpers for other primitives and built-ins, like `mockMapReturnValue` or `mockBooleanReturnValue`? Unless there is a strong reason why we need to increase the API surface here that I can't think of, I'd prefer to keep these helpers in userland. I'm going to close this for now ‚Äì thank you for starting the discussion and sending a PR. Feel free to continue the conversation and convince us why this is needed :) Yeah, that's a good point. However, the difference between `fn.mockReturnValue(Promise.resolve(value));` and `fn. mockResolveValue(value)` is very minor. I'm in favor of changing jest-mock around with a lot of shortcuts for things that make sense but as it is, this doesn't really simplify the API enough to warrant adding more surface area.  Feel free to send a PR for this. I don't think worker-farm supports the notion of ids but you can add the state in `runTest` here: https://github.com/facebook/jest/blob/master/packages/jest-cli/src/runTest.js @evantahler are you interested in implementing this? Sad to hear that üòû. If you have some time to point out what we could make better, please file a new issue for that. Feedback is always welcome!  Yes, this is because we are rendering using react's `test-renderer` which allows to bottom out at string based components. We don't have access to native components so we need to render to strings, instead of a native View, we render to a "View (string)".  The API Reference is missing some definitions:

* findRelatedTests CLI option (http://facebook.github.io/jest/blog/2016/10/03/jest-16.html#upgraded-cli)

> "a --findRelatedTests <fileA> <fileB> cli option was added to run tests related to the specified files. This is especially helpful as a pre-commit hook if you'd like to run tests only on a specified set of files that have tests associated with them."

* moduleNameMapper (linked from http://facebook.github.io/jest/docs/tutorial-react-native.html#modulenamemapper)

 Updated issue description with more information. The API Reference is missing some things that have been recently added. For example, findRelatedTests is mentioned in a blog post from October but it is not documented. Yeah that would be ideal but my understanding is @cpojer totally hates using JSDoc :P Actually, no that's not it. But there isn't really any place in the code where this API is clearly expressed because there is a bunch of meta-programming and because of how Jest sandboxes/virtualizes the runtime the code is run in. These docs would be scattered across jest-matchers, jest-runtime, jest-jasmine but would not be in jest-cli. (btw. jest.clearAllMocks was removed; but we intent to bring it back eventually). I see. React has a similar problem - too little of the API is defined directly to make jsdoc stuff make sense. Hmm it seems like hardly any command line arguments are documented right now For that, the website generation script could require this file: https://github.com/cpojer/jest/blob/master/packages/jest-cli/src/cli/args.js#L49 and then just use the options field.

You can require it from `packages/jest-cli/build/cli/args` and make sure that `yarn run build` was ran before deploying the website. This is to make sure the node version you are using can understand the file, because of flow types. OK. I think step 1 is to separate out command line args from the runtime stuff because it kinda seems like they should be documented on different pages. Sounds great! One thing: jest-runtime and jest-repl have their own cli and cli args. We mostly use it at FB and people outside don't *really* need it so much (unless they use @providesModule and want to build tools that use this) so I think it is fine to keep them undocumented. Hm I didn't realize there was so much stuff there. The only thing I'd expect to have its args documented is the plain old `jest` executable. It's missing about 30 command line options unfortunately üò° OK I think CLI stuff might need to go into its own area of reference Also FWIW moduleNameMapper goes into "configuration" not API and it's already there, the link was jsut broken. PR incomgin https://github.com/facebook/jest/pull/2368  Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!

**If you are contributing on behalf of someone else (eg your employer)**: the individual CLA is not sufficient - use https://developers.facebook.com/opensource/cla?type=company instead. Contact cla@fb.com if you have any questions. Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks!  Thanks for your contribution @pugnascotia, much appreciated!

I'm just not sure if this is a good design to mix regex with glob-like syntax. It can be pretty confusing for newcomers.

Although there's an ongoing effort to introduce globs in configuration files: https://github.com/facebook/jest/issues/926 

cc @cpojer   Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!

**If you are contributing on behalf of someone else (eg your employer)**: the individual CLA is not sufficient - use https://developers.facebook.com/opensource/cla?type=company instead. Contact cla@fb.com if you have any questions. Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks! thanks!  That should make `coverage` object garbage collectable and free up some memory.
I made it a string in case someone tries to access coverage in the future. haven't tested it in www yet, i'll try it tomorrow/next week I'm going to test this locally now as I want to be sure it doesn't conflict with what I' m doing for the phabricator reporter This completely removes the coverage from the aggregated results.
Can you add `aggregatedResults.coverage = this._coverageMap;` just after we write it at the end of the try in the  `onRunComplete` method to allow any testResultProcessor to get that data (maybe only add it there if there's any processor) ?

You probably need to update the flow definition for the `AggregatedResult` flow type as well.
That should be safe as my understanding the problem was that we collect a lot of data and before your change all the test run data were lying around even after being aggregated; /cc @cpojer for opinions on this. @kentaromiura yeah. i'll do that! that should just work ++ to @kentaromiura's suggestion. If you do `jest -i --logHeapUsage --coverage` inside of the Jest repo, is it meaningfully different at the end than without this PR applied? it's somewhat lower

before:
<img width="845" alt="screen shot 2016-12-13 at 4 03 58 pm" src="https://cloud.githubusercontent.com/assets/940133/21164453/d9ed370a-c14d-11e6-9065-7ed9c424eb12.png">
after:
<img width="840" alt="screen shot 2016-12-13 at 4 04 09 pm" src="https://cloud.githubusercontent.com/assets/940133/21164454/dc4ae984-c14d-11e6-8e0a-aeda057c8364.png">
  Thanks for reporting! It's already known bug, we discuss it here: #2059 Unfortunately, it's still an open issue. There are but workarounds, which you can check out in #2059   @dmitriiabramov any ideas on why is this happening?  The hanging means that you aren't tearing down your resources properly at the end of the test run. Use afterAll or afterEach to do that. The hanging suggests otherwise. You can use `--forceExit` if you are absolutely sure but Jest doesn't leave any network resources or similar open after testing. Potentially but it seems like an istanbul issue, you may want to file this there. Might also depend on your node version? Try upgrading node and removing all your node_modules and reinstalling. ok, closing here because it isn't actionable from our side. Ahh, nice!  Instead of enabling automocking, can you try disabling it and calling `jest.mock('aws-sdk')` explicitly? Does that work? We aren't currently investing in improvements to the automocking system. I suggest disabling automocking and explicitly mocking `aws-sdk`. If you are interested in a PR for this, please take a look at jest-runtime and how it handles mocking. Yes, automocking is disabled by default. We'll still have the ability to automatically mock modules using the same system but even at Facebook we are moving away from automocking by default.  Thanks @rogeliog for the thorough explanation. It is correct, we don't mock core modules by default because it is very rare you'll want a mocked version of them. `jest.mock('fs')` is the way to go. @cpojer @hramos this should definitely land in the documentation yeah that's a good point. I'm not sure where though :D  Thanks @pedrottimark for pointing to the duplicate! 

@talkingtab you'll need to wait a little for the next release to use `toMatchObject()`. 
You can read about the reasons in the issue mentioned above.
Closing. Release is scheduled for Thursday (tomorrow), so stay tuned! Please upgrade to Jest 18. yes, we'll do this going forward.  These two screens say it all:

<img width="743" alt="screen shot 2016-12-08 at 15 22 42" src="https://cloud.githubusercontent.com/assets/810438/21015517/30597eca-bd5a-11e6-8362-0888a15bf64c.png">

<img width="743" alt="screen shot 2016-12-08 at 15 22 57" src="https://cloud.githubusercontent.com/assets/810438/21015529/3971de44-bd5a-11e6-890c-4444beda9073.png">

It's the same code without any changes. It's just that the first time no tests ran (because none changed since last commit), and thus coverage reported 0%.

Should we disable the "lazy run" logic when coverage is requested? This is why I repeatedly said that using coverage in watch mode isn't very useful. I think it would be smarter to allow coverage only when you run all tests in this mode but not sure how to best signal it.  jest-runtime comes with a cli as well, you can do `jest-runtime path-to-file` which should give you all of Jest's mocking capability.

I think we did a ton of separate Jest out into individual packages that can be used individually outside of the CLI. We are not actively planning on extending Jest's scope outside of Jest ‚Äì at Facebook we don't get to spend time purely on open source (ok, only a little ;) ) so it will be hard for me to justify work on something that doesn't directly help us. If you'd like to split up runtime more into the actual "runtime" (`jest`) object and the vm context and mock state, I'm happy to review and merge any PRs that you send our way :)

If you'd like to use cucumber I think it may make a lot more sense to integrate cucumber in some way as an assertion library within Jest.

Closing as this is not something we'll take on but happy to keep the conversation going and discuss more.  Hi @pugaldp 
Could you please provide a repository with the repro? The files you provide are missing `index.android.js` and some config I guess @pugaldp tried again, now there's something with Flow not being stripped out. 
You'll need to provide a working github repository, otherwise I can't help much üò¢   thanks!  Right now when pressing "p" to select a test, we don't give any feedback for which tests are available. It would be great if we could give live feedback:

"pattern > conf"
"3 matches"

"pattern > config-normalize"
"1 match: path/to/config-normalize-test.js"

I think this would be pretty cool and helpful on large codebases when trying to figure out the name of a test file.

The data should be available on "SearchSource" and this may be easier to accomplish once we do the following:

* Split jest's watch feature into a separate package and refactor it.
* Use jest-haste-map's file watching feature

With an in memory haste map, we'll be able to query for tests every time the user types something. @rogeliog please join us on discord, see: http://facebook.github.io/jest/support.html Let's continue the discussion in the PR, closing this issue. Thanks for working on it!  Makes sense. Thanks!  Not exactly the same, but you can use similar syntax:
```js
test('title', testMacro.bind(this, 'input', 'expected'));
``` Yeah we cannot break this right now. We are considering to adopt other test libraries instead of Jasmine and Ava's API is awesome, so I'd love to have a standalone version of that. I'm going to close this issue out for now as we aren't likely to build this.  Would you mind providing a repro? I can't seem to replicate the issue, tried Node v4 and v6. 

You can also try [clearing the cache](http://facebook.github.io/jest/docs/troubleshooting.html#caching-issues) by running jest with `--no-cache` Closing due to inactivity. But happy to reopen when provided a reproduction of the issue.  <!-- Thanks for submitting a pull request! Please provide enough information so that others can review your pull request. The two fields below are mandatory. -->

**Summary**
This is attempt to fix segmentation fault on Node 4. Since "Segmentation fault" means that we tried to access memory that we do not have access to, it could happen that we tried to reach not-existing directory.

**Test plan**
Travis
 doesn't `<rootDir>`'s value has a slash at the end already though? Everywhere throughout the project `<rootDir>` is followed by a slash, so I don't think so, but I don't know everything about it. It passed here but this cannot possibly be the fix for the segfault. Thanks for fixing this, though :D  Expose the `testResultsProcessor` option on the cli

The option was already available through configuration, 
I've exposed it and add an integration test for testing it.


**Test plan**
yarn test nice!  Hi @jsdario 
Have you tried this configuration, with `"preset": "react-native"` for RN v38? 
https://facebook.github.io/jest/docs/tutorial-react-native.html

`scriptPreprocessor` was dropped in favour of [`transform`](http://facebook.github.io/jest/docs/configuration.html#transform-object-string-string)

It also would be very helpful if you provided a minimal repo with reproduction of the issue I've setup clear repo with your `package.json` and `.babelrc` and simple test:
```js
// App.js
export default function sum(a, b) {
  return a + b;
}

// App.test.js
import sum from './App';

it('sums', async () => {
  const sum12 = await sum(1,2);
  expect(sum12).toEqual(3);
});
```

Using node v4.6.2 and v6.9.1, Jest v17.0.3. It works out of box, so your config seems to be fine. 
It goes the same with [RN examples from the docs](http://facebook.github.io/jest/docs/tutorial-react-native.html#content)

Have you tried to remove your `node_modules` or change Node version and install it once again? Please remove "haste", "setupFiles", "testEnvironment" and the dev global from your config. They aren't need any more. I don't understand what your actual is. You are saying you get a syntax error for exports so I'm wondering whether you are missing some of the babel export extensions?

This is not a Jest issue, so I'm closing this but we are happy to help more and will reopen if necessary. @jsdario I'm still not clear what your problem is. If you can make a repo with a repro, then that will be much easier.  What's wrong with prorerty? Thanks!  I don't think this is controversial, there are two pieces to this:

* Make assert better. I think @dmitriiabramov mentioned the error thrown from assert has some special stuff in it, so we can use that. The only problem is we are still using Jasmine, so it might be a bit annoying to make it work. Maybe Dmitrii has some suggestions.
* A completely new, better assertion API. Right now we mimic Jasmine because it is pretty good. I agree with some of your points but in general `expect` is really, really good. However, I do want diversity in both assertion libraries and test runners. One of the coolest things I believe would be to ship Ava's test runner and assertion library by default in Jest. It would combine the strengths of both to make one super framework: Jest's scalability, snapshots, failure messages and awesome CLI/watch and Ava's far superior APIs. This is a much longer term thing and I'm excited about the potential here.

Finally, I am gonna put the hammer down a bit on "power-assert". I think it is way too crazy as a default. I don't wanna do anything to prevent you from using it though and you should already be able to, no? If no, then that should be fixed separately. We spent a ton of time making failures look really good and helpful this half and while we could bikeshed forever, the status quo is pretty and gives good signal.

None of the things I mention here are actively being worked on so whatever solution you think makes sense, taking it to a PR will make it more likely to get into Jest. Code wins arguments. built-in `assert` generates an error that can be caught and prettyfied (mocha does this well)
This is actually something that we need to do at some point, just because some projects rely on native assert and unformatted errors look very confusing.
eslint rule tester is one of those projects. It work great with mocha, but with jest it throws errors with no information about what happened at all. (see https://github.com/eslint/eslint/issues/6532)

here's an example of an assert error.
<img width="526" alt="screen shot 2016-12-12 at 8 21 34 pm" src="https://cloud.githubusercontent.com/assets/940133/21127548/9f502ff8-c0a8-11e6-8890-a30453ad5069.png">

however, when using assertion like this:
<img width="494" alt="screen shot 2016-12-12 at 8 13 28 pm" src="https://cloud.githubusercontent.com/assets/940133/21127414/7a64fa26-c0a7-11e6-975f-cca63152fa7b.png">

all you get is `expected true to be false` which is not really informative. And i don't think there's any way to get any meaningful information from there without static analysis (like power assert does).

I think the best option for now is to make `expect` as nice as possible and maybe simplify some methods + provide much nicer documentation @cpojer @dmitriiabramov can we close this issue then? i guess we're not going to get here anytime soon.
here's another issue for this https://github.com/facebook/jest/issues/1230

we should add a list of `first bug` tasks for other people who want to start contributing :)  I don't think that makes any sense. Describe is just used for grouping, you don't need to use it and most of the time it isn't useful. You can make everything else async which is what is recommended for tests. Happy to discuss this further, just closing to manage the queue but convince me/us and send a PR and we'll see what happens :) You can always have side-effectful setup behavior in `beforeEach`, like:

```
let foo;
beforeEach(async () => foo = await bar());
```

We are hoping to one day rewrite Jasmine and remove it from Jest but that is still pretty far out. If you can submit a PR to add async support to "describe" and hack Jasmine to do that, I'd welcome it. This is inside of jest-jasmine2, inside of the vendor folder directly inside of Jasmine. As we are hoping to move away from Jasmine, feel free to try to rewrite this and send a PR :)  `Date.now = jest.fn` or `global.Date = jest.fn()`.  @kentaromiura is actually about to open source the code we use for coverage in phabricator at FB soon.

@ide who might care. This is super useful during code review. Example:

![screen shot 2016-12-06 at 8 32 55 pm](https://cloud.githubusercontent.com/assets/13352/20942417/37fc95ee-bbf3-11e6-807e-2faebfcfbd27.png)
 @ai this is not for the coverage html output. This is for phabricator integration: https://www.phacility.com/ the HTML coverage report is coming from istanbul, not from Jest: https://github.com/istanbuljs We open sourced `jest-phabricator-coverage` with Jest 19. Feel free to use it as `testResultsProcessor`.  this is awesome! Thank you.  @hzoo I wonder if this is related ‚Äì #2141? Looks like it would solve the issue with permissions. > Hmm, I'd prefer not to make this change. We used to store the cache inside of node_modules/jest/.haste_cache and we had a ton of problems, like watchman would crawl this and then get out of sync and a ton of other tools at FB on all codebases would go mad with this. It should be easy to set "cacheDirectory": "<rootDir>/node_modules/.cache/jest" or something
~ @cpojer 

  simply tweak clear codes and check 'em in different envs
main purpose was to clear scrollback buffer, instead of just clearing screen

**Summary**

clear scroll back on watch mode. helps a lot if you have output which you want to scroll up

**Test plan**

tested with this diff just to show that I have patched version of jest running:
```diff
diff --git a/packages/jest-cli/src/jest.js b/packages/jest-cli/src/jest.js
index f499dd3..77ff3e1 100644
--- a/packages/jest-cli/src/jest.js
+++ b/packages/jest-cli/src/jest.js
@@ -285,6 +285,7 @@ const runCLI = (
   argv = argv || {};
   if (argv.version) {
     pipe.write(`v${VERSION}\n`);
+    pipe.write(`PATCHED VERSION FROM 1861-clr-scroll-on-watch\n`);
     onComplete && onComplete();
     return;
   }
```

on each test, I have to add `jest/packages` to `NODE_PATH` and do `npm link` inside of `jest/packages/jest-cli`, to make patched `jest` available globally

then run `jest --version` just to ensure that I'm running my patched version, and then, finally, run `jest --watch` 

checked on:
* OS X with zsh
* Windows 7 with cmd
* Ubuntu with bash

(sorry, no videos nor gifs. removed them)


I think I have not break anything with this change. However, windows 10 with powershell is untested. Do you want me to test it also, @cpojer ?

And, cc @gaearon , please take a look on this PR.

__P.S.__ However, I don't have GUI Linux and can't check on it...  And, yup, this PR is related and should close #1861  I'll take a look at this next week. I want to test it thoroughly but my schedule is just too packed right now and I need more time.  @SimenB yes. from 1.6 version 

link to tmux changes file:
https://github.com/tmux/tmux/blob/23254f59daea7415c96bc323d3b48d35c1b21327/CHANGES#L391-L392

> Support for \e[3J to clear the history and send the corresponding
  terminfo code (E3) before locking. LGTM.  Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!

**If you are contributing on behalf of someone else (eg your employer)**: the individual CLA is not sufficient - use https://developers.facebook.com/opensource/cla?type=company instead. Contact cla@fb.com if you have any questions. Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks! Thanks! There is a simpler implementation here: #2337.  Maybe it would be a good idea to introduce `jest-config-validate` as a separate package and use it across the codebase? 
I think this would be super useful when migrating to newer versions with updated config.
 We have `normalize.js` where we put the validation we do have: https://github.com/facebook/jest/blob/master/packages/jest-config/src/normalize.js

I'm happy to add more, granted it isn't going to slow down the normalization process more.  What about `Object.defineProperty(store, 'doOneThing', {value: jest.fn()})`?  This seems like a Babel issue.

On Node v6 it gives us this nice output:
```diff
 FAIL  src/components/__tests__/FuelSavingsForm-test.js
  ‚óè Test suite failed to run

+   /Users/thymikee/Projects/snapshotbug/src/components/__tests__/FuelSavingsForm-test.js:1
+   ({"Object.<anonymous>":function(module,exports,require,__dirname,__filename,global,jest){import React from 'react';
+                                                                                            ^^^^^^
    SyntaxError: Unexpected token import

      at transformAndBuildScript (node_modules/jest-runtime/build/transform.js:316:10)
      at process._tickCallback (internal/process/next_tick.js:103:7)
```
while I can confirm Node v4 results with what you present.

cc: @cpojer  Yeah it seems like we can't really change the error here. The issue is that you aren't transforming ES-modules. Add this transform: https://babeljs.io/docs/plugins/transform-es2015-modules-commonjs/ to your test `env` in babel.rc.  Please send a pull request if you'd like to see this fixed! It's right here: https://github.com/facebook/jest/blob/master/packages/jest-config/src/loadFromFile.js#L20 I think this is a great issue to be labelled with `good first bug` This was resolved with https://github.com/facebook/jest/pull/2337  We removed it from Jest because it slows everything down and nobody uses it. Using testcheck yourself is the right way to go about it! I recommend checking out jasmine-check, actually: https://www.npmjs.com/package/jasmine-check  Does this still happens on Jest 18.1 and react-native 38+ with Jest's `"preset": "react-native"` in config?  Can you supply a reproduction for this issue? It works as expected on my end. 

And your example:
```json
// .jestrc
{
    "jest": {
        "bail": true,
        "verbose": true
    }
}
``` 
shouldn't work according to docs, if you run it with `jest --config .jestrc`. 
It will work when insterted into `package.json` though. Closing for now.  Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!

**If you are contributing on behalf of someone else (eg your employer)**: the individual CLA is not sufficient - use https://developers.facebook.com/opensource/cla?type=company instead. Contact cla@fb.com if you have any questions. Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks! Hello! I will take a look when I have time. I work on Jest in open source mostly on my own time and I haven't had much time recently. Hey, I was just finally able to take a look at this.

I'm not sure if we want to make ts-jest a default in Jest like this. First, I just refactored this test which was super annoying to work with, so any simplification you can make there is appreciated. Second, ts-jest is not really official but I'd like to figure out a way to make it work well with Jest without hardcoding so much. Do you have any suggestions to implement this better? We do have a "preset" option ‚Äì it only sucks if you want to use more than one, like TypeScript together with react-native. How about in addition we add a "presets" option that can take N number of presets? They may conflict, so it may not be a good idea. setupFiles from presets get merged with the local config, so that should work just fine. @Igmat thank you for the PR and for the discussion here. Let's go back to the issue and take what we learned from this to make this a bit better. I do definitely want better ts-jest integration but I don't think this is the right way. I think we should try the preset way: let's expand the feature (see normalize.js) to support ts-jest well so we can make it easier to use. I think it is ok if it isn't automatic as long as it is simple to setup.  Hi @zigomir, this seems like an issue with `npm`. I've installed deps with `yarn` and tests are running. Try removing `node_modules` and run `npm install` once again.

If that not helps, could you please try installing your deps with other version of npm, e.g. using `npm install -g npm@next`. Or you can use `yarn` if that's not a problem. This is strange. I can still run tests, and they pass when fixing the error, using the same Node version, using either Yarn or npm. Which OS are you on? Have you tried on other machine? I use the same macOS and it works, so this definitely has to be something with your environment. Maybe try to reinstall Node, remove node_modules? It sometimes does the trick ^^ Closing to manage the queue but happy to keep the discussion going and reopen if necessary. I have watchman installed too (v4.5.0). Probably there was an issue with the version you've been using. Would be great if you installed newer version and try it once more :) Check out the bottom of this thread, might be related: https://github.com/facebook/jest/issues/1767  I've seen this before but I don't think it is a Jest issue. Probably something related to React or your node modules folder. Upgrading to npm3 will probably solve your issue ‚Äì maybe the React team forgot to add object-assign as explicit dependency to the test renderer? @spicyj can you help us out here?  We may have some sort of problem with Jest on master in node 4 but it may also be a bad test. Usually kicking the build works; I'll deal with that (unless you want to investigate) so if the node 6 build finishes it is all good for now. thanks! This is great.  Jasmine is using a prefix for test names. We could remove it but it would thrash all existing snapshot tests (= breaking change) so we are keeping it for now. Hmm, I guess we could account for that in the filter. Are you willing to send a PR for that? Wow that is awesome to hear. Did you see https://github.com/facebook/jest/pull/2192 ? We are creating a generic editor support package that will also be used for Nuclide integration. What are your plans for IntelliJ integration? I wouldn't bet on #926 ‚Äì we currently don't have any immediate plans to work on it, so I think this is something the community needs to help out with. Oh that sounds cool! Let me know if you need any help or input from us. @develar are you going to send a PR for this issue? We removed the prefix in Jest 19.  We're actively working on this here: #2397. Feel free to join the discussion. Closing the issue.  This is great! I'll check this out soon when everything around me gets a tiny little bit more quiet. Sorry I can't get to it immediately. Adding the text below to source and test files should do the work:
```
/**
 * Copyright (c) 2014-present, Facebook, Inc. All rights reserved.
 *
 * This source code is licensed under the BSD-style license found in the
 * LICENSE file in the root directory of this source tree. An additional grant
 * of patent rights can be found in the PATENTS file in the same directory.
 *
 * @flow
 */
```
 ping, is the flow typing still happening? :) @jkimbo thank you for the updates!   cc: @cpojer  Wow this is really solid! Nice work. I have one more lint rule to add, so I'll do that in a follow-up :) Small follow-up here: https://github.com/facebook/jest/pull/2509 Actually, @jkimbo would you mind adding the lint rule I was thinking of? I think we should have one that errors when using `xit` and `xdescribe` that people can optionally enable. At Facebook it's really bad when people disable tests (while they are working on something) and then potentially commit disabled tests (similar to the rule for `test.only`, really).  this is fantastic. I really like that we are putting this stuff directly on expect! Can you run with `jest -u` and remove the obsolete snapshot? @just-boris I would welcome a blog post!

Would you be willing to write a codemod that transforms from `jasmine.*` to `expect.*` for these? That would be massively helpful in deprecating the old jasmine APIs quickly. See https://github.com/cpojer/js-codemod/tree/master/transforms for a couple of jest codemod examples.

We can also add a custom serializer to pretty-format inside of Jest. If you can think of a way to pretty print and detect them, please send us another PR. We already pass the React plugin to it, so we can also have our own serializer (see `prettyFormat` calls in Jest). Also, feel free to open a separate issue for this. You can contribute codemods to the js-codemod repo :)  Yeah seems like we need to make some changes here. The code is in there: https://github.com/facebook/jest/blob/master/packages/jest-matchers/src/matchers.js#L540

Personally I don't think there is much value to support out-of-order Arrays in this matcher. Can we just disable it and fall back to an equality check like `toEqual` does for Arrays?

Consider this test:

```
expect(compare([1, 2, 3], [3, 2, 1])).toBe(true);
```

what value does it serve?

We have some tests in Jest itself where the order of results depends on the FS APIs and we manually call `.sort()` on the result array, which imho is a better solution, see: https://github.com/facebook/jest/blob/master/packages/jest-cli/src/__tests__/SearchSource-test.js#L111-L114

What do you think? Check out https://github.com/facebook/jest/blob/master/CONTRIBUTING.md#our-development-process ‚Äì although we'll need to update this guide to recommend `yarn` ;)

I wasn't involved with adding `toMatchObject` but at the core, for every feature, I'm asking two questions:
* How does this help developers write better tests?
* How much lifetime maintenance cost does this new API incur on users of the API?

It seems like this feature right now helps write tests but I'm unsure whether they'll be better quality tests with this current implementation. As said, I don't see much value in a matcher that tests out-of-order arrays for "equality" ("similarity"?).

(cc @dmitriiabramov) Thanks everyone for helping with the fix!  There should be some tests for this in integration tests.

I'm not sure if we should go ahead with this. If you only have one test file, you can adjust the testRegex in your configuration to read these files. I'd rather not make the name of test files more ambiguous. However, with your change "Footest.js" or "Myspec.js" will now also be considered as tests. I think we also have a bunch of places (docs?) where this regex is used.

We use Jest for integration tests. Those tests invoke Jest, so there is some jestception. Simply check out the `integration_tests` folder. Every folder comes with its own Jest config and the files in `integration_tests/__tests__` are the ones that run Jest in one of those folders and make sure the CLI reports the correct output. Nice! See `integration_tests/__tests__` and check out some of the existing tests there and what they check there ‚Äì you need to add one of those to make sure your integration test folder will actually be run in our suite. So basically when you do `jest integration_tests/__tests__/my-test.js`, those tests are expected to invoke Jest itself in `integration_tests/<my-test-folder>/` and then make sure the output is what we expect. yep, looks good!  **Summary**

The Jest website is hosted on GitHub Pages. Deploying a new version is done manually by running `publish.sh` locally, and requires write permissions. With this PR, we are moving website generation and deployment to CI. As a result, the website will be automatically kept up to date whenever `master` is updated. Contributors to the repo will see their changes go live soon after their PRs are accepted and merged.

A side benefit of this change is that it allows us to maintain separate mirrors of the site. Specifically, this config will deploy the `new-docs` branch automatically to http://jest-bot.github.io/jest. This will allow us to preview the updated site before it goes live.

**Test plan**

The script was developed and tested against a fork of this repo at https://github.com/hramos/jest. The commits landed by CircleCI in `gh-pages` can be seen at https://github.com/hramos/jest/commits/gh-pages. A successful CircleCI build initiated by the same changes being submitted in this PR can be found at https://circleci.com/gh/hramos/jest/14.

Once this PR is approved and merged, we'll need to update the CircleCI config for Jest using the same settings used by https://circleci.com/gh/hramos/jest
 Oh man, this is going to make life so much easier. I'm about to head out of the office (it's 11pm in London!) but I'll get back to this on Monday. No worries, enjoy your weekend! I'm not sure how much work would be involved to make that happen. @hramos is helping us out with the project a bit on this side ‚Äì Hector, do you think versioned docs are possible with only a little bit amount of work? How would we handle typos and docs fixes for the current release then? Versioning the docs is no small task, I wouldn't do it as part of this initial sprint. There's pros to doing it as @SimenB mentioned, but it also makes it harder for us to push out updated docs / accept edits from the community (as fixes will not be visible unless people switch to viewing docs from master, resulting in a lot of churn from unnecessary PRs / PRs opened against the wrong branch).

I'm open to doing this down the road but I feel it's an unnecessary complexity at this time. nice work. Thanks @hramos.  Jest 17.1 (today?) will support `expect.assertions(number)`. Does that work for you? Hmm, this makes sense but we do have a legit use case here of making sure something doesn't fail so I don't wanna make it more restrictive.

```
it('does not throw', () => {
  RenderMyApp();
});
```
 The default test that create-react-app ships with doesn't have an assertion: https://github.com/facebookincubator/create-react-app/blob/master/packages/react-scripts/template/src/App.test.js#L7

Jest also doesn't enforce usage of `expect`. You can use any assertion library you want as long as it throws on failure.

cc @gaearon in case he has an opinion here. Yeah, I agree. I think between `expect.assertions` and an eslint plugin, we should be able to cover this use case without making Jest more restrictive.

I didn't realize there was an eslint plugin for Jest. We should consider merging this into Jest, making it official and expanding it's scope a lot; including an optional option to make sure "expect" is used at least once within a test. @SimenB are you interested in working on this? @jkimbo would you be interested to work more on this eslint plugin and helping to make it official? That sounds great. To be honest, I haven't considered this myself before, so I'm gonna rely on ideas from you guys. What do you want it to look like and lint against? I can help figure out what the right defaults should be, though :) I care most about finding patterns that guide people to write tests with good quality and rules that are helpful rather than annoying.

cc @zertosh who always has opinions on linting. That's great! Would you be willing to move it into the "packages" folder of the Jest repo and add me to the project on npm? Awesome! All done! No, Jest 20 has `expect.hasAssertions()` for this purpose, but no minimum.  Set the preset to "react-native" and remove `jest-react-native`. It isn't needed any more with 0.38! We merged this preset back into react-native; please send mocks and PRs directly there. In Jest 18.1, doing `./jest-setup.js` will be resolved from the location of package.json. That might be cool!  Thanks! It is so hard to keep docs in sync :(  Can you provide a repro?
You should be able to mock Node modules from any directory in the project tree.

Provided `left-pad` is in `node_modules` this should work:
```
src
‚îú‚îÄ‚îÄ __mocks__
‚îÇ¬†¬† ‚îî‚îÄ‚îÄ left-pad.js
‚îî‚îÄ‚îÄ left-pad.test.js
```

left-pad.js:
```js
module.exports = 'left-pad'
```

left-pad.test.js:
```js
test('mocks leftpad', () => {
  expect(require('left-pad')).toBe('left-pad')
})
``` @ericclemmons ping! ICYMI Jest 19 came out, so it would be great to test on the newest version.  Jest has a `setupFiles` config which I think is enough. I think we also support `--setupTestFrameworkScriptFile` on the cli for this use case. Happy to accept a PR that renames this though.  See http://facebook.github.io/jest/docs/configuration.html#coveragethreshold-object If you'd like to send a PR to support this, I'm happy to review and accept it. Please also include an integration test! I'd recommend namespacing them as `--coverage-branches`. What do you think?  No it cannot currently and that would be pretty odd. It seems like it would make more sense for the Jest config to read the ts config and add that from the beginning. This may be a compelling reason to allow JS based config files. What do you think? At the same time they don't change often, do they? It may just be fine :)

If you'd like to send a PR to Jest, this should be somewhere in `packages/jest-config`. We've been meaning to support something like `.jestrc` for the longest time. Add support to jest-config. There is some "loadConfigFromPackage" or something functionality in there so I'd change the resolution to something like:

* Load config from file that was passed in.
* Load config from jestrc (preferred) or package.json at the closest location by walking up to the root.

What do you think? Yes, I agree. I think we should prioritize jestrc over package.json and that's fine. yes, .jestrc would simply be a JavaScript file that exports the config. Thanks for the PR! I'll look at this in about a week when I get back to the office :) This will be in Jest 20, soon.  I wonder if this could be done using `expect.any(‚Ä¶)` which we are adding soon. See https://github.com/facebookincubator/create-react-app/pull/1127#issuecomment-264290075 I'm following this here (a bit busy with other stuff) and like what you guys are coming up with. Happy to review PRs for Jest if that makes sense. I'm not super up-to-date on this discussion and react related conversation should probably happen somewhere else (react repo?) but here is one pointer: https://github.com/airbnb/enzyme/pull/742 enzyme is looking into this, too. @pedrottimark I'm a bit unclear on this issue what the action items are. What can we do in Jest to improve this? The shape matcher proposal seems to make sense to me; it appears to me that pretty-printing React component diffs through `toMatchSnapshot` would help us with this?

I understand you have concerns with the behavior of the react-test-renderer. I would like to ask you to discuss that in the react repo, as the Jest team isn't responsible for this piece :) I can't speak as much about Part B/C but for the first one:

* How do we identify a previous snapshot? Since we already keep state, should we just have go with the flow here?

```
const apple = new Apple();
expect(apple).toMatchDIffSnapshot()
const applieModified = apple.eat();
expect(appleModified).toMatchDiffSnapshot()
```

You are also bringing up the question on how we should diff: it seems better to do that on the object level, but it may be slow because it has to be recursive. In this proposal, how will we customize diffing? Will `toMatchDiffSnapshot` be able to take an optional "diff" argument?

Also, I think this is a lot about how we can highlight this in the output as well. Should diff snapshots show different output than regular toMatchSnapshot. Hm, interesting, I actually thought we could push it into toMatchDiffSnapshot:

```
expect([prev, current]).toMatchDiffSnapshot(options?)
```

However, `diffSnapshot` might be more flexible overall, but I'm not sure yet. It really depends on how flexible we want this to be and what kind of user experience we want to make work here. One example could also be to have a mode (using --expand?) where we'd actually show the prev/next snapshots as well. I think there is some UX exploration to do here.

The question is, how would the differ work? Would it receive two pretty-printed strings and operate on those (line-by-line) or would it receive the plain data and require users to diff them, based on what object they are? If so, we could have a default recursive-diff feature in toMatchDiffSnapshot.

I also encourage you to see past what we have now with `toMatchSnapshot`. Assume that `jest-snapshot` is the low-level building block for this new feature but we may want an entirely different CLI output for the diffs. I know @rogeliog has been thinking about this. I think there is a ton of value in visualizing snapshots over time/state. I guess I didn't consider this so much an extension for pretty-format as I consider the implementation of this to exist on top of jest-snapshot in some way. Instead of diffing line-by-line I thought it makes sense to diff JavaScript objects before printing. I see value in both approaches, unsure which one is the best yet. I think this concept is quite interesting and it is really worth exploring... I'm a bit worried of how complex the API can get here.

I kind of like the idea of just starting by using the latest snapshot as a base diff for the next snapshot, with as close to zero options as possible. This will allow us to just create the minimum API to support the most common use case of  this feature and then incrementally make it more flexible as it is needed. I would love to leak the lest amount of implementation detail on how snapshots are stored or how the `.snap` files works.
 @0x24a537r9 That sounds really interesting and further proof that we need to do something here. Are you planning on creating a proof-of-concept renderer for React?  thank you! no worries! We don't actually run this code at all :D  **Summary**
* Virtual mocks weren't hoisted.
* Fix insane clowniness in static analysis.

**Test plan**
jest  @dmitriiabramov will give you a hug for this. I've been fighting him, but I guess now it is 2 against one, so let's do it! I smell some refactors of old Promise code coming. thank you! ‚ù§Ô∏è   Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!

**If you are contributing on behalf of someone else (eg your employer)**: the individual CLA is not sufficient - use https://developers.facebook.com/opensource/cla?type=company instead. Contact cla@fb.com if you have any questions. Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks! Yeah this looks reasonable to me. I think it would be nice if you could follow-up on this PR with a code comment here and there about why matcherResult and the actual/expected values were passed back.

Is there a reason you cannot use Jest's lovely output?

Can you explain more how Jest is integrated with wallaby? I had no idea this existed/works. I'll read the rest later but yes, please do send a follow-up. @ArtemGovorov it sounds pretty awesome what you are doing. I'm sure I've given you a lot of pain in the last year by refactoring internals. We don't really officially support the API of the cli and will likely make more changes. We'll keep in mind that you are integrating tightly and bump versions appropriately and will mention these things in the README.

We are however making jest-editor-support an official package. We just merged it and will continue to improve it until it is really solid but @orta has build a great base. Are you willing to change your integration point to that?  Oh this is great timing. I'm literally working on Jest's plan for the first half of 2017 at Facebook right now and we are very curious about what improvements we can make to snapshot testing. Is this something that you are specifically interested in exploring and potentially working on?

Two of the things I'd like to see done are:
* Add a mode that requires user input to accept new and updated snapshots.
* Add a configuration option to prevent writing snapshots and fail instead. This should be turned on in CI systems to catch tests that don't have a committed snapshot associated with them.
 Just for reference, it isn't Jest that is missing shallow rendering, it is the `react-test-renderer` which is currently missing shallow rendering. I agree it makes sense to add this and I believe it shouldn't require a huge effort. Is this something you could potentially contribute to the react project? It'll benefit literally every single person that uses Jest + React. See https://github.com/facebook/react/issues/7148 ‚Äì I'm sure the React team can help you get started. I *finally* had time to read through this entire issue. Thanks for discussing so feverishly. 

@faceyspacey: what you are bringing up is very interesting. We specifically didn't do any of this visual integration because we thought that it would be too slow and too annoying for engineers. However, building such a thing on top of Jest would be awesome and I'm sure many people would find it valuable.

@pedrottimark: I'm trying to figure out how we can take everything in this issue and turn it into an action plan to improve snapshot testing and make it more useful. I apologize for not fully digesting this issue when I closed your PR recently. So far the thing that sticks out to me the most is that snapshots can often get too big and that the value of the individual snapshots goes down.

One thing that @rogeliog came up with; which I guess is more about the narrative than how it actually works, is "snapshots over time". (See https://github.com/facebook/jest/blob/master/packages/jest-cli/src/__tests__/__snapshots__/watch-pattern-mode-test.js.snap ). The idea is that we want to snapshot how state evolves over time. @faceyspacey has discovered this, as per his comment above as well as @xixixao who proposed diffs for action changes over time at FB. It seems like everyone is independently coming to the conclusion that we need some form of diffs not just within one snapshot but also snapshots between two or more snapshots. The next question I'd like to find an answer to is whether this has to be a technical/behavior change in how snapshots work and whether we need new APIs or whether this is mostly a visual change in how Jest is being used ‚Äì basically whether this is a change in how tests are run or how tests are written or both. Once we have an answer to that, we can figure out how to solve this problem.  hah. @blainekasten there were some typos in here :P 

thanks @raycohen   Unfortunately that function hasn't been part of a public Jest release yet. It's currently on master. Unfortunately we have no way of versioning the website right now so the latest version of the docs is already online :( The next Jest release will come out this week!  thank you!  Seems like you already opened this on the redux-thunk repo, which I think is the proper place for this. Closing it out here.  I'm going to merge this and then take a pass. We may want to make a few cosmetic changes.  I'm happy to accept PRs and make this official provided they follow the code standards, are easy to maintain and well tested. I only want to take this dependency on if we have some guidelines in place to make sure we aren't just growing this repo for no reason :) @Igmat do you have a path forward for this? Any idea how we could make this work? I think for now I'd prefer ts-jest to be maintained outside of the Jest repo but if there are some easy things we can do to make it easier to set up, I'm happy to hear your opinion. @Igmat was exploring this in the past and it did require a bunch of changes as it is more involved than the babel-jest stuff. I'd love for it to be revisited and figure out how to make this work.  **Summary**
See https://github.com/facebook/jest/issues/1822#issuecomment-263717270. For some reason this didn't work previously but now it does and it is great!

cc @kentcdodds who also had trouble with this.

**Test plan**
jest  Make sure to use jest-react-native <= 17.0.3 and *not* 17.1.0 if you are using RN <= 0.38. If you upgrade to 0.38, you can drop jest-react-native and use `"react-native"` as a preset directly.  Please don't turn on automocking by default with the jest-react-native preset. That won't work well!

Also, once you upgrade to 0.38, just drop "jest-react-native" and set the preset to "react-native" :)  sure! Thank you again @thymikee üéâ   thanks!  Awesome.

Let's put all of these into `packages/` inside of Jest. If you can reserve the package names on npm and add me (cpojer) and the "fb" user to it, that will be great. We can then start publishing from within this repo. We may need to figure out some permissions but that shouldn't be that big of a deal :) Oh that's interesting, I was unaware. I definitely think we should split everything up into a `jest-editor-support` package (or many) and then find a way to publish the vscode package. For atom, we should do exactly the same: push most of the code into the editor support package and the atom specific code into a separate package that we deploy via apm. Does that make sense?  We merged the preset into RN. May be related to #2176  also Published as jest-react-native 17.1.0. We may start to actually throw and tell people to change it to "react-native" in a future update.  Is this a bug in `npm prune`?  Like, how does jest-util get there in the first place if npm believes it doesn't need it?  Hey! I'm sorry I'm just getting back from a vacation and am pretty swamped. Please note that all of this is on top of my mind and I'll get back to it soon but it may take a bit more than a week until I can dedicate real time for this. I'm sure we can fix most of these issues. Thanks! I really appreciate that you are doing this ‚Äì if you can find any significant problems inside of Jest that we can turn into a PR, that would definitely make this process faster.

Jest doesn't do well on resource capped machines (low memory/low cpu/slow disk access) and things like code coverage generate a ton of data. Generally we don't have the same kind of issues you are experiencing with Facebook's projects that also use Travis, so we'll have to figure out what's going on. Wow this is great, thank you so much for the investigation. Here is a bunch more that you should think about:
* Jest parallelizes tests, so you should potentially try to detect leaks in a single thread using `-i`, otherwise all the threads will just split the leaking and take longer to crash.
* What has helped me in the past is to use v8-profiler, capture a heap snapshot at certain times and then load it in chrome and take a look at the retained references. Again, this should be done using `-i` because the leak currently seems to happen in the worker processes and not in the main process, so if you run it without `-i`, you'll only capture the heap of the main process without any test runs. See https://github.com/node-inspector/v8-profiler

From the looks of it it seems like one of two things, both equally likely:
* You guys aren't cleaning up after your tests, retaining more memory than you should. This may even be a node bug with the `vm` module ‚Äì I've had issues with that years ago on a different service I was building at FB. For some reason an "Error" object in a vm context was retaining every single JS module at FB and crashing our service after 100 requests. This was tough to track down.
* Jest is retaining information or the vm context after a test has completed in a process and the test data has already been sent back.

One thing I thought could be an issue is code coverage ‚Äì that definitely requires a ton of memory and at FB we had to bump the memory that node can consume. @dmitriiabramov did a fantastic job to rewrite code coverage support but to make it really efficient we may need support from the community to make it more "streamy": store coverage on the file system and then process them as a stream at the end of a test run. Alternatively it may also be possible to merge coverage information in the main process after each test has finished running. I don't know how feasible either of them is, though.

At FB we currently have one repo with about 5000 test suites and even with coverage we aren't running into any big memory leaks which would hint at a leak issue in your code but I'm not entirely convinced and think it may be a Jest bug. We have the same thing at FB, actually, so I don't think your usage of describe/it is a problem. btw. this is where Jest creates workers: https://github.com/facebook/jest/blob/master/packages/jest-cli/src/TestRunner.js#L324 while the slowdown of crashing workers and starting them for each individual test would not be tenable, it is something you can try to change to see if it avoids the memory leak problem (ie. it will ensure it is not a set of tests with leaks but rather the aggregate suite over time) That's great progress. Can you share your setup script? Does it do anything with global objects, timers etc. ‚Äì anything form the environment that it attaches and might stick around and cannot be GC'd? Yeah you definitely have a special case: massive amounts of tests but low memory. At FB, we have both massive amounts of tests and insane amounts of memory, so it is generally not a problem. I'd love to reduce coverage memory usage and I believe the way to do it is by through either:

* Merge coverage results in the main process after each test file and get rid of the per-test-result coverage data.
* Write coverage results to a file and process it as a stream at the end of a run.

Maybe @dmitriiabramov can help identify how much work that is. This is definitely something where we'll need some help with. @cpojer we do merge coverage results after each test. Maybe the easy fix would be to `delete testResult.coverage` after each test. That should free up a lot of memory https://github.com/facebook/jest/blob/master/packages/jest-cli/src/reporters/CoverageReporter.js#L52 @dmitriiabramov wait we do!? I didn't realize that. We still need to extract coverage data per file for phabricator; if we delete it from individual tests, will we still be able to do this? I think this would dramatically reduce memory usage of Jest.

@kentaromiura might be interested as we'd have to change the coverage processor around a bit. @cpojer yeah. it should work.
i would do something like
```js
testResult.coverage = 'coverage object was removed to reduce memory consumption, run with -keepCoverage' to keep it'
```
or something like that.
Phabricator should still work, i think we only use the end result to generate the coverage json to feed in I don't see the value that coverage from one individual test run provides so I'd prefer to just delete it completely after it was merged. imho only the aggregate really matters after a run. If you'd like to know file-specific coverage, run the test in isolation. What do you think? i think it doesn't matter in 99%.
unless someone wants to build a custom reporter for some very specific use case.
I'll just remove it and let's see if it helps @ooHmartY thanks for the analysis. "Runtime" is what runs each test in a vm context in isolation. This is where it gets tricky: why are these objects retained? It is entirely possible that you are doing something in your tests that causes all your test code to be retained. While I'm not entirely sure if this is a Jest issue, I'd appreciate if you could profile this again with test suites as simple as `test('works', () => expect(1).toBe(1))` and let me know if you can repro this leak.

At Facebook we run thousands of test files in one single run and don't ever run into memory issues like you are describing. I highly doubt that you have a test suite that's bigger than what we have, which hints at this problem being at least partially the user code that is run within Jest.

One simple thing I can think of is when you attach listeners or similar to global objects, for example if you did `require('fs')[Math.random] = global` inside of a test, that would make it so everything from one test file will be retained in the parent context.

I'm really hoping we can figure out further fixes here. Does my description help? Turned out it's an issue with `jsdom` leaking Window objects. We track it in this thread: https://github.com/facebook/jest/issues/1893

Here's the relevant issue in JSDOM repo: https://github.com/tmpvar/jsdom/issues/1682
We'd definitely ‚ù§Ô∏è any help on that, but it requires debugging `jsdom` itself.

Closing this.  thank you!    `--no-cache` does create cache files, yes, but it doesn't use existing cache files. This means that subsequent runs will be fast (after dropping --no-cache). Is this a problem for you?

I'm closing this because it is unlikely we'll change this unless it turns out to be a serious issue. Why not set the `cacheDirectory` to somewhere else? We can probably make this work by simply guarding all the cache writes. If you'd like to do that, feel free to send a PR with a few tests to make sure it works well. Here are some of the caches we use:

* `jest-haste-map` creates one cache file
* `jest-runtime`'s `transform.js` file creates one cache file per transformed JS file
* `jest-cli`'s `TestRunner.js` has a "test performance" cache file

  thank you!  @davidtheclark thanks for all the concern! But I'll close this issue, as we're constantly seeking to optimise performance. Hope you don't mind. 

We've recently tracked a [memory-leak in JSDOM](https://github.com/tmpvar/jsdom/issues/1682) which slows us down, but we believe this will be addressed soon. 
Also the watch-mode has been rewritten with some nice perf gains on larger repositories, ready to be released in the next major version.

If you have any ideas on how to improve it further, please do so in separate issues üôÇ   Thank you! Can you make the same change to react-native here: https://github.com/facebook/react-native/blob/master/jest-preset.json#L4 ‚Äì we are actually merging the preset into react-native at the moment! :)  How are type errors thrown by the TypeScript compiler? If it throws a type error on a file, Jest should catch that and show it inline. If the type error is thrown in a file that hasn't changed, Jest will not compile that particular file because it has a transform cache based on when files change. If that's the case, I'm afraid there is nothing we can do except for you to always run with the (slow) `--no-cache` option. Feel free to send a PR to change the TypeScript example to use `ts-jest`. Indeed, TypeScript support is not "official". You can use any transformer and TS is just one of them ‚Äì the problems of showing type errors or source maps etc. are entirely on the transformation side and Jest merely provides hooks for these things. That would be incredibly slow as we'd have to recompile everything on every run. Jest caches transform results.  Closed related issue: #1877. Moving discussion here @scwood.  @migomipo have you managed to solve it?
Anyway I think this is related to `mongoose`/`mockgoose` and there's little we can do about it. It definitely looks like mongoose / mongo / your tests are not cleaning up after themselves. I'm not really sure if there's anything we can help you with on this topic. No, it shouldn't. Every test gets its virtual environment (`jsdom` or or node's `vm`) and is disposed after every run. However we have an issue with JSDOM retaining its globals causing a memory leakage, which is already addressed in their repo. 

I may want to try this example in `node` testEnvironment and see if this still happens Ah, so I was thinking about something else. What we have here is Jest unable to detect uncaught async errors (when `done` parameter is passed to `it()`/`test()`) ‚Äì that's when we handover the test to Jasmine and we need to fix it somehow. This is addressed here: https://github.com/facebook/jest/issues/2059.

As a workaround you need to wrap such places inside try/catch clause, so for this example it will be:
```js
  it('test1', (done) => {
    User.find({}).exec((err3, user2) => {
      try { // catch error in async test
        expect(user2.length).toBe(2); // Intentional test failure, length == 1
      } catch (error) {
        done.fail(error);
      }
      expect(user2[0].nick).toBe('foo');
      expect(user2[0].role).toBe('user');
      done();
    });
  });
```

It shouldn't be an issue if you could return a Promise from test (note that Jest allows returning either a `Promise` or `undefined` from `test()`, otherwise it will throw).

E.g. something like this would work:
```js
  it('test1', () => { // no 'done', it's called automatically by Jest
    return User.find({}).exec().then((user2) => {
      expect(user2.length).toBe(2); // error is caught inside a Promise
      expect(user2[0].nick).toBe('foo');
      expect(user2[0].role).toBe('user');
    });
  });

```

Sorry about that, this bug is such a pain. Closing this issue.  thank you for your PR! This will be in the next Jest release this week.  thank you!  I'm not sure if I follow, but isn't the [`modulePaths`](http://facebook.github.io/jest/docs/configuration.html#modulepaths-array-string) what you're looking for?  This will be solved through #2925, closing as duplicate.  thank you!  Thank you for this PR! `jest-react-native` just reached it's end of lifetime as we merged the configuration into react-native itself!

Can you send the same PR to react-native directly? See https://github.com/facebook/react-native/blob/master/jest/setup.js

Also, it would be great if you could stub out the API a bit more effectively, for example with an in-memory storage.  Since you can write a one-liner function/wrapper around it, I don't see the reason for extending mocks API just to do this. 
I'm closing the issue for now to manage the queue, but we can keep the discussion going and reopen if necessary.  i'm trying to understand what causes syntax errors on CI, i tried to reproduce all kinds of race conditions and it had no success. This info will help me understand whether it's really a race condition that is causing it or something else.

https://github.com/facebook/jest/issues/1874 I'm ok with this if you hide it behind a flag. The default case of a developer running tests and hitting a syntax error is what we should optimize for; if you want to debug some CI thing, please put it behind a flag instead of making the developer experience a bit worse with lots of logs. i added `logTransformErrors` config options, i'll enable it on www only to see the errors I somehow missed your update. It's gonna be in 18.  Does this help?
http://facebook.github.io/jest/docs/tutorial-async.html So basically, having 
```javascript
HOC(Component) => EnhancedComponent
``` 
you can just test EnhancedComponent to have props you expect. @SamWyld any luck with your problem? I'll close this issue because it's not strictly Jest related, but happy to discuss if you need to :)  While async testing promises it's good to remember that you can return a test function as a Promise, so something like this will work:

```js
test('my promise test', () => { //a test function returning a Promise
  return Promise.resolve(load.succeed(result))
    .then(() => {})
    .then(() => expect(result).toHaveBeenCalledWith(result));
})
```

Returning a Promise from test function makes Jest aware that this is a async test and to wait until it's resolved or times out.  I'm hoping to copy the entire synchronous part of the `resolve` module into jest-resolve and then to refactor it with more performance in mind. This would have a nice speed boost for Jest and we could support these kind of things better as well. Would you be willing to help out and build this? 

The first step could be to merge the pieces of resolve that we need into jest-resolve, then get rid of the "browser-resolve" module and then update the whole thing for performance ‚Äì all of this can happen in individual PRs. @yanivefraim looks like this was added in node-resolve v1.2.0: https://github.com/substack/node-resolve/commit/c2cbdddcc2aa1c427ccd8a7c1784c745093f836f

So I'll close this issue, because `_http_server` should be supported now. 
If we want to move `resolve` into `jest-resolve` lets discuss this in a separate issue/PR.  From what I can see React Native 0.38 asks you to use [React 15.4.0 RC 4](https://github.com/facebook/react-native/blob/v0.38.0/package.json#L135).
Have you tried using it instead of 15.4.1?

Also related: https://github.com/facebook/jest/issues/1840. @donataswix there is another solution. I can say, "fix" :)
https://github.com/facebook/react/issues/8442#issuecomment-263474956 @Richard-Cao I suppose, it depends on used `react-native` version
> `"preset": "react-native"` when using RN 0.38+

 I'll update jest-react-native today to forward to react-native. I'm also updating Jest's documentation to hint that you won't need `jest-react-native` any longer as the default setup with 0.38 includes a working Jest configuration.

See #2182.  Hey @th3fallen, thanks for your input. Can you provide a test case or simple repo with the bug? Tried several times but I can't seem to replicate this.
Thanks! Thank you, much appreciated!  Closing this for now, but happy to help if the issue persist :) You need to update `transformIgnorePatterns` to not include the specific node_module. By default, it doesn't transform anything in your node modules.  yeah. i think those should be separate configs, it would be hard to autogenerate default value based on module extensions  This is already possible and used in the wild thanks to [`snapshotSerializers`](http://facebook.github.io/jest/docs/configuration.html#snapshotserializers-array-string) config option.

Some examples:
* https://github.com/rogeliog/jest-serializer-enzyme
* https://github.com/ruyadorno/jest-serializer-html-string

Not to mention you can write your own :)  thanks!  reduce `maxDepth` when pretty formatting the object if the resulting string is too long.
It will reduce depth by 1 every time until it either fits the `MAX_LENGTH` or becomes 1 (just printing the top level keys). This should happen only on failures, so the performance hit from running `format` multiple times should not be that bad.

cc @gaearon  üíú * Let's halve it every time. No need to waste cpu cycles.
* When `-e` is given, always expand it and show the whole things.

What do you think? @cpojer supporting `-e` means bringing state to the utils (or passing `{expand: true}` into every call). Will require some rearchitecture. although we should definitely support it.
Let's set `MAX_LENGTH` to maybe `50000` for now and plan to consolidate state, utils and matchers in one package? Oh yeah, good point. Let's not do the state thing then but still halve the max-depth each time. I don't see a point in making this linear. Gentle ping as it affects us in React repo after updating to 17. Thanks so much! @thymikee i didn't even look into it actually.
in our `.babelrc` we have `es2015-destructuring` but we don't have `es2015-spread`, i'm not sure what exactly `[...Arrat(10)]` is, so i just rewrote the breaking code using `for` loop :) nice work @dmitriiabramov. I'll publish a new release this week.  Is there anything that prevents you to await this code in `beforeEach()` hook? We'll not be adding this for now as the complexity isn't really worth it. The recommended solution is to create a test utils file and use it like so:

```
const TestUtils = require('TestUtils');
beforeEach(TestUtils.setup);
```
  This is what I see with a single failing expectation:

![gif](https://d17oy1vhnax1f7.cloudfront.net/items/0A2w0K1W1Q1M0a1D1e2M/Screen%20Recording%202016-11-21%20at%2005.10%20pm.gif?v=efedafa1)

This is because jsdom has its implementation under a `Symbol()` key, and a single jsdom element brings the whole jsdom with it.

Can we fix it by adding some sort of pretty-printing for jsdom? I know that's what @yaycmyk attempted in https://github.com/thejameskyle/pretty-format/pull/47 but it received a comment:

>I also don't think HTML printing should be a default. I don't actually want to pretty-print HTML elements in Jest like this.

>If we really want to do this, the right way is to build a plugin and then use instanceof checks with the objects coming from jsdom.

Shall we do this them?

Another way to fix this specific issue would be to skip `Symbol()` keys since they're intentionally "private". The downside would be that comparing two objects with different values under Symbol keys would presumably miss those differences. We could maybe only print `Symbol()` keys if we know the difference is *inside* of them but skip them otherwise.

Yet another way to fix it would be to limit nesting when printing difference to something like 3. I think it's what Node does in console.log but I might be wrong. @yaycmyk are you interested in making such plugin for `pretty-format`? Thanks! Marking this as a Good First Task then, since majority of the work is done by you. Go for it! Check out the pretty-format package in the Jest repo and how the plugin system works.  Yes, Jest excludes node_modules by default. You can adjust `testPathIgnorePatterns` for your use case: http://facebook.github.io/jest/docs/configuration.html#testpathignorepatterns-array-string Ahh, I'm sorry, yeah you are right! I didn't realize this before, but yes, what @shanewilson says should work for now. I believe to fix this without changing the "haste" config, you'd have to turn this switch to true: https://github.com/facebook/jest/blob/master/packages/jest-haste-map/src/index.js#L207 ‚Äì if @shanewilson's workaround doesn't work, can you try turning this option to true and reporting back? If that works, we can probably expose it as well as part of the "haste" object ‚Äì you could send a PR for that :)

I also encourage you to give lerna a try: https://github.com/lerna/lerna ‚Äì it has worked really well for us!

Are you using Jest at Buzzfeed? Ok I see, yeah that makes sense. I encourage you to just go with @shanewilson's workaround then.

Also, cool that you are using Jest! :) Discussion continued here: https://github.com/facebookincubator/create-react-app/pull/1081#issuecomment-264351297  This is not a bug. Jest is not aware of your tsconfig. You can set [`modulePaths`](http://facebook.github.io/jest/docs/configuration.html#modulepaths-array-string) though. 
Hope that helps!  I don't think i've ever had a need for anything like that in out tests, but i think `Object.keys` should work just fine. It's simple and very explicit.
I also added this matcher last week (https://github.com/facebook/jest/pull/2110). maybe it can be updated to take an array as the first arg. But honestly, i'd rather prefer explicit `Object.keys`  @cpojer what do you think? I think this could resolve problems like this: https://github.com/facebook/jest/issues/2070 @voideanvalue is likely going to work on something that should affect this. I'm not interested in disabling this warning but we might make some FB-only stuff configurable so it doesn't leak out to the community so much.  There's an idea to tackle it in #2231. We'll keep you posted. Aaaand it's closed (see #2303). Turns out `cacheDirectory` gives us all the flexibility to fight such issues. Thanks for your input!  If you'd like to send a PR to add the uid to the default cache paths including tests, I'm happy to accept that.  Thanks for all your input here. The reason is it's just not implemented yet!

There's this issue about JS config too ‚Äì https://github.com/facebook/jest/issues/2203
And this PR, waiting to be reviewed ‚Äì https://github.com/facebook/jest/pull/2445

Fingers crossed it will be ready for the next release. Closing this as a duplicate.  If you'd like to mock a module that was previously required, you'll have to call `jest.resetModules()` and re-require it.

Example:

```
let module = require('module');
jest.mock('module');
jest.resetModules();
module = require('module'); // this is a fresh, mocked copy
```

in `beforeEach` that may look like this:
```
let module;
beforeEach(() => {
  jest.mock('module');
  jest.resetModules();
  module = require('module'); // this is a fresh, mocked copy
});
```
  Have you tried using asymmetric matchers? They are exposed through `expect`. http://facebook.github.io/jest/docs/api.html#asymmetric-jest-matchers Worth noting they're available since Jest 18.
And will be [provided with pretty-printing](https://github.com/facebook/jest/pull/2476) soon  Disregard my previous comments. 

Nevertheless I'm not convinced we need another type of matchers, because it's all possible through asymmetric matchers (now ported to Jest) without much more typing.

e.g. you can use
```js
expect(mock).toHaveBeenCalledWith(expect.objectContaining({
  two: expect.any(Number)
}));
```

 yep, agree with @thymikee here.  @pdhoopr would you mind providing a minimal repro of the issue? Thanks! I'll get to it as soon as I can  @bmatto have you managed to work this out? Thank you for this!  This has come up a few times. I think we need to bring `clearAllMocks` back. cc @mrsharpoblunto @jdmunro I'm ok with a PR that brings back `clearAllMocks` alongside `resetAllMocks`. Closed via https://github.com/facebook/jest/pull/2771  awesome! That makes sense to me :)  Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!

**If you are contributing on behalf of someone else (eg your employer)**: the individual CLA is not sufficient - use https://developers.facebook.com/opensource/cla?type=company instead. Contact cla@fb.com if you have any questions.
 Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks!
 Hey! Thanks for this. I'll be out on vacation next week but happy to look after then.
 I'm not super excited about the `dontThrow` check but I'm also not feeling strongly about it so I went ahead and merged it. I'll publish a new version of Jest sometime this week once I get through all of these issues. Sorry for making you wait.  Closing this in favour of #1377. You're welcome do discuss new this API shape there.  Nice work @thymikee. Thanks again for sending a PR with a fix for an issue! I appreciate your contributions.  Jest 16 introduced improved `moduleNameMapper` resolution, so it indeed may work a bit different than you expect and it's most probably like that by design.

Are you still experiencing it? If not, can you please provide a small repo with the issue?
Doesn't something like this work?
```js
"^react-native\/(.*)$": "<rootDir>/node_modules/react-native-web/dist/$1"
``` Closing due to inactivity.  I don't think it makes sense to include this arbitrarily in this example. The problem here is that your reporter runs inside of the vm context of a test, instead of Jest's own context. We should make the reporter interface pluggable from the outside.

cc @dmitriiabramov
 hey @khejing 
plugging into jasmine can be confusing, because it runs inside the testing sandbox. I'm working on a pluggable XML reporter for jenkins integration here https://github.com/facebook/jest/pull/2115
any help would be appreciated :)
  Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!

**If you are contributing on behalf of someone else (eg your employer)**: the individual CLA is not sufficient - use https://developers.facebook.com/opensource/cla?type=company instead. Contact cla@fb.com if you have any questions.
 Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks!
 I think this is pretty nice! Thanks for following up with a PR ‚Äì I cleaned it up just a little bit; basically I disabled the `?` command when usage is shown by default.

You said that the "First run should show usage, second should not. Hit ? while in watch mode." but this isn't actually how it works. I think this is a good feature to add though ‚Äì would you mind sending a follow-up PR for this? @kusold note that the ENV variable will go away in the next Jest release, see https://github.com/facebook/jest/pull/3078  I think this is a nice idea. Would you like to send us PR with this? :) Closing this for now, but happy to reopen if you're willing to work on this üòâ   Hi @anmonteiro, could you provide a repro of the issue?
This is probably not the issue with Jest, so I'll close it. But I'm happy to help and reopen if it's really a bug  @thymikee I think this is actually a Jest issue! Sorry about that üòÑ Trying to close issues too fast! Thanks for the repo, much appreciated! I sent a PR with a fix.  I think we shouldn't do this statically. It should be a runtime check after the test completes.
 het @browniefed 
per our discussion today:
here's the hook that i used to fail the test if there's a failing `.toMatchSnapshot` (they don't throw by default: https://github.com/facebook/jest/blob/master/packages/jest-jasmine2/src/setup-jest-globals.js#L22-L34

and you can use those to set this global matcher state from the inside of `expect` code: https://github.com/facebook/jest/blob/master/packages/jest-matchers/src/index.js#L144-L148
 This will be in the next Jest release as `expect.assertions(number)`.    Duplicate of #1652.  Hi @albertolive, would you mind providing a reproduction of your case? Ideally you could set up a separate repository with a single test causing this issue There'a an open issue for that in Istanbul's repo: https://github.com/gotwarlost/istanbul/issues/735, which I guess is better place to discuss the issue.
Closing.  Can you double check if this works with 17.0.0 or not?
 @Spy-Seth I've tested the case from attached gist on v17 and v18, test pass.
@acateland your example is valid too. 

Closing this, but happy to reopen if you can provide a repo with failing test (can be something with configuration). Yeah, so `resetMocks` and `jest.resetAllMocks()` works this way now, that it wipes all mocks data. Here's a relevant issue to bring back `jest.clearAllMocks()` back to Jest: https://github.com/facebook/jest/issues/2134.   Nice! Thanks for sending a PR with a fix.

@kittens will like this too.
  **Summary**
It's possible we receive multiple events if one folder is watched twice for some reason.

Example:
* Roots are `<rootDir>` and `<rootDir>/packages`
* `touch packages/a.js`
* Two events are emitted to the `onChange` handler.

This diff also changes the onChange handler into a queue based system, just to make sure this is all done in sequence.

**Test plan**

jest + manual verification.

cc @matryoshcow @davidaurelio No, there isn't, which is why I made this change. I was thinking of watching only the least common ancestor but that may be `/` and it would watch for every single file change, there is no point in that :(
 This deduping would likely go into https://github.com/amasad/sane
  fixes master @nickpresta no worries! i should've noticed it right away :) it sucks that we can't control formatting on different node versions :(
  Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!

**If you are contributing on behalf of someone else (eg your employer)**: the individual CLA is not sufficient - use https://developers.facebook.com/opensource/cla?type=company instead. Contact cla@fb.com if you have any questions.
 Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks!
 Thanks for the PR! I just pushed an update that should fix your Flow issue :)  This definitely looks like something Windows-specific.
@ilyaivanov @ZeroCho do you mind investigating into it and propose a PR? Would be fantastic! @benhurott @ilyaivanov does changing Node version also fix this for you? Thank you very much! Closing then.   This was fixed in a recent release. Please upgrade to Jest 17.
 Can you provide a repro? We allow the cov variable to pass this static analysis check here: https://github.com/facebook/jest/blob/new-docs/packages/babel-plugin-jest-hoist/src/index.js#L111

are you sure you are using babel-jest 18 and jest 18 together? Please let me know if you have a consistent repro in a repository on github and we'll fix this.  @gre can we close the issue then? So this is apparently possible with extending `haste` configuration (a node modules resolution mechanism used by Facebook and it's not quite documented here) and resetting `coveragePathIgnorePatterns` as it defaults to `["node_modules"]`.

Check if something like that should work for you:
```js
"jest": {
    "coveragePathIgnorePatterns": [],
    "collectCoverageFrom": [
      "src/*",
      "node_modules/your-app/**/*"
    ],
    "haste": {
      "providesModuleNodeModules": [
        "your-app"
      ]
    }
}
```

Make sure you call jest with `--no-cache` flag.

cc: @cpojer if you have anything more to add here.  Fixes #2099  The comment was outdated. I removed the line! You can simply use `it`.
  thank you for working on it!
i resolved the conflicts and opened a PR https://github.com/facebook/jest/pull/2120
  @tarim you're probably having `testEnvironment` set to `node`, but you should use `jsdom`. Please see the docs: http://facebook.github.io/jest/docs/configuration.html#testenvironment-string  thank you! Sorry for making you wait.  This is odd. Can you put up a repo with a repro? babel-jest should definitely be used if it is installed. Can you try with --no-cache once? I'm assuming the node6 preset includes the commonjs transform, right?

What does your Jest config look like?
 Oh, so when you overwrite "transform" in any way, babel-jest is not automatically being used. Should we change that default?
 The problem is that we cannot really detect precedence with this simple setting because we are using regex to define them. What if you specify a custom transformer for `test.js` ‚Äì should we then only use the first one that matches or fall through to babel-jest as well? I think explicitly defining the transformers you want makes sense and we should consider updating the documentation to reflect that.
 Yeah, please send a PR! :)
 I think mentioning it in the API docs should be fine; the getting-started guide shouldn't contain this.
 (closing in favor of the PR)
  Yes.
 unclear, this is probably not a Jest bug ‚Äì if you can make this repro consistently and can share it on github, please show me!
  Hey! I'm sorry, I'm about to embark on a vacation and I will get back to this next week. Overall, lgtm though so happy to merge it when I'm back and make a release :)  That may be an issue with Jest but I think the "globals" field should be deprecated and removed altogether. It isn't very useful.

I recommend creating a file that does:

```
global.__SERVERS__ = [‚Ä¶];
```

and adding that to your `setupFiles`.
  `testPathIgnorePatterns` or `modulePathIgnorePatterns` both work on the file level, not on the directory level so they should work for this.  In your test or setup file you can do something like this:

```
console.error = message => {
  throw new Error(message);
}
```

Unfortunately we cannot just overwrite the console in Jest for everybody so this should be opt-in on a per-project basis. If you'd like to work on a PR that adds something like `jest.throwOnConsoleError()` (I'm sure there is a better name for this), I'm happy to work with you on that.
 Closing, as this should be further handled in a related PR.  @MattCopenhaver you're right, there was no PR on this topic Feel free to send us one! :) Feel free to join us on discord if you'd like to discuss anything! http://facebook.github.io/jest/support.html  Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!

**If you are contributing on behalf of someone else (eg your employer)**: the individual CLA is not sufficient - use https://developers.facebook.com/opensource/cla?type=company instead. Contact cla@fb.com if you have any questions.
 Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks!
 Just published 17.0.2. Sorry about this.

I'll probably send a follow-up PR that goes back to concat so we don't clone this array on every resolution.
  I'm pretty sure it was published properly. Is it possible whatever mirror you are using is behind? Can you try with Yarn?
 npm sometimes needs some time to catch up.
  Does it work with `npm test`? I don't think this is a Jest issue. Which version of Jest are you using?
 Closing because I think this is not Jest's fault. Happy to help out resolve this issue though and reopen it if it turns out to be a Jest issue.
 That's odd. Do you have watchman installed and are you on Mac OS Sierra? Can you check the bottom of #1767?
  **Summary**
Nobody uses it and it is slow. I don't want to keep maintaining it.

**Test plan**
it's gone.  This seems like an issue with jsdom, not with Jest. Please open an issue here: https://github.com/tmpvar/jsdom
  Thank you for your pull request. We require contributors to sign our Contributor License Agreement, and yours has expired.

Before we can review or merge your code, **we need you to email cla@fb.com** with your details so we can update your status.
 Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks!
 I recommend making this change directly in react-native: https://github.com/facebook/react-native/blob/master/jest/setup.js

The next version of react-native will come with this preset by default and we'll deprecate jest-react-native.
 Thank you for sending us a PR though! :)
  See http://facebook.github.io/jest/docs/tutorial-react-native.html#transformignorepatterns-customization
  If you run more than one test, Jest groups the log messages per-test. If you only run a single test or use `--verbose`, we don't buffer console calls. This is an escape hatch ‚Äì if you have an infinite loop and we buffer console messages, none will show up at all. I recommend not using `--verbose` unless you are only running a single test.
  It is on npm. Just install 17.0.0. Their website is slow to update.
  Would you mind adding a test for this?
 Why doesn't `pretty-format`'s recursion detection catch this?
 To be clear, I mean that while the fix is probably good, shouldn't we take a stab at the underlying problem and figure out why `[Circular]` doesn't get printed as expected?
 > could be due to multiple instances of the same synthetic DOM node not being strictly equivalent

It's hard for me to understand how this could even be possible in JavaScript. Which is why I'm worried: there might be a larger issue of `refs` not being passed, or cleared at the wrong time.
 I looked at it for a bit.

The error occurs not due to a circular reference, but due to the fact that HTMLElement in jsdom links to an "implementation" object which in turn links to the "core" which itself links to all jsdom globals, and conversely, the complete browser API:

https://gist.githubusercontent.com/gaearon/f7e771410e6b095625c3b413dcc5d2ff/raw/c23fbc63f75dd8b6192ef4289a02612387ec91fb/wow.md 

So maybe `pretty-format` works "right" after all and just enforcing minimal depth is enough.
 yes, it is published. Just pushed the tags too.
  This option was removed. Jest 16 should throw and guide you to the right config. Use `moduleFileExtensions` instead.
  yes, you'll need to add `".*": "babel-jest"` manually in such a case.
  yep! That's an npm issue :)
  Can you explain what exactly doesn't work any more now?
 I cannot repro. Please try and clone the Jest repo and run these:
- `npm run test "has.*map"`
- `npm run test haste-map`
- `npm run test packages/jest-haste-map/src/__tests__/index-test.js`

they will all run the appropriate tests.
  This doesn't seem like an issue with Jest. The code you pasted is clearly a syntax error (`function () name () {}` is not valid syntax). Seems like you'll need to fix your transformer. I recommend to try `jest --no-cache` in case there is something funky going on.
  Hey @jsomsanith!
Cloned the repo and it works. Does this still happen to you? Yup, first i tried on master, but then on the branch. Have you tried to remove node_modules and install deps once again? 
For reference, I was on node v6.9.1, macOS Sierra.  This time I got it right! 
Currently snapshots have known problem with escaping single `\r` character, which is being inserted in 2 of your icons ‚Äì `talend-arrowright` and `talend-arrowleft`. As a temporary solution, please remove `\r` from those icons if possible.

Here's the corresponding issue: #1890. Feel welcome to send us PR on this if you like :)  Exactly! Check out whatwg-fetch.
  Yes this does suck indeed. The manual mocking system is really not good and I'm happy to accept PRs that will improve the situation, assuming we can make sure we don't break all of FB (but I can take care of that :) )
 Yes, mocks are "global" as well. This is a terrible design that we have to live with, unfortunately. At FB we have 4000+ mock files in the wrong location (and often there isn't even a proper location). It is likely we will fix this early next half, so this should improve in Jest. I'm happy to support PRs that improve the behavior in Jest for open source ‚Äì if we can retain the old behavior for Jest at FB for now.
 Yeah, it should be a config option. But I'm not just talking about the warning, I'm also talking about the feature in general.
 The resolution code is called from jest-runtime: https://github.com/facebook/jest/blob/master/packages/jest-runtime/src/index.js and is somewhere in jest-resolve and jest-resolve-dependencies.
 @cpojer  what about some global override, like `JEST_USE_BASENAME_FOR_CACHING`, to switch this behaviour?

At least, we can enjoy non-unique filenames, and it will not break anything in FB.

Of course, it's a temporary solution.

I mean, this is in some `/etc/profile` or `~/.bashrc`
```sh
export JEST_USE_BASENAME_FOR_CACHING="true"
```
(or some file with env)
and then 
```
$ jest
```

or this one, without env file modifications:
```
$ JEST_USE_BASENAME_FOR_CACHING="true" jest
```

What you think? It's a sort of hack or it's ok?  :wink:
 it would be nice to see  @cpojer answer on it Hey everyone, sorry for the delay, I'm pretty backed up with a ton of stuff right now.

I think I'm fine if you guys decide to do whatever breaking change in Jest that is necessary to improve this system. Manual mocking is really messed up and doesn't work well. One thing we kind of want to do is limit the scope of "haste modules" (internal FB module system) using a config option, like `"haste_modules": ['path/a', 'path/b']"` and then only look at haste modules in those folders, including this weird mocking behavior. If anybody wants to make this change, that would be amazing.

One thing to be figured out then, is this: If all manual mocks are local, like `__mocks__/a.js` maps to `a.js`, what do we do with node_module mocks? For this there are a couple of ways:
* Introduce a new `__node_modules_mocks__` folder but that is ugly.
* The top level `__mocks__` folder as seen from `rootDir` (project root) could act as a global folder.

So to summarize:
* Let's fix manual mocks in Jest!
* Let's namespace haste modules and limit them to certain folders/regex whatever.
* Make sure that the current mocking behavior still works for FB, even if that means we have to whitelist certain folders to make haste work (it would just look like `["<rootDir>"]` for us for now, I guess)
* Figure out how to still be able to mock node modules.

What do you think? My thoughts:

### haste modules:
I think , `haste_modules`  is nice, it fits just like `collectCoverageFrom` and other options: *array of globs*
In case, if you have all `src` as _haste_ modules, and just one directory is non-haste:
```
haste_modules: [
  "src",
  "!src/foo"
]
```

### node_modules

@EnoahNetzach what if someone have same names for app module and module from node_modules?

-------------------------------------

To make it work without haste... hm, I think it can be described like:

> given node module `project/node_modules/react`, mock will be inside of `project/__node_modules_mocks__/react.js `
> if you have a file `project/react.js`, then use `project/__mocks__/react.js` 

(of course, `react.js` is an example. here can be any filename among of all modules, which can be installed from *npm*)

Really, mocking *node_modules* module is a rare case by my experience, so... may be _rareness_ may compensate _ugliness_ in particular case of mocking *node_modules* ?

Anyone mocking modules inside of *node_modules* often?

### what about to think further

as I noticed, for *react-native* projects, we often have to mock `application modules` and leave modules from *node_modules* unmocked (e.g. `lodash`)

this means, we have:
* manual created mock component for each dumb component  (dumb component are layout components)
* a long list of `jest.mock` call in every test file

__what I want to say__: it would be very nice to have ability to _auto mock_ modules on some paths.

It can be implemented around well-known data structure *array-of-jest-globs* in config, and filtering modules upon it.

I will describe that step by step

Given this config entry
```
"autoMockingPaths": [
  "src/components/dumb/**/*.js",
]
```
and this code at `src/screens/app.js`:
```
import _ from 'lodash';
import Button from '../../components/dumb/button.js';

// blah blah AppScreen implementation skipped
```
and this test code for screen at `src/screens/__tests__/app-test.js`:
```
import AppScreen from '../app.js';

describe('AppScreen', () => /* testing app screen */);
```

We come to this situation, in context of `app-test.js`:
* `AppScreen` is not mocked
* `lodash` is not mocked
* `Button`, which is required by `AppScreen`, is mocked

... You can answer, how it will play with `automock` config entry?

simply saying, `automock: true` is equivalent to:
```
"autoMockingPaths": [
  "<rootDir>"
]
```

-------------------------------

#### auto mocking... wait!

may be just introduce special value for `automock`? at least it will not break people's configs

for example, with this config entry:
```
automock: "app"
```
jest will auto mock all application modules, and leave actual versions for modules from `node_modules`

what do you think about app level modules automocking, @cpojer  ? I find it very efficient for my particular case.
 may be just throw, if someone has same module name in `node_modules` and `app modules`

e.g.
> `app/express.js` as app module (may be I'm doing train game)
> and `app/node_modules/express` as web server from npm
> `throw new Error("can't mock express.js file - it duplicates one from node_modules")`

in this case, `__mocks__` can be used for `node_modules`, but dev have to rename own modules on such collisions

nah... this is more ugly than `__node_modules_mocks__`, isn't it?
 Let's keep this focused on changing how haste works (whitelist/blacklist rather than on by default). I do think I'd prefer to maintain that `<rootDir>/__mocks__` should be the default for node module mocks. We could make this a configuration option as well: "globalMocks" that defaults to `<rootDir>/__mocks__`. Is anybody willing to work on this? I can work on PR this sunday, I'm kinda free

@cpojer just to recap - create `globalMocks` config entry with default value of `<rootDir>/__mocks__`. This option regulates use of `node-haste` within *jest* by specifying path? Or it will be array of paths? I think these are some larger changes on the way to get this resolved but I think we need both the singular globalMocks option (could be a string or array of strings) and the hasteModules option which would be an array of paths of haste modules. Most of this code lives in jest-haste-map and jest-resolve. I'm not 100% sure what the right solution will look like yet.


________________________________
From: Max Sysoev <notifications@github.com>
Sent: Friday, December 9, 2016 8:18:44 AM
To: facebook/jest
Cc: Christoph Pojer; Mention
Subject: Re: [facebook/jest] [bug] duplicate manual mock found in separate directories (#2070)


I can work on PR this sunday, I'm kinda free

@cpojer<https://github.com/cpojer> just to recap - create globalMocks config entry with default value of <rootDir>/__mocks__. This option regulates use of node-haste within jest by specifying path? Or it will be array of paths?

-
You are receiving this because you were mentioned.
Reply to this email directly, view it on GitHub<https://github.com/facebook/jest/issues/2070#issuecomment-265958606>, or mute the thread<https://github.com/notifications/unsubscribe-auth/AAA0KAMFc34iKqBDLHZzgaGHqyc3WkAzks5rGQ7kgaJpZM4Kt2DW>.
 Sorry, my workstation became broken, and apparently no way to get it working in couple of months (1-2 months). I even lost my project on this PR :( So, sorry for taking responsibilities. We cannot break the current behavior as we rely on it extremely heavily at Facebook. cc @voideanvalue this may be something you'll have to think about (namespace manual mocks as part of the new haste implementation).  thank you.
 I'll do it either today or early next week. 17 is out already.
  Can you explain which tools do this and which problem you are trying to solve? I don't really see any advantage to doing this.

Closing for now but happy to continue the discussion. Convince me! :)
 Neither of these two tools seems particularly popular so I'm inclined to wait and see if others adopt it.
  This is an issue with "fileset" which needs to update their dependencies to the new version of minimatch. You can ignore this for now ‚Äì we don't have control over this package but since Jest isn't exposing a web server or anything, the warning you are seeing is unlikely an issue.
  You need to add the ES modules to common js transform to your babelrc.
 Which file is throwing?
 See http://facebook.github.io/jest/docs/tutorial-react-native.html#transformignorepatterns-customization to whitelist node modules.
  Can you confirm this is happening for you on projects that are not react-native?
 sorry about that. I'll try to publish a fix soon.
 Sorry this took a while. Fix is up at #2083. Will publish a patch release in an hour.
  That is of course because it is `jest.resetAllMocks()` and I didn't use the right name in the documentation.
  Are you mocking `chalk` in a way and overwriting it? I'm sorry but with the things you listed here it won't be possible to help you unless you can create a repository on github with a repro.

I think this is unlikely an issue with Jest itself. It may be your test code or your npm install. I recommend at least wiping away all node modules and reinstalling them.

Closing as it is unlikely a Jest issue but feel free to keep the discussion going and happy to reopen if this turns out to be a Jest issue.
  If you'd like to set up your own preprocessor, look at the scriptPreprocessor config in Jest. This will be renamed to "transform" and expanded a bit in the next release. Also check out how babel-jest and ts-jest work.

See http://facebook.github.io/jest/docs/tutorial-react.html#custom-preprocessors
  You may need a proper ListView mock. The one that's currently in `jest-react-native` is very simply and doesn't really do much. We are merging the preset into react-native, so it's best to send a PR to https://github.com/facebook/react-native directly.
  Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!

**If you are contributing on behalf of someone else (eg your employer)**: the individual CLA is not sufficient - use https://developers.facebook.com/opensource/cla?type=company instead. Contact cla@fb.com if you have any questions.
 thank you
  On master, I changed one of the tests in jest-haste-map from `toBeDefined()` or something to `not.toBeDefined()`. It would then go on to crash Jest:

```
[cpojer: ~/Projects/jest (master)]$ jest "haste-map.*index"

 RUNS  packages/jest-haste-map/src/__tests__/index-test.js

/Users/cpojer/Projects/jest/packages/jest-jasmine2/node_modules/jest-matchers/build/index.js:110
        throw error;
        ^
Error: expect(received).toBeNull()

Expected value to be null, instead received
  undefined
    at HasteMap.hasteMap.once (/Users/cpojer/Projects/jest/packages/jest-haste-map/src/__tests__/index-test.js:685:62)
    at HasteMap.g (events.js:291:16)
    at emitOne (events.js:96:13)
    at HasteMap.emit (events.js:188:7)
    at Timeout.emitChange (/Users/cpojer/Projects/jest/packages/jest-haste-map/src/index.js:562:14)
    at ontimeout (timers.js:365:14)
    at tryOnTimeout (timers.js:237:5)
    at Timer.listOnTimeout (timers.js:207:5)
```

@dmitriiabramov what have we done? Oh, it might have been because I didn't return the promise but instead am using Jasmine's async work. Nevertheless, we should hook up an unhandled promise handler in Jest.
 @capaj seems like you are on the hook to make that PR. Jest is an open source project, if you'd like something to be fixed, please start contributing. The attitude you are showing on this issue tracker is not appropriate. I'd prefer if you channeled your enthusiasm into code which will help make this project better for everyone or channel it into productive conversation. Negative comments don't help anybody; if that's the only thing you are contributing to this project I'd prefer to see you using a different testing platform. That's ok, we can disagree on this but the Jest project doesn't need your negativity and we won't accept this behavior here.  **Summary**
This implements file watching in jest-haste-map. This is going to be useful for two things:

* replacing `node-haste` with `jest-haste-map` in RNP.
* rewriting Jest's watch command to listen for haste map changes instead of filesystem changes. This is going to significantly speed up the watch command on larger repos because we won't need to rebuild the entire time something changes.

It does so by using `sane` and listening to change events. On every change it deletes the entry in the file map, module map and mocks map (if they are defined) and then runs through the processing code to add it back to all three of these maps. Every X "frames" it emits a change event with the updated HasteFS and ModuleMap instances as well as an event queue of all the recently changed files.

I explored a bunch of solutions and this one seems like it's the best trade-off for now: We aren't reading/persisting the cache in watch mode at all. This is a lot faster but means we'll do a bit more work on the next startup. Since this additional work is at most ~1s on large repos and makes sure we never get into an inconsistent sate, it will work well. The reason why we cannot do this is because we don't get properly updated watchman clocks. There may be a way to do this together with sane but I'm unsure right now whether this is properly threaded through. Also, this makes it easier to swap out watching with other solutions if we'd like to do that.

@matryoshcow @davidaurelio

**Test plan**
jest

 About collisions:

Changed it so that we switch to warn in watch mode. The behavior change is to take the last haste module rather than the first like we did previously. This is a breaking change but also behavior that is non-deterministic in the first place (depends on the order of files we get from the fs).
 Regarding data-structure consistency:
I have to copy the data structure instead of updating them in-place because otherwise we swap them out in between a window and it would cause awkward reliability issues. I decided to still re-use the original ModuleMap and HasteFS instances and update them instead of providing new instances. I'll see how that feels on RN ‚Äì right now we also mutate the fastfs instances and module map. If I can make it work to never cache the instances on another class, I'll make them immutable and create new copies every time, as there is no overhead to this.

I profiled the copying the entire haste map on RN and it takes 10ms on average which is awesome. I thought it'd take much longer (100-200ms). I changed the emitter to emit a change event every 30ms and made it so that we copy the haste map only once per window. This gives us 20ms per set of file changes to process changes, which should be plenty for a small number of files (common case).

This PR is now ready to be shipped.
  updated the PR so we don't have to wipe away all snapshots; fixed the failing test.
  The problem is likely that the rollup plugin explicitly doesn't use the ES module transform.

I recommend you to do this:
- Add  `"plugins": ["transform-es2015-modules-commonjs"]` to the `test` env in your `.babelrc`. See https://babeljs.io/docs/usage/babelrc/
- Run jest once with `--no-cache`

If this doesn't work, split up your config into prod and test and then use es2015-rollup for prod and the regular es2015 for testing.
  There is `toMatch` for strings and regexes. Otherwise I recommend using `Array.isArray`. Feel free to add a matcher for `toBeArray()`.
 `expect([1, 2, 3, 4, 5, 6]).toContain(rollDice())`

will work just fine then, right? I don't think we need to add a matcher for this. In the next release, `expect.extend` will be available and you can add your own custom matchers :)
  You must import React in any file that is using JSX. That is unrelated to Jest.
  hey @iamchenxin 
actually we don't use jasmine matchers any more and we have our own `toThrowError` matcher implementation here https://github.com/facebook/jest/blob/master/packages/jest-matchers/src/toThrowMatchers.js#L32
and it doesn't support more than one argument.

alternatively you can use `.toThrowErrorMatchingSnapshot` matcher, that will serialize the whole error and make sure it's matching
 We removed the ability to specify this message in 16.
  Right now we have no plans to change this. We may eventually in the future.
  Our version of jasmine is actually a fork. We have comments in the code though, if you can preserve them, the test should keep passing after the upgrade.
 We'll continue this discussion on the PR.
  We are gonna keep this for now. If you have suggestions on how to not make this confusing for users, I'm happy to review and accept a pull request but it isn't something we'll do from our end.
 Maybe we could add an option in config and CLI, some thing like `hideWatchUsage`? This also bugged me when I try to use watch in my editor's terminal, so maybe lets reopen? 
Especially that it should be easier to implement since watch extraction.
cc: @rogeliog @cpojer  There is already an ENV variable. See https://github.com/facebook/jest/pull/2125 Whoa, I missed that!  Can you try "jest@test" and tell me if this fixes your problem?

On Thu, Nov 3, 2016 at 9:01 PM +0000, "Kent C. Dodds" <notifications@github.com<mailto:notifications@github.com>> wrote:

Do you want to request a feature or report a bug?

bug

What is the current behavior?

In some cases, when source code does stuff with built-in globals like Object, Array, etc. it appears that those built-in globals are not the same as the globals available in the test environment.

If the current behavior is a bug, please provide the steps to reproduce and if possible a minimal repository on GitHub that we can npm install and npm test.

Still working on figuring out a reliable way to reproduce this in an isolated environment... Stand by...

What is the expected behavior?

The globals should be the same in both environments

Run Jest again with --debug and provide the full configuration it prints. Please mention your node and npm version and operating system.

forthcoming...

## 

You are receiving this because you are subscribed to this thread.
Reply to this email directly, view it on GitHubhttps://github.com/facebook/jest/issues/2048, or mute the threadhttps://github.com/notifications/unsubscribe-auth/AAA0KFrQY9PqX0WQIDZNhofPno0mfgBWks5q6kuIgaJpZM4Ko6Wt.
 If you are using the "module" module in Jest, it will get pulled in from the parent context with all the parent built-ins instead of the ones from the vm module. You can think of it like in a browser with an iframe. The "Array" constructor from the parent won't be the same as the one from the iframe, which is why you need to use `Array.isArray` instead of `instanceof Array`. It seems like the same thing is happening here.

Unfortunately I don't see a good way around this. I would recommend to do something like this:

```
const exports = eval(`const module = {}; ${code}; module.exports`);
```

is there a reason that wouldn't work for you and why you'd need to run it as a real module? Another workaround that will work just fine is to do this:

```
fs.writeFileSync('my-file.js', 'my-code', 'utf8');
require('./my-file.js');
```

Closing for now as I don't think we'll add a require-string API to Jest and there is other ways to solve it. Happy to continue the discussion.
 Ah this is interesting. So the problem is that the `vm` module in node doesn't seem to bring its own JSON implementation as I see it. So I have to pull it in from the parent context but then it creates objects with the built-ins from the parent context as well.

I think the best way to solve this is to build a recursive function that updates the prototype, like this:

```
const update = object => {
  if (Array.isArray(object)) {
    return object.map(update);
  } else if (Object.prototype.toString.call(object) === "[object Object]") {
    Object.setPrototypeOf(object, Object);
    Object.keys(object).forEach(key => update(object[key]));
  }
  return object;
}
```

If you can figure out where the JSON built-in is and how to create a new version of it inside of a context, please let me know. Another alternative is to load a json polyfill in your test and do `global.JSON = require('json-polyfill')` which will then be evaluated in the test context instead of the parent context.
 I don't know what `JSON` is that @kentcdodds was referring to.
 Did you upgrade to Jest 18? This should all work now. Would you mind opening a separate issue for that?  I recommend not running eslint on snapshot files. I don't think there is any value in that ‚Äì Jest generates them and you should trust that it generates properly formatted code.

It looks to me like this trailing space actually comes from v8, rather than Jest itself. The code you linked is used to split some stuff up for pretty-printing Jest's output.
  Hey,

this definitely sounds like a very interesting thing to add and I'd be happy to support this in Jest. I don't think we'll be able to spend time on this ourselves at the moment but is this something you are interested in building?

How do you imagine we'd be printing diffs to show they don't match?
 @IPWright please start a PR and ask questions on how to work through the issues! Happy to help.
 @IPWright any updates on this one? @IPWright bump üòÑ  It seems like we aren't moving forward with this for now, so closing this issue. I'd still be excited to see what support for this may look like in Jest, though. Let us know if you are interested in picking this back up. @FredrikNoren this is interesting, can send a PR so we can discuss and iterate on the idea?  I was hoping we could change Jest so that it actually fails the test itself when something is obsolete.
 @develar do you think you could help with a PR? This data could be added here: https://github.com/cpojer/jest/blob/e4220e6659abdc4d6d4500455eb4982d3230dba3/packages/jest-jasmine2/src/index.js#L97

and we could add the `testExecError` to make it print the proper error.  You can create a file and add it to `"setupFiles": ["path/to/setup.js"]` and put something like `global.moment = require('moment');` into it, for example.
 You can point it to your JS file: `require('path/to/moment')`. You can try to do this:

```
require('path/to/moment')
console.log(global.moment);
```

or

```
global.moment = require('path/to/moment')
console.log(global.moment);
```

and see which one works. I'm not familiar with moment myself.
 I would advice against making network connections in your test code.
 It usually leads to slow and flaky tests, which will mean developing your project is slower.
  This is not a support forum, please ask your question on StackOverflow. Thank you!
  Did you reinstall all node_modules, node and whatever else is part of node/jest?
 closing in favor of the other issue.
  @IPWright are you still interested in implementing the feature?
I think @dmitriiabramov could have some input here hey @IPWright 
unfortunately we can't return anything from a matcher function.
the reason for this is:
1. we allow `it` to return only undefined or a `Promise` and disallow returning anything else
2. Implicit arrow function returns will make any test fails
  ```js
  it('111', () => expect(1).toBe(1)); // will fail because `true` is returned
  ```


I think for your case it's easier to use `jest-snapshot` package directly. you can look at how `toMatchSnapshot` is implemented and replicate the same functionality with some extra logic
 Thanks @dmitriiabramov! Closing this then.  thanks!
  thanks! Ideally we'll also recommend a transformer the transforms css the way webpack does. Do you wanna create an example for that? :)
 I think it would be great to have as an option. It's ok for those things to live in the Jest repo but they should be opt-in via the config.

I was thinking of making the `moduleNameMapper` config from the webpack tutorial a default as well. What do you think about that?
 I think a basic jest-css-transform module will be good to have.
  You can adjust `preprocessorIgnorePatterns` to also transform node_modules. The problem with that is that the initial run of Jest is going to be a lot slower, which is why it isn't a default.

In Jest itself, this isn't a problem (we also use lerna): with `npm run watch` we continuously compile changes and every package's `package.json` points to `build/index.js` instead of `src/index.js`. This works really well ‚Äì I suggest using the same kind of setup we have in this repo :)
  I believe that should work?
 heh, good catch ;)
 For now it is fine but we'll be adding some aliases like `jest.any` or something.
 @maximderbin yes, please do it! :)
 @vkrol that wasn't said on behalf of the Jest team. You can use any Jasmine API you like and we'll provide codemods for you to upgrade your API to the new versions once they become available.
  This is fixed on master but I haven't pushed the site yet because the docs were updated for master and not the release version of Jest. Unfortunately we don't have a way to version our docs :(
  Does this still repro in Jest 19?

Closing this issue but feel free to keep the conversation going. Sorry for taking so long to respond.  Jest uses `jsdom` to emulate browser env, so if websockets are needed for Firebase to work and they're not covered in the library, this may be problematic (it isn't for Mocha, because it can run in a browser). 

You can try to mock the websocket somehow, but it certainly won't work for "real-world" testing you're trying to achieve. Please bump the `jsdom` issue mentioned by @TheAncientGoat.

Closing for now.  Confirmed, this is really strange. Maybe `gl` has some issues with running under Node's `vm`? Although it's most probably not Jest-related (but not 100% sure, maybe we run on some edge case here). So for now I'll close the issue but happy to keep the discussion going and reopen if necessary. Does it work with two files when doing `jest -i`? We parallelize across processes, so that may be an issue here? Tested with `-i`, fails too. That's really odd then because that makes it run in process, serially. It may indeed be a gl issue in this case. Let's keep this open until we find proper solution or fix the `gl` lib. Closing due to: https://github.com/facebook/jest/issues/3552 (as a workaround use `--no-cache` flag for now)  You'll have to use `testPathIgnorePatterns` to exclude the file or adjust your testRegex. Currently setupFiles will be counted as test files if they match the test regex.
  Seems like same issue as #1772?
  Thanks for bringing this up. I had this discussion at FB previously with @davidmccabe and the conclusion has been that Flow isn't descriptive enough to make this worthwile. For example if you want to generate a "username" it may be a string of length between 3 and 18 characters excluding special characters but in Flow you can only treat it as "string".

Right now, we (the Jest team) have no interest in pursuing anything related to generative testing because it is pretty slow and we haven't seen adoption at FB. It also strictly seems like something that can be built around Jest and doesn't have to be part of the core. I'm happy to continue the discussion but I'll close this issue as non-actionable to manage our queue.
  Thanks! I'm gonna merge this and then spruce it up a little bit :)  cc @dmitriiabramov 
 hey @danez ! thanks for reporting and providing the repro scenarios!

on the last branch the coverage was indeed wrong, and that was caused by double instrumentation. First the instrumentation by your `.babelrc` and then by `babel-jest`.

the result of this was pretty interesting, because for every statement in the code istanbul introduces a coverage statement. and the second pass, covers the original code, plus the generated istanbul code. this results in some statements coverage being reported twice, for the statement itself (with index `X`) and for another statement with the index of `X` times `2`.
(in the screenshot, statements `11` and `23`, with `23` being the line that should not be marked as covered)
![screen shot 2016-10-29 at 1 02 03 pm](https://cloud.githubusercontent.com/assets/940133/19832455/d5f9b350-9dd8-11e6-959b-babec52955db.png)

i don't know if it made sense, but removing `istanbul` babel plugin form `.babelrc` seems to solve the problem, and the coverage gets back to normal :)
![screen shot 2016-10-29 at 1 10 32 pm](https://cloud.githubusercontent.com/assets/940133/19832473/19aed71a-9dd9-11e6-85d3-a3f750fa61bb.png)
 Also, for now, please run jest with `--no-cache` when you change your .babelrc file. This will not be necessary in the next release any more.
  **Summary**
Long standing "bug" in Jest that was confusing to people and required them to run with `--no-cache` once.

**Test plan**
- Run jest
- Change `.babelrc` to remove all the transforms
- Run jest again; it should now throw whereas previously it would still pass because it used the cache files.

cc @taion @kentcdodds 
 Made it so that during watch mode we don't use the in-memory cache in case `.babelrc` changes while Jest is running.
 It's not actually having any noticeable impact except for more fs access. I'd prefer to keep fs access low on CI runs etc. though.
 soon!
  **Summary**
- More cleanups.
- Removed old deprecation warnings.

**Test plan**
jest
  **Summary**
There appears to be no other way to pull out built-ins from a vm context than actually evaluating them inside of the vm. This takes a bit of code from jsdom and adapts them to set the appropriate globals on the `global` object. This makes it so that `Object` equals `global.Object` inside of a vm context, with the right globals (not the ones from Jest's own context).

Fixes #1597

cc @domenic in case he knows whether there is another way.

**Test plan**
jest (+ will add an integration test)
 Also, it appears that "JSON" does not actually exist inside of a vm context.
 Somehow this doesn't work.

```
require('vm').runInThisContext('global.Object === Object'); // works
global.Object === Object // doesn't work. `global.Object` is still null.
```
 Ok, new version ready. I didn't realize until now that the global object and the sandbox object are actually not supposed to be the same objects.
 Found a much simpler solution. Simply doing `const global = vm.runInContext('this', this.context)` and splitting up global/context works as well. No need to manually write the builtins.
  **Summary**

This PR applies a small change on #1842, prepending instead of appending custom serializers to the default ones provided by Jest. This allows those serializers to work not only on _parts_ of the snapshot, but also on the snapshot _as a whole_, since they are given precedence with respect to the default ones.  This, in turn, allows React components to be rendered not only with the default `ReactTestComponent` plugin, but also with a custom HTML previewer (an idea introduced in #1862).

**Test plan**

Unit test and integration tests are included. Integration tests show that default and custom serializers work, both independently and in tandem.
 thanks!
  hey @Kamaraju333!
what exactly didn't work in your code? was there an error?
 Please ask questions on stackoverflow. Closing this as it is unlikely a bug with Jest itself.
  Thank you!
  We don't support this feature consciously in our require implementation. In the applications we create we would like to be able to statically analyze the dependency tree. Custom module resolution algorithms make this more complicated and require custom tooling. It also breaks `jest --watch` because we cannot reliably find out which tests should be run based on changed files. People have brought this up in the past and the conclusion has usually been that such extensions aren't great patterns.
 You are right, it isn't supported the way you expect. Jest has its own require implementation and we don't support all kinds of things that node.js supports. If Jest doesn't work for you, please feel free to use a different test runner or send us a PR that adds the feature you need ‚Äì then we can discuss appropriate implementations :)
 As said previously, feel free to work on a PR that adds `require.extensions` support to Jest. The require implementation for Jest is part of the Runtime: https://github.com/facebook/jest/blob/master/packages/jest-runtime/src/index.js

Note that if we add this, it is possible that we'll break `jest --watch` for those things that use `require.extensions` but I guess that is an ok trade-off.
  I don't think this is a problem in Jest (as you pointed out). `package.json` is part of node's module resolution algorithm and not using it is going to break a ton of stuff.

If this is fixed in babel-plugin-istanbul and it still doesn't work with `babel-jest`, you can always create your own preprocessor that does the right thing in your case.
 Well, Jest does support it but it seems like our code coverage dependencies have some trouble. Better to fix them.
  Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!

**If you are contributing on behalf of someone else (eg your employer)**: the individual CLA is not sufficient - use https://developers.facebook.com/opensource/cla?type=company instead. Contact cla@fb.com if you have any questions.
 Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks!
 I can live with this.
 Thanks for the contribution!
  This definitely works and it must be something that is wrong with your setup or code. What does your `./src/__mocks__/styleMock.js` look like? Try `jest --no-cache` one time.

I'm happy to reopen if you can provide a repo that shows this issue. Right now we don't have enough information to help.
 Probably a faulty regex. Have you double-check if it's correct? You can use http://regexr.com/ to easily test it  Oh sweeet. @kassens will be so happy.
  Thank you for your pull request. We require contributors to sign our Contributor License Agreement, and yours has expired.

Before we can review or merge your code, **we need you to email cla@fb.com** with your details so we can update your status.
 thanks!
      I think the problem is in how istanbul wraps functional components, there isn't much we can do about it. Are you using enzyme-to-json? That might be the problem.
 Can you try to update Jest? We published a patch to pretty-format that should fix this.
 The problem here is the istanbul coverage transform which makes functions anonymous when it shouldn't :(

See https://github.com/istanbuljs/babel-plugin-istanbul/issues/63 @Velinsky are you using the same version of node? Can you share the differences? It seems like your snapshot may include some some platform specific data.  I added 

```
jest.mock('react-native-linear-gradient', () => 'LinearGradient');
```

to https://github.com/cpojer/jest/blob/master/examples/react-native/__tests__/Intro-test.js#L8

and 

```
import LinearGradient from 'react-native-linear-gradient';
```

to http://github.com/cpojer/jest/blob/master/examples/react-native/Intro.js#L14

and rendered it as `<LinearGradient />` and it worked properly. Seems like you did something wrong outside of the content in the issue you described.
  I'm worried about having to type out `matcherUtils`. It's not really a nice name for a variable, especially when repeated often. Can we call this something else or map it to `this`?

How about:
- `this`
- `this.utils`
- `this.helpers`

Basically I want to make sure we are helping people write pretty error messages. If we make the API more verbose than it has to be, it's not going to be used.

(personal preference: extend `this`)
 i would probably prefer `this`, but we already have 13 utils and a few constants :/
i'll namespace them through `this.utils`
 Closing for #2009
  i agree. when running a single `.only` test it's easy to get lost in all the skipped tests. maybe we should hide it when running a single test file?
 Let's move the discussion here #2169 as @gaearon had the same issue  It's a convention we adopted from our PHP/Hack stack at Facebook. We've used this convention for almost a decade and our CI system looks for files that are specifically inside of `__tests__` folders.

You are free to use `my.test.js` or `my.spec.js` if you'd like.
  Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!

**If you are contributing on behalf of someone else (eg your employer)**: the individual CLA is not sufficient - use https://developers.facebook.com/opensource/cla?type=company instead. Contact cla@fb.com if you have any questions.
 thanks
  Thanks so much for the awesome contribution again, Glenn.

I just noticed that we use this 600+ times at FB. Unless you are prepared to upgrade our codebase I'm afraid we cannot make a breaking change here. How about introducing `jest.mockReset()` instead?

Actually, it sucks this stuff is on the mock objects and not on the jest object. The real versions of those modules may have those functions. I think we could do `jest.resetMock(fn)` ‚Äì this API sounds good and takes the function off of `fn`. `jest.resetMock` can call `fn[ModuleMocker.resetMockSymbol]()` where `ModuleMocker.resetMockSymbol` is a `Symbol('jest-reset-mock')` that is non-enumerable. What do you think about that?
 I don't mind so much of breaking the config option because we don't use it at FB (outside of IG I guess).
 `jest.clearAllMocks()` doesn't clear the module registry. `jest.resetModules()` does.
 Ah, I see what you mean. This was added recently and isn't really used at FB. I'm ok making `jest.clearAllMocks()` reset the mock function state completely.

As said I'm still against changing `mockClear` ‚Äì unless you would like to codemod all of FB (it's fun, actually :) ). Otherwise I recommend adding `mockReset` or `resetMock` or whatever works for you. We can also introduce this new API, codemod everything at FB to use it and deprecate the old one.
 This is awesome. Great work. Who do I have to bribe at FB to allow you to contribute more time to Jest?
 @0xR can you not do `jest.resetModules()` and then re-require your modules?
 @0xR there you go: https://github.com/facebook/fbjs/blob/master/packages/babel-preset-fbjs/plugins/inline-requires.js
  I think it's not a strict requirement. Seems like the default when in yargs (http://yargs.js.org/) is to use `--help` only and I prefer not to add this alias for now.
  I recommend using lerna: https://github.com/lerna/lerna

You should be able to set `testPathIgnorePatterns` to `['<rootDir>/node_modules']` to exclude only the top level folder.
 I tried using this branch and a getting this:

```
 FAIL  dist/decorators.spec.js
  ‚óè Test suite failed to run

    Cannot find module 'must' from 'decorators.spec.js'

      at Resolver.resolveModule (../jest/packages/jest-resolve/build/index.js:150:17)
      at Object.<anonymous> (dist/decorators.spec.js:27:13)

 FAIL  dist/job-executor.spec.js
  ‚óè Test suite failed to run

    Cannot find module 'leche' from 'job-executor.spec.js'

      at Resolver.resolveModule (../jest/packages/jest-resolve/build/index.js:150:17)
      at Object.<anonymous> (dist/job-executor.spec.js:3:14)

 FAIL  dist/math.spec.js
  ‚óè Test suite failed to run

    Cannot find module 'chai' from 'math.spec.js'

      at Resolver.resolveModule (../jest/packages/jest-resolve/build/index.js:150:17)
      at Object.<anonymous> (dist/math.spec.js:3:13)

 FAIL  dist/utils.spec.js
  ‚óè Test suite failed to run

    Cannot find module 'must' from 'utils.spec.js'

      at Resolver.resolveModule (../jest/packages/jest-resolve/build/index.js:150:17)
      at Object.<anonymous> (dist/utils.spec.js:23:13)

Test Suites: 4 failed, 4 total
Tests:       0 total
Snapshots:   0 total
Time:        1.407s
Ran all test suites.
```

doesn't seem like this is related? I can't find these modules anywhere in the tree.
 Can you provide a repro that I can `npm install` that shows which problem you are running into?
 Thanks. You are right, we actually filter out files in `node_modules` folders way before doing any work. This happens here: https://github.com/cpojer/jest/blob/master/packages/jest-haste-map/src/index.js#L302 ‚Äì this option is currently private but if you'd like to send a PR that adds "retainAllFiles" to the "haste" config field and is threaded through to `jest-haste-map` accordingly, I'm happy to support this. It's basically adding the option here: https://github.com/cpojer/jest/blob/master/packages/jest-runtime/src/index.js#L225 ‚Äì check out the contributing guide on how to get set-up!

Otherwise I'd keep suggesting lerna. It's unlikely I'll be able to spend any time working on the fix myself :(
  Thank you for your pull request. We require contributors to sign our Contributor License Agreement, and yours has expired.

Before we can review or merge your code, **we need you to email cla@fb.com** with your details so we can update your status.
 Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks!
 thank you!
  Yep, you are right we should improve this API and that it sucks currently. My hope was that we could make `expect(() => {}).toThrow()` async, but that's not easy either. I don't really like the "plan" functionality so much but we should potentially consider it ‚Äì although it would be a pretty big hack into Jasmine. What do you think is best?

cc @dmitriiabramov 
 yes. this was always a very dangerous thing.
what if we introduce async matchers?

``` js
expect.async(await stuff).toThrowErrorMatchingSnapshot();
```

might also be a default behavior for `expect` to wait if a promise passed.
 It would be `expect.plan`. We already have per-test state, so we can do this.
 Anybody up to make a PR?
 This will be in the next Jest release as expect.assertions(number).  Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!

**If you are contributing on behalf of someone else (eg your employer)**: the individual CLA is not sufficient - use https://developers.facebook.com/opensource/cla?type=company instead. Contact cla@fb.com if you have any questions.
 I didn't really realize that there was a "test-summary" reporter that does exactly what we do in Jest. I send an alternative PR in https://github.com/facebook/jest/pull/1999 that simply removes our custom printing and always uses `test-summary`. It's a little less pretty but it's also less code and the info comes directly from istanbul without having to do anything special :) Thanks for your contribution and for making me aware of this.
  thanks! Let's try this and see how it goes. Jest still needs npm because lerna currently doesn't support Yarn. So we can use yarn for the Jest project and npm through lerna for individual packages.
  Awesome, I was literally about to write the same line of code in `setup.js` just now.
 cc @kentaromiura you'll need to add this to react-native's setup.js as well.
 You can try `jest-react-native@test` and `jest@test`. We'll make a real release next week.
  Thanks @edvinerikson for your contributions. This is great!
  Nice!
  Thank you for your pull request. We require contributors to sign our Contributor License Agreement, and yours has expired.

Before we can review or merge your code, **we need you to email cla@fb.com** with your details so we can update your status.
 thank you so much!
  Is it possible your anti-virus software is invoked on every file system access within your project? Can you try whitelisting this folder and re-running Jest? This is a common problem on Windows.
 On Windows we cannot use either watchman or the `find` binary so we fall back to using node.js to crawl the repo: https://github.com/facebook/jest/blob/master/packages/jest-haste-map/src/crawlers/node.js#L23 ‚Äì if you can send a PR to make any of this faster, that would be awesome!

We have to do this on every startup of Jest, unfortunately, to do static analysis (like for the watch mode or for `jest -o` etc.).
 When Jest prints "RUNS" it means it is already running the code inside your tests. Maybe you can add some instrumentation (`console.time()`, `console.timeEnd()`) there?
 It just looked at it, the test run should certainly complete in less than a second. This is really odd.

Is it at all different if you do `jest -i`? If not, can you try to profile things earlier? Check out https://github.com/cpojer/jest/blob/master/packages/jest-cli/src/TestRunner.js#L1
 Interesting. Are you using npm2? I would recommend to upgrade to yarn or npm3 to install Jest which will result in a lot fewer modules that will be required per context.
 Closing for now as I don't think this is actionable. If there are issues in Jest that we can fix, please comment here or send a PR and I'll reopen this issue.
 Jest does require a ton of modules, yes, but normally that shouldn't take more than ~10ms. The paths very much look like the node_modules folder wasn't deduplicated, which is really odd. You should only have `jest-*` modules on the top level of your node_modules folder. Would you mind wiping away node_modules and installing Jest again? @apieceofbart can you try `testEnvironment: "node"` in the config? The 2s overhead is odd; I'm assuming it is because of loading jsdom.

Jest has to read files from disk to load and run them. What you are pointing to are the pieces of code that executes node modules and user code. It may be that your harddrive is very slow or your anti-virus scanner looks at all the node_modules. If you make an exception for your projects, all your tools may be faster.  Thanks! The "### Workflow and Pull Requests" section lists all the things you mentioned. Would you mind expanding that one instead?
 thanks for updating it and contributing to Jest! I updated it a tiny little bit ‚Äì it's not actually useful to use Jest's own watch mode while developing Jest because chances are you'll need to restart it when you make changes to Jest itself. It gets a bit weird when you are using Jest to test Jest ;)

However, it makes sense to run `npm run watch` in the background to continuously transform changes with babel.
  It seems like watchman somehow got into an inconsistent state and then when you restarted it, it had to first recrawl everything which takes some time. I don't think there is much we can do about this, unfortunately, but it should happen only a single time.

Would you mind letting me know how big your project's folder is? It shouldn't take this long unless your folder is several gigabytes.
 It seems like for whatever reason watchman wasn't watching the current directory but instead the whole user dir. Maybe it is because it tried to start watching before `git init` was called or something similar that signals to watchman that it should watch the specified project.

@wez any idea why watchman might point to the homedir instead of the project's folder?
  Thank you for your pull request. We require contributors to sign our Contributor License Agreement, and yours has expired.

Before we can review or merge your code, **we need you to email cla@fb.com** with your details so we can update your status.
 Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks!
 We publish multiple packages all located in the "packages" folder. You should go into `packages/jest` and runn `npm link` there.
  Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!

**If you are contributing on behalf of someone else (eg your employer)**: the individual CLA is not sufficient - use https://developers.facebook.com/opensource/cla?type=company instead. Contact cla@fb.com if you have any questions.
 thank you!
  In your getTemplates function, where does `userName` come from? First, your example doesn't even use template literals and always returns the same string; second even if it was, it doesn't have a `userName` variable.

It seems like there is something wrong with your setup or there is some confusion about the expected behavior. I don't think this is a bug in Jest because ES features don't determine whether a snapshot is outdated or not. It seems that for some reason your snapshot isn't even being written.

I'll close this for now as I don't think it is a Jest issue but please feel free to come back with a proper repro so we can take a look at this issue.
 Thank you for providing a repro case. I now fully understand the problem you were highlighting. I thought that you were implying that Jest has trouble when persisting snapshots that are created using the template literal and substitution, but rather the issue is that Jest persists snapshots using template literals itself. This means that `${foo}` in a snapshot attempts to be executed as code.
 This will be fixed in the next release. Thanks for the report!
 Mine neither but we made it work and I fixed it, so we can all be happy! Thanks again for reporting the issue and helping us make Jest better. ‚ù§Ô∏è
  #2021 should fix this in the next release.
  i'm worried that most of the rendered components will look broken because their CSS will be missing
  for better error messages!

cc @dmitriiabramov @blainekasten 
 should it be namespaced?

``` js
this.matcherUtils.printExpected(...);
```
 Done! Now we need documentation for how `expect.extend` and matcher utils.
 Oh, shall we also expose `this.deepEquals(a, b)`? I think that is very useful for custom matchers.
 done!
  Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!

**If you are contributing on behalf of someone else (eg your employer)**: the individual CLA is not sufficient - use https://developers.facebook.com/opensource/cla?type=company instead. Contact cla@fb.com if you have any questions.
 thanks!
  When a function throws, the exception bubbles up to the closest try-catch block.

```
try {
  throw new Error('e');
} catch (e) {
  // ‚Ä¶
}
```

your first example doesn't have such a block, so essentially what you are doing is:

```
arrayEquals(‚Ä¶); // throws
```

which throws before calling `expect`. The closest try-catch block is somewhere in Jasmine that will mark the test as failed.

Now you could write your test like this:

```
let error;
try {
  arrayEquals(‚Ä¶)
} catch (e) {
  error = e;
}
expect(error).toEqual(‚Ä¶);
```

but this is a lot to write! Instead, what you can do is wrap your throwing-function with another function and our matchers will then add a try-catch block implicitly:

```
expect(() => { throw new Error('‚Ä¶'); }).toThrow();
```

When `toThrow` is called it does exactly what the previous example above does. In fact, you can check out the implementation here: https://github.com/facebook/jest/blob/master/packages/jest-matchers/src/toThrowMatchers.js#L36-L40
  Thank you for your pull request. We require contributors to sign our Contributor License Agreement, and yours has expired.

Before we can review or merge your code, **we need you to email cla@fb.com** with your details so we can update your status.
 Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks!
 thank you!
 @honzabrecka mind opening a new issue?  I'm pretty sure you just forgot to save your test file. This definitely works, otherwise all of Jest would fail and we wouldn't be able to make a release.

To test, you can try to clone this repo and try one of the examples part of the repo. Let me know if you still can't figure it out.
  Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!

**If you are contributing on behalf of someone else (eg your employer)**: the individual CLA is not sufficient - use https://developers.facebook.com/opensource/cla?type=company instead. Contact cla@fb.com if you have any questions.
 Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks!
  Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!

**If you are contributing on behalf of someone else (eg your employer)**: the individual CLA is not sufficient - use https://developers.facebook.com/opensource/cla?type=company instead. Contact cla@fb.com if you have any questions.
 Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks!
 thanks!
  The documentation is in the `docs/` folder in this repo. Feel free to add the CLI args to the API.md file. You can test the website by going into the website folder and running `npm start`.
  thank you!
  it is probably not jest that is throwing the error, but something in your code that is breaking when you import it.

you should follow the this part of the stack trace to identify what it is:

```
      at node_modules\onsenui\js\onsenui.js:581:11
      at node_modules\onsenui\js\onsenui.js:582:5
      at Object.<anonymous> (node_modules\onsenui\js\onsenui.js:971:3)
      at Object.<anonymous>.React (node_modules\react-onsenui\dist\react-onsenui.js:3:123)
      at Object.<anonymous> (node_modules\react-onsenui\dist\react-onsenui.js:6:2)
```
 I'd recommend trying again with Jest 17.
  Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!

**If you are contributing on behalf of someone else (eg your employer)**: the individual CLA is not sufficient - use https://developers.facebook.com/opensource/cla?type=company instead. Contact cla@fb.com if you have any questions.
 Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks!
 Thanks for the PR! :) There is also the unofficial ts-jest preprocessor: https://github.com/kulshekhar/ts-jest
  Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!

**If you are contributing on behalf of someone else (eg your employer)**: the individual CLA is not sufficient - use https://developers.facebook.com/opensource/cla?type=company instead. Contact cla@fb.com if you have any questions.
  Hey! So we actually used to have this in Jasmine but found that over thousands of test files at FB, nobody used it. So for now we are printing a nice error message with approximate information and a stack trace that will lead to the expectation (just like in your screenshot). I agree we could print the line that throws but quite often the assertion is multiple lines long:

```
expect(a).toEqual({
  ‚Ä¶
});
```

so this wouldn't actually look so good and we'd have to use a parser to parse the JS and extract the relevant info (and collapse long lines) or something similar to make it pretty.

Personally I think we are showing enough information for now but happy to reconsider. If you have ideas for something that isn't very complex but adds more context which helps resolve issues faster, let me know.
 hey @timoxley! we already thought about adding something like this.

so the issue with the first option is that some matchers have optional arguments, and that makes things more complicated.

e.g. here on the second case we won't know if the argument is a proximity or an error message

``` js
expect(555).toBeCloseTo(111, 2, 'reason why');
expect(555).toBeCloseTo(111, 'reason why');
```

second suggestion won't work because the matcher will throw as soon as something does'n meet expectation

``` js
expect(1).toBe(2)/* will throw here */.because('reason');
```

we could attach the reason before the matcher executes, like this:

``` js
expect(1).because('reason').toBe(2);
// or 
because('reason').expect(1).toBe(2);
```

but this API doesn't really look that good.

another option would be to add a second arg to `expect`

``` js
expect(1, 'just because').toBe(2);
```

but it is pretty much the same as the previous option.
 The reason why I think this isn't very useful is because engineers don't want to waste time writing tests. Anything we do to make it harder for them will just lead to worse tests.

In the past, the best solution was actually to create custom matchers. We'll introduce `expect.extend` in the next version of Jest and it will allow you to easily create matchers like:

```
expect(a).toEqualMySpecificThing(‚Ä¶)
```

which should allow you to write more expressive failure messages. I've seen this used a lot in projects like Relay. See all the matchers: https://github.com/facebook/relay/blob/master/src/tools/__mocks__/RelayTestUtils.js#L281
 Closing due to inactivity but happy to reopen if there are good ideas.
 Thanks for keeping the conversation going. Note, that you also don't need the describe block, further making things smaller. `.because` won't work unfortunately because when the matcher throws (which happens before `.because` is called), we won't have a way to extract the name. It would only work if we add it as a second arg of `expect`.
We can't add it as a the last arg for every matcher function because of ambiguity
e.g.
```js
expect(obj).toHaveProperty('a.b.c', 'is that a reason or a value of the property?');
``` @jayphelps we're not using the jasmine way any more since we rewrote all jasmine matchers @jayphelps as i said before, it won't work for all matchers because of the ambiguity.
```js
expect(obj).toHaveProperty('a.b.c', 'is that a reason or a value of the property?');
```
and sing jest matchers can be extended with a third party packages i don't think it's a good idea to mess with the argument list the cleanest option is probably to have it as a second argument of `expect`, since it always takes exactly one argument.
```
expect(123, 'jest because').toEqual(123);
```

i'm not sure if we want to overload the API though. We almost never used it in facebook test suites, and for special cases i think it'm easier to just define a new test:
```js
beforeEach(someSharedSetup);
test('reason or description', () => expect(1).toBe(1));
```

it's just a few lines more :) Or you can even put it into another `describe()` call. Test suites (files) run concurrently, `test()` calls don't. i'm starting to think that something like
```js
test('111' () => {
  jest.debug('write something only if it fails');
  expect(1).toBe(2);
});
```
can be a thing  This will be fixed in #1974.
  hey @biphobe!
this is actually expected, the reason behind this is that jest matchers throw errors and make the test execution stop as soon as something is thrown (this is why `hi` is not logged in TC2)

in Jasmine, matchers don't throw and let the test continue execution with a failure at the end.

what we can do (and probably should) is write an integration between `jest-matchers` and `jasmine` so that if something fails inside an async function, we'll let Jasmine know about it and fail the test at the end.
That will make the assertion error still happen in TC2 and TC3
 we'll do this as part of replacing jasmine. i'll close the issue
  hey @Alivejke!
what version of jest are you using?
we exclude test files automatically in the last version of jest.

also, i think the correct pattern for exclusion would be with the `!` in the beginning (like `'!src/**/*.spec.js'`)
 I'm going to close this because it is unlikely a bug in Jest but rather a config issue. Happy to reopen with a proper repro.
  For this you'll likely need to do something like:

```
jest.mock('Picker', () => {
  const Picker = new String('Picker');
  Picker.Item = 'Item';
  return Picker;
});
```
 In that case I'd do this:

```
const Picker = class extends React.Component {
  render() {
    return 'Picker';
  }
}
Picker.Item = 'Item';
return Picker;
```
 you should instead do this, actually:

```
jest.mock('Picker', () => {
  const React = require('React');
  return class MockPicker extends Component {
    static Item = props => React.createElement('Item', props, props.children);
    static propTypes = { children: React.PropTypes.any };

    render() {
      return React.createElement('Picker', this.props, this.props.children);
    }
  }
});
```
 No. `jest-react-native` was always just an experimental feature until we merged the configuration back into `react-native` with 0.38. From now on, if you'd like to mock RN components, please send a diff for that directly to react-native. This decouples our dependency on RN and makes this solely an RN concern :)  Ah dammit. If you update Jest-cli and all Jest deps to 16.0.2 it should work again.

On Thu, Oct 20, 2016 at 6:27 PM +0900, "Andy Tyurin" <notifications@github.com<mailto:notifications@github.com>> wrote:

Have seen same bug, please update https://www.npmjs.com/package/jest-clihttps://urldefense.proofpoint.com/v2/url?u=https-3A__www.npmjs.com_package_jest-2Dcli&d=DQMCaQ&c=5VD0RTtNlTh3ycd41b3MUw&r=aFhQMFmdCAmrM__WP0c73w&m=8FdrA_-x354wSAAHM0mhlIw6lk97iVMtCil3NuctTfI&s=FPbevu0AYBUL99BakaCY6dlsDT1_KUhE2cYgkCdJHsc&e= to v16.0.2.

## 

You are receiving this because you are subscribed to this thread.
Reply to this email directly, view it on GitHubhttps://github.com/facebook/jest/issues/1959#issuecomment-255055531, or mute the threadhttps://github.com/notifications/unsubscribe-auth/AAA0KG_q49u7SMxJj5G4CqfbFLdz0anIks5q1zPOgaJpZM4Kb4qG.
  This doesn't seem to be a problem with Jest if changing how enzyme renders your React component crashes, is it? Can you provide a full repository with a repro?
 This should be fixed in Jest 17.
  Yes, we changed the resolution algorithm a little bit: https://github.com/facebook/jest/pull/1723 ‚Äì we also mentioned it in the changelog. Sorry it caught you by surprise!
  thank you!
  Thanks for your PR. Unfortunately I don't think we should add this to Jest right now. I'm happy to support it if `jsdom` chooses to add this but otherwise I'd prefer to recommend people to put this into their own `setupFiles` for now.
  Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!

**If you are contributing on behalf of someone else (eg your employer)**: the individual CLA is not sufficient - use https://developers.facebook.com/opensource/cla?type=company instead. Contact cla@fb.com if you have any questions.
 Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks!
 @benmccormick check here: https://github.com/facebook/jest/blob/master/packages/jest-matchers/src/spyMatchers.js#L72
 That should be somewhere around here: https://github.com/facebook/jest/blob/master/packages/jest-matchers/src/index.js#L55

we rewrote this matcher completely as we are trying to kill parts of Jasmine that we don't like :)
 that makes sense! Thank you.
  This is something we cannot actually do anything about if you are on a case-insensitive file system. Node has the same behavior ‚Äì doing `require('add')` vs. `require('Add')` will actually give you two different copies of the same module.

cc @wincent who ran into this at FB.
 (Jest in open source also comes with its own require implementation, not just at FB.)

My conclusion at the time when @wincent proposed his RFC was that this is not something that Jest should have to think about. You could build a static analysis tool for this if you'd like to but it definitely falls into the category of linters, rather than test frameworks.
 I totally get what you are saying Blaine. As I said, I do believe it should be part of a linter and I can see it become a default in popular default lint configurations.

However, since other require implementations work the same way, I'm not inclined to change Jest. We aim to be compatible and there may be legit (although crazy!) reasons why people may do this right now. I've seen everything in the node ecosystem ;)
  Thank you for your pull request. We require contributors to sign our Contributor License Agreement, and yours has expired.

Before we can review or merge your code, **we need you to email cla@fb.com** with your details so we can update your status.
 Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks!
 thank you!
  nice fix!
  Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!
 Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks!
 In react-native, the resolution looks something like this: https://github.com/facebook/react-native/blob/master/packager/react-packager/src/node-haste/DependencyGraph/ResolutionRequest.js#L442

I think this workaround with extensions is clever but I'm worried about diverging behavior. Can you think of any problems this might introduce?
 Also, can you add an integration test for this behavior?
 I'd prefer to create a folder in the `integration_test` top level folder. In there you can add a `package.json` with the `"haste"` field and `"defaultPlatform"` field.

Then we have `integration_test/__tests__` (see other files in there for how it works) which use Jest to run Jest (I know, jestception!). That is usually the best way to test this behavior.
 The resolution algorithm I linked to above looks like this:

```
1. If the file exists as specified, return it. require('./Foo.js') will require Foo.js directly.
2. If the platform is specified, for require('./Foo'), check whether Foo.<platform>.js exists
3. Check if Foo.native.js exists
4. Otherwise, try Foo.js
5. Last attempt: Foo.json
```

See the code here:

```
      if (this._fastfs.fileExists(potentialModulePath)) {
        file = potentialModulePath;
      } else if (this._platform != null &&
                 this._fastfs.fileExists(potentialModulePath + '.' + this._platform + '.js')) {
        file = potentialModulePath + '.' + this._platform + '.js';
      } else if (this._preferNativePlatform &&
                 this._fastfs.fileExists(potentialModulePath + '.native.js')) {
        file = potentialModulePath + '.native.js';
      } else if (this._fastfs.fileExists(potentialModulePath + '.js')) {
        file = potentialModulePath + '.js';
      } else if (this._fastfs.fileExists(potentialModulePath + '.json')) {
        file = potentialModulePath + '.json';
```

I think we need to make sure that jest-resolve does exactly the same. Right now it skips 2 and 3 so we need to make sure jest-resolve considers them in the right order.
 This is great! Thanks for all the work. It seems like `resolve` does check extensions based on the order, so that's good!

https://github.com/substack/node-resolve/blob/master/lib/sync.js#L40
  oh hello, @LegNeato! Good to run into you.

I don't think I'd like to support this weirdness in the module loading that `node-forge` does. I recommend building a manual mock for it or sending a PR to the maintainers of `node-forge` to provide a better versions that uses CommonJS properly. This will make it work with Jest automatically.
  Not needed any more as we only care about perf on Node 6: https://github.com/nodejs/node/pull/5123
  thank you! This might be fun to update at FB‚Ä¶
  I believe this should be fixed in the next release of Jest. Try `jest@test` for now.
  Try `jest --no-cache` one time. This should be fixed with #2023.
  thank you <3
  Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!
 Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks!
 I really like this! I'll get back to reviewing this tomorrow :)
 i actually disagree that the second example is more readable.

first example is 3 lines and it's dead simple, you have one thing and you expect it to not be equal to another thing.

on another hand, second example has two extra function arguments that is always harder to work with than with primitive values, plus implicit compare of the values returned by the second function.
I was not able to understand what exactly is going on until i looked at the source and saw that the second function is called twice.
 @dmitriiabramov brought up some good points. I think this matcher is a good idea but I don't think we necessarily need to ship it as part of Jest. Once we merge #1933 it'll be easy to add this matcher yourself.
 i think things like that are awesome in small/medium projects or on relatively stable teams, but they will definitely increase the ramp up time for the rest of us :)
it would be cool to have a separate package (`jest-awesome-matchers` or something) that provides all those neat things that you could just plug into jest
 #1933 was merged and will be part of the next release.
  I'm unsure what the problem here is. Maybe on windows manual mocking doesn't work as well as it should? :(
 @frevib with babel-jest and the es-modules transform, imports will be compiled to CommonJS, so that isn't the issue here.
 @dYb is this still an issue with Jest 17? @dYb as a rule of thumb, you should always keep Jest's helper packages (like `babel-jest`) in sync to the major version to avoid such problems. There's no way for one package (e.g. `"jest": "17.0.3"`) to update another one in your `package.json`. You need to do it manually (or use some kind of CLI which will do it for you, but unfortunately we currently don't have anything like that for Jest).

It's very similar case for updating `react` to the next version ‚Äì you also bump version of `react-dom` and, let's say, `react-addons-test-utils` to the same major version, to avoid inconsistencies between two incompatible versions.  @dYb it definitely has to be updated! @frevib is already working on that.
Thanks for catching that up :)  Fastpath is only useful to speed up the `path` module in versions of node prior to 6. Now that most people have migrated to 6 and we have migrated to it internally at FB, we can drop this dependency.
  Proxyquire is not necessary with Jest. Jest brings its own require implementation and you can stub out modules using `jest.mock` and similar. See http://facebook.github.io/jest/docs/api.html
 Switching test frameworks is not a "drop-in" kind of thing. You should carefully evaluate what makes sense for you and make the necessary updates to your codebase to support your new choice.
  We were hoping to build an interactive mode for Jest where it will ask to update each snapshot individually. Would that solve your problem?
 @JakeGinnivan since Jest 17 larger diffs are shown in a form of [a patch](https://github.com/facebook/jest/pull/1894#issuecomment-252425110), so I think we're on a good track. 
@cpojer Should we create a separate issue for interactive snapshots update mode and maybe continue there? Yeah, let's put that in a separate issue. It's on our plans for Jest but I don't know if we'll get to it anytime soon.  Thank you for your pull request.  As you may know, we require contributors to sign our Contributor License Agreement, and we don't seem to have you on file and listed as active anymore.  In order for us to review and merge your code, please email cla@fb.com with your details so we can update your status.
 Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks!
 thank you!
 Awesome thanks!
  `preprocessorIgnorePatterns` overwrites the configuration from the preset. You'll need to exclude `react-native` from it, as well:

```
"preprocessorIgnorePatterns": [ "/node_modules(?!\\/(react-native|redux-request-state|redux-data-fetching))/" ]
```
  This does look good. Would you mind polishing it up so we can ship it? :)

cc @dmitriiabramov 
 this looks good! There is a few things we'll need to clean up in www before we can land it (custom equality) but i remember that it wasn't that complicated.
(sorry for the long response. long vacation :/)
 We can land it before cleaning up our internal code. We'll just update everything at FB the next time we release a version of Jest.

We should also find a way to expose `matcherHint` etc. so that messages can be pretty-printed, but that can be done in a separate PR.
 thanks @blainekasten. The last iteration I think you might not have run locally yourself ( :P ) but I spend some time polishing it and will merge in a moment.
  hey @mark0978!

the correct usage would be like this:

``` j
jest --collectCoverageFrom='["packages/**/index.js"]' --coverage
```

single quotes around json and double quotes inside json.

it's complicated because there's no easy way to pass an array through yargs and we have to pass a serialized json instead :(
 @dmitriiabramov can we add this here: http://facebook.github.io/jest/docs/api.html#jest-cli-options ?
 absolutely!
https://github.com/facebook/jest/pull/2010
  I think the way logging works in Jest is fine. If you'd like to change this, I will appreciate any PRs or custom libraries on top of Jest that support your use case well.
  Hi @tjmehta, happy to review PR if you're interested in implementing that :) Closing this in favour of PR I'll keep this open for now, we may want to discuss this a bit more. Oh, ok, thought we'd do it in a PR Sorry, just haven't thought about this myself much yet but I'm thinking this issue may go beyond the PR a bit. We'll see :) Don't be sorry, thanks!   When there is a Babel syntax error, there is no use printing its stack traces:

<img width="990" alt="screen shot 2016-10-13 at 19 22 30" src="https://cloud.githubusercontent.com/assets/810438/19361408/768a7450-917a-11e6-8872-8867e7e65081.png">
 This is another beautiful one:

<img width="1135" alt="screen shot 2016-11-24 at 19 54 31" src="https://cloud.githubusercontent.com/assets/810438/20609056/e37b6cc4-b27f-11e6-979b-9a87abba83ad.png">

I‚Äôm going to tweet this so maybe somebody contributes. :-) Unfortunately I'm not very familiar with internals but I think you'd need to find the place where Jest calls its transformers (Babel is one). The fix would either be in that place, or in the transformer itself (`babel-jest`), depending on where the error is being turned into a string. We want to preserve the message but drop the stack trace. You can catch it here when we call a transformer: https://github.com/facebook/jest/blob/master/packages/jest-runtime/src/transform.js 

Note: I believe all the code here: https://github.com/facebook/jest/blob/master/packages/jest-runtime/src/index.js#L461 is outdated and doesn't run, which is one reason why syntax errors aren't super helpful right now.  Yes, manual mocks take precedence over node modules. The manual mocks system is a bit sketchy. For now, we are removing the warning in the next release, so `jest.unmock('left-pad')` should be all you need. See #2022

One idea we had was to make a separate system for manual node module mocks but that should likely be discussed in a separate proposal, so I'll close this issue out.
  `cd packages/jest-cli; yarn link`

`yarn link jest-cli`

should work.

Otherwise:
`npm run build` in Jest and `path/to/packages/jest-cli/bin/jest.js` in your project should work.
 I believe calling `vm.runInContext` so often is going to be really slow. My alternative proposals were going to be:
- Run the entire jest-mock code inside of jest-runtime using `const ModuleMocker = runtime.requireInternalModule(require.resolve('jest-mock'));`. This should be pretty straightforward.
- Use `Object.setPrototypeOf(obj, environment.global.Object)` etc. on everything that's created using jest-mock.

What do you think about these approaches?
 Ide, are you going to follow up on this? The first proposal seems good to me.

I'll try to fix the globals issue.
 Can you do, in this file: https://github.com/cpojer/jest/blob/master/packages/jest-environment-node/src/index.js#L78

```
const JEST_MOCK_PATH = require.resolve('jest-mock');
const mockScript = new vm.Script('const module = {};' + fs.readFileSync(JEST_MOCK_PATH), {filename: JEST_MOCK_PATH});

const ModuleMocker = script.runInContext(this.context).exports;
this.moduleMocker = new ModuleMocker;
```

I think something like this should work.

Also see #2021.
 thanks for sticking with me and updating this! I think this solution is way better :)
  Unfortunately that's a problem in istanbul: https://github.com/istanbuljs/babel-plugin-istanbul/issues/63
  You need to return a promise to make the test wait for it. Right now you are simply invoking async work but not waiting for its completion.

See http://facebook.github.io/jest/docs/tutorial-async.html#content
  thanks!
  thanks!
  @wberty thanks for your report. We discuss the same issue here: #2166.  thank you.
  Are you actively working on this? Do you need anything from me?

My only request is to make it so that if `scriptPreprocessor` is used, we throw an error and tell people how to upgrade. We've done this before and it has helped people upgrade quickly :)
 @jsynowiec In Jest 15 we introduced pretty error messages for this sort of thing: https://facebook.github.io/jest/blog/2016/09/01/jest-15.html

We'll also keep supporting `scriptPreprocessor` with an upgrade warning for now because that's easier than breaking everyone.
 damn, solid work @keyanzhang.
  thank you! Would you mind letting me know how you ran into this? Jest doesn't use this itself.
 I love everything you guys do on Instagram <3
  Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!
 thank you!
  Jest actually only runs the given test file if the path is given and has a small optimization there. The slowdown you experience during startup is very likely other static analysis that Jest is doing. As discussed previously, installing watchman (`brew install watchman`) should significantly improve startup time of Jest on large projects with 100000s of files.

I don't think we'll change this pattern API in the cli as it is really useful.
  try `jest-react-native@test` and `jest@test`. We'll publish a new tagged release soon.
 The latest version of jest-react-native should work just fine. Simply install the 16.1.0 version of it.
 jest-react-native is outdated. Simply use `react-native` as a preset.  We'll keep iterating on #1947. Thank you for your pull request!
  Duplicate of #1650.
  cc @dmitriiabramov 
 TypeScript support in Jest is not "officially" supported by us. I recommend using `ts-jest` like @kwonoj mentioned. As somebody pointed out above, if the preprocessor prints code with different line numbers etc., Jest cannot do the proper remapping on its own so this is strictly out of the scope of Jest.

@kwonoj feel free to send PRs to solve any of the problems you outlined above if that will help you have better coverage support.
  #1876 should fix this.
  Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!
 Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks!
 thank you <3
  Can you provide a repro? Jest does sometimes decide to run tests serially if it thinks it will be faster than parallelizing them (which has a fixed startup cost associated to them per process).
 This is the heuristic where we decide: https://github.com/cpojer/jest/blob/master/packages/jest-cli/src/TestRunner.js#L220

We could change it so that what `jest.js` ( https://github.com/cpojer/jest/blob/master/packages/jest-cli/src/jest.js ) passes in as maxWorkers is annotated with whether it was specifically specified by the user or not. If the user provides it, we can use it as an override.

What is the reason you need this feature, though? If Jest thinks that running tests in the same process is faster, then that's a good thing, no?
 Ping: @jonathanong are you going to send a PR to make this overridable? :)
 @develar can you share your changes? 20 minutes is obviously not acceptable but also probably means that there is a lot of I/O going on. Jest has a `test.concurrent` API to make tests that access network resources within one file parallel.
 I see! Can you run a second time and share whether it is faster then? As @jonathanong pointed out in this issue it may make sense to make Jest's heuristic overwritable for this case so that it always uses many processes.
 Merged @develar's PR to not run in band on the first run.  I guess `automatically loaded` was supposed to mean that you still have to install it but it will be loaded automatically.
  `rootDir` limits where Jest looks for anything, including mocks. It is simply a side-effect of the node module resolution algorithm that requiring node_modules up to the root of your filesystem. If you specify your `rootDir` as `src`, please put your `__mocks__` into `src` as well. I'll consider updating the docs a bit. Thanks for bringing this up!
  @orta I'm totally happy to support this if you send a PR. If the data is big and takes a lot of time to calculate, I'd prefer it to only happen with the verbose flag. Otherwise, if it's quick to compute and not that much more info than we already have, feel free to expand the existing `--json` behavior with all the information you think is valuable. We can then discuss on the PR about specifics :)
 I'm going to close this issue because by itself it isn't actionable and it isn't on our internal roadmap. Please feel free to keep sending PRs and extend the `--json` output as you see fit.
  It's a known bug, where unhandled async errors crash Jest, moving discussion here #2059  You need to update your node_modules, like babel. `npm run clean-all; npm install`
  Can you provide a repo that we can npm install and npm test to take a look?
 @pavloko Your repro on Jest v15 works fine. You can easily migrate to Jest v17 by replacing `scriptPreprocessor` with:
```js
"transform": {
  "^.+\\.(ts|tsx)$": "<rootDir>/config/jest/preprocessor.js"
},
```  This'll definitely need some heavy tests :)
 Awesome work btw.!
 We should also add an option `--expand` or `-e` to overwrite printing and make the printing longer. It might be hard to get the config option all the way into jest-diff though‚Ä¶
 this diff is amazing! super excited about this feature
  I've done a little research on this one, but not deep enough.

Indeed we seem to leak some memory here. But it's not because of `babel-polyfill` for sure (it just makes the heap grow faster, like @turadg noticed).

Tried to profile this with Chrome DevTools, but it didn't show timeline for Allocation Timelines and I didn't have too much time to wonder why.
```
node --expose-gc --inspect `which jest` --logHeapUsage -i
```

Any help on this one is highly appreciated! When using babel-jest and when babel-polyfill is available, Jest will load it automatically. babel-jest is used as a dep of jest-runtime Further investigation: the suspect is `jsdom`.

When running Jest with `jsdom` environment, the Runtime object doesn't get swiped by gc.
On the other hand, when `--env=node` Runtime is properly garbage collected.

Below are results after running couple of hundred tests:
`--env=jsdom`:

<img width="1483" alt="screen shot 2016-12-14 at 22 47 09" src="https://cloud.githubusercontent.com/assets/5106466/21202603/5391f652-c24f-11e6-9d66-058bc3c64b65.png">

`--env=node`:

<img width="1483" alt="screen shot 2016-12-14 at 22 47 23" src="https://cloud.githubusercontent.com/assets/5106466/21202604/53932cb6-c24f-11e6-8935-19ac854fa88e.png">

Since `jest-environment-node` and `jest-environment-jsdom` are nearly identical, it makes it even more probable, that `jsdom` is to blame here, although I'm not 100% sure. Do you know what exactly is being retained or what kind of stuff may lead to cycles? We may want to unset more things in the `dispose` method here: https://github.com/cpojer/jest/blob/master/packages/jest-environment-jsdom/src/index.js#L19 Update: Managed to separate the case with `jsdom` only and filed an issue there: https://github.com/tmpvar/jsdom/issues/1682
Feel free to help debugging this üòÑ  95% drops are interesting, I have experienced some drops, but not this big, and the stack was still growing fast. 
I've did a quick test and it looks like on `--env=node` it grows stack in similar fashion when paired with `babel-polyfill` (comparing Node env + polyfill with JSDOM env without), so maybe there's something shared about these two? I'm wondering: do we even need babel-polyfill in recent versions of Node? Shall we just not load it (except for regenerator, which we may still need). Are you sure `jsdom.env` fixes the problem for you? I've changed `jest-environment-jsdom` locally to use it once and didn't see better results. Jest disposes `jsdom` (calls `window.close()`) not in the same tick. also wrapping the close() method in setTimeout didn't help. 

BTW, I appreciate your help on investigating that so much, thank you! Sure I have tried that and it indeed worked for me (but didn't check in the inspector). I need to find some time to test it better in Jest, because last time it was a really quick check, where I could miss something! @jakubzitny thanks for sharing your story!
I'll try to make this issue a priority for the next couple of days. The difference is probably that in mocha, everything is within one context. In Jest, every test has its own context and is isolated from each other. It seems like it creates some cycles that can't be GC'd, unfortunately. UPDATE: I'm not yet sure why, but just tested it on latest master build with and without `babel-jest` and the leak is gone, so it was probably somewhere on our end. This was fixed accidentally with this commit https://github.com/facebook/jest/commit/8256904751d85e16909152ddaf8395d7c2b60eba and I have no idea why this works, seriously. 
Anybody have any ideas? Maybe it's some kind of weird edge bug in Node. I wish this was that simple. Try running `env.dispose()` in the next tick and see the results. This is weirder than it seems It will land in Jest 19. We plan to release it in a week. This should be fixed now for the most part, right? :) I apologize. I forgot to merge https://github.com/facebook/jest/pull/2755 into the release (honestly I thought I did), it will be part of the next release. No, there is no fixed release schedule here. There may be one next week. Can you try `jest@next` for now and see if it helps?  @cpojer's time off mainly. Although there's a chance we could roll out 19.1, but @dmitriiabramov is the one to decide. @mlanter @jedmao I encourage you to debug your tests with `--inspect` flag for Chrome Debugger and try to figure out where the leak may come from (it's likely something in your tests). To simulate slow CI environment, you can throttle the CPU a bit:

<img width="267" alt="screen shot 2017-05-16 at 08 42 18" src="https://cloud.githubusercontent.com/assets/5106466/26092869/9bc8b7da-3a13-11e7-81c9-31e5266f3594.png">
  Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!
 thank you!
  Would you mind sorting them appropriately and sending us a pull request? :)
  @lachenmayer is this still happening with Jest v17.0.3? Right. So we're normalising newlines `\r\n`, but we don't do that for single `\r` char. 

@cpojer should we rather escape `\r` not followed by `\n` or treat it as a newline anyway?
Second thing would be probably as easy as adjusting `normalizeNewlines` to this:
```js
const normalizeNewlines = string => string.replace(/\r\n|\r/g, '\n');
```

and would also be a `good first bug` case @thymikee sounds reasonable to me! cc @jsomsanith who was interested in sending a PR in his free time.  @rubenmoya run the test suite and send a PR üëç  You need to install `hg`. Read [CONTRIBUTING.md](https://github.com/facebook/jest/blob/master/CONTRIBUTING.md) on how to setup everything. These are unrelated, you can fix them by doing `brew install hg`. Closing this in favour of PR  any file will be excluded from coverage if it's outside `cwd`. we pass `cwd` to istanbul here https://github.com/facebook/jest/blob/master/packages/jest-runtime/src/transform.js#L251

if cwd is not the project's root then it means something is not setting `rootDir` properly. which i believe is here https://github.com/facebook/jest/blob/master/packages/jest-config/src/index.js#L42

@cpojer do you have an idea what could go wrong?
 @PhillMcKraken ah! that's it! 
thank you for finding this! do you mind sending a pull request with this change?  @cpojer we should probably validate if the module passed to `moduleNameMapper` actually exists @lindgr3n awesome!
Yea, I think this is a good place for this. You can throw ValidationError from `jest-validate` package for nicer formatting of the message. We can discuss the details after you send a PR (ideally with a test) üôÇ   thank you!
 Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!
  Global and local versions are the same 
 This seems like an npm problem, not a Jest problem.
  This will be fixed in the next release. Yay!
  Your react-native version is outdated. Please update it to 0.32+ to work together well with Jest.
  Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!
 Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks!
 ok! I don't feel so strongly about this as we are planning to provide a default solution automatically soon.
  Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!
 I'm assuming that second module.exports was supposed to be gone? :)
 thank you!
  We added some docs for the CLI options.

I think the workaround @tizmagik provided is reasonable. You can also specify a config as a string, like `jest --config='{"testRegex": ‚Ä¶}'`.
  thanks!
  Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!
 Nice. Thank you so much for the fix! I left a bunch of inline comments.
 You should definitely restore `fs.writeFileSync = writeFileSync;` in `afterEach`. Otherwise stuff might get messed up later.
 awesome! Thank you for the fix.
  would you mind creating a complete repro that I can npm install and npm test? Otherwise it will be hard to repro this.
 @scwood have you got any updates on this? 
It looks like the issue is in how mongoose/mockgoose is used. 
May be related: #2167  Let's close this one then and continue there  closing in favor of https://github.com/facebook/jest/pull/2104
 @nickpresta yep! should go out soon
  why would directly mapping to your proxy project not work?
 ok I'm gonna merge this. I really believe we need a `transform` config option like we talked to and have some better out-of-the-box support for this, though.
  seems like @Daniel15 ran into this at FB too.
 Yeah I encountered the same thing, but very sporadically (maybe 1 in 30 or 40 test runs). It's failing at the exact same location (`transform.js:284:10`) every time 

```
    /..../html/shared/react/renderers/dom/client/eventPlugins/SimpleEventPlugin.js:274
    }});
      ^
    SyntaxError: Unexpected token )

      at transformAndBuildScript (scripts/jest-config/node_modules/jest-runtime/build/transform.js:284:10)
      at Object.inject (html/shared/react/renderers/dom/shared/ReactDefaultInjection-core.js:61:19)
      at Object.<anonymous> (html/shared/react/renderers/dom/ReactDOM-core.js:28:34)
```
 the only race condition that might take place i can think of is writing the same transformed file to cache at the same time from two different child processes.

``` js
fs.WriteFileSync(cacheFilename, transformedSource)
```

can that be the case?
 i tried to debug it and stress test with multiple concurrent writes and wasn't able to reproduce. What i noticed is that it almost never happens on hot cache. What happens on our CI servers is that we get this failure on the first day after we check in a new test, and then it goes away after a few days. This is unrelated. It seems like lodash-es is not compiled to ES5, therefore you need to either import regular lodash or whitelist lodash-es so Jest can compile it with babel or other compiler of your choosing, look here for details http://facebook.github.io/jest/docs/en/tutorial-react-native.html#transformignorepatterns-customization Oh, sorry then!  I'm unsure whether this is an issue with Jest. I'm not very familiar with rxjs. How does Observable deal with thrown errors in a test? `expect` in Jest throws directly so you need to handle that and call `done.fail`.
 Hi @mmcgahan, 
Jest (still) uses Jasmine under the hood, so I wonder if using `TestScheduler()` helps here? https://github.com/Reactive-Extensions/RxJS/blob/master/examples/testing/jasmine/spec/SelectSpec.js @brownbathrobe this is actually expected behaviour, since `expect` is a throwing function (@cpojer mentioned it here https://github.com/facebook/jest/issues/1873#issuecomment-258840638) and if it throws, it does it directly, so your `done` callback is unreachable. 
That's why in async code using `done` you need to handle `done.fail()` also, e.g. in a `try/catch` block.

This is how things work with Jasmine (our test runner) and I think we can't do much about it currently (unless we rewrite it).

But if you're testing a promise, the problem is gone when you return it (but you mustn't use `done`):

```js
test('failing `Promise` test does time out', () => {
  return Promise.resolve().then(() => {
    expect(false).toBe(true);
  });
});
```

I'm closing this issue in favour of https://github.com/facebook/jest/issues/2059 where we discuss how can we change this behaviour to always catch the errors.  If that's all you care about, did you think about doing `jest --json | node processJestOutput.js` with a custom script that prints data from the JSON result?

I'm happy to support a minimal output. What exactly are you looking for? Would you be willing to work on a PR for this? The reporter interface is pretty easy to work with nowadays (thanks to @dmitriiabramov). Basically getting rid of the default reporter here: https://github.com/cpojer/jest/blob/master/packages/jest-cli/src/TestRunner.js#L374 or changing the default reporter to only show the progress bar/time should be doable :)
 I'm going to close this out as it is not currently on the roadmap and there hasn't been any progress on this issue. Let me know if you are picking this up ‚Äì I'm happy to point you in the right direction and reopen this issue :)  It seems like the docs are outdated. We don't actually support jasmine1 in Jest any more and dropped it with version 14 or 15.
 publishing a new version of the website now.
  Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!
 Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks!
 Hey, sorry, I've been busy with Yarn (see https://code.facebook.com/posts/1840075619545360 ). I'll look at this soon.
 merged! :)
  Duplicate of #1392.
  The reason we disabled it wasn't just node but also istanbul which doesn't guarantee that function names stay the same when it adds coverage transformation. If you can get them to fix that, I'm more than happy to add an option back. Otherwise I'm afraid it will always cause trouble and I'm not excited to support something that is half-broken half the time.
 yes, but the snapshot tests will all fail because the function names aren't the same as in non-instrumented code.
 Yes, the assertion you have makes sense to me. As I pointed out earlier, using the function names in snapshots is not really great.
  It seems to me like some of your test files are actually crashing Jest or calling `process.exit` or similar. Would you mind making a repo on github that highlights the issue you are running into?
 @janaz I can't reproduce this error. I get the same exact output for both commands on Jest 16 and 17, Node v4.6.2 and node v6.9.1. Are you still experiencing the issue? Closing this to manage the queue, but happy to reopen if necessary.  Thank you for your pull request.  As you may know, we require contributors to sign our Contributor License Agreement, and we don't seem to have you on file and listed as active anymore.  In order for us to review and merge your code, please email cla@fb.com with your details so we can update your status.
 Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks!
 thank you for the fix! This is great.
 I published 16.0.1 right after I merged this. Would you mind letting me know which CI system you noticed this one? Jest's travis runs were always fine but I have an internal project that uses travis with osx (I believe) and I saw a memory leak error from node as soon as Jest started ‚Äì this change seems to have fixed that. Can you confirm you saw the same?
 Would you mind pasting the exact error so I can confirm this fix is also the one that fixed my issue? :)
 Yep, exactly what I saw and it's fixed now. Phew!
  16.0.1 was published. Thank you so much for the fix. ‚ù§Ô∏è
  ## Summary

I find the new snapshot testing feature of Jest awesome and I blogged about it in [Picture this: snapshot testing ‚Äî Jest, reloaded](http://guigrpa.github.io/2016/09/27/picture-this-snapshot-testing/).

While working on adding tests to my application [Mady](https://github.com/guigrpa/mady), I thought that the snapshot workflow may improve if the snapshots could be reviewed _graphically_, especially when they are created (but also after updates). This would not replace, but rather _complement_, a careful review of the text-based snapshots, which obviously contain more information.
## Included in this PR
- A `pretty-format` plugin that generates HTML code for React elements from `react-test-renderer` input (`ReactTestComponentToHtml.js`). For this conversion, several React white lists have been used, as well as `hyphenateStyleName()` from `fbjs`.
- An HTML previewer that generates a static `.html` file with the HTML snapshots corresponding to a `.snap` file (allowing the user to review each one of them separately). The lifecycle of the `.html` files is parallel to the corresponding `.snap` files: they are created and deleted at the same time.
- Updates to `jest-snapshot`'s `utils.js` and `State.js` to save the HTML preview alongside `.snap` files
- Limited unit tests (more could be added)

**Note**: when snapshots do not correspond to React elements, they still trigger the generation of the HTML preview. Snapshots are in this case wrapped in `<pre>` tags and inserted in the template.

**Note-2**: additional dependencies (`fbjs/lib/hyphenateStyleName`, `escape-html`) can be inlined if deemed necessary.
## Examples

Some **examples** of HTML previews generated for Mady with this PR:
- [Example 1 - form](https://rawgit.com/guigrpa/mady/master/src/client/components/__tests__/__snapshots__/080-settings.test.js.html) -- this preview contains only one snapshot (I believe this is much easier to validate than the textual snapshot)
- [Example 2 - tabular component](https://rawgit.com/guigrpa/mady/master/src/client/components/__tests__/__snapshots__/060-translator.test.js.html) -- multiple snapshots for the same component (note that the `TranslatorRow` component is mocked)
- [Example 3 - non-React snapshot](https://rawgit.com/guigrpa/mady/master/src/server/__tests__/__snapshots__/parseSources.test.js.html) -- in this case, the raw snapshot is shown
## Envisaged next steps

Beyond this draft, but included in the PR, I envisage:
- Adding further unit tests (please advise on priority areas)
- Removing HTML snapshots generated during Jest's internal tests (please advise on how this can be done)
- Adding a configuration flag to disable generation of HTML snapshots (although I believe they should be enabled by default)
- Allowing the user to inject CSS in the snapshot preview, so that it more closely resembles the real application. In some of the Mady examples above, this would allow (Font Awesome) icons to be shown

Beyond the scope of this PR, but related:
- Help to integrate the new functionality with the more granular, interactive snapshot-by-snapshot approval process proposed in #1798, #1328 and in [Ben McCormick's post](http://benmccormick.org/2016/09/19/testing-with-jest-snapshots-first-impressions/). For example, Jest could automatically open in the default browser the HTML previews for the snapshots that have changed.
 @suchipi Thanks for the feedback! Regarding PNG snapshots, I think they can also be a useful tool, but I believe a browser gives you a lot of flexibility. Not only you can have the same "at-a-glance" impression on whether your snapshot is utterly wrong (a _smoke_ test), but you can also open up the DevTools and explore its internals: invisible/transparent divs, CSS attributes, dimensions, accessibility properties (including `title` attributes for tooltips), etc.

Re "why doesn't it look/behave like it does in my app": it should be made clear to the test engineer that the HTML snapshot reflects exactly the text-based snapshot. There will be obviously no dynamic behaviour, and isolating a component (e.g. in my 2nd example above) will also have an impact on its appearance. But I believe that the test engineer will find in the browser exactly what he expects (even more, when we add custom CSS to the HTML preview), and we should still stress that a code review process is very important before committing new snapshots (.snap and .html) to the repo.

Finally, the approach presented here also allows viewing non-HTML snapshots within the browser, which some people may find useful.
 (Sorry, accidental click!)
 @guigrpa I think this is a great exploration but right now I don't believe this is the right thing to integrate into Jest itself. As @suchipi pointed out, the CSS and functionality will be missing because we are only rendering a snapshot from something that looks like JSX. This approach will undoubtedly also break down when mocking out components to "shallow" render them, for example when doing something like `jest.mock('path/to/Header', () => 'Header')` which will render as "<Header />" instead of a primitive value.

Instead, what I would encourage you to do is to build a tool on top of Jest's current snapshot format that can be run after Jest and will create HTML output that you are looking for. Finally, it might make sense to consider what a fully in-browser snapshot solution for React specifically might look like.
 @cpojer Thanks for the review. I'd just like to add some thoughts regarding your remarks:
- **Lack of CSS**: the missing stylesheets could be added via CLI options (as I suggested above) _or_ by adopting some convention (e.g. a fixed file name in the snapshot folder). Also take into account that, if you use inline styles (rather frequent in the React community, I'd say), they will automatically be included in the HTML snapshot.
- **Lack of functionality**: I'm not sure I get what you mean. Of course, all snapshots (`.html` or `.snap`) are static. You can use different tools to _read_ them, but whether that's a text editor, a diff tool, or (in my proposal) a browser, I think most developers will understand their static nature. I believe many developers will find reviewing snapshots in a browser highly convenient, considering how rich current browser devtools are.
- **Mocks and shallow rendering**: as demonstrated in [my example above](https://rawgit.com/guigrpa/mady/master/src/client/components/__tests__/__snapshots__/060-translator.test.js.html), you can have shallow rendering and children components showing something meaningful in the HTML snapshot. In my case, I use the following mock (simplified for clarity)...

``` js
jest.mock('path/to/Header', () => (props) => <div {...props}>Header</div>);
```

...but I could update the PR so that the pure-text mock you propose would also work. And we could of course fix any other technical glitches of this approach.
- **Alternatively building an external tool**: this could be done, but wouldn't it be useful for many Jest developers to have such a convenient feature (maybe opting in via a CLI flag)? Note that this implementation also allows to review _non-React snapshots_ in the browser.
 @suchipi Thanks for the suggestion. However, if I understand correctly #1842 would generate **a single version for each snapshot** (in HTML format, if we build a suitable serializer). What I had in mind in my PR was getting two versions for each snapshot: the standard one, with the most complete information (untouched), **plus** an HTML preview. I don't want to _replace_ the default snapshot. Any idea?
 In addition, currently it seems to be impossible to override the `ReactTestComponentPlugin` ([see here](https://github.com/facebook/jest/blob/master/packages/jest-snapshot/src/plugins.js)), let alone wrap it, since custom serializers get pushed at the end of the `PLUGINS` array. I was thinking about inserting an additional property on snapshots prior to being serialized by the default plugin, but I don't see how that might be possible.
 @cpojer Would it be possible to _prepend_ custom serializers, instead of _appending_ them, for maximum flexibility?
 Definitely. Do you wanna send a PR for this? Please add a test that ensures we append custom serializers instead of prepend :)

On Thu, Oct 27, 2016 at 7:52 PM +0900, "Guillermo Grau Panea" <notifications@github.com<mailto:notifications@github.com>> wrote:

@cpojerhttps://github.com/cpojer Would it be possible to prepend custom serializers, instead of appending them, for maximum flexibility?

## 

You are receiving this because you were mentioned.
Reply to this email directly, view it on GitHubhttps://github.com/facebook/jest/pull/1862#issuecomment-256609657, or mute the threadhttps://github.com/notifications/unsubscribe-auth/AAA0KEoP0XSaRJ89E0x8-evSIZBeoFQ-ks5q4IJwgaJpZM4KN6JO.
 @cpojer Sure, I'll prepare a PR for that
 That's exactly what I intended to do (with other names ;) ), and that's why I needed the custom plugins to be prepended rather than appended (if not, we don't get a chance to render React components in another form). 

If you mean it's undesirable because there is redundancy: yes, but in exchange for that you'll get simple, visual snapshot reviews. Let me put together a proof of concept and maybe you will convince yourself ;)
 @cpojer I built the serializer + HTML preview tool, you can find it here: [jest-html](https://github.com/guigrpa/jest-html). Care to check it out and give me some feedback?

Also, if you find it useful, we could link to this tool from the Jest docs, as an example of custom serializer ([Jest configuration](https://facebook.github.io/jest/docs/configuration.html)) or, even better, as a complement to the "snapshot review experience" ([React tutorial](https://facebook.github.io/jest/docs/tutorial-react.html#snapshot-testing)). What do you think?
 This looks really impressive. I'll try to spend some time playing with this and give some feedback soon.
 Version 1.1.0 now lets you quickly toggle between the HTML preview and the raw snapshot‚Ä¶
  Output grows really fast in watch mode, and after sometime it gets really hard to navigate through terminal output with scrollbar.

Clearing scrollback before each run will fix that.

OS X : hotkey is CMD+K. but in watch mode you fast get tired of pressing it each time

How to do it programmatically: `printf '\e[3J'` [1]

[1] VIA: http://apple.stackexchange.com/a/113168

P.S. It's only about watch mode
 We clear it every time we re-run tests. It just seems that terminals like iterm allow to scroll back up indefinitely.

I know @gaearon has done a ton of work with this.
 @cpojer  I'm using standart terminal app
@kentcdodds yes, that's the point, eliminate scrolling in watch mode

What you think guys?
 I'm happy to support this in Jest but I want to get some input from @gaearon first. Also, how does this behave on windows? Do we need to do a platform sniff and print different things or will this work on both?
 Tested on windows 7 cmd - `printf '\e[3J'` not works, but `cls` works

__UPD__ `echo -e '\e[3J'` works on Ubuntu terminal nicely In this case, would you mind sending a PR with the new behavior for osx (and linux?) and the old one for windows? Can you double check it works well on linux, too?
 yes, but may be wait for @gaearon message? Interesting, what he can say on it
 Send a PR and I'll be happy to test it with a few edge cases I know have been broken in the past last time I tried to fix this.
 let's continue the conversation in the PR.  I'm worried this will make watch mode more complex than it needs to be but at the same time I see how this could be useful. Would you be willing to add this feature and send a PR?

Right now the watch code isn't super pretty but it is functional. You'd make the changes here: https://github.com/facebook/jest/blob/master/packages/jest-cli/src/jest.js#L392 ‚Äì we can add `t` that works just like `p` :)
 Watch mode is now rewritten so it should be easier to implement üòâ  This is being implemented by #2568.  thanks!
  Hah, that's a good one. Thank you for the PR ‚ù§Ô∏è
 It's quite common too: https://github.com/search?utf8=%E2%9C%93&q=worfklow :D
  I don't think what you are saying or experiencing is a real issue. If you are using babel-jest, the mock calls are hoisted properly. This example is passing in our CI as well, so not sure what problem you are trying to solve.
  thanks!
  Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!
 Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks!
  Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!
  I believe this should be fixed in Jest 17. Let me know if this is still an issue.
  The preset must be coming from a `.babelrc` somewhere in your tree. If it's there, Jest will currently automatically use it.
 To fix:
- Remove `.babelrc`
- Install the ES2015 preset
  Can you provide a repository that highlights this issue so we can fix it? :)
 @difelice does it work if you provide the argument `--collectCoverageFrom` twice (with different arguments)?
 @maiis @difelice is right; `collectCoverageFrom` shouldn't contain `rootDir`.
  Thank you for your pull request.  As you may know, we require contributors to sign our Contributor License Agreement, and we don't seem to have you on file and listed as active anymore.  In order for us to review and merge your code, please email cla@fb.com with your details so we can update your status.
 Thank you! I'm hoping you'll update use when Part 3 comes out ;)
 When you said the article will go out of date I was getting my hopes up there'll be more ;)
    thanks!
  Thank you for your pull request.  As you may know, we require contributors to sign our Contributor License Agreement, and we don't seem to have you on file and listed as active anymore.  In order for us to review and merge your code, please email cla@fb.com with your details so we can update your status.
 Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks!
 No, I would prefer `toBeCalledWith` etc. to stay strict.
 @excitement-engineer would you mind rebasing this diff?
 Ok thanks! @dmitriiabramov is going to handle this whenever he gets around to it :)
 this PR is awesome! thank you so much @excitement-engineer!
and sorry for the long response. holiday season in the US :) Yea, this was already reported in #2195 :D Thanks!  Thank you for your pull request.  As you may know, we require contributors to sign our Contributor License Agreement, and we don't seem to have you on file and listed as active anymore.  In order for us to review and merge your code, please email cla@fb.com with your details so we can update your status.
 Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks!
 Sorry for getting back to this so late.

This is a really solid PR. I'll merge it tomorrow!
  Sorry about that. Unfortunately we don't have versioned documentation :( 16 will be out this week.
  Which version of react-native are you using?
 Oh, remove the `haste` config from your Jest configuration. The jest-react-native preset brings this in automatically.
 you don't seem to have react-native as a dependency of your project.
 Yes, `testPathDirs` is actually a different name for "roots". We should really rename this and fix it. Jest only looks in folders that are called "testPathDirs" and it doesn't look anywhere else.
 @jasonmerino try `jest@test`
 You also need `jest-react-native@test`
 this issue happened to me after upgrading react-native to 0.38 and react to 15.4.1

it was fine using react-native `0.33` and react `~15.3.0`

@carera installing `react-dom` doesn't help

 Can someone confirm? `ln -s node_modules/react node_modules/React` has fixed for me.
I have case-sensitive filesystem on my Mac, so calls like `require('React');` are invalid (`require('react');` is ok)

@Richard-Cao you've mention that on your local PC all is fine, and it breaks on CI server. May be it because You have case-INsensitive FS on local PC, and Linux FX is case-sensitive? Sorry for triple comment.
This is not a Jest issue, I guess It's React issue. React and Haste *

let me explain a bit
`require('React')` is actually handled by Haste loader, by `@providesModule React` directive.

Where it's located:
Source code:
`src/isomorphic/React.js`
https://github.com/facebook/react/blob/c78464f8ea9a5b00ec80252d20a71a1482210e57/src/isomorphic/React.js#L9
Transpiled version: `node_modules/react/lib/React.js`

I've installed some last versions one-by-one, and this directive was suddendly disappear from transpiled code, throwing error from Haste, which can't resolve `React` to `node_modules/react`.

Versions and directive existence:

| Version     | Has Haste directive |
|-------------|---------------------|
| 15.3.2      | Yes                 |
| 15.4.0-rc.1 | Yes                 | 
| 15.4.0-rc.2 | Yes                 | 
| 15.4.0-rc.3 | No                  |
| 15.4.0-rc.4 | No                  | 
| 15.4.0      | No                  |
| 15.4.1      | No                  | 

What was happen with transpiled source at `15.4.0-rc.2` -> `15.4.0-rc.3` version bump? I dunno...

So. For now, I have react-native `0.38` installed, and
```
npm WARN react-native@0.38.0 requires a peer of react@~15.4.0-rc.4 but none was installed.
```

And ` react@~15.4.0-rc.4` don't hase Haste directive -> tests are broken...


What to do? 

1. Rollback react to `15.4.0-rc.2` or `15.3.2 ` and wait for fix
2. See Red CI servers and wait for fix...


* actually, react-native packager forms bundle successfully... and Jest can't find react module O_O very strange... `jest-react-native` was fully merged into react-native. Simply changing your Jest config to `"preset": "react-native"` when using RN 0.38+ should work.

We haven't forwarded jest-react-native to react-native yet, unfortunately. cc @kentaromiura I'll update jest-react-native today to forward to react-native. I'm also updating Jest's documentation to hint that you won't need jest-react-native any longer as the default setup with 0.38 includes a working Jest configuration.

I'm sorry that this was a problem for people. I was on vacation and we were unable to update `jest-react-native` previously.

See #2182. @JeroenNelen actually, issue You've linked ( https://github.com/facebook/react-native/issues/4968 ), comes from npm - it has a bug with installing dependencies. Please refer to https://github.com/npm/npm/issues/12654 . How to deal with this bug : personally, I don't use `devDependencies`, I store all your dependencies into `dependencies`.That's how I resolved it.

React-native is rapidly changing, probably sticking with old releases is not very good... But who knows, may be old RN version will work for someone! @JeroenNelen If you are using react-native prior to 0.38, use `jest-react-native` locked to version 17.0.3 or lower. If you are using 0.38, use `react-native` as preset or install `17.1.0` of jest-react-native which will continue to work (and forward) to react-native for a while. Yeah, we moved to more explicit mocks and StatusBar might simply not be mocked properly. See https://github.com/facebook/react-native/blob/master/jest/setup.js#L69 ‚Äì you can send a PR to RN to fix this and meanwhile you can probably add this mock manually a file that you add to `setupFiles`.  Use `--notify`.
 Feel free to send a pull request to add this feature.
  You can change it using

```
Object.defineProperty(location, 'href', {
  value: 'your url',
  configurable: true,
});
```
  Thank you! I'm gonna go ahead and merge this and then polish the whole thing a little bit.
  We need to expose our addMatchers API as `expect.extend`. See https://github.com/facebook/jest/pull/1298 it's already there, just need to hook it up.

After that we need to overwrite `jasmine.addMatchers` to route to jest's matchers in a compatible way.

cc @blainekasten @dmitriiabramov 
 Please go for it!
  I'm sorry for the confusion. It is right we don't currently have branching for the website, but these things don't happen often.

If you'd like to use the new features, try out `jest@next` :)
 We'll publish 16 and we should be back on track with the website :)
  thanks!
  Let's add a new docs page "Migration to Jest" that mentions how to migrate from different test frameworks.
- If you are using Jasmine or the test runner you are using uses Jasmine, Jest should be mostly compatible and easy to upgrade.
- If you are using ava or tape, you can upgrade with jest-codemods
- If you like chai, you can upgrade to Jest and continue to use chai.

A docs page can be added in the `docs/` folder and is hooked up by updating the page that comes before and after. You can then `npm install` and `npm start` inside of the `website/` folder to see your changes live.

I think it is good to start out with the migration document and see how far you can get. Then we can expand it later :) 
  This should work in `jest@next`. Would you mind trying this out?
  Just a few small cleanups :)

cc @maximderbin 
  Properly fixes https://github.com/facebook/jest/issues/1769. Supersedes: https://github.com/facebook/jest/pull/1771

This is now pretty awesome with the watcher interruption we have :) cc @thymikee  
 Upgrade to Jest 17. It works with --watch ‚Äì when the first test fails, it will stop the run. It will re-run when files change again.
 It should definitely re-run again when you change a file. If it doesn't, that's a bug. If you can figure out the issue and send a PR, that would be greatly appreciated :)
  Thank you for your pull request.  As you may know, we require contributors to sign our Contributor License Agreement, and we don't seem to have you on file and listed as active anymore.  In order for us to review and merge your code, please email cla@fb.com with your details so we can update your status.
 Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks!
 Thanks for your pull request. Unfortunately, I think you are a bit confused here. The catch block is indeed empty, yes, but that means that the `return false` statement is executed right afterwards.

With your change it is effectively exactly the same in the end.
 Yes, because npm's client is broken. This has nothing to do with Jest. Update to npm 3.10.8.
  Nice! Thanks for sending this PR again. This is gonna be really useful.
  Can you try updating to Node 6.5 and see if this still happens? It does some things differently in how it infers function names.
 yeah this kind of sucks. Istanbul wraps functions with other anonymous functions and we take the function name that node gives to the rendered component :(
 You can also add `displayName` to the component.
  Does this work if you set `testEnvironment: 'jsdom'`? :)
 yes it is but I haven't been able to spend time on this yet.
 Duplicate of #1597.
 @cooperka you are right, there was still an issue with this. I just merged a PR that should fix this for the next release :)  Update your version of node; put `'use strict';` on top of your file. Can also try out https://github.com/facebook/jest/tree/master/examples/react-native
 If they aren't precompiled you'll need to add it to your `preprocessorIgnorePatterns`: http://facebook.github.io/jest/docs/tutorial-react-native.html#preprocessorignorepatterns-customization
 The problem is that unfortunately react-native's packager compiles everything which is horribly slow. We should really stop doing this (and are planning to on the RN team). In Jest we made the choice to ignore most node modules by default and enable users to whitelist the ones that aren't precompiled. We might want to update the error that Jest throws to hint at this.
  This is definitely an issue with npm. Try to do `npm install -g npm@next`
 @kentcdodds I'm not sure if this is correct. The above warning is definitely an npm issue. Our memory usage in watch mode might be indeed an issue that we may need to fix.
  thank you!
  Ok, one more rename for the option if you don't mind. I didn't mean to ask for changing the API of the crawler to `crawl(options: CrawlerOptions)` but rather something like `crawl(roots, data, extensions, options: CrawlerOptions)` but your change is solid and I'm not opposed to it, so let's keep that part :) Nice!
 This will be in Jest 16 :)
  See https://github.com/facebook/jest/issues/1353
  I think this is a good start but I'm concerned a full rebuild is going to be way too slow.

Here is what we need to do at the minimum:
- Add a way to debounce writing the cache like I outlined in the internal task so we don't always write.
- When we rebuild, reuse the previous version of the map from memory instead of reading it from the file system.

I think this will make rebuilds be less than 300ms or so, which should be reasonable. I think we should get this ready, merge it and then perf test it. If it isn't fast enough, we need incremental rebuild which should also be easy to add :)
 I'm worried this is going to introduce a ton of subtle inconsistencies into the haste map. The integrity and correctness is really important. One thing you mentioned to me was that we are missing fs updates (when a lot of writes happen quickly). In this diff also you are only updating the file list but you are not making the appropriate changes to the module map and the filemap is left in an inconsistent state (you only update the dependencies but not the haste id if it changes). I'm afraid that this approach won't work unless you spend a lot of careful effort writing tests for every possible case.

Instead, I'd like to ask you to go back to my initial proposal from my previous review above: "When we rebuild, reuse the previous version of the map from memory instead of reading it from the file system.". Specifically, what I'll recommend is splitting up the "build" method into two functions: `_buildInternal` and `_build` ( https://github.com/cpojer/jest/blob/master/packages/jest-haste-map/src/index.js#L229 ). The only downside of this is when you don't have watchman, we'll use `find` to find all JS files on every file change because we cannot do filesystem deltas. This might be a problem for external folks with large codebases who don't have watchman. If we are confident that we can catch all changes properly, we can add a separate node-delta-crawler however that would take care of it and I wouldn't worry too much.
- `_buildInternal` would be typed as `Promise<InternalHasteMap>` and uses a promise cache just like `build()` and `build` would call it.
- then a `watch` API would call `_buildInternal.then(internalHasteMap => {‚Ä¶})`. This way, storing the previous version of the haste map doesn't have to be on the instance but it's kept inside the promise cache.
- `_buildInternal` calls `_buildFileMap` and `_buildHasteMap`. You can then add the ability to pass a version of the internal map to `_buildInternal(internalMap)`, wipe away the promise that is cached in `_buildInternal` and pass the previous version of the map to the other build functions which would then side-step file reading.
- At this point, we only persist once when calling the external facing `build()` function and we can call persist in the watch function when we debounce.

The nice thing about this is that it will re-use all of the code-paths that the haste-map already uses to make sure everything is consistent. Instead of relying on what watchman gives us, we just query it directly about what has changed since the last time we asked.

So there are two ways to build file watching. One is the path you are going down which I'm scared is going to be brittle and problematic but if done right, will be the fastest solution. The other is the one I laid out above which will be reasonably fast with watchman and has some downside with node. It's up to you which one you'd like to go for :) What do you think?
 Let's reopen this when it's a bit more polishing. I'm currently struggling to keep up with PRs on Jest, so closing this to manage my queue.
  Try http://facebook.github.io/jest/docs/configuration.html#testpathignorepatterns-array-string
  You can create your own preprocessor that invokes babel that omits the `canCompile` check or output your typescript files with an appropriate extension. I don't think we'll change our implementation.
  **Summary**
- Fixes #1782 by immediately printing "RUNS" in the single process mode between tests and hiding the summary.
- Hides the cursor and removes a trailing newline.

**Test plan**

`jest cli -i`, `jest haste-map`, `jest` and watch the output.
 Looks like hiding the cursor is not great when killing the process with `ctrl+c`. Sometimes it doesn't show up in iTerm2. I'll remove this again but also keep the removed newline. This way the cursor is after the progress bar, which seems alright.
  If you just added your `.babelrc` and modified it between a test run, run `jest --no-cache` once to make sure the change is being picked up. This is a bug in Jest that I was hoping to fix, sorry for the inconvenience.
 Oh, I just noticed this happened to a node module, which Jest by default doesn't preprocess. Check out http://facebook.github.io/jest/docs/tutorial-react-native.html#preprocessorignorepatterns-customization and whitelist the exponent packages :)
  You can currently put `__mocks__` anywhere and they are global. We are planning on making changes which may include what you are requesting. @flarnie is working on this; I'll create new tasks to track these things but we aren't specifically prioritizing this request and it will likely be a different route that we'll go.
  awesome work! Thanks for adding a test.
 When running jest with `--no-cache` it seems like this is generating a bunch of @providesModule warnings because you changed the my-module folder.
 Nice work!
  thank you!
  This will be part of React 15.4: https://github.com/facebook/react/issues/7740

You can do `jest.mock('path/to/MapBox', () => 'MapBox')` which should completely stub it out.
  Which version of Jest are you using?
 Yes, testPathPattern is not a supported config option. I pushed a website update with the option removed.
 Thanks for raising the issue!
  This is good! Thank you :)
  This definitely works for me. Is it a problem with your browser?
  Yeah, for now we rely on the Jasmine docs for this. We'll document it at some point when we have something new. If you'd like to document the `done` syntax on the Jest website, please send us a PR :)
  I think the way this message reads isn't great. Can we add an option to `formatReceivedCalls` to not start a new sentence but rather lowercase the "but"? For `toBeCalled` we can then print "Expected the function not to be called but it was called with [‚Ä¶]" which reads much better.
 awesome!
  **Test plan**
jest
  I think we could connect this with interactively updating the snapshots so it's more convenient. I think here is where I'd start:

* Make this work only for watch mode (this is supposed to be interactive).
* Record all the failures (Jest is already doing this).
* When the tests are run, it will say "Snapshots failed, press u to update all or i to update them interactively"
* When "i" is pressed, clear the screen and run each test one by one. When it fails, ask to press "a" to accept or "s" to skip.

I'd start looking at watch.js and getting the list of test results and then trying to apply that as "pattern" + testNamePattern (See #1860, which we may need for this as well).  Yes this will be in the next release as `testNamePattern` or `-t`.
  Actually depends on https://github.com/facebook/jest/pull/1795 which adds ability to mock stateless components

Why? These 2 PRs actually enable usage of this module in app tests.

It would be just nice to `import` and use `jest-react-native` as a small utility module...
 I don't think `jest-react-native`'s mockComponent call should support this. It is specifically made to mock react-native components. If you'd like to have this helper method, I recommend creating an npm module for it and publishing it yourself. We are happy to accept a PR that adds it to our documentation :)
  Now it's able to mock `arrow-style` components aka `stateless components` aka `lambdas`
 Do I need to add a test case for this PR?
 Thanks! This is fine.
  Closes #1739
  we should definitely have something like that in jest.
the API i was thinking about is

``` js
expect({a: {b: 1, c: 2}, d: 3, e: 4}).toContainSubObject({a: {b: 1}, e: 4});
```

the only thing that i'm not sure is the name of the matcher. toPartiallyMatch, toEqualPartially?
 I think we could use `.toMatch` for this kind of stuff. It's basically the same as matching a string against another string/regex, no?
 Let's do `toMatchObject`. I think `toMatch` would be appropriate but I don't want to overload it. Do you want to send a PR for this?

You can simply use `jasmine.objectContaining` in the new matcher for now. We'll swap out the internals eventually :)
 We'll continue the conversation in the PR.
  thank you
  Wow this is interesting. You are using Jest 0.6 which is completely unsupported. At this point, we are at version 15.1. Please update and report back, happy to reopen if this issue persists.
 I'm sorry, we don't have resources to support older versions at this point.
  Jest will always return the same module when `jest.resetModules()` is _not_ called. Without a repro I'm afraid there isn't much we can do.
  Hmm.. this is very odd. Jest should always escape quotes. Would you mind letting me know which systems all your engineers are using?
 Quotes always spell trouble. @kyldvs noticed the issues first. Does this happen in files where there are test failures or snapshot failures? I believe it is possible that this might happen when a test is thrown, yet we try to write the snapshot data back into the test file anyway.
 I haven't seen this since we rewrote snapshots in 16. Please try with Jest 17 and report back if this is still an issue.
 I think I finally found the issue. It's a combination between renaming and disabling tests. I did it! Here is the repro:

* Have three snapshots with quotes in a file, store them all.
* Delete one of the tests.
* Use `test.only` for the second one.
* Run with `-u`.
* This will remove the obsolete snapshot, write the one in `test.only` and use the existing value of the third snapshot because the test wasn't run; that third one will not use the proper escaping mechanism. Unfortunately since the way we encode/decode strings currently, I cannot think of a good way to fix this :( cc @dmitriiabramov had an idea. The problem is that we rely on pretty-format to escape quotes in strings, like `"foo\'bar"` but these go away when we require the file as JS. When we write a snapshot file, we use the data from pretty-format of the real value (passed to `expect`) so everything is escaped properly. When we write a snapshot file with data we read from a snapshot because we don't run the test that generates it, we don't have the data from pretty-format. This is also affecting @pieterv and myself if that's of any use :) @vjeux it's not, but thanks! Can you fix it? :) @jlongster when a snapshot file is written (either through -u or a new `toMatchSnapshot` call), we take all of the values passed to `expect` and call `pretty-format` on them and write a completely new snapshot file. When a test is disabled, we don't have the generated value so we use pretty-printed string from the snapshot file, which is what is causing the problem here. @vjeux is actually investigating a fix right now :) Seems like I might a bad call with regards to escaping. This will be fixed in Jest 19 thanks to @vjeux. It's a breaking change for snapshot and we'll try to message it appropriately.  Are you using create-react-app? Jest should exit normally assuming you clean up all your resources.
  Thank you @javache. @kentaromiura is actually working on merging all of the stuff from `jest-react-native` back into RN.
 It looks like flow is unhappy about this. Would you mind checking what's going on here? :)
 Also, which version of react-native should this be targeted at? Would you mind updating the peer dep in jest-react-native's package.json? Thanks!
 @javache which version of RN is this going to work with? We need to update the peer-dependency and make sure the integration test in Jest will pass with this.
 Why dogscience? I can publish a new version of jest-react-native anytime. As long as semver works as expected and the rc version will also include the actual release, this should be fine, no?
 Seems like this doesn't make travis happy either. Can you point me to the commits that changed the format so that we can figure out how to make sure 0.35 will work fine with Jest out of the box?
 @bestander yes but until that is merged we'll need to support the preset here. Once @kentaromiura's changes are merged we can make it so this preset forwards to rn and eventually kill it entirely.
  We are updating what we print here in Jest 16. Feel free to send us a PR with your suggestion. The code for it should go here: https://github.com/facebook/jest/blob/master/packages/jest-matchers/src/spyMatchers.js#L36
 Go for it! Excited to see a PR. If you can do it today or tomorrow it might make it in time for Jest 16 :)
 Please consider both the messages when the function gets called with different args vs. the function not having been called at all.
 Ah yeah, that makes sense! Closing this issue in favor of the PR you opened. Thank you!
  this reduces `npm run jest` running time from 45s to 30s
see https://github.com/facebook/jest/issues/1784
 I'm gonna close this for now. I don't care so much about the runtime of Jest's suite itself.
  Thank you! I removed the mount documentation as it might be confusing to beginners and I'm sure there are many more guides available. I prefer our docs to be succinct.
  This is really odd. Some other people reported this as well and I thought it was something they did wrong. Jest hasn't published a release in a while as we are working on 16 so I'm wondering if there is any change in istanbul or react that went out in a patch release that is causing this issue?
 It might be a bug in enzyme-to-json then?
 I think those are separate issues.

One is that `toString()` is called on a function before Jest even receives it.

The other is that our custom serialization format used to print function names. We don't invoke `toString()` there.

I'm wondering whether the issue here is that we have "functions" that don't identify themselves as functions or we might call `toString` on them inadvertently. I didn't yet have time to fully explore what is going on here and any help identifying or fixing the issue is appreciated.
 @adriantoine thanks for fixing it in enzyme-to-json.

@bsr203 if this is happening to you with react-test-renderer, please provide a repro.
 Closing as this looks like resolved now. Happy to reopen if the problem still exists for @bsr203   thank you!
  ``` js
test('not implemented');
it('not implemented');
```

will result in skipped tests
  Duplicate of #462. Unfortunately there are some bugs here but we are hoping to fix this soonish.
  I can reproduce this with a simple test:

``` js
it('hangs', function() {
  var elem = document.createElement('div');
  expect(elem).toBe(undefined);
});
```

It hangs forever on Jest 16.0.1.
 It's faster if you send a PR! Unfortunately I've been pretty backed up with a ton of work.
 Sure, that's fine too.
 https://github.com/facebook/jest/pull/2078#issuecomment-260090774
 This still happens for us in React repo with the latest Jest.
Unfortunately I'm having troubles trying to reproduce it outside of React repo :-(

I made a repro case inside React repo.

```
git clone https://github.com/gaearon/react.git react-jest-bug-repro
cd react-jest-bug-repro
git checkout jest-bug
yarn
npm test -- JestBug
```

Expected: it doesn't hang.
Actual: it hangs.

Commit with the repro: https://github.com/gaearon/react/commit/8a0e694beee2a2b66eaff6ecd243063de85ce8da. should be fixed in https://github.com/facebook/jest/pull/2148
@gaearon thanks for the repro case! I think it was getting stuck trying to send a very long error message from a child process to the master jest process. @sebmarkbage can you send a PR to Jest with a failing test? Ok, so I finally found some time to test it and indeed thats the diff library we're using which causes problems. 

We could consider changing our diff to utilise Google's [diff-match-patch](https://code.google.com/p/google-diff-match-patch/), which further optimises Meyer's algorithm with pre/post diff work (which is super fast for partially similar strings). 

Although it still can choke on some bigger totally unrelated values (at least on default options), it can process values at least 3 orders of magnitude higher.
 Is there anybody who'd want to add Google's JS implementation for Jest 20? It seems like it should be fairly easy to switch over to a new implementation, no? :) @AlexTes if you have already made progress, how about sending a PR? :) We should be able to fix these things up together.  Thanks for this PR. This change will make Jest not respect the --bail flag in watch mode at all. We currently have a PR out for interrupting watch mode (#1709) ‚Äì I feel like building on top of that and stopping the test run after the first failure when `--bail` is specified makes the most sense, no?
 See my follow up in #1827.
  We are currently rewriting snapshot support so it means you'll likely have to update your code when we publish Jest 16.

You won't be able to use the snapshot code without an `fs` implementation. You could wrap your code in electron to enable that, however. There isn't anything else we can do here, unfortunately.
  Fix is in #1827.
  It seems like you need to update your `preprocessorIgnorePathPatterns` so that realm is also compiled properly. Add realm to the list here: http://facebook.github.io/jest/docs/tutorial-react-native.html#preprocessorignorepatterns-customization
  I'm quite confident this is not a Jest issue but either an underlying module or something else on your system. Unsure how to troubleshoot, everything is fine here on Sierra.
 I also got a similar report about Sierra: https://github.com/facebookincubator/create-react-app/issues/713
 @cpojer Do you have a Sierra? Have you tried 6.6.0 on it?
 Per https://github.com/facebookincubator/create-react-app/issues/713#issuecomment-249197672, uninstalling Watchman fixes the issue so it‚Äôs either a problem with Watchman, or its Jest integration on Sierra.
 A few other _possibly_ related threads:

https://github.com/ember-cli/ember-cli/issues/6259
https://github.com/facebook/watchman/issues/358

Can you try any suggestions there and report back?
 @gaearon I'm using node 6.6.0 on Sierra with watchman and everything is fine.
 Definitely seems like a watchman/upgrading issue. I'm gonna close this out for now but happy to reopen in case this is actually a Jest problem. Since many people reported this on other projects (rn) it is unlikely though.
 I was thinking that `fsevents` is the issue. I would recommend reinstalling the node binary, wiping away all node_modules folders and doing a fresh npm install.
 Usually when this happens it is a sign to restart the computer. This happens frequently at FB too (unrelated to Jest) :(
 @hmeerlo watchman is a file watching service built by FB to make file system operations faster. Jest will run much faster on a big repo if watchman is installed and it brings the startup overhead of Jest to practically nothing as it will only statically analyze files that have changed.
 It's not a strict requirement but just like react-native, on big repositories with large dependency trees (lots of node modules, for example), we do recommend watchman for better performance and to avoid the problems mentioned in this issue. I would recommend your team to install it to speed up common file system operations.
 @cpojer Should we document Watchman in CRA User Guide?
 @gaearon Yeah, I don't think there is any problem with that. I would recommend adding it to the Jest docs as well.

I'm unsure how big the dependency tree of cra's node_modules is. If it is sufficiently large we should probably recommend watchman to most people.
 Do you have problems if you uninstall Watchman completely? Jets should use the Node based watcher if you do so. Do you have issues with it as well?
 I'm reopening because we get reports about this in Create React App with **uninstalling** Watchman fixing the issue. Therefore the problem is in whatever Jest uses when Watchman is disabled.
 Whether or not this is a Watchman issue, it affects Jest users, and by proxy, all Create React App users. Create React App chose Jest as a runner in the hope that such issues are addressed, whether in Jest, Watchman, or any other underlying projects.

No matter whose fault this issue is, I don't think we can close it until we have clear instructions about how to fix it, and I can tell something consistent about fixing it to Create React App users.

I can't tell something as vague as "Try installing, or maybe uninstalling Watchman, whatever works" to people if [tests literally don't run inside newly created projects](https://github.com/facebookincubator/create-react-app/issues/960). If some versions of Watchman are buggy or incompatible, Jest should bail out of using them. If Node crawler is buggy, Jest should fix it, or force users to install Watchman.
 Hey everyone,

I've been incredibly busy with a bunch of projects and was unable to spend any time on this issue. I'm sorry about that. There have a been a ton of reports here and different solutions seem to have worked for different people. I'd like to figure out what is going wrong and how to fix it, however I have not been able to reproduce this issue and it doesn't seem like there are any repro steps available in this thread either. Can somebody who ran into this spend some time trying to figure out a consistent repro that I can test locally?
 Reportedly, this [may](https://github.com/facebookincubator/create-react-app/issues/960#issuecomment-258509457) fix the issue:

```
launchctl unload -F ~/Library/LaunchAgents/com.github.facebook.watchman.plist
watchman version
```
 It seems like most people resolves this issue in one way or another and it most likely had to do with issues around OS upgrades, node modules, watchman and node. We never had a repro at FB, so it is hard to know what exactly was going on here. I'll close it as non-actionable at this point. If you are reading this in the future, please scroll up and try any of the solutions people brought up. I also summarized a few workarounds [here](https://github.com/facebookincubator/create-react-app/blob/master/packages/react-scripts/template/README.md#npm-test-hangs-on-macos-sierra). @MoOx Unfortunately at this point I don‚Äôt think we‚Äôll figure out the root until somebody who has the issue takes the time to figure out what is happening (e.g. you could put console logs in Jest sources and its Node-based watcher). I think that without watchman Jest falls back to [Node crawler](https://github.com/facebook/jest/blob/master/packages/jest-haste-map/src/crawlers/node.js). Something in Sierra might've broken it. So maybe worth putting some logs there. Another data point: I just had this issue on Node 6.9.1, switching to 6.3.1 solved it. As I noted above, please feel free to dig into why this happens. While this *is* inconvenient, this is an open source project, and you can help us. Right now I have a lot of work on React itself and unfortunately don‚Äôt have time to look into why this happens. It seems like usually it‚Äôs fixable by installing (or uninstalling) watchman so, while irritating, people tend to work around it quickly. @ro-savage thank you so much for doing this investigation. Would you be open to make a change to `sane`? I'm also happy to switch off of sane if you'd like to write a file-watching system directly within this repo, but that is probably a bigger challenge. That's awesome. Looking forward to it. Something to keep in mind: it would be nice if we ignored specifically the root `node_modules` rather than `/node_modules/` generally. See https://github.com/facebook/jest/pull/2796 and https://github.com/facebook/jest/pull/2318 for some context for why I‚Äôd like `src/node_modules` to still be working.

Also, 

>The error seems to be thrown by walker when it searches too many files/directories using fs.lstat. You can pass a predicate function that will ignore certain folders. (Ignoring node_modules solves the issue.)

sounds more like a workaround than a solution. I would like to better understand this. Yes, ignoring `node_modules` works around the problem because there is less files. But presumably on a large enough project you could hit this limit too. Is there a way to fix the underlying problem (‚Äúerror seems to be thrown by walker when it searches too many files/directories‚Äù)? Does this only fix crashing tests, or hanging tests too? Most commonly I just observed Jest hanging on "Determining test cases to run..."  I recommend putting a custom `toJSON` method on your function so that when Jest serializes the value, it doesn't contain the source code. Unfortunately we can't really fix this ‚Äì you shouldn't take snapshots of source code.
  i don't think we need it any more
 nice!
  I moved `SnapshotFile` functionality into `SnapshotState`, because we use one state per test file (and hence one snapshot file)
now the only publicly exposed API is `SnapshotState` and `toMatchSnapshot` matcher
 Awesome! This is so good. Snapshots are so much cleaner now.

I'm gonna remove the memoized file exists thing because it is scary in long sessions (--watch).
  Thanks for making these improvements! :)
  that should be fixed by https://github.com/facebook/jest/pull/1721#discussion_r79238454
  thanks!
 Please do send a PR for docs too. I also feel like we should link to all of the examples more prominently because it is easy for people to copy-paste them to get started :)
  interesting. this is definitely an issue with instrumented code.
@seethroughtrees  can you confirm that it works when you run it without `--coverage` flag, or with `collectCoverage: false`?
also, do you use `babel`? and if yes, what does your `.babelrc` look like?
 this is very, very strange then.
those are definitely some kind of coverage instrumentation

```
 case /* istanbul ignore next */(++_cover__().s['5'], 'SORT_POLL_BY'): /* istanbul ignore next */++_cover__().b['1'][0]++_cover__().s['9'];
```

that is causing an error.

so something is transforming it by adding those `_cover__()` statements.
do you have a reproducible project on github or anything i can look at?
 thanks for investigating @seethroughtrees!
 @Gpx that doesn't sound right. Can you throw up a project on github that shows this issue? Are you sure your `.babelrc` is properly set-up and that you ran Jest with `--no-cache` while modifying your `.babelrc`?
 I'm assuming your problem is not using semicolons. Please use semicolons or use your own preprocessor that doesn't use `retainLines`. Further, if this is a bug with `retainLines` you can also report it on the babel issue tracker and hope they'll fix it. The reason we use `retainLines` is to get reasonably accurate stack traces from transformed files.
  hey @calebmer 
how do you require fixtures in your code?
if it's through `readFile` or `readFileSync`, we won't be able to tell which tests we need to run. (because it's a runtime dependency, and we can only resolve dependencies using static analysis)

but i think what we can do, is potentially add a configuration option specifiying wathced files `watchFiles: ['fixtures/**.json']` that, if changed, will run the entire test suite. Although, it might be easier to just re-run the test suite manually in this case
 While this is a cool idea, I don't really think it is worth the complexity in Jest. In the watch mode we have all the options to customize the tests that are being run when files change and you can hit `enter` to trigger a re-run. I don't think we'll invest time in this so I'm closing the issue but feel free to send a PR to implement this and we can continue the discussion there :)
  Let's continue this discussion in #1798.
  it looks like something is calling `.toString()` on a function, which results in the raw transformed function source code being saved to a snapshot
 This seems like the same issue as this one: https://github.com/facebook/jest/issues/1766

Can you try not to render a function or overwrite it's toJSON function? If you put function sources into a snapshot, that's not really useful I'm afraid :(

Is it possible that React's test renderer calls toString on functions? cc @spicyj.
 This is really odd. The only thing that happened last week that was changed was updates to React itself. Jest hasn't changed but many people report having these issues right now. :(
  instead of using `fail` i would recommend either returning a promise (test will fail if the promise is rejected) or throwing an error manually, if the code is not async (`throw new Erorr('fail for some reason')`)

right now `fail` comes from jasmine, but we might drop support for in in the future versions
  **Summary**
Fixes https://github.com/facebookincubator/create-react-app/issues/583 and https://github.com/facebook/jest/issues/1746

**Test plan**
jest + repro in https://github.com/facebookincubator/create-react-app/issues/583
  This is tracked in https://github.com/facebook/jest/issues/1605
 https://github.com/facebook/jest/pull/1775
  @dmitriiabramov we'll need this API in jest-matchers somehow. It's pretty useful.
 i think the better way to do it would be to add a separate matcher that does custom equality without extending the global one. so, adding things instead of modifying, but we can think about other solutions to, even if it means replicating jasmine functionality 
 @mandysimon88 is that a third-party library that provides `.equals` method on its classes or a custom code?

my worry here is this:
we provide error messages with detailed diffs that show what exactly is not matching, and this diff is based on our diffing algorithm.  If we allow extending `toEqual` by using custom methods, we won't be able to guarantee that error messages well make sense.

What i think is the best solution in your case is to use `.toCustomEqual` and codemod the existing usages of `.toEqual` to the new `.toCustomEqual` matcher. I'll try to look at writing a codemod that can modify only failing tests after a jest update.

thanks for your feedback and sorry, our matcher system is not that flexible yet, but we're working on it :)
 @mandysimon88 @guy-kdm you can use [`expect.extend`](http://facebook.github.io/jest/docs/api.html#extending-jest-matchers) to achieve that.
Example implementation:
```js
expect.extend({
  toCustomEqual(received, expected) {
    let pass = false;
    let message;

    try {
      pass = received.equals(expected);
    } catch (error) {
      message = `${received}.equals() is not a function`
    }

    message = message ||
      this.utils.matcherHint('.toCustomEqual') + '\n\n' +
        `Expected value to not be (using .equals()):\n` +
        `  ${this.utils.printExpected(expected)}\n` +
        `Received:\n` +
        `  ${this.utils.printReceived(received)}`;

    return {actual: received, message, pass};
  }
})
```

Closing this for now, but happy to reopen if necessary.  nice work!
  This is tracked as part of #1679.
  Thanks for bringing it up. We don't unfortunately have different branches for the website and accidentally published the website yesterday with a bunch of new things. We'll be making a release this week, however.
  Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!
  This is indeed a bug. Will be fixed in Jest 16.
  **Summary**
Because of how lerna hooks up node modules (previously with one index file and now with a symlink), Flow was unable to follow the modules properly. This diff adds a module mapper in the flowconfig and fixes up all the invalid Flow annotations that we accumulated over time.

**Test plan**
flow + jest

cc @hzoo this might be interesting to you.
 Also decided to fix the snapshot printing issue in this diff because the Flow improvements pointed out that we were trying to print "null".
  <!-- Thanks for submitting a pull request! Please provide enough information so that others can review your pull request. The two fields below are mandatory. -->

**Summary**
Updated lerna; made a test more consistent.

**Test plan**
jest
  Can you try to use `-i` on travis which will run all the tests in one thread instead? I'm thinking this might be a resource problem, like one or many tests are leaking memory or something similar.
 Travis in general doesn't have a lot of resources so you might not be able to notice this because your CPU and memory is much better than what a travis vm gives you.
 I'm gonna close because there is probably nothing actionable for us and `-i` has worked in the past. If it turns out to be an issue in Jest and you have a repro, we are happy to help you fix it.
 @alansouzati that happened to me a few times and using `-i` helped.
the reason this was happening was conflicting subprocesses that i spawned from my jest tests. after switching to `-i` there was only 1 subprocess running at a time and it fixed the issue. It was not reproducible locally as well
 It really depends on what you are doing in your tests and how you are utilizing your resources. If you spawn a lot of child processes in your tests, running Jest with many processes itself might stall the CPU. In this case, `-i` can improve performance. Also consider things like `-w 2` which will set the number of workers to 2 ‚Äì you can try half the available ones on your system and see if that improves things, for example.
  You can overwrite `toJSON` on your top level object to provide a custom return value.

Try:

```
const object = ‚Ä¶;
object.toJSON = () => 'my string';
expect(object).toMatchSnapshot();
```
 yeah I'd be happy to accept that!
  I think it's because of code instrumentation

```
jest --coverage
```

``` diff
    - Snapshot
    + Received
...
    -   onSelect={[Function onSelectHandler]}
    +   onSelect={[Function anonymous]}
```

Running with `jest` is just OK.

Source code and func name for onSelectHandler:
`jest`:

``` js
    console.log src/components/pie-chart.js:44
      [Function: onSelectHandler]
    console.log src/components/pie-chart.js:45
      function onSelectHandler(_ref2){var nativeEvent=_ref2.nativeEvent;

      if(!onSelect){
      return;
      }
      onSelect(nativeEvent.index);
      }
```

And for `jest --coverage`:

``` js
    console.log src/components/pie-chart.js:44
      [Function]
    console.log src/components/pie-chart.js:45
      function (_ref2){var nativeEvent=_ref2.nativeEvent;++__cov_742n7agVtRgakP6RGrGnDGRBizg.f['3'];++__cov_742n7agVtRgakP6RGrGnDGRBizg.s['7'];

      if(!onSelect){++__cov_742n7agVtRgakP6RGrGnDGRBizg.b['1'][0];++__cov_742n7agVtRgakP6RGrGnDGRBizg.s['8'];
      return;
      }else{++__cov_742n7agVtRgakP6RGrGnDGRBizg.b['1'][1];}++__cov_742n7agVtRgakP6RGrGnDGRBizg.s['9'];
      onSelect(nativeEvent.index);
      }
```

How I can avoid this issue? Force use anonymous functions on every place? üòØ 
 Degugging:

```
console.log(onSelectHandler);
console.log(onSelectHandler+'');
```

First line will show function name, second will show function source code.

I think this issue comes from **istanbul**, I can investigate it tomorrow
 cc @dmitriiabramov 
 Yes, this is istanbul.

Related issue: https://github.com/gotwarlost/istanbul/issues/699

For now, I wanted to point out a hotfix for that. Just wrap your named func into anonymous proxy func:

``` diff
@@ -44,7 +44,7 @@ const PieChart = ({
   return (
     <RCTPieChart
       chartRotation={chartRotationInRadians}
-      onSelect={onSelectHandler}
+      onSelect={(...args) => onSelectHandler(...args)}
       segments={processedSegments}
```

And snapshot transforms then to this:

``` diff
@@ -2,7 +2,7 @@ exports[`PieChart Android should render pie chart 1`] = `
 <RCTPieChart
   chartRotation={-0.2617993877991494}
   innerCircleRadius={0.55}
-  onSelect={[Function onSelectHandler]}
+  onSelect={[Function onSelect]}
   segments={
     Array [
       Object {
```

However, this is a hack... 
 yeah.. it seems like there's nothing we can do on the jest side, unless we omit function names in snapshots.
in theory it should be possible for istanbul to keep the names of most of the functions using only static analysis, right?
 @dmitriiabramov Take a look on my snippets above...

Recap. Given this handler (AFAIK it should be an anonymous function):

```
 onSelect={(...args) => onSelectHandler(...args)}
```

It writes this handler in snapshot:

```
onSelect={[Function onSelect]}
```

How can it be?
 Yeah we should probably just get rid of function names in the snapshots. I originally liked this a lot but it is causing more trouble than it is worth.
 Will be fixed in 16.
 Hmmm... doesn't solve the problem completely if for some reason you're snapshotting a React element. It's name will turn `Unknown` in the snapshot when you enable `--coverage`.
 @dotfold if you can isolate the test case, please file a new issue with it. For stateless components you need to define `displayName` prop of the Component. See this thread for more background: https://github.com/facebook/jest/issues/1824#issuecomment-250478026 >yeah this kind of sucks. Istanbul wraps functions with other anonymous functions and we take the function name that node gives to the rendered component :(
~ @cpojer  Node 6 infers function names.

Example:
```
const Banana = () => {};
console.log(Banana.name); // "Banana"
```

this wasn't possible in previous versions of node.

It works fine when you aren't using coverage but when you do, here is what istanbul does to your code:

```
const Banana = (__cov[‚Ä¶], () => {});
console.log(Banana.name) // empty
```

because of how the expression is defined, node cannot infer the name properly. The only way to fix it is in istanbul itself or by using a babel transform that changes `const Banana = () => {}` to `const Banana = function Banana() {}`.  It is unlikely this depends on the watch mode but rather something going on in your code. Would you mind providing a repository that highlights this issue?

It doesn't look like this is a Jest issue so I'll close this issue to manage the queue. If this does turn out to be a Jest issue, I'm happy to reopen once there is more info, but it looks like a React thing and some general confusion.
  thank you!
  Any JavaScript function can be mocked simply by doing `myModule.myFunction = jest.fn()` or using `myModule.myFunction = jest.fn(() => mockReturnValue);`.
 See http://facebook.github.io/jest/docs/api.html
 @ablanco1492 I don't know of any example, but Stack Overflow is the best place to ask such questions!  @dmitriiabramov is working on that separately.
 This is awesome! Nice work and thanks for adding an integration test. My only comment is whether we should add an alias for this, given that no one will want to write `testNamePattern`.
 yes please
 Great work. Thank you for helping make Jest better for everyone :)
  Nice work! Just a small comment on the test file :)
 yay !
  Thank you @0xR, sorry that this was broken ‚Äì definitely an oversight.
  hm.. the easiest way to make it work is probably add a `setupFiles: ['removeExpect.js']` config option that will contain:

``` js
delete global.expect;
```

and then jest add a condition to the `extendJasmineExpect`

```
if (global.expect) {
  // do all the extending magic
}
```

alternatively we can either introduce `--no-expect` flag or `--no-globals`
 We should make it so setupTestFrameworkScriptFile runs afterwards. This way you can modify expect anyway you like and you can rename it to jestExpect in your project.
  Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks!
  Both for snapshots and regular diffs in other matchers, the diffs often get unwieldy and huge. Let's find a good heuristic to collapse unimportant info by default and add an `-e` (`--expand`) flag to print the full diff. It should be intentionally different from `--verbose`.

Proposed heuristic:
- Always print small diffs, collapse unimportant diffs over N lines automatically
- Always print small diffs, collapse unimportant changes based on the ratio between changed/unchanged lines. If there is a high ratio of changed lines, show all changes.
- ...?
 a couple of thoughts:
- it's important to always print full diffs when running in CI mode.
- if we implement interactive snapshot updates, we can always show small diffs and then give an option to expand (`press 'e' to expand snapshot diffs`)
 @thymikee yeah that looks great! Why `@@`? Is that what other diff tools do?
 Yeah I think this is nice! Are you going to send us a PR? :)
 I think we should keep 4 lines of context at least.
 We'll continue the conversation in the PR.
    This looks great. Nice work @zackargyle 
  I think I mentioned this on discord but we do have this in the Troubleshooting section: http://facebook.github.io/jest/docs/troubleshooting.html#caching-issues

Since this is a bug that currently only comes up when changing the `.babelrc` and I'm planning to fix that, I don't think it is necessary to add this to the webpack tutorial which doesn't mention babel configuration at all (except for the webpack 2 bit).

Thank you for sending a PR though and I'm hoping you'll send more in the future :)
 can we add `<rootDir>/.babelrc` hash to the cache key?
it'll not work with all `.babelrc` files in the repo, but will cover 90% of the cases
 Yes, I've been planning to do this for ages, actually. It doesn't need to be `<rootDir>/.babelrc` but rather we have to walk up from the filename to the root and take the first .babelrc, that's how babel works (it doesn't merge them either).
   @suchipi let me know if it works with chai snapshots!
 @suchipi we can probably just add another dependency injection here

```
class SnapshotState {
  constructor(testPath, update, snapshotFile?: SnapshotFile) {
    this.snapshot = snapshotFile || forFile(testpath);
  }
}
```

that should work, right?
  We don't specifically mock TouchableHighlight. It is rendered as View because that is what react-native renders it to.

It seems like TouchableHighlight sets props directly on its native backing element: https://github.com/facebook/react-native/blob/master/Libraries/Components/Touchable/TouchableHighlight.js#L200 and you'd need a special mock for it to make it so your prop shows up in the rendered output.

One thing that might work could be to create your own mock like suggested in the second example on the website: http://facebook.github.io/jest/docs/tutorial-react-native.html#mock-native-modules-using-jest-mock

```
jest.mock('TouchableHighlight', () => {
  const jestReactNative = require('jest-react-native');
  return jestReactNative.mockComponent('TouchableHighlight');
});
```
  thanks @LasseNisted. Would you mind sending us a PR that updates the blog post? And potentially a second one that updates the error message? It should be in this file: https://github.com/facebook/jest/blob/master/packages/jest-config/src/normalize.js
 I'm gonna close this out due to inactivity. We updated the docs for this and will soon drop these messages (probably in Jest 17 or so).
  You must not call `jest.mock('react/lib/ReactDefaultInjection')` because it disables a bunch of internal React stuff that is necessary. See https://github.com/facebook/jest/issues/1353#issuecomment-247498277
  Thanks for the PR. I think this is the wrong fix as we'd like to keep the Node 6.5 behavior. This change will break snapshots for people either on Node 6.5+ or on previous versions.

Let's do:

`const mockConstructor = function mockConstructor() {}`

this way the functions will always have a name in any version of node.
 This does seem to break one of the jest-mock tests on node 4. Repro by running `jest jest-mock` locally using node 4.
 We'll actually get rid of function names in snapshots in 16.0.0 because it is causing a lot of trouble: https://github.com/facebook/jest/issues/1740
  **Summary**
I added this ugly special case a while back when we didn't have great react-native support. Now we don't actually need this any more as I expect the community to fully switch over to the preset.

Fixes #1655

**Test plan**
the react-native example still passes.
  **Summary**
See #1671

This updates Jest to pretty-format 4.0. This version now always prints trailing commas so all snapshots will be invalidated once people upgrade to 15.2.0.

**Test plan**
jest
 yap, that's fair. We might tag it 16.0 next week.
  **Summary**
This is based on #1512 and #1526 (thanks @maximderbin!) and rewrites all the spy matcher messages and improves some of the `ensure*` messages. Finally back at writing code!

**Test plan**
jest
  Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!
 thank you!
 @suitupalex you can also probably just do `Object.defineProperty(window.location, 'href', {value: 'http://my.website.com', configurable: true});`
  MatcherContext is going to be `this` inside matcher functions.

why:
1. Right now it has only one value `isNot`, that tells you whether matcher was called with `.not` or not. Snapshot matcher will need this value in order to disable all `.not` invokations.
2. Later we'll be able to pass other context values that snapshots need (current file, suite, test names)
    before i go into working on snapshot testing, i want to make sure we have a very good test suite.

this is a more declarative way of testing snapshot without introducing much file system state (existing test fail once in a while if you interrupt `jest` before it finishes)

all test files and their content are defined in the test file and written to the fs every test, so no need to switch between directories/files every time
 üëç 
  @thymikee would you mind rebasing your diff? We just merged the concurrent reporter so we made some changes in the same modules :(
 @thymikee I polished the implementation a little bit and I think it works pretty well now both in the concurrent and in-band mode. Would you mind giving it a try and letting me know what you think? I removed the "Press c to cancel a test run"-line so we aren't making the watcher messy, especially since cancel can only be used during a run. However, with the new concurrent reporter, printing a message during the run on how to abort also seems kind of odd. Do you have any suggestions on where to hint at that pressing "c" will cancel the run?

Also cc @gaearon because he requested this feature. Try it out!
 Do we need a separate command? Can we make existing commands just keep working instead?

Basically all I wanted is to be able to `p`, type another pattern, press Enter, and have Jest acknowledge that during the test run. Same with `o` and `a`.
 @gaearon you are saying that any existing command should cancel if a test run is active?
 I think that _on confirmation_ (`p` confirms on `<Enter>`, `a`, `o`, and `<Enter>` itself confirm immediately) the existing command should cancel, clear the screen, and the new command should run.
 This is what it looks like now:

![jest-interrupt](https://cloud.githubusercontent.com/assets/13352/18941777/cb0176dc-864e-11e6-90f9-96921bb47650.gif)

Took @gaearon's suggestion, even hitting "enter" during the run will abort. Let's see how people like it.
  We are not going to be able to help you without a repository that shows this issue. Note that this is unlikely a Jest issue but rather a testing question on how to write a test for a specific react-native component. Feel free to add more info but I'm going to close this to manage our queue.

Happy to reopen if this turns out to be a Jest issue.
  Please also add `coffee` to `moduleFileExtensions`. Jest only looks at files with this extension and then testRegex is used to narrow down the files.
  nice work!
  @cpojer what do you think?  @kentaromiura works at FB and brought this up. I think we should do it at some point.  i have some flow errors that are only thrown using `flow-bin@0.32.0`. Updating it here so i can rebase later
  thank you!
  thank you!
  Yes, this isn't supported currently. See https://github.com/facebook/jest/issues/1377
  Would you mind actually switching this out and adding in babel, typescript and async-to-gen? All the other tools are basically deprecated. Thanks Lee!

Have you considered switching graphql to Jest? :P
 thank you <3
  cc @dmitriiabramov 
 ‚ù§Ô∏è 
  hey @thangngoc89!
you can pass a testRegex directly to cli

`jest integration-tests` should just work!
  Thank you! I think the plan is to deprecated this option and add something like `jest.setTestTimeout()` instead so I'm not gonna merge this for now.
  Hi.
I have some code that depends on node-etcd, which in turn depends on deasync.
The code runs fine, under node 6.5 and 6.2.
I've added a simple test for that code using jest, and when executed, jest fails with the following:

```
 Could not locate the bindings file. Tried:
     ‚Üí /home/reflog/dev/basicServer/node_modules/deasync/build/deasync.node
     ‚Üí /home/reflog/dev/basicServer/node_modules/deasync/build/Debug/deasync.node
     ‚Üí /home/reflog/dev/basicServer/node_modules/deasync/build/Release/deasync.node
     ‚Üí /home/reflog/dev/basicServer/node_modules/deasync/out/Debug/deasync.node
     ‚Üí /home/reflog/dev/basicServer/node_modules/deasync/Debug/deasync.node
     ‚Üí /home/reflog/dev/basicServer/node_modules/deasync/out/Release/deasync.node
     ‚Üí /home/reflog/dev/basicServer/node_modules/deasync/Release/deasync.node
     ‚Üí /home/reflog/dev/basicServer/node_modules/deasync/build/default/deasync.node
     ‚Üí /home/reflog/dev/basicServer/node_modules/deasync/compiled/6.5.0/linux/x64/deasync.node

      at bindings (node_modules/bindings/bindings.js:88:9)
      at node_modules/deasync/index.js:34:32
      at Object.<anonymous> (node_modules/deasync/index.js:76:2)
      at Object.<anonymous> (node_modules/node-etcd/lib/client.js:7:11)
      at Object.<anonymous> (node_modules/node-etcd/lib/index.js:9:10)
      at Object.<anonymous> (lib/server-base.js:16:12)
      at Object.<anonymous> (lib/test/testRun.js:2:23)
      at process._tickCallback (internal/process/next_tick.js:103:7)
```

Indeed, the files that are mentioned in the error are not present, but, to reiterate - when running the same test file without jest (just the actual test code) - it runs fine.

I guess something in the way jest initialises node environment confuses the bindings library.

If any additional details are need - I'm happy to provide.

Thanks in advance!
 Thanks for reporting. This does seem like a bug!
 Awesome! Do you want me to create a repo to for reproducing the problem, or it's clear for you? 
 A repo would be helpful, yes! Sorry for the bug.

On Wed, Sep 14, 2016 at 11:21 PM -0700, "Eli Yukelzon" <notifications@github.com<mailto:notifications@github.com>> wrote:

Awesome! Do you want me to create a repo to for reproducing the problem, or it's clear for you?

## 

You are receiving this because you were assigned.
Reply to this email directly, view it on GitHubhttps://github.com/facebook/jest/issues/1694#issuecomment-247245425, or mute the threadhttps://github.com/notifications/unsubscribe-auth/AAA0KJ7REXOF06_QVQSnaXmvBZBpc4Bnks5qqOPcgaJpZM4J8_RS.
 Welp. It's always useful to create a reproducing repo. This way - you find out, that you are a dumb ass :) Apparently, I forgot that I had a preprocessor for Typescript, (ts-jest) and it was the one causing the problems.

Jest is not at fault here. Yey!

Closing the issue - no bug here.
Thanks!
 I've opened the bug in ts-jest https://github.com/kulshekhar/ts-jest/issues/2
 @cpojer , with help of @kulshekhar we came to the conclusion that it is, in fact a problem with Jest.
Here's a repo with steps to reproduce:
https://github.com/kulshekhar/jest_bug_test

To check:
1. do 'npm start' -> it will successfully run the code
2. do 'npm test' -> it will fail to find the bindings

This repo doesn't use any preprocessors, it's just jest and javascript.

Thanks in advance!
  We tested this with your repro (thanks for that) and it seems like the issue is the class-properties transform that you are using in `Toggle.js`. We have `retainLines` set to true in `babel-jest`, however when this transform is enabled it doesn't seem to be respected properly. This might be impossible unless all the class properties are defined right after the constructor. Maybe file an issue with babel?

For now we don't support source maps in babel-jest so I'll close this as wontfix but if transforms become more advanced some day we'll reconsider adding support for them to show more accurate stack traces.
  This was fixed in https://github.com/facebook/jest/pull/1639. We'll make a release tomorrow.
  that seems to be expected with https://github.com/istanbuljs/istanbul-lib-instrument/pull/22 being shipped
  actually.. we already have `expect(jest.fn()).toHaveBeenCalledTimes(x)`
but unfortunately it's not documented :)
sorry.. we're still cleaning things up in our documentation
  fixes https://github.com/facebook/jest/issues/1630
 nice work.
  add support for testing using generator functions per https://github.com/mxstbr/react-boilerplate/pull/980

cc @mxstbr
 please rebase and then merge. LGTM.
 I don‚Äôt quite understand this, can you please help me get the use case?

@mxstbr 

Can you clarify what you meant by "generator support" in https://github.com/mxstbr/react-boilerplate/pull/980#issuecomment-246182724?

I‚Äôm confused because your comment was about `redux-saga` but I don‚Äôt think it uses generators via `co` at all, it interprets them. So I don‚Äôt understand why the feature this PR added was needed.

Thanks!
 In particular I‚Äôm not sure why [this function](https://github.com/dmitriiabramov/react-boilerplate/blob/09250fa870cca05a80ff8d45b50d234e5873a848/app/containers/HomePage/tests/sagas.test.js#L85-L91) (presumably being the reason for this PR?) is a generator. It doesn‚Äôt `yield` anything, does it? Are there some special semantics I‚Äôm missing?
 actually, i think i just implemented the generators support without understanding the full context first.
and yes. it seems like this PR doesn't affect  [this function](https://github.com/dmitriiabramov/react-boilerplate/blob/09250fa870cca05a80ff8d45b50d234e5873a848/app/containers/HomePage/tests/sagas.test.js#L85-L91) 
It seemed very straightforward to me, but it turned out to be not :) we should probably revert this PR and then i'll look into how we can make react boilerplate tests work after that
 @mxstbr Thanks, I guess my question is why was this test function a generator in the first place? What was is supposed to yield? How did you expect generator functions to be handled as test cases?
 @mxstbr I‚Äôm just not sure why this function is a generator at all. It doesn‚Äôt `yield`, does it?

To be clear I‚Äôm not arguing against anything. I‚Äôm just trying to understand why that function has a `*` üòÑ 
 @garth Why were the functions written as generators? Can you show an example? I think we're open to adding support but it's just not clear what the semantics are supposed to be. Why not use `async` / `await`? 

```js
    it('returns 404 for wrong username/password', async () => {
        const res = await server.inject({
             method: 'POST',
             url: '/login',
             payload: {
                 username: 'bar',
                 password: 'foo'
             }
         });
        expect(res.statusCode).to.equal(404);
     });
 });
```

Unlike ad-hoc special treatment of generators returning promises, `async` / `await` is (almost) well-specified part of the language designed specifically for this.  hey @andersonjb 
you should add `.jsx` to `moduleFileExtensions` config options
this will soon be the default behavior.
you can refer to this PR https://github.com/facebook/jest/pull/1668/files#diff-ab09e5aa1ed478de64fca31554ece7ddR36 :)
  thank you!
  This should be answered by the React team. I think it would be useful to have but I don't know about their plans.

See https://github.com/facebook/react/issues/7148
  I've tried to repro this with both iterm2 and Terminal.app and zsh and bash and couldn't repro.

Here are the settings I used (+ the bash overwrite):
<img width="777" alt="screen shot 2016-09-14 at 2 23 13 pm" src="https://cloud.githubusercontent.com/assets/13352/18530534/d4cb97a2-7a86-11e6-82bf-a7a8566cbd12.png">

It looks like this is related to your setup. When I use zsh, for example, it doesn't ever open the new tab in the current working directory of the previously active tab.
  what node version did you upgrade from?
 Yes this is expected. Node 6.5 and its v8 version are smarter at detecting function names.

For example:

```
const obj = {
  apple: () => {}
};
```

`obj.apple.name` might be `apple`. Update your snapshots and you are good to go!

In the future, updates to node or Jest may require you to update your snapshots. This is expected.
 Yeah I'd recommend explicitly giving these functions a name. Unfortunately I don't have a good answer for this ‚Äì we'd like the function names to be in the snapshot because it could be an unexpected change.

I understand that this is unfortunate but I believe these changes are happening rarely enough on the engine level that it isn't gonna be a huge issue going forward. Node 6 is going to be an LTS release soon and it can be made a minimum requirement.
  thank you!
  @mjackson i think the biggest issue will be migrating `expect(x).toMatchSnapshot()`
and we haven't quite figured it out ourselves yet :)

the issue here is that it depends on some jest global state (like current running test, filename, whether it's running in `--update` mode or not, etc). and that means that there has to be some pretty complicated integration with the test runner.
and also
whenever something doesn't match snapshot, we don't really throw an error right away. Instead, we log the failure and decide what to do with it after the test finishes.
 We won't be adding the snapshot matcher to expect from the beginning. For now it will just be `jest-matchers`. Snapshotting is done in its own package, `jest-snapshot`. We will explore ways to bring snapshotting to other runners through `expect` (cc @suchipi) but it isn't our immediate goal. @dmitriiabramov didn't know this was coming because I failed to communicate with him.
 Small update: we just added `expect.extend` :) We are working on making this happen!
 Hey @mjackson,

we are tracking this internally right now. The JS Tools team is pretty busy until the end of year with our three projects (Yarn, Jest and react-native-packager) so we may not make a ton of progress on this immediately but it's definitely one of our goals to make this work well. I'll share something more soon :)
 I believe there is value in the `not` negator but any more dots to chain matchers is not really useful imho. I understand this is subjective but I believe the current style in Jest is clean and straightforward. We can also build simple modules that will bring back things like `toNotEqual` because it's implementation is basically just `expect(foo).not.toEqual()`.
 @vjeux is helping out to make this a reality.

Here is what was done so far, among adding a ton of features to `jest-matchers`:

* expect.extend was recently added. This has a slightly different but a lot more powerful in `jest-matchers`.
* Remove jest-snapshot from jest-matchers: #2390.
* Change the export of `jest-matchers` to export `expect` directly: #2391.
* Remove the dependency on jasmine: #2389
* Move asymmetric matchers from jasmine to Jest: #2396

**TODO**

* A codemod that does ~80% of the conversion.
* `expect.assert` doesn't really make much sense because node comes with `assert`. I'd rather not add it and include it in the codemod.
* Add `spyOn` to Jest: we are currently unsure whether it should be a separate module (`jest-mock`) or whether these should be on `expect`. I would prefer to make this a breaking change and have the codemod take care of it. Is this ok @mjackson?

Assuming we'll figure out these things soon, are you happy to transfer ownership of the project to us? (edit): We'll likely support the syntax that is supported in node 4 and up. You can add an additional transformation step for the environment you are using.

Also, the current expect library is great and works well. If you've been happy about using it in the past and you don't want to upgrade on existing projects, I think that's fine too. Here's an example of the before/after

jest-matchers:
![image](https://cloud.githubusercontent.com/assets/197597/21371951/2ccba31c-c70c-11e6-9a27-cec7ec336eb7.png)

current expect:
![image](https://cloud.githubusercontent.com/assets/197597/21371965/4805fd9e-c70c-11e6-8087-ea695a420515.png)
 Can you provide us with an integration test? How does expect work in the browser? Do you ship a single build file of it or do you let webpack/browserify take care of the bundling? There is nothing that should prevent jest-matchers to work in the browser (assuming `chalk` is shimmed properly) but we haven't tested it yet.

cc @zertosh who knows how to create bundles for webpack. Can you help us get a build file of the "jest-matchers" package? @mjackson Jest is also running in `jsdom` Yeah, we are of course happy to support `spy` and `spyOn` but I think it is better to keep them separate inside of `jest-mock` as `mock.fn` and `mock.spyOn`. `expect.spy` and `expect.fn` doesn't really work that well imho and I'd prefer not to add *too much* to expect, it's already a lot. FWIW I've been using `expect` in online courses on JSBin a lot. @gaearon you can use Jest in the browser via repl.it: https://repl.it/languages/jest

@mjackson if you can send a PR to Jest that bundles up jest-matchers, that would be great. If there are any issues for running the browser, we'll obviously fix them but I don't expect any real issues once we have a bundle. I'd like to switch the name over to expect in early January. @cpojer My content for Egghead includes specifically JSBin links because they are integrated, adding another third party service to the mix is going to be confusing. It doesn't matter for me (although `expect@latest` will likely break and I need to replace it) but just saying other people may use it in training materials too and might not want to use replit for one reason or another. @mjackson, @gaearon do you have examples of codebases using expect? I'm writing a codemod to convert to jest-matchers and would like to try it.

http://astexplorer.net/#/P1ejE5e6sh/1 https://github.com/ReactTraining/react-router Update: http://facebook.github.io/jest/blog/2017/02/21/jest-19-immersive-watch-mode-test-platform-improvements.html#expect-improvements

Done:
* A codemod that does ~80% of the conversion.
* Added `spyOn` and `fn` to `jest-mock` as a standalone module. Within Jest, `jest.spyOn` and `jest.fn` are available.
* `jest-matchers` is now standalone and works in the browser.

Todo:
* The codemod doesn't handle the conversion from `expect.spyOn` to `jestMock.spyOn` yet.
* Write a page in the documentation on how to convert everything.
* Rename `jest-matchers` to `expect`.

I think we are ready to cut over any day now :) Here is the process:

* `yarn add --dev jest-matchers jest-mock`
* Install jscodeshift and download https://github.com/cpojer/js-codemod/blob/master/transforms/expect.js
* Run `jscodeshift -t path/to/expect.js <folder or files to transform>`
* Replace `expect.createSpy` with `const mock = require('jest-mock'); mock.fn()` and `expect.spyOn` with `mock.spyOn`. *Note: we made a behavior change here: by default, spyOn calls the original implementation (that's why it is a spy). If you don't want that, use `mock.spyOn(‚Ä¶).mockImplementation(() => {})` or `obj[method] = mock.fn().*. If you are using Jest, then you can use `jest.fn` instead of `mock.fn`.
* Try to run it.

When hitting errors, take a note on what doesn't work and list them here for us so that we can either make a decision not to support it (breaking change) or update the codemod. Then advise on the next steps please.

I recommend the following:
* Make a detailed upgrade guide that explains how to run the codemod and how to manually update the breaking changes we are making.
* Rename `jest-matchers` to `expect` and publish a release (it would be version 19.x.x).
* Update Jest to use `expect` instead of `jest-matchers`.

Since the current version of the expect package is kind of at the end of life, if people aren't willing to upgrade to the new version of expect, there isn't really any issue with people staying on the old version. It works and is fine. Hey @skovhus, you are a codemod pro. Do you think you could help us out here by taking https://github.com/cpojer/js-codemod/blob/master/transforms/expect.js and putting it into jest-codemods and adding a few of the fixes that @kentor just mentioned?  Thanks for the PR. This is really useful, especially also for our internal use of Jest. Can't wait to update Jest there and delete some old code! I think the actual implementation can be simplified quite a bit. We already basically have a code path for related tests: the `findChangedTests` function in SearchSource.js that is invoked when `patternInfo.onlyChanged` is true.

I suggest implementing this feature similarly: if `patternInfo. findRelatedTests` is true (should be the second assertion right after `onlyChanged` in `getTestPaths`), call a new function `findRelatedTestsFromPatterns`. This function will resolve all the input arguments from the `patternInfo` object into absolute paths and do something like:

```
const paths = new Set(resolvedAbsolutePathsArray);
return this.findRelatedTests(
  new Set(Array.prototype.concat.apply([], changedPaths)),
);
```

Does this make sense? I think that should help solve the problem more elegantly and with less code ‚Äì plus it will allow us to use this feature in our internal runner. Would you mind making the suggested changes? Thank you!
 Thank you for sending a PR and adding this option! :)
  yes. this is directly proxied to istanbul. we should add it to the docs!
  Thank you! Do you mind adding a test as well?

We should probably replace every character that would make the code we eval illegal, however.
 Thanks. The reason why we do this is so that errors etc. preserve the name. In practice, this hasn't caused much trouble. Thank you for the fix! Just waiting for CI now.
 I think this is fine for now. This is a rare enough edge case that most people never run into it :)
  Thanks Maxim. I'm gonna spend some time myself to clarify the documentation in a separate PR. I don't think it is helpful to provide different options for debugging and I'd like to stick to explaining one solid method.
  thank you!
  There is a `coverageThreshold` configuration option for this. http://facebook.github.io/jest/docs/api.html
  I totally agree we should have this! In fact, in our more advanced runner internally at FB we have this. Do you mind working on a PR for this?

Check out how changedFiles is used in SearchSource: https://github.com/facebook/jest/blob/master/packages/jest-cli/src/SearchSource.js#L20 ‚Äì we could make it so if a list of files is passed and the `--changed` option is passed, we sidestep the git/hg check and just use that list of files (and do `path.resolve(cwd, file)` on all to turn them to absolute paths).
 Thanks @okonet for the proposal. To make sure we don't have duplicate issues, I'm gonna close this issue in favor of the PR.
  In Jasmine you need to define all your tests (calls to `it` or `describe`) before the end of the test. This is a limitation we can't do so much about right now. Can you make it so your tests are generated synchronously? beforeAll definitely does work in Jest, however and can be made async too. `beforeAll` is called before the first call to `it`.
 if your definition is fetched asynchronously there is nothing we can really do to make it work :(
i think the best solution would be to stick it all into one test case and provide nice messages if something failed:

``` js
test('some api', () => {
  generateApi().then(api => {
    return promiseAll(api.routes.map(route => {
      return new Promise(route => invariant(true, `${api.name} ${route.name} test failed because of something`));
    });
  });
});
```
  thank you for the fix!
   TypeScript currently requires a custom preprocessor and we don't have an official one and there are issues with source map support. I'm worried people might have js build files and ts source files and that with this change both of them will be picked up. I'm not sure how much of a concern that is, just worried it might mess things up. What do you think?
 removed typescript
 even better defaults!
  By default Jest runs all `*.test.js`, `*.spec.js` and files inside of `__tests__`. You can adjust the `testRegex` config option to whatever you like.
  should we add them to fix the diffing?
<img width="258" alt="screen shot 2016-09-09 at 9 59 04 pm" src="https://cloud.githubusercontent.com/assets/940133/18408079/e43ad9ac-76d8-11e6-9b94-7b4559f6f3c3.png">
 yes I totally agree we should always print trailing commas in pretty-format if we show a multi-line diff, just like we do in our code style. This will make diffs better.

cc @thejameskyle
  Hey! This is most certainly a minor issue with your code. Unfortunately without a repository that highlights this issue we won't be able to help.

Feel free to post this here and we can take a look but I'm closing this issue for now to keep the queue clean. Happy to reopen if this turns out to be a Jest issue.
  you are the best! I shall invite you to a nice dinner and/or beer.
  agree we should have this. @kittens was looking into this actually.
 Will be implemented in the next release, see the attached PR :) Nice work @fson.
  `jest.resetModules()` is synchronous. Old module references are still available however:

```
const React1 = require('react');
jest.resetModules();
// React1 is still available here.
const React2 = require('react');
// React2 is a new copy of React.
```
  wow this is awesome. Sorry it took me a while to get to this. I love this PR.

I think the global mock registry is gonna get us into huge trouble. For example when we run tests in the same process (using -i), we could theoretically run them concurrently. There is no guarantee in Jest that only one test is running at a time so it is entirely possible that one test clears mocks from another, which would be pretty bad for our isolation guarantees.

Instead, I would recommend to add the mock registry as an instance variable on Runtime. Since all mocking APIs are forwarded to the test from the runtime, we can make it so the mock registry is passed into `jest-mock` from runtime via currying or wrapper functions around everything in jest-mock. What do you think?
 It's ok to change this right now. There aren't any other envs that I'm aware of and we can bump versions to signal this change. I really like the idea of the mock registry being part of the env.
 sounds good!
 thanks for all the work! This is awesome :)
  thanks!
  thank you!
  Jest doesn't really support module.parent, which is used here: https://github.com/hypercloud/import-dir/blob/master/index.js#L14

You can try adding a fully compatible version of it here: https://github.com/facebook/jest/blob/master/packages/jest-runtime/src/index.js if you'd like but honestly I'd rather not support this.
 importDir seems kinda crazy. For static analysis reasons I generally recommend to stick with require and import, also works with `jest --watch` to only run the minimum amount of files that were changed.
  We don't really have a way of doing this on the framework level and I don't think we need to. I recommend you to make your globals injectable and then write your tests like so:

```
it('works with this config', () => {
  MyStyles.inject({stylesA});
  expect(‚Ä¶).toMatchSnapshot();
});
it('works with that config', () => {
  MyStyles.inject({stylesB});
  expect(‚Ä¶).toMatchSnapshot();
});
```

Alternatively, you can also reset modules and redefine your globals:

```
it('works with this config', () => {
  jest.resetModules();
  globals.styles = MyStyles;
  const React = require('react');
  const MyComponent = require('MyComponent');
  expect(‚Ä¶).toMatchSnapshot();
});
```

Both of these options should be sufficient without introducing complexity to Jest.
  It defaults to `node_modules` in Jest normally unless you use react-native without the react-native-preset (which isn't recommended). Unless of course you overwrite it manually.
 If you called Jest like that, then it always used `development` as env.
 Oh, I'm sorry, I thought this was the other issue you created.

This is indeed odd. Do you have react-native installed? There is some magic Jest is doing that we don't need to do any more, I should clean that up.
 Does that download react-native at all? Like, do you have a react-native folder in node_modules/react-native?
 yeah, probably best to use moduleNameMapper here and get rid of the react-native folder. Now that we have the rn preset as the recommended way to use Jest and RN together, we can remove our magical shitty hack in Jest too! :)
  Yeah you are right, we should add documentation for this. Jest sets the NODE_ENV to test if it isn't provided and otherwise let's you use a custom override. We don't use BABEL_ENV at all. I'm gonna close as wontfix but I'm happy to accept a PR for documentation.
  Duplicate of #1650.

Usually we recommend using a preprocessor in this case and running on the source. Can your compile-to-JS language compile individual files synchronously?
  This is interesting. Is it possible that node's `--debug` flag doesn't work when using the `vm` module to create a context?
 I think we need to create a repro without Jest and submit an issue to the node.js bugtracker.
 @orta and I were literally talking about this. It works for him in vscode, so we may not need the node-debug environment. I think `--debug-brk` and starting Jest with `-i` will work.

I appreciate you building the debug environment, this is exactly how I'd have done it too. I guess it makes sense to limit this to:

* Jest runs a single test file
* It's not in watch mode

One of the problems with this is that you can get the global variable other than `global` that we pass to a file run in a Jest context. I'd really like to figure out how the node team could fix v8, that seems like the long term fix :( This is not a Jest issue. This is a bug in v8/node, see https://github.com/nodejs/node/issues/7593 ‚Äì please express your concerns there and ask the node or v8 teams to fix this within vm/contextify. I'm going to close this issue because it isn't actionable from our side. Some workarounds were documented above, that may or not work for you. Once this is fixed in node/v8, it will automatically start working eventually.  snapshots are colocated with tests and they are definitely not meant to be for machine readability. They are meant to be reviewed by humans, both the author of a test and the code reviewers.
 Jest also ensures that there are never any stale snapshots in the system. This means we both need a way to map from a snapshot to its associated test and back. This seems kinda hard to configure via string values in the JSON config :(
 I don't really quite understand what you mean. The snapshots are colocated with tests and there is a 1:1 mapping between `testfilename.js` and `__snapshots__/testfilename.js.snap`?
 but that is the opposite of colocating snapshot files with their tests, isn't it?
 I'm not religiously opposed to this if you want to do all the work necessary to support this, find a way to make this maintainable and test it well.
 We can also help on our discord channel and happy to review code, of course :)
 I'm sure you find many people that share your opinion. Testing is like a religion to people and I'm happy to support all kinds of doing this as long as it integrates well with Jest and is well tested itself.
 This is something where we'll need some help from the community. I think a good way to support this is by adding a config option `resolveSnapshots` that points to a module with two functions:

```
exports.resolveSnapshotFile = testPath => snapshotFilePath;
exports.resolveTestFile = snapshotFilePath => testPath;
```

this way we can call these methods to resolve the snapshot path from a test path and the other way round and it will enable use to keep snapshot files consistent.
 I'm gonna close this given the inactivity. If somebody would like to work on this, I'm happy to reopen this and review a PR :)
 Actually at this point I don't really think I want to support this feature. It adds unnecessary complexity and gives almost no value.  thank you!
  We don't really have this available with Jasmine 2 right now. We might be able to fix this once we replace jasmine with a compatible runner but not until then. I agree we should fix it and it will be automatically fixed when we get to this bigger task, so I'm going to close this task to keep our queue clean :) Sorry it isn't awesome yet.
  `test` is not an alias for `describe`, it's an alias for `it`

the correct usage would be:

``` js
describe('...', () => {
  test('something', () => {});
});
```

or without a top level describe (as in tutorial):

``` js
test('something', () => {
  expect(1).toBe(1);
});
```
 we should probably throw when `it` is used during the test execution to avoid this kind of confusion, but we won't be able to do this until we replace jasmine.
  thanks!
  jsdom doesn't ship with `requestAnimationFrame`. You'll need to put a polyfill into your `setupFiles` config like this one: https://gist.github.com/paulirish/1579671
 The test renderer currently doesn't support refs; this is a feature the React team is currently working on.
 I think probably like 15.4 but I'm not on the React team, so not sure. See https://github.com/facebook/react/pull/7649
  Jest's requires node's APIs so to my understanding it will not be able to run together with karma.
 Also see #848 
  Oh, thanks for noticing! Actually the readme is generated from the `docs/GettingStarted.md` filed when you run `npm start` inside the website folder. Would you mind making your change there?

I think this was meant to say `interactive watch mode`. Would you mind changing it into that? Thank you!
 thank you! It wasn't updated previously I assume :)
  Can you provide a repo with this bug? Thank you.
 If you use create-react-app you cannot customize your Jest configuration.
 Constants is a node core module. If you type `node` and then `require('constants')` in the repl, it'll give you that module.
 Yeah, in Jest the resolution algorithm always looks at core modules first and returns them, you'll probably need to rename it. I'm sorry, we can't really fix this :(
 We could do this, however we are following node's module resolution algorithm which always prefers core modules over other modules that may match, see https://nodejs.org/api/modules.html#modules_core_modules
  Stringify sees a circular reference in a flat array that looks like this:

```
const a = {foo: 'bar'};
const b = {a: 5};
expect([a, a]).toEqual([a, b]);
```

will print the first object as `[{foo: 'bar'}, [Circular]]`.

cc @dmitriiabramov
 yeah. i guess we should take nesting levels into account to when we stringify.

tbh i think this stringify thing should be an `ugly` mode of `pretty-format`, we're almost duplicating the same thing
 I agree cc @thejameskyle ‚Äì can we make it so pretty-format has an option that doesn't print newlines?
 Yes, the circular printing is an issue with our own stringify function. I'd prefer to use a single-line version of pretty-format though.
 Fixed in 16.
  Would you mind adding an integration test for this?
 > Error: EPERM: operation not permitted,

Hey @insin, you can avoid that issue by using an administrator command prompt. Windows requires admin rights to create symlinks, and Lerna does not have an option to use NTFS junctions (which don't require admin rights)
 merging anyway. Thanks for the fix!
 (yolo)
  If you look into your project (including node modules folders), are there two `__mocks__/View.js` files?
 This is really odd. Can you potentially do this:

console.log(require.resolve('View'))
console.log(View) // this might need some more advanced logging?

to see if we are getting different values for each?

Jest mocks out View with a mock of the real version of View in jest-react-native's setup script. I'm unsure how it is getting two different versions. The only thing I can think of is that you might use a react-native version prior to 0.30? (edit: nevermind, I saw you are using 0.32).
 If you can figure out a way to repro this and put it on github for us to npm install and npm test, that would be really helpful here.
 üéâ 
  Yeah this is a bit odd. We need `moduleFileExtensions` to find all files that we need to look at with watchman (at FB we have tens of thousands of files in repos with more than a million files etc.). Then we use testRegex on top of that to find the actual tests. I understand this is not very intuitive. We should probably update the documentation and also add jsx as a default for the next release.
 not sure if `.ts`, `.tsx` worth adding to defaults, but it will simplify configuration fro typescript projects and probably won't make it worse for the rest.
https://github.com/facebook/jest/pull/1668
 This is gonna be in the next release tomorrow. Thanks @dmitriiabramov.
  See http://facebook.github.io/jest/docs/tutorial-react-native.html for an updated guide on how to test react-native. Please also upgrade to Jest 15.
  Fixed in https://github.com/facebook/jest/pull/1745

Dammit, if Flow would have been set up properly in the project, I would have caught this when I changed jest-diff initially :(
  added some globals that i always wanted.

```
xtest
test.only
test.skip

context
xcontext
context.only
context.skip

describe.only
describe.skip
```

we also need to add them to all the lint rules
 that is a ton of new globals.
 worth it!

still, i think the ideal solution would be to enable

``` js
{
  globals: false
}
```

in the config and then 

``` js
import {it, describe} from 'jest';
```
 but we can't actually shadow jest with our own module because how are you gonna require jest in a jest test then?
 https://github.com/facebook/jest/blob/master/packages/jest/src/jest.js

i think we can actually export it here instead of proxying `jest-cli` and leave cli to `jest-cli` :)

do we have anything that uses `require('jest')` programmatically?
 I mean, we can probably survive.

tbh I kind of want to keep the globals. I'm not happy with the one-line boilerplate in every test‚Ä¶
 I feel like context is a very common variable name as opposed to `describe` and `it`. I don't really think we should add it now.
 yeah. let's kill context. its semantics is hard to understand too
 @dmitriiabramov is way ahead of you: https://github.com/sindresorhus/globals/pull/97
 @dmitriiabramov are you going to add them to the documentation? Otherwise it's a pretty undiscoverable feature.

http://facebook.github.io/jest/docs/api.html#the-jest-global-environment
 @vjeux yes! i'll submit a PR with the docs a bit later :)
   definitely! thanks
  sorry. the build was red because i broke master :)
  thank you!
  This is a good idea, thanks for starting a PR.
 I'm gonna close out this issue in favor of the work that is going on in the PR and to make sure there is only one place we are discussing it :) Thanks for all your work so far!
  <img width="621" alt="screen shot 2016-09-06 at 12 45 46 pm" src="https://cloud.githubusercontent.com/assets/940133/18288360/e01c3178-742f-11e6-98b3-86ceb20ad6d2.png">
  Yes that is indeed a bug! Is this something you (or anyone else who is running into this) could help out with? The code should be somewhere around here: https://github.com/facebook/jest/blob/2699ed50ae4f849dfc384d3a4f4c4687b9fb24b0/packages/jest-resolve/src/index.js#L201
  \+ it's in the repo title
 this is transformative.
  the problem is that `pretty-format` has exactly the same formatting for both immutable lists and arrays

``` js
> Immutable = require('immutable'); format = require('pretty-format');
[Function: prettyFormat]
> format(Immutable.List([1, 2, 3]));
'Array [\n  1,\n  2,\n  3\n]'
> format([1, 2, 3]);
'Array [\n  1,\n  2,\n  3\n]'
>
```
 I think the right fix for this would be to do two diff passes: one that uses `toJSON` inside of pretty-format and if the two objects are identical, call pretyt-format again with `toJSON` ignored. This will require some small changes to pretty-format and jest-diff.
 This will be fixed in 16. See https://github.com/facebook/jest/pull/1752
  You should tear down your connection in `afterEach` or `afterAll`. Jest doesn't tear down the connections for you.
 No, this is just normal node behavior. If you spawn async work, node will not quit until that is finished. The test framework you previously used probably just killed the process.

We could do that but we don't really want to ‚Äì it could mask bugs in your code where you don't clean up resources in your code.
  yes it is, just do it like you wrote.
 that means it is very likely you have an infinite loop somewhere and node just crashes.
  Unfortunately I don't have access to the new version of macOS yet. Do you have some time to help troubleshoot and potentially fix the issue? See https://github.com/facebook/jest/blob/master/CONTRIBUTING.md#worfklow-and-pull-requests for how to get started.

Can you try `--no-watchman` to see if this is a watchman issue?
 It probably makes sense to console.log in this promise chain: https://github.com/facebook/jest/blob/master/packages/jest-cli/src/jest.js#L133 and see where it gets stuck.

If you are using the Jest repo itself, make sure you do `npm run watch` in a background tab to keep compiling your files. You can also just insert those logs into the build file of jest in your project.
 @wez are there any known problems with watchman on macOS Sierra?
 It seems like this is a watchman issue because Jest works fine if watchman isn't installed. I opened an issue on the watchman bug tracker but happy to reopen here if it turns out to be a Jest issue.
  Thank you!
  thank you!
  thanks!
  Thank you!

I'm probably going to turn this into a bullet list later but for now this is good.
  Thanks @fson!
  I agree we should use natural sort for numbers.
 Yeah, let's use natural sort for this like I recommended previously. This should only require the sort call from here: https://github.com/cpojer/jest/blob/dfa96d6d9a67ac21b5b64d3baa68f50f177e9cc9/packages/jest-snapshot/src/SnapshotFile.js#L108 to be changed to natural sorting. I'm sure there is an npm module for this :D
 Implemented in #1732 and will be merged soon.
  we should probably implement some kind of path normalization function that will lowercase the `C:\` and escape all special characters

cc @Daniel15 
 Hmm... Are we hand crafting JSON here? JSON.stringify should be escaping
the backslashes.

Case sensitivity issues are also present on Mac OSX, which also uses a case
insensitive file system by default. We probably need to normalize all file
paths regardless of OS. There's a separate issue for these case sensitivity
issues (on Windows it's often c:\ vs C:)

Sent from my phone.

On Sep 6, 2016 7:11 PM, "Dmitrii Abramov" notifications@github.com wrote:

> we should probably implement some kind of path normalization function that
> will lowercase the C:\ and escape all special characters
> 
> cc @Daniel15 https://github.com/Daniel15
> 
> ‚Äî
> You are receiving this because you were mentioned.
> Reply to this email directly, view it on GitHub
> https://github.com/facebook/jest/issues/1611#issuecomment-245154393, or mute
> the thread
> https://github.com/notifications/unsubscribe-auth/AAFnHa6NuhHHyoAKKcMssLFa379tGsO8ks5qnh1qgaJpZM4J02fw
> .
 hm... we shouldn't be writing any JSON manually. this is strange
 I confirmed that `JSON.stringify` correctly escapes `\` characters, so there must be something else that's causing this JSON to be invalid.
 @Daniel15 i'll look inside istanbul coverage reporters. most likely it's something in there that's causing this
 @IljaKroonen we'll need more info to be able to troubleshoot this issue. Can you provide a repository that we can npm install and npm test that highlights the issue you are running into? Thanks!
 Wow, good catch @kwonoj! 
 thanks @kwonoj. This should be within the semver range when istanbul gets published so it should be fixed in Jest automatically with a reinstall once your PR gets merged and released. Closing here.
  I don't understand what issue you are referring to. Every test is run all the time when Jest runs a test file. `jest --watch` by default only runs test related to changed files. This works by building a reverse dependency tree and looking up test files.
 `-o` is best effort. If you don't have a git repository or if all files depend on the changed file, all tests will run. It is mainly an optimization so that locally the test runs are minimal and fast.
 Let's assume this dependency tree:

```
a.test.js
 - depends on: c d
b.test.js
 - depends on d
```

When you change `d`, we will run both tests. When you change `c` it will only run `a.test.js`.
  thank you!
  `cacheDirectory` is configurable for this reason. We used to store it inside of Jest but it was always a huge issue to people so we changed to a temp folder. Please configure Jest the way you like for your CI :)
  I think that will be quite annoying if you have looads of snapshot files and all of them have the same header.
 I think to do this we need two things:
- A detailed blog post explaining what snapshot testing is and why it is useful (and when not to use it). @kentcdodds are you willing to help with that for the Jest blog?
- A simple 3-5 word explanation so that the comment with URL fits into one line.
 I'm gonna close this out due to inactivity. It hasn't really come up, so I'm inclined to keep snapshot files to the bare minimum.
  It seems like we aren't escaping regex properly. We can fix this by introducing an option to pretty-format that will escape regex.
 @anilanar hm, are you sure? Is the original issue report not valid any more? If it is, would you mind sending a PR to fix it?
 This will be fixed in the next Jest release this week.  i really wanted those too. I aliased some of them here
https://github.com/facebook/jest/pull/1632

`failing` and `todo` seem to be pretty awesome too, but the'll require a little more code :)
 I don't see value in `test.failing` it seems too easy to forget to fix them.

`test.todo` I'm ok with, should be easy to implement as `test.todo = title => xit(title, () => {})`.
 @dmitriiabramov test.todo seems easy enough to add. Do you mind helping with this since you already added all the other ones from this issue?
 ah, we accidentally pushed the website but not a release yet. There'll be a new release in the next few days.
 This will be in 16: https://github.com/facebook/jest/pull/1775
  Do you wanna make this command and send a PR? :)
 ping @yaycmyk are you willing to help out with a PR for this?
 Ok, I'm gonna close out this issue to manage the queue. If you do end up working on it (or anyone else) please send a PR. It's unlikely we'll get to it.
  Uses the AppVeyor Jasmine reporter from the `jasmine-reporters` project to report test details to AppVeyor.

Example: https://ci.appveyor.com/project/Daniel15/jest-71o27/build/3/tests (this is building my fork of Jest)

Before: "Tests" tab is empty
![](http://ss.dan.cx/2016/09/chrome_03-12.02.43.png)

After: "Tests" tab is populated
![](http://ss.dan.cx/2016/09/chrome_03-12.01.33.png)

Failing tests show the output when clicked:
![](http://ss.dan.cx/2016/09/chrome_03-12.01.48.png)
 This is gonna be fun when we kill jasmine!
 I'd hope that we have support for our own custom reporters when we kill Jasmine - They're pretty useful for integrating unit testing into other systems. I guess we could use Jest's JSON output instead :smile: 
  When watch is going over a lot of files, sometimes I want to stop it and change the search pattern to narrow it down. It would be great if it was possible to do this right in the middle of the run.
 yeah, this might not be easy. Happy to help out if anyone wants to attempt a PR. Message me on discord (see http://facebook.github.io/jest/support.html )!
 It's happening in 16.
  Array and Object should definitely be there ‚Äì the vm object creates those. I don't really know why lodash three never worked ‚Äì can you investigate a bit? They fixed their detection in lodash 4.
 I recommend updaring to Node 6+
 Will be fixed in the next release.
 you can try `jest@test` which has a fix for this.
  I made this change in #1556 to make console clear work better on Windows. However I now discovered this has a significant downside on OS X: now if you first have a bunch of errors, scroll down, and then a successful run, scrolling up brings a confusing mixed view:

<img width="623" alt="screen shot 2016-09-03 at 10 59 38" src="https://cloud.githubusercontent.com/assets/810438/18224238/f0093a42-71c6-11e6-82da-9525b2596dc6.png">

This change just reverts my tweak and makes it the way it has been before, with clear boundaries between the test runs in the scroll history:

<img width="707" alt="screen shot 2016-09-03 at 11 10 33" src="https://cloud.githubusercontent.com/assets/810438/18224242/1aacf6d0-71c7-11e6-8099-1834b4e1611a.png">
 ok!
  Are you using npm2? If so, you can probably safely ignore this warning. I recommend updating to npm3, where this shouldn't be happening. You can also probably add `node_modules/react-native/node_modules/` to your `modulePathIgnorePatterns`.

(Closing because this is unlikely something we can fix)
  Seems like lerna might not work so well with spaces in the path. cc @hzoo
 Will be in the next release of Jest. Thanks for raising the issue.
 I'd recommend trying it outside of a path that contains a space, in this case "Google Drive". Looking forward to your contributions.
  I understand it‚Äôs a big change but should be super easy to find/replace if we do this.
Why:
- One less global in code, relying on `jest.fn()` weird if you‚Äôre not entirely sold on Jest yet
- `jest.fn()` is not descriptive at all, I had no idea what it means for a long time
 It used to be called `jest.genMockFunction()` which was very confusing. In reality, this is used a lot and the longer it is, the fewer people use it and the more annoying it is. It litters the code a lot if it is longer too. I'll argue that `expect` is not really a better place for it.

My hope was that `jest function` becomes something that people think is synonymous with "mock function" or "stub function". I understand that `jest.fn` is more obvious to people that have used Jest for a long time (like engineers at Facebook) but I would like to take a revamp of our mock capabilities a lot further than just a rename: I want to build the best mocking library that's out there. We should come up with a perfect API for this and then go and build it.

We can also make a special fake module available in tests that gives you the jest runtime object. We can't really call it jest because then you cannot require jest inside of a test (like we do in Jest's own tests). What would we call such a module? `require('‚öí')`? :D

_Note: jest is not technically a global, it is injected into the module scope and every module has a separate copy of the jest runtime object. This doesn't concern users, but it is nevertheless interesting._
 The reason I‚Äôm saying it is as much as I like Jest, I just feel uncomfortable replacing `expect.createSpy()` in my code with `jest.fn()`. It feels wrong to use something implicitly injected called `jest` for something non-Jest-specific like creating a spy.

I can understand `jest.mock()` or `jest.useFakeTimers()` because those are Jest-specific features, but typing `jest.fn()` for every spy feels like Jest is trying to tie me down to itself.

I know it‚Äôs irrational, but programming is irrational in many ways. I‚Äôm sure I‚Äôm not the only one feeling uneasy because of such a silly reason.
 Wait, is expect.createSpy a thing other frameworks use? In that case I'm happy to support it if its common.
 It‚Äôs not commonly put on `expect` global but there‚Äôs a [fairly popular `expect` library](https://github.com/mjackson/expect) doing that.
 OK. Can `jest.fn()` become `jest.spy()`? It‚Äôs just one more letter and way more descriptive.
We can change the docs to call them ‚Äúspies‚Äù anytime too.
 The reason I‚Äôd like to rename them to ‚Äúspies‚Äù completely is because this makes the distinction between ‚Äúmocking‚Äù feature (for module system, depends on Jest) and ‚Äúspies‚Äù (for functions, not really Jest-specific) more clear.
 Won't `jest.spy` get confused with `jasmine.createSpy`, which can also be used in Jest tests?
 AFAIK none of `jasmine` APIs are officially supported in Jest and the plan is to eventually remove them. The official Jest API is here: https://facebook.github.io/jest/docs/api.html. The rest just happens to work. 

I might be wrong on this though.
 > It's actually closer to a stub than a spy I think.

True - I don't think Jest provides an easy way to call the original implementation (ie. `and.callThrough()` in Jasmine), which is one of the things that differentiates spies from stubs.
 To me, a spy is something that wraps around an existing function. We haven't added a helper for this yet, but I'd like to add

``` js
jest.spyOn(MyClass.prototype, 'onClick');
```

which would return a mock function. Therefore I'm unsure whether spy is really a good terminology for this.

In the end, all it is is really just a function that has a mock property with some data on it. Therefore, mock function and `jest.fn` seemed like a really convenient shortcut.

I do however understand Dan's concern about `jest` being a global. As mentioned before, we could make the jest runtime require-able but then it needs to have a unique name that isn't jest.
 This is gonna be part of renaming jest-matchers to expect. I'll close this issue for now. https://github.com/facebook/jest/issues/1679
  It does include console calls. Just scroll up a little bit ;) For a single test, they are printed immediately when they happen and we don't wait until test results are coming in.
 If you are using Jest 15 it should definitely be printed unless you also add `--silent` or something else is happening.

Can you please provide more information? The issue template is there for a reason ;) Which OS are you on, which version of node, which version of Jest, etc.?
 oh, ok, the problem here seems that we don't print console errors that happen _after_ a test has been finished because the worker thread will always be torn down. When you run `jest -i`, will that print the console.error calls?
 yeah, I suspect what happens is this async operation is called after the test finishes and we ignore those messages at this point. We could potentially bring them back but that might be risky.

Can you also try:

``` js
afterAll(done => {
  setTimeout(() => done(), 3000);
});
```

that will make the test wait for a few seconds before sending results back to Jest and would help me confirm my suspicion.
 @davidaurelio upgrade to Jest v18.1, this should be fixed there for Node 7  Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks!
 thank you!
  Sure but this is gonna come at a premium price.
  Ohh noo, seems like istanbul doesn't respect our options. Is there a way to tell istanbul which pipe to use?
  Hey,

we aren't using TypeScript and are unlikely to both provide and maintain definitions for TypeScript. There are some in flow-typed that you can potentially use: https://github.com/flowtype/flow-typed/blob/master/definitions/npm/jest_v14.x.x/flow_%3E%3Dv0.23.x/jest_v14.x.x.js
 closing was wontfix. If you'd like this, please create them and add them to DefinitelyTyped.
 Again, we do not maintain or own the definitions for Jest for TypeScript. I don't know who created them, please send a pull request to https://github.com/DefinitelyTyped/DefinitelyTyped with the API updates.
 Should be easy to update too! Please send us a PR with the new APIs that were added (jest.resetModules, not sure if much else).
  thank you!
  Thanks for the issue. We do not have an official typescript preprocessor in Jest so whatever you are using; you are responsible for retaining the correct line mappings in Jest just like we do with babel jest.

I realize that TypeScript cannot do this, so for now you can use `ts-jest` but there is really nothing that we can do. I'm hoping that `ts-jest` can be fixed up and become a bit less hacky so that we can officially adopt it in Jest and provide support. For now I have to close this issue, however.
  This is great. Thank you!

I really dislike the names of these functions. They are sooo long. Do you think it makes sense to rename them to smaller ones? Like `jest.fn().returns(foo)` and `jest.fn().returnsOnce(foo)`?
 thank you!
  Would you mind adding these in a PR? Thank you!
  We changed it to `--watch` and `--watchAll`.
 Also see https://facebook.github.io/jest/blog/2016/09/01/jest-15.html for all the new awesome improvements :)
  I'm sorry this is not really actionable. Please provide a repository on github that we can install and test to repro and provide actionable feedback. Closing this issue until we have more info :)
 I would suggest adding a console.log(err) in your callback and figuring out why it fails to connect to mongo or something. At least that is what is happening for me.

You shouldn't really connect to a db in a test but rather mock out all of it's APIs and pass fake data around. Otherwise your tests are becoming slow end-to-end tests pretty quickly.
  http://facebook.github.io/jest/docs/api.html#testregex-string
 @cpojer should `.jsx` be in the defaults?
seems like a pretty common use case
 @dmitriiabramov feel free to send a PR :)
  Thank you so much!
  Jest automatically detects babel-jest if it is available and no other preprocessor is specified. This allows us to have a no-config configuration with a minimal hook inside of Jest itself.

With the new coverage support we are using istanbul's transforms via babel as well. There are a few states someone can be in:
- No preprocessor is used, babel-jest is used for coverage transforms with istanbul.
- babel-jest is used by default, it also transforms for coverage in a single transform step.
- A different preprocessor is used. Then we apply the transforms from the user's preprocessor (TypeScript etc.) first and then run babel-jest with istanbul.

For the new coverage support we decided to use babel-jest and made it an explicit dependency of jest-runtime. This has the unintended side-effect that, when using npm 3, it is picked up automatically and will magically just work. If there is no babel config, it will simply not do any work at all. If you are using npm 2, you'll need to explicitly install to make sure it gets hoisted up because otherwise it might now so I'd continue to recommend making babel-jest an explicit dependency. Magic is never good and we may decide to change how coverage is implemented at any time and we don't want that to impact our users.
  Hmmm.. I'm trying to figure out if we need to ever escape hyphen when we always escape square brackets ‚Äì I think not. This is probably whatever people on stack overflow recommend to use and I think it might be flawed :)

cc @davidaurelio what do you think?
 awesome, thank you so much for the quick fix. I'll publish a fix for Jest tomorrow morning.

This also fixes #1551.
 We'll figure out where to go from here and how to put a lasting fix in place. We are still working on getting Jest's tests onto AppVeyor.
  wow, I was just messing with you but if that is what it takes to get you to contribute, that's awesome.

I also cannot believe that you actually went into jest-runtime and just made an awesome fix like this. I literally had this internal registry before but it was way more complex and I thought we didn't need it. Then I added "\* Make internal registry that's persistent (?)" to my wishlist. You deserve a medal.

Would you mind also adding a test for this? It can be either an integration test in integration_tests (every folder should contain a test project and then the top level **tests** folder is used to call `runJest` (jestception)) or just directly in jest-runtime. I think I prefer integration test with a one or two line code comment on why it is necessary.
 thanks, this is great. üéâ
  yay we fixed this. Nice work @skevy.
  I think it is gonna be hard to sync this all the time when the CLI args change. Most of the time when people actually need them, they have Jest installed locally and can check the runtime flags.

I do agree we should at least sort them alphabetically though.

Since there hasn't been any action on this issue, I'll close it to manage the queue but I'm happy to accept PRs that improve the situation.
  Can you post your configuration?
  Fixes #1429.
Fixes #1509.

Adds pretty-printing of elements both to regular tests (yay shallow rendering diffs!) and to snapshot tests (which had pretty-printing for instances but not for elements).

<img width="450" alt="screen shot 2016-09-01 at 16 31 54" src="https://cloud.githubusercontent.com/assets/810438/18174106/32c69de8-7064-11e6-9de2-843e893161ce.png">

<img width="437" alt="screen shot 2016-09-01 at 16 33 59" src="https://cloud.githubusercontent.com/assets/810438/18174108/36b0831a-7064-11e6-9a89-1be3b36a97ed.png">
 Awesome! I just updated some minor require odering nit.
  cc @ide who was too lazy to do this :P
  Fixes #1534.

I couldn‚Äôt figure out a good integration test for this but since try catch is on top level, this should cover all cases.

I tried more granular try-catching but it didn‚Äôt work due to `JSON.stringify` offering no protection against throwing `toJSON`s. So this is the best I could come up with.
  Thank you! Do you think you can send a pull request with a fix and a test? :)
 Cool, thanks for the update. It seems like Node.js has a lot of edge cases in environments that are case insensitive (Windows, and Mac OS by default)
  This is incorrect. The examples in examples/snapshot has the same code and works currently but breaks with your change.
  This seems like a reasonable default. Also made it so runtime can accept a JSON config.

cc @kyldvs 
  thank you!
  You can do `require.requireActual` to get the real module and create some mocks for it.

```
jest.mock('Form', () => {
  const RealModule = require.requireActual('Form');
  const MyModule = {
    RealThing: RealModule.RealThing,
    ‚Ä¶add some mocks
  };
  return MyModule;
});
```

is that what you are looking for?
 Hey! Yeah I'm totally happy to accept a PR that explains how to create mocks (and why) for certain components when using snapshot testing :)
  ## Using a more solid clear sequence

Unlike the one used today, it clears the whole console on Windows (as opposed to a part of the screen). We have been using the same sequence as I propose here for a month in Create React App, and it works well on all platforms.

The only downside is that it erases the scroll history on Windows. IMO it‚Äôs a tolerable downside and less annoying than misaligned output interleaved with older commands.
## Adding Windows fallbacks for ‚úì and ‚úï

Inspired by https://github.com/mochajs/mocha/pull/641.
The pending circle didn‚Äôt need updating, it worked fine on Windows.
## Clearing line more aggressively for Windows

This prevents run-on ‚ÄúDetermining tests to run‚Äú and ‚ÄúRunning N tests...‚Äù on Windows.
All changes tested on OS X too.
## Detect Backspace on Windows when matching pattern

Fixes #1555.
 thank you <3
  Can you explain what you are trying to do a bit better? The example code above, is that from your manual mock? If so, you shouldn't call `jest.unmock` there but rather `const Relay = require.requireActual('Relay')`.
 Can you create a repo with this so I can take a look? I'm not really sure why this is happening and can't give hints without the full setup.
 Ah, this might be a real issue with Jest 15. Can you try, as a workaround, to call:

```
jest.mock('react-relay', () => require.requireActual('react-relay'))
```

and let me know if that works?
 Thanks for the repro. I'd recommend for now to call `jest.mock('react-relay').unmock('react-relay')`. That should be the default in Jest but it seems like this is an actual bug.
 Yeah the workaround I mentioned above is still recommended until we change how this works in Jest.
 Will be fixed in the next release. #2022
  Can someone provide a repository that I can install on windows to test this? Seems like 15 works on windows but you have a configuration that isn't quite compatible.
 Thanks for the repros. @Daniel15 is our resident windows expert. We are hoping to have a fix for this sometime tomorrow. Please be patient, it's a bit hard sometimes to keep up.
 I'll try to take a look at this tonight. All the known issues should have been resolved by #1463, I'll need to investigate further and determine what broke.

Unfortunately we don't have automated builds on Windows yet. Currently, several of Jest's unit tests are broken on Windows. We're aiming to fix all those issues and enable an AppVeyor build (#1465) to more easily catch Windows-specific regressions in the future. 
 I think @cpojer is right that #1574 should fix this. So far I've only been able to replicate the issue for folder names containing hyphens.
 Published 15.1.1 with a fix. Sorry for the wait!
 Hey, I didn't do anything! All credit goes to @insin who troubleshooted it and sent a PR and @Daniel15 who helped verify.
 Hi @dylanparry! I'd suggest filing a new issue so we can look into it. I think we'll add some integration tests to test scenarios like this.
 It seems like there is also a bug with spaces in dir names on windows. See #1639 ‚Äì we'll fix it in the next Jest release.
  blocked on https://github.com/facebook/jest/pull/1499
 @maximderbin would you mind rebasing this now that @dmitriiabramov rewrote the snapshot matcher? :) This should be a matcher in jest-snapshot.
  Fixes the failing snapshot test on node 4. Through the snapshot test I learned that stack traces on node 4 and node 6 can be different; the node 6 ones have more information.

This made me realize the node 4 stack trace matching was actually broken and that the two regexes we had could easily be rolled into a single one. Finally, to make the test pass, I created a custom Error class to make sure that the stack trace is definitely the same on all node versions.
  API reference should explain runtime environment, Configuration should explain CLI and config options. Right now they‚Äôre mixed together on ‚ÄúAPI Reference‚Äù which feels confusing and not very discoverable.

cc @lacker
 I'm really in favor of rewriting the entire website with new, focused, documentation.
 Can't assign to you because you're not in the contributor list in this repo.
I'll let you know if I have other feedback, thanks!
  This is great! What about beforeAll/afterAll?

What is wrong locally? `npm install` and `npm test` should work.
 Master is passing for me and on travis. Seems like an issue with your node version?
 thank you!
  duplicate of #1256.

This should be easy to implement: just overwrite beforeEach/afterEach the same way we overwrite `it` with `jasmine-pit`.
 please send a PR ;)
 afterEach already accepts `done` for async work, no?
 it does. http://jasmine.github.io/2.5/introduction.html#section-55
i had no idea jest doesn't support it. I can work on it this week
 @dmitriiabramov @ide ended up doing this himself, therefore paying 5 bucks to himself.
 oh. nevermind then.. still going through my jest emails from last week :) 
thanks @ide for doing this! 
  See http://facebook.github.io/jest/docs/tutorial-react-native.html#preprocessorignorepatterns-customization

you need to whitelist async-es to be transformed in react-native.
  lol!

Please update to Jest 15: https://facebook.github.io/jest/blog/2016/09/01/jest-15.html

I'll publish 15.0.1 in a bit with this and other fixes.
 It is! Just published :)
  In React, we have a test that deletes the global Symbol variable and it breaks Jest 15 (whereas Jest 12 is fine): https://github.com/facebook/react/blob/master/src/isomorphic/classic/element/__tests__/ReactElement-test.js#L25-L28

Caching the Symbol object so that it doesn't read from the global one fixes it.
 @gaearon deleting it is not evil, replacing it with some random function is. Of course we do that as well: https://github.com/facebook/react/blob/master/src/isomorphic/classic/element/__tests__/ReactElement-test.js#L497-L507
 @cpojer has a different implementation
  Can you provide a repository with a repro that we can npm install?
 Does it work when you use jsdom? If this is an older version of lodash it is known to be buggy in the node env.
 Hey @aaronjensen, is this still an issue? Works on Jest 17  Oh yeah, you are right, this isn't great. Would you mind sending a PR with an update?

See https://github.com/facebook/jest/blob/master/package.json#L47 for an example. It's also mentioned here: http://facebook.github.io/jest/blog/2016/09/01/jest-15.html#rewritten-code-coverage-support
 Oh wait, no, sorry. I mixed it up. `collectCoverageFrom` is used to generate code coverage from all files, even untested ones.

`collectCoverageOnlyFrom` literally takes a list of files and only collects coverage for those.

The two options are mutually exclusive.
 No, collectCoverageFrom is the only option that accepts globs currently (it is completely new). collectCoverageOnlyFrom literally only accepts direct, full paths, to files. It is used internally and an ugly leftover of darker times.
 `collectCoverageOnlyFrom` has the format that looks like this:

``` js
{
  "file1.js": true,
  "file2.js": false
}
```

there was a reason to implement it this way for the internal runner, but for the outside world it probably makes no sense. should we remove it from the docs?
 Probably, yes. `collectCoverageFrom` should be able to handle this use case.
 @dmitriiabramov would you mind adding docs for `collectCoverageFrom` and removing `collectCoverageOnlyFrom` from the docs? I consider it internal and deprecated.
 will do
  In jest 12, you could write

``` js
.toMatch(' react-text: [0-9]+ ')
```

and it would turn the string into a RegExp automatically and match `' react-text: 2 '`.

In jest 15, it fails

``` js
Expected value to match:
      " react-text: [0-9]+ "
    Received:
      " react-text: 2 "
```

The fix is to write

``` js
.toMatch(/ react-text: [0-9]+ /)
// or
.toMatch(new RegExp(' react-text: [0-9]+ '))
```

It would be nice to either restore the previous behavior or to have a good warning if you are passing a string instead of a regex object.
 There's a ton of callsites inside of jest that use toMatch with a string, so it's probably going to break a ton of code to make any change. https://github.com/facebook/jest/search?utf8=%E2%9C%93&q=toMatch
 This was an intentional change. You either want to match against a regex or an exact string. On www this only failed one out of thousands of tests, so I don't think this is a big deal tbh.
  yeah I just ran into this on www too.

cc @dmitriiabramov can we fix this?
 yeah. i'ts a bug in the stringify/prettyprint function. i'll try to get a diff soon
  Thanks!

`jest.useRealTimers()` is global per test file and needs to be disabled through `jest.useFakeTimers()`.
  This is gonna be really hard to troubleshoot without a repro :( . Coverage was completely rewritten and simply does more work now. Do you have a custom preprocessor or are you using babel-jest? Are you using `collectCoverageFrom`? Is there a performance difference when not using coverage in Jest 15 vs 14?

Is this the first test run or the second? The first one will have to compile every single file and the second would use cached transformed and instrumented files.
 This probably means that the previous coverage feature was a huge mess and didn't work correctly.
 I'm sorry for the slowdown. Coverage is inherently slow. Can you provide some sort of repro for us that shows this problem, maybe even with the Jest repo itself?

cc @dmitriiabramov in case he added some sleep calls.
 it might be generating coverage for unstested files that is taking so long. It has to run through all files in the project (probably including `node_modules`) and match them against a regex to understand if report is needed for the file or not
 but if subsequent runs are much faster then it's probably preprocessing + writing cache :)
 Istanbul released a much faster implementation of their coverage collector which should hopefully help with this. Otherwise there isn't anyone working on this so closing the issue.
  Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!
 thank you!
  This commit literally changes and fixes everything. Sorry about that, release lockdown :)
  I'm not sure about overwriting them because the keys are regex values ‚Äì would we apply the user specified values first and then apply the Jest defaults if they fall through? That way people won't be able to get rid of the defaults, though, just overwrite them.
 I was thinking of running Jest inside of electron and rendering real apps inside of an iframe, including images and wanted to preserve option value :D
  Thanks @maximderbin. I actually already had this change in one of my bigger cleanup diffs that are getting Jest ready for release. I think it makes sense to not even invoke `diffStrings` if both of the strings are single line ‚Äì no need to print the strings again, they are already printed. I'm sorry I didn't send out my diff earlier, but thank you for raising this issue, I probably would have missed it.
  thank you!
  oh yeah. `includes` is not available everywhere. `indexOf` should be totally fine! :)

and travis is significantly slow yes. it is .really. slow :) especially if comparing to macbook pro
 Are you using the free version of Travis, or the paid version? The free version is pretty resource-limited, so slowness is expected. The paid version has much more CPU power available.

> This travis job is configured to use Node 5

As a side note - Node v5 is EOL... v4 is the LTS release and v6 is the 'current' release. You should switch to either v4 or v6 depending on whether you want a release with long-term support (v4) or a release with the latest features (v6)
 I'm fixing the includes issue.
  yeah this is definitely confusing. Can we make a hotfix here? The same is true for a one line vs multieline diff.
 yeah. we should probably disable oneline diffs at all.
eventually we should highlight the difference in characters on multiline diffs the same way github does it
 it's in here https://github.com/facebook/jest/blob/master/packages/jest-diff/src/diffStrings.js#L37
@maximderbin do you want to hack on that?
  Other test frameworks allow test suites as well as tests themselves to be categorised using arbitrary strings. For example, see https://github.com/nunit/docs/wiki/Category-Attribute. These categories can then be used to specify particular types of tests you want to run (or tests you want to ignore).

Example use cases:
- Tests that work on Linux but fail on Windows could have a `broken-on-windows` category and then CI runs on Windows could ignore those tests
- Integration tests could have an `integration-test` category to only run them in CI builds (not local builds) - Although this is also possible if you put all your integration tests in one folder
 How are we adding these categories?
 Not sure yet - This is just a rough idea, it needs to be fleshed out some more. In C# with NUnit or XUnit, you specify the categories as an attribute on the test:

``` csharp
[Test]
[Category("SomeCategoryName")]
public void SomeTest() {
```

One idea would be for `it` to return an object which would allow chaining syntax like:

```
it('foo', () => {

}).setCategory('SomeCategoryName')
```

I'm open to better ideas though!
 i remember we had it in ruby :)
https://engineering.sharethrough.com/blog/2013/08/10/greater-test-control-with-rspecs-tag-filters/
but that specific implementation was a mess.

maybe we can have an optional tag argument

``` js
test('some stuff', 'integration', () => {
});
```

i don't really want to overload jest functions though.

maybe even something like

``` js
tag('integration').it('does stuff', () => {
});
```
 Good to know that Ruby supports it too! Most test frameworks I know of for other languages have some sort of tagging/categorising functionality, so I was surprised that it's missing from Jest :smile: 
 I'm gonna close this because it is unlikely anyone will be working on this. Will be happy to accept a PR.
   cc @gaearon
  Also added aa mockComponent convenience function.

This adds new and improved default mocks for:
- View
- Image
- ListView
- ScrollView
- TextInput
- ActivityIndicator
  This makes the line with the error red and bold. The new printing style is less intrusive so it is easy to miss errors. This should make it clear _which_ test is failing.
  See #1484
  Thanks! However we cannot break usage of `jasmine.any` for these. We use it heavily at FB.
 (closing in favor of the new diff).
 oh sorry, I got confused because it looked similar :D
  For Jest 15 we are going to ship with a ton of new defaults that should make the experience of using Jest better. With this, I also removed a bunch of outdated documentation from the website ‚Äì however I feel like we should completely rewrite the documentation on the website and replace it with better, useful, step-by-step guides (cc @lacker).

This diff:
- Disables automocking by default.
- Uses real timers by default. Adds a `timers: 'fake' | 'real'` config option for global control.
- Doesn't implicitly reset the module registry after every test. Adds `jest.resetModules` and a `resetModules` config option for better control.
- Includes `.test.js` and `.spec.js` in the default `testRegex`.
- Completely removes some deprecated configuration options and makes Jest throw with helpful error messages so that it will be easy for people to upgrade.
- Adds a warning when `jest.unmock` is used to either enable automocking or remove the unmock calls. Similarly Jest now logs a warning if automocking isn't used but `unmockedModulePathPatterns` is specified.
- Updates the docs to reflect the new defaults and removes some outdated pages.
- Fixes two minor reporter bugs: the verbose reporter now prints the test header before any test results and top level `test` or `it` calls don't print a `>` right after the `*` bullet. (`* works` instead of `* > works`). I know this should have gone into separate diffs, but you know, sue me.
- Removes obsolete `testEnvData` config option.

At Facebook we will continue to use automocking and fake timers for the foreseeable future and both features will continue to be part of Jest long term. Especially the auto mocking feature at this point is easy to maintain and the explicit auto-mocking using `jest.mock` is incredibly valuable. However, it makes a lot of sense for libraries and beginners to start with sane defaults. Automocking is valuable for big organizations that do not have a unit testing culture. I will elaborate this in the release blog post but wanted to give a few hints in here.

_TODO: I'll add a few tests for the new errors tomorrow :)_

cc @gaearon 
 Alright, should be good to go. Updated some older tests and added new ones.
  no more 

```
"!**/__tests__/**`,
"!**/__mocks__/**`,
```

in the config
  I'm not sure I follow, RandomView is only rendered once?
 I see. Yeah, we need to stop trying to render React elements.

cc @gaearon ‚Äì we talked about this before but then I got a bit confused about what exactly to do in the pretty formatter.
 But it shouldn't be `<BlueMessage />`, right? It should render as something like `[react.element BlueMessage]` or some other representation, no?
 I started implementing this in https://github.com/thejameskyle/pretty-format/pull/28 and it got confusing pretty quickly because I was suddenly dealing with elements, instances and test renderer instances and I ended up printing quite deeply and it wasn't really useful.
 I was simply trying to print React elements using the existing react test renderer plugin ‚Äì including props and its children. Note that we don't need to change pretty-format itself but only the React plugin. Plugins in pretty-format come with a test function and every object gets tested for a match. If you patch the diff you'll find that it doesn't quite work as intended, I think the problem was nested React children. I'd be happy to see a PR with the proper implementation, though ‚Äì we can chat tomorrow and I can point out the issues I found. In the meantime I'll close this as a duplicate of #1429.
  See #1491.
  Update to react and react-test-renderer 15.3.1, this should be fixed.
  Can you install the latest version of jest and jest-react-native? This should be resolved.
 (you might also need to delete your node_modules folders).
 Please use the _latest_ version of jest-react-native. I think that is 14.1.3 or something like that.
 `npm info jest-react-native` says 14.1.3. Note that many packages in Jest are versioned slightly differently than "jest" itself.
  We don't support this config option any more. You can still pass it from the CLI or use the `testRegex` option for this (but then I recommend removing `testFileExtensions` from the config).
 Can you create a repository that shows this issue? Then I can help ‚Äì I'm pretty sure a proper testRegex pattern is the right solution here.
  this works just fine for me with node 6. If you have a repository with a repro for me I'm happy to reopen and investigate but I don't think this is a bug with Jest.
 It's because on line 53 of `src/validators/min.js` you call `Date.pare` instead of `Date.parse`.
 yes, window is undefined in the current version of Jest's create-react-app config (we may change this before officially releasing this version and use jsdom, though). Date is definitely there, though, so you must have another issue somewhere. Do you do something like `delete global.Date` or something?
 It seems to me like sinon is doing this. When I remove sinon from the tests it will provide Date just fine.
  See #1479 and #1475. I'm merging both today and both of the issues you raised will be fixed in the major release this week :)
  hey @sibelius !
this is most likely happening because you use a spread operator somewhere in your code and you node doesn't support it.
If that's the case, the easiest fix would be to add [this](https://babeljs.io/docs/plugins/transform-object-rest-spread/) plugin to your babel transform.

ideally we should guard against those errors and at least provide a SyntaxError with explanations
 It seems like you need to add `react-clone-referenced-element` to the list of patterns that need to be preprocessed.
  Thanks @maximderbin. I'm still catching up from my vacation but can we keep most of the matcher functionality in jest-snapshot and make jest-matchers depend on it rather than jest-jasmine2? I would like jest-snapshot to be useful standalone so it can be integrated in other test runners.
 Could we change `extendJasmineExpect` to export a function instead of having a side-effect? That way, in our jasmine2 adapter, we could do:

```
requireInternalModule('extendJasmineExpect')(snapshotState, {updateSnapshot: config.updateSnapshot});
```

to pass on the snapshot information to the matcher.

Also, please don't pass the entire config on. I deliberately didn't want jest-snapshot to get all config values ‚Äì it just makes everything harder to refactor when a few levels down in the future something accesses some weird config option.
 Also, how does expect(foo).not.toMatchSnapshot work with this diff?

I feel like we should kill the jasmine matcher completely, tbh. No need :)
 the fundamental difference between this and what's in master right now is that jasmine based matcher won't throw and let the test go ahead even if the snapshot didn't match. When we have a test like this:

``` js
test('something', () => {
  expect('something that will not match and throw').toMatchSnapshot(); // throws
  expect('second snapshot in the test').toMatchSnapshot();
});
```

the first snapshot will throw and stop the test execution. That means that the second snapshot will not even be registered and will be marked as obsolete.

another issue is when we have two failing snapshots

``` js
test('something', () => {
  expect('fails').toMatchSnapshot(); // throws
  expect('fails as well').toMatchSnapshot();
});
```

we'll only get an error for one snapshot. if we then run jest with `-u`, it will update both of them, meaning you'll be updating something that you didn't even verify is right.

to fix this issue we'll need to introduce a concept of  not throwing matchers in jest
 @maximderbin thanks for making it work with jest!
i'll take this PR as a base and add the not throwing functionality to it
  This should work fine in the next version of Jest that we'll release this week.
  Thank you!
  This is not yet supported. The issue tracking it is here: https://github.com/facebook/react/issues/7148
  it seems like it doesn't have any coverage data for anything inside the class definition, which is weird. Thanks for reporting this! i'll investigate
 hey @alansouzati 
to understand what exactly is going on with this file what we can do is
add a line right before this line `https://github.com/facebook/jest/blob/master/packages/jest-runtime/src/transform.js#L328`

with something like
`filename.match('AccordionPanel') && console.log(wrappedResult);`

then run `jest --coverage --no-cache` and see the final source of this file with all instrumentation added to the source
 hey @cpojer 
this is what i think is happening:
1. There is a transformer for ES6 classes to ES5 functions
2. We add `/* istanbul ignore next */` to nodes added by babel
3. the whole class definition gets ignored because of the added statement

i'm not even sure how to approach thing bug. can we configure which transforms can add `/* istanbul ignore next */`?
 babel-jest adds this but I don't think we can customize it.
 @alansouzati what is in your babelrc file?
we can try disabling `babel-plugin-transform-es2015-classes` plugin and see if it works
 We are unsure what exactly is happening here, this issue might be in Jest 15 :(
 Oh that's great to know. We actually just published Jest 15: facebook.github.io/jest/blog/2016/09/01/jest-15.html
  <img width="592" alt="screen shot 2016-08-26 at 10 26 23 am" src="https://cloud.githubusercontent.com/assets/940133/18014491/0462d520-6b78-11e6-8dbf-64c783830679.png">
<img width="608" alt="screen shot 2016-08-26 at 10 27 14 am" src="https://cloud.githubusercontent.com/assets/940133/18014498/09e7fa16-6b78-11e6-9e7c-ca6f7b1ffb38.png">
<img width="598" alt="screen shot 2016-08-26 at 10 27 49 am" src="https://cloud.githubusercontent.com/assets/940133/18014500/0ce4c24e-6b78-11e6-8cbc-6876b101cf6f.png">
<img width="599" alt="screen shot 2016-08-26 at 10 28 29 am" src="https://cloud.githubusercontent.com/assets/940133/18014503/10b25850-6b78-11e6-8a8e-fe3a91a0bd6c.png">

cc @gaearon 
 Yeah, let's print the code hint only once. Otherwise, nice work! :)
 ok. i'm updating the rest of the matchers then!

one thing that i'm not so sure about though.
`toContain` is usually used in two ways:

``` js
expect([1, 2, 3, 4, 5]).toContain(getValue());
```

or

``` js
expect(getList()).toContain(5);
```

and that blurs the difference between `expected` and `received`.

this kind of applies to all matchers, but mostly it's pretty straightforward and natural

``` js
expect('abc').toBe(getValue()); // weird
expect(getValue()).toBe('abc'); // normal
```

but in the case of `toContain`, the value types are very different.
should we implement `toBeContained` or something? :)
 I think it is ok for now to have `toContain` be a tiny bit weird.
 here's the `cat` of some of the snapshots

<img width="680" alt="screen shot 2016-08-29 at 1 05 37 pm" src="https://cloud.githubusercontent.com/assets/940133/18065597/53e3bb00-6de9-11e6-832e-5b1673c0b8f6.png">

<img width="479" alt="screen shot 2016-08-29 at 1 05 04 pm" src="https://cloud.githubusercontent.com/assets/940133/18065598/53f00e64-6de9-11e6-96be-cd7db3f3b87a.png">
 - Instead of "Instead, received" I would recommend starting out with `Received:`.
- Let's remove the `failures` integration test completely. The console stuff is tested separately.

Let's fix these two things and then merge it and iterate.
 Yep, I agree we should think about negation a bit more but I don't want to block this PR on it and we should do it in a follow up :)
  Fixed in #1505.

Thanks for the report. We'll make a new release this week.
  Thank you for the contribution! This is useful :)

Is this being deleted properly just like "Running X tests‚Ä¶"?
 Created an updated PR. Thank you for your contribution! I fixed it up :)
  hey @alansouzati !
in order to run those tests you need to have mercurial installed!
the easiest way would probably be `brew install mercurial` :)
  some terminal color schemes (solarized) have the same color for `background` and `bright black` (that is  used in `chalk.gray`) which makes the output invisible.
`chalk.dim` however works just fine and produces almost the same result.
  `t 12627110`
seems like it has also been done already. I just changed the tests to use snapshots instead of regexps to capture the whole message and not just the piece.
 cc @maximderbin 
 hell yea.
  Sorry for the late reply, I just got back from a vacation.

Thank you for sending us some tests, that is always appreciated! Unfortunately it seems like they are failing. Also, just like @Daniel15 pointed out, this is a good use-case for `toMatchSnapshot` :)

Would you mind updating this PR?
 Thanks @zackargyle. Since there hasn't been much activity on this issue and the bug you were running into was fixed, I'll close this PR. We have integration tests for this plugin so I don't think we need further tests right now :)
  This doesn't seem like a Jest issue. It might be and I recommend setting `persistModuleRegistryBetweenSpecs` to true in the config (will be a default in the next major) but if that doesn't solve it I recommend upgrading React to 15.3 and filing an issue with React's bug tracker.
 Yeah we need to get better at unhandled promise exceptions but your code is incorrect.

Try:
```
it('works', async () => {
  try {
    await x();
  } catch(e) {
    ‚Ä¶
  }
});
```  I think this is a reasonable request. Do you want to send a pull request with tests for this? :) See the integration_tests folder on how to add tests to test jest.
 Hey! Please send a Pull Request for this. I think using `fs.writeFileSync(filename, JSON.stringify(data))` should work just as well for this :)
  hey @alansouzati !
from my experience, things like grunt and gulp tend to add complexity to CLI tools rather than solve problems, however i understand that you're trying to abstract the configuration for end users, and if you're working on some shared set of build utils that is used by multiple projects it can become a pain.

i'd say the simplest solution would be to just invoke a child process from your gulp task and proxy the stdout/stderr to your main process. to abstract configuration you might want to pass a JSON config to the CLI
something like

```
jest --config '{"rootDir": "/a/b-c", ...}'
```

that json config you can generate dynamically in your gulp task based on what you're trying to do

i don't think it's documented yet, but we've been using this option in some of our projects.
We'll be working on simplifying our configuration pretty soon to, and most likely will add support for plain JS configs.
 @alansouzati `jest.config.js` are coming for sure! :)
  No, we are unlikely to add this. Snapshots are text files and should be treated as such.
  ![react_reporter_demo](https://cloud.githubusercontent.com/assets/940133/17913395/829b8026-694e-11e6-8a69-a49524b18a5e.gif)
 question.
right now this reporter tries to print when it's run on travis, and the output looks like this
![screen shot 2016-08-27 at 12 55 42 pm](https://cloud.githubusercontent.com/assets/940133/18029749/ab1586d2-6c55-11e6-9331-962bb82e4e91.png)

is there a good way to detect if we run it inside a CI to avoid printing it?
`process.stdin.isTTY` does not really work.
should it be a module that can identify the most popular CI environment and return true/false?
 @maximderbin yeah... so i thought about making a package like `jest-is-ci` and having it return `true` if any of the env variables (like `CIRLCECI`, `TRAVISCI`) set. but i'm not sure if there's a better way to do it
 @dirk seems like that's exactly what we need! thanks! :)
 <img width="907" alt="screen shot 2016-09-15 at 2 29 17 pm" src="https://cloud.githubusercontent.com/assets/940133/18568195/d909975e-7b50-11e6-9b2c-85d14bf76029.png">

this also fixes the output in CI (except this 'running coverage' line, but that's not related to this change)
 Current Status:

![jest-reporter](https://cloud.githubusercontent.com/assets/13352/18780476/b2db8b0a-81b8-11e6-9c7f-bcf1bcc82bf3.gif)
  This is super awesome. Would you mind rebasing it so I can merge it?

Eventually we should move the watcher stuff into a separate file, but for now this is fantastic.
 See #1508.
  This is a deliberate design decision because symlinks always cause trouble. I recommend you to use the `moduleNameMapper` config option. See facebook.github.io/jest/docs/api.html#content
 I recommend trying to use jest@test which is gonna be the next release of Jest.
 I think everything is working just fine in Jest, except for locating test files, which imho is a reasonable trade-of for what we are doing inside of jest's haste map.
 Feel free to send us a pull request that fixes Jest to fit your use case. If it doesn't make Jest harder to maintain and works within our constraints, I'm happy to accept it.

Personally, the only reason I get to work on Jest at Facebook is because I'm solving Facebook's problems related to JavaScript testing. This is not a problem for us so I'm not able to justify working on it myself.
 no, I think it would make sense to support them overall. I think if you change the node crawler to support them behind a flag (that would disable watchman as well), I wouldn't stop you from adding it to the codebase, granted it is well written and tested etc.
  Can you try installing babel-jest@test or babel-jest@14.1? We recently fixed this.
  nice work!
  Can you try to modify the sample preprocessor again and run Jest with `--no-cache` while working on the preprocessor? 

Unfortunately we don't currently have an official typescript preprocessor (besides the example). If you'd like to work on this and send a pull request for adding `typescript-jest`, that would be awesome!

I'm closing this for now because we can't really do much if it isn't part of Jest.
 Are inline sourcemaps supposed to work automatically when using node and when using the `vm` module? Because Jest uses `vm` to run tests.

All of this code is in packages/jest-runtime ‚Äì transform.js creates `vm.Script` instances.

If you are willing to help out, please join our discord channel (see https://facebook.github.io/jest/support.html ) ‚Äì I'm usually there and happy to help. Creating `typescript-jest` would be awesome and should be fairly straightforward.
 Can typescript somehow retain lines, just like babel can?
 ah that sucks :(
  you can't do it from CLI, but you can run the test matching `Foo` by doing `jest Foo` and focusing your specific test by using `fit` instead of `it`
 we have in the docs in under the `jest global environment` :)
i was also thinking about bringing back the old API `it.only`, `test.only`, `describe.only`, just to reduce the number of globals
 We definitely need `ftest` or `test.only`.
 test.only will be added in 15.2. For now use `fit`.
 @AriaFallah they're not documented yet, but you can see the full list of new globals in https://github.com/facebook/jest/pull/1632
  hey @orta !
jest is a monorepo and this repo contains multiple packages.
we use [lerna](https://lernajs.io/) to manage them.
`package.json` in the root directory is used only for development
the full list of packages is here https://github.com/facebook/jest/tree/master/packages
  You can wrap babel-jest and create your own preprocessor by just passing in the options you want. That should be sufficient.

On Fri, Aug 19, 2016 at 9:04 PM +0200, "Josh Story" <notifications@github.com<mailto:notifications@github.com>> wrote:

Would love to know the answer on this here as well

## 

You are receiving this because you are subscribed to this thread.
Reply to this email directly, view it on GitHubhttps://github.com/facebook/jest/issues/1468#issuecomment-241106867, or mute the threadhttps://github.com/notifications/unsubscribe-auth/AAA0KEhHwHWLdV4HMHF4-ck3CRpb7QsQks5qhf4VgaJpZM4Joskp.
 @ccorcos you can specify your custom preprocessor in the config
http://facebook.github.io/jest/docs/api.html#scriptpreprocessor-string
 You can make your own preprocessor that simply does this:

```
require('babel-jest').createTransformer(babelOptions)
```

and then point scriptPreprocessor to that file.

See https://github.com/facebook/jest/blob/master/packages/babel-jest/src/index.js#L53

This makes the simple case simple and the hard case possible. I don't think we'll make scriptPreprocessor a function and the current solution should work well enough.
 I don't understand what you are saying with "runtime". The preprocessor is required by Jest and is used to transform files. When it is being required you can do whatever you want to create your babel options object that you pass on to `createTransfomer`. I'm pretty sure there is just some confusion here because this API gives you all the power you need and if it's not enough then there is some confusion left.
 @tizmagik as i understand you're trying to pass a parameter from your build process (e.g. `grunt` or `gulp` pipeline) into jest transform, so that jest transformation is affected by outer process?
as @cpojer said, you can do anything inside your custom preprocessor, but if you really need to pass some external parameters you can probably use environment variables.
e.g.

``` js
spawnProcess('jest', {env: {ADD_CUSTOM_TRANSFORMATION: 1}});
```

then in your customPreprocessor:

``` js
if (process.env.ADD_CUSTOM_TRANSFORMATION === 1) {
  plugins.push(require('my-custom-transformation-plugin');
}
```
 I still don't fully follow here. If you pass in the options to the scriptPreprocessor from the outside I see no problem to instead create them from the inside. Just factor out the piece of code that creates your babel config:

```
// babelConfig.js
module.exports = {babel options};

// transformer
module.exports = babelJest.createTransformer(require('./babelConfig'));

// other build scripts
require('./babelConfig');
```

we are using this approach all over at FB and it works well for us.
 @tizmagik i think the biggest thing here is being able to pass config to child processes, when we run tests in parallel.
I don't think there's an easy way to pass a function to another process right now, but i might be wrong.

see https://github.com/facebook/jest/blob/master/packages/jest-cli/src/TestRunner.js#L255
 @ccorcos can you show a real example of why my proposal won't work? In practice it worked really well for us. It requires you to only invert a few things and will probably lead to a better separation of concerns.
 Why do your build options change so much and why are they generated? I feel like there must be a simpler way with more static build configuration that's stored in a file somewhere.
  I recommend running Jest with `--no-cache` while working on your own preprocessor but yes, the way you are doing this seems fine.
  The build doesn't actually work properly yet (a bunch of tests fail: https://ci.appveyor.com/project/Daniel15/jest/build/1.0.5/job/wjnpa9thok6twp5y) but it's worth at least starting to work on this. Once all the broken tests are fixed on Windows builds, having a continuous integration setup like this will prevent it from breaking again in the future.

Closes #1192
 This is supposed to be stacked on top of #1463, but I forgot that Github is not Phabricator and doesn't support basic features such as that. The only change in this pull request is supposed to be the `appveyor.yml` file.
 are you interested in fixing up all the tests to work on windows?
 Sure, I can take a look when I get a chance.
 @cpojer - What do you think of this approach for now? I simply make Windows builds skip all the tests that fail on Windows. It's not ideal and I do plan on going through and fixing the tests incrementally, but at least it makes a Windows build actually possible and will still help catch some regressions.

It works! https://ci.appveyor.com/project/Daniel15/jest/build/7/job/apivm49w0c7nm4hc
 Can we instead just dump the skipOnWindows file in `scripts/` and add an @providesModule header? I'd like it not to be part of the actual jest packages.
 In testSetupFile.js you could also do:

``` js
jest.mock('skipOnWindows', () => {
  return implementation.
}, {virtual: true});
```
 I'm having some trouble getting Jest running on my work laptop, so I'll do those changes tonight on my home PC instead üëç 
 Thank you @Daniel15!

One problem we often run into is that Jest has an issue with test paths and can't find any more tests. The exit code in this case is 0, so it says everything is fine. Can we add an additional check to appveyor that makes sure at least one test was run?
 We have an integration test for that, however that uses Jest too, so if Jest breaks like this, we won't actually know :D
 Hmm, that's tricky... I feel like the exit code should actually be non-zero
if Jest doesn't find any tests. Can we change that behaviour or add a
--fail-on-no-tests flag that'd do it?

Sent from my phone.

On Sep 3, 2016 1:53 AM, "Christoph Pojer" notifications@github.com wrote:

> Thank you @Daniel15 https://github.com/Daniel15!
> 
> One problem we often run into is that Jest has an issue with test paths
> and can't find any more tests. The exit code in this case is 0, so it says
> everything is fine. Can we add an additional check to appveyor that makes
> sure at least one test was run?
> 
> ‚Äî
> You are receiving this because you were mentioned.
> Reply to this email directly, view it on GitHub
> https://github.com/facebook/jest/pull/1465#issuecomment-244535346, or mute
> the thread
> https://github.com/notifications/unsubscribe-auth/AAFnHaOB2ebBFJeeuWoUCeakdkgfoHMUks5qmTV0gaJpZM4JoL_3
> .
 I'm happy to accept a PR that adds this flag, yes. I'm worried about this having a bad impact on www where our test infra might try to run something that isn't actually a test; we don't want to fail and require changes to the test infra there.
  - Upgrade Lerna. Lerna 2.0 beta 24 has known issues in Windows: It appears to run successfully but actually doesn't do anything (https://github.com/lerna/lerna/issues/226#issuecomment-233049613). Need to upgrade to beta 26 to get an actual working version.
- The regex in `package.json` wasn't working correctly for some reason. Moving the `\` to the right spot (before the `.`) fixed it. (6c7620237ba9fa3a441bb7f26aabc59e9df85467)
- `SearchSource`  was incorrectly escaping `\` characters in the file path. To avoid this, we convert the `\` to `/` before running `escapeStrForRegex`. `replacePathSepForRegex` (which is what `pathToRegex` calls) converts it back to the correct separator anyways.

Fixes #1462
 cc @cpojer - The SearchSource change broke Windows support between 14.1.0 and master, and thus should be considered launch blocking for the next release.
 thank you <3
  "NO TESTS FOUND" is showing up when I run `node packages/jest-cli/bin/jest.js packages\jest-jasmine2\src\__tests__\iterators-test.js`

It looks like there were two separate issues causing this. Initially this bisected to 6c7620237ba9fa3a441bb7f26aabc59e9df85467. I could fix it by adjusting the `testRegex` from `.*-test.\\js` to `.*-test\\.js`, but master was broken even with that patch. Bisecting again after applying that patch, it blames to b56e36832d211c626894bff2591e9b152d14ba5b
 @cristian-sima - Yeah, this bug is only present in the latest alpha versions / master. The latest stable release (14.1.0) does not have the problem.
 @jquense - Yeah I've already got a pull request out to fix it (#1463). 
  Lerna 2.0 beta 24 has known issues in Windows: It appears to run successfully but actually doesn't do anything (https://github.com/lerna/lerna/issues/226#issuecomment-233049613). Need to upgrade to beta 26 to get an actual working version.
 I'll open a separate PR with a few more fixes (including this one)
  I'm on vacation this week and will respond next week.

On Tue, Aug 23, 2016 at 8:19 PM +0200, "Kapil Gowru" <notifications@github.com<mailto:notifications@github.com>> wrote:

@cpojerhttps://github.com/cpojer Any updates here? I'm trying to see if I should proceed with Jest or Mocha. If I proceed with Mocha, I will have to give up the Snapshot tests. If I proceed with Jest, I can't get Enzyme tests to function properly.

## 

You are receiving this because you were mentioned.
Reply to this email directly, view it on GitHubhttps://github.com/facebook/jest/issues/1460#issuecomment-241825704, or mute the threadhttps://github.com/notifications/unsubscribe-auth/AAA0KM_OSiiHMQmc_C9EGiK5zyRCciPfks5qizmHgaJpZM4JoEOW.
 You shouldn't use or need the react-native-mock when using Jest.

This is unlikely a Jest bug so I'll close this issue. However, if you can provide a full repository on github that I can clone, npm install and then test, I'm happy to help more.
 When you are using the jest-react-native preset, this should work.
  This isn't really actionable. Please provide a repository on github that we can npm install and npm test to repro.

It seems like you are using automocking. Please disable it by doing `"automock": false` in your jest config.
  We don't really support npm2 with this integration, I'm sorry. Please wipe away your node modules and use npm3 on this project.
  We don't have a good way to do that right now. I would recommend trying to hook in a debugger (Chrome Inspector) to figure out what is going on. If you know what creates the async work, you can potentially also monkey patch it and track it (like put something around Promise.prototype.then)
 I don't know how you'd kill existing async processes if you don't have a handle on them.
 We could do that, I guess, but I'm worried it leaves people not hanging when it should and they aren't shutting down their resources properly.

cc @dmitriiabramov what do you think?
 One example: I actually ran into this with Jest myself where we had a long running watcher process that wouldn't terminate Jest itself. If Jest would have killed itself during the test run (heh!) I would have never noticed the issue and I would have shipped a version that would hang when people try to use it.
 i'm not sure if it's safe to force kill the process. at the same time, if people want to do some async post processing after the tests are done, they could use `after all` hook that will wait for it to finish before quitting the process.

the other issue that we might have is cutting the output stream before it finished printing. we had this issue before, when error messages don't have enough time to print before the process exits.
 The question is whether we could figure out a way for Jest to say "Looks like some tests aren't cleaning up after themselves. here is what is going on".
 It seems to me like Firebase should be fixed.

I have no reservations against adding an option called `--forceExitAfterTestRun` and it should be easy to add. I think it just requires a change to exit here: https://github.com/facebook/jest/blob/master/packages/jest-cli/src/cli/index.js#L41 if the flag is given regardless of the result.
 If anyone would like to send a PR, this is something that we could use some help with and I outlined details in my previous comment :)
 Closing in favor of the PR that was just opened. We'll continue the discussion there.
  Sure!
  Yes. You can expect that updates to Jest will require you to update your snapshots because we'll be updating the format and improving on the feature :)
  Ok, let's get this in now.
 Awesome work! Thank you so much for helping make the preset awesome. I'll publish a release later today.
  It seems like you are on an older version of react-native before 0.30. The Jest preset only works with 0.30 and onward, please upgrade :)
  `npm info istanbul-api`. They have the typo in their version, lol.
  This isn't really actionable for us. Can you provide a repository on github that we can install and test to see what is missing?
 Would you mind trying:
- Use jest@test (the latest development version)
- As a workaround: use the `jest-environment-jsdom` value for `testEnvironment`.
 Try `jest-environment-jsdom` ‚Äì we haven't published the fix for just using `jsdom` to @test yet.
 Sorry about the trouble. If you stick `"persistModuleRegistryBetweenSpecs": true` into your config and call `example().end().then(‚Ä¶)` in your test it will work.

You can also return the promise from `it` without using `done` at all.

We'll make the module registry persistent in the next major version of Jest, as people have trouble with it.
 We'll make this the default and have an opt-out to the current behavior. It's currently internal.

Jest resets the module registry before every test for isolation but people don't enjoy using this feature in open source and prefer to use imports or top level requires.

Example:

``` js
const React = require('React');
jest.resetModuleRegistry() // implicitly happens in beforeEach right now
const React2 = require('React');
React === React2 // false!
```

but this requires people to write their requires inside of `it` calls instead of at the top level and they won't be able to use imports. People do that though, so we'll make it the default.

It just happens that the stream library has a "lazy require", ie it requires something inside of a function call. If you have a reference of a module from the first module registry and you call something on it and that requires something every time, when the module registry gets reset, it loses it's reference and re-requires it. That way a module, during its lifetime, might use different instances of different modules and that gets messy and it is too magical, so we'll kill it.
 jest.useRealTimers()

We will make this a default soon as well.

On Sat, Aug 20, 2016 at 1:28 AM +0200, "Miguel Oller" <notifications@github.com<mailto:notifications@github.com>> wrote:

So after trying to write my tests again today I came across another bug with using Nightmare. This time I took the time to figure out exactly what it was.

It looks like Jest mocks the global setTimeout which Nightmare uses internally to wait for elements to appear in the DOM or simply to wait a set time. I've updated the repo I linked to before to include this new bug.

Is there a way to disable the mocking of timers in Jest?

## 

You are receiving this because you were mentioned.
Reply to this email directly, view it on GitHubhttps://github.com/facebook/jest/issues/1448#issuecomment-241159472, or mute the threadhttps://github.com/notifications/unsubscribe-auth/AAA0KIMK29IKQk8yR9JUPj53cUcCVWW9ks5qhjv9gaJpZM4Jm5Hf.
 @dmitriiabramov would you mind cloning the master branch in this repo and running `jest --coverage` and investigating a bit?
  Looks good! Just two more minor changes please :)
 Nice work!
  See #1423.
 No worries at all :)
  Your English is just perfect and I can understand your concern. Would you mind explaining why you want to use this flag on the CI? You should always run all tests on CI to make sure everything works together. `--onlyChanged` is meant to be for local development.

I recommend doing this:
- Store the files from `git rev-parse HEAD`
- Call `jest` with that list of files. Then Jest will only run those files. Like `jest <file1> <file2>` etc.

Let me know if that doesn't work for you and I can reopen this issue and help you prepare a PR.
 Since you already found the code where we detect this, would you be willing to send a PR both for git and mercurial that looks for files the way you are asking for? :)
  <img width="779" alt="screen shot 2016-08-16 at 4 18 07 pm" src="https://cloud.githubusercontent.com/assets/940133/17719126/1aeb34d4-63cd-11e6-9f89-288fb0c385ce.png">
 As previously discussed, `toEqual` must be compatible with jasmine 1's version of the same for the time being. The two changes we made in Jasmine 2 to relax the matcher are:
- Do not check for constructor name equality. This one is stupid and I don't want it, it just makes it harder to write tests and people don't care about this. People should care about this in their type-checker but not in a test file.
- Skip undefined fields in both `a` and `b`. This one I somewhat think we should fix, but unless you go and do the work on www I see no way of shipping this.

Alternatively we can run a huge codemod using Jest inside of a jscodeshift transform to codemod the failing tests to a new matcher that matches the current implementation of `toEqual`. I'm not really ready to do it and would like us to focus on pretty-printing the error output first; then make these large changes later.

Another thing I want to bring up is whether you thought about not printing either objects in red. My biggest problem in a sentence like `Expected <loads of gibberish> to equal <more gibberish>` is always to find where the first object ends and the second one starts. Can we print the two objects in black and the rest of the sentence (`to equal` and `Expected` etc.) in red? What do you think?

Finally, if you can find the fastest toEqual implementation on the planet and use that, I would be happy. It is the most used matcher by far and we run some pretty huge objects (in ads code) through it.
 i don't like the `actual/expected` idea at all. every time i see the diff i spend a few seconds trying to figure out what is `actual` and what is `expected`.

also the fact that `actual` value is passed into the function that is called `expect` naturally confuses the human brain

``` js
expect(actual).toEqual(expected)
```

my thoughts on this were to get rid of these terms completely and replace them with:
`added/missing` instead. this way it's very clear what should be green and what should be red
 Let's have this discussion separately from this diff which is about pretty-printing the values. I care more about changing the colors around so that when printing two objects I can still see whether it says "to equal" or "to be". I can do that in a separate diff.

For actual/expected, I think we need to have a bit more of a discussion. I'll think about it.
 I'll send a new PR that uses jasmine's toEqual matcher for now and then another PR on top of that to polish all the messages and their colors.
  Please update Jest to 14.
  Can you try `jest --no-cache`? If you changed your babelrc before the last invocation, we might not update the cache properly.

If that does not work please create a repo on github that I can npm install and npm test to troubleshoot.

Tip: you don't need unmockedModulePathPatterns when using the react-native-preset because automocking will be disabled anyway.
 You can enable preprocessing for this module via this config option: http://facebook.github.io/jest/docs/tutorial-react-native.html#preprocessorignorepatterns-customization

If you'd like, you can also create an issue on this project's github page to ask them to precompile their dependencies and publish build files on npm.
  Not really, this is by design because we cannot make this run efficiently otherwise. In this case you can run `jest` or `jest <pattern>` to match against tests you would like to run. I don't recommend using jest-webpack-alias; please try out the `moduleNameMapper` feature instead.
  I'm assuming you didn't call `toJSON()`? There isn't anything we can do to guard against this ‚Äì snapshots can be any serializable data structure.
 How do you think we should print these? Just like any other React component using `tag`, `props` and `children` or should it be `<InternalReactElement />`?
  yes
  hey @dsifford 
thanks for reporting the issue!
i was able to find the problem. The new version of Istanbul uses babel to instrument the file, and basically this condition (https://github.com/facebook/jest/blob/429b2d1947cc427d01c33bddeae1378221a2a4f5/packages/jest-runtime/src/transform.js#L254) always returns false because of the `.tsx` file extension.

all make a fix for it on monday!
 https://github.com/facebook/jest/pull/1430
 we're going to release the next version in about two weeks or so.
@cpojer are you going to push anything to npm this week?
 I'm more or less continuously pushing a `test` tag this week. You can try `npm install --save-dev jest@test` to try it out. It's your own risk though, we are currently making many awesome changes but some of them might break (please report it though if it is a real bug!).

I published @dmitriiabramov's fix a minute ago, so please feel free to try it out. It's `jest@14.2.2-alpha.22bd3c33` or `jest@test` should work too.
 @dsifford the bug was actually in `jest-runtime` not `jest` itself.
so you'll have to do something like `rm -rf node_modules/*jest*` and then `npm i jest@test --save-dev`

jest tried it on `academic-bloggers-toolkit`

<img width="711" alt="screen shot 2016-08-16 at 8 13 20 pm" src="https://cloud.githubusercontent.com/assets/940133/17723321/196d5fd0-63ee-11e6-92ca-ba1b9cf77af4.png">
 also now you can add something like this to your jest config

``` js
"jest": {
    "collectCoverageFrom": ["src/**/*.{js,ts,tsx}", "!**/{vendor,__tests__}/**"]
}
```

and this will also collect coverage for all files that are not tested but match this set of globs
 @calclavia is there any stack trace? does it happen after/before or during the test run?
 that should be fixed by https://github.com/facebook/jest/pull/1482
  this looks awesome!
@cpojer can you look at it?
later we can kill jasmine part and `toBeCalled` part if we want to
 The direction is good but this won't work because the spy/mock APIs aren't the same. Just look at the current implementation of `toBeCalled` as it works both with Jasmine spies and Jest mock functions. We should also do this for `toBeCalledWith` and move `lastCalledWith` also into the jest matchers file :)

Also, lots of eslint errors.
 Oh yeah, you are right. I'm sorry, I was pretty jetlagged over the weekend and my code review wasn't entirely effective. Do you mind patching this up so it passes all the tests and then doing the same for `toBeCalledWith`? Thanks for all the help :)
 Sent a follow-up.
  sure!
 thank you :)
  As discussed in person I think it would be good if we could take verbose off of config in jest.js and pass it into TestRunner.js an option and pass it along there.
  sure, why not!
  please rebase.
  @suchipi yeah absolutely, we just had absolutely no time at all to think about this or review code. I'm sorry. We'll get back to this soon and are working on merging the snapshot feature into the new matchers and I'll take a look at your PR.
 Hey @suchipi,

I'm sorry I let this diff sit for an entire month. This is not ok and not our usual behavior. We were occupied with the Jest 15 release and @dmitriiabramov took on the work to rewrite our snapshot implementation to work with Jest and also to work better with external frameworks. It goes a bit further than this diff here and lays the groundwork for future additions to snapshots. See #1721.

This means that your PR is no longer applicable to Jest. I apologize that we aren't going to merge your code even though you did all this work. I hope we don't lose you as a future contributor given that the work @dmitriiabramov did was entirely inspired by the discussion you started. I hope to have more discussions with you on where to take the snapshot feature in the future. You are welcome to join us on discord (see facebook.github.io/jest/support.html )
  Yeah we definitely want to improve watch and make it more interactive.
 Fixed in #1508. We'll publish a new version of Jest this week.
  Yeah, there are no DOM events in the test renderer. The idea is that DOM events will be dispatched properly by the browser, so we don't need a fake implementation of that. You can pass arguments into your click handler like `onClick({shiftKey: false})` etc. that basically mock out the event you might receive.

For now you can access items in the tree like this but it is not an officially sanctioned way by the React team at this point. We are working on a selector API for the test renderer which will make this possible through an official API and it is possible that at some point you might have to update this code to properly access child nodes.
 No, it hasn't been worked on yet. I think @aweary was looking into it though!  thank you!
  I'd like to first evaluate whether this makes sense to do. What is the particular reason why you think one general snapshot folder per project is better than many that are colocated with their tests?

How would you name the snapshot files to correspond to the test files? We actually wanted to make it a constraint to colocate snapshots with their test files. This makes it easier for our snapshot cleanup to work (easy 1:1 mapping). I initially thought you wanted to customize the name of the `__snapshots__` folder, which also makes sense.

We can make this work, I just want to understand why this is a good idea and whether we want to support this use-case long term.
 hey @ffxsam !

here's a few files to look at
config types: https://github.com/facebook/jest/blob/master/types/Config.js
then if you add a config option to your package.json, it's usually gets set to the resulting `config` object in here: https://github.com/facebook/jest/blob/master/packages/jest-config/src/normalize.js#L84
this is where (i think) the snapshot file path is calculated) https://github.com/facebook/jest/blob/master/packages/jest-snapshot/src/SnapshotFile.js#L163
 Also, we should update our contributing guideline for Jest.

Here is how it works basically:
- `npm install`
- `brew install hg` (or use any other package manager that can install mercurial, needed for the Jest tests)
- `npm run test`

While developing, make sure to run `npm run watch` to continuously build your changes in the background.
 I honestly think the complexity isn't worth it. If you want all snapshots in one place, also put the tests in one place.

Personally I suggest colocating your tests with your components and then snapshots will be colocated with your tests. This makes it easy to find things as your project grows.
 I mean, that's just what we use at Facebook. Anything that works well for you is fine. If you want to power through and can find a good way to make customizable snapshot folders work (not just having different names for them) and it doesn't add much complexity, I'm happy to merge it but for us there is little reason to do this. I hope you understand :)
  this is awesome @lacker !
 This is amazing @lacker. You deserve a medal for this. I added some inline comments and suggestions (but accidentally commented on the README, not API.md, hope you don't mind :) ).

I really like that you explain code that might behave a certain way without spelling out the implementation because it would just be way too much.

I recommend sorting API methods by frequency or how likely people will use them (toEqual, toBe, toMatchSnapshot are used more often than others). I think it also makes sense to explain matchers in a way that expressed people should find the matcher that is closest to what behavior they want to assert because it will make the test more readable and provide better error messages.

Again, fantastic work, this is amazing.
 Amazing.
  This is great! Do you mind sending a follow up that gets rid of stripJestVersion in all the test files?
 should we create some global debug function that will print only if `--debug` flag is passed?

e.g.

``` js
const debug = require('jest-debug');
debug(`using babel-jest version: ${babelJest.version}`);
```
  i don't think `react-test-renderer` can accept the `context` argument.
i think for the snapshot testing it's better to look at [this](https://github.com/yahoo/react-intl/wiki/Testing-with-React-Intl#dom-rendering) or [this](https://github.com/yahoo/react-intl/wiki/Testing-with-React-Intl#testing-example-components-that-use-react-intl) example.

hey @ericf can you look at this?

we should write a doc for [jest](https://github.com/yahoo/react-intl/wiki/Testing-with-React-Intl#jest) if we can get a working example :)
  Nice work! Promises are complicated and over time this happened, I guess :D 
  Thank @taion! Just two minor inline comments if you'd be so kind to fix.

cc @jquense who thinks the project is called Webpack :P
 wow, you should get a medal for this turnaround time. Thank you!!
  I recommend for now to mock out these components:

``` js
jest.mock('ListView', () => 'ListView');
jest.mock('ScrollView', () => 'ScrollView');
```
 Oh I see. @DaleJefferson can you share your mock? We should add it to the jest-react-native preset.
 I'm adding new default mocks in Jest 15 this week: https://github.com/facebook/jest/pull/1516
  It's fine if we bump the peer-dep to 0.31. That way people with react-native 0.30 can use 14.1.2 and we'll publish 14.2.0 to work with 0.31.
 (this was fixed in the latest update to jest-react-native).
  Hmm, that is very weird. Is the file system access slow, that's really the only thing that should be different here between Jest and mocha? Jest crawls the file system from the root (package.json) and looks at all the files for static analysis. How many cores does the system report that it has? Can you try invoking Jest with `-i`?
 Another thing is that if you are using babel-jest, babel actually loads a ton of modules so if the fs is slow, this might contribute to that.
 i remember having similar kind of issues inside docker container. The problem was the slowness of fs access. I think it was related to mounting a directory through a virtual container
 found the issue https://github.com/docker/compose/issues/631
not sure if it's still relevant 
 Yeah I'm gonna close this out because unfortunately it isn't actionable from our side :(
  Thank you! This is great.
  @bear2029 are you running `--watch` and `--coverage` at the same time?
 we rewrote the way coverage is collected in the latest version of jest, and if `--coverage` is not specified, the threshold should not be checked either
 @dmitriiabramov I don't think what you said is true, is it? See https://github.com/facebook/jest/blob/master/packages/jest-config/src/normalize.js#L135-L137 ‚Äì we should remove this.
 @cpojer mutability and our config got me again! :)
yeah. we should remove this
 https://github.com/facebook/jest/pull/1440
 Will be released in a bit.
  I still haven't made up my mind about what `toMatchSnapshot` should take as an argument. @joesavona asked about custom formatters and that's what the argument could be used for as well.
 I'm happy to support both:

```
toMatchSnapshot("string-name");
toMatchSnapshot({name: "string-name"});
```

the simple case will be to name a snapshot and we'll have option value to add more fields as options in the future. Generally I'm not a big fan of accepting differently typed arguments but this seems like a special case where we should allow it :)

Feel free to send a PR including tests. We have snapshot integration tests in `integration_tests` as well.
 This will be in the next Jest release thanks to @ericclemmons. We started with the most simple API of passing a string to `toMatchSnapshot`.  Thank you! We recommend to add this to your own preprocessorIgnorePattern, see http://facebook.github.io/jest/docs/tutorial-react-native.html#preprocessorignorepatterns-customization
  Just published a new version of jest-react-native which should solve this.
  I don't quite understand what `:i18n` is and it seems like that's why `jest.mock` fails with the error you are seeing. If you use the correct module name (probably without the :i18n?) it will work.
 Please let me know if `:i18n` is some sort of webpack thing, though. I have never seen it.
 Yeah, I'd recommend to use the `moduleNameMapper` config option to remap where these direct to: http://facebook.github.io/jest/docs/api.html#modulenamemapper-object-string-string

I don't know how meteor works with module resolution. What does `meteor/universe:i18n` translate to when using meteor? Which bundler is it using or is meteor its own bundler?
 I'd recommend going with the moduleNameMapper option to map that module to a stub or something.
 Yeah, something like this should work.
 It shouldn't be in `__mocks__` though, those files are kinda special :)
  yeah I think that makes sense. Are you willing to add this to the preset and send a PR? :)
 Can we just do "passPerPreset: true" and put the babel-preset-jest into the last list and then try to see when they run?
 In the tutorial we can also just recommend people to add:

``` js
{
  "env": {
    "test": [config]
  }
}
```

that should work fine, right? And people can continue to use babel-jest.
 Let's close this now and update the tutorial for webpack two support when that is actually shipped and ready. Do you wanna work on this?
 Also, while you are changing your babelrc, I recommend running jest with `--no-cache` until you are done.

@taion yeah that would be great. Maybe can you add a note to the bottom that talks about webpack two and state it is experimental?
 I was under the impression there could be many nested .babelrc files. I guess I could copy https://github.com/babel/babel-loader/blob/fca4b92cd09efdaf94b5c422c4f0e1b7bb26997d/lib/resolve-rc.js into Jest and add it to the cache key? I've been meaning to fix this for a while but was worried about not finding all the babelrc files.
 that's good to know :) Thanks! I'll include it in the cache key then.
  thanks!
  We should provide a default mock for TextInput.
 Fixed in https://github.com/facebook/jest/pull/1516 for Jest 15.
  ``` js
it('works on jest.fn', () => {
    const foo = jest.fn();
    foo();
    expect(foo).toHaveBeenCalled();
});
```

```
 .toHaveBeenCalledTimes() ‚Ä∫ it works on jest.fn
  - Error: toHaveBeenCalled matcher can only execute on a Spy function
        at ensureSpy (packages/jest-matchers/src/spy-matchers.js:51:11)
```

cc @maximderbin 
 The Jest matcher for this is toBeCalled. I think we should update toHaveBeenCalled and use toBeCalled's implementation for it and similar matchers. I remember Dmitrii and I previously talked about this.

On Sat, Aug 6, 2016 at 4:51 AM +0900, "Maxim Derbin" <notifications@github.com<mailto:notifications@github.com>> wrote:

@dmitriiabramovhttps://github.com/dmitriiabramov I'll have a look today or tomorrow

## 

You are receiving this because you are subscribed to this thread.
Reply to this email directly, view it on GitHubhttps://github.com/facebook/jest/issues/1382#issuecomment-237946379, or mute the threadhttps://github.com/notifications/unsubscribe-auth/AAA0KHNZbiR1P4bqDmqmJtJ_UzpqwTffks5qc5Q6gaJpZM4JeAXi.
  thank you!
  thank you!
  This is awesome. Thank you so much for the fix and for bearing with us on writing a test :)
  Yeah this makes sense! Thank you.
 I'll publish a fix later today.
 Sorry, slipped a bit. Will publish now.
 done! install jest-react-native 14.1.2.
 No, unfortunately the jest-react-native preset is only available from 0.30+ because it required some changes to react-native. You can still try it out with the preset, it might just work alright for testing. You can also copy bits and pieces from the preset to make your own thing.
  I totally agree we should have this.
 i'll make it work!
@cpojer should we add async functions to jest .babelrc?
 no, please don't. `async/await` compiles into a promise. This is literally just like the work you did for `pit`:

``` js
expect(() => {
  return new Promise(‚Ä¶);
}).toThrow();
```

when the function is called and returns a promise and it doesn't throw, we should wait for the promise to resolve and then make sure it throws.

Since it creates an `async` function inside of another `async` function it should properly make the `it` callback a promise, right?
 @cowboy that is actually pretty sweet. I don't think `jest.sincify` is a great name. It should live somewhere on `expect` possibly and be in the jest-matchers package. Thanks for coming up with a few proposals, everyone. I added some more thoughts in the PR by @excitement-engineer: https://github.com/facebook/jest/pull/3068#issuecomment-285070025 Fixed with #3068. This will land in Jest v20.   Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks!
 Thank you!
  Can you provide a repository on github that I can npm install and `npm test` to locate the issue?
 Can you provide a reduced test case with just the modules required that point out this bug?
  Hey! It does work, however we don't use deep equality any more but rather object identity.

``` js
const object = [1];
expect([object]).toContain(object); // passes
```

Another workaround:

``` js
const object = 1;
const array = [1];
expect(array[0]).toEqual(object);
```

Personally I feel like this makes more sense and will enable you to write _better_ tests. When I updated the matchers at FB I actually found some tests that weren't really doing anything. The second example makes it explicit what you expect, most of the times the return values of a function are consistent.

cc @dmitriiabramov
 testing deep equality in `.toContain` would probably be too dangerous, but what if we added another matcher like `expect([{a: 1}, {b: 2}]).toContainEqual({1: 5})`?
 I think we are ok with this restriction and there hasn't been any progress on this issue so will close it. Happy to accept a PR for a new matcher.
 @mthmulders please send a PR! Let's call it toContainEqual and I'll think about the name until the PR is ready. Maybe there is something better :)
  What kind of backend testing are you trying to do? Jest itself uses Jest for tests and loads of libraries use Jest for testing. Can you provide a repository on github that I can use to `npm install` and `npm test` that shows your issue?

Two things I recommend: try setting `"automock": false` and `"testEnvironment": "node"`. If your other tests rely on this, you can create a separate Jest config and run jest with `--config=pathToConfig.json` and use `modulePathIgnorePatterns` to ignore the frontend tests.
 Yes, the default environment (`jsdom`) doesn't always lend itself well to node testing. Another benefit is that the node env will load 500ms faster (effectively instant) because jsdom is kinda slow.
  Jest does not support browser rendering and it is unlikely that it will. Jest ships with jsdom which emulates the DOM.

I encourage you to try out snapshot testing: https://facebook.github.io/jest/blog/2016/07/27/jest-14.html
  I think it makes sense to assume that react-test-renderer and react will be published together and the same version of both should be used, just like for react-dom. I don't expect this to be an issue going forward and I believe your issue here is enough documentation now. Thank you for documenting it.
   LGTM.

We are like a really serious open source project now.
 @cpojer  we should probably collect coverage for only some specific packages.
most of the things are now tested through integration tests and collecting coverage for those is not really possible
 yeah, feel free to improve it. I just wanted to get it in, because why not? :)
  thanks!
  Yeah, that sounds like it could be awesome! I'm happy to help come up with content. I'm actually in London from August 15-19 and would be happy to chat with you about this in person.
 <3
 Oh! Can we take a look at it before you are planning on launching it?
 ok! Closing this issue.
  I agree that this is currently hideous. Good news is we are actively swapping out all of the Jasmine matchers and we have a new nice diff engine that will look similar to snapshot failures. We hope to ship an improved version of toEqual soon and hope you can bear with us in the meantime.

On Wed, Aug 3, 2016 at 8:09 PM +0900, "Mattias Petter Johansson" <notifications@github.com<mailto:notifications@github.com>> wrote:

This is just unreadable. Some line breaks and indentation would go a long way.
[screen shot 2016-08-03 at 11 20 43]https://urldefense.proofpoint.com/v2/url?u=https-3A__cloud.githubusercontent.com_assets_17815_17360522_5d44ae0c-2D596c-2D11e6-2D815e-2D3b3a1ddc22f4.png&d=CwMCaQ&c=5VD0RTtNlTh3ycd41b3MUw&r=aFhQMFmdCAmrM__WP0c73w&m=ya23oLxCIu0VrKPjjPPtMBMZlMGofrRgXoz6e3d4Zgg&s=GRxRe6jcA3aZCLswfHkMZLf8iPIWx5qMdyAG9ALeyuY&e=

## 

You are receiving this because you are subscribed to this thread.
Reply to this email directly, view it on GitHubhttps://github.com/facebook/jest/issues/1358, or mute the threadhttps://github.com/notifications/unsubscribe-auth/AAA0KKoOaVmMGek3F2IBSbuy35qzTWqQks5qcF2YgaJpZM4Jbdxr.
 this is coming very soon. This is really the last jasmine matcher that needs to be fixed
 Fixed in Jest 15: facebook.github.io/jest/blog/2016/09/01/jest-15.html :)
  The tutorial does say that the package.json will look "something like this" ‚Äì maybe we can instead of `*` use something like `current-version` or something? I really don't want to have to track other projects and update our tutorials every time they bump a release. Do you wanna send a pull request for this? (It's in the docs folder on master).
  Do you want to make a mock of what you'd like to see? I can make your dreams come true because I'm awesome at regex and usage of chalk.
 i actually think it's a great idea. I usually follow the same workflow.

i can see thin implemented in two ways:
1. Only highlight the test stack line when matcher throws (should be super easy with new matchers)
2. Catch whatever throws and highlight the first occurrence of `-test.js` file in the stack (Jasmine will get in the way)
 I love this too.
 We highlight project files differently from outside files now and could potentially highlight test files even more.
 Ok, I'll highlight test files differently from other code. This should be nice.
  cc @dmitriiabramov 
 @yaycmyk hm. we rewrote the whole collection/instrumentation flow this months.
did it just start happening or does it also happen in jest <14.0?
 Please try with `jest@test` or `jest@14.2.2-alpha.22bd3c33` to see if this issue still persists. If it does, we'll reopen this issue.
 @yaycmyk are you using only babel-jest or a custom preprocessor?
it can happen when we instrument coverage **after** all other transformations are done. I didn't test it much though
  This should be fixed with jest-react-native 14.1.1.
 I see, it must be react-dom then. Can you try `jest.mock('react/lib/ReactDefaultInjection')` and see if that makes it work?
 Can you share a repository on GitHub that highlights this error? I'm pretty sure we need to either provide better mocking defaults in Jest or figure out a way for React to not completely blow up when react-dom and react-test-renderer are both required. The problem here isn't a Jest issue, it's that react-dom and the react-test-renderer are both rendering targets for React and right now in React you can only load a single rendering target.
 Yeah we should really come up with documentation for this and maybe even add error messages to React that point you to what you need to do to avoid the errors.
 There is a workaround and the next version of React won't have this problem.
 A workaround to use both enzyme (with react-dom) and react-test-renderer in one file is:

```
beforeEach(() => jest.resetModules());

test('react-dom', () => {
  const React = require('react');
  const enzyme = require('enzyme');
  // write your test with enzyme
});

test('react-test-renderer', () => {
  const React = require('react');
  const renderer = require('react-test-renderer');
  // write your test with react-test-renderer
});
```

This will give you fresh copies of React for every test.
 I don't see the value in that. Once the test-renderer has a find API there is little value in using enzyme for this kind of testing. The React team is working on it.
 What is a click in an environment that is a fake implementation of the DOM? It is simply a function call, so calling a prop called `onClick` is exactly the same.
 @countoren 

The problem will be fixed in React 15.4.0, but it is not released yet.
I believe this is mentioned in the thread above so feel free to read through it!
 You should be able to try React `15.4.0-rc.4` (be sure to bump all packages).
If you have issues please report them in https://github.com/facebook/react/issues/7770.
 @DarrylD 

Have you had a chance to read my comments above?

From https://github.com/facebook/jest/issues/1353#issuecomment-254761524:

> You should be able to try React 15.4.0-rc.4 (be sure to bump all packages).

From https://github.com/facebook/jest/issues/1353#issuecomment-249906262:

> The problem will be fixed in React 15.4.0, but it is not released yet.

It is not expected to be fixed in Jest 17 because it is not a bug in Jest.

**The bug is in React, and it will be fixed in React 15.4.0.**
You can already install React `15.4.0-rc.4` if you want to try it out.

Cheers!
 No worries. Let me add this to the top post so less people miss it.
 This was fixed in React 15.4.0 which is [out today](https://facebook.github.io/react/blog/2016/11/16/react-v15.4.0.html).
  I published pretty-format 3.5.2. Simply reinstalling pretty-format or wiping away Jest from your node_modules and reinstalling it should work.
 And also, thanks for the bug report!
  Thank you!

Would you mind changing it so this is only required once?

``` js
const {Response, Request, Header} = react-native/Libraries/Fetch/fetch);
global.Response = Response;
// etc.
```
 Yes, that's actually what we do internally at Facebook as well :)
 Also it seems like travis is failing. Please make sure to run `npm run lint` or `npm run test` and fix the errors :)
 Published 14.1.1. :)
   This looks good!

If we are doing a major version bump for this, should we completely remove coverageIgnorePatterns and collectCoverageOnlyFrom? I don't think these are important enough that we have to do two majors for deprecation + removal, so I'm ok with being radical.
 @cpojer i would rather keep it secret and undocumented for a while. I want to see how easy it is to use it and how it performs. I'm not really a fan of having both regexes and globs together :)
 Ok.
 @faisalil it'll first run the files through your preprocessor and then through the coverage instrumenter. 
The results can be a little off but mostly accurate (if your preprocessor doesn't retain lines, the line coverage will not be accurate at all) 
We still have some work to do on getting globs into jest, and then we'll write docs for it
  You shouldn't set `__DEV__` to false in your tests. Production versions often skip checks that you should use in tests.

If you want to set it to false, put `globals.__DEV__ = false` in a file and add it to the "setupFiles" config option array.
  Can you try out the identify-obj-proxy module as described here: http://facebook.github.io/jest/docs/tutorial-webpack.html#content ?

(note: requires node 6).
 Can you share a repository with your Jest config that shows this problem? Otherwise it will be impossible to help.
 cc @keyanzhang can you take a look at this? I thought that this would work exactly as expected with your object proxy module.
 This is so awesome. Thanks @keyanzhang for finding the issue!
  true!

It's still passed in. I think I didn't remove this argument because it would be a breaking change and requires a minor or major version bump.
 working on it.
  We just moved to a newer version of istanbul that instruments code using babel. This way it will generate coverage data that is much more accurate.
I'm not sure how good the data is yet, but as an alternative solution there is a sourcemap coverage report mapper that istanbul provides.

most the code is still in PRs but most likely it'll make it to jest 15.0
 I think this is gonna be resolved with all the work @dmitriiabramov is doing.
  Hey!

This is exciting. Would you mind sending a PR with the API updates you need? I think here is what we should do: expose SnapshotFile through `jest-snapshot/src/index.js`: you should be able to do `require('jest-snapshot').SnapshotFile` and never reach into `jest-snapshot/build/‚Ä¶`

We might want to make the snapshot cleanup function more generic too, as you'll probably need that to keep consistency. We might also want to move the reporter into jest-snasphot from jest-cli, but let's do this step-by-step :)
 This looks like a good start but I want to stress the importance of a good user experience which is why we spent so much time trying to get snapshot testing in Jest exactly right.
- I agree we should export the SnapshotFile constructor in Jest.
- Can you think of a way to make the matcher more general and not tied to patching jasmine so we can share as much code as possible?
- I recommend throwing if the update flag is passed and the snapshot matches. Otherwise people might keep the update flag in there, always overwriting the snapshot. It is probably going to be pretty annoying if you have 100 snapshots that all change if you modify a component that all snapshots rely on.
- Have you thought about CLI output or further test runner integration? Jest writes a nice summary every time a snapshot is modified, outdated or a snapshot or test file has been removed that has an associated test or snapshot file. This is to make sure the user is informed but also makes sure that the repo is always in a clean state.
- We didn't think `.not` is useful. How would it provide any value? Which snapshot would you test against?

We are hoping to further improve the UX and I feel like we are just at the beginning with Jest snapshot testing ‚Äì if you'd ever like to use Jest itself and help us improve our snapshot feature, please let use know :)
 Thanks for your response.

# Integration

I think jest-snapshot should contain all the functionality necessary to integrate the feature into other runners. Usually the way we approach problem solving is that we aren't providing solutions to problems we don't have, which is why you are in the unfortunate position to have to go in and make it adaptable for your use-case. I'm not sure I understand your idea about `processSnapshot`. I feel like you could do:

``` js
const matcher = require('jest-snapshot').matcher;
const result = matcher(filePath, options, /* TODO: remove this arg; but it is a breaking change */ null, snapshotState)().compare(actual);
```

It looks like some indirection because Jasmine matchers kind of suck but we are planning to simplify this matcher in the next release (cc @dmitriiabramov). The result variable should then contain a `message` and a `pass` flag which you can use in chai. I think your chai matcher should wrap around this matcher in Jest and it should already be possible.

I think you can actually move snapshot tracking into beforeAll/afterAll and implement it on top of the APIs provided by `jest-snapshot`. If it proves to be universally useful, we can integrate it into jest-snapshot but I think I'd like to see it work in "userland" first.

# .not matcher

Yeah, it doesn't make so much sense to me so I'd just prohibit it.

# The number/name of snapshots

We made it so that Jest keeps track of the current test name and for each test (call to `it`) it keeps a counter. Consider this example:

``` js
describe('abc', () => it('def', () => expect(foo).toMatchSnapshot());
it('test', expect(bar).toMatchSnapshot());
```

will generate "abc def 1" as first snapshot name and "test 1" as second. If you add a second snapshot in the "def"-it-call, it's name will be "abc def 2". We then alphabetically sort all the snapshots from a test and save them in a file. This is so that people can have as many snapshots per file as they want and when they reorder their assertions the snapshot file won't change.

# Jest and contributions

Thank you for your kind words. I agree automocking is often counter-productive and we now recommend to disable automocking and are likely going to ship with automocking disabled by default in the next major release of Jest. We also dropped the ball initially when we shipped Jest but it has improved a lot since.

You can find a high-level overview of our plans in the [Jest 14.0 blog post](http://facebook.github.io/jest/blog/2016/07/27/jest-14.html#what-s-next-for-jest) and I'm happy to share more details. We literally want to redo everything about Jest that sucks and one project that I'm excited about and am hoping that someone from the community could take on is to rewrite the reporter code and what Jest outputs when run from the CLI ‚Äì it could be so much prettier than it is. However, if you'd like to start using Jest, I'd be happy to listen to your pain points and what you'd like to change to better suit your needs. I'm sure we can make it work well for you.
 ### Message

I recommend to send a pull request that refactors the matcher into two parts: one that returns `{pass, actual, expected}` and one (the jasmine matcher) that wraps the raw matcher and transforms it into `{pass, message}`. This way you can do whatever you'd like with the actual and expected value.

### Counter

If you create a PR as suggested above, the raw matcher will receive a snapshot state. You can then provide your own snapshot state. We should also make `getSnapshotState` separate from patching jasmine.

### Concrete suggestions:

Add:
- `jest-snapshot.createSnapshotState(filePath)`
- `jest-snapshot.patchJasmine(jasmine, snapshotState)`
- Split up the matchers into a raw matcher and a jasmine matcher.

How does this sound?
  Can you try `jest.mock('Header', () => 'Header')`?
  I recommend doing this:

``` js
jest.mock('ListView', () => 'ListView');
```

which should work until we provide a better mock for it.
 This will be fixed in Jest 15 with https://github.com/facebook/jest/pull/1516
  thank you!
  Prints:
- "re-run with `-u`" when invoked with Jest.
- "run with `npm <event> -- -u`" when invoked through npm.

cc @gaearon 
  Yes this is indeed a React issue.

Please comment on https://github.com/facebook/react/issues/7148
  I recommend using `"automock": false` in your Jest config for now. We'll turn off automocking by default soon.
 I'm gonna close this as wontfix. Jest 15 ships with automocking disabled by default: facebook.github.io/jest/blog/2016/09/01/jest-15.html
  this is interesting... the only thing i can think of is that arguments don't get parsed.
do you have any code on github with this example so we can reproduce it?
otherwise you can stick `console.log(newConfig)` into this line and see if it prints the configuration correctly (it should have `newConfig.updateSnapshot` set to `true` when running with `-u`)
 @cpojer don't we use the local version of jest when running `jest` globally? 
  Thank you! We actually generate the website from master. The blog post can be found in `blog/`. Would you mind making the change there? :)
 Oh wait, nevermind. This was already fixed yesterday but I forgot to publish the site. See #1326 

Thank you for your contribution.
  Thanks for bringing up these questions. I think it's important we have these discussions and think about where we can take snapshot testing from this basic version we have right now.

To prevent against environment specific configuration: This is where Jest's mocking system can really shiny. I'm assuming you aren't making actual API calls in your test run (if you are, you should probably record their outputs) so you can mock out the module that provides the API url:

``` js
jest.mock('~/config', () => {
  const config = require.requireActual('~/config');
  config.apiUrl = 'http://my-app.com';
  return config;
});

import config from '~/config';

// config.apiUrl will always be the mocked version
```

This is basically a form of "dependency injection" with modules as boundaries.

To answer your second question: `--bail` actually only works on a per-test-file basis, not within a test but I can see how we might want to change that eventually. Currently we also have a problem when `fit` is used to skip other tests or when a runtime error occurs: Jest will yell at you for having obsolete snapshots and that you should run with `-u` to remove them. I think we need to change Jest to be a bit more conservative and skip snapshot validation in those cases.

One thing we tried to do is to make snapshot files independent to test file changes as long as you are only moving around `it` calls within a file. For example:

``` js
it('renders a snapshot', () => expect('foo').toMatchSnasphot());

it('renders another snapshot', () => expect('foo').toMatchSnasphot());
```

should produce identical output to 

``` js
it('renders another snapshot', () => expect('foo').toMatchSnasphot());

it('renders a snapshot', () => expect('foo').toMatchSnasphot());
```

To make the system as seamless as possible, we had to pick a barrier that we can use to create names for our snapshots. Logically it seemed like `it` was the most granular we could go without requiring a babel-transform or something. To guard against the specific issue you are running into I'd propose to separate individual tests into more `it` calls.

Does this make sense?
 I see what you mean. Yes, it is suggested that you review your changes carefully and that your code reviewers do the same. Snapshots should be considered additional signal during code review, as well.
 also as we talked yesterday. It would be nice to have an interactive mode for updating snapshot (similar to `git add -i`)

```
Snapshot mismatch:
-expected +actual

- missing string
+ added string

Do you want to update this snapshot? Y\N
Y
...
```

that would be very helpful for going through test failures one by one after a big refactoring and filtering out legitimate failures from just formatting updates
 Ohh that's a great idea @dmitriiabramov.

The initial idea for snapshot tests was to not be intrusive. If people have to stop and pause every time something changes, that would be bad. Adding it as an option is a good idea however.
 @aaronjensen are you willing to work on an experiment/pull request for that? I agree it would be helpful as I need to look at this stuff manually too.
 I'm gonna close this one in favor of #1798 which is a more focused discussion about just this feature we are discussing now.
  Thank you! Must have come from copying the post from quip :(
 Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!
  I actually prefer to keep linking to the PR because it shows how to convert test utils tests to snapshots. Thank you for your contribution though!
  It seems like not all your Jest dependencies were updated to 14.0. I recommend running rm -rf node_modules/jest-\* and then reinstall.

On Wed, Jul 27, 2016 at 10:26 PM +0900, "marudor" <notifications@github.com<mailto:notifications@github.com>> wrote:

I get the following error:

TypeError: this._environment.runScript is not a function

switching to jsdom make it work again.
config:

{
    "verbose": true,
    "noStackTrace": true,
    "automock": false,
    "notify": true,
    "setupTestFrameworkScriptFile": "src/testInit.js",
    "testEnvironment": "node",
    "testPathDirs": [
      "src"
    ]
  }

## 

You are receiving this because you are subscribed to this thread.
Reply to this email directly, view it on GitHubhttps://github.com/facebook/jest/issues/1323, or mute the threadhttps://github.com/notifications/unsubscribe-auth/AAA0KB-2TfrDNpiKBDTcZkTPrz4m3SaCks5qZ1xdgaJpZM4JWL1G.
  As a workaround, can you use moduleDirectories instead?
 Ok, I think that's the right solution here actually.
  If automocking is false then lodash is most certainly not mocked. I suspect the problem might be with how lodash is detecting the environment and it always does some crazy trickery.

Here is what we forward into the sandbox context: https://github.com/facebook/jest/blob/master/packages/jest-environment-node/src/index.js#L30-L38

cc @jdalton did anything change here or can you find anything missing from the node env that would break this?

As a workaround, @trotzig can you try to set `"testEnvironment": "jsdom"` and see if that works?
 What exactly is different and what should we put on our node environment to make this work?
 Ok cool, can you reference this issue in the correpsonding lodash issue? Closing this issue here since it isn't Jest related.

@trotzig please downgrade lodash or use the jsdom environment in the meantime. Sorry for the confusion!

@jdalton would you be willing to add a simple Jest test for lodash that uses:

```
"jest": {
  "automock": false,
  "testEnvironment": "node"
}
```

and makes sure that lodash works? We use Jest at FB and in dozens of React codebases and lodash is often part of it.
  Thanks for troubleshooting this! This is indeed a bug in the plugin and I attached a PR that should fix this. I'll shortly publish a new version of babel-plugin-jest-hoist. If you wipe away the module and babel-jest and babel-preset-jest and reinstall them, this error should go away.
  This probably just means a file has changed since and it is re-running some tests?
 What exactly are the steps to reproduce this? :) Otherwise I think it'll be pretty hard to try to resolve this.
 Duplicate of #1284.
  Thank you for your patience. We launched Jest 14.0 with experimental react-native support:
- [Blog Post](http://facebook.github.io/jest/blog/2016/07/27/jest-14.html)
- [React-Native Tutorial](http://facebook.github.io/jest/docs/tutorial-react-native.html)

Please feel free to create new issues after trying out the new integration if any issues remain. 
 No it seems like your configuration is messed up. Please remove `modulePathIgnorePatterns`, `haste`, `testFileExtensions` and `unmockedModulePathPatterns`.
 @Bhullnatik can you try `--no-cache`?
  I think I have an idea what's going on. Thank you for the incredibly detailed bug report, that was very helpful.

Jest runs tests in parallel in different processes and I was thinking the env might be slightly different. Jest itself sets NODE_ENV=test but it just appeared to me that we might not do this in the worker processes. This means that if you run in band (or run a single test), this line: https://github.com/facebook/fbjs/blob/master/packages/babel-preset-fbjs/configure.js#L17 will be triggered and use the inline requires transform. When running in worker processes, that env variable might not be set (which is a bug, we should set it!). Can you try launching Jest with `NODE_ENV=foo jest` and tell me if that works?
 This shall be easy to fix then. Just stick `inlineRequires: false` into your call to the fbjs/configure function.
 (Closing as I'm sure that will solve the problem, will reopen if it does not)

Also make sure you are using `--no-cache` on the first run for this to make sure it isn't using the cache.
 That seems odd, the stack trace you posted points to inline requires still being on...
 Can you try to use the `"moduleNameMapper"` config option to map `printRelayQuery` to `printRelayOSSQuery`?
 Can you provide a repo that I can `npm install` and test so that I can repro this myself? That will probably help find a solution.
 We are currently working on releasing a major version of Jest and it is taking up all of my time. Please be a bit more patient, I'm doing everything I can and am hoping to get back to this issue soon.
 Is this issue still present on Jest 15?
  You can add `"globals": {"__DEV__": true}"` to your config.
  Can you try `jest --no-cache`? I'm confident the example works as our CI doesn't break with it.

Which version of Jest are you using and what exactly is your setup?
  Which version of Jest are you using? Are you using babel-jest? Can you try `jest --no-cache`?
 Closing due to inactivity. Please provide more information and I'll reopen this issue.
  You are right, that does seem like a bug :(
 This is a limitation that we'll have to live with for a while. I'm gonna create a new issue soon with a detailed plan on how to improve manual mocking so I'll close this issue for now.
  Yeah, we intentionally just map the module name to whatever you specify, so it is an intended limitation that you can only have one mock per module name mapper rule.
  I think that "Create a directory `__tests__/` with a file `sum-test.js`" right above the piece of code is enough of an explanation.

Thank you for your PR, however.
  Closing in favor of #1423 
 @cpojer this PR had `toHaveBeenCalledWith`, should we reopen and finish it?
 I'll do it.
  this is awesome! thanks!
you can simplify some tests using `jasmine.createSpy`
 `toBeCalled` and friends in `jest-jasmine2/src/index.js` support both Jest's mock functions and jasmine spies. Can we just convert those and alias the Jest names (`toBeCalled`) to the Jasmine names (`toHaveBeenCalled`)? That way we don't have code duplication and the jasmine matchers actually become more powerful (as they are just aliases of the same ones in Jest). I think that would be ideal.
 @cpojer i'm a little worried that it will slow us down when we start working on our mocking functionality.
I'd rather keep them separate having `.toBeCalled` and friends in core `jest-matchers` package and `.toHaveBeenCalled` in `jest-jasmine-adapter` (https://github.com/facebook/jest/pull/1298).
React repo is full of `SpyOn`, and if we ever change mocking API we'll have to stop and refactor entire react repo first
 plus we already have the code for both and it won't be any extra work
 I don't think that makes sense. The Jest matchers support both Jest mocks and Jasmine spies, so just aliasing them to the jasmine ones makes sense to me, as it will deduplicate the matcher code (and those are 6 matchers, and it could be only three).

I also offer to clean up the React tests to use jest's mocks. I can take a hit for the team :)
 let's see if it works on www. I'll move it out of this package a little later
  Thank you :)
  Thank you! Please sign our contributor agreement :)

cc @dmitriiabramov if we are ok with this console message in our `npm test` run, instead of copying/symlinking Jest into every project we can now simply `rm -rf node_modules/jest-cli` and then run jest-cli from packages. We can also.. just keep doing what we are doing, I guess.
 The bot sometimes takes a while to confirm it.
 We'll probably hold off publishing a new version for a little while ‚Äì I hope that is ok?

We are currently rewriting major parts of Jest and will probably tag 14.0 next with a major rewrite of all the matchers, we are killing Jasmine inside of Jest and will replace it with our own implementations and pretty error messages.
  Thank you for bringing this up and for the detailed description of the issue. To be honest, I have been upset about this stuff myself and it definitely makes Jest's test suite a little harder to deal with.

I also agree the way this is working currently does not make any sense if Jest still ends up running tests anyway. I'm sorry you wasted time on this.

Would you be willing to send a pull request?

My suggestion is as follows:
- Remove `process.exit(1)`.
- Do `process.on('exit', () => console.log(chalk.red('The error message ')))` so that we get a nice, red message at the end of a test run telling you that something is not quite as it should.

It will allow people to use the wrong version of Jest (which isn't recommended, because there might be breaking changes) but it will still finish the test run properly and will print a message at the bottom. What do you think?
  We are tracking this work internally. I'll close it here and add this to the internal task. For people in open source who cannot see FB tasks: we are planning to rewrite and improve `--watch` over the next few months. I'm happy to answer questions if anyone is interested in our progress or if anyone wants to work on this.
  I would probably suggest disabling automocking altogether and doing `"automock": false` in the config.

It does seem like for unmocking/mocking we don't properly take the moduleNameMapper into account.
 No, Jest has a lot more to offer than automocking. Automocking is useful in certain situations, like when you have a codebase that isn't tested at all with a huge amount of tightly connected dependencies. We have found at Facebook that after years of it being beneficial, it is not providing as much value as it once did and people choose to disable it more often.

Jest itself has a ton of other features that are critical to Facebook. I refer to the website for a subset of those features.

Regarding this individual bug, it doesn't look like I'm gonna get to this any time soon as I'm focused on Jest's performance and some other developer experience work for the next few months. If you'd like to help out to fix this, it is likely going to be somewhere around here: https://github.com/facebook/jest/blob/424e0db7fc42aa1f7ba787c7679f9c99057bc24d/packages/jest-runtime/src/index.js#L465 and you might need to look into the jest-resolve package as well.
 Yap, that does sound like it. If I remember correctly, the first implementation of moduleNameMapper was made for the stubs use case (like CSS etc.) which we didn't ever want to be mocked.
 I'm gonna close this as wontfix. Your PR adds a note to the documentation and it doesn't seem like anyone is going to get to working on this any time soon. Of course, I'm always happy to help someone if they want to make a PR to change this.
  This absolutely sucks and happened because we changed everything about Jest around in 13.0. If you are brave, you can install `jest@test` which is currently a test release and should have this fixed ‚Äì it will definitely be resolved in the next version of Jest but because we are making more large scale rewrites right now, I don't know exactly when we'll publish this version as stable.

(Closing because it's fixed on master)
  In Jest we reset the module registry in `beforeEach`. I suggest using `require` inside of `beforeEach` which will reset all modules instead of top-level requires.

Example:

```
let module;
describe('test', () => {
  beforeEach(() => {
    module = require('../module');
  });
  it('tests', () => {
    expect(module).toBe(‚Ä¶);
  });
});
```

This is how in Jest you'll get a fresh copy of all modules without any state for every test.
 I'm hoping that https://github.com/benjamn/reify/blob/master/WHY_NEST_IMPORTS.md will eventually make it into a standard, which will be nice.

At Facebook, we actually use a transform called [`inline-requires`](https://github.com/facebook/fbjs/blob/master/packages/babel-preset-fbjs/plugins/inline-requires.js) and we don't yet use ES modules.

Personally, I don't see a big reason to use ES modules in test files but people want it, so they can use it but there are some drawbacks with the current spec, unfortunately.
  cc @dmitriiabramov

Maybe we should have a short summary only (overall coverage) when using coverage and watch?
 wait... why would you use `--watch` and `--coverage` at the same time? i used to throw an error in this case before, because the coverage will never be accurate
 I have asked this question myself but people seem to want it.
 @tonyxiao i think if there is any valid use for it, we should make it work. But if not, i think it's better to just throw an error and kill the process. Wrong information is worse than no information :)
 Ok, let's do this: instead of erroring, show a message on the top that says "coverage is enabled through the config but not active during `--watch`". People might have `collectCoverage: true` in their config and I don't want the process to throw if that is the case.
 Fixed in #1515 for Jest 15.
 You are right, `--no-coverage` isn't currently supported. If you'd like to add it, please send us a PR! :)  thank you so much @jeffmo :)
  Can you provide a full reproducible test case? Otherwise I'm afraid we will likely not be able to help.
 You can either create a manual mock for that node module or try to disable automock.
  The example is correct. It is up to you to add the correct amount of commas to your package.json. We cannot know what your package.json looks like and if you add the "scripts" section as last item to your package.json, you will not be needing to add a comma. If you add it anywhere in between, you will.
  Jest would print a message if it can't find tests, so this seems like it is crashing for some reason.

Can you try:
- Without --verbose
- With node6

And specify some more info, especially what kind of CI and maybe your Jest config? This is really confusing, as `jest` inside of an npm script and `node_modules/.bin/jest` are exactly the same.
 Is there any way that I can easily try to run this myself? It's a bit hard to troubleshoot this otherwise :( I'm sorry you are running into this trouble, this is definitely confusing.
 Thank you!
 Does this still repro with Jest 14? SlowShip, thanks for creating a repo ‚Äì if this is still a problem with Jest 14, I'll take a look :)
 Oh that sucks! It's probably a really minor thing and I'll try to investigate soon and hopefully publish a point release with a fix :)
 I just found a bug in Jest that makes it so it doesn't find any files if the project itself is located in a temporary folder like /tmp based on what the OS thinks should be a temp folder. I'm working on a fix for that but it will probably land after the weekend. What's the full path of the test run in your examples?

I'm also a bit confused about @ecoleman's comment about invoking Jest directly through `node_modules/.bin/jest` ‚Äì if `npm test` maps to `jest` as it does based on the example in the initial comment, it should be 100 % the same thing.
 @bravely you might be on an older version of Jest if that's the case?

@rimunroe fixed this in #1379 and I'm hoping to tag a new release this week with the fix :)
 @bravely it seems like that is a separate issue. testRegex definitely does work _but_ you are using `testFileExtensions` which we deprecated but still support. If it is present, it will overwrite the `testRegex`. We should probably make it throw if both are provided.
  I'm reopening the React issue, this is not related to Jest.
  Please rebase :)
 Seems like there are some failures on travis?
  There is `coverageIgnorePathPatterns` which you can use to exclude certain scripts from coverage.
 Oh, we might forgot to publish the website recently.
  Thanks for opening an issue. imports in TypeScript work similarly to ES2015 ‚Äì they are hoisted above all other statements. When using babel-jest, we actually hoist `unmock` calls above imports. If you are using TypeScript, we don't have this custom transform available unfortunately.

Here are a few ways to work around this issue:
- Disable automocking completely ("automock": false) in the config.
- Instead of `import`, use `require` inside of your test files.
- Use `babel-jest` in your typescript preprocessor after processing your typescript code into JS. (basically: `return babelJest.process(tsOutput, filename);` ).
- Create a separate module that unmocks specific modules (not recommended).

Of course, the right way to fix this would be a plugin for typescript that hoists `jest.unmock` calls.
 I don't know, does TypeScript have a plugin system like babel does or is the compiler still completely closed?
 @cpojer would it make sense to run `babel-preset-jest` transformation on top of anything that is not `babel-jest`?
this would solve the coverage problem too
 so basically.. if you're using `babel-jest` you get `babel-plugin-jest-hoist` and `babel-plugin-istanbul` for free as a last step in your babel pipeline.
If you're using typescript/coffeescript/whatever, we'll jest run these two as a second transformation step. Performance would suck, but will solve a lot of issues
 It's definitely ok if we go down this route. I wouldn't mind for everything that doesn't use babel already.

At FB, we use our custom preprocessor and we need to make sure we don't double process there ‚Äì what kind of escape-hatch can you think of for this use-case?

To summarize:
- babel-jest should do coverage instrumentation and hoist Jest calls.
- babel-jest will be used to transform coverage even when a different transformer is used.
- when not using babel-jest, but you are not using a custom preprocessor that uses babel, like at FB, don't use babel-jest at all.
  thanks @maximderbin!
  An issue to keep track of all the matchers
- [x] toBeTruthy
- [x] toBeFalsy
- [x] toBe
- [x] toBeUndefined
- [x] toBeDefined
- [x] toBeNull
- [x] toBeNaN
- [x] toBeCloseTo
- [x] toBeGreaterThan
- [x] toBeGreaterThanOrEqual
- [x] toBeLessThan
- [x] toBeLessThanOrEqual
- [x] toContain
- [x] toEqual
- [x] toHaveBeenCalled
- [x] toHaveBeenCalledTimes
- [x] toMatch
- [x] toThrowError
- [x] toThrow
- [x] toHaveBeenCalledWith
- [x] toMatchSnapshot
- [x] lastCalledWith
- [x] toBeCalledWith
 I vote for killing the `toHaveBeenCalled` ones completely.

We have our own matchers that work both with Jest mock fn's and Jasmine spies. Please put all of the matchers from https://github.com/facebook/jest/blob/master/packages/jest-jasmine2/src/index.js#L178 on your list ‚Äì we should move them into the matchers file and out of `jasmine2/src/index.js`. Can't wait to kill off Jasmine's arms.
 @cpojer my plan was to create `jest-jasmine-support` and move all spies, `jasmine.addMatchers` and similar stuff in there, so that projects that are built around jasmine can still run their test suites.
I remember react was relying on spies heavily when i upgraded it to jasmine2. So killing `.toHaveBeenCalled` completely will require either another a day of cleaning up or a smart codemod
 Yep, the solution for this is a codemod. @kentaromiura ran this at FB recently, we just need to open source it and put it into js-transform.
 Just bumped into another case where `toHaveBeenCalled` behaves differently from `toBeCalled` and I forgot `toBeCalled` is the one to use.
 @gaearon https://github.com/facebook/jest/pull/1512 and https://github.com/facebook/jest/pull/1526 will fix this. @maximderbin has been doing good work, we just didn't have enough time to review and polish those yet and didn't want to make 15 depend on it :(
 Nice, thanks!
 I think it wasn't working with jest.fn() for me. Maybe I was doing something wrong. 
 Ah, I think it was toHaveBeenCalledWith(). 
 I've merged @maximderbin's two PRs for these in a local branch and am currently polishing up all the messages.
 Holy shit we are almost done, I cannot believe we actually did this.
 üíú
 the last one is in https://github.com/facebook/jest/pull/1721
thank's everyone who helped! ‚ù§Ô∏è 
  Thanks! Seems like we need to handle this properly in pretty-format.
  I don't believe that `beforeEach` and `afterEach` will work with async/await without us making modifications to it like we do with `it`. I have no problem with doing that though and it should be straightforward to make it happen.

If you'd like to send a pull request (with an integration test! See `integration_tests/promise_it`), here is where you'd look into adding it: https://github.com/facebook/jest/blob/master/packages/jest-jasmine2/src/jasmine-pit.js
  This fixes escaping of strings properly and I added a really nice integration test, @dmitriiabramov should be proud.
  Duplicate of #1253. Sorry about this, we are fixing it right now and will be publishing a new version.

If you force install jest-util@13.1.2 it should work. Something in our publish script didn't update the dependencies properly.
  Can you try to rm -rf node_modules and install 13.2.0 again? There was some confusion with this release but it should work.
 lerna is failing me :(
 Ok, 13.2.2 was published. Totally my fault but James isn't as innocent as he sounds :P
  I don't quite follow. Are you saying that everything that was required through or as a manual mock (`__mocks__`) should persist but everything else should be reset? I think that would be very confusing, especially since those mocks could retain references to modules that were reset, so you'd end up with multiple copies of certain dependencies.
  The correct assertion should be `toBeCalled`. Can you try that?
 Jest resets the module registry on every call to `it`. You are requiring `ApiWrapper` on the top and `Helper` inside beforeEach, so Helper likely receives a different copy of `ApiWrapper`. To fix it you can:
- Import both classes on the top.
- Require both classes in `beforeEach`

Simplified explanation:

``` js
var A = require('A');
jest.resetModuleRegistry();
A !== require('A'); // true, A is not the exact same module as before we reset the registry.
```

Let me know if that doesn't fix your problem.
  Thank you! :)

I'll probably have to update some Relay tests in the next release. Just an early heads-up to @jkassens.
  You have to include `jsx` in the `moduleFileExtensions` config as well:

``` js
"moduleFileExtensions": ["js", "jsx"],
"testRegex": "__tests__/.*.js[x]?$"
```
  This diff:
- uses vm.Script instead of strings for executing code in contexts.
- Removes the unused CoverageCollector class.
- Refactors IstanbulCollector to be more sane.
- Now properly caches files when using `jest --coverage`. We now no longer transform files more than once when they are unchanged and coverage is used.
 To further improve performance I tried to use `vm.Script`'s `cachedData` option that allows to store and read bytecode: https://gist.github.com/cpojer/fea3636b94406f56490716270d61d899

However, it yields no performance benefits that I can identify. I ran Jest twice, once writing the bytecode and once with reading from cache. I then compared this PR with the code in the gist above and ran Jest multiple times. I could not identify a statistically relevant performance difference when using this feature, unfortunately. I thought that parsing and compiling a script would take up a relevant portion of the runtime but it doesn't seem relevant.

It seems like the bytecode cache is about 2-3 times smaller than the source text, which would be a nice win for memory and cache size. However, a `vm.Script` instance requires the original source text as well as the cached bytecode. It seems like we should build a `vm.CachedScript(buffer, options?)` feature into node but overall there seems little value other than memory use. cc @indutny what do you think about that?

See https://github.com/nodejs/node/commit/96934cbb302275400f15675717e81729690446a7 and https://nodejs.org/api/vm.html#vm_class_vm_script for the node.js feature.

The rest of this PR is still relevant, of course.
 cachedDataProduced is false, yes, so everything appears to be working correctly. I only tested on a small size of files, however, which might have something to do with this. What do you think about the chances of adding `vm.CompiledScript` to node? It would take a buffer without the original source code and would leave the validation up to the user (in our case we'd simply check whether the source file has changed or not). I'd be happy to attempt to make a PR.
 I just tested it on a larger number of files (453) and the difference seems to be less than 10ms. Is this expected? Is parsing and compiling so fast these days that everything else just dwarfs it?
 Adding `console.log(script.cachedDataRejected, script.cachedDataProduced);` will tell me that it wasn't rejected (`false`) and that it didn't produce new cache data (`undefined`).

Are you saying this feature is not very useful for many small files but would be more useful for a few big files? Is there anything we can tweak to make this more useful?
  There is no way. The scriptPreprocessor has to be specified through the config.

Please note this is not a help forum and such questions are better asked on stack overflow or on discord.
  You can do `jest --config='{‚Ä¶}'` and provide a JSON object and that should be sufficient for now I believe.
  Please read http://facebook.github.io/jest/docs/timer-mocks.html#content and look at the example code. Timers are mocked so you can advance them more quickly.

Use `jest.useRealTimers()` to use setTimeout directly.
  Thanks!
  I'm not really sure I follow? You can just do

``` js
const module = require('./module');
const Foo = new module();
expect(module.mock.instances[‚Ä¶]).toDoSomething();
```
 You aren't using `new` so it'd be `module.mock.calls`.
  Thank you for your contribution, this is super helpful!

I opened #1233 with an the Flow fixes and added a test to make sure we won't regress :)
  Cleanup doesn't really do much special stuff: https://github.com/rstacruz/jsdom-global/blob/master/index.js#L49

I suggest if you need this, to either:
- Write your own cleanup handler.
- Create a separate test file.

Does this work for you? At this point I'm quite hesitant to adding new APIs to support jsdom better.
  There is literally a link there in the error message with an explanation. Also, what @vvo said.
 I also recommend to just disable automocking for all your tests. Try `"automock": false` in your config. It might be a better default.
 See the moduleNameMapper in the documentation for how to use Jest with webpack.

http://facebook.github.io/jest/docs/tutorial-webpack.html#content
  Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks!
  It turns out that on a full test run at FB, simply requiring testcheck actually slows the test run down by about 20 %. Since I do not expect it to be used throughout the codebase but rather only in a few tests, I decided to change this feature to be optional.

It can now be explicitly required by doing `require('jest-check')`. This new way of installing the module also allows us to get rid of the global config object passing, yay!

cc @davidmccabe
 @davidmccabe are you planning to rewrite it? That would be great. I really believe it would be awesome to ship this for all engineers at FB with a reasonable default perf :)
  measuring coverage for entire codebase might be not a good metric, but sometimes we want to ensure that critical parts of our app are covered.

I was thinking about something like

``` js
/* @jest-coverage-threshold: 90% */

describe('critical piece of the app', () => {
  // ...
});
```

would that be something we can do in jest?
 I believe there is quite a lot of impact to be had if you'd like to work on improving code coverage support in Jest and I'm happy to meet sometime this or next week to chat and also happy to put this on the H2 plan for Jest. Here are a few thoughts about this:

We've had a lot of discussions about this. Generally my team hasn't been excited about this idea so much and there are some concerns:
- The coverage threshold is only going to be complete when we run all of the tests and collect aggregate results from all tests. When running only a single test file, coverage for a file might not be the same as when running multiple tests.
- Apparently this was attempted in the past and people just don't care and lower the thresholds etc.
- Coverage should consistently be high by default instead of having to add an annotation.
- This actually won't affect code coverage at all.

However, there is a lot of stuff that we need to improve on around coverage, which is, besides mocking and matchers, another unloved part of Jest that we could easily fix and make awesome. Some of the bugs that I have on the list:
- We need to merge coverage results per test result instead of at the end to reduce memory consumption in Jest. This is a problem right now.
- Some things aren't properly covered through babel-jest + istanbul together. We could potentially use istanbul only for the reporting and use a babel plugin for gathering coverage. This would however leave behind people that don't use babel but given that this is what we use at Facebook and it would significantly improve our coverage implementation, I'd totally vote for doing it. We could also easily provide both modes (babel plugin when using babel-jest, istanbul when not using babel-jest).
- We also need to improve caching of transformed files when using coverage. We'd get this for free when using a babel plugin to add the collectors.
- `jest -i --coverage` is broken for some reason.

Another solution that I've been thinking about is to run every test twice on a diff (at FB) and compare the coverage percentage and comment on the diff if the threshold is lowered. Instead of running diffs twice, we could also store coverage info in a db, of course. Basically the way I see it is that coverage is an additional tool that helps during review and forcing people to write tests will probably make a lot of people angry. This is why we should the covered lines in phabricator diffs at FB which has been super useful for diff reviews.
 I'm gonna close this out for now as it doesn't seem like we'll be investing in it anytime soon. Feel free to reopen if we choose to do this, though.
  We are working on improving code coverage over the next few months. cc @dmitriiabramov.
 I'm assuming this is fixed now. @dmitriiabramov rewrote Jest's code coverage support. Please try with `jest@test` or `jest@14.2.2-alpha.22bd3c33` to see if this issue still persists. If it does, we'll reopen this issue.
 The current pre-release might have an issue on windows that we'll need to resolve before the final then. Sorry about that.
 Looks like the issue on Windows blames to #1379 (b56e36832d211c626894bff2591e9b152d14ba5b). I created a separate issue to look into it: #1462. Thanks for reporting, @ManuelDeLeon!
  Yes, you can use the `jest-mock` module which is standalone if you'd like but we have no documentation. If you'd like to use it outside of Jest, you'll have to spend a little bit of time with it :)
 Well that's certainly gonna be a lot more work. I'm sorry we don't have the capacity to support other testing frameworks from within Facebook and I hope you'll understand.
  we're working on it right now, so probably in a few weeks that should be implemented
 See #1354. This will be in the next major release of Jest. Woohooo!
 This is now part of the latest Jest pre-release and will be in Jest 15. @dmitriiabramov rewrote Jest's code coverage support. Please try with `jest@test` or `jest@14.2.2-alpha.22bd3c33` to see if this issue still persists. If it does, we'll reopen this issue.

The new option is `collectCoverageFrom` and it takes glob patterns. @dmitriiabramov can you make sure this is part of the API documentation before 15 comes out?
 @jsynowiec do you have an example project that i can look at?
we have an integration test for `.ts` coverage that seems to be working https://github.com/facebook/jest/blob/master/integration_tests/typescript-coverage/package.json

and what does your full config look like?
 @jsynowiec i could reproduce the issue and was able to fix it by removing

```
    "testPathDirs": ["<rootDir>/test"],
```

from the config.

@cpojer if we have `testPathDirs` in `package.json`, hast-map doesn't seem to have any files outised of the `test` directory, is that intentional?
 `testPathDirs` is unfortunately the worst name someone gave to this field ever. It simply means `roots`, ie. that Jest will only look into folders specified in `testPathDirs`. The default is `rootDir`.
 hey @umgupta 
`collectCoverageFrom` accepts a list of globs, and not regular expersions
so in your config instead of 

```
"collectCoverageFrom" : ["app\/.*\\.js"],
```

you should have

```
"collectCoverageFrom" : ["app/**/*.js"],
```

you can find globs documentation here https://github.com/sindresorhus/multimatch
  i added 1 `jest` matcher (`toBe()`) and a very basic diffing algorithm

![screen shot 2016-06-23 at 4 05 58 pm](https://cloud.githubusercontent.com/assets/940133/16323906/8f1d7c20-3963-11e6-8afe-87e6f5fdfbe6.png)
![screen shot 2016-06-23 at 4 52 01 pm](https://cloud.githubusercontent.com/assets/940133/16323907/9266cc10-3963-11e6-8a57-eacdbf70e70f.png)
 Man this is great.

A couple of suggestions:
- Needs @flow everywhere, sorry!
- Can you test the performance with an object would print as ~500 lines with many nested objects where only one or two lines are different? I remember we had some perf issues with these kind of things in the past and I remember @wincent to fix something around this. @wincent do you remember what it was? Ideally of course we'd also add a test for this.
- Can you add toEqual and all the other `diffable matchers` (see JasmineFormatter) as well?

I'm really excited about the potential of killing all the matcher code. That's the last really outdated piece of code in Jest.
 Some more considerations for the output format:
- Should we use `pretty-format` instead of `JSON.stringify`? It'll look much much nicer!
- With your change we'll print both objects and then a diff. Right now we print both objects and diff inline and it seems like both of those approaches aren't ideal. The canonical Facebook test case is `expect(bigResultA).toEqual(bigResultB)` and we need to optimize both for small and big inputs the same.
 Yeah. this was more of a POC PR. If it looks good i'll add flow and other things.
I wanted to start from just `toBe`, because other matchers can become more complex and most likely result in 1000+LOC PR.

`JSON.stringify` needs to be replaced anyways, because it will throw on objects with circular references.

about the diffing of very large objects. I thought about it a lot and the approach i want to take is actually to dynamically traverse the objects and print only relevant info. so an example output would be:

``` js
expect(veryLargeObj1).toEqual(veryLargeObj2);

// - expected + actual
//  {
//    ... // truncate properties that are present and equal in both objects. we don't care about them
// -  a: 1,
// +  a: 2,
//  }
```

This way we don't print too much and print only what we're interested in (what made the test fail)
This should also improve the performance, cause we can just skip the properties if they're `===`
what are your thoughts on that?
 cc @thejameskyle ‚Äì would you mind benchmarking `pretty-format`? It's about to become an integral part of Jest and we should make sure it is optimized to the fullest. Also, should we move pretty-format into the Jest repo as a package? (I vote yes).
 @thejameskyle that's awesome!
is there a way to make it alphabetize object keys? so that we can run a diff algorithm on plain strings
 We already do alphabetize, at least for JSX from a react test renderer.
 @thejameskyle ok i see that it sorts the keys here https://github.com/thejameskyle/pretty-format/blob/master/index.js#L119
the README.md is probably worth updating :)

let me try to integrate it with jest
 This is great. I left a few smaller comments inline.
- Can we kill the bulk of the ugly-ness in JasmineFormatter and formatFailureMessage? All of that code is terrible and it should die. I don't care if that means jasmine1 messages aren't pretty-printed any more as we are killing it and I expect everyone to have updated to it already. I'm ok with removing support for it in 14.0 altogether to help you move faster.
- Why not immediately replace all "diffable matchers"? Seems like your diff handles all the cases already.

Note that we relaxed the restrictions on `toEqual` to not check for undefined keys in either object and we don't compare the constructor name either. We might want to run a huge codemod on www to clean this up OR we can also add `toStrictEqual` to Jest now that we are taking ownership over the matchers. That will probably save us a week of work trying to fix up 1000 test failures at fb.
 updated the PR.

@cpojer i don't think it's the right time to kill all this code yet. There's still a lot of things that rely on it.
I don't want to go into all diffable matchers in this pr because there is a lot of details in them (like symbols, defined/undefined props, class names, etc.). Right now i just want to make sure we're moving the right direction and lay down the infrastructure for future work. 
I ran this PR on www and it seems to we working fine, expect for some jsdom related failures that also appear in master
 ![screen shot 2016-07-05 at 6 33 25 pm](https://cloud.githubusercontent.com/assets/940133/16604928/30d0c610-42df-11e6-801f-ae6cf36ce652.png)
![screen shot 2016-07-05 at 6 34 02 pm](https://cloud.githubusercontent.com/assets/940133/16604931/363f16d8-42df-11e6-9852-c850dc830dfe.png)
 I'm assuming he took the screenshot before publishing his pretty-format PR :D
 @thejameskyle oh dang.. yeah. i had to monkeypatch pretty-format in node modules to make it print `global`. it should be there :)
 See #1257.
  Can you try running Jest with `--no-cache`? Jest currently doesn't recognize changes to .babelrc files and only compiles files again when you change them.

Also, does Jest print `babel-jest`? Can you provide a repository with a config and code that shows this problem? I'm pretty sure this problem lies with you but with limited information there is no way I can troubleshoot this issue properly.
  It would be awesome to have multiple `.jestrc` files in different subdirectories. We could merge separate suites in www into one
 This is now possible since Jest 20: http://facebook.github.io/jest/docs/en/configuration.html#content  We used to have this but it is actually impossible for anything of Facebook scale so we removed it. I recommend doing `jest; jest --watch` if you'd like this behavior.
  I suspect this is fixed in Jest 15 because of the new defaults. See facebook.github.io/jest/blog/2016/09/01/jest-15.html

Let me know if this still persists and we can reopen and troubleshoot.
  Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks!
 Thank you for your contribution @ethemes and sorry for the long wait without a response. We've been pretty busy recently.

The good news is that we are about to launch official experimental react-native support. Please see #1317 for further details and watch out for a blog post sometime this week detailing more things. I'm also working on a tutorial for this new feature :)
 Thank you for your patience. We launched Jest 14.0 with experimental react-native support:
- [Blog Post](http://facebook.github.io/jest/blog/2016/07/27/jest-14.html)
- [React-Native Tutorial](http://facebook.github.io/jest/docs/tutorial-react-native.html)
  I agree! Would you mind sending a pull request for this? This should be in the config and not part of the CLI and should be fairly straightforward to implement. I'd call it `coverageIgnorePaths`.
 This unfortunately has to use regex to stay consistent with the rest of Jest.

Changing Jest to other matching algorithms is part of our plan to rewrite configs, but shouldn't be done in this change :)
 This is going to be in #1233 and will be tagged soon! :)
  Nice work @dhe128!
  Hey @MattFoley,

sorry that I made you wait so long. We made a change to how we detect "@providesModule" to be closer to how we use it at Facebook. You'll need to use a real docblock:

``` js
/**
 * @providesModule Car
 */
```

Note that the first line is `/**` instead of `/*`. Sorry that I'm putting you through the trouble to update all your files but thank you for providing a repro that enabled me to figure this out :)

Also, you can install `jest-repl` now which allows you to have a repl where you can require modules that have `@providesModule` annotations :)
 @ranjitpandit can you provide a repo that shows this problem just like @MattFoley did? That would be very helpful :)
  Yes, see `unmockedPathPatterns`. Please note this is not a help forum. Please read the documentation and API docs carefully and ask questions on stackoverflow. Thank you!
  Could we instead add the linebreaks when we call "serialize"? That way we don't need to remove them later.
  wait, where does eslint resolve node_modules from now? `../node_modules`, what does that even mean?
 I believe they fixed it.
  Yes, see the `testRegex` config option.
 Because that's not a valid regex. Try `(.*)-test.js$`
 you shouldn't specify testDirectoryName when you are using testRegex.
  You should unmock `babel-runtime` and graphql. If you wanna test graphql, there is no point in automocking it.
  we should probably add RN example to https://github.com/facebook/jest/tree/master/examples
I get asked about it a lot
cc @davidbrear
 I'll focus on this next week with the release of Jest 14. We are skipping 13 because we are superstitious. cc @zpao.
 Thank you for your patience. We launched Jest 14.0 with experimental react-native support:
- [Blog Post](http://facebook.github.io/jest/blog/2016/07/27/jest-14.html)
- [React-Native Tutorial](http://facebook.github.io/jest/docs/tutorial-react-native.html)

Please feel free to create new issues after trying out the new integration if any issues remain. 
  I'm a bit worried about performance when making this the default. I don't know how much different this is from `resolve` itself and how compliant it is. We have tons of code at FB depend on the way we resolve modules now.

We could theoretically add the option and have it off by default. When turned on, we could use browser-resolve.
 Right, "relatively" compliant isn't great, and I'm not sure how this as a default would impact current Jest users. Also, we are really focused on not regressing performance and browser-resolve seems to be doing more work than resolve.

If you make it optional based on a `browser: boolean` field and add a test for it, I'm happy to merge this, however.
 You have to add it to jest-config everywhere and then pass it along where Resolver.create is called.
 We just started using Flow (flowtype.org) to Jest, and it seems like its a bit complaining :)

Can we also add a test that ensures we are calling browser resolve if the option is specified?
 I think it should work if you add a test to `jest-runtime`. There is a `test_root` folder in there with some fixtures. We haven't written any tests for `jest-resolve` because jest itself and `jest-runtime` serve as a 100 % integration test for `jest-resolve` #yolo.
 Yeah, there is a node_modules folder here: https://github.com/facebook/jest/tree/master/packages/jest-runtime/src/__tests__/test_root you can add a package.json there.
  Thank you!
  I recommend using `W:\path_to_libs` directly instead of `<rootDir>` in this case.

I think it is probably ok to send a PR that will remove the slash when it is a drive, but that should happen earlier where "rootDir" is being set if its on Windows.
 closing due to inactivity. Feel free to send a PR that fixes this issue! :)
  woah this is cool!

cc @gillesruppert ‚Äì we need to bring this to www too :) Does growl somehow work across ssh sessions?
 Does growl support images at 2x for retina displays? If so, can you add a file that is 2x as big? Most Mac users nowadays use a retina display, so it should be the default :)

I'm also sorry for our silly abc style guide. I wonder if there is a lint rule for this.
 Does growl resize the image to a set size? If yes, we could just ship the 2x image and let growl take care of it?

On Wed, Jun 15, 2016 at 4:01 PM -0700, "Marcel Erz" <notifications@github.com<mailto:notifications@github.com>> wrote:

I will update the code with the abc rule.
For Growl, I can only give one image. Do you know of a way to figure out if the machine has a retina display - from node?

## 

You are receiving this because you commented.
Reply to this email directly, view it on GitHubhttps://github.com/facebook/jest/pull/1170#issuecomment-226344918, or mute the threadhttps://github.com/notifications/unsubscribe/AAA0KPEFdoC9J7aSh_6C-ThVzi53EJRuks5qMIQ0gaJpZM4I22ra.
 "Notifier" as a class name is good :)
  See #1169.
  Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks!
  This is really good actually! Nice work @flarnie!
  See #1151
  See #1150.
  Probably have to rebase this past https://github.com/facebook/jest/pull/1140 where I added the trailing comma transform + add some more trailing commas.

Thanks for doing this! :)
  See #1158
  Duplicate of #1121.

As a workaround, you can wrap your `it` calls with `describe`.
  cc @marcelerz
 @facebook-github-bot import
  @facebook-github-bot shipit
  @facebook-github-bot shipit
 thank you!
 @facebook-github-bot shipit
  I think it would be really awesome to write a jest server that can execute tests for specific files and gather json information about the tests and send it to nuclide whenever we save a `-test.js` file.

We can add warning/notifications similar to what flowtype/eslint do.

It would be super awesome for TDDing.

![screen shot 2016-06-10 at 2 37 02 pm](https://cloud.githubusercontent.com/assets/940133/15979437/d87335e0-2f18-11e6-8ccd-965f16a4e735.png)
![screen shot 2016-06-10 at 2 36 53 pm](https://cloud.githubusercontent.com/assets/940133/15979440/da903332-2f18-11e6-9745-5320b491d464.png)

cc: @gillesruppert

for real though... that would be a killer feature :) unless it takes a minute to run the test suite
 @gillesruppert we were planning one hackathon this tuesday :)
 We now have a notification via `--notify` and I'll be working on more performance work. I'm also hoping that the Nuclide team put the test runner onto their list of things to work on for next half. cc @zertosh
  right now whenever something is printed from within a test it's pretty random and breaks the output (esp if you're using json output format)

I think it'd be cool to wrap `console.*` methods and format the output. eg.

``` js
it('...', => {
  console.log('1234566');
  console.warn('111');
  console.error('222');
});
```

```
[log: myTest.js] 12334566
[warn: myTest.js] 111
[error: myTest.js] 222
```
 #1435 

done. 
 ```
console.log = jest.fn();
```

and then treat it like any other mock.  Test against jest visible output.
This is to check that the correct information is given to the user when updating/removing or adding snapshots.
 @facebook-github-bot shipit
 @facebook-github-bot shipit
  I'm gonna assume this is not a problem with Jest 15 any more where automocking is disabled by default? See facebook.github.io/jest/blog/2016/09/01/jest-15.html
 I guess it is a bug but I don't think it is trivial to fix. I'd recommend just manually unmocking transitive deps in the manual mock instead.
 could also try to call `deepUnmock` for those transitive deps.
 Sorry, I mean deepUnmock from within your manual mock. I think it makes sense to either turn off automocking (the new default in Jest) or to call deepUnmock of any deps that you are pulling in in your manual mock ‚Äì I think this makes sense as this is what you'd do in tests as well.

The problem here is that we can only unmock transitive dependencies if we actually descend into a node module. We aren't doing that here, so you need to unmock at a different layer.
 Yeah, manual mocks are currently a mess and there is no resolution algorithm associated with them. I'm hoping to make them much stricter eventually.
 I'm gonna close this for now as Jest by default ships without automocking and it isn't likely we'll get to fix this anytime soon, unfortunately.
  Test packed and ready to be published npm packages in real world environment.

This test will catch bugs related to publishing packages, eg:
- package is installed locally, but not included in `package.json`
- package files are not published because they're in `.npmignore`
- or `.gitignore`
- or not added to `files` property in 'package.json'

How it works:
1. Pack all `packages/*` using `npm pack`
2. Install all created tarballs as packages into a `TMP/node_modules` dir
3. Run integration test suite using the installed packages.

depends on https://github.com/facebook/jest/pull/1113
 it'll fail now because `jest-snapshot` is not on npm yet
 @facebook-github-bot shipit
  Duplicate of #1114
  You have `express` in your project name and in `unmockedModulePathPatterns`: https://github.com/danielstern/express-rest-api/blob/5fc40fa7e709ddb960f1f8ab503f44f82e1903a2/package.json#L25 because every pattern is matched against the full path of a file, and express is part of the path, automocking is basically disabled.

I recommend changing your unmockedModulePathPatterns to `node_modules/express/`.
  It only strips out flow types and puts all .js files into `/build/*` directory

also moved stuff around in the root directory. All build/test/setup related files now are in `./scripts/*`

<img width="605" alt="screen shot 2016-06-03 at 8 18 05 pm" src="https://cloud.githubusercontent.com/assets/940133/15797324/79d4d8c2-29c8-11e6-8910-746bb6e5b92c.png">
 @facebook-github-bot shipit
  I just thought of a new approach: Instead of throwing an error and letting a try-catch on a higher level take care of this, can we instead directly call `onRunFailure` which is defined right below? That is basically what it ends up doing without going back up to the promise and handling the error there. I feel like that is more explicit.
 Nice! I'm only gonna merge this after we have made the necessary cleanups on www, though :)
 Created #1217. Thanks Kent!
  It seems like you aren't properly using `jest.mock`. The error clearly says the second argument must be a function:

I recommend this:

``` js
jest.unmock('fetch-mock');
jest.mock('fetch', () => require('fetch-mock'));
```

or a manual mock:

``` js
// __mocks__/fetch.js
jest.unmock('fetch-mock');
module.exports = require('fetch-mock');
```
 Your code has a syntax error and it doesn't make much sense. Don't import fetch-mock, just do

jest.mock('fetch', () => require('fetch-mock'));
  A test framework should not depend on network connections. If you want this to be supported, I recommend creating a setupFile that loads your remote file but this is almost never a good idea. I recommend just storing loader and loading it directly.
  thanks for working on this! I left a couple of small comments before I can ship this :)
 Also please run `npm run lint`.
 yeah, just the indentation is a bit off in the package.json. It is supposed to be 4 spaces :)
 Das ist auch ok, I can take a look tomorrow too. The ansi-regex module doesn't play well with automocking, might want to just unmock chalk.
 @facebook-github-bot import
 @facebook-github-bot shipit
 @cdreier thanks for your contribution. I'll publish a new version of jest-haste-map (but not the rest of Jest) because I'll be out next week and can't support everyone if they are having issues :)
  Man this is amazing, you are doing fantastic work.
 @facebook-github-bot shipit
  Uh oh, this is not good. Did you try master or is this a fresh install of Jest?
 Also, can you show me your config? :)
 I wonder if the problem is windows? This problem hasn't come up at FB where we are using this exact code.
 oh, dammit, it isn't escaped properly on Windows and we are using `path.sep` here. We have a utility function here: https://github.com/facebook/jest/blob/master/packages/jest-util/src/index.js#L25 that we could inline in jest-haste-map. Would you like to send a PR for this?
  @facebook-github-bot shipit
  thanks!
 @facebook-github-bot shipit
 No it's fine, we just forgot to update the README the last time :)
  @facebook-github-bot shipit
 Thanks for importing. If you are an FB employee go to [Phabricator](https://our.intern.facebook.com/intern/opensource/github/pull_request/517146515140480/int_phab) to review.
  This most definitely isn't a Jest issue and questions are better asked on Stackoverflow. The piece of code you pasted definitely works if you put it into a test.

I'm assuming you have automocking on and setKey is coming from a different module. If automocking confuses you, I recommend turning it off: add `"automock": false` in the "jest" object in your package.json.
  `accessSync` will return true for directories, which we do not want.

Right now, when in the integration test folder, running `jest snapshot` will not find any tests while `jest snapshot.js` will work. This is because there is a snapshot folder, `accessSync` will return true and Jest tries to run the directory as a test file.
 @facebook-github-bot import
 Thanks for importing. If you are an FB employee go to [Phabricator](https://our.intern.facebook.com/intern/opensource/github/pull_request/1707785559487069/int_phab) to review.
 @facebook-github-bot import
 @facebook-github-bot import
  Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!
 @facebook-github-bot shipit
 Thank you for the contribution! This is great :)
 This was all created by @dmitriiabramov and @kentaromiura :) We now have a neat integration test runner for Jest!
  This refactors the snapshot serialization a little bit:
- Use @thejameskyle's pretty-format plugin to pretty-print objects (see screenshot below). We now allow any value to be used with `toMatchSnapshot`. We can add other serializers (for react output, for example), later.
- Add a dirty flag to only attempt to save a file if `toMatchSnapshot` was called and a snapshot was changed.
- Move some things around in getMatchers, because there was an inline require there.

![Imgur](http://i.imgur.com/d2TKgYq.png)
 @facebook-github-bot import
 @facebook-github-bot import
  thank you!
 @facebook-github-bot shipit
  Snapshots get cleaned in this way:
- Everytime a test has at least one `toMatchSnapshot`:
  we keep track of which snapshots didn't run, we delete those in `save`
- If a test file exists but there's no `toMatchSnapshot`:
  same logic as above, plus `save` will now tell if a snapshot existed
  previously so that we can add it to the summary
- if the test file no longer exists:
  we use the hastemap at the end of the run to check if all the
  snapshots have an associated test file, we then delete the orphan one.
 I left a bunch of comments regarding code style, variable naming and maintenance concerns. Overall your solution looks good and those are just minor comments.

One high-level comment: I believe that we should consider the update flag for validation: all validations should make the test file _throw_, even if it was deleted (we'll just produce a "fake" result entry). It should then highlight in the summary that snapshots aren't valid any more and have to be cleaned up, and `jest -u` should be used to do that. What do you think?
 @facebook-github-bot import
 @facebook-github-bot shipit
  Before this change the updateSnapshot flag was just rewriting all the
snapshot, now it just updates those that are not equals providing
better information in the summary
 <img width="831" alt="screen shot 2016-06-01 at 3 01 17 pm" src="https://cloud.githubusercontent.com/assets/87300/15712315/c8948482-2809-11e6-941b-009c385861fc.png">
 I think this is still misleading. It should say `1 snapshot updated` instead of saying that it added or removed a snapshot. Also, with this change the snapshot count on the bottom seems to be wrong.
 I'll change that to just say updated then, also I accidentally forgot to update the count when it matches, this means I should add an end to end to cover that
 After the latest changes:
<img width="641" alt="screen shot 2016-06-02 at 2 43 43 pm" src="https://cloud.githubusercontent.com/assets/87300/15746948/789b69ec-28d0-11e6-9afb-8cac3c37392c.png">
 FIY: Looks like there's a little bug in the jest/chai diff printer (`formatMatchFailure`) that doesn't reset the background when there's a newline, this is not related to this change.
 @facebook-github-bot import
 @facebook-github-bot shipit
  @Volune would you like to send a pull request with a proper default that works both on windows, linux and mac os? If that is not possible, we could detect whether the user is on a windows machine and set a different default.
 Should be fixed by #1189.
  Can we instead rename the `tutorial` folder to `jquery` :)
  Why are you importing `process`? `process` is available as a global in node.

Your problem is probably fixed by doing `jest.unmock('process')` or just by removing the import statement.
  (Also, tabs, wtf?)
 @facebook-github-bot shipit
  Thanks! I was unaware this was a public API. cc @dmitriiabramov 
 @facebook-github-bot shipit
  I agree we should have this feature and it is on my list. @giantelk do you want to send a pull request? If there are no assertions (and no runtime errors) in a test file, we should throw. As @StephanBijzitter says it should probably be configurable as either ignore or error (I don't think having three states is that useful). Would you like to work on a Pull Request for this?
 We have someone at FB working on this, so I'll close the task here for now so that no one is going to do any duplicate work. Expect a PR that will get merged soon.
  For posterity: Node 6 has a stricter path module and we updated Jest to work with Node 6 in 12.0.1.
  @facebook-github-bot shipit
 thank you!
  @keyanzhang seems reasonable to me, if this is possible. Do you want to send a pull request for this? :)
 The cli parts are somewhere around here: https://github.com/facebook/jest/tree/master/packages/jest-cli/src ‚Äì I'm also next to you physically right now in case you wanna ask me ;)
 @chrisvariety no! Instead we recommend upgrading to node 6 which has proxies on by default.
  Thanks for your contribution! Unfortunately I don't believe that regex replacements are safe for JavaScript code and I wouldn't want to recommend this as an official solution. If however you process the returned JavaScript's AST, insert comments and then re-print it to JavaScript, I'd be happy to merge that.

The proper fix for this however should be to ask the TypeScript developers to implement this feature into their compiler.

If you'd like to put this preprocessor in its own npm package that people can use, I'm ok with that too but I won't be merging this exact solution into our sample code :) I hope you understand.
  This looks fantastic! I also like how you refactored the code. One big plan I had for TestRunner is to be lightweight. I wanted to remove all the matching functions from TestRunner completely and change the API to this:

`new TestRunner(testPaths, config[, options]);`

To create the list of testPaths, my idea was to create a class `SearchSource` that would take on all the functions that TestRunner has right now and maybe also some of the stuff you put into `src/jest.js`.

It would work like this:

``` js
// in a promise chain:
.then(() => {
  var source = new SearchSource(config);
  return source.testsMatching(pattern);
})
.then(testPaths => {
  const runner = new TestRunner(testPaths, config, options);
  // run the tests
});
```

given that you are changing so much about how we match patterns, would you like to make this change in this PR as well? I think it would be really awesome to have this separation. My end goal is to have one TestRunner that can take multiple paths from different search sources ‚Äì but that is going to happen in a separate diff :)
 @facebook-github-bot import
 @facebook-github-bot import
 This refactor is really impressive and helps me so much with Jest. I'm making a couple of small modifications before shipping this, plus I have to update our internal runner.
- I changed `buildHasteMap`'s second argument to accept an object instead of a scalar.
- I changed `promiseTestPathsRelatedTo` to `findRelatedTests` ‚Äì this has been on my mind for a long time and I'm happy to finally rename this :D
- Updated some small nits.
  @facebook-github-bot import
 @facebook-github-bot shipit
  I'm assuming this is fixed now. @dmitriiabramov rewrote Jest's code coverage support. Please try with `jest@test` or `jest@14.2.2-alpha.22bd3c33` to see if this issue still persists. If it does, we'll reopen this issue.
  Thanks @mateuszsokola for helping out on issues! :)

@luizribeiro can you paste your config and your file system structure? It's possible that the default regex in `testRegex` might do something wonky on OS X :)
 You could try patching #1057 and see if they are found at all and what filters them out :)
 This is fixed in the latest test release (can be installed through `jest@test`) and will be fixed in the next release, Jest 15.
  I'm gonna close this for now to manage the PR queue. Will reconsider and potentially re-open later if we want to ship this at FB.
  Yeah it is probably what @mateuszsokola said. Let me know if this is still an issue and I'll reopen :)
  @facebook-github-bot import
 that's fantastic. Thank you!
 @facebook-github-bot shipit
 Thanks for importing. If you are an FB employee go to [Phabricator](https://our.intern.facebook.com/intern/opensource/github/pull_request/1771421566407012/int_phab) to review.
  How to test the following:

```
// File: index.js

export function myName(text) {
    return 'My name is: ' + text;
}

export function makeBold(text) {
    return '<strong>' + myName(text) + '</strong>';
}
```

With the following test:

```
// File: __tests__/foo.test.js

jest.unmock('../index');

import { makeBold, myName } from '../index';

describe('bar()', () => {

  it('calls myName', () => {
    myName = jest.fn();
    makeBold('Text');
    expect(myName).toBeCalled();
  });

});
```

The above would throw similar to:

`... myName is read-only ...`
 Jest mocks things on the module boundary, which is the boundary at which you should test your "units" (= modules). With JavaScript, there is no way to swap out references to something.

Consider this example:

``` js
// a.js
exports.a = 42;

// b.js
var b = require('./a').a;
b = 14;
console.log(require('./a').a); // still 42
```

this is a simple example similar to your code that should point out the problem you are having. You cannot swap out a function that is internal to a module. When you try to overwrite `myName` with `jest.fn()` in your example, you are just modifying the local binding `myName` in your test but it has no effect on the `myName` binding in your other file. This unfortunately becomes more of a problem with ES2015 modules where it is less obvious. The right solution here is to split up `myName` and `makeBold` into two separate modules and mock `myName`. Generally, there is little value in writing a test like the one you are writing here: you should test that `makeBold` _behaves_  as expected, not that its internal implementation relies on any particular implementation details.

One way however to do what you are trying to do is to drop down to CommonJS (which babel compiles to, anyway):

``` js
// module.js
exports.foo = function() {};
exports.bar = function() { exports.foo(); }

// test.js
const module = require('./module');
module.foo = jest.fn();
module.bar();
expect(module.foo).toBeCalled();
```

This works because the `bar` function calls `foo` with a binding that can be modified ‚Äì `exports.foo` is just a field on an object that can freely be modified.

I hope this explanation makes sense and I provided enough guidance so that you can write a good test. Please note that this is mostly a limitation of ES2015 (modules) and we can't really do much about this. Also, this is a bug tracker that we use to prioritize work. It's not well-suited for questions. In the future, please ask questions on StackOverflow.
 > you should test that makeBold behaves as expected, not that its internal implementation relies on any particular implementation details.

So true, thats basically  what we did in the end.

Apologies for logging an issue, I understand such"questions"  are not suited for an issue tracker. Although at times its hard to differ the two.
 That's alright! Now we have this documented somewhere, so that's good for the next person who runs into this :)
  Adding an handy summary for snapshots after a test run
Here's two test run, the first one matches all the snapshots, the second one overwrites everything:

![screen shot 2016-05-25 at 6 35 52 pm](https://cloud.githubusercontent.com/assets/87300/15550149/fc28817a-22a7-11e6-95fe-97d499a0050e.png)
 Are you going to send out a diff separately to add `x snapshots` to the result line where it says "2 tests passed" etc.
 This looks good! Just a few minor comments but I really like how clean this is. Nice work.

Can we use `\u203A` instead of `*`? It's what we also used for failed tests (it's a fancy version of `>`).
 After applying your suggestions I made a run, now this is the result (with two bgColor to compare):
![screen shot 2016-05-26 at 2 59 25 pm](https://cloud.githubusercontent.com/assets/87300/15577091/eb78eac6-2352-11e6-90ca-65cf3a6f5219.png)
![screen shot 2016-05-26 at 3 00 09 pm](https://cloud.githubusercontent.com/assets/87300/15577092/ed7ae770-2352-11e6-8f78-818776efbc2f.png)

and when it matches:

![screen shot 2016-05-26 at 3 03 55 pm](https://cloud.githubusercontent.com/assets/87300/15577147/207380c4-2353-11e6-924e-30342fae6d40.png)
![screen shot 2016-05-26 at 3 03 39 pm](https://cloud.githubusercontent.com/assets/87300/15577151/2233f312-2353-11e6-96ee-33e328ef4101.png)

It looks clean to me and not too clowny
 @facebook-github-bot shipit
  @facebook-github-bot shipit
  @facebook-github-bot shipit
 Thanks Joe! Unfortunately I don't think including the `<rootDir>` in the defaults is of much value for things like `preprocessorIgnorePathPatterns` because people might have nested node_modules that they'll want to include. That makes the pattern a bit more confusing to write. We are thinking of providing a simpler config with less regex stuff.
  This is what the moduleNameMapper config option is for: see http://facebook.github.io/jest/docs/api.html#modulenamemapper-object-string-string and https://github.com/facebook/react-native/blob/master/package.json#L16
  Same images, now with retina-friendly SVGs :)

Had to add a few lines of CSS to ensure that the images are properly
sized inside their respective containers.
 @facebook-github-bot shipit
 yay sharp images!
  Prevent `toMatchSnapshot` from being used with `.not` as it doesn't make sense:

Here' s an example where I force triggered the error (it's not in the code of this PR):
<img width="601" alt="screen shot 2016-05-25 at 10 44 42 am" src="https://cloud.githubusercontent.com/assets/87300/15535633/19138fd8-2266-11e6-8ef7-63997d8270b9.png">
 @facebook-github-bot import
 negativeCompare, nice find!
 @facebook-github-bot shipit
   I think the previous version had overflow-scrolling for iOS ‚Äì is this important here as well, given that this fixes an issue with mobile rendering?
 You're right, adding that back too - for context, it allows for "kinetic" touch scrolling on Webkit browsers, rather than the "stuck in the mud" style touch scrolling :)
 @facebook-github-bot shipit
  ‚Ä¶ option.
 @facebook-github-bot shipit
  @bypass-lint
 @facebook-github-bot shipit
  @facebook-github-bot shipit
 thank you!
  @ColCh would you like to send a PR? The check for mocks needs to be added here: https://github.com/facebook/jest/blob/101cda7511109408891e6f87773f61a2d008e213/packages/jest-cli/src/Runtime/Runtime.js#L234 the config field is `mocksPattern`.
 @ColCh we already have an integration test for coverage. You could add a manual mock there, load it in the test and make sure it isn't part of the coverage output.

@mateuszsokola yeah, we should completely change collectCoverageOnlyFrom, I agree. I think we should also only turn on coverage after we run the setup files, need to think about this a bit :)
 Thanks @ColCh! This will be fixed in the next release.
   @facebook-github-bot shipit
 thank you for the contributions!
  @facebook-github-bot import
 Thanks for importing. If you are an FB employee go to [Phabricator](https://our.intern.facebook.com/intern/opensource/github/pull_request/1599822750307880/int_phab) to review.
 Thanks! I wasn't aware of this error code.
 @facebook-github-bot shipit
  Please check this out to view it properly, I know it's a huge pull request, so the best way to review will probably be to actually test it in action.

@bypass-lint
 @facebook-github-bot shipit
 This is fantastic, thank you so much Matthew.

I'm gonna land this and make a few tiny tweaks before publishing.
  We are thinking of adding a recursive option to `unmock`, but yes, this is intentional at the moment. We'll probably add something like `deepUnmock` or `jest.unmock('Foo', {transitive: true})`.
 No ETA but the feature already exists in Runtime.js for node modules. If you'd like to send a PR, I'd be happy to help you through it ‚Äì it should be fairly easy :)
 Feel free to message me on Facebook: fb.me/cpojer
 Suffering the same issue. Look forward to this PR.

Im beginning to feel after a month of Jesting we are always struggling with mocks / auto-mocks more often then we ever. Never seemed to have mocking issues on competing libraries: mocha / ava. 

maybe its our approach :-(
 btw. this is mostly a React issue, as it has special cases for React classes but not functional components.  See https://github.com/facebook/react/issues/6932
 @andrewmclagan auto-mocking might not be right for you then. I recommend turning it off using `"automock": false` in the configuration.
 We are disabling automocking in Jest 15 and I think we aren't going to change React to adapt to this, so I'm closing this issue. Jest 15 will be released sometime this week :)
  When passing no arguments and the configuration is wrongly set up (like `testPathIgnorePatterns`) or a wrong pattern is passed, we show a "No tests found" message in Jest. This has lead to a lot of confusion. For example, one path pattern that is ignored might be "/build/". On CI, a repo can be run in a folder /tmp/build/my-repo/src and every test path will be filtered out entirely and people don't know what's going on.

Here are a couple of ways to mitigate this:
- If no pattern is passed and no tests were found (ie. simple invocation of `jest`), exit with a status code of 1.
- When no tests are found, regardless of the passed in pattern, show the amount of tests available and how they were filtered. For example:

```
"No tests found. 1700 tests available.
testRegex: ‚Ä¶
testPathIgnorePattern: ‚Ä¶ 
```

(see https://github.com/facebook/jest/blob/17c04e1583b95f4f66fda64e1f4e5e72a61f9f64/packages/jest-cli/src/TestRunner.js#L76-L82 for how we filter tests).

Also make sure this doesn't get printed during `jest --watch`, it doesn't seem to be so useful there.

cc @valerybugakov ‚Äì would you like to take this on? Integration tests would certainly be useful here.
cc @lencioni @trotzig 
 I'm gonna close this, continue on #1084.
  @facebook-github-bot shipit
 thank you!
  Yep. I'll publish a new version today.
  This'll be fixed in a release tomorrow. For now please stick with 12.0.2.
  This warning really doesn't matter. `cover` simply has `preferGlobal` set to true in `package.json`. If you'd like it to go away, I recommend sending a PR to https://github.com/itay/node-cover in which you remove this line.
  I don't think it makes sense to exclude them. They are code, not tests.

tbh I don't quite understand why people want to exclude tests from coverage in the first place, but it seems to be a pretty big deal to some. Every test file should have 100 % coverage and if not, that's a good signal that something in a test file isn't being executed properly. But oh well, I do what the majority demands :)
  See my explanation here: https://github.com/facebook/jest/pull/1044#issuecomment-221147691 ‚Äì we are relying on the community for these things. Please stick with 12.0.2 until tomorrow when I tag 12.1.1. :)
 yeah we should fix this. Do you care to send a pull request? :)
  @facebook-github-bot shipit
 thanks! This makes sense to me.
  @facebook-github-bot shipit
 seems reasonable! Thank you for the fix, this is great.
  argh, I'm confident the problem here is that eslint depends on some other undocument module APIs that I haven't added to Jest (because they are undocumented). I'll try to figure out where exactly this is coming from.
 This looks like a JSDOM bug. I noticed that the filenames from modules run in the vm are missing and this is likely because of jsdom's eval which doesn't allow to set the filename properly. I filed a bug in the jsdom issue tracker: https://github.com/tmpvar/jsdom/issues/1509

Workaround: if you are not using doing any DOM tests, you can switch to the node environment:

In your config:

``` js
  "jest": {
    "testEnvironment": "node"
  },
```

The nice thing about this is that it will also speed up the startup time of Jest by 500ms, making your test suites way faster ;) If you have DOM tests and code tests for things like eslint, I recommend making two separate Jest configs for both. We are also working on a multi-runner so tying them together in CI will be easy. I'm also happy to accept a PR that will allow to set the environment on a per-test basis like:

``` js
/**
 * @jest-environment node
 */
```

I'll close this task and will track the bug in jsdom and make and changes to Jest if necessary. Sorry that I can't resolve this right away.
  I'm gonna close this task in favor of #1057 which has some actionable things to do to fix this. As discussed on your project, please do submit a documentation fix for this :)
  @facebook-github-bot import
 @facebook-github-bot shipit
 @facebook-github-bot shipit
  Thanks for the pull request. Please sign our CLA.

Why not use the jest-util function there directly? :)
 @facebook-github-bot shipit
 Unfortunately we aren't using Windows to develop or run Jest and it is something we completely rely on the community to provide. My hope is that by the end of this year, bash for windows will work really well for node applications and we can actively remove windows support. For now, I'm happy that you guys are sending PRs and hope that the pain isn't too bad ‚Äì it might make sense to skip the first version of a major or minor release :)

cc @dmitriiabramov who is thinking about revamping configs in Jest and we might potentially adopt something like globs.
 > if only we could have windows on our CI servers :)

We can set up something like AppVeyor to build on Windows. :smile: 
  @facebook-github-bot import
 Thanks for importing. If you are an FB employee go to [Phabricator](https://our.intern.facebook.com/intern/opensource/github/pull_request/1718381585047862/int_phab) to review.
  switching to yargs seems fine so I'll close this PR and merge the other one after switching the error to a warning.
  thank you so much for doing this!
 @facebook-github-bot shipit
 It's out now.
  Yeah actually this looks pretty good. I'll take a look sometime next week and test the performance of this approach ‚Äì all of this is super hot code and we need to make sure we aren't regressing anything :) Thank you so much for the PR!
 @facebook-github-bot import
 @facebook-github-bot shipit
  Fixes #1038 
 @facebook-github-bot shipit
 Thanks for importing. If you are an FB employee go to [Phabricator](https://our.intern.facebook.com/intern/opensource/github/pull_request/1707511969521758/int_phab) to review.
 I was hoping to soon refactor the TestRunner code and pull isTestFilePath out of it and then use it in Runtime. isTestFilePath is covered well.
  yay new bugs! :) It's likely the fact that we use this config option here: https://github.com/facebook/jest/blob/master/packages/jest-cli/src/Runtime/Runtime.js#L235 unfortunately. It should use `testRegex` instead ‚Äì would you like to send a PR?
 Will be fixed in the next release.
   @facebook-github-bot shipit
   @facebook-github-bot shipit
   @facebook-github-bot shipit
  @facebook-github-bot import
 Nice work! You had a small typo in your test (`subDir` instead of `subdir`) but other than that it looks really really good. Thanks so much for sending this PR!
 @facebook-github-bot shipit
  Before:
<img width="526" alt="screen shot 2016-05-19 at 2 46 38 pm" src="https://cloud.githubusercontent.com/assets/87300/15395686/af7fae6a-1dd0-11e6-9de5-c4ff55cc08a2.png">
After:
<img width="379" alt="screen shot 2016-05-19 at 2 47 06 pm" src="https://cloud.githubusercontent.com/assets/87300/15395685/af7d8b3a-1dd0-11e6-9cd2-d87813c6b896.png">
 @facebook-github-bot shipit
  Hey!

Actually this is not correct. At the moment, mocks can be anywhere. This is unfortunate but we rely heavily on this at Facebook. I'm hoping to fix this in Jest in the future.

Thank you for your contribution ‚Äì it will make sense in the future and I might go back to it and merge it when we have fixed it in Jest :) I'll close it for now.
  If you are using react-native you can use `@providesModule` in your module files to make them global. Since we use this at Facebook I recommend you to use this too, with the following structure:

src
node_modules

in src, all your files should have something like this on the top:

``` js
/**
 * @providesModule MyLibrary
 */
```

and then you can do:

``` js
const MyLibrary = require('MyLibrary');
```

that should work. I'm confident there is an easy way to make your current setup work with Jest but you'll have to play around with the configs a bit. You definitely need to set `testPathIgnorePatterns` to an empty array `[]` and make sure testPathDirs is empty (so it matches the rootDir).

We are also planning to rewrite configs for the future so that this is hopefully not a big issue any more. I hope the workarounds are satisfying.
 Oh, we are also adding `modulePaths` and `moduleDirectories` to the next version of Jest, see #1033.
  @facebook-github-bot shipit
  @facebook-github-bot import
 Are you trolling me? You mentioned coffeescript in a code comment in a project I work on? What!?
  @facebook-github-bot shipit
  @facebook-github-bot shipit
 Thanks for importing. If you are an FB employee go to [Phabricator](https://our.intern.facebook.com/intern/opensource/github/pull_request/221399088245107/int_phab) to review.
  This is probably not a Jest bug and something isn't unmocked properly. Try `"automock": false` in your config and mock components using `jest.mock('path/to/module')` as needed.

Also, for questions like this please provide a repository with a config, code and tests that we can use to troubleshoot the issue.

I'm happy to reopen if this turns out to be a Jest bug. Feel free to continue commenting.
   @facebook-github-bot shipit
 I should explain why this change was necessary:

`HGPLAIN=1 hg status` works on www and works in open source mercurial. However, it doesn't work on Facebook laptops because they require the rest of the env variables to be available, otherwise the test will throw and this feature won't work. I changed it so HGPLAIN is added to all env variables that are available.

I also added an error handler, which should be common sense but I think we didn't have one there because the code would never be called if hg (or git) was not available based on the previous call. Anyway, error handlers are good for you. Use them!
  Add `testRegex` instead of `testDirectoryName`. Should be backwards compatible.
 @facebook-github-bot import
 @facebook-github-bot import
 @facebook-github-bot import
  nope. There is `--testEnvData` or something however that you can pass in and then toggle behavior based on it.
  Where is the config module? It should be `./config` I'll assume?
 We'll be adding support for `modulesDirectories` soon and then I guess this will work. See #963 for progress. Should happen within the next week or so?

For now, you can also do

``` js
moduleNameMapper: {
  '^config$': '<rootDir>/path/to/App/config.js'
}
```
 @ankitrg into your configuration file/object, for example in your `package.json`:
```js
"jest": {
  "moduleNameMapper": {
    "^config$": "<rootDir>/path/to/App/config.js"
  }
}
``` @ankitrg Yup. But I think Stack Overflow is the best place to ask such kind of questions :)   @facebook-github-bot shipit
  See #1018
 @facebook-github-bot shipit
  You are right! Somehow we forgot to update it. I published a new version of the website. You are right, we added `jest.fn` which can also take a mock implementation, like `jest.fn(() => 42)`.

See #1019.

The changelog can be found here: https://github.com/facebook/jest/blob/master/CHANGELOG.md
  Jest runs tests in an isolated context. I wonder if the failure is because we are running code using `vm.runInContext`? Not sure what we can do here :( What exactly are you trying to test? Whether creating an image works?
 I don't think Canvas.Image is a drop-in replacement for jsdom's (or the DOM's) Image constructor, is it?
 @Sebmaster do you have any experience with this and how it relates to jsdom?
 Sounds like it isn't a Jest bug then? :)
  Yes, you can do `--config=myConfig.json`.
  - removes mkdirp form jest-cli
- fixes broken jasmine formatter when the environment is not passed
 @facebook-github-bot import
 @facebook-github-bot shipit
  Yes, your configuration was wrong. You added `moduleFileExtensions` and overwrote the default. The default contains both js and json.
 Arghhh: https://github.com/airbnb/enzyme/pull/399
  What's `babel-jesta`? :D

Would you mind: upgrade Jest to 12.0.2 and then provide a sample repository that highlights this bug? It'll make it much easier to troubleshoot issues.
 Closing due to inactivity. Please feel free to provide a repro and I will reopen.
  moving it to util as I'll needed it for the snapshot functionality
 @facebook-github-bot shipit
  The `rootDir` config option is quite inconsequential. It is really just useful for configuration and not really used in useful ways inside of Jest. `testPathDirs` is what limits the directories which are being looked into for JS files and for tests. If you limit it to `<rootDir>/src/`, none of the folders outside of `src` are being looked at, therefore your gist is correct.

The correct name for `testPathDirs` is probably `rootDirs`, but that is confusing as well. Maybe we can improve the docs a bit.
  Hey! This doesn't seem like a problem with Jest and you are heading down the right path. I'll close this issue but if it turns out to be an issue with Jest, I'd be happy to reopen and fix whatever issue Jest may have.

Unmocking bluebird and rethinkdb makes sense based on what you are trying to do, however Jest is a unit test framework and the idea is usually to not make network requests (or write to databases) in a unit test. It makes a lot of sense to create a manual mock ( facebook.github.io/jest/docs/manual-mocks.html#content ) for RethinkDB and keep the database contents in memory during your test.

As to why your test is failing currently: I will expect the callback is executed asynchronously when the operation has finished, so you need to wait for that. To test promises, see this: http://facebook.github.io/jest/docs/tutorial-async.html#content

Jasmine 2 also passes a "done" argument to the spec that you can use to wait for the completion of an async operation ‚Äì see http://jasmine.github.io/2.0/introduction.html#section-Asynchronous_Support

I hope this helps :)
  It seems like that's an fb thing, then. I had no idea. Is there anything in mercurial already that does the same? 
 I'll take a look at this in a bit. I think changing how the hg command works should be done in a separate PR, not in this one :)
 Instead of an integration test, I'd prefer to mock out hg/git for the tests. See what I did with child process here: https://github.com/facebook/jest/blob/master/packages/jest-haste-map/src/crawlers/__tests__/node-test.js#L15-L34 ‚Äì I think we should assume that git and hg give us the right data back and stub it out in the hg/git tests. How does that sound?

For the root-relative thing, it turns out that is indeed a Facebook thing. The correct fix that should work both at Facebook and outside is to drop the `--root-relative` and set the "HGPLAIN" environment variable to 1 before calling any hg commands: `HGPLAIN=1 hg status` ‚Äì although not sure how that works with child processes in node :)

cc @sid0
 @facebook-github-bot import
 Actually, let me take care of this. Thank you so much for the pull request, this is great!
 Thanks for importing. If you are an FB employee go to [Phabricator](https://our.intern.facebook.com/intern/opensource/github/pull_request/1111639552233974/int_phab) to review.
 @facebook-github-bot shipit
  I just noticed this as well and snuck a fix into #1007: https://github.com/facebook/jest/pull/1007/files#diff-01c39670fbe12c47eaa0c31e8bdcbc22R120

Sorry for the issue, it'll be fixed in the next Jest update next week :)
  This refactors Runtime.js and TestRunner.js and pulls out the resolution code into a new module `jest-resolve` which now encodes Facebook's module resolution algorithm. It provides the second half of node-haste and together with `jest-haste-map` can be seen as a full replacement.

There is very little new code in this diff. Most code is existing code that was lifted from another module and brought together. The next step after this diff will be to see if it makes sense to fork the `resolve` module and speed up how it works.

It doesn't come with its own tests (yet) because its functionality is completely covered by all the tests in Runtime.js. I have also cleaned up all of the Runtime tests and added a new `createRuntime` helper for testing, which should make it much easier from now on to change how an instance of Runtime is constructed for tests.
 @facebook-github-bot import
 cc @davidaurelio, as always for these kind of things :)
  @facebook-github-bot shipit
  Why would it not work?
 This is working just fine. Your example above is incorrect:

``` js
var a = new RegExP('/abc');
a.test('abc'); // false, as expected
a.test('/abc/'); // true, as expected
```
  I don't quite understand what you are trying to do. When exactly do you want `actions.getSearchRoute` to be mocked? Can you expand on your example?

If you need one module mocked and another one uses those methods, I would recommend just dropping down to require instead. That works well.

I currently see no way to make this work using babel's modules. I'll close this because it isn't actionable for Jest this time (I'm trying to manage this issues queue, it's tough!) but I'm happy to help here to resolve your issue :)
  Move back to `__tests__` files and ignore them in the top level of the integration tests folder. This is so much better!

Also, we are now running the package tests first ‚Äì because jest-cli is a package, we can just do this and it will run as part of the packages. This should increase the signal while developing.

cc @dmitriiabramov 
 @facebook-github-bot import
 @facebook-github-bot import
  It was late last night and I forgot to push these changes.
- Always show the first line from the stack trace, even if it comes from Jest ‚Äì this should help make it easier to debug issues in Jest and in general should show where exactly an error came from.
- Move around some files in jest-util to be more consistent with other Jest packages.
- Remove `cleanStackTrace` references.
 @facebook-github-bot import
 @facebook-github-bot import
 @facebook-github-bot import
  This commit introduce a new matcher to `jest`:
`toMatchSnapshot`.
this new matcher can be called as usual:
`expect(something).toMatchSnapshot()`
the main idea is that the first time the test run it will store whatever is inside expect in a snapshot file,
the next time `jest` runs it will check against it to see if something has changed.

In order to store something on file we need to serialize it, so I currently implemented two different serialization strategies, if we are _expecting_ a `React` element to match a snapshot representation then it will be _currently_ be serialized using the `React.renderToString` method, otherwise it fallbacks to `jest`'s pretty printer.
I choose it because it provides out of the box support for `Maps` and `Sets` other than `Object`s and `Array`s.
As the title mention this is a work in progress as I plan to iterate on it to improve the serialization strategies and possible the output when it fails the expectation.

The matcher uses jasmine `Spec` `getFullName` as the key in the snapshot file, adding an index at the end, this enable us to use multiple `toMatchSnapshot`, not just in the same `Suite`, but also in the same `Spec`, when failing it will highlight which snapshot has failed prepending `#` in front of an index of it (it starts at 0, but we can change it to 1 if it creates confusion).

When a test fails one can either fix the code breaking the expectation or, if the expectation is not up to date anymore, pass `--overwriteSnapshot` to `jest` to update it:

<img width="733" alt="screen shot 2016-05-12 at 4 57 56 pm" src="https://cloud.githubusercontent.com/assets/87300/15221840/016ac28a-1865-11e6-87aa-b563e88e7d0e.png">

This is an example of a failing test for a React component  
<img width="849" alt="screen shot 2016-05-12 at 5 25 33 pm" src="https://cloud.githubusercontent.com/assets/87300/15222242/96ce6d8a-1866-11e6-81f4-59d759e5cb8a.png">
 This looks fantastic @kentaromiura! I left a ton of comments that are hopefully helpful.

Here are a couple of high level points that should help guide you:
- I really believe that we should not be opinionated about React at all and jest-snapshot shouldn't load in react-dom or react (except for the tests). I would like to maintain this API as we discussed in Japan:

``` js
expect(render(component)).toMatchSnapshot();
```

This is more to type for the user but leaves us with way more option value. The user can then render the react component to a string, to a DOM component or to a JSON structure. I think this PR should limit snapshotting only to DOM elements (where it does outerHTML or something) and strings. I'm really worried about opening this up to all kinds of data from the beginning. I'd like to learn from React snapshot testing and whitelist other types later when we find some patterns that people want.
- I think the matcher can be refactored to be less procedural and more functional. Can you think of some nice separation of concerns? For example, you could move the handling for directory creation into the `TestSnapshot` class by doing something like:

``` js
class TestSnapshot {
  static forFile(config, testPath) {
    // figure out snapshot directory
    // figure out snapshot path
    // create directories for snapshot
    return new TestSnapshot(snapshotPath);
  }
}

// matcher:
const snapshot = TestSnapshot.forFile(config, testPath);
```

I think that would be nicer and make the matcher more concise.
- Can we add a temporary flag "--experimental-snapshots" to Jest and only make the matcher do something when it is passed? This will allow us to iterate on it when it is merged into Jest and we don't have to feel bad when we change how it works.
- The tests should all use a mockFs and mockPath that you make up yourself, so they are unit tests and not integration tests :)
 Another solution instead of the "common" global state module:
- Create a class SnapshotState and instantiate it in `jest-jasmine2/src/index.js`.
- Pass it to the function that adds the matcher and wherever else you need to pass it to.

that way you'll have an instance of this global state in your test and it won't be globally stored in a module. When you get rid of the serializer it makes it easier to manage too :)
 I added a few comments, mostly with code nits. I have a few ideas on how to optimize the SnapshotFile class and I can help with that later. Let's fix up those minor nits I had and then ship this and iterate on it.
 Looks great! I'll land this tomorrow after tagging 12.1.1.
 I rebased to 12.1.0 so it should be easier to rebase later.
 @facebook-github-bot import
 @facebook-github-bot shipit
  Sorry, no there is no compatible version of Jest for node 0.12. We jumped straight from 0.10 to iojs and then node 4-6. I recommend trying to use node 4+ anyway for your tests ‚Äì if you depend on native modules you can mock them using Jest's automocking feature :)
  thanks for bringing this up. Unfortunately Windows support for Jest is mostly self-service ‚Äì we don't have the resources to support this at FB. If you'd like to dig into this, I'm pretty sure this must be an istanbul bug and it isn't a Jest bug because we don't write these files. We call istanbul's writer here: https://github.com/facebook/jest/blob/master/packages/jest-cli/src/reporters/IstanbulTestReporter.js#L38

I'm going to close this out because it doesn't seem like a bug in Jest. Thank you so much for providing a repository with a repro, I hope that someone working on istanbul can take a look at this. If this does turn out to be a bug in Jest, I'm happy to receive any PRs that make this situation better for you.
  The reporting code is a huge mess. This simplifies a bunch of things and makes everything go through the same code path and makes `noStackTrace` work again which hasn't worked properly for maybe half a year.

Fixes included:
- When a single test is run and it throws a runtime error, we now show the "1 test suite failed" message.
- Runtime errors, string errors and error objects thrown in tests now all render the same way and go through a single code path.
- Stack trace printing can be disabled with `--noStackTrace`

yay, regex

Fixes #985.

@bypass-lint
 @facebook-github-bot import
 @facebook-github-bot import
  The top level `__` part kind of annoys me and it isn't significant to Jest in any way, so let's move some things around :)

cc @dmitriiabramov 
 @facebook-github-bot shipit
   @facebook-github-bot shipit
  I don't know where `module.__filename` came from but it isn't a thing. `module.filename` is, however.

I also made some minor cleanups to Runtime.

Fixes #968.
 @facebook-github-bot import
  Right now we generate coverage and merge it back into the results object at the end after a test run. This has two disadvantages:
- Coverage data is massive and requires a lot of memory
- We take a significant amount of time to do this at the end of a test run

by merging coverage info after each test we can avoid both of these issues.
 cc @clentfort who expressed interest to help out a bit.
 It seems like we are already adding coverage information here: https://github.com/facebook/jest/blob/master/packages/jest-cli/src/reporters/IstanbulTestReporter.js#L25

but we also have `formatTestResults` for JSON printing, which is why we need to retain them. I'd like to take coverage off individual test results and get rid of them after processing them in the IstanbulTestReporter and potentially format them early?
 Sorry, it looked like we weren't going to focus on this anytime soon but @dmitriiabramov made a strong case to me to improve coverage support :)
 I think what @dmitriiabramov is doing should be enough to make this reasonable.
  Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!
 Can you check #991 and #984 and tell me whether that fixes your issue? The issue you run into should be resolved in the next version of Jest.
 Got it! I'll close this PR then and will tag a new release of Jest somtime in the next 2 days.

Thank you for your contribution! Sorry that I was fixing this exact issue at the same time :) Looking forward to more contributions.
  We don't need this option any longer. This simplifies the runner a bit and makes everything easier to reason about. We either have 1 or many workers. There are guards in place so that, if for some reason the worker count is <= 1, we stick with 1.
 @facebook-github-bot import
  Can you explain how your change helps? Don't you mean `require.resolve(rootDir, path)`? 
 I'm going to assume that `path.resolve` is relative to your root directory then when the "from" option is not specified. I'm pretty sure what you did won't work if you invoke jest on a folder that is not the same as `rootDir`, like if you do `cd src && jest` it will likely produce the wrong absolute path. I think `require.resolve` with the rootDir and the path passed in is a more robust solution for this.
 Can you add an integration test to Jest for this feature and add the configuration that you have? That'll help figure out what is going wrong here. `path.resolve` uses `process.cwd`, so I'm pretty sure what I said above is correct: https://github.com/nodejs/node/blob/master/lib/path.js#L1142

Which tests are failing, exactly?
 What exactly does your change look like and what's your config?
  @facebook-github-bot shipit
 thank you for those fixes!
  duplicate of #1175

I'm working on it.
  This is fantastic! I'll land it tomorrow :)

Should we also do this or something similar for `lastCalledWith` (and potentially factor the code out into a reusable piece)?
 @facebook-github-bot import
 @facebook-github-bot shipit
  You are unmocking `react` here: https://github.com/tommyJS/react-relay-redux-example/blob/master/package.json#L129 but that actually unmocks everything that has react in its path, including `reaction.js` or `react-example/App.js`.

See http://facebook.github.io/jest/docs/tutorial-react.html#setup on how to properly do it :)
  I'll fix this for the next version of Jest :)
 Going to close this out in favor of the pull request. The new Jest release will come out soon.
  This is a similar fix to what @spicyj did in https://github.com/spicyj/jest/commit/cff14103b247fcf539b5d5434b07fb2a55819d6d a long time ago. I wasn't aware of why we had this but it seems obvious to me that we shouldn't create processes if there are less than one worker available. Not really sure how that could happen but it seems that on vagrant/docker installs the number of cores is 0.

See #980.
 @facebook-github-bot import
 Probably not, looks like a different bug unfortunately :(
 We really need to start using flow + add more integration tests.
  Reopened #977.
  expose DIFFABLE_MATCHERS to allow customizing it
this allow formatMatchFailure to use the custom chai-diff messages for any custom matchers:

eg: in a theoretical `test-framework-setup.js`:

```
// ...
const JasmineFormatter = require('jest-util/lib/JasmineFormatter');
JasmineFormatter.DIFFABLE_MATCHERS.toMatchSnapshot = true;
// ...

failureMessage = formatter.formatMatchFailure(res);
```

will show something like:
<img width="1417" alt="screen shot 2016-05-09 at 2 36 01 pm" src="https://cloud.githubusercontent.com/assets/87300/15115038/ce7a75ae-15f4-11e6-8c54-66bc67ee19cb.png">
 Can we do `Jasmine.addDiffableMatcher` instead? A function API is more future-proof.

Also, should we add a test that this actually works? Do we test the diffable matcher thing at all?
 I think we may add an end to end test for this later (as the test requires to run through a custom matcher, intercept jest output and check that the resulting string is correct).
We can also add some unit test for the JasmineFormatter class as well as the current test are very basic.
 @facebook-github-bot shipit
  Is there an easy way to reproduce this kind of environment so I can fix this? :)
 Can you try to change https://github.com/facebook/jest/blob/master/packages/jest-haste-map/src/index.js#L296 to do `maxWorkers <= 1` instead and see if it works?
 I published a PR with this fix and will try to ship a new version of Jest sometime this week when I have overcome my jetlag and I'm sure I won't be doing anything silly ;) I suggest using the patch provided or downgrading to 11.0.2 for now until 12.0.3 is out sometime later this week.
 Ah, I'll keep it open until I publish the new version :)
 THis should be fixed.
  Fixed in #1515 and Jest 15 (released sometime this week).
  If you are trying to create a redis client that is mocked, you have to create a manual mock for it. Auto mocking can only go so far as to create automatic interfaces. When calling those functions, they will return undefined. However, you can implement custom implementations, like:

``` js
redis.createClient = jest.fn(() => {
  return a mock implementation here;
});
```

Note that the mock implementation depends on your needs and how full of a mock you'd like to create. Based on https://github.com/NodeRedis/node_redis#usage-example it has quite a few methods. Your mock could look something like this:

``` js
redis.createClient = jest.fn(() => {
  const client = {};
  client.on = jest.fn();
  client.set = jest.fn((key, value, print) => doSomethingOnSet());
  return client;
});
```

You might have to play a bit to get a good client to work but a good manual mock can be re-used in many tests.
  Thank you for reporting this issue. Do you use mocking or is mocking disabled? If you'd like to test your modules/components "supertest" and "appServer" you'll have to unmock them first:

``` js
jest.unmock('supertest').unmock('../appServer');
```
 Oops, wrong button, reopening :)

If you can't figure it out, can you provide a repository that points this issue out so I can take a closer look? Thank you :)
 I boarded a long distance flight and my internet was cut-off before I could reopen this issue.
 No, you haven't provided a full repository that highlights this problem so there is no way for me to confirm your issue.
 I think this should be fixed by setting the "testEnvironment" config option to "node". jsdom doesn't deal well with this stuff.
  Thanks for adding a test! I added a few minor comments ‚Äì would you mind rebasing and fixing them? :)
 @facebook-github-bot import
 @facebook-github-bot shipit
 I modified your change a little bit to set the name in `normalize`, no matter where the config is coming from ‚Äì I think that's gonna be safer for the future :) Thank you for your contribution and I'm looking forward to more :)
  Brief reply because I'm on vacation: it is likely your unit tests set up some expensive listeners and they aren't being cleaned up properly. The memory use between 0.9 and 12 did not change significantly.

Is this with or without coverage? Coverage is currently a bit unoptimized and we are planning to fix it soon.

Do you have any code you could share that reproduces this problem so we can make sure to fix this next week when I'm back? :)
 I'm pretty sure you aren't loading any images in Jest, are you? :)

While Jest could be better with memory use, it is very likely that your tests are for some reasons not being torn down properly and retaining module code that are being required.
 Well, glad Jest could help find some issues with your code! :D
  Can you try adding this: https://github.com/fbsamples/f8app/blob/master/package.json#L51-L60 to your Jest config? That should work.

The docs in react-native about Jest testing are unfortunately entirely outdated and no one is bothering to update them :(
 Closing as duplicate of #921.
 Is this a yubikey?
  Short answer because of vacation, but use babel-jest and jest.unmock instead of dontMock and it will work. More info can be found on the website and in the latest blog post.
 +1 cant seem to work out how jest handles default exports
 @richtier unmock is not deep. It seem to me like you'll have to also unmock your `Constants` and `Helpers` modules.

@andrewmclagan @richtier 
The way imports/exports work is based on how babel implements them and has nothing to do with Jest. If you use import and export on both sides, it will just work as you expect. If you use `export default` on one side, and require on the other, you'll have to do `require('Foo').default`. This is admittedly a confusing  implementation detail of babel. Is there a reason you are using require?

Closing this as it is a question and not a bug in Jest. If there is any clarification we could add to the documentation, please feel free to send a pull request :)
 Can you share a repository that highlights the issue that you are running into? I'm pretty sure there is just some confusion going on here about automocking and it should be resolved easily :)
 @mike-marcacci would you mind providing a minimal repro? @mike-marcacci this is because of circular dependency in your modules. `schema` must be imported before X is called, because X imports `schema`.  Can you rebase this? We should try it on www.
 @facebook-github-bot import
 Thanks for importing. If you are an FB employee go to [Phabricator](https://our.intern.facebook.com/intern/opensource/github/pull_request/156623838073276/int_phab) to review.
  Yes that seems like a bug. We'll fix it for the next release.
  We added a config option for this in #1233 and it will be shipped soon.
  When running my tests recieving this error:

```
 FAIL  src/components/common/user/UserMenu/__tests__/UserMenu.test.js
‚óè Runtime Error
Error: Failed to get mock metadata: /redacted-directory/node_modules/core-js/library/modules/_global.js

See: http://facebook.github.io/jest/docs/manual-mocks.html#content
    at Object.<anonymous> (/redacted-directory/node_modules/core-js/library/modules/_shared.js:1:133)
    at Object.<anonymous> (/redacted-directory/node_modules/core-js/library/modules/_shared-key.js:1:133)
npm ERR! Test failed.  See above for more details.  
```

Component under test:

```
import React, { Component, PropTypes } from 'react';
import { Nav, NavItem, Dropdown, MenuItem, Glyphicon } from 'react-bootstrap';
import { FORM_LOGIN, FORM_SIGNUP } from 'redux/modules/auth/auth';
import { LinkContainer } from 'react-router-bootstrap';
// import './UserMenu.scss';

export default class UserMenu extends Component {

  static propTypes = {
    user: PropTypes.object,
    organisation: PropTypes.object,
    logout: PropTypes.func.isRequired,
    showForm: PropTypes.func.isRequired
  };

  render() {

    const { user, organisation, showForm, logout } = this.props;

    return (
      <div className="user-menu">
        {!user &&
          <Nav navbar pullRight>
            <NavItem className="login" onClick={showForm.bind(null, FORM_LOGIN)}>Log in</NavItem>
            <NavItem className="signup" onClick={showForm.bind(null, FORM_SIGNUP)}>Sign up</NavItem>
          </Nav>}

        {user &&
          <Nav navbar pullRight>
            <li>
              <Dropdown id="profile-menu">
                <Dropdown.Toggle>
                  <span className="profile-name">{user.first_name}</span>
                  <img src={user.avatar} className="profile-image" />
                </Dropdown.Toggle>
                <Dropdown.Menu>
                  <MenuItem eventKey="1"><Glyphicon glyph="star" />Shortlist</MenuItem>
                  <MenuItem eventKey="2"><Glyphicon glyph="search" />Saved Searches</MenuItem>
                  <LinkContainer to="/user">
                    <MenuItem eventKey="3"><Glyphicon glyph="cog" />Edit Profile</MenuItem>
                  </LinkContainer>
                  <MenuItem className="logout" eventKey="4" onClick={logout}><Glyphicon glyph="log-out" />Log Out</MenuItem>
                  {organisation && <MenuItem divider />}
                  {organisation &&
                      <LinkContainer to="/admin" className="organisation">
                        <MenuItem eventKey="3">
                          <img src={organisation.avatar} />
                          {organisation.name}
                        </MenuItem>
                      </LinkContainer> }
                </Dropdown.Menu>
              </Dropdown>
            </li>
          </Nav>}
      </div>
    );
  }
}
```

Unit test:

```
jest.unmock('../UserMenu');

import React from 'react';
import ReactDOM from 'react-dom';
//import TestUtils from 'react-addons-test-utils';
import { shallow, mount } from 'enzyme';
import UserMenu from '../UserMenu';

describe('CheckboxWithLabel', () => {

  const properties = {
    user: {
      first_name: 'Fat',
      last_name: 'Freddie\'s',
      email: 'fatfreddy@example.com',
      avatar: 'http://image.com/image.jpg',
    },
    logout: () => {},
    showForm: () => {},
  };

  it('displays a dropdown menu - logged in', () => {
    const wrapper = shallow(
      <UserMenu {...properties} />
    );
     (wrapper.find(UserMenu).length).toBe(1);
  });

});   
```

Package.json:

```
"jest": {
  "unmockedModulePathPatterns": [
    "<rootDir>/node_modules/react",
    "<rootDir>/node_modules/react-dom",
    "<rootDir>/node_modules/react-addons-test-utils",
    "<rootDir>/node_modules/enzyme"
  ]
},
```
 ‚ö° npm --version

> 3.8.9
 Are you using babel-jest as well? Does it get printed when you run Jest?

As a workaround you can add "node_modules/core-js" to the unmocked patterns.
 yeah using `babel-jest` @ "^12.0.2"

I added core-js to the list previously. Although its throwing:

```
TypeError: Cannot read property 'apply' of undefined
```

Am i correct in assuming this is some kind of babel related issue? Having trouble diagnosing it...
 There was a small bug similar to your initial description in Jest earlier. It was fixed in 12.0.2 - are you sure you tried the latest version?
 I'm gonna close this for now because I don't believe there is a Jest bug here. core-js should be automocked as a polyfill when used with babel-jest. I just re-tried the react example in the examples folder with the latest version of babel and core js and everything works fine.

Happy to reopen if you have a repro. If you can provide a repository where I can highlight this issue with an `npm install` and `jest` run, I'm happy to reopen this issue and fix it :)
 Okay i will investigate further and return :-) 
 @cpojer 

Okay, I have more information.

When the component under test is declared as such:

```
import React, { PropTypes } from 'react';

export default class UserMenu extends React.Component {

    // ...
```

everything is fine :-) Although when the component is declared like so:

```
import React, { Component, PropTypes } from 'react';

export default class UserMenu extends Component {

    // ...
```

We get the core-js mocking errors. There were other errors with my PropTypes declarations, tht was solved with `"stage-0"` in .babelrc

Everything else is as the test repo!
 Personally i would really like to be using `transform-runtime` until webpack 2 is usable, with tree shaking. 
 If you unmock the path to transform runtime in the unmock patterns it should work. We don't currently special case it like we do with the polyfills but maybe we should.
 ok i will do that, although +1 for the exception moving forward. 
 @0xR do you have automocking enabled? This shouldn't happen with the default config in Jest 17.
  Did your test actually pass or did it fail with a runtime error? I'd expect it to fail in some way while it imports some modules that cannot be auto-mocked. Because you have a typo in the function name, it wouldn't hoist the disableAutomock call and therefore happen after the imports, when another failure has already happened.
 @dmnd I think we should error in the transform when incorrect casing is detected. Would you like to send a PR for this feature? The transform code is pretty simple and can be found here: https://github.com/facebook/jest/blob/master/packages/babel-plugin-jest-hoist/src/index.js ‚Äì simply doing a case-insensitive check first and throwing if the case-sensitive check for the method names doesn't match should be good enough :)
 Closing due to inactivity.
  Hey! I think it should be something like `^\.\/relayUnstableBatchedUpdates$` instead because of how Relay transforms their require statements.

We should probably add support for resolving `.native` files. Personally the platform extension files (and .native extensions) are kind of annoying and I'm hoping that we'll get rid of them for react-native eventually (in favor of inline `if (Platform.ios)` checks etc.).
 `.native` will be supported in the next version of jest. See #1007. I'll close this issue and we can continue the discussion on the pull request.

You'll need to add this to your configuration:

``` js
{
  "haste": {
    "defaultPlatform": "ios",
    "platforms": ["ios", "android", "native"]
  }
}
```

You can expect this feature to go out in Jest 12.1.0 soon (next week :) ).
  Encountering similar issues. AKA importing with lastest ES syntax as such:

`import { IsolatedComponent } from 'components';`

How do we get jest to `unmock()` a component exported in this way?
 Done! Thanks @jquense. `modulePaths` and `moduleDirectories` is now part of Jest 12.1.0.
  Yes you are right, which is why I removed the config options from the API docs. The next version of Jest will retry a crawl with node instead of watchman if watchman is not available, so this should not be an issue any longer.

We keep the `--no-watchman` flag so that jest doesn't print a silly warning message every time ‚Äì which should only happen if watchman is available but cannot be used, which is a rare case anyway. Does this make sense?
 (the fact that we use configs to transport options is bad and we should rewrite that.)
  Fixes #960.
 @facebook-github-bot shipit
  Thanks. That was a silly bug. The website system apparently tries to evaluate ${userID} in a template literal.

Yes, I think we should remove pit and use it and see how that goes :)
  Fixes the event listener leak message.
 @facebook-github-bot shipit
  wait, are they? In Jest, modules definitely behave differently based on whether "use strict" is given and I believe in nodejs too.
 I didn't know that! Would you mind also removing it from `examples/react`? :)
 @facebook-github-bot shipit
  @facebook-github-bot shipit
  Hey! Thank you for opening an issue on the bug tracker. Can you provide a small repository that highlights this bug so we can fix it and add it to our (new!) integration tests? :)
 Can you upgrade to 12.1.0 and let us know if this is still an issue? And as said, please provide a repository that shows this bug so we can reproduce it.
  We fixed this for the next release :)
  This has been confusing to me when using these matchers.
- If a mock function has been called once, instead of "was never called with" we should print the values.
- If a mock function has been called multiple times we should print the value it was last called with and print "And called N-1 more times."

Example Repro:

``` js
const fn = jest.fn();
fn('abc');
expect(fn).toBeCalledWith('abcd');
```
 @petetnt would you mind taking this back on and sending another PR? I think as a start showing the last N calls (3 is a good number!) + the number of overall calls would be very helpful.
  Fixes #802.
 @facebook-github-bot import
 @facebook-github-bot import
   @facebook-github-bot shipit
  @facebook-github-bot import
 @facebook-github-bot shipit
  This is not possible. Can you elaborate on why you'd like to do this?
 I don't think we'll support this as it makes everything dealing with the setup a bit more messy.

The way I would suggest to work around this is something like this in your setupFile:

``` js
global.it = function(description, fn) {
  pit(description, () => {
    // Assuming it is a promise
    return loadEnvironmentAsync().then(
      () => fn()
    )
  });
}
```

This will make everyone of your tests async. If you are not using `pit` you can use `it` instead (by doing `const it = global.it;` beforehand to save the jasmine function before). Then you have to use the `done` flag to work with async operations.

Let me know if this isn't a satisfying solution
  @facebook-github-bot shipit
 yap please add an integration test. I have a list of at least 5 integration tests I want to write so this stuff happens less often from now on.
  Sorry! We now finally have the ability to write integration tests for Jest and we can make sure we won't be breaking this again. I'll tag with a fix 12.0.2 today.
  Fix coming in 12.0.2. Sorry about that, we made a large rewrite from 11 to 12 and didn't think about scoped packages unfortunately.
   @facebook-github-bot shipit
  Fixes #925, #317, #290.

I'm starting to refactor how we find tests. This removes `testFileExtensions` and `testDirectoryName` in favor of a regex option for `testsPattern`. I tried to maintain the old config options with an adapter in normalize for now so that this isn't a breaking change. In a future release we'll add a warning and in a future-future release we will actually remove both options.

cc @dmitriiabramov would really appreciate a review.
 I'll create a new pull request as I "accidentally" used master for this one. I'll follow your suggestion and call it `testRegex`.
 I was on vacation and am currently working on bringing this back to life :)
  We removed global mock caches in #934 but for some reason I forgot to move this cache in the constructor. We only unmock the setup files a single time which isn't useful for subsequent tests. This makes it so we do this every time. It shouldn't have a big perf impact.
 @facebook-github-bot shipit
  In #905 it was reported that people without mercurial had some trouble with `jest -o`. I fixed that initially but on some system it seems like `childProcess.spawn` can throw. It doesn't seem to happen on OS X locally but based on what I read about `childProcess.spawn` I do believe it can throw. I think it is best to wrap it in a try-catch now ‚Äì the worst thing that can happen is to report back as not a git or not an hg repo, which it won't be if the commands fail.

I also took a note to write an integration test for this, now that we have integration tests. I will add a few in a follow up.

Test Plan:
Run `jest -o` with changed files both in a git and hg repo.
 @facebook-github-bot import
  Major because we rewrote `node-haste` as `jest-haste-map` and we updated Jasmine which throws on some things and is more strict than before.
 @facebook-github-bot import
 @facebook-github-bot shipit
  @facebook-github-bot shipit
 Thanks for importing. If you are an FB employee go to [Phabricator](https://our.intern.facebook.com/intern/opensource/github/pull_request/835635016541801/int_phab) to review.
  @skawian are you willing to make this change? That would be great. Also, I think we should leave the defaults the way they are and provide additional documentation for this.
 I'm fixing this in #943. I started some larger rewrite and had to do this :)
 Sorry I still haven't gotten around to work on the new matching code but we are getting closer! I'll close this PR as it won't be relevant when I send mine. Thanks for the contribution however and I'm looking forward to future contributions from you :)
  You can do:

``` js
jest.unmock('./myModule.js');

const myModule = require('myModule');
myModule.foo = jest.fn();
```

See http://facebook.github.io/jest/docs/api.html#mock-functions
 I do believe I understand this quite well. The way babel compiles modules however doesn't make this easier to understand and I understand your confusion. I don't know exactly how this would behave in a real ES2015 environment with modules, mainly because no such environment exists right now (except maybe latest versions of Chrome Canary, which I haven't tried yet). In order to explain what happens, we have to look at the compiled output of your babel code. It will look something like this:

``` js
var foo = function foo() {};
var bar = function bar() { foo(); };

exports.foo = foo;
exports.bar = bar;
```

In this case, it is indeed correct that you cannot mock foo and I apologize for not reading your initial issue correctly, however it did not make any assumption on how `foo` was called, so I assumed it was `exports.foo()`. Supporting the above by mocking a function after requiring a module is impossible in JavaScript ‚Äì there is (almost) no way to retrieve the binding that foo refers to and modify it.

However, if you change your code to this:

``` js
var foo = function foo() {};
var bar = function bar() { exports.foo(); };

exports.foo = foo;
exports.bar = bar;
```

and then in your test file you do:

``` js
var module = require('../module');
module.foo = jest.fn();
module.bar();
```

it will work just as expected. This is what we do at Facebook where we don't use ES2015. 

While ES2015 modules may have immutable bindings for what they export, the underlying compiled code that babel compiles to right now doesn't enforce any such constraints. I see no way currently to support exactly what you are asking in a strict ES2015 module environment with natively supported modules. The way that `jest-mock` works is that it runs the module code in isolation and then retrieves the metadata of a module and creates mock functions. Again, in this case it won't have any way to modify the local binding of `foo`. If you do have ideas on how to effectively implement this, please contribute here or with a pull request. I'd like to remind you that we have a code of conduct for this project that you can read up on here: https://code.facebook.com/pages/876921332402685/open-source-code-of-conduct

The right solution in your example is not to mock foo but to mock the higher-level API that foo is calling (such as XMLHttpRequest or the abstraction that you use instead).
 I agree it would be useful to be able to do this, but there isn't a good way in JS to do it without (probably slow) static analysis upfront :(
 You can call `.mockClear` on the function in `beforeEach` or call `jest.clearAllMocks()` if you are using Jest 16.
 yeah, something like this should get you on the right path! :) Use `jest.fn` as a nicer API, though :D  It seems like a Jest bug with Node 6. Would you mind sharing your setup or some of your specific tests that fail so we can make sure this is fixed in Jest 12? What do you mean "table with test cases", do you mean coverage?
 Should be fixed in the next release of Jest :)
 I have a PR up. Would you mind trying Jest master with this commit applied: https://github.com/cpojer/jest/commit/4bce1154c9ee35e2261464d9d594086b696b7f5d and tell me whether it fixes the same issue you had?
 Upgrading to Jest 12.0.2+ should resolve your problem.
 If it doesn't, it is probably another dependency that hasn't been updated (like babel, where I've seen this happen).
 Oh sorry, I didn't understand your comment the first time reading it. What you say is correct, some APIs are a bit more strict and the fix for Jest is to update to the latest version (12.0.2 onwards) :).
  This is a bug in Jasmine and we fixed it in our fork of Jasmine here: https://github.com/facebook/jest/commit/d6660c4417ac28863b2fb70abc1cef46e896b098

It'll go out with Jest 12 probably in a week and a half. You can use the master version of Jest until then if you'd like: https://docs.npmjs.com/files/package.json#git-urls-as-dependencies
 (I also ran into this in https://github.com/facebook/jest/pull/896 and it was annoying).
  The example doesn't use `autoMockOff` so I don't think the issue you created makes sense this way. The example definitely passes and has for a while; see the package.json file.

The new API is `jest.disableAutomock()` when used together with babel-jest, it will work properly.
  Would you mind re-trying this with Jest on master? I believe this bug was fixed recently.
 Ok, I tried out your gist and can confirm that `jest -i` passes the tests on Jest 12.

I had to add this:

```
"unmockedModulePathPatterns": [
  "node_modules/babel-polyfill"
]
```

to the Jest config however. There might be a minor bug there, individual from your issue and I will try to repro that :) Thank you for your patience!
 Oh yeah, that is indeed another bug I accidentally introduced. Fixed in #942 and will go out in 12.0.1. You won't need to add anything to the config then :)
  Currently we have `it` and `pit`.

When returning a promise or any other value from `it`, it is silently ignored and you might write a test with a promise that passes without ever checking the promise code.

There are a few things we can do:
- Overwrite `it` and merge the `pit` functionality into it. When `it` returns a Promise, it uses `pit`, if it doesn't return anything it will just use the regular it and if it returns anything else we throw. This is preferred if it doesn't have a negative performance impact.
- Just make `it` throw when returning anything but undefined.

This will likely also need some test fixes internally on www. After making this change, `jest --all --new` should be run and failures should be manually fixed before we can merge this.

cc @dmitriiabramov 
 Yeah, that's the idea. I don't know if this wrapping is gonna be bad for perf on www but it is probably negligible and we should just try it :)
 It's basically:

```
jest --all --new
jest --all --new
```

and take the time of the second run. The first one cannot be trusted (it creates the cache and does babel transforms). If it's slower than before, then we have to make sure it isn't that much slower ;)

I actually believe that if we add this directly to our fork of jasmine 2 instead of wrapping it, that would be fine with me too if its in the interest of perf.
  I like it.
 We can also do `--json` and look at that. Maybe `runJest.asJSON(‚Ä¶)` or something similar.
 @facebook-github-bot import
  An overhaul of the entire config system was planned. I would definitely like to preserve the ability to use regex however, as that is likely what most Facebook projects will want to continue to use.

Here are some parts to this:
- Design a new, simpler config system
- Convert old configs through an adapter. We can install and use that by default, warn for one major version and then drop it in the next.
- Make testPathPattern actually a pattern and not a directory pattern :D This has been a long standing feature request.
- Allow the use of both regex and patterns.

What do you think about re-thinking Jest's config and also possibly the CLI options? :)
 it's still on our plan. First we need to make sure there is no performance regression when using globs and then we'll probably keep both regxeps and globs in jest configuration :)
 @pksjce you should run jest on the top level, like `npm test -- jest-config` or `jest config` ‚Äì it reads pretty nicely if you have Jest installed globally. I'm curious to see what you come up with without breaking changes and significantly making configuration in Jest harder. @develar I agree it would simplify our configuration but you have to consider it would be a major breaking change for Jest and we have a ton of existing codebases that use the old system, both inside of FB and outside. This needs to be done carefully. Feel free to start with this, as long as it isn't a breaking change I'm supportive of any improvements to our config system. One thing to be mindful of is performance; regex simply seems to perform much faster than glob patterns and we apply these patterns on tens of thousands of files etc. at FB. I think it makes more sense to find new names for new things rather to rename existing regex patterns. I think we should have an analog to `testPathIgnorePatterns` that works with globs. Right, everything should be configurable and Jest should just ship with good defaults. I agree we need an escape hatch but given that we cannot break the existing field and turn it into a glob, we'll need to either keep `testPathIgnorePatterns` as a regex without a glob counterpart or add a second field that is the glob analog to the current regex one. I'm gonna close this issue. We'll ship with "testMatch" support in Jest 19. If we want to change other frequently used regex config patterns to glob, we should create a new issue. I think "testMatch" is going to be used the most, so people will be happy. Unfortunately we started auto-pushing the website again. This will be a feature in Jest 19, which will come out soon. We'll make sure to add "Added in Jest XX" in future doc updates. Sorry about that.  I think it may have been passed from argv into the config object previously but we aren't doing that any more, so I believe it can be removed as a config option.
  Dmitrii is still having some problems with the import script and I'm on vacation this week. We'll resolve it next week. Sorry for the delay.
 I just got back from a vacation so I have some more time to look at this. I left some inline comments.

Can you also add some tests with some mock-results so that we make sure we don't break this feature in the future? I'm hoping to get work done on improvements for coverage support overall soonish.

@dmitriiabramov is the import bot still broken for you? Can you work with the open source team to figure out what is going on here?
 please write a comment when you update the PR ‚Äì github doesn't automatically notify me :)
 @facebook-github-bot import
 @facebook-github-bot shipit
 Sorry for the long wait, between the bot being broken for Dmitrii and me being on vacation and having to catch up, this took a bit longer than it does normally :)
  @facebook-github-bot shipit
 Thanks for importing. If you are an FB employee go to [Phabricator](https://our.intern.facebook.com/intern/opensource/github/pull_request/876765215766703/int_phab) to review.
  Can you try adding this: https://github.com/fbsamples/f8app/blob/master/package.json#L51-L60 to your Jest config? That should work.

The docs in react-native about Jest testing are unfortunately entirely outdated and no one is bothering to update them :(
 @cliedeman the correct solution is to provide a new setup file and config example for Jest that works well  with react-native. If you'd like to send a PR to react-native and fix the docs, that would be fantastic and well appreciated!
 I agree! I'm sorry we are a bit behind on the documentation ‚Äì we are committed to make Jest the best testing tool for react-native but there are a couple of fires burning at FB at all times that I need to help put out, so this is moving a bit slowly in open source :)
 I would like to have a guide next to the React guide on the Jest website that explains the React Native setup well so that we don't have to go over to the react-native repo to fix the testing docs for Jest. If you have ideas on how to improve Jest's support for react-native, feel free to send as many PRs as necessary ‚Äì I'm happy to help as much as I can :)
 Thank you for your patience. We launched Jest 14.0 with experimental react-native support:
- [Blog Post](http://facebook.github.io/jest/blog/2016/07/27/jest-14.html)
- [React-Native Tutorial](http://facebook.github.io/jest/docs/tutorial-react-native.html)

Please feel free to create new issues after trying out the new integration if any issues remain. 
  Hello! Thank you for opening an issue. Would you mind making a small repository that reproduces this problem so we can take a deeper look? Thank you!
 Thank you for your patience. We launched Jest 14.0 with experimental react-native support:
- [Blog Post](http://facebook.github.io/jest/blog/2016/07/27/jest-14.html)
- [React-Native Tutorial](http://facebook.github.io/jest/docs/tutorial-react-native.html)

Please feel free to create new issues after trying out the new integration if any issues remain. 
  This was fixed in Jest 11.0. Please upgrade! If it doesn't work, I'll happily reopen this issue.
 You don't have the relative regex: "^[./a-zA-Z0-9$_-]+\.png$": "RelativeImageStub" that you'll need too.
 With the new jest-react-native preset this should work when using `jest-react-native@test`. We will release a major this week where this will work well for jpg files too.
  You should update to Jest 11.0. This config option wasn't present in previous versions which looks like what you are using.
  üëç 
  @facebook-github-bot shipit
 Thanks for importing. If you are an FB employee go to [Phabricator](https://our.intern.facebook.com/intern/opensource/github/pull_request/1243976738963250/int_phab) to review.
  Thank you for your thorough investigation and providing repros. I'm sorry this issue is hurting you and we might be able to remove some of this caching in the future. Unfortunately, most of this is quite complex.

To work around your issue, I believe an explicit `jest.mock(‚Ä¶)` call in your tests where you expect mocks will work until we fix this in Jest.
 This will be fixed in #934 and in the next release (Probably coming in 1.5 weeks).
  Fixed in Jest 12.1.1 (coming out tomorrow!).
  Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!
 Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks!
 Thank you! The README is generated from the API documentation here: https://github.com/facebook/jest/blob/master/docs/API.md would you mind updating `API.md`? Otherwise your change will get overwritten the next time we recreate the README :)
  @facebook-github-bot import
 Thanks for importing. If you are an FB employee go to [Phabricator](https://our.intern.facebook.com/intern/opensource/github/pull_request/1552872068340322/int_phab) to review.
  Fixed in #909. Thanks for the pull request!
 Published 11.0.2.
  You'll need to use `babel-jest` and `jest.disableAutomock()` if you are using import statements. 

See facebook.github.io/jest/blog/2016/04/12/jest-11.html for an explanation.
  Fixes #904  and #905.

The promise executor is synchronously called during instantiation, so `.catch()` will not work.
 @facebook-github-bot import
 Thanks for importing. If you are an FB employee go to [Phabricator](https://our.intern.facebook.com/intern/opensource/github/pull_request/1108774579143788/int_phab) to review.
 You are right. I'm a little bit confused as to why this worked yesterday for me. I'll change it.
 This version should now work properly.
 @facebook-github-bot import
 Thanks for importing. If you are an FB employee go to [Phabricator](https://our.intern.facebook.com/intern/opensource/github/pull_request/1108774579143788/int_phab) to review.
  Oops, at Facebook everyone has both Git and Mercurial installed, so we missed this during testing of 11.0.1. We'll fix this tomorrow and release a new version. Until then you can do:
- `jest --watch=all`
- downgrade to 11.0.0
 Fix will go out with 11.0.2 today.
 It's published now :)
 `--o` isn't a valid flag. It's `-o` or `--onlyChanged`. However, `jest --watch` does `-o` by default. If you want to run all the tests, you should do `jest --watch=all`.
 I'm fixing this in #941 and for the next Jest release (12.0.1). Would you mind sharing which OS you are using? `childProcess.spawn` isn't throwing for me but I do believe that it can throw.
 @duongphuhiep the issue you might be experiencing is that `jest --watch` by default runs tests related to changed files that have not been committed. If it works for small projects but not for bigger ones the problem might be either that the dependency graph that is being built is not entirely correct or that your setup is weird. If you could share an example repo where `jest --watch` does not work with certain changed files, I'd be happy to take a look.
  Oops, at Facebook everyone has both Git and Mercurial installed, so we missed this during testing of 11.0.1. We'll fix this tomorrow and release a new version. Until then you can do:

jest --watch=all
downgrade to 11.0.0
 Fix will go out with 11.0.2 today.
  @facebook-github-bot import
 @facebook-github-bot shipit
  @facebook-github-bot shipit
 Thanks for importing. If you are an FB employee go to [Phabricator](https://our.intern.facebook.com/intern/opensource/github/pull_request/1714114938833079/int_phab) to review.
  @facebook-github-bot shipit
 Thanks for importing. If you are an FB employee go to [Phabricator](https://our.intern.facebook.com/intern/opensource/github/pull_request/1669131236680910/int_phab) to review.
  Jest has more than just one node_modules folder ‚Äì every example and package might have one. We should probably delete them all :)
  I _think_ it should work if you create a `__mocks__` folder in your npm project and call it the same as your npm module. Would you mind trying that?

`my-npm-module` would ship with `__mocks__/my-npm-module.js`. If it doesn't work, we need to make it work :)
 Alternatively, if you have an index.js file, I think this should also work:

```
index.js
__mocks__/index.js
```
  This is a little bit upsetting, eslint is using private APIs ("module.paths") which Jest's sandbox isn't polyfilling as expected. @lencioni you are setting this because prior to 11.0 `paths` was not defined. In 11.0 it is an empty array which is why it cannot find airbnb's config.

I'll look into fixing this for the release today.
 Fix will go out with 11.0.2 today.
  Sorry I haven't gotten around to what's going on here yet. We follow the node resolution algorithm so I don't really expect this to happen. I just published Jest 12 ‚Äì does that version have the same problem?
 very good! I'll tag 12.0.1 tomorrow with some additional fixes.
  This is a new haste map implementation for Jest which is much more scalable than node-haste.

node-haste2 isn't well designed and not scalable for short-lived services like Jest. The startup time of node-haste1 vs. node-haste2 on www is almost the same, both between 6 and 8 seconds which is not acceptable for our engineers. This implementation is attempting to accomplish a much reduced and more scalable startup time. It also has reduced scope ‚Äì the goal of this is to only build a haste map and provide a way to resolve a one-level deep dependency tree, which is all that Jest really needs from node-haste. `jest-haste-map` can serve as an ideal basis for rewriting node-haste2 (into node-haste3!).

With this, the cold start time (building the entire haste map) is now about 14 seconds on www (that's acceptable) but the incremental invocation is only 2 seconds (@kyldvs will love me). I haven't heavily micro-optimized the JavaScript in `packages/jest-haste-map/src/index.js` and there is a bunch of data copying with `HasteResolver.js` ‚Äì I believe I can get close to 1 second with these optimizations once I'm done. One of the goals I have is to allow tacking on data (list of mocks) to the haste map and serialize the haste map and read that one in directly in the workers instead of keeping two caches.

On every startup node-haste2 asks watchman (or node) for a list of _all_ files. It builds up an in memory-file system and then processes every single file through an insane amount of promise chaining. It takes about 3 seconds on react-native to do this on a warm start. With this new implementation the cold start is about 1.5 seconds and warm start is way less than a second.

`jest-haste-map` only does the minimum processing necessary: it retrieves a list of all files only on the first start when using watchman and subsequent invocations only receive the deltas of changed files since the last time Jest has run. It further processes only files that have been changed or added. The node crawler isn't as optimized but it should be faster than node-haste2 as well.

What to review:
- `packages/jest-haste-map/src/index.js`
- `packages/jest-haste-map/src/worker.js`
- `packages/jest-haste-map/src/crawlers/`
- The other modules in `jest-haste-map` were lifted from node-haste2 and just received small code style updates (removed babel compilation etc.)
- `src/resolvers/HasteResolver.js` for usage.

cc @davidaurelio @kentaromiura @jeffmo @vjeux
cc @amasad ‚Äì if you could take a quick look, I would greatly appreciate it :)
 Actually the time it takes to run a fast test (~10ms) on www with this is 2s overall. That includes the 500ms overhead of loading jsdom too, so we are already pretty close to 1s for building the haste map.
 Done in e3189c4c80109e60f42cd98fa94880066587df9b: "Clean up HasteResolver and file caching for all of this". Now we only create one cache file. It is amended by "HasteResolver" with mocking information and is directly read from a TestWorker.

One nice side-effect of all this work is that Jest's own test suite is almost 2x as fast now. It only takes 2.5s instead of 4-5s.
 Thanks for the review.
- We use `testPathDirs` as separate roots extensively on www. This reduces the scope of files to crawl
- Yes, we should probably write a dex :D 
- It is probably fine to publish this as `jest-haste-map` as a first version and then consider splitting out certain packages into separate modules, depending on what other people might need.
- Yes, Map and Set are super fast but they don't serialize well to JSON. Is writing to a Map or Set as fast as it is to an Object? We are doing so many writes during startup, which is quite critical when you have 100k+ items. https://github.com/cognitect/transit-js could help to speed up serialization ‚Äì it is basically a custom serializer that is really fast and can encode/decode to immutable data structures. I think right now that is more than I need but if it yields real performance gains, I'd consider going for it :)
 I made a bunch of micro-optimizations in ed2ee7829928f890cb3c1792d1b9d0cf93f9061a

Since both my metadata objects for all files/modules contain the same fixed amount of items, using constant keys and arrays  was a great optimization and the code complexity stayed pretty much the same (`module[H.ID]` instead of `module.id`, for example).

The file size reduction of using constant keys and arrays instead of long string names and objects was 10 mb (!) down from 26 to 16 on a large code base. I was then able to exclude 5 % of the files from the original list and am now down to 14 mb. The parse time went down from 500ms to 250ms. The write time, interestingly, is still at 300ms. I looked into compacting the paths but that would only yield a win of another 2mb or so but it would add additional post-processing. I believe with this model the file size will grow to 30 mb over the next 3-4 years and decode in less than a second which will be more than good enough. Then, someone can consider different serialization models but right now we are in the diminishing-returns territory. The data model is simple enough and the code is easy enough to change.

Things I tried:
- JSONStream: this is memory efficient but actually very slow
- Decoding every metadata object individually so I could store them using my own data format. `loop over JSON.parse(item)` had _exactly_ the same performance characteristics as `JSON.parse(allItems);`.
 This implementation is now done and ready for review. I've added tests for all but the main `HasteMap` file which I will do tomorrow. Jest works on all platforms I have tested (www, react-native) so I'm confident the implementation is correct.

I added a large docblock to `HasteMap` explaining the constraints and architecture. I will add more documentation to individual methods.

On www at Facebook these are the effects of the change (very large repo):
- way more predictable performance than node-haste ‚Äì variance is less than a second on repeat runs.
- cold start (no cache): 20-30s down to 6s
- warm start: 6s down to <1s (this was the goal)
- inverse dependency resolution: 12-17s down to 0.3s
 And we are done. I tried to document the haste map as much as I could and everything should be covered by tests. Jest itself is an integration test for `jest-haste-map`. Everything works well on all code bases I tried. Jest is much faster for really really tiny repos (no more startup cost) and much faster for huge repos. Same perf for mid-sized libraries (like relay).
 @facebook-github-bot import
 Thanks for importing. If you are an FB employee go to [Phabricator](https://our.intern.facebook.com/intern/opensource/github/pull_request/1687533184831566/int_phab) to review.
  This was fixed in Jest 11.0. Please update your version of Jest. See https://github.com/facebook/jest/commit/67cdabbec04d45f396d36cee990f966ffafca6cc#diff-be7aadd3d65098895718442cdd64d31fR301
  Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!
 Thank you for your contribution. Please sign the CLA.

Would you mind adding an explanation of why this change is necessary and what you are trying to do here? :) Thank you.
 thank you for the explanation!
 Do you have an email address to which I could send a PDF version of the CLA that you can sign? Please email me at cpojer@fb.com or christoph.pojer@gmail.com
 Did you actually sign it? It doesn't seem like the GitHub bot picked up on it. Normally it will add a label to the commit that you signed the CLA.
 Is there a reason you closed this PR? I'm sorry I didn't have time yet to work on this more and merge it. And unfortunately it doesn't seem like you actually properly signed the cla as requested by the bot :( Please try signing it again, the bot usually works properly and I've not experienced any issues with it yet.
  @facebook-github-bot import
 This is great!
 Thanks for importing. If you are an FB employee go to [Phabricator](https://our.intern.facebook.com/intern/opensource/github/pull_request/1707644609511279/int_phab) to review.
 @facebook-github-bot shipit
 Thanks for importing. If you are an FB employee go to [Phabricator](https://our.intern.facebook.com/intern/opensource/github/pull_request/1707644609511279/int_phab) to review.
  You are right, this is indeed a jsdom issue. At Facebook, what we have done to work around this, is use this:

``` js
Object.defineProperty(window.location, 'href', {
  writable: true,
  value: 'some url'
});
```

this works for us, however we are still on jsdom 7 internally.

I'll close this, as I believe the `Object.defineProperty` way of doing things is fine. If that doesn't work for you in jsdom 8, I'm happy to reopen it.
 Nice! @okovpashko we're planning to expose jsdom to the environment: https://github.com/facebook/jest/issues/2460 `Object.defineProperty` works for us at FB.  I don't really care if its expensive or not as long as we only do this when a test is actually failing. Is the function you patched only called when a test fails? Can you point me to where that happens?

JSON.stringify/JSON.parse is definitely not great for consistency ‚Äì it loses all complex values. I'd much rather have a shallow copy (should probably be enough, right?) or even a deep copy utility (urgh!).

As an alternative ‚Äì could we change expect to throw when a test fails? There is often little point in continuing on until inevitably something else in the same test fails. That seems like the sane and easy fix to me? What do you think?
 @facebook-github-bot shipit
 would be nice to have a test for this, but it looks good so I'm gonna ship the fix first :)
 Thanks for importing. If you are an FB employee go to [Phabricator](https://our.intern.facebook.com/intern/opensource/github/pull_request/1254363157925226/int_phab) to review.
  Hey! I recommend looking at the history for the changelog changes: https://github.com/facebook/jest/commits/master/CHANGELOG.md

I always considered 0.9 and 0.10 a pre-release. If you have been on 0.9 and you upgrade to 11 and your tests pass, everything should be fine :) Most of what we did was bugfixes or new features ‚Äì so if anything breaks it is because Jest is now more correct than before.
  Is this a new problem with the latest version of Jest or have you only tried it with this version?
 Are you requiring react like "../../../../react" somewhere? It is unlikely that this is coming from Jest.
 Oh, I didn't realize you were using webpack alias. I don't officially support it and it is likely not a problem with Jest that you are running into.

`babel-jest` is the only officially supported preprocessor. I would recommend you to use that one (see facebook.github.io/jest/docs/getting-started.html#content ). If you need aliases, I recommend checking out the `moduleNameMapper` configuration option.
 Also, while playing around with the preprocessor I recommend doing `rm -rf node_modules/jest-cli/.haste_cache` ‚Äì I'm still working on some better cache invalidation logic.
  I think this is a wontfix (unless someone wants to send a PR). At this point I'd prefer not to change the jasmine1 runner so much. I think it pretty much reached its EOL. Jasmine 2 is more strict and I suggest everyone switching to it.

As @dmitriiabramov suggested, this seems like a bug in our jasmine 1 adapter and by switching to jasmine 2 it pointed out an issue with your test :)
  Please update to jest 0.10.2 :)
 Uhh.. I'm getting confused with the zero :) Heads-up: in a few days we'll jump to major versions for Jest and will start with 11.0.
 We'll survive it :)
  Until this is fixed I recommend unmocking the other module in question. Personally I would probably always recommend explicitly listing everything a module exports if you'd like to iterate over them but this should still work with Jest.
 Woah, I didn't realize babel-jest would even work with babel 5. We don't really support it any more‚Ä¶
 This will be fixed in the next release this week. Sorry about the issue.
  Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!
 Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks!
 Thanks for your contribution! Unfortunately, I don't think what you wrote is entirely correct. First, it mentions `package.json` and second it mentions that config can be passed through argv. This is not strictly true, as only some things can be changed through the command line. This should be made clearer and better (in code) at some point, but we are not there yet.

I think we should also rename "Config options" to "Configuration" here: http://facebook.github.io/jest/docs/api.html#config-options and link to the configuration headline below.

How about this:
Jest's configuration can be defined in the `package.json` file of your project or through the `--config <path/to/config.json>` option. If you'd like to use your `package.json` to store Jest's config, the "jest" key should be used on the top level so Jest will know how to find your settings:

``` javascript
{
  "name": "my-project",
  "jest": {
    "verbose": true
  }
}
```

When using the `--config` option, the JSON file must not contain a "jest" key:

``` javascript
{
  "bail": true,
  "verbose": true
}
```

Would you like to make these changes? :)
 oh.. hmm.. I honestly never even noticed their presence. I think we should probably get rid of it. You might need to update some links in the documentation that link to api.html#configsomething though.
 @facebook-github-bot shipit
 Thanks for importing. If you are an FB employee go to [Phabricator](https://our.intern.facebook.com/intern/opensource/github/pull_request/1686856544902303/int_phab) to review.
  awesome! Thanks for making these fixes.
 @facebook-github-bot shipit
 Thanks for importing. If you are an FB employee go to [Phabricator](https://our.intern.facebook.com/intern/opensource/github/pull_request/587116664788281/int_phab) to review.
  @facebook-github-bot shipit
 thank you so much Joe!
 Thanks for importing. If you are an FB employee go to [Phabricator](https://our.intern.facebook.com/intern/opensource/github/pull_request/1036878279705089/int_phab) to review.
  @facebook-github-bot import
 Thanks for importing. If you are an FB employee go to [Phabricator](https://our.intern.facebook.com/intern/opensource/github/pull_request/572592772921053/int_phab) to review.
 See #881. I had to make a lot more changes on this so I figured it is best to send a separate PR. I based my work off of yours, thank you very much! I had to rush a little bit to get this in in time for f8.
  Are you saying that your module uses `export default` and that doesn't work well with `jest.genMockFromModule`? Might require us to add some tiny little hack into the mocking library for babel 6's behavior around export default.

Would you mind making a repro for this so I can confirm this is the issue? Sorry you are running into trouble with this.
 I think this should be fixed in the latest version of Jest that we are releasing tomorrow. Feel free to reopen if this is still a problem.
  This doesn't work because ignoring scss from the preprocessor just means that it will not be run through babel-jest. Jest will then try to require the scss file directly and then fail because it isn't valid JavaScript.

There are two solutions:

#### Use the `moduleNameMapper` option and a stub file:

Jest config:

``` js
"moduleNameMapper": {
  "\.scss$": "path/to/SCSSStub.js"
}
```

SCSSStub.js:

``` js
module.exports = {}; // Or other stub data for all SCSS modules.
```

#### Build your own preprocessor using `node-sass`.

I'm not entirely sure what webpack does to export scss files as JavaScript, but basically you'll want to wrap `babel-jest` and do something like this:

``` js
module.exports = function(src, filename) {
  if (fileName.endsWith('.scss')) {
    return processSass(src);
  }
  return babelJest.process(src, filename);
}
```

where the processSass would use `node-sass` and whatever the webpack loaders do :)

I hope one of these is a satisfying solution. If you do build a preprocessor that wraps babel-jest, I'd be happy to add it to Jest as an officially supported package.
 that's great!
  It seems like this is working according to @dmitriiabramov. Happy to reopen if this continues to be an issue :)
  @facebook-github-bot shipit
 This is nice! Thank you for your contribution.

`--watch=all` means that it will run all the tests when a file changes. This is unrelated to the `--watch` or `--onlyChanged` option (which you changed).
 Thanks for importing. If you are an FB employee go to [Phabricator](https://our.intern.facebook.com/intern/opensource/github/pull_request/1713970938883699/int_phab) to review.
  @facebook-github-bot import
 This looks great! Sorry I was getting ready for the 11.0 release and didn't have much time to look at this but I'll add this to the next minor release of jest-mock :)
 Thanks for importing. If you are an FB employee go to [Phabricator](https://our.intern.facebook.com/intern/opensource/github/pull_request/254277384909867/int_phab) to review.
 @facebook-github-bot import
 Thanks for importing. If you are an FB employee go to [Phabricator](https://our.intern.facebook.com/intern/opensource/github/pull_request/254277384909867/int_phab) to review.
 @facebook-github-bot shipit
 Thanks for importing. If you are an FB employee go to [Phabricator](https://our.intern.facebook.com/intern/opensource/github/pull_request/254277384909867/int_phab) to review.
  @facebook-github-bot import
 Thanks for importing. If you are an FB employee go to [Phabricator](https://our.intern.facebook.com/intern/opensource/github/pull_request/947954301991308/int_phab) to review.
 @facebook-github-bot shipit
 Thanks for importing. If you are an FB employee go to [Phabricator](https://our.intern.facebook.com/intern/opensource/github/pull_request/947954301991308/int_phab) to review.
 Thanks for your contribution! I made a couple of small improvements to the message that I was only thinking about today ;)
  Unfortunately we are not currently planning on working on this. If you'd like to help out and add more custom test reporter features, I'd be happy to work with you on a Pull Request :)
 Closing this because there has been a month of inactivity. Happy to receive pull requests for this if anyone is interested in working on it.
  cc @appden
 I see that this is related to the `NativeModules` module not being stubbed properly. I'm currently thinking of ways to improve this. @ehrudxo what does the `__fbBatchedBridgeConfig` variable inside of your react-native app contain? You can try putting that same configuration into a file and add it to the `setupFiles` config array in your Jest configuration like:

```
global.__fbBatchedBridgeConfig = <whatever it is in your react native app>
```

I'm hoping to have a good fix for this by the end of the week, however.
 Thank you for your patience. We launched Jest 14.0 with experimental react-native support:
- [Blog Post](http://facebook.github.io/jest/blog/2016/07/27/jest-14.html)
- [React-Native Tutorial](http://facebook.github.io/jest/docs/tutorial-react-native.html)

We'll probably need to find a way to add some data to the __fbBatchedBridgeConfig for realm. cc @appden can you tell me what exactly realm exposes on the bridge config? We can then add a stub.
 With `jest-react-native` or the next release of react-native it should be easy to extend the `NativeModules` module in a file that is part of `setupFiles` with Realm related stubs. Closing this now.
  With jest 0.10.0 and babel-jest 10.0, you can use `jest.disableAutomock()` and it will properly be hoisted :)
 Also publishing a new version of the website now.
  Thanks for noticing! This part of the documentation didn't make any sense after my big rewrite. I updated it in #860.
  Hello!

This is most definitely not normal and I'm unable to reproduce this locally. If this happens only on the first run, it most likely means that your babel configuration is messed up and that babel is doing something that it should not. On the first run, babel transforms all files under test.

Your `package.json` specifies a bunch of presets for babel, they don't however seem to be installed. I recommend reading up on the babel documentation here: http://babeljs.io/docs/plugins/#presets

To prove that this is indeed a babel problem, I recommend doing `rm -rf node_modules/babel-jest` and then running Jest ‚Äì if the test runs significantly faster (less than 1s as expected), it is definitely a babel problem. Your test file doesn't currently seem to use any babel transforms either.

I'm closing this because it's unlikely that it is a Jest issue, but happy to reopen if it turns out to be related to Jest.
 Thank you for the update! That's definitely reassuring :)
  Thanks! I'll try to figure out what's going on here :) Just to check: you were changing the `sum.js` file in `src`, right? If you change the `__tests__/sum-test.js` file, will it run the tests? Do you have watchman installed? :)

As an escape hatch, you can always use `--watch=all` to run all the tests. Maybe we should add this to the console output? The static analysis of Jest will not work when using dynamic requires, for example.
 I tested your example repo (thank you for providing one!) and it does not reproduce locally (10.11.4). When I change either `sum.js` or `sum-test.js`, the tests run ‚Äì assuming files in the repo have been changed and are unstaged in git. I wonder if its related to your version of OS X, node and watchman or any combination of these?

If you'd like to send a PR mentioning `--watch=all`, that would be great. Can you come up with a succinct description? "No tests found related to changed and uncommitted files. If you are using dynamic require calls or no test files related to your changed files can be found, consider starting Jest with `jest --watch=all`"

?
 ohh that's interesting! I'm sure when you do `git add newfile.js` it will work properly with `jest --watch`. Is there a way to get untracked files in git? If yes, we can add it here: https://github.com/facebook/jest/blob/master/src/lib/git.js#L16 and it should work :)
 will be fixed in the next release :)
 @kalisjoshua we are talking about `jest -o` (the default for `--watch`) which uses static analysis to find related test files based on the set of changed files. This doesn't apply to `jest` itself or `jest --watch=all`.

At Facebook we have thousands of test suites. `jest -o` is the default ‚Äì it isn't feasible to run all tests on changes but we can accurately capture all _affected_ tests because we track all dependencies in the system (using https://github.com/facebook/node-haste ).
  setup.sh shouldn't be run when installing 0.10.0. I don't understand why it is trying to be run ‚Äì cc @kentaromiura didn't you make it so it won't be run!? Can we at least make it so that it just silently fails if `setup.sh` is not part of the copy of Jest? That should fix this too.

We'll fix this but in the meantime you can ignore the error. This is only for development and if npm install gets this far, Jest should be properly be installed :)
 This message will be removed from the next release.
  thanks! I might need to adjust the website generation tool that creates the README, but in the meantime this is fine :)
 @facebook-github-bot shipit
  Hey! I think the problem is that you are probably not unmocking all the modules you should be unmocking. In your example, Container and App need to be unmocked. Automocking is not actually a great default for many people or projects (I'll probably write a blog post about this soon).

Here are your options, based on Jest 0.10.0 which was just released:
- `jest.unmock('path/to/App'); jest.unmock('path/to/Container');` etc.
- `jest.disableAutomock()` to disable mocking by default
- `"automock": false` in the configuration.

I recommend basing your work off the react example in this repo :) If this turns out to be a problem with Jest, I'm happy to reopen this issue.
  I can‚Äôt quite tell from #698 and #296 whether or not this by design.
When I use `it.only` to isolate a specific test I want to focus on, Jest reports all other tests as passed:

```
1 test failed, 20 tests passed (21 total in 1 test suite, run time 1.733s)
```

However what _really_ happens is that those 20 tests were skipped because of `it.only()`.
If I remove it, I get

```
21 tests failed, 0 tests passed (21 total in 1 test suite, run time 4.093s)
```

The ‚Äú20 tests passed‚Äù in the first message gives a wrong sense of comfort. I‚Äôve also seen people commit `it.only()` in React repo in PRs more than once because Jest makes it so easy to miss. In contrast, different test runners usually report skipped tests explicitly. Could Jest output something like this instead?

```
1 test failed, 20 tests skipped (21 total in 1 test suite, run time 1.733s)
```

Thanks for consideration!
 Unfortunately this is a wontfix. Jasmine 1 doesn't have a concept of skipped tests. Jasmine 2 brings `fit` with it and correctly records and reports skipped tests. The fix for this is to upgrade the react repo to use Jasmine 2, which has been in the works since December. Jest now ships with Jasmine 2 by default and I'm hoping to phase out Jasmine 1 over time :)

cc @zpao :P
 Sure! Do you want that with fries or a mixed green salad?
 Yep! Jasmine calls them "pending" but I renamed it to "skipped" because pending sounds weird. 0.9.2 might still say pending but the next release (incoming!) is renaming them.
  Hey,

that actually sounds like a pretty good idea! However, is there a reason why wrapping Jest isn't an option for you? This was the original intention:

`jest --json | node processJestOutput.js | doSometingElse`

wouldn't that also work and give you more freedom to do whatever you want?
 @facebook-github-bot shipit
 Thanks for importing. If you are an FB employee go to [Phabricator](https://our.intern.facebook.com/intern/opensource/github/pull_request/230792390608442/int_phab) to review.
 yeah that seems reasonable to me. We made it so that Jest produces output similar to what we use at FB (with our custom runner, not yet open source), but there wasn't any other particular reason to do so.
  Thanks for opening this issue. I'll triage some older issues that are related to this task and close them in favor of this fresh discussion. Browser testing is part of my plan for Jest, however it isn't something we are planning to use at FB so it doesn't have a high priority. This is something where I'd be excited to support someone from the community ‚Äì this is certainly a challenging task but it would make Jest even more compelling to people :)

`browser-run` looks really awesome. If you look at the jsdom environment: https://github.com/facebook/jest/blob/b01ab18e0c703a715302a6959e3fca9e6b0260cf/src/environments/JSDOMEnvironment.js#L36 Jest already has a way for environments to run code in any way they want.

This would be easy if it wasn't for the fact that this callback would be async but Jest relies on synchronous calls to `require` to load the next module. Most of this is done in https://github.com/facebook/jest/blob/master/src/HasteModuleLoader/HasteModuleLoader.js (soon to be renamed to Runtime or similar). What's interesting however is that almost nothing in the module loader is entirely node specific and it could be packaged up and run in a browser.

At that point, here is what we'll need to do:
- Abstract HasteModuleLoader a bit more into a server and a client component. This might just be about making the seams clear and to isolate the parts that should be shipped to the browser: all the runtime (`jest` object), require implementation and mock configuration should be available on the browser.
- ship jest-jasmine and jest-util to the browser. Might require a tiny bit of refactoring.
- Transform and package all JavaScript and ship it to the client. JS should be sent as a Map<path, codeString> ‚Äì it has to be sent as string and should not immediately be run because Jest resets the module registry for every test. This is important for test isolation so that tests don't depend on each other. Since Jest doesn't know which files to run until they are needed, the big change here would be to bundle everything upfront. This wouldn't work at FB scale, but we don't intend to ever use a browser runner, so I don't mind this not being 100 % efficient.
- Add a "mock" `path` implementation so that module resolution can work based on the Map mentioned before.
- Every individual test should be run in its own browser environment, which should probably be an iframe. Again, this is to preserve Jest's sandboxing guarantees.
 I think we'll first need to think pretty hard on how to implement this in a way that it's gonna work well before we start writing any code. Once we have a good idea of what we are gonna build here, I can think more about the staging and smaller chunks of work.

I think one of the big questions is how to create the bundle. webpack/browserify will be insufficient for a few reasons:
- We don't know which actual modules we are going to use and run until they are required at runtime. I experimented with doing this statically (in #599) but mocking rules are runtime dependent and the static resolution was just way too slow (like, 2 order of magnitudes slower and not worth it). For example, when you do `require('Foo')` in Jest, it might require `Foo.js` or `__mocks__/Foo.js` and we only know which one at runtime (and it might be different for different tests, too). If you can think of a way to ship both to the browser, that would be great. We actually have an exhaustive list of all mock files and all JS files inside of a project in Jest, however that only works for Facebook's `@providesModule` modules and not for modules that are real CommonJS or node_modules. We need to figure out a way to get all of the relevant JS files into the browser.
-  Once we have a way of shipping the relevant code, it'll be a matter of separating some Jest code so it can be run in the browser. We need to ship our own require implementation (that we can extract from `Runtime`) with all the mocking rules applied and we need to be able to run JS from strings (using eval) instead of just dumping a bundle into a script pack.

I'm all for integrating with existing tools, but it seems that we need the ability to let Jest do it's runtime work of sandboxing and shipping its own require implementation.

Another option would be to make the runtime parts of Jest work in the browser and consider them as entirely separate from the cli runner. One example is the modularization we are doing already: `jest-mock` (https://github.com/facebook/jest/tree/master/packages/jest-mock) can already be used in any environment. The bundling would then be up to the developer (just get the JS to the client, and put it somewhere that Jest can execute it). Instead of `jest-cli`, it would be `jest-browser` and it would be a separate framework that shares the same core and could potentially run the same tests but with vastly different configurations and setup. I'm not sure if that's a good idea.
 I appreciate this discussion got started again. To me this has always been exciting but also risky for the project. I'll support this as much as I can and have some thoughts as well.

My ideal solution to this would be somewhere in jest-runtime and jest-environment-*. The problem is that right now; Jest requires and compiles files "just-in-time" when they are required which means they need to be synchronous. Because of the mocking feature, the entire module system and file system needs to be virtualized in the browser, as well as the entire transform pipeline with babel.

However, there are two more ways of solving this, both equally exciting:
* We split up Jest into many packages and a bunch of them can be used in the browser if they are bundled up, like jest-matchers.
* We could actually turn `require` into a generator and use a websocket connection to communicate with "jest sever". The problem is that right now require's are synchronous but we'd need to make them async. I'm not sure how this would work (generator or async/await) but with a babel transform and changing the require implementation in Jest, given that we are in full control, could work:

```
// How it works right now, jest wraps every file in a function and passes its require implementation:
(function(require, ...) {
  const apple = require('apple');
});

// How it could work, using a babel transform:
(function*(require, ...) {
  const apple = yield require('apple');
});
```

This would run on the client; when we call into require we'd request the transformed module over a websocket connection. @cpojer I'm actually not into the topic but in case you missed it, async `import()` recently got to Stage-3: https://github.com/tc39/proposal-dynamic-import 
and I believe it's used in Webpack2 now: https://github.com/webpack/webpack/pull/3413 @thymikee yeah good point but that also requires to write a transform from require to async import, it's very similar I guess. @ThatTomPerson jest-runtime does this branching already. Wow, this is super cool you're working on this!

I think you should spawn new browser in `ElectronEnvironment#constructor`, just like we do with spawning `jsdom` env. 
Keep us posted oh hell yeah @nhunzaker. I'm extremely excited about this. Do you have a guide to set this up?

If @thymikee's suggestion doesn't work, could you use iframes in `runScript`?  Thanks! Fixed this in https://github.com/facebook/jest/commit/7e575672689dca354a34ce34b0bfa702308301a7
  Hello @ide :)

I think it would be easier to just get rid of slashes in the config name. That would go here: https://github.com/facebook/jest/blob/master/src/config/loadFromPackage.js#L22 and maybe one or two more places. It seems easier to me than creating a sub directory here.

What do you think?
 Yeah, I guess this is alright. I think we should probably use the same cache-key-name generation that we use in other places (where we hash the whole thing) but it doesn't really matter that much in the end.

See https://github.com/facebook/jest/blob/master/src/TestWorker.js#L43-L46
 @facebook-github-bot shipit
 Thanks for importing. If you are an FB employee go to [Phabricator](https://our.intern.facebook.com/intern/opensource/github/pull_request/495253304002668/int_phab) to review.
  @facebook-github-bot import
 Thanks for importing. If you are an FB employee go to [Phabricator](https://our.intern.facebook.com/intern/opensource/github/pull_request/963453847065679/int_phab) to review.
 @facebook-github-bot shipit
 Thanks for importing. If you are an FB employee go to [Phabricator](https://our.intern.facebook.com/intern/opensource/github/pull_request/963453847065679/int_phab) to review.
  can you do `rm -rf node_modules/jest-cli/.haste_cache`? The preprocessor is not being invoked for files that have not changed. Most of the times the preprocessor is only called once.
 Yeah, most people won't run into this because they just use `babel-jest`. I agree though that it can be made easier. `--no-cache` also serves this purpose but currently it doesn't clean the old cache, so invocations with `--no-cache` and without produce different files. That's a bug I'd like to fix soon.
 I'm likely going to remove this option soon, however, because it doesn't serve a lot of purpose.

I would recommend adding a note like this:

_Note: Jest's preprocessor is only ran once per file unless the file has changed. During development it can be useful to run Jest with `--no-cache` or to frequently [delete Jest's cache](http://facebook.github.io/jest/docs/troubleshooting.html#caching-issues)._

would you mind sending a PR?
 `--no-cache` does the same thing, so why disable it from the config?
 I'm sorry, I thought you were talking about removing the option `preprocessCachingDisabled`, something that I will do soon. I don't know much about nested babelrc files but it seems out of the scope of Jest to fix this. And yeah, you can obviously always use your own preprocessor :)
 yes.
  cc @kentaromiura 
 I'm going to close this because we can't reproduce this unfortunately. If this is just an issue with the reporter it might be a bug in istanbul. I'm happy to reopen if you can provide a sample repository where we can run Jest and try to reproduce the issue :)
 Hey! I believe this is definitely an issue with either babel or istanbul or how they are connected and all of this isn't super great right now. It seems like the coverage report itself is correct (100 %), which is important. It might just collapse two lines into one or something.
  great! Just needs a proper copyright header :)
 @facebook-github-bot shipit
 Thanks for importing. If you are an FB employee go to [Phabricator](https://our.intern.facebook.com/intern/opensource/github/pull_request/129405100788132/int_phab) to review.
  Hello! Thanks for creating this issue. It seems like you figured everything out based on the existing documentation, so I'm not really sure if there is anything actionable here. If you'd like to add some more hints and text to the existing documentation, please feel free to contribute it in a pull request :)
  Fixed in #832.
 Wait, sorry, nevermind. No, that is not yet fixed unfortunately.
 @brentvatne can you retry with Jest 12 and let me know if this is fixed now?
  Thanks for the idea! In the next version we are actually going to wipe away everything in the terminal window every time we re-run Jest during a watch. I think this is going to improve this quite a bit and will give you enough information to realize that a re-run is happening. I think this will be enough signal.

Since we may get potentially thousands of signals (like during npm install), printing the names of the changed files isn't that useful.

I'm going to close this issue but if you feel strongly that this should become a feature in Jest I'm happy to help you on your way to make your first Pull Request to Jest :)
  Hey! Can you try without coverage and whether that works? I will recommend not using `--coverage` during watch. There are some issues with coverage which have to be fixed, however.
 Duplicate of #815.
  Just to double check to make sure I understand: you are using jest inside of the submodule, not inside of the parent repo, is that right?
 Looks like `git rev-parse --show-toplevel` is what we want instead of `--git-dir` :)
 @facebook-github-bot import
 Thanks for importing. If you are an FB employee go to [Phabricator](https://our.intern.facebook.com/intern/opensource/github/pull_request/1589590824694906/int_phab) to review.
 @facebook-github-bot shipit
 Thanks for importing. If you are an FB employee go to [Phabricator](https://our.intern.facebook.com/intern/opensource/github/pull_request/1589590824694906/int_phab) to review.
  @facebook-github-bot shipit
 Thanks for importing. If you are an FB employee go to [Phabricator](https://our.intern.facebook.com/intern/opensource/github/pull_request/1538805506420540/int_phab) to review.
 woah, it's the real @brentvatne contributing to Jest! Jest is now officially a hipster project again. Thanks for the documentation improvements.
  @kentaromiura was looking into this.
 Will reopen once we have a repo.
  - postinstall breaks npm install on windows, moving the logic inside a javascript file and run it through node
- utils-normalizeConfig-test.js was failing on windows because of difference in path separator and root
 Fixes https://github.com/facebook/jest/issues/795
 @facebook-github-bot shipit
 Thanks for importing. If you are an FB employee go to [Phabricator](https://our.intern.facebook.com/intern/opensource/github/pull_request/837700199709569/int_phab) to review.
 @yaycmyk I have created an account but didn't get to set it up for Jest yet. I want to point out that we don't prioritize Windows support at Facebook. We rely on awesome contributors, like you, to help us out with that. That being said, we should make sure we don't regress on any existing features.
  I'm currently not interested in changing the test run order. I think it can be further optimized (like pointed out in the blog post, to run previously failed tests first) but no one has been actively working on it. If you'd like to, I'd be happy to help! It should be a pretty easy feature to add :)

I don't think it makes much sense to mix up the run order much more than that. What you recommended will most likely be achieved by running failed tests first :)
 Unfortunately on the first run, we don't really know which tests to run first because we don't have knowledge from previous runs. The way we integrate Jest at FB is actually on a per-test basis ‚Äì when a developer lands a change that breaks tests, they get a task assigned to them to fix that one particular test which means we'll have to run all the tests anyway. In general, it is useful to run all the tests on CI so you have a log of everything that fails. Is this something that is actually impacting your CI test runs? I think that any change we'll be making here is at the most going to save you 5-10 seconds on the CI and things like "npm install" are way slower and there is probably way more you can do there to optimize.
  Nice work! I left a couple of small comments. I do agree it should definitely throw when the second argument to mock is invalid and can't be hoisted.

I would like the API to be this:

``` js
jest.mock('foo', () => {
  const myMock = require('myMock');
  myMock.foo = jest.fn();
  return myMock;
});
```

where the second argument to `jest.mock` is a function that gets run when `require('foo')` is called. I think this does require some minor changes to HasteModuleLoader ‚Äì if you can make this work from the babel plugin side, then I can make the changes to the module loader with this new feature. It's fine if the integration test fails for now until I'm done with that :) Of course, if you'd like to take a stab at it, it would be somewhere around here: https://github.com/facebook/jest/blob/master/src/HasteModuleLoader/HasteModuleLoader.js#L159-L219 ‚Äì and will require a new instance variable and some new tests. I think we can also change `_explicitlySetMocks` to this:

```
jest.setMock('foo', value) -> this._explicitlySetMocks[name] = () => value;

jest.mock('foo', () => value) -> this._explicitlySetMocks[name] = arg2OfJestMockCall;
```

which should make this change a bit easier. I'm not entirely sure about constraints around isolating require, but we can use this as a start.

We also need to update the documentation to include this new feature, this is something I can do.

Finally, this is a breaking API change and might confuse people. I think we need an escape-hatch for people to opt-out (just like we are keeping `jest.dontMock` around). We should add a function that is an alias for `jest.mock` but doesn't get hoisted. Since `jest.dontMock` is already quite silly, we can potentially just call this method `jest.doMock`. It's an escape-hatch that will be rarely used anyway :)

And also I wanna say: thank for the hard work you are putting into Jest. This is invaluable and I appreciate the support I'm receiving from you. Thank you.
 Can you add a whitelist to the plugin instead? I can take care of the rest of the work in the HasteModuleLoader.
 @facebook-github-bot import
 Thanks for importing. If you are an FB employee go to [Phabricator](https://our.intern.facebook.com/intern/opensource/github/pull_request/743304005771562/int_phab) to review.
 @facebook-github-bot shipit
 Thanks for importing. If you are an FB employee go to [Phabricator](https://our.intern.facebook.com/intern/opensource/github/pull_request/743304005771562/int_phab) to review.
 I decided to go with a whitelisting approach as follows:
- `jest` and `require` are whitelisted
- All current globals are whitelisted, these are the default globals from Node.js available in the Jest preprocessor which are most likely all non-custom globals that are also available inside of Jest's sandbox.
- All built-in types from the ES2015 standard are whitelisted.

This list is exhaustive and there is no reason we can't update it once per year when EcmaScript evolves. The escape-hatch is to access `global.Foo`. Now, this will not work if someone depends on mutations to built-in types if they occur after an import. However, these kind of mutations should be done in one of the `setupFiles`, so most likely this will be fine too.

I fixed a small bug around `setMock` that was introduced in this commit and updated the documentation.

The one thing I'm going back and forth on is whether the moduleFactory should receive it's own `require` implementation or whether it should just take the one from the parent context. It will likely slow things a little bit down but give more isolation to `jest.mock` module factories. Technically every module in Jest receives its completely separate require implementation. The API would look something like `jest.mock('Foo', require => require('mock'))`. I'm going to have to think about some of the downsides of doing this but it seems more technically correct. However, at the same time, the only thing that I think can really be affected by this is to copy the custom mock across test files, where the state of the module loader might be different.

Thanks again @pvolok for working on this.
  I don't think that's a good idea. `peerDependencies` are now no longer automatically installed with npm3 and I'd prefer not to add more complications here.
 Yeah, I agree. And I'm sorry about that. There have been a few other things that are more important to get right at the moment than updating jsdom across all of our tests at FB. As previously recommended, I suggest creating your own `JSDOMEnvironment` (https://github.com/facebook/jest/blob/master/src/environments/JSDOMEnvironment.js) and use it with the `testEnvironment` config option. You'll be able to remove it once we update jsdom.

May I ask why you need this update? Is there anything in jsdom that I missed that is super-good to have?
 I'm going to merge #873 which will split up the environments. We'll make it easier for the future to customize the env, as well. I think I'm gonna bump the jsdom version for this.
  We now have `jest-environment-jsdom` and other environments can be added easily. We also upgraded to the latest version of jsdom, so we should be good.
  Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!
 Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks!
 thanks!
 @facebook-github-bot shipit
 Thanks for importing. If you are an FB employee go to [Phabricator](https://our.intern.facebook.com/intern/opensource/github/pull_request/231441940541454/int_phab) to review.
  This is awesome. I left a few smaller comments inline. Overall, while the code should potentially be async, I like how simple it is using sync operations. There is also nothing at all to be gained from making this code async, so please keep it this way.

Can you move add a test command to `jest-mock` as well? :)
 Alright! Can you:
- Rebase on top of https://github.com/facebook/jest/pull/821#event-599644541 (merged into master)
- Make the script run `npm link` on Jest's root folder.
- Make it so that for every example we run `npm update` and then `npm link jest-cli`

That should make travis pass and it will make the new test command work, I think :)
 This is great @dmitriiabramov. I left a couple of minor inline comments before we can ship this. Awesome work!
 @facebook-github-bot shipit
 Thanks for importing. If you are an FB employee go to [Phabricator](https://our.intern.facebook.com/intern/opensource/github/pull_request/188162634899229/int_phab) to review.
  Hmm, honestly I would prefer not to add this message to the Jest code. We used to have it but I don't really like having those deprecation notices in node. I feel like 0.12 and 0.10 are "pretty much dead". Can we only add it to the troubleshooting guide?
 @facebook-github-bot shipit
 Thanks for importing. If you are an FB employee go to [Phabricator](https://our.intern.facebook.com/intern/opensource/github/pull_request/1686297954971644/int_phab) to review.
  Yes I agree we should do this.

@kentaromiura Let's add it automatically here: https://github.com/facebook/jest/blob/409a7626bf7e083ce434e5a6dd7b0bac149a7276/src/config/normalize.js#L112-L116 if `moduleFileExtensions` is not explicitly passed in as a config option.

@StephanBijzitter for now you can add the `moduleFileExtensions` config option manually :)
 @StephanBijzitter would you like to send a pull request for this change? The link above should show you where this would go :)
 Closing due to inactivity.
  It seems to me like these are things that should be fixed in babel instead of in Jest.
 Also happy to help talk to people on the babel side about this. Both issue seem to be simple fixes in Babel, so it should be easy to get them in.
 I'm assuming this is fixed now. @dmitriiabramov rewrote Jest's code coverage support. Please try with `jest@test` or `jest@14.2.2-alpha.22bd3c33` to see if this issue still persists. If it does, we'll reopen this issue.
 nice!
thanks @migueloller 
 Try jest 15.
 @ola-g86 are you using any custom preprocessors? is your project open sourced?
  @facebook-github-bot import
 Thanks for importing. If you are an FB employee go to [Phabricator](https://our.intern.facebook.com/intern/opensource/github/pull_request/704230543013592/int_phab) to review.
 @facebook-github-bot shipit
 Thanks for importing. If you are an FB employee go to [Phabricator](https://our.intern.facebook.com/intern/opensource/github/pull_request/704230543013592/int_phab) to review.
  @facebook-github-bot shipit
 Thanks @kmagiera! Seems like we had this issue since forever and obviously Jest should be a much smaller install. Looks like 0.9.3 will be going out this week, then ;)
 Thanks for importing. If you are an FB employee go to [Phabricator](https://our.intern.facebook.com/intern/opensource/github/pull_request/930236080425772/int_phab) to review.
 Thanks for importing. If you are an FB employee go to [Phabricator](https://our.intern.facebook.com/intern/opensource/github/pull_request/930236080425772/int_phab) to review.
  @facebook-github-bot import
 Thanks for importing. If you are an FB employee go to [Phabricator](https://our.intern.facebook.com/intern/opensource/github/pull_request/1107530779299758/int_phab) to review.
 @facebook-github-bot shipit
 Thanks for importing. If you are an FB employee go to [Phabricator](https://our.intern.facebook.com/intern/opensource/github/pull_request/1107530779299758/int_phab) to review.
  Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!
 Thank you for the contribution! :)
 Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks!
 @facebook-github-bot shipit
 Thanks for importing. If you are an FB employee go to [Phabricator](https://our.intern.facebook.com/intern/opensource/github/pull_request/912415638856191/int_phab) to review.
  Thanks for the report! That definitely doesn't sound right. Do you have any configuration for jest in your `package.json`? One thing that changed was that the default is now Jasmine 2 instead of Jasmine 1. You can still use Jasmine 1 (see http://facebook.github.io/jest/docs/api.html#config-testrunner-string or use `--testRunner=jasmine1`). Nevertheless, this should definitely not happen and I'm taking a look now.
 So the problem is definitely the `throw('error')`. Changing it to `throw new Error('error')` will work correctly. I'm trying to figure out whether this is an intentional change in Jasmine or whether this only happens with Jasmine inside of Jest and is a bug in the Jasmine 2 integration :)
 Ok definitely a bug in Jest. I'll try to fix this for the next release but as a workaround I suggest changing to `throw new Error()` :) Thanks so much for creating a concise repro case!
 Or well, you can also use jasmine1 for now to unblock yourself :)
 Fix will go out with the next version of Jest.
  @hourliert would you like to send a Pull Request for this? Note we refactored Jest a bit, so the line you referred to earlier is now in the `read` file: https://github.com/facebook/jest/blob/master/src/config/read.js#L26
 Fixed in #809. This will be in the next Jest release.
  Since the latest version of Jest doesn't ship with automocking enabled by default and no one is working on fixing this I'm gonna close this issue out due to inactivity.
  What about just `babel-plugin-jest-hoist`?
 @facebook-github-bot import
 This is great work. Thanks so much @pvolok!
 Thanks for importing. If you are an FB employee go to [Phabricator](https://our.intern.facebook.com/intern/opensource/github/pull_request/1129795840372560/int_phab) to review.
  I think the description inside of Jest makes sense but it might make sense to add this to the top of https://facebook.github.io/watchman/docs/troubleshooting.html @wez what do you think?
 We now have more control over fixing this. We should just not use watchman if it throws. Here is what we could do:

See https://github.com/facebook/jest/blob/052af961fb469f78ddcbd623b39622416fc21da9/packages/jest-haste-map/src/index.js#L329
- catch errors thrown by crawl (not sure if this is thrown before we create the promise or in the promise chain. Seems like it is before that?)
- `if (crawl === watchmanCrawl) { console.warn the watchman error and retry with node crawl }` ‚Äì this could highlight that watchman should be initialized and link to the watchman troubleshooting page which the thrown error should do from the watchman crawler.
- If that fails too, re throw.
  Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!
 Thanks, that's a great start! Even with an example.

Unfortunately, a lot of this code is _super_ performance constrained ‚Äì the function you added this to is called thousands of times. Unfortunately my hint on where to add the resolution for this was out of date. Here is the correct link: https://github.com/facebook/jest/blob/7d060a2a6f47a0bfdf37e48a0afd81fadec2ddcc/src/HasteModuleLoader/HasteModuleLoader.js#L447-L449

I think it might be fine if we change the return statement to something like this:

`return this._getModule(moduleName) || moduleName;`

If there is an entry in the haste map (`this._modules`) it will return that, otherwise it will return the moduleName that it received from `resolveStubModuleName` ‚Äì I think that should work? You don't need to resolve relative module names. Jest has a `<rootDir>` template that you can add to anything in the config object and it will resolve to a full path. This means that you don't have to do this on the fly and it won't incur a performance cost :)

Also, the right place to add a test is somewhere around here: https://github.com/facebook/jest/blob/7d060a2a6f47a0bfdf37e48a0afd81fadec2ddcc/src/HasteModuleLoader/__tests__/HasteModuleLoader-requireModuleOrMock-test.js#L110-L122 ‚Äì with the config on top of the file here: https://github.com/facebook/jest/blob/7d060a2a6f47a0bfdf37e48a0afd81fadec2ddcc/src/HasteModuleLoader/__tests__/HasteModuleLoader-requireModuleOrMock-test.js#L29-L32

Would you mind trying out these changes? :)
 Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks!
 Yes, that is basically the idea! It allows to map arbitrary modules to other strings. Ideally we'd also support backreferences, so something like "foo(.*)": "<rootDir>/bar/\1" would map "foobar" to "<rootDir>/bar/bar" but that should be done in a follow-up ‚Äì I haven't created a task for this, but I'd be happy to if you want to tackle this :)

And of course, feel free to add documentation to your PR.
 Actually, I think I would recommend removing the example but adding the test instead at the location that I mentioned in my earlier comment ‚Äì examples are always a bit of work to maintain :)

I recommend adding better documentation for this feature in API.md, that should be more helpful than the example overall :) Does this make sense to you?
 That's fantastic!
 @facebook-github-bot shipit
 Thanks for importing. If you are an FB employee go to [Phabricator](https://our.intern.facebook.com/intern/opensource/github/pull_request/1750483138514395/int_phab) to review.
  @facebook-github-bot import
 Alright, let's give this a try! :)
 Thanks for importing. If you are an FB employee go to [Phabricator](https://our.intern.facebook.com/intern/opensource/github/pull_request/584247051730122/int_phab) to review.
 @facebook-github-bot import
 Thanks for importing. If you are an FB employee go to [Phabricator](https://our.intern.facebook.com/intern/opensource/github/pull_request/584247051730122/int_phab) to review.
  You need to use node 4+. Jest is not compatible with node 0.10.
  Yeah it shouldn't be mocked, that is probably the fix. Would it be possible for you to provide a repository with this code so I can see for myself what you are doing here? :)
 I'm gonna close this but will be happy to reopen once we have a repro :)
  Hello!

Which version of Jest and npm are you using? I'm fairly confident that if you are using the latest versions of Jest and babel-jest, this shouldn't be an issue.

If your problem isn't resolved by that, please post more source code and your Jest configuration, ideally even a small repo that I can use to reproduce the issue. If this turns out to be an issue with Jest, I will reopen this issue :)
 jest 0.9.3 (out next week) will contain `jest.disableAutomock` which will be hoisted above imports. It should resolve this issue.
  Hey @pvolok!

That's a great suggestion. I wanted to get started with `unmock` because it is a new API and therefore is unlikely to break any existing clients. I think hoisting `mock`, `autoMockOn` and `autoMockOff` is fine ‚Äì is this something you'd be willing to contribute to this repo? :) You can take a look at the unmock plugin which should be 90 % of what you need. We might want to rename the unmock plugin to something else however ‚Äì do you have any recommendations?

I'm a little bit worried about `setMock` because it can be set like this:

``` js
const someFn = () => { return someMock; };
jest.setMock('foo', someFn);
```

which would break if we hoisted the `setMock` call. We could make it defensive so that it only hoists `setMock` calls where the second argument is a function/arrow function ‚Äì however I'm unsure whether that is confusing. What do you think?
 Hey! Woah, this is pretty cool already but I'm really worried that hoisting everything related to `setMock` might be very problematic for us. I'd rather not do it.

I think we should build new APIs for most things that we should hoist, so we don't disrupt people who might update babel-jest and get different behavior. Unfortunately, for `jest.mock` I don't see a way of doing this, but that should be fine.

Here is my recommendation: change the `babel-plugin-jest-unmock` into a plugin that hoists:
- `jest.mock('Foo')`
- `jest.enableAutomock()`
- `jest.disableAutomock()`
- It should also work for cases like `jest.unmock('Foo').mock('Bar')`.

the latter two will be new APIs that we can add to Jest. I'm also open to give them different names :)

After we have done this, we can think about what we can do for `setMock`. The current workaround is, obviously, just to use `require`, but with the new ES2015 way of writing imports, that isn't discoverable or desirable.
 Hey! I think that should probably work. Is there a babel API for this and could you make a pull request with this feature? We should allow things like `require` inside of the module factory ‚Äì that way most people shouldn't need to reference variables from the outer scope. Also, I'd like to come up with a new name for this so that we don't mess up existing workflows. Can you imagine a name other than `setMock`? How about allowing a second argument for `mock`? That way we can roll the feature into the existing hoist plugins _and_ we'll have a concise API:

``` js
jest.mock('Foo'); // Use manual mock
jest.mock('Foo', () => {}); // Uses the provided factory; doesn't refer to non-local bindings.
```
 @thejameskyle created a proof of concept here: http://astexplorer.net/#/cpVMSKRm5y although he says @kittens will probably have a better solution for this :P
 Oh, the new API should definitely be the module factory then. :) Sorry, didn't get a chance to look at your PR _yet_ but thank you so so much for this contribution. It is awesome!
 The new version was now released as 0.10.0 and the babel-plugins are 10.0.1 :)
  Thanks! I'm sorry the tests aren't passing on Windows right now ‚Äì I'll fix them up and will start using AppVeyor for Jest soon to prevent regressions. All these tests fail simply because I didn't have windows in mind when I wrote these tests ‚Äì so Jest will work just fine on Windows :)
  You are not using Node 4. Your log **clearly** says it is Node 0.10 in the third line. Node 0.10 is not supported by jest 0.5+.
  As I pointed out before on another issue you created, this is not a help forum. Please ask questions on stackoverflow or discord: facebook.github.io/jest/support.html If the documentation isn't clear enough, please send a pull request with your suggested improvements. We always welcome any and all contributions to Jest!

In your test, you are neither correctly creating a mock nor checking for whether it was called. Here is a correct example: https://github.com/facebook/jest/blob/master/src/lib/__tests__/utils-normalizeConfig-test.js#L45-L58 As said, we'll appreciate it if you can add this to the documentation in a pull request :)
  @facebook-github-bot import
 Thanks for importing. If you are an FB employee go to [Phabricator](https://our.intern.facebook.com/intern/opensource/github/pull_request/752233024878798/int_phab) to review.
 This is lovely! Let me check whether this works well internally before merging.
 @facebook-github-bot shipit
 I made a couple of cleanups on that diff of yours, so when it syncs out it is going to look slightly different. Don't be surprised please :)

I'll tag the new release (`0.9.2`) tomorrow.
 Thanks for importing. If you are an FB employee go to [Phabricator](https://our.intern.facebook.com/intern/opensource/github/pull_request/752233024878798/int_phab) to review.
 And thanks again for your contribution, this is very much appreciated!
  Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!
 Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks!
 Thanks! I'm a little confused over babel-runtime vs. babel-polyfill. Is babel-polyfill still necessary when babel-runtime is used? Are they mutually exclusive?

Can you paste an example of what the code looked like before and after before I merge this? :)
 That's a great explanation @mbrio. Thanks so much for the fix, I'll publish a new version today or tomorrow :)
 @facebook-github-bot shipit
 Thanks for importing. If you are an FB employee go to [Phabricator](https://our.intern.facebook.com/intern/opensource/github/pull_request/184367695275856/int_phab) to review.
 @mbrio I'm unsure whether it is wise to use babel-runtime. I'm still not entirely sure whether people should use the polyfills or the runtime. It seems like babel-polyfill is what is generally recommended.

At the least, we can't use a string for the transform, we'll need to use `require('babel-plugin-transform-runtime')` instead. However, that won't work either, because when running the test, while using npm2, the `babel-runtime` node module would be part of `babel-jest` instead of the single `node_modules` folder and it will not be found by Jest. So basically that would mean that users would be required to manually install `babel-runtime`. I'm wondering whether we should revert the use of this plugin by default ‚Äì you can still add it to your `.babelrc` file for the `test` env and it will automatically be picked up by `babel-jest`.

cc @thejameskyle and @hzoo who might be able to enlighten me
 According to @thejameskyle, adding the comments should be enough so I don't think there is any need to use `babel-runtime` now? Nevertheless, as explained before, you can add babel-runtime to your `.babelrc` and it should solve your specific use case. I don't think we need to change anything in babel-jest?
 yes, I agree. If the comment printing is broken in babel, I feel like you should open an issue on the babel bug tracker for it.
  Hello, I'm not sure what "pending" means but an `x` in front of `it` or `describe` will disable the test. I think Jest counts disabled tests so and they'll show up as passed tests even though they are disabled.
 @mbrio I see. I wasn't aware of the difference between Jasmine's reporting and Jest's reporting. We never reported pending tests before (not even when Jasmine 1 was the default). Would you be interested in fixing the reporting around this so that at the end we say `2 passed, 1 pending`, for example? :)
 Fixed by #788 
  @facebook-github-bot shipit
 uh, sorry about that! I'll publish 0.9.2 sometime this week.
 Thanks for importing. If you are an FB employee go to [Phabricator](https://our.intern.facebook.com/intern/opensource/github/pull_request/537930379718893/int_phab) to review.
 Also, thanks for your contribution! :)
  Unfortunately, some modules cannot be mocked, check out http://facebook.github.io/jest/docs/manual-mocks.html#content to explain why and learn how to create a manual mock instead. In this case, you'd create a top level `__mocks__` folder with a `gcloud.js` file.
  Thank you for creating an issue but please ask questions on stackoverflow or discord: facebook.github.io/jest/support.html

An example of `toThrow` can be found in the Jasmine documentation: http://jasmine.github.io/2.0/introduction.html

``` js
expect(() => {
  throw new Error();
}).toThrow();
```

you should wrap your `resolve` function call in another function that is passed to expect.
  I love you <3
 @facebook-github-bot shipit
 Thanks for importing. If you are an FB employee go to [Phabricator](https://our.intern.facebook.com/intern/opensource/github/pull_request/101703140226255/int_phab) to review.
 Would you mind explaining to me why those ignore patterns aren't right?
 paths‚Ä¶ :confused: :question:
  Discussion: https://www.facebook.com/groups/reactnativeoss/permalink/1528961550733807/

I would like `babel-jest` and `jest`'s setup process to be simpler. It turns out that react-native plugin developers commonly ship plugins without precompiling them with babel, leaving it to react native's packager.

This changes the `preprocessorIgnorePathPatterns` config option to default to `['/node_modules/']` or an empty array when react-native is detected as part of the project. Further, I removed the `node_modules` check in babel-jest, because the preprocessor is now not called when the file is a node_module. This has the nice side-effect of _not_ copying every single node_module JS file into the cache and the files will now be read from the cache directly! For users of babel-jest, nothing will change. For people using react-native, they'll now be able to use `babel-jest` directly. For people who do not use a preprocessor, this change doesn't have an effect either. It does however change Jest for people who use a custom preprocessor. I expect that if they have something custom (like TypeScript), they won't want `node_modules` to be compiled, so the behavior change should be minimal. It is still possible to set `preprocessorIgnorePattern` to null or an empty array, to make this work.

Finally, I also moved the normalization for `babel-jest` into `utils`. The polyfills are now included even if the `scriptPreprocessor` is explicitly set to `babel-jest` and the message that babel-jest is being used is properly printed to the console. Overall, this seems more correct for people who upgrade from a previous version of Jest to Jest 0.9.0.

Note, for the future I'm planning to provide config presets, like `jest-react-native-preset`. We are quite far from that and blowing up the `normalizeConfig` function to support all this isn't too bad for now. I think this solution is quite elegant, actually.

Reviewers: @vjeux @yungsters @voideanvalue

cc @appden @ms88privat @ide @brentvatne
 @facebook-github-bot import
 Thanks for importing. If you are an FB employee go to [Phabricator](https://our.intern.facebook.com/intern/opensource/github/pull_request/205118629844202/int_phab) to review.
 @facebook-github-bot import
 Thanks for importing. If you are an FB employee go to [Phabricator](https://our.intern.facebook.com/intern/opensource/github/pull_request/205118629844202/int_phab) to review.
 @facebook-github-bot import
 Thanks for importing. If you are an FB employee go to [Phabricator](https://our.intern.facebook.com/intern/opensource/github/pull_request/205118629844202/int_phab) to review.
 Yeah, we'll certainly need some default settings in `react-native init` for Jest. This is something where I'd prefer to keep the option value to change it, though. The `preprocessorIgnorePatterns` should certainly default to `node_modules` though and this is a good excuse to make the switch from babel-jest into jest.
  Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!
 Can you explain why you made his change? `unmock` is being hoisted before `import` statements using `babel-jest` and `babel-plugin-jest-unmock`. There is no point in using `dontMock` any longer.
  Fixed in #801.
  Uh oh, that's not great! Sorry about that, 0.9.0 is pretty much a complete rewrite and some things might have gone a little bit wrong :) I'll check this out tomorrow and fix it if necessary! I'm also planning to rewrite `--watch` to be much better in the future.

For now, `jest -o` should have you covered ‚Äì it should only run tests related to your changed files :)
 Huh, that's not good! If you use strings for your `require` statements (like `require('Foo')`) jest should be able to statically analyse the dependency tree. If you can upload a repository with a repro, that would be very useful :)
 This repros for me for all files that aren't tests themselves, is that true for you too?
 Oh, `jest -o` will only work if you have changed files in your source repo. The idea is that when you change a module and then run `jest -o`, it will only run the affected tests. This is reliant on `git status`.
 will be fixed in jest 0.9.1. :)
 Yes, that is what Jest is supposed to do. In your repo example, `Counter-test` should be run when either `Counter.js` or `Counter-test.js` is changed (but not committed) in your repo. :)
 0.9.1 was published and should contain the fix.
 There is `--watchExtensions`: https://github.com/facebook/jest/blob/master/src/cli/processArgs.js#L131-L136

I agree that we should remove this config however and just use `config.moduleFileExtensions`.
  I'm pretty sure this works with jest 0.9.0. Would you mind trying with that?
 Also, in your repository, you don't need your custom preprocessor. babel-jest does exactly what your preprocessor does (it excludes node modules). You can remove it and the `scriptPreprocessor` setting in your config and it will be used automatically with jest 0.9.0.
 Good to know! Jest 0.9.0 should be 100 % more sane and not have stupid issues like this :) It also adds a few nicer APIs like `jest.fn` and `jest.unmock` :)
 I'll try to be more open about the plans around Jest and try to create more issues. One of the things I'd like to see done is add `jest-chai` as part of the modularization effort. Right now Jest supports Jasmine 1 and Jasmine 2, but there is no reason it can't support any other test assertion library ‚Äì someone just has to add it :)
 We also have a channel on discord, if you'd like to hang out there: facebook.github.io/jest/support.html :)
  I think the problem is this if-statement: https://github.com/facebook/jest/blob/master/src/HasteModuleLoader/HasteModuleLoader.js#L421-L423

in package.json:

``` js
"jest": {
  "moduleNameMapper": {
    "some regex": "path/to/some/module"
  }
}
```

will not work, but:

``` js
"jest": {
  "moduleNameMapper": {
    "some regex": "SomeProvidesModule"
  }
}
```

with SomeProvidesModule.js:

``` js
/**
 * @providesModule SomeProvidesModule
 */
module.exports = 'foo';
```

will work. We should fix this.
 Fixed in #801.
  Thanks for bringing this up, this should most certainly not be a problem and is something that should be fixed somewhere in https://github.com/facebook/node-haste

I'll take a closer look on Monday and fix this.
 Ok, found the issue, it's in node-haste ‚Äì 2.6.0 was just published a couple hours ago which breaks Jest completely and it's why you are running into this issue unfortunately. This wasn't present in 2.5.0. We'll work on a fix.
 Alright, fix is here: https://github.com/facebook/node-haste/pull/50 ‚Äì I'll tag 2.6.1 soon, when that's done I'll close this issue and you'll be able to reinstall jest-cli with the node-haste 2.6.1 dependency. I tested @AdamKyle's ToyBox repo with an empty `modulePathIgnorePattern` and it works as expected again :)
 We are good :) Just re-tried your Toy-Box example and it works with jest 0.9.0 and node-haste 2.6.1. Sorry for the hiccup!
  I literally just pushed an update that makes all of this better. I deprecated https://github.com/babel/babel-jest (and just pushed the README change, thanks for reminding me!) because it moved into this repository.

Update to 0.9.0 and babel-jest 9.0.0 and it should be good. Switch the `dontMock` to `unmock` too! The website received a huge update with all the new info: facebook.github.io/jest/ ‚Äì please read the new Getting Started guide :)
 `babel-jest` is auto-detected now and 9.0 is on npm: https://www.npmjs.com/package/babel-jest

I'm unsure what's going on. Can you paste your `jest` config from your `package.json` file? If you clone the jest repository and go into `examples/react` ( https://github.com/facebook/jest/tree/master/examples/react ) you can see how it is supposed to work. babel-jest and jest-cli are installed alongside each other, and as long as `babel-jest` can be resolved from your `rootDir`, it should get auto-detected and will work properly.
 @AdamKyle would you mind posting your updated package.json?

@ms88privat would you mind also pasting your package.json? Your directory structure would also be good to know, for example, where is your `.babelrc` (and what is in it) and what does `require.resolve('babel-jest')` give you from the root of your project?

Also, please remove `scriptPreprocessor` from your setup, if you are using `babel-jest` 9.0.

Please make sure you are using `babel-jest 9.0.0`. Before this version, `unmock` will not work properly. This was published just a few hours ago (right around when this issue was created :) ).

I'm also planning to update the docs on react-native testing soon. @ms88privat thanks for linking that page, I wasn't aware that react-native had their own page on testing, which is now outdated with `jest 0.9.0` :)
 You have a custom setup for `scriptPreprocessor` which will overwrite `babel-jest`. My recommendation is to follow the babel-jest setup guide in the Getting Started section: https://facebook.github.io/jest/docs/getting-started.html#babel-integration

After you are done, I recommend installing the react-native preset: `npm install --save-dev babel-preset-react-native` and adding it to your `.babelrc`. This should be enough to make Jest work. As said, I will add documentation for this when I get to work next week ‚Äì so there'll be more info on this for react-native specifically soon.

If you, for some reason, don't want to go through this, then you cannot use `jest.unmock` together with `import` statements. Your test files will then have to use `require` instead:

``` js
jest.unmock('Foo');

const Foo = require('Foo');
```

The reason this is, is because `babel-jest` 9.0.0 brings in the `babel-plugin-jest-unmock` with it that hoists `unmock` calls before `import`s. Without this, an import is run before an unmock call and is therefore not mocked.

Yet another solution, if you are using Jest 0.9.0 and you don't want to use automocking, you can set `automock` to `off` in the config. However, I haven't tried that on react-native yet.

Is that helpful for now? As said, there'll be more documentation soon.
 The react example ( https://github.com/facebook/jest/tree/master/examples/react ) I mentioned earlier does this with the correct setup and it works. I'm afraid I can't help you unless you push a repro somewhere on github that I can take a look at. I'm pretty sure this is some sort of configuration issue on your part.
 Oh, I think I know why this has happened: Jest uses caching, and when you added a `.babelrc`, it wasn't recognized. Can you try again adding a `.babelrc`file **with** the es2015 preset and running Jest with `--no-cache` once? That should make sure that config changes are properly picked up :) Without the es2015 preset, import/export will definitely not work.
 thank you. That was very useful. The problem was that react-native was required but it wasn't being processed by `babel-jest`. I actually was unaware that we aren't shipping a compiled version of react-native on npm. You can update `babel-jest` to `9.0.1` and it should work properly. Thanks for creating a repro, that was great!
 @nitsujri hey! Not sure if you are using react-native or react, but whichever one you are using needs to be part of your `unmockedModulePathPatterns` or you need to call `jest.unmock('react-native')` before importing it.

Sorry, I still didn't have enough time to polish up the docs for react-native :)
 Yep, working on it as hard as I can! :)
 The fix is probably going to look something like this as part of the "jest" config in `package.json`:

``` js
  "haste": {
      "defaultPlatform": "ios",
      "platforms": [
        "ios",
        "android"
      ],
      "providesModuleNodeModules": [
        "react-native"
      ]
    }
```

It may not work with 0.10.0 yet, but there will be point releases in which I'll make it work soon.
  try this:

```
var app;
expect('foo', function() {
  it('works', function() {
    jest.setMock('../config', {dev: false});
    app = require('../app');

    expect(app()).toEqual('pro info');
  });
});
```

In your example you required app, which then requires config and it keeps it there. You later set the mock for config which will only work for subsequent requires. To illustrate, here is a simplified example:

```
var foo = require('foo');
jest.setMock('foo', myMockForFoo);
console.log(foo) // this is still the original variable because we can't directly swap out what the foo variable refers to.
```
  Check out https://github.com/facebook/react-native/blob/master/package.json#L16-L19 and https://github.com/facebook/react-native/blob/master/Libraries/Image/GlobalImageStub.js on how to set this up.
  @yaycmyk would you mind taking a look at this? Seems like the remaining code blocker (besides documentation and all :) ).
 It looks to me like your example isn't in a `__tests__` folder. Jest requires tests to be in a folder named `__tests__`. I'll be happy to reopen if this is actually broken on Windows.
  This should be fixed with jest 0.9.0-fb3 (`jest-cli@next`). It isn't officially tagged as 0.9 yet but you can try it out. Also add `babel-preset-jest` to your transforms and check out the new `examples/react` folder here: https://github.com/facebook/jest/tree/master/examples/react. With these new features applied, change your `jest.dontMock()` calls to `jest.unmock` and it should work.

Let me know if it doesn't and I'll reopen this issue.
  I'm currently working on improving the testing setup guide for react-native, I'll update this task soon with new information.
  thanks!
  Thank you! I'm currently rewriting all docs fort he 0.9.0 release so I can't merge this right now but I'll include your suggestions.
 whenever 0.9.0 is ready :) It'll be soon!
  You are right, we probably don't need to run coverage on test files. Fixed in #759.
  This is awesome! Thank you! I'm going to try to land this but the examples are not imported at FB so the typo fix there might not sync out properly and I might have to do that in a follow up.
 @facebook-github-bot import
 Thanks for importing. If you are an FB employee go to [Phabricator](https://our.intern.facebook.com/intern/opensource/github/pull_request/1087453194610072/int_phab) to review.
 @facebook-github-bot shipit
 Thanks for importing. If you are an FB employee go to [Phabricator](https://our.intern.facebook.com/intern/opensource/github/pull_request/1087453194610072/int_phab) to review.
 What do you mean exactly? :) Feel free to make any updates to the docs! I myself will start improving them sometime next week, at last :)
 yeah, this is some internal syncing thing because we actually import this into our giant repo at FB and then export it and I didn't import the examples. If you don't mind sending a PR for that typo, I'd appreciate it :)
  I think we are gonna go with #720 instead as @yaycmyk and I discussed a few days ago. This is mostly to not incur technical debt. I'll clean up all related tests at FB that might fail as a result of this.
 The idea is to make jest more modular and at some point make the jsdom environment its own npm package. You can then opt to install your own version of it if you wish and also we can add more options to that. Right now, you can specify `testEnvironment` with a full path and that can be your own implementation of JSDOMEnvironment. I think that should be enough.
  This is very useful for turning on specific babel transforms in jest 0.9.0: https://github.com/facebook/jest/blob/master/examples/react/.babelrc#L4

This convention is also used by frameworks like Relay, see https://github.com/facebook/relay/blob/master/package.json#L26 and it is confusing not to have this.

The default can be overwritten by defining the `NODE_ENV` environment variable before calling jest, so `NODE_ENV=prod jest` will continue to work.
 @facebook-github-bot import
 Thanks for importing. If you are an FB employee go to [Phabricator](https://our.intern.facebook.com/intern/opensource/github/pull_request/581009152051702/int_phab) to review.
 @yaycmyk by both ways you mean it works on windows and linux/mac?
  This adds two new packages as part of Jest's modularization effort. One of them is a babel plugin to hoist calls to the new `jest.unmock` API in order to make `import` statements work properly with unmocking behavior. The old API `dontMock` will not be hoisted and serve as an escape hatch. Note that this transform hoists every `jest.unmock` call to the top of their scope. I will also update the documentation (separately) to highlight this new feature for the new 0.9.0 release. I will pull in `babel-jest` into the jest repo and make this transform a default in a follow-up diff as well. If you'd like to try out this feature immediately, install `jest-cli@next` and add `babel-preset-jest` to your `.babelrc` file.

See http://astexplorer.net/#/SSAVF697Ro/4

cc @davidbarton @sameoldmadness @jeffcarp
cc @kittens
 @sameoldmadness both of the problems outlined in #634 are already fixed in `0.9.0-fb3`, tagged as `jest-cli@next` ‚Äì feel free to try that out :) Check https://github.com/facebook/jest/commit/a203d85570fd2f9c22c2a0236ea170fa9407e2c9 and https://github.com/facebook/jest/commit/68c21626b614f0db4ea88662a4b9c60bb1c8e3e1
 @facebook-github-bot import
 Thanks for importing. If you are an FB employee go to [Phabricator](https://our.intern.facebook.com/intern/opensource/github/pull_request/1646658335587397/int_phab) to review.
 @facebook-github-bot import
 Thanks for importing. If you are an FB employee go to [Phabricator](https://our.intern.facebook.com/intern/opensource/github/pull_request/1646658335587397/int_phab) to review.
 yay! :)
  I like this solution but I'd prefer not to add a new API. Can we instead change `setMock` to handle this? `this._modules` contains a map between haste module names and their full path, so I'm afraid storing the `moduleExports` there is not an option. Can you take another look at implementing this?

One solution could be to add another instance variable `this._virtualModules` that is just a map from `moduleName` to boolean values. In `setMock` you can set it to `true` before calling `_getNormalizedModuleID`. I would then recommend in `setMock` to add an `else if` clause after the `resolve.isCore` if-statement that checks whether the module name is part of `this._virtualModules`. If it is, set the `moduleType` to virtual and return something like `'virtual' + path.delimiter + moduleName`. What do you think?
 hm, I'd prefer not having to add a new API at all. `setMock` should just know to do the right thing. It's ok to change `_getNormalizedModuleID` and all.
 @facebook-github-bot import
 Thanks for importing. If you are an FB employee go to [Phabricator](https://our.intern.facebook.com/intern/opensource/github/pull_request/523643534465764/int_phab) to review.
 We'll add this in a separate pull request. We have refactored quite a lot in Jest and this solution is not quite applicable any longer.
 Yes, it's going to be in the next release, coming out around Monday June 13th.
  Would it be possible to provide an isolated test case? Otherwise I'm unsure how to repro this :(
 Can you retry this with the final version of 0.9.0 and provide a repro if this is still an issue?
 Thanks for the repro! I'm going to take a look tomorrow and fix this if necessary. I'm wondering if it's the `.js` at the end of the require and unmock calls, it is uncommon to do that in CommonJS.

We did fix some issues with mocking and yes, we did switch to jasmine 2, which might be the source of your trouble. Would you mind trying to run your tests again with `--testRunner=jasmine1` to see if this is a difference in the test framework? If you'd like to stay with jasmine1, it will continue to be supported and you can set the testRunner in the config.

Does your last test hang when you run it? I'm wondering if Jasmine changed to not throw in-line immediately, which would basically result in an infinite loop because `token !== null` will always be true.

Lastly, would it be possible to create a repository with these repros so that I can get a full picture of your setup? That will most certainly help me resolve this issue.

0.9.0 is pretty much a complete rewrite of Jest (see https://github.com/facebook/jest/blob/master/CHANGELOG.md#090 ) ‚Äì so there might be some hiccups, and I'm sorry about that. It is hard to make sure everything is fine with all the possible setups that are out there. I'll make sure we add a regression test for this, if it turns out to be an issue with the framework.
 Thanks! That is going to be very useful for debugging :)
 Thanks @sterpe! I checked out your repo and the reason why mocking doesn't work, is because automocking is implicitly disabled and therefore everything is unmocked ‚Äì you are providing an empty array to `unmockedModulePathPatterns` which means that _nothing_ is mocked. I agree that this is confusing but currently I'm unable to make this breaking change. I'll eventually rewrite how configuration is done for Jest and fix this behavior. When I remove the option from your config, `dontMock` behaves just as expected and the test fails when the module is being mocked.

A good way to ensure whether something is mocked or not is by using `console.log`. The function/class that is mocked will have a `_isMockFunction` property attached to it.

Let me know if there are any other issues with jest 0.9.0 ‚Äì I think my explanation covers both issues that you pointed out earlier.
  Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!
 Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks!
 Hey @vdvleon,

thanks for your contribution. This is a good fix but unfortunately this code is really hot and gets run quite often. Can we make it so we explicitly list out the EventEmitter methods one-by-one? I'm aware this is more code but it is going to do way less work on every test :)

See https://github.com/nodejs/node/blob/master/lib/events.js#L57 for the list of methods that we need to bind.

I'm also thinking it might make sense to not actually pass `process` into Jest but rather provide a mock. For example you wouldn't want a test to be able to call `process.exit`. I'll think about this some more for a follow-up.
 @facebook-github-bot import
 Thank you! Not a huge fan of the space indentation but I guess it makes sense here. And yes, you should ideally mock your database but nevertheless you fixed a bug here :)
 Thanks for importing. If you are an FB employee go to [Phabricator](https://our.intern.facebook.com/intern/opensource/github/pull_request/1022501811129934/int_phab) to review.
 @facebook-github-bot shipit
 Thanks for importing. If you are an FB employee go to [Phabricator](https://our.intern.facebook.com/intern/opensource/github/pull_request/1022501811129934/int_phab) to review.
  thanks!
  I talked to @zpao a while ago and I think he said this doesn't actually matter that much. @zpao care to elaborate? Should we merge this?
 Oh, the website isn't part of our internal copy of Jest (I should import it eventually, though). Would you mind sending a separate PR for the Site.js change? Thank you!
 thanks boss!
 @facebook-github-bot shipit
 Thanks for importing. If you are an FB employee go to [Phabricator](https://our.intern.facebook.com/intern/opensource/github/pull_request/226680954342277/int_phab) to review.
  Can you try `jest-cli@next`? This bug should be fixed in the next release! And it's also much faster.
 (Let me know if this is not fixed and I'll reopen this issue :) ).
  Someone else has asked about this before. I'm a little unsure how much sense it makes for `setMock` to mock something that doesn't exist. Why exactly do you need this behavior?

I think I wouldn't be opposed to merging such a change, however. It has to include tests though ;)
 I recommend upgrading to `jest-cli@next` because it'll make your test runs way faster :)

I think what you are saying makes sense. Do you wanna cook up a PR? :)
 duplicate of #701.
  Hey! Are you using npm3? That might be it. I'm fixing this for the final 0.9.0 release.
 If you could try whether #732 solves your issue, that would be fantastic. I believe it does, so I'm gonna close out this issue but if it doesn't, I'll reopen and fix it :)
  glad this is resolved! This bug was haunting me :)
  Thank you so much for fixing windows support. I'll update node-haste inside of Jest tomorrow and merge this PR then.
 @facebook-github-bot import
 Thanks for importing. If you are an FB employee go to [Phabricator](https://our.intern.facebook.com/intern/opensource/github/pull_request/1688577981409830/int_phab) to review.
 @facebook-github-bot shipit
 Thanks for importing. If you are an FB employee go to [Phabricator](https://our.intern.facebook.com/intern/opensource/github/pull_request/1688577981409830/int_phab) to review.
  lol.
  Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!
 Thanks for troubleshooting this and sending a PR. There is a PR for node-haste which aims to fix this issue inside of node-haste which will also fix it for react-native :)

Follow along here: https://github.com/facebook/node-haste/pull/41 ‚Äì after this is done I can tag jest-cli 0.9.0 :)
  Thanks for the contribution! Would you mind adding a test for this? :)
 Awesome. Having a few hiccups internally but I'll merge this asap :)
 lovely!
 @facebook-github-bot import
 Thanks for importing. If you are an FB employee go to [Phabricator](https://our.intern.facebook.com/intern/opensource/github/pull_request/1197783656916452/int_phab) to review.
 @facebook-github-bot shipit
 Thanks for importing. If you are an FB employee go to [Phabricator](https://our.intern.facebook.com/intern/opensource/github/pull_request/1197783656916452/int_phab) to review.
 nope, just wait for the bot to close this for you.
  Thanks! Do you have any ideas as to why this might be happening or could you help troubleshooting this a bit? :)
 @yaycmyk What happens when you comment out this part: https://github.com/facebook/jest/blob/master/src/resolvers/HasteResolver.js#L117 ?
 Ah yeah, the process quit issue, we figured it out and I'll publish fb2 soon.
 I'm pretty sure this is resolved with fb2. Can you try and let me know if it is still an issue? If you are using watchman, try `--no-watchman` if it doesn't work, to double check :) Let's reopen if this still repros.
 I'm afraid without a proper repro case I can't do much. The 200ms in the example is probably just variance.
 https://github.com/facebook/relay is a good benchmark.
 thank you so much for making a repro! I'll take a look after the weekend. Would you mind telling me the difference between those two commands on your personal projects with 0.8.2? Were they both at the same (slow! :D ) speed?
 Hey @irudoy would you mind sharing what the runtime of `jest.runCLI` is on 0.8.2? If it's the same as with 0.9.0, then I'll go ahead and publish 0.9.0 and fix this bug as a follow-up patch release. Trying to get 0.9.0 out of the door first :) If you have some time to investigate why this happens yourself, that would be fantastic too. As you mentioned, it does seem like for some reason it isn't being using the preprocess-cache, so it might make sense to look into why that config is disabled.
 @irudoy is this still an issue?
  This looks really, really great. Thank you for your hard work. I can take it from here and do all the integration work with this stuff inside of www (node modules etc.), I'll try to get to it tomorrow :) Can you add me to the npm packages that you created for Jest so I can publish to them?

I think I'm going to be a bit bullish on lodash, as said I don't wanna add the dependency unless we absolutely need it ‚Äì I hope that's fine with you.
 Thanks for removing lodash. As discussed in messenger, we need some script that can set up the dev environment when someone wishes to develop Jest. I recommended taking a look at https://github.com/kittens/lerna, cc @kittens
  If only we could open source all of the Facebook JS code. We have thousands of tests and they are all depending on clowny behavior in jsdom. jsdom is getting more awesome with every release, but when they become more compliant, we have to go in and fix hundreds of tests! That's unfortunate and it'll take a little bit of time to make this (seemingly) simple update :) We are working on it!
 @facebook-github-bot import
 Thanks for importing. If you are an FB employee go to [Phabricator](https://our.intern.facebook.com/intern/opensource/github/pull_request/1554897211490466/int_phab) to review.
 I'm going to merge #873 which will split up the environments. We'll make it easier for the future to customize the env, as well. I think I'm gonna bump the jsdom version for this.
  I'm afraid I won't have time to do this myself right now. If you can make a branch from https://github.com/facebook/jest/tree/3931bb0e377cfbb6f08f041a3f98b488e79a6867, update the dependencies and package.json and let me know which branch it is on your fork, I can pull it in and tag it no problem :) You can also fork jest at that point in time and set the dependency of your jest-cli package to `git://github.com/facebook/jest.git@<commit-hash>`.
 Hm, I thought about this some more and I'm all in with 0.9 right now and I'm worried that tagging this reveals some other problems of things that happened since the 0.8.2 tag. I think it makes sense to do what I said and link to your specific commit hash in the package.json of your project.

I was also thinking of whether it makes sense to be able provide your own version of jsdom. Basically a config option `jsdom` that is a path to the jsdom node_module that you'd like to use ‚Äì that way people can decide more freely which version they want to use even if we at FB trail behind. Is this something you'd be interested in helping out with?

I'm going to close this. Sorry for the trouble but I really appreciate the contribution!
 I also wanna say I'm trying to make the 0.9 release really awesome and am spread a bit thin trying to accomplish that and maintaining our internal test infra at FB right now ‚Äì so I'm mostly just worried that tagging 0.8.3 would be a distraction, I hope that is understandable :)
 There is already and experimental setting that you can use to include your own environment for your tests :)
  Do they both have an `@providesModule` header with the same name?
 Yeah, that is the only reason. Previously in node-haste1 you'd only get one of these files in your tests and you might have been thoroughly confused in the past! :)

Would you like to send a PR to node-haste to improve the error message, printing the `name` and that it is related to `@providesModule`? See https://github.com/facebook/node-haste/blob/master/src/DependencyGraph/HasteMap.js#L133 :)
 Fixed in 0.9.0-fb2, going out in a bit.
  What happens when you do this:

``` js
Object.defineProperty(window.navigator, 'userAgent', {value: '....'});
```

?
 This workaround should work.
  Thanks! I'll merge it once I figure out our www woes :)
 @facebook-github-bot import
 Thanks for importing. If you are an FB employee go to [Phabricator](https://our.intern.facebook.com/intern/opensource/github/pull_request/1651878958410281/int_phab) to review.
 Well lucky me, it turns out I am a Facebook employee!
 @facebook-github-bot shipit
 Thanks for importing. If you are an FB employee go to [Phabricator](https://our.intern.facebook.com/intern/opensource/github/pull_request/1651878958410281/int_phab) to review.
  Can you share a repro so I can take a look into this? Which OS are you using? Do you have watchman installed?
 I think the problem is Windows. Right now there is some issue with file paths on windows in the 0.9 branch unfortunately. If you have some time it would be fantastic if you could dig in and send a PR! I currently don't have access to a windows machine and your help would be greatly appreciated and would mean 0.9.0 will be released much faster :)
 This is the only remaining blocker for tagging jest 0.9 and is why I tagged it as `fb-1` ‚Äì it's mostly internal :) Any help is greatly appreciated!
 Should be fixed after all the work by @yaycmyk 
  I guess it makes sense to disable `watchman` on travis. Can you test whether calling Jest with `--no-watchman` solves this issue? If yes, I can add this to jest.
 I'm gonna close this, let's try 0.9.0-fb2 and reopen if it is still a problem.
  I cannot believe this was never an issue before? wtf.?
 @facebook-github-bot import
 Thanks for importing. If you are an FB employee go to https://our.intern.facebook.com/intern/opensource/github/pull_request/680807545393429/int_phab to review.
 Yep, fixing that one is next on my list :)
 Now that #599 is landed I can finally get to some of those silly bugs we have in open source Jest :)
 @mgenev that is what automocking does. A mock of an array is an empty array. You can fill it out with a manual mock or explicit mock. This is expected. If this is not what you want, I recommend disabling automocking.
  @jamedranoa yes, I plan on eventually removing this check. Unfortunately we have a shitload of tests at FB that depend on this behavior. My goal is to unfork jasmine eventually though, it'll happen in the next few months.
 @scsper we still have plans, but there's still too many FB tests that depend on this behavior, so it's not going to happen soon :/  I think I'm going to remove it from the docs for now until someone will help integrate it better in 0.9. Thanks for pointing this out.
 No loaders are needed. Jest and webpack are completely individual tools. `jest` is run when you invoke it yourself.
 People use complicated webpack configs that don't translate well to tools that are not based on webpack. If you have a complex configuration with webpack, this tutorial will help you create a similar setup for Jest.
  Wait, this is weird. When do you get an object instead of undefined? It should only be an object when the option is explicitly provided in your config. If it isn't provided, it should be undefined.
 Should be fixed by #599. Thanks for your contribution.
 You can try `jest-cli@next` and see if that fixes your issue. It'll also make your test runs 2-4x faster :)
  You can load jQuery in a setup file, see https://facebook.github.io/jest/docs/api.html#config-setupenvscriptfile-string

``` js
window.$ = require('path/to/jquery');
```

for example.
  Did you switch to npm3? You might have to unmock `fbjs` as well as react :) This is unlikely a Jest issue and I'll close this issue but feel free to comment here if you can't resolve your issue.
 Can you do `rm -rf node_modules/jest-cli/.haste_cache` and retry the run?
 I'm quite convinced that the problem is npm3 here and that fbjs is being mocked when it should be unmocked. Are you certain you put `fbjs` in the `unmockedModulePathPatterns` setting?
 The culprit is likely the `keyMirror` file. Do you have more than one `keyMirror.js` file in all of your node_modules? Also, feel free to join #jest on discord (See facebook.github.io/jest/support.html ) so we can troubleshoot this more easily.
 The problem was having multiple keyMirror.js files in various other npm modules, and node-haste picks them all up (at random). #599 will solve this and be merged today. In the meantime I recommend unmocking everything that also depends on keyMirror.js:

Here is a copy of our conversation on the chat:
![Imgur](http://i.imgur.com/gGFpObi.png)
 This is definitely fixed in jest-cli@0.9.0-fb3, at last :)
  `jest.addMatchers` doesn't exist any more with jasmine2. The solution, as you found, is to use `jasmine.addMatchers`. Thank you for the report!
 Since I guess we are still supporting jasmine1, we should keep the `jest.addMatchers` API around and just make it work for jasmine2, fixed here 2d10421baf79081ce698791023360144fb595a27
  Can you paste your package.json?
 I don't really know how npm works on windows but `npm install jest-cli` should create a symlink in `node_modules/.bin/jest` that you can use to run your scripts. If this doesn't work, your setup might be broken.

This issue seems unrelated to Jest, so I'm going to close it.
  Yes, this is going to be solved with #599. I am optimizing perf like crazy in that PR and node-haste2 (see https://github.com/facebook/node-haste ). The next version of jest is going to be as fast as a test framework can possibly be. The runtime of the Relay test suite is going down from 60-100s to 20s.

I'll close this issue because it isn't actionable in light of #599. I'm going to merge it as soon as I can fix everything up around Facebook's test infra integration :)
 It's needed for facebook and our open source projects to resolve `@providesModule` headers inside of modules, mostly.
  I think that makes sense. I'll consider this for integration after I merge #599.
 This will be fixed in jest 0.9.0 with the new `babel-preset-jest` and `babel-jest` integration. See https://github.com/facebook/jest/tree/master/examples/react for how this will work.
  If you aren't requiring react-native anywhere in the dependency tree of your test, there is no point in mocking it. Just remove that line.
 In that case I will recommend to put react-native into the devDependencies of your project, does that make sense?
 Another solution that should work is to create a file `react-native.js` in a `__mocks__` folder, effectively making it a "free mock" that only exists for test purposes. We do this at Facebook to stub out certain network data.

`setMock` is more strict. If you use it, you are explicitly saying "this module exists in my dependency tree and I would like it to be mocked". If it then doesn't exist, you have dead code in your test which might be confusing.

Does this explanation make more sense? :) I'm willing to change my mind on this but we had _many_ invalid callers to setMock in our tests and it is overall just a mess.
 I'm also not 100 % set on this. If you feel strongly and want to send a pull requests, by all means, go for it :)
 @mc-zone in Jest 0.9 errors should properly be rethrown, that was an unfortunate bug :)

@vitalets I think we are going to add a recursive option to `setMock`. Planning to merge it soon :)
 cc @valerybugakov ‚Äì is this something you'd like to look into?

We should add this to `jest.mock` which now supports two arguments. I don't think we should add it to `jest.setMock`, I consider it a bit deprecated.
 This will be fixed in the next Jest release. Awesome work @valerybugakov, thank you so so much for your contributions!
  https://hosain.net/2016/01/31/unit-testing-react-native-components.html is this helping? :)
  I'd recommend unmocking it. You can put `gulp-util` into unmockedModulePathPatterns and it'll work.
 Are you using npm3? In that case, for now, you'll also need to put chalk and has-ansi into the unmocked patterns.
 npm3 fiasco and Jest hasn't entirely caught up to that yet. I'm working on it though :)

I'll close this out as I'm sure you can fix it by unmocking all the node_modules as I listed. The npm3 issue is tracked somewhere else and will be resolved soon.
  Hey! This is an intentional API change. Jasmine 2 has `fit` and `fdescribe`, meaning `focused it` and `focused describe` instead.
 Jest parallelizes test runs and it doesn't know upfront which tests it should run and which it shouldn't run. This means when you use "fit", it will only run one test in that file but still run all other test files in your project. `fit` should only be used for debugging purposes, so I recommend invoking jest with `jest MyTest.js`, which will only run one file and the one test within it.
 You can pass `-i` for that, but jest still won't know that only one test will be run. I don't think there is a good way to fix this issue although I'm open to ideas :) I'll be restructuring how tests are being run and provide a better implementation of `--watch` to improve the developer ergonomics around this.
 That is not possible because Jest isolates test files into separate environments. Of course, that could be disabled using a different param, but then you'd have to pass another cli option. Internally we have a `--spec` option which could be useful for this as well.
 Yup, you can do this but the question is whether it is worth it. At FB we have thousands of tests and doing static analysis to figure out whether only one tests needs to be run would likely take about 1/3 of the entire test runtime. For small projects the overhead isn't big, so this makes sense. I'm hoping to modularize more pieces of Jest so you can pull out the parts of jest that give you, for example, all the valid test files.
 Yes, for continuous integration we do. Locally, people run `jest --onlyChanged` which will only run test files related to changed files.
 Yes it is part of Jest. We use node-haste for dependency management and have a reverse dependency lookup algorithm. In #599 I've written a new implementation of this algorithm which works better than previously.
  Can you add a test and give me an example of how this is going wrong currently?
 Woah, JavaScript is so weird :)

Thanks for the fix!
 So.. Safari doesn't use "bound", node 0.10 only does "bound foo" and Chrome/node 4+ do "bound bound foo". Good to know!
 @facebook-github-bot import
 Thanks for importing. If you are an FB employee go to https://our.intern.facebook.com/intern/opensource/github/pull_request/178310525868031/int_phab to review.
 Thanks for the fix! I updated it with a more performant implementation because this is super-hot-code.
 @facebook-github-bot shipit
 Thanks for importing. If you are an FB employee go to https://our.intern.facebook.com/intern/opensource/github/pull_request/178310525868031/int_phab to review.
  Yes, keyMirror needs to be unmocked to make this work.
  can you `console.log(Object.create)`? Are you overwriting it with your own implementation that is being mocked?

(I'm closing this because it is likely not an issue with jest and more like a question, but happy to reopen if it turns out to be one :) )
 @Sebmaster thanks for the explanation! I don't normally pass anything other than null to Object.create.
  Yes, you cannot use `jest.autoMockOff` before an `import` statement because the `import` is being hoisted above all other code as per the ES2015 spec. Using `require` is the correct workaround here.

In Jest 0.9.0 you'll be able to set `automock` to `false` in the config. Another solution is to create a setup file with `jest.autoMockOff()` because that will run before the test file :)
  This will be fixed in #741.
  Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!
 Is there a reason why you are creating and instantly closing pull requests?
  `testPathDirs` is stupid and doesn't make any sense. I'll fix it soon. The startup time will be fixed by #599. You can artificially speed it up by putting certain node_modules into the `modulePathIgnorePatterns` config.
 This should be resolved with #599. Give it a try!
  The error message for this should be improved in `jest 0.9.0` (released soon) so this will no longer be necessary.
  @yborunov can you try again with Jest 0.9? I think this problem should be fixed with the latest version.

If this issue hasn't been fixed it would be great if you could provide a repository with this issue and I'll be happy to reopen and fix this issue :)
  There is no real reason to include this because it just maps to `console.log`. I actually didn't even know it existed. If you need this, I'd recommend doing `console.debug = console.log` in your setup env file or in the beforeEach call of your associated test. I don't think I'll add this to jest.
  Can you retry this with `jest-cli@next`? :)
 This should be fixed in the next version.
  I'm going to update all the docs and examples for the 0.9.0 release!
  Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!
 Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks!
 Yeah this sucks and was a change in babel 6 that I didn't anticipate. There are a number of ways to fix it and I haven't settled on one yet.
 I'm fixing this right now and I'll have more info later today actually :) There'll be a babel transform + npm3 and mocking issues. Some of this can already be found in `jest-cli@next`.
 Closing this in favor of #741. As promised!
 @5amfung I recommend unmocking the parse SDK. With jest 0.9 you should be getting a helpful message linking you to  http://facebook.github.io/jest/docs/manual-mocks.html

For unmocking, see: http://facebook.github.io/jest/docs/api.html#config-unmockedmodulepathpatterns-array-string

Put `node_modules/parse` or `node_modules/parse-sdk` into the `unmockedModulePathPatterns` config option (or whatever else matches the parse SDK). You can also do `jest.unmock('my-npm-package-name')`.
 It helps to add a `"__DEV__": true` to the `globals` config object or set it in a setup file (see the documentation on `setupFiles`. It is a common FB convention, I'm wondering whether I should just make this a default in Jest eventually‚Ä¶
  Fixed in #599 in `jest-cli@next`.
  The error message will link to http://facebook.github.io/jest/docs/manual-mocks.html#content in 0.9.0. Some modules use meta programming and can't properly be mocked. The guide should have examples on how to work around it.

Jest 0.9.0 also has better mocking capabilities, so this issue might go away for your modules.
  Feel free to send a pull request to add support for this in jest. I'm unlikely going to get to this and will close this issue to better keep track of things we'll be focusing on.
  Yeah I think this is unrelated to Jest. Either an istanbul or a babel issue, I'm afraid.
  @facebook-github-bot shipit
 Thanks for importing. If you are an FB employee go to https://our.intern.facebook.com/intern/opensource/github/pull_request/1511496782479314/int_phab to review.
 Thanks @epriestley! May the Internet points be with him. To the best of my knowledge, the time range in our license and copyright headers are of little significance.
  Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!
 Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks!
 Nice! I didn't know about `--relative`. I have a fix for this in #599 as well.
 @facebook-github-bot shipit
 Thanks for importing. If you are an FB employee go to https://our.intern.facebook.com/intern/opensource/github/pull_request/873809362738202/int_phab to review.
  I'll reopen the other issue.
  I think you have to call `jest.runAllTimers` because bluebird uses asap/setImmediate. Can you try that and reopen if it is still an issue?
 which kind of Promise implementation are you using? If you are using the native promise implementation, this may not work as expected. You might have to use `pit`, return the promise and use `then` to chain expect calls:

``` js
pit('works', () => {
  return somethingThatReturnsAPromise()
    .then(a => expect(a).toEqual(b));
});
```

for example.
 I think this is unrelated to Jest. You are probably using the native promise _somewhere_ (in another node_module that is a dependency?) and it was introduced in node 4, which is why you are not seeing it anymore past jest 0.4.
 I'm a little unsure how that would work. Maybe `process.nextTick()` is enough?
 I think these issues might come up because you might be using _different_ promise implementations in different node_modules or parts of your application. We had this problem somewhere in react-native as well. One fix could be to do `global.Promise = require('my-promise-impl')` and potentially stub out all the other promise modules that might be included transitively by other node_modules with that same implementation.
  can you make an isolated example of this failure so I can repro? This shouldn't happen and definitely works for all repos at FB! Are you using the native Promise object in your code or using a polyfill?
 Seems like you found an actual bug in your code with Jest, then ;)
  This is almost certainly a bug. Can you publish a test repository with a repro for me so I can fix this?
 Sorry for not getting back to you earlier but this issue should be resolved in jest 0.9.0. I think you might have been using npm3 or deduped some npm2 dependencies because your repro passes just fine for me. See #554  #732 #737

Let me know if this is not fixed when using `jest-cli@next` and I will reopen and investigate again.
  @facebook-github-bot shipit
 thanks! :)
 Thanks for importing. If you are an FB employee go to https://our.intern.facebook.com/intern/opensource/github/pull_request/964503953624168/int_phab to review.
  This is an issue tracker, not a help form. Please use stackoverflow or join us on discord. I'm cc'ing @gaearon in case he has some insight.
  If you are using babel 6, for now you'll have to do `require('Item').default` in your test. This is annoying and going to be fixed soon.
  @frantic @martinbigio did we change how we do relative images in react-native?
 This should work using `jest@next`, fixed in #599.
 Currently working on a fix but it breaks some internals.
 This'll be fixed in the next release! Thanks @jonesdar for helping to troubleshoot it.

See https://github.com/facebook/jest/commit/b01ab18e0c703a715302a6959e3fca9e6b0260cf
 0.10.0 has been released with a fix for this :)
  @facebook-github-bot import
 Thanks for importing. If you are an FB employee go to https://our.intern.facebook.com/intern/opensource/github/pull_request/616899061782180/int_phab to review.
 @facebook-github-bot shipit
 Thanks for importing. If you are an FB employee go to https://our.intern.facebook.com/intern/opensource/github/pull_request/616899061782180/int_phab to review.
  Hey @bigblind. This is a good point but this is actually by design and JS doesn't really allow to call the constructor with variadic arguments and a bound context. I think the wrapper you have is the only proper way to solve this for now.
  Please upgrade node to 0.8.2. This is unlikely a bug in Jest and stack overflow is a better place to ask questions.
  duplicate of #717.
  This is an issue tracker, not a help forum. Please post your question on stackoverflow or ask in the #jest channel on reactiflux.
  This is a question, not an issue with jest. If you wan to test Relay components I would recommend not trying to render them using a root container but instead rendering the RelayContainer with fake data. Another solution is to write a mock for Relay's network layer to inject your own data.
 cc @yuzhi do you know how to test a Relay.RootContainer properly in a test? :)
  Yes I agree! Setup and config should be completed rewritten and documented properly. I'm going to work on this in the near future.
 See #763.

Feel free to help add more documentation after that PR merges :)
  I don't think this is actually the right fix at the moment. I have made a similar change in #599 which I will eventually pull in but for now I don't see how this change does what you suggested in the summary of your PR. The change you made changes Jest to collect coverage for all files when coverage is enabled.
  Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!
 Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks!
 exciting! Thanks for your contribution.
 @facebook-github-bot shipit
 Thanks for importing. If you are an FB employee go to https://our.intern.facebook.com/intern/opensource/github/pull_request/193812930967604/int_phab to review.
  Does this also happen with jasmine2? You can switch out the runner using this option: http://facebook.github.io/jest/docs/api.html#config-testrunner-string
 This was fixed in a19544fad5ac497c9ceaf65e568c393f5fb6fa56.
Thank you for reporting!
  This should definitely be fixed with #599.
  thanks!
 @facebook-github-bot shipit
 Thanks for importing. If you are an FB employee go to https://our.intern.facebook.com/intern/opensource/github/pull_request/982459011800053/int_phab to review.
  I think it is enough to set this on a per-test level. This already works. If you need it in every test you can set it in the setup-env file.
 Sorry, I mean the `setupFiles` config option: http://facebook.github.io/jest/docs/api.html#setupfiles-array
 Phew, I'm sorry again. `setupFiles` actually runs before we set-up jasmine. We have `setupTestFrameworkScriptFile` which runs after jasmine and before your test.
 Somebody should send a PR for `jest.setTestTimeout(time)` so we have an official forward-looking API for this.
  This should no longer be an issue. With the latest version of Jest you might have to add this to a react-native project: https://github.com/fbsamples/f8app/blob/master/package.json#L51-L60
  Hey @ncuillery,

that sounds like a great idea. Unfortunately I'm unlikely to have time to work on this _soon_. Maybe some time in January. If you'd like to take a stab at this, feel free to send a pull request against #599, which is a new implementation for the module resolver (note that it is a moving target and I'm still changing a lot of things around).

Overall, I agree that (auto)mocking can be very confusing and you did a great job outlining that in your original post. I'll appreciate any proposals you might have to simplify how mocking works.
 Now that we disabled automocking by default I don't think we'll actively invest in building this.
  @facebook-github-bot shipit
 Thanks for importing. If you are an FB employee go to https://our.intern.facebook.com/intern/opensource/github/pull_request/1644409495816392/int_phab to review.
  Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!
 Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks!
 thanks!
 @facebook-github-bot shipit
 Thanks for importing. If you are an FB employee go to https://our.intern.facebook.com/intern/opensource/github/pull_request/510911255754683/int_phab to review.
  Unfortunately jest 0.4 is at the end of its lifetime and there won't be a new release unless there is some form of security issue which is highly unlikely. I suggest to try to convince your company to update to node 4 which is well worth the investment. We have completely rewritten jest since the last 0.4 update and made significant improvements, see https://github.com/facebook/jest/blob/master/CHANGELOG.md

If that proves impossible there is nothing wrong with updating jest in your own fork in whichever way you'd like and locking the `jest-cli` version number to a specific git hash from your fork.
  Yes, babel6 changed its behavior. We'll fix this soon.
  It doesn't seem like you have set up babel-jest or your own preprocessor correctly. Please see the documentation but this doesn't seem like a bug in jest. Appropriate places to ask for help are the discord channel or stackoverflow.
  The test directory cannot contain the rootDir at the moment. I am planning to redo configuration and will enable this kind of behavior in the future.
 I don't think there is a good way to do this right now. I'm sorry, it is definitely planned though.
  Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!
 Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks!
 thank you!
 @facebook-github-bot shipit
 Thanks for importing. If you are an FB employee go to https://our.intern.facebook.com/intern/opensource/github/pull_request/530548183779230/int_phab to review.
  @facebook-github-bot shipit
 Thanks for importing. If you are an FB employee go to https://our.intern.facebook.com/intern/opensource/github/pull_request/1515139805450859/int_phab to review.
 Thanks for importing. If you are an FB employee go to https://our.intern.facebook.com/intern/opensource/github/pull_request/1515139805450859/int_phab to review.
 pushed directly.
  Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!
 Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks!
 I'll take a look to see if this works internally :) I'm a bit worried about error reporting though; if a file throws now it won't use the correct file name in the stack trace, will it? That actually seems like a dealbreaker to me.
 but try-catch is slooooow.
 Woah. If this is true it will most certainly convince me.
 I tried it and it breaks one test which is likely doing weird things and I can fix that.

Other than that it works well, performance is about 5 % faster on a full test run, so not enough to convince me. Are you willing on working on the stack trace thing? The problem is that code that throws after it has been evaluated will also yield the wrong stack trace ‚Äì which is kind of a deal breaker. If you can figure out a good way to make all the stack traces be as they are now I'd be happy to switch to eval, otherwise I'm afraid I can't merge this.
 awesome!
 @facebook-github-bot import
 Thanks for importing. If you are an FB employee go to https://our.intern.facebook.com/intern/opensource/github/pull_request/180110725671252/int_phab to review.
 @Sebmaster unfortunately it still does change the behavior a tiny little bit, compare:

diff applied:

```
 FAIL  scripts/third_party/babel-relay-plugin/src/__tests__/BuildChecker-test.js
‚óè babel-relay-plugin ‚Ä∫ it has been built properly
  - Expected `src/RelayQLAST.js` to transform into `lib/RelayQLAST.js`. Try running: npm run build
        at eval (scripts/third_party/babel-relay-plugin/src/__tests__/BuildChecker-test.js:67:17)
        at Array.forEach (native)
        at eval (scripts/third_party/babel-relay-plugin/src/__tests__/BuildChecker-test.js:61:36)
        at Array.forEach (native)
        at Object.eval (scripts/third_party/babel-relay-plugin/src/__tests__/BuildChecker-test.js:57:14)
        at process._tickCallback (node.js:366:9)
```

before:

```
 FAIL  scripts/third_party/babel-relay-plugin/src/__tests__/BuildChecker-test.js (3.356s)
‚óè babel-relay-plugin ‚Ä∫ it has been built properly
  - Expected `src/RelayQLAST.js` to transform into `lib/RelayQLAST.js`. Try running: npm run build
        at scripts/third_party/babel-relay-plugin/src/__tests__/BuildChecker-test.js:66:17
        at Array.forEach (native)
        at scripts/third_party/babel-relay-plugin/src/__tests__/BuildChecker-test.js:60:36
        at Array.forEach (native)
        at Object.<anonymous> (scripts/third_party/babel-relay-plugin/src/__tests__/BuildChecker-test.js:56:14)
```

Because of the newline you added in eval, all the line numbers are incorrect. I don't really mind that `eval` shows up in the stack trace but I do mind about the line numbers. If you can fix this, I'll merge your change.

Also, since you are changing the private API use, can you update the package json to use jsdom `^7.2.0`? :)
 @facebook-github-bot import
 Thanks for importing. If you are an FB employee go to https://our.intern.facebook.com/intern/opensource/github/pull_request/180110725671252/int_phab to review.
 @facebook-github-bot import
 Thanks for importing. If you are an FB employee go to https://our.intern.facebook.com/intern/opensource/github/pull_request/180110725671252/int_phab to review.
 @facebook-github-bot shipit
 Thanks for importing. If you are an FB employee go to https://our.intern.facebook.com/intern/opensource/github/pull_request/180110725671252/int_phab to review.
  Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!
 Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks!
 When I have time to fix it, which depends on when #599 is done. I have 6 more work days this year and if I can't finish haste2, I'll have to fix this properly next year. If you want to contribute, we know what kind of fix we'd like to see. Feel free to join us on discord (google reactiflux and join #jest) and talk to me about it :)
 This will be fixed in 0.9.0. See #741.
  That sounds like a bug!
 Fix is landing now.
  Hey! Which version of node, npm and jest are you using?
 This is not great. Can you try running jest with `--coverage` and tell me if it yields something different? Can you maybe create a reduced example that I can dig into to figure out what is wrong?
 Fixed by 0.9.0.
  Can you explain how this is used in some modules that you are trying to test? I don't think forwarding `require.extensions` and `require.cache` is what you wanna do here. `jest` uses its own require system and I don't want the parent one to leak into test contexts. I think the right solution here would be to add stubs, like `require.cache = Object.create(null);` and `require.extensions = Object.create(null);`.
 Thank you!
 @facebook-github-bot shipit
 Does the GitHub bot take weekends off? cc @vjeux 
 it's all green :(
 @facebook-github-bot shipit
 it is creating the internal diff but not stamping/shipping :(
 Something here is going awfully wrong with our GitHub bot. I'll pull this in manually.
  Closing this in favor of #741.

I'll overhaul the examples and the docs around this, mentioning all the fixes to mocking and npm3 as well. Thanks for your contribution and sorry for making you wait so long. If you'd like to help improve the documentation and revert your changes to `module.exports`, I'd be happy to merge :)
 @jeffcarp no! Check out this updated example: https://github.com/facebook/jest/tree/master/examples/react ‚Äì this is exactly what the docs for react should be like now :)
 If you'd like to send a new PR that reflects exactly the example from `examples/react`, that would be appreciated :)
  Did you resolve your issue? It seems like the starter kit now has 0.15 in it?
 this should work now.
  Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!
 Thanks for the contribution! Please sign the CLA so I can merge this. I left a couple of inline comments but generally, would you mind adjusting the code style to fit with jest's style? It is mostly about whitespace, see:

```
if (foo !== bar) {

}

// instead of
if(foo!==bar){

}
```
 Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks!
 Merged in https://github.com/facebook/jest/commit/17f61adf297e2005ba6ef99d94b8be6317f958fb

Thank you for your contribution!
  The two suggestions up there should solve your problem. Please re open if there are other problems.
  Thanks @Jarlotee, sorry for the late response, just got back from a vacation :)

I think this is related to different implementations of the History API since older versions of jsdom. I'm gonna cc @domenic and @Sebmaster on whether they have ideas on how to resolve this for testing. How is the event loop being used for hashchange events?
 I don't know where `instance` is coming from in this case. Oh, so you are saying that hashchange is fired synchronously upon setting the prop? Is that how it works in the spec?
 I'm going to assume that `setTimeout` in this case is not the fake and replaced one then?
 We already do replace setTimeout. I think this might be fixed if you change the code to do `global.setTimeout` (as in the jsdom `window` instead of calling `setTimeout`). That way, instead of using node's version, you'll be using whatever the user supplied to you. I'll try this before sending a PR to jsdom.
 https://github.com/tmpvar/jsdom/pull/1312 :)
 Fixed in 0.8.1.
  Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!
 Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks!
 Unfortunately this doesn't currently work well with `jest.dontMock` etc. because imports are hoisted. I'm hoping to solve this in the future but for now I can't merge this.
  I agree this sucks. I didn't know that how module get transpiled with babel6 has changed (should have synced up with @sebmck :) ). I think it might make sense to include https://www.npmjs.com/package/babel-plugin-add-module-exports in babel-jest for now. I'll keep thinking about this.

I want jest to be able to use ES2015 import syntax for tests too, but imports are hoisted so if you do:

``` js
jest.dontMock('foo');

import foo from 'foo';
```

will transform to

``` js
var foo = require('foo');
jest.dontMock('foo');
```

which breaks how jest works. I think it might make sense to turn hoist `jest` calls up even further but I haven't made up my mind about this completely.

I'm going to close this PR because this is not what I would like people to write and I'll figure out the fix around babel-jest.
  Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!
 Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks!
 @facebook-github-bot import
 Sorry for the late response, I was on vacation :) Pulling it in now.
 Thanks for importing. If you are an FB employee go to https://our.intern.facebook.com/intern/opensource/github/pull_request/422650044587529/int_phab to review.
 @facebook-github-bot shipit
 Thank you for the fix!
 Thanks for importing. If you are an FB employee go to https://our.intern.facebook.com/intern/opensource/github/pull_request/422650044587529/int_phab to review.
  Can you paste the contents of `/Users/stereodenis/work/stereopark/PlaceInfoMobile/node_modules/coffee-script/node_modules/docco/node_modules/commander/node_modules/should/node_modules/gulp-header/node_modules/through2/node_modules/bl/node_modules/brtapsauce/package.json`?

Do you use a preprocessor? Can you try deleting `node_modules/jest-cli/.haste_cache` and trying again?
 can you try to reinstall this module and see if it works? Maybe npm crashed when it tried to install this module or something.
 (I'm closing this because it is unrelated to jest and is unlikely to affect a change in jest. Feel free to continue this discussion here, however.)
  I agree this sucks. I'll fix it with all the work in node-haste2, follow along in #599.
 This should definitely be fixed in the next version of Jest and might already work properly in 0.9.2.
  thanks @huang47! I'm going to be on PTO starting Thursday, I'll get back to this pull request once I'm back ‚Äì I don't want to merge anything that is "risky" before I leave. I rewrote bin/jest.js a little bit in one of the refactors, but I can do the rebase :)
 Uh, forgot about this PR. @huang47 can you rebase this against master? :)
 @facebook-github-bot shipit
 Thanks for importing. If you are an FB employee go to https://our.intern.facebook.com/intern/opensource/github/pull_request/1090481994310226/int_phab to review.
  oh lool. I didn't know there was a difference between plugins and presets in babel 6.
 Thank you!
  I'm looking into it right now. Seems like the .babelrc isn't being picked up correctly in babel-jest. I'll fix it and update the examples and docs.
 This was fixed by adding a `.babelrc` to the example folder.
  Can you try using the `moduleNameMapper` option to stub out .css modules? 
See: http://facebook.github.io/jest/docs/api.html#config-modulenamemapper-object-string-string

I'm wondering whether this has to do with .css files not being processed correctly. For tests it probably makes sense to create a stub for all .css files.
  Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!
 Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks!
 This doesn't seem necessary. `babel-jest` works with a `.babelrc` file, see the updated react example.
 Can you give an example of this?

If this is necessary I would recommend building your own preprocessor: https://github.com/facebook/fbjs/blob/master/scripts/jest/preprocessor.js I'm currently updating the docs for the react tutorial to include this info.
 yeah I guess that does make sense. My bigger problem is that I'll have to support this config option forever but I'm planning to redo configs completely. Personally, babel-jest has never worked so great for me in my projects ‚Äì I always needed custom config. I think having your own preprocessor is necessary for most projects, actually. If you build your own preprocessor, you can put the options right there.
 To sum up, I'm not against adding this config option in general, I'm more worried about adding more complexity and technical debt to the config system in jest, which I consider a total clusterfuck and which I will rewrite and make easier so that jest's config and setup are easy and powerful and don't contain surprises; and also so they won't require changes like the one you made at all and that it will just work great by default.
 I would actually prefer to just pass any config option through and remove the whitelist entirely. Would that help you?
 Oh, here is the best solution that should solve @homer0's use case of needing different configs: `.babelrc` supports environments, see: https://babeljs.io/docs/usage/babelrc/

If you change your jest invocation to `NODE_ENV=test jest` this should work as you'd expect.
  Thank you! For some reason the new doc site wasn't being generated yesterday when I pushed the website. I fixed it now.
  This seems related to #554.

Can you add react-overlays and react-prop-types to your unmocked module list in the config?
 Oh I'm sorry, I see now what you mean. The problem is that two projects depend on the same dependency but different versions of it. npm3 installs one of them in `node_modules` and the other one in `node_modules/react-overlays/node_modules` and the module loader seems to pick the wrong one first, is that right?

@amasad does the new resolver fix this use-case? What does it give preference to?
@hgezim did the module resolution algorithm change at all with npm3?
 I think this won't be a problem with the new resolver from #599. I'll close it once this gets merged into jest at the beginning of December.
 @hgezim would you mind retrying with jest@next (0.9.0-fb1) and reporting whether it resolves your issue?
 That seems unrelated to the 0.9 update and is likely also happening on 0.8 then? You can also try --no-cache.
 Please let me know if this is still a problem with `jest-cli@next` and I will reopen and investigate.
  Use the `--noHighlight` option for running jest.
 It's `jest --no-colors` now I guess there's no other way to do it currently, but to set this `argv`. 
Right now this option is consumed by Jest, but it's not used anywhere.
 
The `--no-color` (and apparently `--no-colors`, although I have no idea why) flag is read by [supports-color](https://github.com/chalk/supports-color#info) package in `chalk`, which we use to color terminal output.  I suggest using babel-jest to preprocess your files and strip flow-annotations before tests are being run on them. Follow the guide for React testing on the bottom here: http://facebook.github.io/jest/docs/tutorial-react.html#content

(Note: we are in the process of upgrading babel-jest to babel6. For now I recommend using babel-jest 5 until we have ironed out the issues).
 I think we should add some notes for this somewhere. cc @hramos. Ooof, I wasn't aware this was an issue people might need help with. If you still think this should be documented, feel free to open a new issue and assign it to me. Yeah! That is on me to document. Unfortunately it's not been on my mind as the issue is closed. @thomb `transform-flow-strip-types` plugin (or `flow` preset) just works with Jest when added to your Babel config. _.babelrc_
```json
{
  "presets": [
    "flow"
  ]
}
```
That's all.   Thank you!

Do you think it makes sense to add an example for this as well (In a separate PR)? I would prefer for this to be after the react tutorial. We should re-order the tutorials:

Getting Started
Tutorial
Tutorial ‚Äì React
Tutorial ‚Äì Webpack Integration
...Other Tutorials

What do you think?
 Yeah, we also have a react example using babel-jest, would be nice to have one for webpack integration so people can copy-paste the setup :)

Would you mind making the proposed changes in the ordering of the tutorials? :)
 @facebook-github-bot shipit
 Thanks for importing. If you are an FB employee go to https://our.intern.facebook.com/intern/opensource/github/pull_request/923728341054310/int_phab to review.
 yes! I just didn't have time to do it yet with all my work on haste2 :) Sorry! I'll get to it soon.
  done! Thanks for the PR, this is great to have.
  Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!
 Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks!
 yeah it would be great to update the example to work with babel 6!
 The example was fixed today using `.babelrc` properly.
  Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!
 Awesome, thank you so much. Our bot is going to ask you to sign the CLA :)
 Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks!
 @facebook-github-bot shipit
 Thanks for importing. If you are an FB employee go to https://our.intern.facebook.com/intern/opensource/github/pull_request/1700413520187823/int_phab to review.
  Hey! Yeah, sorry for the confusion. I'm planning to make configs much easier soon :)
  Hey! Can you try to add `uncontrollable` to the unmocked module list? The problem is that npm3 uses a flat copy of node_modules and jest currently doesn't know how to deal with that. I will fix this eventually!

This is tracked in #554
 No worries. This is definitely confusing and should probably be part of the documentation for now. How do you feel about making a small pull request for the docs that adds information about unmocking with npm3? :)
 I think it makes sense somewhere around here: https://github.com/facebook/jest/blob/master/docs/API.md#configunmockedmodulepathpatterns-array ?
 Yeah I think that would be fantastic. I'm actually planning to revamp how jest's config and setup works and with that I also wanna make the jest website more beginner friendly! Some people (including me :) ) are hanging out on discord ‚Äì if you wanna join us and be involved, feel free to do so: https://facebook.github.io/jest/support.html :)
  Hey @radfahrer,

I've been waiting for this pull request: https://github.com/facebook/jest/pull/330 to be rebased. If you wanna help out, feel free to take it over and send a new PR :)
 Closing this; we'll publish jasmine2 support soon and it is tracked in the PR.
  Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!
 Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks!
 Hi @CodeFred,

thank you for your contribution. Unfortunately, I'm not sure I follow why you are making this change. The idea of testPathPatterns is to match against the tests you want to run. If it isn't specified, all paths are considered and all tests are being run.

Example:

```
jest foo // Runs all tests matching `foo`
jest // Runs all tests
```

I don't think it makes sense to add this to the config ‚Äì the config should specify all potential tests in your environment. The test path pattern specified on the command line should only be used by users trying to test a specific test. I'm planning to do a drastic simplification of jest's setup and config. The `testPathPattern` from the command line will likely go away; I don't really see its value.
 @CodeFred thanks for the elaborate response. I agree with the 2 conceptual differences and there are a bunch of settings in the config that can be used for 1. For the second part, this is what the rest of the arguments in the cli option already support. However, this is all too complex at the moment and I'm hoping to make this more simple soon.

Would you mind elaborating why jest wasn't a good fit for your project? I understand setup is one of the main pain points (feel free to join us on discord, see http://facebook.github.io/jest/support.html ) right now but after that it should work pretty well (and I'm working on improving all parts of jest :) ).
  This pull request is used to track the implementation of node-haste2.
##### Summary
- Implemented node-haste2, a re-implementation of Facebook's haste dependency system, based on Facebook's react-native packager. We now create the entire haste-map upfront and pass it to the worker threads instead of creating node-haste instances in each worker.
- Changed the core architecture of Jest to abstract the HasteModuleLoader into a ModuleLoader and HasteResolver piece. Added a Test class so we aren't creating instances of a TestRunner in every worker. The new code should bring a lot of clarity but there is also a lot more to be done.
- Performance improvements
  - fixed startup time of Jest, both on cold and warm start. node_modules are now lazily analyzed.
  - fixed require-resolution time for relative requires. Loading modules without haste is now much faster and uses more caching.
- New implementation of `--onlyChanged` that should work much better and find the correct set of related tests to run.
- Numerous bugfixes and cleanups all around Jest.
##### Performance Improvements
- The Relay test suite (GitHub) now takes 20s vs. 60-100s previously (on 13‚Äù MBP)
- The react-native test suite now takes 8 seconds instead of ~70s (on 13‚Äù MBP)
- Starting up Jest on react-native (fb internal) now takes 1 second vs. ~10-15 seconds from before.
- FB's frontend codebase test run was already heavily optimized but there is ~10 % win down to ~97s from about 107s.

This diff/PR forms the basis for all the work on Jest that I'm planning to do in the near term and will set up Jest for further success. It should be much easier to iterate on Jest from now on given that we have replaced the biggest legacy system and I can finally focus on solving some of the community problems.
 The new module execution code is a little bit more ugly but it is super-hot code and yields a 10 sec perf win on www (~8.5 % of the entire runtime).
 omg it works.
 Outstanding list of TODOs:
- Add cache and fileWatcher to actually make this fast
- Only construct one moduleLoader in TestRunner; re-use HasteResolver
- Make 'HasteResolver' class configurable
- Test this at FB and fix issues that come up

Future release:
- Support NODE_PATH + traversal up the tree for node_modules so we can drop `resolve`

None of these should be blockers for merging this PR except for testing this at FB (no point in building this if it doesn't work on all of our tests ). I will try to run it on Monday and fix minor issues as they come up (assuming it won't blow up completely :) ). The first for TODO items are blockers for tagging a new version of jest itself, of course.
 @jsdf thanks for the review! What would the ideal API look like to you? I take it webpack/browserify pre-transform code and then resolve them?

I can imagine to merge the preprocessor and the resolver: resolving the dependencies for a path will pre-transform the file and apply the transform recursively for every dependency before resolving its dependencies. Now that there is only a single entry point for transform (there used to be three!) this should be easy to change. All that it needs is a map from real path to the cache path, which should be achievable using the `getCacheKey` method in the preprocessor.
 High level description of all the changes:
- replaced node-haste with node-haste2
- major cleanups in HasteModuleLoader, TestRunner and `jest.js`
- fixed a bunch of bugs.
- Split up HasteModuleLoader into two classes, the new class is HasteResolver which will soon receive more functionality.

Here is a breakdown of all the changes from oldest to latest:

https://github.com/cpojer/jest/compare/89481fbf1a7d7ce9b37b85bb6ffbd0a76cda69ad...cpojer:5f82cc75872ae02e97fcfa5f41039f8f6d6e3686
- The first few commits are cleanups. They remove some cruft in the test runner and inline the module execution. By not using objects and `Object.keys` when executing a module we get a slight speedup. Note that this code will move out of HasteModuleLoader in the future and I just consolidated this convoluted piece of code

https://github.com/cpojer/jest/commit/e1faf1bd8ea38cb14c8f2cc955e47685782ef788
- This diff is inconsequential. `getJestRuntimeForTest` was removed in a later commit in the stack.

https://github.com/cpojer/jest/commit/620ea9e003751e96bbee139f139e61a71043665d
- This diff cleans up a bunch of minor things. Most notably I noticed that the `disposed` variable wasn't useful at all. I'm now using the global to check if a context should be disposed.

https://github.com/cpojer/jest/commit/f518a9235f4273af64559dde9cb7e047c0fc0f14
- Slightly unrelated change but we were reporting the wrong number of total test suites (we didn't include the failed ones, this was annoying during the refactors)

https://github.com/cpojer/jest/compare/9a4e8d0a11f8055f5683c9fc7d8ee6a712fbb263...cpojer:000d0d9d6c53b64e5c25b9e2018c3035c8f50a4b
- This is the collection of diffs with all the changes that replace node-haste with node-haste2. At the end I changed all objects in the loader from `{}` to `Object.create(null)`.

https://github.com/cpojer/jest/commit/422ab8863d02953682f6fcfe1f762297a4c9d25d
- This diff reorganizes all the methods in HasteModuleLoader, the file is now readable. I sorted it similar to how classes are organized in node-haste, with the public interface on top. The one change I made was to not only create coverage data for direct dependents. This doesn't seem useful and isn't worth mutating the config object over. I can bring this back in the future if we need it but I think ignoring `node_modules` is enough. I froze the config object in the next diff: https://github.com/cpojer/jest/commit/1b06d9e9d9d78032568b3b0fbcb50b0e7d2a9a82 which will allow further optimizations in the future.

https://github.com/cpojer/jest/commit/92bcc173dc9936305ea409255621d6e8a951c57a
- Just a code cleanup and moved the code to ES2015

https://github.com/cpojer/jest/commit/5fd0c8888d4413b418c5bea6793772f04cee9d44
- I noticed `jest --onlyChanged` never properly worked in the jest repo itself. This fixes the command for repos where `<rootDir>` doesn't equal the git root. The big algorithmic change in this diff is that instead of looking at all the changed files and resolving their dependents recursively up to a test file, we are now looking at all the recursive dependencies of all the test files and intersect them with the changed files. Let's bring back the old algorithm (and support for it in node-haste) if this proves to be too slow internally at FB.
 Ok we are back in business. I just rebased this branch on top of all the work that went into jest since I started on this diff. Everything up until "Use `Object.create(null)` in HasteResolver." was reviewed by @amasad about two weeks ago. I'll pull in the minor cleanups from the beginning of this PR into jest 0.8.1 and once I'm done with the jasmine2 conversion at FB I'll pick this one back up.
 Another rebase with all of the haste2 unrelated changes removed and pushed to jest.
 @facebook-github-bot import
 Thanks for importing. If you are an FB employee go to https://our.intern.facebook.com/intern/opensource/github/pull_request/1632719277015544/int_phab to review.
 @facebook-github-bot import
 Thanks for importing. If you are an FB employee go to https://our.intern.facebook.com/intern/opensource/github/pull_request/1632719277015544/int_phab to review.
 @facebook-github-bot import
 Thanks for importing. If you are an FB employee go to https://our.intern.facebook.com/intern/opensource/github/pull_request/1632719277015544/int_phab to review.
 @facebook-github-bot import
 Thanks for importing. If you are an FB employee go to https://our.intern.facebook.com/intern/opensource/github/pull_request/1632719277015544/int_phab to review.
 I updated the PR summary with a better description of what is being accomplished here.
 tomorrow!
 Seeing similar perf gains in open source, from #jest on our discord channel from @ncuillery:
![Imgur](http://i.imgur.com/6Yj0qHa.png)

If you'd like to try this with react-native, you might need to specify the `haste` option in jest now:

``` js
  "haste": {
      "defaultPlatform": "ios",
      "providesModuleNodeModules": [
        "fbjs",
        "react",
        "react-native",
        "parse",
        "react-transform-hmr"
      ],
      "platforms": ["ios", "android"]
    },
```

I'm not entirely sure whether putting `react-native` into `providesModuleNodeModules` is going to be sufficient. I'll do more testing before the release to make sure that apps dependent on react-native have a smooth upgrade experience.
 Diff was landed against Facebook's main codebase and it seems to be working fine. I'll hold off merging this diff here for another day to make sure everything stays green internally.
 Another person tried and got significant speedups:
![Imgur](http://i.imgur.com/KbrCB0J.png)

This later went down to 18s (warm start run).
 Thanks @ncuillery that is super useful. I haven't been able to repro this on any platform so far.

Would you mind sharing the size of your repository? How many files are visible from all the `testPathDirs` (or `rootDir` if `testPathDirs` wasn't specified) and how many of those are js/json? One thing you could try is to limit the `testPathDirs` to an array of folders as close to the JS as possible. At FB, for example, we have `/html/js` which is only a tiny subset of the root folder of all files in our repository. Crawling the root would be super slow, but crawling only the subset that contains JS is reasonably fast.

The new implementation uses watchman for file crawling if available and that should be much faster. Would you mind trying to set this up for your project? https://facebook.github.io/watchman/ I'm curious to hear about the difference.

One important thing to note is that I'm planning to improve the `--watch` command soon and to turn Jest into a server, so that single test runs are instant and there won't be a startup time penalty.
 Awesome!

Alright, it is time to merge. We should figure out the Windows issue before tagging 0.9.0.
 I've published this PR as `0.9.0-fb1` for anyone who would like to try it out.
 @irudoy can you try passing `watchman: false` to your jest run?
 If you are willing to add tests to Jest that point out this issue you are seeing with your integration or sahre a test suite with a repro, I can try to look into this.
 Thanks! Note that 0.9 is not out yet and you should be safe using 0.8. Would you mind opening a separate issue on this repo with the details of this issue and what you'd expect to work that doesn't any more? :)
 Published jest@next again as 0.9.0-fb2 which should resolve the watcher issues.
 Ohhh, there is an open task to improve caching when coverage is being used. If anyone wants to work on that, it should improve test runs with coverage by 20-50 %.
  We'll redo how we do configs soon, I don't think this will apply then. I recommend setting your rootDir to `./` instead of `src`.
  I would recommend unmocking the recursive chain of dependencies that react-bootstrap depends on, in the config for jest: https://github.com/facebook/jest/issues/554#issuecomment-148836979 ‚Äì + add react-bootstrap there.
 I admit I get confused about these things as well and am hoping to make this easier with the module loader rewrite. The honest answer: I don't know. Any or all of these combinations might work, as `react` itself might work too.

Do you want to use mocking as part of your app right now? If not, I recommend using `jest.autoMockOff()` at the top of your tests.

Also, this is not an appropriate space to ask questions. Please use stack overflow or join us on discord, where I'm almost always around.
 (I meant to say that I'm always around on discord, not stack overflow :) )
 If you can push a repo on github with a repro I could take a look there. It is hard to say what the right way to go about this is without looking at all the pieces of the system. It should be a simple fix though.

I'm currently trying to make up my mind about auto mocking. I don't think it is that useful in places where libraries and apps are small (like, not FB scale) and I'm hoping to focus on improving the experience around that soon. If you wanna spend some more time debugging I would recommend joining discord (see https://facebook.github.io/jest/support.html )
 The source code for jest is in this repository and GitHub has a search function: here is how you can inspect how unmockedModulePathPatterns works: https://github.com/facebook/jest/search?utf8=%E2%9C%93&q=unmockedModulePathPatterns
  Which version of jest are you using? There must be something bad going on in one of your tests. Have you been able to isolate which test is throwing up?
 Can you try to disable coverage and see if it stops reproing?

The list of tests being reported is misleading because it fails to run certain tests. So it would be good to know which tests always pass and whether it is always the same test that causes the crash.
 Yeah, coverage is a little bit flaky unfortunately. If you have time to look into this, I would suggest forking jest and upgrading istanbul and see if the issue goes away.
  I'm planning to completely redo configs for jest eventually, so these options might slightly change. Why not use the `--config` option and pass in a file with your on-the-fly created test config?
 ``` js
fs.writeFileSync('temp-config.json', JSON.stringify(config), 'utf-8');
exec('jest --config temp-config.json');
fs.unlinkSync('temp-config.json');
```

?
 I'm not opposed to adding this. Feel free to send a pull request. But note that the configs might change soon-ish and you might have to update your thing. I might also remove some of these options when I consolidate the cli args/config stuff.
 There is no task tracking this yet. This is mostly in my head atm. If you want to send a PR, I'll accept it but as said, these options might change in the future and I might remove certain things from the cli again. How do you feel about adding `--JSONconfig='{"..."}'? This means we don't have to add more than one cli option and it supports everything that the config supports.
 Seems like tracking this issue right here is fine. I'll probably not get to this anytime soon (like, within the next month) but I'd be happy to accept pull request that adds this feature.
  this is because we are not buffering console outputs any longer and we are printing them as they happen. This is a bit unfortunate ‚Äì @amasad can you think of a fix?
 We can potentially prefix logs with the test name in: https://github.com/facebook/jest/blob/master/src/Console.js

Thoughts?
 I think not buffering has benefits that is worth the tradeoffs here. You can use them to debug timing-sensitive code (which is most code in JS).
 I think prefixing is quite noisy, unfortunately. The problem with the new behavior is mostly that different tests can cause a log spew at the same time. Ideally, nothing should be logged to the console except for explicit console.log calls when the console isn't shimmed in tests. That way, when the user adds a single log message and they run the tests, they'll only see that one.
 Actually, I think if we remember the previous test and prefix and indent it might be nice:

```
  LOG ModuleResolver-test.js
    log1
    log2
  LOG JSDOMEnvironment-test.js
    log1
```
  Agree the error message here could be better but this was a change we backported from jasmine 2. The fix is to change the object into an array or the array into an object :)
  It seems like this is a problem with one of the dependencies of jest and might be related to npm 3. I'll take a look
 btw. at Facebook we adopted Node's LTS release process. Which means that we will officially support the LTS releases and upgrade only once every 6 months. I am less likely to discover these kind of issues (Node 5 was released just a few days ago) and will appreciate pull requests. We should probably add node 5 to the travis matrix, however.
 Oh yeah, what happens when you upgrade from npm 2 to npm 3 without wiping away node_modules?
 perfect!
  Hey! Are you using jest 0.7.0? This was fixed recently.
 You are right, I fixed this in the haste2 PR, see #599, and more specifically f518a9235f4273af64559dde9cb7e047c0fc0f14

I should probably cherry pick this into 0.8.0. node-haste2 will likely be 0.9.0.
 Sorry, this entire issue is confusing, there were a bunch of other small counting issues when we changed to test suites vs. tests and I should have been more thorough during code review.
 There we go: https://github.com/facebook/jest/pull/618
  Thank you for your contribution! Can you explain a little better what you are trying to accomplish here and figure out the test failures? I'm not really sure what you are doing here.
  There are no new APIs in 0.7. I removed APIs that were undocumented in open source and never should have been open sourced in the first place. `jest.resetModuleRegistry()` is being called implicitly before each test run. It simply wipes away the module registry for all modules and has been around forever. It was previously called `require('mock-modules').dumpCache()`.
 Also, the reason I'm doing this is to
- refactor jest into a codebase that a human can understand and read
- replace node-haste in the future
 Yeah, it is a public API because there exists a config option to disable the reset, mainly for the react/relay open source projects. I'm hoping to kill this option and also to completely revamp configs (+ have some sort of legacy-options converter or something).
  Hey! First off, please upgrade to jest 0.6.1. Second, can you paste an example of a test where this happens os I can try to repro? :)
 Yep! We fixed a bunch of things in how we are dealing with the console :)

the `warning` module in react actually uses `console.error`, so you need to stub that :) https://github.com/facebook/fbjs/blob/master/src/__forks__/warning.js#L42
 Anytime! Feel free to join us on discord https://discordapp.com/channels/102860784329052160/103622435865104384 if you have future questions :)
  Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!
 Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks!
 Thank you!
 @facebook-github-bot shipit
 Thanks for importing. If you are an FB employee go to https://our.intern.facebook.com/intern/opensource/github/pull_request/754418737996209/int_phab to review.
  Oh man, did I mess up this thing in Promise.resolve? I thought Promise.resolve calls the passed in function. That is messed up. I'm sorry!
 Can you join me in #jest on discord so we can discuss there and resolve this? http://facebook.github.io/jest/support.html
 Thanks for all the debugging work. Using `Object.assign` for `global.process` does indeed fix memory usage a lot! I'm working on a fix for jest 0.7.0.
 Fixed in https://github.com/facebook/jest/commit/4e127314516bdd48238cc82ee3e9b6a039520928 and I will tag 0.7.0 shortly. @richardscarrott would you mind trying to run your code like this (after upgrading):

`node --expose-gc node_modules/jest-cli/bin/jest.js --runInBand --logHeapUsage`
  That's not good. We certainly need to get better around memory usage, something I'll be focusing on in the future but not currently, unfortunately. Do you know which test consistently hangs and whether its only one or always a different test?
 Can you repro this at all when you aren't using coverage? Coverage is way more expensive, so I'm wondering whether the issue is because it tries to generate coverage for a large app and it somehow fails.
 oh yeah you got a lot of tests there. I also had an internal report of this and I'm hoping to find a fix for this soon but as always, these things are a bit hard to track down.

You can run your tests in the main thread using `--runInBand`, maybe try that together with `--verbose`.
 There is also `node-heapdump` which allows to create a heapdump of the current state of a node process that you can then open and inspect in node. I built a service at FB that used multiple contexts and had a circular reference from inside a context to the parent and it was just a mess to debug :(
 If you do want to test Promises you can return a promise from a test (change `it` to `pit`) and it will have a 5 second timer for that promise to resolve.
 Feel free to ping me on the reactiflux channel for jest, as well: https://facebook.github.io/react/blog/2015/10/19/reactiflux-is-moving-to-discord.html
 Thanks @cpinnix for tracking this down. We have had a similar issue at FB recently so I'm wondering if they are related. @jmorrell
 @anback Note that use of `--forceExit` is discouraged and means that your tests are not cleaning up resources (like db connections etc.) and cause memory leaks while the test is run. You should use `afterAll` or `afterEach` to disconnect and tear down things.  No, unfortunately that is not currently possible. It may be possible to implement a separate PhantomJSContext for jest and you are welcome to send a pull request. Feel free to join our channel on discord ( https://facebook.github.io/react/blog/2015/10/19/reactiflux-is-moving-to-discord.html ) and ping me about this!

As of this time we have not planned adding support for this so I'll be closing this issue to keep the queue short. Feel free to re-open if you are planning to help and send a PR.
  @facebook-github-bot import
 Thanks for importing. If you are an FB employee go to https://our.intern.facebook.com/intern/opensource/github/pull_request/108676296160596/int_phab to review.
 @facebook-github-bot shipit
 Thanks for importing. If you are an FB employee go to https://our.intern.facebook.com/intern/opensource/github/pull_request/108676296160596/int_phab to review.
 I cannot do that @cpojer, because @clentfort does not have an active CLA on file.
 I cannot do that @cpojer, because @clentfort does not have an active CLA on file.
  that sounds like a good idea. I've been wondering why jest depends on coffee-script and haven't gotten around to look at the jasmine part of jest yet, unfortunately.
  let's see what happens when I try to import this with a conflict.
 @facebook-github-bot import
 Thanks for importing. If you are an FB employee go to https://our.intern.facebook.com/intern/opensource/github/pull_request/649940348480696/int_phab to review.
 @facebook-github-bot shipit
 Thanks for importing. If you are an FB employee go to https://our.intern.facebook.com/intern/opensource/github/pull_request/649940348480696/int_phab to review.
 Nice. I could import this and just fix the issue myself. Yayyy!
 I cannot do that @cpojer, because @clentfort does not have an active CLA on file.
 I cannot do that @cpojer, because @clentfort does not have an active CLA on file.
  @facebook-github-bot shipit
 Thanks for importing. If you are an FB employee go to https://our.intern.facebook.com/intern/opensource/github/pull_request/1161463120549339/int_phab to review.
 I cannot do that @cpojer, because @clentfort does not have an active CLA on file.
  Thank you! The singular of suites is `suite`. Can you fix this?
 Please also add the field to the JSON result here: https://github.com/facebook/jest/blob/master/src/lib/formatTestResults.js#L53
 @facebook-github-bot import
 Thanks for importing. If you are an FB employee go to https://our.intern.facebook.com/intern/opensource/github/pull_request/161463364205395/int_phab to review.
 @facebook-github-bot shipit
 Thanks for importing. If you are an FB employee go to https://our.intern.facebook.com/intern/opensource/github/pull_request/161463364205395/int_phab to review.
  oh my god. You are making me _so so_ happy. This was on my TODO list for the longest time. I'll take a look on Monday!
 @facebook-github-bot import
 Thanks for importing. If you are an FB employee go to https://our.intern.facebook.com/intern/opensource/github/pull_request/1236191896397289/int_phab to review.
 I'm going to ship it because I don't want you to have to rebase this after other changes.
 @facebook-github-bot shipit
 Thanks for importing. If you are an FB employee go to https://our.intern.facebook.com/intern/opensource/github/pull_request/1236191896397289/int_phab to review.
 I cannot do that @cpojer, because @clentfort does not have an active CLA on file.
 I cannot do that @cpojer, because @clentfort does not have an active CLA on file.
  yay!
  Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!
 oh noo, @clentfort just sent out #570 :(
 @clentfort is updating the documentation. Would you mind removing your documentation change and just change the example? That way I can merge your PR. Oh, and please sign the CLA :)
 Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks!
 Thank you!
  This is great!
 @facebook-github-bot shipit
 Thanks for importing. If you are an FB employee go to https://our.intern.facebook.com/intern/opensource/github/pull_request/1632256837047332/int_phab to review.
 @facebook-github-bot import
 Thanks for importing. If you are an FB employee go to https://our.intern.facebook.com/intern/opensource/github/pull_request/1632256837047332/int_phab to review.
 @facebook-github-bot import
 Thanks for importing. If you are an FB employee go to https://our.intern.facebook.com/intern/opensource/github/pull_request/1632256837047332/int_phab to review.
 @facebook-github-bot shipit
 Thanks for importing. If you are an FB employee go to https://our.intern.facebook.com/intern/opensource/github/pull_request/1632256837047332/int_phab to review.
 I cannot do that @cpojer, because @clentfort does not have an active CLA on file.
 I cannot do that @cpojer, because @clentfort does not have an active CLA on file.
 I cannot do that @cpojer, because @clentfort does not have an active CLA on file.
 I cannot do that @cpojer, because @clentfort does not have an active CLA on file.
  Yeah this needs to be aligned with the `examples/react` folder. @clentfort or @mrberggg would you be interested in sending a PR for this?
 Done in #570
 I commented on your pull request :) Let's take it from there!
  If you pull jest from master you shouldn't need to use react-tools. react-tools is deprecated. I just recently merged a PR that added react 0.14 to the examples folder but I think we didn't update the website yet.
 Oh I didn't realize there were two different ones. Yeah, I'm just going to kill the react one and rename the react-es6 to react :) Thanks for bringing this up!
 Done in https://github.com/facebook/jest/commit/2597a0b16e5a17640d4455ce36729e462af38365
  @facebook-github-bot shipit
 Thanks for importing. If you are an FB employee go to https://our.intern.facebook.com/intern/opensource/github/pull_request/653227438153293/int_phab to review.
  @facebook-github-bot shipit
 Thanks for importing. If you are an FB employee go to https://our.intern.facebook.com/intern/opensource/github/pull_request/1515284165460715/int_phab to review.
 I cannot do that @cpojer, because @clentfort does not have an active CLA on file.
  cc @huang47 can you take a look?
  sorry! Yes this was added in #565
  Thank you very much!
  Hey!

I think the problem is that you are using `import`. Jest right now does not support import but jest 0.7.0 likely will (the next-next release :) ). Sorry, there is no more info that is coming back from the engine that we could sure here I don't think.
  No, jest has a different goal ‚Äì it is focused on testing isolated pieces of your application logic.
  I don't think there is anything wrong with jest. It must be with your setup or your tests. Are you using the latest versions of react, node and jest? From the example you posted I don't know where the error is coming from ‚Äì do you have a stack trace?
 Would it be possible for you to publish your changes based on the starter kit so I can repro this myself?
 For some reason react is being mocked even though it shouldn't. This is weird.
 Seems like setMock really, really sucks :)
 https://gist.github.com/cpojer/72093d149e725a5e6082 this patch can make your tests work properly. In short `setMock` sucks and doesn't work as well as it should. I'm hoping to fix this soon. I added a mock using the new `moduleNameMapper` feature which will match all `.css` files and use the same stub for them. This now makes your tests work. You might also be able to turn this into a pull request for the react-starter-kit :)
  We are working on making jest faster. React is pretty big and requiring it takes a while. You can expect some improvements in jest 0.7.0 (the next-next version :) ).
  @facebook-github-bot import
 Thanks for importing. If you are an FB employee go to https://our.intern.facebook.com/intern/opensource/github/pull_request/314880515302767/int_phab to review.
 @facebook-github-bot shipit
 This is awesome!
 Thanks for importing. If you are an FB employee go to https://our.intern.facebook.com/intern/opensource/github/pull_request/314880515302767/int_phab to review.
  Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!
 Hey! Thanks for your contribution. I think this sounds good but as you said this should be optional!

Take a look at `bin/jest.js` on how to add command line options. Most of the time you'll need to add the option from `argv` to `config`, like we do for some other options as well. I'm not sure if it makes sense to change `success` to be something else if coverage is not provided. I would recommend doing something like `--requireFullTestCoverage` which then does a separate pass on the results and it throws if coverage is not at 100 % ‚Äì what do you think?
 Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks!
 Feel free to reopen if you are picking this Pull Request up again.
 @ttmarek there is a "coverageThresholds" option.  Yeah I think everything that is needed is there? Please feel free to reopen if you think this is a problem with jest.
  Are you using npm3?
 Also see: https://github.com/facebook/react/issues/5183

We don't have a good solution for this yet, unfortunately.
 Manually unmocking `fbjs` as well as `react` should work for now.
 Workarounds for React:
1. Disable automocking entirely (_suggested because fuck mocking_)
2. Disable mocking for `node_modules/{react,fbjs}`
 fyi the tentative plan is to wait for Haste 2 in #599 and then I'll fix unmock patterns to be deep-unmocks when they are inside of node_modules.
 should be out sometime by the end of this year, that's the plan at least :)
 Will be fixed in 0.9.0. I'll publish a new version of `jest-cli@next` that solves this problem.
 0.9.0 has been published and this issue is now properly fixed :)
  If your module is located at `<dir>/module.js` you should create a mock under `<dir>/__mocks__/module.js`.
 Are you using npm3?
 Unfortunately we don't have a good solution for this yet :( We aren't using npm3 at FB yet and I haven't been able to investigate this issue thoroughly yet. If you have an idea for a fix, I'd appreciate a pull request!
 what kind of development doc are you looking for? I'm working on revamping the CONTRIBUTING guide. All you need to do is make a change and submit a PR on GitHub. Our bot will then ask you to sign the CLA.

You can run jest on itself by doing `node bin/jest.js`.
  which version of node and which version of jest are you using?
 Jest doesn't support node 0.12. Please update to node 4.
  yes, node_modules are unmocked just by their name.
 Are you using npm3?
 :(

https://github.com/facebook/jest/issues/554
 We need to fix this in jest!
 Yep! We'll try to figure out a proper solution.
  Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!
 Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks!
 Thank you so much, this is awesome!
 This is wrong in the other example too. Would you mind fixing that up as well? :) And it would be awesome if you could flatten your commits into a single one!
 This is great, thank you!
 I'll publish it when we tag 0.6.0 :)
  Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!
 Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks!
 thank you!
  I guess there is no particular reason. I guess it is more useful for most people to count the number of tests instead of the number of files and we should make the change. Do you want to send a pull request? :)
 I don't think it makes sense to show different counts based on the `--verbose` option.
 This will be in 0.6.0. Yay!

https://github.com/facebook/jest/pull/557
  Jest has a "testURL" setting.
  I will recommend to unmock sinon, because that is the intention. Either add it to your unmockedModulePatterns or add an explicit `jest.dontMock('sinon')` to your tests!
  It definitely does work with 0.14 but we haven't had time to update the jest examples. Feel free to send us a pull request! :)
 This should be fixed with #550
 If you clone jest from master and try the examples from there, do they work?
  - More reliable (uses IPC instead of stdin/out)
- No more weird messaging issues (unable to parse, message order, etc)
- Allows (currently, up to 2) initialization errors per worker
- Console logs can appear as they are executed (not buffered)
- Also means that they console logs appear even when there is initialization errors
- Simplifies console and logger implementation
- Easier for debugging (even if the program crashes you can still see your logs)
- Opens up opportunities for future more involved inter-worker communication (say sharing mocking work)
  cc @cpojer @DmitrySoshnikov 
 Potential issues to close:
#259
#539
#369
#341
 Perfect, thanks!
 wow this is awesome. I thought this was going to be a much more involved change, glad it allowed to get rid of a bit of code! Nice work @amasad.
 Soon @Pajn. Either this week or next week. We won't be doing a pre-release for 0.6.0.
  I'm not entirely sure if this is really doing anything. I tried this internally at FB and there is no difference in the test behavior whether I use `1` core or `32`. Can you explain what exactly the difference is for you with this option? Given that we create one ModuleLoader per process, we probably don't want it to spin up more processes anyway.

We are about to rewrite node-haste so this problem will likely go away completely soon.
 Got it. Would you mind rebasing your change against master? I'll pull it in and ship it in 0.6.0. Note that all of this will change very soon as we rewrite node-haste, so this problem will resolve itself long-term as well.
 @facebook-github-bot shipit
 Thanks for importing. If you are an FB employee go to https://our.intern.facebook.com/intern/opensource/github/pull_request/425688177630800/int_phab to review.
  We already have a `maxWorkers` option that should take care of this, no? It is passed on to the TestRunner.
 That's weird. Feel free to send a Pull Request :)
 Also check out #599, which replaces node-haste with an entirely new implementation.
  @facebook-github-bot import
 Thanks for importing. If you are an FB employee go to https://our.intern.facebook.com/intern/opensource/github/pull_request/923645757710017/int_phab to review.
 @facebook-github-bot shipit
 Thanks for importing. If you are an FB employee go to https://our.intern.facebook.com/intern/opensource/github/pull_request/923645757710017/int_phab to review.
 I used this pull request as a test for our FB sync infra. Now we can develop jest more efficiently at FB :)
 Yeah we can't use the merge-feature on GitHub any more but right before my previous comment the bot has commented with a link to the diff that got merged. Is this what you mean?
 cc @vjeux ^
  You can explicitly specify that you want the module to be mocked: `jest.mock('fs')`. Not sure why the decision was made that builtins shouldn't be autmocked. cc @jeffmo 
  Can you please post more sample code, like the implementation of your store?
 It doesn't look like you export `orderByPassenger` on your `TripSearchStore` object
  I followed your repro instructions and couldn't repro.

I created a file with the following and required it in a test:

```
exports.something = Symbol
```
 nvm, I had autmocking off, now it works.
 This is a problem with reserved keywords. Merging with #394
 Fixed, should be out in 0.6.0
  That won't work with jest -- it will assume that "app" or "modules" are in node_modules.
Why don't you use relative requires? In your example just do `require('../../modules/sum')`.
  Agreed! I haven't heard from @koddsson since he initially started his pull request.
 I'm happy to accept pull requests for this feature!
 This will be part of the 12.1.0 release sometime this week. Thanks to @bookman25 for implementing this feature!
  agree, that would be nice! I'm a little backed up with other work on jest, if you have time to build this I'd appreciate a pull request! :)
 I'll close this in favor of #649, which has some concrete examples on what this could look like :)
  Please do!
  Yeah I think the problem is that it stringifies the `config` object as well and the encoding isn't stable, ie. the keys in the config object are sorted randomly. I'm not sure why that would lead to problems however, it just leads to more work for the pre-processor. But yeah, this should be fixed.
 fixed via 38a364f63ba25dadfe757f229b943a9d8c2b1033 and 5039aadbeb12686834ee5a1e455f23b3eb4d922a
  I would recommend turning of auto mocking via `jest.autoMockOff()` or just saying `jest.dontMock('googleapis');` instead.
  Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!
 Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks!
 thanks!
  thank you!
  This will be fixed in 0.6.0. Sorry about that!

https://github.com/facebook/jest/blob/master/src/TestRunner.js#L531
  Nice! Would you mind retrying the travis tests? It's unhappy, although I'm unsure why ‚Äì might be a caching issue?
  This is fixed in https://github.com/facebook/jest/commit/bc4e4a169e6d682865474f293c860d561a6d40e2 and will be out in 0.6.0.
  yes! I'll look into what format we are using for `arc unit` and whether I can just open source that :)
 Yes this is planned but I wish I had 10 hours more per day to work on jest!
 This will be in 0.6.0.
 https://github.com/facebook/jest/commit/5413b7ba6dd4e0b34ce99e51b1691fbe8dc196f5

@ide care to try this out to see if it works for you? I wanna tag 0.6.0 tomorrow or so.
 Right, the question is more like:
- does this work for you (or work at all :D )
- does it give you all the info you need
 Cool. I mean this is the same code we use at FB for arc/phabricator so I guess this is fine.
  Please bump your ulimit
 #599 is going to merge next week and it should resolve this problem too.
  @iandanforth do you think you can submit a pull request for this? :)
 We added this for `0.9.0`.
  There is no workaround for this yet. Blocked on #599. I'll likely add a way for jest to properly mock node_modules (and internals) and also will make it more strict to colocate mocks.
 I recommend using `jest.mock('path/to/module', () => {‚Ä¶})` instead.
  I think this is a jasmine issue that we can't fix. Sorry about that, using a different string should work. Maybe jasmine2 will fix it.
  This is correct. If you want to use jest with node 0.10, use jest 0.4. If you want to use the latest version of jest, use iojs or node 4.
  Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!
 Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks!
 thank you!
  thank you so much for the pull request. I'll take a look next week, but unfortunately don't have a windows machine to test on :(
 This looks good. Would you mind rebasing it on master so I can pull it in? :)
 @facebook-github-bot import
 Thanks for importing. If you are an FB employee go to https://our.intern.facebook.com/intern/opensource/github/pull_request/1497189433935922/int_phab to review.
 @facebook-github-bot shipit
 Thanks for importing. If you are an FB employee go to https://our.intern.facebook.com/intern/opensource/github/pull_request/1497189433935922/int_phab to review.
 Thanks @AttackTheDarkness ‚Äì this will be in jest 0.6.0.
  I think there might be a SyntaxError in your code somewhere that is being wrongly recorded. I'll take a look shortly.
 Well, the bigger issue in jest is that there is a promise exception that is still getting swallowed somewhere...
 Can you run the test that failed alone, without workers? `jest MyTest.js` or `jest --runInBand` should do that and give you an appropriate error message while I fix this bug.
 Thanks! There might have been some caching issues from the upgrade. We should probably wipe away the cache dir if the jest version doesn't match up.
  This was fixed in 0.5.3, let me know if this is still broken for you.
  Yes I think @yudoufu's suggestion makes the most sense.

@jsdf can you make this change?
 Thank you! I'll tag 0.5.4 shortly.
  Actually, I think the documentation is wrong here. It should be empty by default and should allow you to disable node_modules if you choose to do so. Most of the times the files you are testing depend on node_modules, so you certainly want to require them.

cc @jeffmo 
 @element6 would you mind rebasing this pull request so I can merge it? :)
 @facebook-github-bot import
 Thanks for importing. If you are an FB employee go to https://our.intern.facebook.com/intern/opensource/github/pull_request/1614744225445342/int_phab to review.
 @facebook-github-bot shipit
 Thanks for importing. If you are an FB employee go to https://our.intern.facebook.com/intern/opensource/github/pull_request/1614744225445342/int_phab to review.
 @element6 sorry for the long wait. I think this is indeed the correct default.
 Ok this one is driving me nuts. I'm going to revert this and fix the documentation. This shouldn't be the default, especially since your rootDir should be something like `src` that lives side by side with a `node_modules` dir. If the newrelic package is causing you problems I'd recommend unmocking it by default (using the other config option).
  thank you!
  Thank You!
  thanks!
  thanks @ide!
  Thanks for the report, I'll fix this shortly. I think the problem might be that either your preprocessor can't transform your source or you have a syntax error.
 Unfortunately I haven't been able to commit and tag a fix today. I'll get back to this on Tuesday and will resolve this issue. If this is blocking you I recommend downgrading to jest 0.5.0 for now. Sorry for the inconvenience.

When you see this error it usually means there is a syntax error in your code and jest isn't currently doing a good job at reporting this back.
 I'll tag 0.5.2 with the fix in a moment.
  Hm, I'm wondering whether this file is being loaded incorrectly. Can you paste the whole source of the file the way the preprocessor sees it? Basically add a console.log statement for the compiled source ‚Äì it should get compiled based on your regex but I'd like to see what it looks like :)
 It looks like this is using the object short notation. Are you sure you are using `iojs`? What does `node --version` give you? If you are using io, I'm wondering if an older version of it did not support this ES2105 feature ‚Äì would you mind upgrading to iojs 3.3?
 Thank you! jest only supports iojs 2 and up. This situation will soon be resolved with node v4, finally :)
 Closing. Let me know if this is a problem with iojs3 or node4, which was released today! :)
  Thank you!
  We are currently working on adopting jasmine 2. jest also integrates pit, which should work as well.
  Can you share the code from your test? This should work properly. I haven't used iojs 3.2 yet, can you check if there is a difference on iojs 3.1?
  Try this:

``` js
describe('Test', () => {
  var warn;
  beforeEach(() => {
    warn = console.warn;
    console.warn = jest.genMockFn();
  });
  afterEach(() => {
    console.warn = warn;
  });
});
```

and then you can test your console.warn call like any other mocked function.
  Thanks for your contribution! I've flattened your commits and merged it manually here: https://github.com/facebook/jest/commit/41d2fda5b51a2a7ceca6ff60c2062b5965a0a34b
 There has been a regression and we'll fix it for Jest 12.1 soon.
  We have updated our documentation to reflect the deprecation of react-tools.
  Basically just tell it that I don't need to do any mocking and it shouldn't hijack the mocking process.
 Yeah, jest already has this? Feel free to reopen if you are thinking of doing something else.
  Done in 0.6.0.
  Agreed! @garthk are you open to sending a pull request for this feature? :)
 This will be part of jest (0.9.0?) towards the end of the year. It is already part of #599 which will be merged in about two weeks from now. Closing this because the PR tracks this feature.
  Jest does not support node 0.12. Please use jest 0.4 with node 0.10 or jest 0.5 with iojs v2 and up.
 Feel free to send a pull request mentioning this. There are no plans to support node 0.12 as it is basically dead. The next version will be node 4.0 which will be based off of iojs 3.0
  @huang47 perfect! Followups:
- Can we add this to the documentation/website?
- Future improvements: only run the tests that was affected by the change
- It'd be great, if we can do the same thing for internal jest test runner.
 @cpojer should we release a new minor version for this?
 Before publishing this I'd like to add documentation first. @huang47 can you send a pull request for that? :) I think a patch release is fine, based on how we develop jest we have only bumped "minor" versions for breaking changes.

We can also just go back to 5.0.4 and use semver properly, I wouldn't be opposed to that actually ‚Äì let's discuss internally.
  Modules doing any kind of initializations in their code are bound to fail to be mocked.
https://github.com/chalk/has-ansi/blob/77fd627fb18b9740518a7bb65e9c3a68b9e51cf2/index.js#L3

In the following `ansiRegex()` will return undefined because it's a mock

``` js
'use strict';
var ansiRegex = require('ansi-regex');
var re = new RegExp(ansiRegex().source); // remove the `g` flag
module.exports = re.test.bind(re);
```
 I'm actually running into this issue a lot. Modules are failing to mock because some other dependency that they have have to run as part of initialization. The problem becomes is that you're trying to call a mock which returns undefined, and then you're trying to access a property of undefined (see OP).

Essentially, we're trying to mock the interface of a given node module, but we end up mocking everything underneath the interface as well. That realization lead to the idea that inline-requires will make things a lot faster (if it's not used in initialization then we don't need to mock it that early on). Inline-requires will actually mitigate part of this issue (if we don't have to require everything, there less of a chance that we hit a module that has this initialization mocking bug).

What we need to do to support mocking these kind of modules is that we need not to mock it's dependencies, we just let everything execute untouched and finally mock the interface.

cc @DmitrySoshnikov @cpojer @jeffmo 
 The documentation for this is going to be vastly improved with Jest 0.9.0, so I'm going to close out this issue. Some modules simply cannot be mocked properly because of the meta-programming they do.

I'm quite convinced in your example you either used npm3 or you deduped your npm2 dependencies, causing `ansi-regex` to be mocked. This will be fixed in 0.9.0 as well, so the original issue doesn't apply any longer.

I agree with you that mocking is sometimes a pain. I'm hoping to improve both the mocker and the documentation further in the future, but I don't think there is anything actionable left to do in this issue.

See #763 for the documentation updates.
  You have to install iojs to use jest 0.5.

You can keep using jest 0.4 with node JS 0.10

node 0.12 does not work with jest.
 No, unfortunately we won't be able to support node 0.12.x which is "pretty much dead". The next version of node is 4.0 which is based off of iojs3 and will have some support for node 0.12, although I do not know what the extent of this is.

I understand your pain, v8 APIs change all the time with bad upgrade paths. I recommend you to look into node-nan ( https://github.com/nodejs/nan ) a project that aims to eliminate these issues.

The problem is that before node 0.12 came out and after iojs was announced, the jsdom project decided to switch platforms and only support iojs. I'm planning to make jest work without jsdom for things like node environments, which might help you. Since we moved directly from node 0.10 to iojs at Facebook, which is the better upgrade path, we are not planning to support 0.12 ‚Äì if you would like to hack on it and provide a solution in a Pull Request, that would be awesome.
  You have to use iojs v2+ to use jest 0.5

If you are stuck with nodeJS you have to use jest 0.4.x
  Hello. Would you mind producing a simple test case or, if that is not possible, share all your store logic so I can reproduce and investigate this issue?

If not, then I'll assume this is a problem with your code and unrelated to jest :)
 The issue is likely that `objectAssign` is mocked, therefore driverStore never receives those methods. You should unmock it by default.
  Finally fixed: https://github.com/facebook/react/pull/6052
  Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!
 Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks!
 Thank you!
  I recommend using `jest.mock('@namespace/module/name', () => {‚Ä¶})` for this. I don't think we'll add support for nested mocks.
  thank you!
 How long does this svg take to update? It says 0.4.19 because it was he last published version, but the latest version we recommend to users is 0.5.0 which I published before 0.4.19.
 I guess it just uses the last one published, not the latest one based on semver which makes sense.

On Sat, Aug 15, 2015 at 9:28 PM -0700, "C. T. Lin" <notifications@github.com<mailto:notifications@github.com>> wrote:

Normally svg update so fast. It's so weird. The latest version of jest-cli which shown on npm pagehttps://www.npmjs.com/package/jest-cli is 0.4.19, and version installed by npm install jest-cli also 0.4.19. Maybe some npm bugs here?

‚Äî
Reply to this email directly or view it on GitHubhttps://github.com/facebook/jest/pull/461#issuecomment-131490111.
  Are you guys on node 0.12? jest does not work well with that version of node. You'll have to use node 0.10.

We'll soon be tagging jest 0.5, which will work with iojs v2 and up and we'll deprecate node support completely.
 Jest does not support any version of node 0.12. You need to use 0.10 or iojs 2+. Would you mind confirming that it works both in node 0.10 (with jest 0.4.x) and in iojs 2+v (with jest 0.5.x)?

I'm sorry for the pain, but node/iojs are almost reconciled and we'll soon be able to move forward with node v4 only :)
 I don't think there are any action items here. 

@Verikon your comment seems unrelated to this issue. Let me know if it still persists with the latest version of jest in a separate issue.
  Good point. Maybe one day we can stop using internal APIs :)
 cc @DmitrySoshnikov why are we using runInContext here?
  Thanks for the list @domenic. On it.
 fingers crossed for the segfault issue.
 Seems like Buffer itself isn't part of jsdom. Would you be ok with me sending a PR to jsdom to add it? What about DataView (although I'm not sure any tests at FB depend on this). process should probably not be part of JSDomEnvironment ‚Äì I'm planning to add other environments for this use case.
 yep, makes sense. Thought we had a buffer implementation on the web for some reason ;)
 Done in e5484b0eaea9310c9c46859d368953026c791401 and bd1f22b7996725764fd41204f6c92be12f5f3987
  :+1: 
  Make `0.5.x` as a new master.

CC @ide, @cpojer, @amasad 
 Awesome.
 @ide planning on doing this after I deployed 0.5 at FB.
 y u no publish?
 I updated the latest tag. I guess I didn't quite understand how npm works and wasn't aware of the `dist-tag` command. It should work properly now.
  This doesn't look good. Can you upgrade to the latest version of iojs and report whether this is still happening?
 Feel free to reopen if this problem still persists.
  Yes, you need to mock `Date.now` with your expected return value, like this: `Date.now = jest.genMockFunction().mockReturnValue(0);`
 Yes.
  Please update to jest 0.5 and node 4, this problem should have gone away.
  Fix coming in 12.0.2 in a bit!
  We don't support node 0.12. Please upgrade to node 4 and jest 0.5 or use node 0.12 with jest 0.4
  Please feel free to reopen this issue once you add more context. I don't understand what exactly you are asking. You can probably do what you want or we can add this feature if it doesn't introduce technical debt.
  Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!
 Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks!
 OK, thank you!
 Yeah, sorry for the delay, will publish now.
  OK, thank you.
  There is also nomnom which we have been using for https://github.com/facebook/jscodeshift
 @fkling what would you recommend? I remember we had this discussion around jscodeshift as well.

@mbrio it would be awesome if you could take this on! I'll try to merge #800 today, it probably makes sense to wait for that first :)
 Alright, the refactor from #800 has now landed!
 I'm gonna close this because I honestly don't really care much about it. It works just fine. @dmitriiabramov is thinking of redoing some stuff here, so maybe he can consider to replace this module eventually.
 I agree. The deprecation notice itself is not enough for anyone at FB to spend time working on this.
  With `vm.runInContext` and jsdom 5.4.3, we started to get `ReferenceError` issues:

``` js
describe('strict eval', function() {
  it('eval', function() {
    var code = [
      'var _bar = 10;',
      'function foo() {',
      '  "use strict";', // because of this
      '  return _bar;',
      '}',
    ].join('\n');

    eval(code);

    new foo(); // Reference error: _bar is not defined
  });
});
```

Thus it relates only to `"use strict"` inside the function, without it, `_bar` is available in the `new foo()` call.

The `vm.runInContext` seems works fine in isolation in this case. Can be jsdom related?

CC @ide, @domenic
 OK, it's nevertheless issue of `vm.runInContext`. If a code is wrapped into a function, then `eval`ing strict function inside that function, doesn't capture the bindings.

This works (file `test.js`):

``` js
var code = `
var foo = {m: 1};

function bar() {
  "use strict";
  return foo;
}
`;

eval(code);

bar();
```

Node session:

```
> vm.runInNewContext(fs.readFileSync('/Users/dmitrys/test.js', 'utf-8'))
{ m: 1 }
>
```

This doesn't:

``` js
function main() {

  var code = `
    var foo = {m: 1};

    function bar() {
      "use strict";
      return foo;
    }
  `;

  eval(code);

  bar(); // foo is not defined

}

main();
```

Node session:

```
> vm.runInNewContext(fs.readFileSync('/Users/dmitrys/test.js', 'utf-8'))
undefined:6
      return foo;
             ^
ReferenceError: foo is not defined
    at bar (eval at main (evalmachine.<anonymous>:13:8), <anonymous>:6:14)
    at main (evalmachine.<anonymous>:15:3)
    at evalmachine.<anonymous>:19:1
    at ContextifyScript.Script.runInNewContext (vm.js:18:15)
    at Object.exports.runInNewContext (vm.js:49:17)
    at repl:1:4
    at REPLServer.defaultEval (repl.js:154:27)
    at bound (domain.js:254:14)
    at REPLServer.runBound [as eval] (domain.js:267:12)
    at REPLServer.<anonymous> (repl.js:308:12)
```

Unless I'm missing something obvious from strict mode, it's probably a bug in `vm` module, and is not related to Jest or jsdom.
 Need to notice, this is test form io.js `v2.3.1`. With Node `v.0.12` the `vm.runInContext` has even different behavior: the `bar` is not defined there.

Also, if no `"strict mode"` is used, then the `foo` is captured in `bar`.
 OK, I filed this issue on `io.js` yet: https://github.com/nodejs/io.js/issues/2245, hope we'll get some clarifications. Though, it's currently a blocker for us at Facebook to switch to Jest 0.5 with io.js (CC @yungsters), and probably will be a blocker to merge 0.5 to master on August 1st as we planned.
 This seems like it was fixed in node 4.
  Thanks!
  OK, seems reasonable, thanks!
  Thanks!
  I'd be open to accepting a pull request if someone finds a sane way to do this. I expect it to be pretty slow though if you run this as a separate step. I guess what you are looking for here is do what @browniefed suggested - write a test that requires an entire app. Since you need basic instrumentation I don't think there will be any good generic way to do this other than writing a test itself.

Feel free to reopen if you want to submit a pull request but I'm probably not going to have time to build this anytime soon myself.
 `collectCoverageFrom` can be used for this, it takes globs to match files and then runs coverage on all files in the project that match.
  Cloning here would be too expensive for performance. I understand this is an issue but the side-effect in your function is probably not something you'd want in your application anyway, I'll assume? While I do not know what your application is doing, shallow copying the object in your function `Object.assign({}, obj)` is probably reasonable.
  This should be fixed in 0.9.0, currently as alpha release tagged with `jest-cli@next`. Let me know if this still doesn't work and I will reopen this issue.
 @blainekasten can you provide a repo that highlights this issue so we can add it as an integration test and fix it?
 Oh you are right, it's because we don't collect coverage information from tests. I'm not entirely sure what the best behavior here should be ‚Äì I believe when we fix the test path pattern to be based on the full path rather than just the directory name, this bug will resolve itself :) Soon!
 I think this should be fine now. If there are issues that are still unresolved with Jest 12.1, please open individual new issues.
  I'm adding `console.log` to my `exports.process` function and it works. Maybe this was recently fixed?
 This should work much better in 0.6.0.
  Oh yeah, we actually updated the documentation but I haven't yet had time to push the update to the website!
 updated: http://facebook.github.io/jest/docs/tutorial-react.html#content

we should probably revamp the docs a little bit :)
  This might be a problem in Jasmine itself. Perhaps when/if we upgrade to a newer version of that this will just work.
 Fixed in the next release.
  OK, sounds good, thanks.
  Jest doesn't work on node 0.12. You need to upgrade to node 4 (use jest 0.5+) or use node 0.12 (use jest 0.4 or below).
  @mleavitt, yeah, sorry, I didn't have chance. The plan is now to make `0.5.x` as master, and maintain legacy `0.4.x` separately. This should happen on August 1st, 2015 (we started to issue deprecation notice). From this perspective, not sure we need to publish additional version on npm yet (and legacy version can be installed from the Github's branch). If this is still very on demand, we can probably publish the new beta tag (though later it'll become obsolete and may bring confusions).
  Sorry for not to be clear in the message, we should probably rephrase it (feel free to send a PR with the rephrase, although, make sure it's not too big message). We decided to move to `io.js` in the new versions (since https://github.com/facebook/jest/pull/374), since it's faster (doesn't have dependency on the `contextify` library we used previously), has more new features, and also `jsdom` dependency doesn't support legacy Node and also work only on `io.js`.

The option for legacy Node will still be available via the `0.4.x` branch. We'll try to maintain it as well with new features, although would recommend switching to `io.js`, which eventually will be merged with Node again.
  Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!
 Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks!
 Thanks!
  OK, makes sense, thanks!
  Thanks!
  This has been published as `v0.4.15`.
  Disk caching layer is added. Caching is done by default, unless explicitly disabled via the `preprocessCachingDisabled` config option. Preprocessor script may also export `getCacheKey` method,  in case of custom hashing or invalidating logic for a cache key.
  Yeah, we should replace it with a function expression. Not sure why it was a declaration with an explicit suppression from JSHint rule `/* jshint -W082:true */`.
  Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!
 Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks!
 Hey @blainekasten,

how do you feel about changing this to recommend babel-jest and then explain how to customize the transform if necessary?
 thank you!
  Please upgrade to node 4 and jest 0.5.x
  Awesome, thanks!
  jest 0.6.0 will have a `moduleNameMapper` config option that allows to map these kind of modules to a stub module. See https://github.com/facebook/jest/blob/master/src/HasteModuleLoader/__tests__/HasteModuleLoader-requireModuleOrMock-test.js#L24 and the tests on the bottom.
  We actually add more stuff than just those two fields and we should have all the info that we need there. I recently added `parent` but it is only a stub module. `module.parent` sucks.
  OK, sounds good, thanks!
  Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!
 Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks!
 OK, looks legit, thanks.
  What's the specific use case? The diff description doesn't explain this.
 I see, OK, sound good. Thanks!
  yap, we are not supporting old versions of node or npm any longer. Thanks for the report!
  Perfect, thanks!
  I have tagged 0.5 which works on iojs 2 and up. Contextify is dead. Please try installing iojs + jest 0.5 and report back here :)
 I'll close this; feel free to reopen if you are still having issues. If yes, I will have to get a windows computer I'm afraid :)
  I recommend giving Jest 0.9 a try which is basically a rewrite of Jest :)
  We noticed some performance regression after #333 in tests that do a lot of mocking. We should investigate how to make getting of non-enumerable properties faster. Probably we want to run the slow path only for the cases we know are for ES6 classes.
 CC @AsaAyers
 Yeah, without some special tag it seems hard to determine reliably. Let's keep this issue opened to get some ideas, or probably to rewrite the code in more optimized way.
 There is no way to do this during runtime but I have ideas on turning this into a babel-transform in the future:

``` js
class A extends C {
  foo() {}
  bar() {}
}
```

becomes:

``` js
class A extends C {
  foo() {}
  bar() {}
}
A.__jestMockFields = C.__jestMockFields.concat(['foo', 'bar']);
```

This should be easy to build and experiment with but it won't support any sort of meta-programming so I'm not sure how viable this will be, especially at FB where we have a lot of tests that might be incompatible with this.

@DmitrySoshnikov are you willing to experiment with this? This could speed up mocking significantly.
 I don't think the original intention of this task is still important. We'll change mocking when we need to but we absorbed this performance hit in order to be more correct.
  Great, thanks!
  It would be great having progressive output in the `--verbose` mode. Currently, if some test takes long time, non of the individual `it` results are shown until the whole test ran. And then we can fix `--bail` mode to affect each `it` as well.
 CC @PhilVargas 
 Yeah, I'll need deeper investigate the reporter hooks, but seems we can [handle](https://github.com/facebook/jest/blob/master/vendor/jasmine/jasmine-1.3.0.js#L1034-L1038) the `reportSpecResults`, and slightly rewrite our [JasmineReporter](https://github.com/facebook/jest/blob/master/src/jasmineTestRunner/JasmineReporter.js).
 Ah, this is very true. OK, we'll need to think how can we combine it with the sequential runs, for now seems it's a blocker.
 I think the goal should be to make jest faster instead of complicating how jest works in --verbose mode. The blocker above shouldn't exist any more from 0.6 onwards so we could potentially build this, although I'm worried about messages being out of order.

If you want to build it, feel free to reopen this issue ‚Äì I'm all for it :)
  This one prints test path and time to be consistent in the header output in the short mode.
 All passed:

![screen shot 2015-06-11 at 3 56 51 pm](https://cloud.githubusercontent.com/assets/244010/8120354/0ec5118a-1053-11e5-97a3-e3d2a0b75dc0.png)

Some failed:

![screen shot 2015-06-11 at 3 56 14 pm](https://cloud.githubusercontent.com/assets/244010/8120358/1b304ac0-1053-11e5-8965-0197294cb235.png)
 CC @PhilVargas 
 @PhilVargas, ah, that's true, it can be simpler. Feel free to send the PR, I'll automerge it.
  The issue here is that jest tries to name functions using reserved keywords like "catch" in this case. And Symbol.for in #528. I'm sure a lot of other things are effected by this too.
  Don't mock non-enumerable accessors yet: they may throw, and fail in the mocker, when the mocker tries to get the value by the slot. Fixes #389, #380.
 CC @AsaAyers 
 Yeah, OK, I'll change the comment.
  I think this is currently not really feasible so I'm going to close this out. If you feel strongly and would like to work on this, I'd be happy to support you all the way and give useful pointers (and will obviously reopen this issue).

In the future we'll probably add a `deepUnmock` feature to unmock a module recursively, which should help with this as well.
  I like it! nit: can we call it `--bail`? inspired from mocha.
otherwise I'll let @DmitrySoshnikov merge
 This is looks great, thanks. Let's fix the nits, and it's good to go.
 Thanks!
  OK, looks good. What about Travis errors?
  We're going to invest in io.js update, and 0.10 will likely be final version for legacy node (since new jsdom version doesn't support 0.12).

Closing this issue, since it's tracked in #243.
  Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!
 Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks!
 OK, thanks!
  I'm going to start rewriting the haste module loader soon and want to support third-party module loaders as outlined in this plan above. @iamdustan let me if there is anything I can do to support you better with the new functionality. Is adding a config for a different module loader enough for you?
 There is a `moduleLoader` config already that allows you to specify a custom module loader. Is that enough for most cases?
 What, you accepted a new job and didn't check with me first?
 @akheron I suggest using a preprocessor to compile your code to ES5 before running test. Look at the `babel-jest` npm module.

@amasad can you elaborate on how the new dependency resolver resolves modules in this case?
 So there are two issues here:
1. `@providesModule` being a single namespace (which is what fbjs uses). That means that require('warning') will get the last one node-haste managed to look at last. :mask: 
2. node-haste not supporting recursive node dependencies: when you have two foo node_modules, in different parts of the tree it will also pick one at random :tired_face: 

The react-native-packager resolver we're gonna base this off will solve these two issues by:
1. Doesn't allow node_modules to reach into the `@providesModule` namespace
2. will support recursive deps
 you can still transform this file, you might have to update some configs but you can compile node_modules if you want.
 This work was completed in #599. Yay!
  Yeah, the mocker should consider accessor properties and not to call an accessor function. See the #389.
  Yeah, it looks kind of inconsistent with other `import` statements, and doesn't explain why this module is `require`d instead of `import`ed, but it seems the only workaround. Thanks!
  We're going to invest into io.js update, and 0.10 will likely be final version for legacy node (since new jsdom version doesn't support 0.12 anymore).

Closing this issue, since it's tracked in #243.
  Yeah, `import`s are hoisted (see https://github.com/babel/babel-jest/issues/16), so workaround is to use explicit `require` here. See also https://github.com/facebook/jest/pull/379. Closing this one.
 For future reference, the new API we introduced together with `babel-jest` from 0.9 onwards is `jest.disableAutomock()`.
 We do hoist `jest.disableAutomock()` :)
  @ide, this is something really great! Does the update fix automatically the node v.0.12 as well (the contextify issue was one of the main there)? I'm on PTO at the moment, but I'll get back to this PR for detailed review in a week. And we can discuss in detail the further plans on supporting separately jest 0.4 and 0.5.
 > `<script>` tag was 10x slower

Performance is currently one of the Jest's issues which invest the most resources, so don't think we can degrade it this way with the `<script>`.

@domenic, would be great to have some workaround if the global object is a private data (any suggestions?). Or, could we just expose getter for the global object for public API?
 I see, thanks for the info guys. Yeah, we'll need something that wouldn't degrade the performance, since again it's one of the main Jest's issues at the moment. The `runScriptWithoutScriptTag` could be good solution.
 @ide, OK, thanks for the info. We probably can go with it, also I agree with @domenic it'd be better not to access private data. @domenic, what is your input on this? Do you think it makes sense to provide that `runScriptWithoutScriptTag`?

Also, since which version jsdom dropped support of node? I'm still thinking about making it work on node 0.12 by using `vm` module, but just with some previous version of jsdom.
 @ide, yeah, I think as a "temporary fix" it might work, and I agree is probably better than what we have now with stuck in 0.10 (long term, depending on private state is looking for maintenance issues). Do you still think that before major version update (to `0.5`), we can probably update jsdom to `< 4.x`, and help people with solving #243. Then we can drop support of Node, and the final supported version will be 0.12 for Jest 0.4. And Jest 0.5 will work only with io.js. If again, it's not worth the effort, I'm fine with having 0.10 for old Jest version.

Ideally, we could probably even keep two versions of jsdom to support node and iojs. Since we commit to Jest more often, and devs who will be on Node 0.10 won't have these new features/fixes, unless are forced to switch to io.js.

As long as all tests pass, I think we can merge it.

Also will be great to measure some performance changes (I hope to see something faster).
 OK, I'll try updating to jsdom 3.x and fixing the Node 0.12. And after that we can merge this one.
 @ide, thanks for the detailed analysis. I see you make it configurable via the `USE_JSDOM_EVAL` variable (although it's local to a file, and cannot be passed as an option or something). At FB on www we try to win every ms of performance now, so maybe we'll use still the way with `vm` there.

Mind keeping this PR for a bit? -- we'll need to prepare for supporting `0.5.x` and legacy `0.4.x` in parallel, and announcing that Jest will be working only with io.js. Also, I still haven't tried running it on 0.12.

@domenic, in the view of io.js and Node projects rejoining, does it still make sense to explicitly disallow Node for `jsdom`? Although, as official [documentation](https://nodejs.org/download/) says "io.js releases will continue in parallel". This "in parallel" makes me worried, since if we're gonna work only with io.js, there will be no way to return to Node, if node 0.13, 0.14, etc will appear, and devs will stuck forever with io.js, and probably will have to maintain different versions of node.
 OK, sounds good guys, I'll merge it later on today to `0.5.x`.
 @ide, do you know whether github supports yet changing target branch of a PR (I just created `0.5.x` branch)? If not, I'll merge it manually from command line.
 OK, merged manually to https://github.com/facebook/jest/tree/0.5.x (I think we can close the PR manually to now). @ide, thanks a lot for this PR! @domenic, thanks for the info on jsdom and the things.
 Yep, thanks, we'll follow up with the cleanup which @domenic mentioned. Also, if people will adopt io.js well, I'll consider merging `0.5.x` to master soon (just tested it, it is faster), and `0.4.x` will stay legacy of Node 0.10.
  OK, looks good, thanks!
  Seems like this was unfortunately still not merged into jsdom. I'm closing this issue here as there is a corresponding issue on the jsdom issue tracker and we'll update once it is fixed.
  This looks really good. We can probably change recursion (in building and reporting the tree) with a loop for a better performance, although, if it's not noticeable performance win, we can keep recursion since it's cleaner.

For the visual output, you may want consider instead of coloring the whole title as green, to use just a green checkmark (or red cross in case of failure) -- you can check how Mocha framework displays it.
 OK, this looks perfect, thanks for the contribution!

(worth also measuring the time with verbose and standard outputs for analysis)
  Should be fixed via #540 (will go out with version 0.6). Please reopen if that's not the case. 
  Thanks, it makes sense.
  Feel free to reopen if this is still an issue with the latest version of jest (0.7.1+).
 No, did I say anything like this?
 It is unlikely there'll be official support for this library unless it is a community contribution.
  This is currently being done using `testPathDirs`, which unfortunately has a misleading name but allows to include modules and test files.
 `modulePaths` and `moduleDirectories` is now part of Jest 12.1.0. We'll be adding some more documentation for the website but it should match the implementation in webpack. See http://facebook.github.io/jest/docs/api.html#moduledirectories-array-string
  For a non-TTY session do `--noHighlight` mode by default.
 boom
 :shipit: 
 @latkinsa what's an example of it running in a subshell?
 I think it makes sense to invert the option: `--forceHighlight` to force it for non-tty but wants highlight:

```
 if (!argv.forceHightlight) {
   config.noHighlight = !process.stdout.isTTY;
}
```
 @latkinsa, yeah, if you need highlight from a non-TTY run, the `--forceHighlight` option would make sense (we can remove explicit `noHighlight` option then, but keep it in config, basically what @amasad suggested). Want to send a pull request?
  This is looking great. Thanks ColCh. I'm currently a bit swamped with other work on jest but I definitely want to make the module loader pluggable so you can add your own WebpackModuleLoader to jest as a plugin in the future!
  Yeah, we can rephrase it this way. Although, "immediately adjacent" I guess meant exactly the `__mocks__` dir located where the module source file is. Or, can you clarify and give an example of "either" and "or" cases?
  I see, I guess you're right, in case we want a real regexp, it should no espace `(` and `)`, so now I think we don't need `escapeStrForRegex` :smile: Also, we should keep in mind, that `new RegExp` expects `\s` and similar to be `\\s`. We can leave it up to a user, but seems would be better to handle it, and append those slashes.

``` javascript
(new RegExp('\sa')).test(' a'); // false
(new RegExp('\\sa')).test(' a'); // true
```
 OK, looks great, thanks!
  I can see the need for this, however, I'm thinking whether the `_jestTestFilePath` "injected global" is the best approach here? We already expose Jest's runtime for `setupTestFrameworkScriptFile`, so alternative way would be `jest.getTestFilePath()`. OTOH, it may unnecessary bloat the runtime's API, and maybe this injected global is OK-ish.

@vjeux @amasad @zpao, what you guys think?
 Yeah, let's just add the `jest.getCurrentTestPath()`. You may pass the `filePath` either as a parameter to the loader (or alternatively, just attach it to the environment object, and then you will be able to access it in the module loader constructor). Then add the method here: https://github.com/facebook/jest/blob/master/src/HasteModuleLoader/HasteModuleLoader.js#L956
 Thanks!
  Hello,

let me know if this is still an issue with the latest version of jest and feel free to reopen this task.
  @McNouvion, yes, seems it's true, this option is broken, and should use `new RegExp(...)`. Want to send a pull request? Also, this option wasn't documented in the `./bin/jest.js`, so we probably want to add and document it there as well.
  This issue is to discuss the behavior of [`setImmediate` mock](https://github.com/facebook/jest/blob/master/src/lib/FakeTimers.js#L331), which was implemented in https://github.com/facebook/jest/issues/213.

Let's say we have this module:

``` javascript
var Foo = {
  bar(callback) {
    setImmediate(() => callback());
  };
};
```

And a test for it, where the callback should throw:

``` javascript
var mockError = new Error('Expected callback error.');
mockCallback.mockImplementation(() => {
  throw mockError;
});

Foo.bar(mockCallback); // somtimes throws here (race condition)

expect(() => {
  jest.runAllTimers(); // sometimes this isn't reached
}).toThrow(mockError);
```

Since the mock [runs original `setImmediate`](https://github.com/facebook/jest/blob/master/src/lib/FakeTimers.js#L347) (and also puts it into `cancelledImmediates` after it -- which is simply confusing, since the immediate call wasn't canceled!) -- because of this real run, we get race condition, when the real run is executed prior the `except(...).toThrow(...)` happens, and the the whole test run fails because of the thrown exception.

I have couple of questions:
- Should we actually run the original `setImmediate` right away (the `nextTick` does the same, but `setTimeout` doesn't)
- If yes, and we have this race condition, how to test this use case?

CC @wwalser, @leebyron, @amasad, @zpao 
 Why should the real `setImmediate` run before the sync `runAllTimers` call? `setImmediate` _should_ be async.
 Just tried your example and it works every time
 @wwalser, thanks for the explanation (didn't mean to interrupt your vacation, sorry :)).

Yes, it true, it works in an isolated example, but fails (inconsistently, with races) if there is a least one async test. To confirm:

Foo:

``` javascript
var Foo = {
  bar: function(callback) {
    setImmediate(function() { callback(); });
  }
};

module.exports = Foo;
```

Test:

``` javascript
'use strict';

require('mock-modules').autoMockOff();

var Q = require('q');

describe('Foo', function() {
  beforeEach(function() {
    mockCallback = jest.genMockFunction();
    Foo = require('../Foo');
  });

  it('test 1', function() {
    var mockError = new Error('Expected callback error.');
    mockCallback.mockImplementation(function() {
      throw mockError;
    });

    Foo.bar(mockCallback); // fail because of test 2

    expect(function() {
      jest.runAllTimers();
    }).toThrow(mockError);
  });

  pit('test 2', function() {
    var d = Q.defer();
    d.resolve(1);
    return d.promise.then(function(x) {
      expect(x).toBe(1);
    });
  });
});
```

It just was confusing, since `setTimeout` mock doesn't actually execute original `setTimeout` (and hence always works synchronously), but `setImmediate` does. Since newer version of jest our tests start to fail, because `setImmediate` is now available.
 OK, I found the bug, it's in the `runAllImmediates`, [here](https://github.com/facebook/jest/blob/master/src/lib/FakeTimers.js#L133-L134). The `this._cancelledImmediates[immediate.uuid] = true;` should be executed _prior_ calling the callback, because callback may throw (like in our specific case), and the `uuid` won't be recorded in the `this._cancelledImmediates`. And then eventually the callback from the original `setImmediate` call [will be executed](https://github.com/facebook/jest/blob/master/src/lib/FakeTimers.js#L324-L325) -- because it was scheduled by node, and because `this._cancelledImmediates` doesn't contain this `uuid`.
 :dancer: 
  Does the tutorial work if you check out the repo and run it from there?
 Very probably related to #243.
 Jest only works with node 4 (jest 0.5) or node 0.10 (jest 0.4 and below).
  OK, seems accessing the runtime from those files can be useful in some cases, thanks!
  This will be fixed in the next release of jest, `node` was added as a default!
  Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!
 Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks!
 Seems legit, thanks. Potentially we could use more from `lodash` utils, but for now just template dependency is enough.
  See #243
  @fabiomcosta, which new version of jsdom are you using? We have an issue to update to the newer version, see https://github.com/facebook/jest/pull/221. If it's unrelated, the PR looks good to me. CC @zpao 
 OK, sounds good, thanks!
  If you require your modules in `beforeEach` you won't be running into this problem and every call to `it` will receive a new module environment:

``` js
var A;
beforeEach(() => { A = require('A'); });

it('test 1', () => doSomethingWith(A));
it('test 2', () => doSomethingElseWith(A));
```

both calls to `it` will receive different versions of A.
 @graue @mrsharpoblunto please feel free to send a PR to fix this behavior.
 Sure, if you send a PR with a test :P
 We have `jest.resetAllMocks()` and `fn.mockReset()` now.
  This is probably because of automocking. You should probably use requireActual which won't get mocked (I think). But also you might not want the polyfills in the test itself but in the environment (this is what we do for jstransform - https://github.com/facebook/jstransform/blob/master/jestEnvironment.js to make sure some ES6 features are available).
  This is a result of React + JSDOM (which is used by jest). React prepends the `\n` for browser consistency. JSDOM doesn't read that value back the same as browsers actually do. We actually explicitly work around this in our React test for this (https://github.com/facebook/react/blob/master/src/browser/ui/dom/components/__tests__/ReactDOMTextarea-test.js#L32-L34). I would imagine this would get solved by upgrading our JSDOM dependency, which we'll get to eventually. For now though I'm going to close this out since we're not going to explicitly work around this here.
  Thanks :)
  Should be fixed via #540 (will go out with version 0.6). Please reopen if that's not the case. 
  This is fixed in 0.5.
  v2 seems like it should work, however you also seem to be hitting the error we see when using node v0.12, which jest doesn't support well / at all. See #243 for more.
 Check out this pull request: https://github.com/facebook/jest/pull/417
  duplicate of #335.
  I'm going to assume that this should probably work with babel. I'm going to close this as babel has a `retainLines` option that we are using in `babel-jest` and at FB we are currently unlikely to use another compile-to-JS language that needs this feature. Is there a reason why you'd want source maps if you know the exact line number of when something is failing?

I also appreciate contributions to `babel-jest` (see the `packages/` folder) that improve support here.
 @felipeochoa I have no smart thoughts on this to be honest, so feel free to send a pull request with the changes and with tests and we'll see where can take it.  I recommend using jest.mock('path/to/module/name', () => {‚Ä¶}) for this. I don't think we'll add support for nested manual mock files.
 We aren't currently investing in improvements to the mock system heavily. If you'd like to work on this please join us on discord (#jest on reactiflux) and I'm happy to help you get a PR ready :)
  Hey @chrislloyd. I think with babel6 and the Jest+Babel auto-integration, there is little need to use webpack for processing. However, webpack might be doing some things that Jest does not and I'd like to collect a list of things that are missing from Jest that make it not work so well with your particular projects.

Here is a list of things that would help:
- What does webpack do when it processes files that Jest doesn't do?
- What kind of special things does `require` do in webpack?
- Can you provide a sample project on GitHub that uses webpack where I can dig into the webpack config to understand what specifically doesn't work?

My guess is that with `babel-jest` we are already 90 % on the way for good webpack support. If we can identify the things that don't work yet, I'm more than happy to guide you through fixing those one or two minor issues to make the support great out of the box.
 @sampeka: can you share a typical webpack configuration with all the special things require does in webpack? Then we can consider improving support for it. I think besides the consolidation around babel (and `.babelrc`) and the `moduleNameMapper` feature in Jest we probably won't need to much other stuff.
 After all this time we have finally implemented more support for webpack. I'm sorry for the long wait. `modulePaths` and `moduleDirectories` are now part of Jest 12.1.0. We'll be adding some more documentation for the website but it should match the implementation in webpack. See http://facebook.github.io/jest/docs/api.html#moduledirectories-array-string A long time ago we also implemented a `moduleNameMapper` feature which should be similar to the alias feature in webpack. It can also be used to map css/scss files to a stub module, see http://facebook.github.io/jest/docs/api.html#modulenamemapper-object-string-string For actually compiling scss/css for a test, a separate preprocessor can be created that uses node-sass and babel-jest ‚Äì this is something I'd be happy to accept a PR for and happy to maintain a `babel-webpack-jest` package, for example.

I think we support all the features for module resolution well and testing a project with Jest when using webpack should work well, so we can close this issue at last.

cc @jquense who offered to write some documentation for the website and who implemented this feature into jest-resolve.
  cc @jeffmo 
 I think we should go with this PR, but we need to support all methods on classes, including those that override defaults (like `toString`).

So, will something like this be sufficient:

``` javascript
/**
 * Returns all properties in the prototype chain,
 * including non-enumerable (to support mocking of
 * ES6 class methods). Doesn't consider Object.prototype
 * at traversing.
 */
function getSlots(object) {
  var slots = {};
  do {
    Object.getOwnPropertyNames(object).forEach(function(prop) {
      slots[prop] = true;
    });
    object = Object.getPrototypeOf(object);
  } while (object !== Object.prototype);
  return Object.keys(slots);
}

// tests

var foo = Object.create(Object.prototype, {
  m1: {value: function() {}},
  m2: {value: function() {}},
  m3: {value: function() {}},
  m4: {value: function() {}, enumerable: true},
  p1: {value: 10, enumerable: true},
});

var bar = Object.create(foo, {
  toString: {value: function() {}},
  m5: {value: function() {}},
  m6: {value: function() {}, enumerable: true},
});

// ["toString", "m5", "m6", "m1", "m2", "m3", "m4", "p1"]
console.log(getSlots(bar));
```

And then the usage will be:

``` javascript
getSlots(metadata.members).forEach(function(slot) {
  ...
});
```
 OK, let's go with this version. Thanks for this fix!
 :santa: 
 Yeah, the mocker should consider accessor properties and not to call an accessor function. See the #389.
  Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!
 Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks!
 Sorry for the delayed reply, this is a great progress, glad to see this PR. The issues described above though (with failing React test on comparison of deep objects, fixing `pit`, etc), still would be great to solve before we can actually switch to the newer version of jasmine (ideally, to the latest version).
 @tomv564, perfect, I'll follow up for the `jasmine-pit` fix, and will make sure it's merged, and then we can continue on other remaining issues. Would be great if we can make latest jasmine version as main, and deprecated jasmine 1.x.
 This is awesome. Is there an overview of all the API and breaking changes? I'd like to upgrade our tests at FB so we can start using jasmine2.

Do you guys have any numbers on the performance impact of switching to jasmine2?
 Update: I'm currently spending some time cleaning up APIs on our largest jest deploy. Once I got all the tests in a good state I will take a look at what it takes to merge this in and move over all of FB to jasmine 2.
 I'm quite swamped with all the work around jest atm. We have big plans to improve all the internals of jest and to make jest better, faster and more stable. I need to see how this change affects all tests at FB and how long it would take to deploy. It's on my mind, I haven't forgotten! :)
 I'd prefer to bump the version of jest and use jasmine2 exclusively however!
 Alright, I finally got around to spend time on this. This looks really good, @gagoman would you mind rebasing this on top of master before we continue? I'm sorry for causing this pain :(
 I think it is fine to add jasmine 2 support as an option. I'll think about the deprecation strategy for jasmine 1 later and when it makes sense to make jasmine 2 the default. Ideally we'll support any kind of test framework within jest in the future and we can split jasmine1 support out into a separate npm package.
 @gagoman did you get a chance to work on this? :)
 @gagoman thank you so much! I'll take a look in a bit. I'm hoping to merge this for the December release with the new resolve (jest 0.8.0).
 Ok, as a first step I'm elevating jasmine-pit into the jest repo. There is no point in keeping it in a separate repo. Going to get code-review for this and push it out.

I need to figure out how to deal with your diff. I'd like to make some changes to your pull request but I want the sync script to properly attribute you for your diff. I might merge your diff internally and make my changes in a separate diff. Thanks for all the hard work and I'm deeply sorry that it took forever for someone at FB to take a look at this. This is not ok and will not happen again.

If you want to hang out with me and other people using jest online, feel free to join our channel on discord: http://facebook.github.io/jest/support.html :)
 @facebook-github-bot import
 Thanks for importing. If you are an FB employee go to https://our.intern.facebook.com/intern/opensource/github/pull_request/1663907390495818/int_phab to review.
 Awesome. This _almost_ works internally. I have a couple of small modifications to your diff and will make a cleanup diff afterwards to make all of this fit into jest better. I'll try to land all of this tomorrow.
 Yeah it seems like there is something else going on internally that is unrelated to your changes.
 Nope, I'm almost done! Going to merge it tomorrow when I get up.
 It's happening!

@gagoman thank you for your contribution. I'm deeply sorry it took so long for this to get merged. I have taken your implementation and polished it up a little bit in a follow-up.
 This is really annoying. Our FB GitHub bot picked one user in this PR to give attribution to because it flattens everything into one commit. @gagoman if you'll accept I would like to send you a ReactJS tshirt as a thank you for pushing this change through for this entire time. Send your tshirt size, name and address to cpojer@fb.com. I'm going to be out of the office for the next 12 days but I'll make sure that you receive this by the end of the year.
  Does it it have an isolated repro, and does it still repro? Otherwise, can we close the issue?
  You can load polyfills into the environment by using `config.setupEnvScriptFile` and then `require.requireActual` (I think to make sure it's not mocked) from there.

See what we do in `jstransform`: https://github.com/facebook/jstransform/blob/master/package.json#L42 & https://github.com/facebook/jstransform/blob/master/jestEnvironment.js
  The described issues seems legit to me. Would you like to send a PR fixing them by providing the `--relative`? We can fix `node_modules` in a separate diff.
 thanks for the fix! I have a fix for this in #599 as well.
  Yeah this is a really silly bug and I'm going to fix this soon.
 @flarnie added a warning for this for Jest 16. Finally :)
  Yea, this is unfortunately unrelated and is on npm/node + contextify.
  What version of node?
 Ah, contextify is a binary module, which means it's compiled against a specific version of node for the running platform when it's installed. It's possible you compiled for one machine and then copied over the built files. If a binary is built for the wrong architecture this is what you end up seeing.
 We aren't using contextify any longer with iojs as it is part of node/io
  Seems fine. Might be worth adding a comment in the code that it will need to be updated if we upgrade to jasmine2. http://jasmine.github.io/2.0/upgrading.html
 Shall we go with this PR? Also, we have the process of upgrading to jasmine2 in https://github.com/facebook/jest/pull/330.
 OK, seems it was merged internally already, so we can add it here.
  This is working for me (node 0.10, fresh pull & npm installs)
 Cool, so probably another edge case issue with versions of node. Will just point to #243.
  Thank you for your pull request and welcome to our community. We require contributors to sign our Contributor License Agreement, and we don't seem to have you on file. In order for us to review and merge your code, please sign up at https://code.facebook.com/cla - and if you have received this in error or have any questions, please drop us a line at cla@fb.com. Thanks!
 Thank you for signing our Contributor License Agreement. We can now accept your code for this (and any) Facebook open source project. Thanks!
 @bench87, I see you closed the related issue. Is this PR is still relevant?
 This was fixed in #379, I think we can safely close this PR?
  Please ask questions on Stackoverflow. There are now many React testing solutions available.
  It seems like you're introducing an optimization that will potentially result in more confusion (eg with the lodash case you mentioned). You can already exclude files/directories with patterns so it seems like being super explicit is the better option here. Sure, you have to write more config to make it work but it's very clear what happens.
  Seems this one has a normally working and configurable solution. I guess we may keep default `__tests__` pattern, and close this issue?
 Feel free to send a pull request to update the documentation to include this :)
 Yes we definitely want to do this (for the next release maybe). @dmitriiabramov was looking into it I believe.
 We have finally implemented this for Jest 12.1.0. The option is called `testRegex` and the default is this: https://github.com/facebook/jest/blob/9d2b2bcf5e0705c64d5eba631c225426c09965ef/packages/jest-cli/src/config/defaults.js#L30
 It's here: http://facebook.github.io/jest/docs/api.html#moduledirectories-array-string but there isn't a guide for this yet.
 I'm sorry, I thought you asked about the `moduleDirectories` setting because I've been closing a lot of issues with that.
 Ok, I added `testRegex` to the documentation :)
  I'm gonna assume this issue is resolved in Jest 0.9 and will be happy to reopen this issue if it doesn't work appropriately.
  @facebook-github-bot import
 Thanks for importing. If you are an FB employee go to https://our.intern.facebook.com/intern/opensource/github/pull_request/748711525227162/int_phab to review.
 This will be in 0.6.0.
 I couldn't actually push this change directly because the CLA was never signed :( I took the proposed fix, and added the ^ to the regex as @DmitrySoshnikov proposed.
 I cannot do that @cpojer, because @akutz does not have an active CLA on file.
  This will be in 0.6.0.
  :thumbsup: thanks!
  Thanks!
  We now only support iojs > 2.
  This should be resolved with 0.9.0 which is being released soon.
  We only use it in 1 place in a script so it shouldn't even be a real dep, only a devDep. Want to fix that (and lock it to 0.0.2)?
  I recommend unmocking reflux by default by putting it into the `unmockedModulePathPatterns`.
  I'd like to fix this if it is still causing trouble for people. Can someone provide me a proper repro against jest 0.8 or 0.9?
 This will be fixed in `0.9.2` tomorrow. #785 and #787.
  thanks!
  this was fixed.
  I'm going to close this. I don't consider CS actively supported from us at FB and we'll rely on external contributions for future support of it in Jest. That being said, it shouldn't be a big deal for someone else to figure this out :)
  This is a known problem. #243
  :thumbsup: thanks!
  Fixed in #741 for 0.9.0.
  I think you're looking for `it.only()` and `describe.only()`?
 Hmm, it works for me on master...what version are you using?
Just to be completely clear about what I'm seeing work for me:

``` javascript
describe('suite', function() {
  it.only('a', function() { console.log('a'); });
  it('b', function() { console.log('b'); });
});
```

(I only see 'a' printed with the above test)
 Given that test files run in parallel, I don't think it'd be possible to know to skip other test files until it's too late. What you can do (and what I do often) is specify a unique part of the name of a test file as the first arg to the test runner. This will enure only tests matching that arg string get executed (and then internally, only the .only() test will run)
 @binarykitchen: I don't think fit or fdescribe solve the problem here...and I don't see a solution, do you? How do you deal with the fact that tests run in parallel and therefore you can't know until you've already run all the tests whether one of them is marked as "focused" or "only"?
 Given that jest runs tests in parallel this seems quite impossible as @jeffmo pointed out earlier. What I've found to work well is `it.only` and passing the name of the test to jest, so it only runs a single file:

`it.only(...)` and `jest MyTest.js`
 @danielstern you can now use `-i -t <pattern>` I guess. @arcseldon what has disappointed you about Jest? Can you elaborate on that? It's crucial to get such feedback, so we can work on this to make Jest better. @arcseldon this is a very vague comment on a random issue and isn't very helpful. If you have concerns or concrete issues and would like to see Jest improved, please help us by starting discussions in the appropriate places or send us pull requests to make Jest work for you.  I have to run to a meeting so I haven't looked deeply myself -- but just wanted to point at this code and make sure you'd verified that there's nothing going on in there that can't happen in strict mode:

https://github.com/facebook/jest/blob/master/src/lib/moduleMocker.js#L77

(strict mode has all sorts of things to forget about and I think we're doing some pretty meta stuff in that mockConstructor...and it's been a little while since I added it, but I'd be surprised if I set `/*jshint strict: false*/` without good reason...)
 @fabiomcosta is the comment about why it couldn't be used was wrong? We are still using the function constructor in this file.
  Woo!
  Closing this. I think @hankhsiao's suggestion is what we should go for ‚Äì add a setting to specify the reporters you'd like to have. Would you mind creating a PR for this against the current version of Jest? :)
  Yes, that is needed. Jest mocks all requires by default.
  We won't be adding this as a command line flag, but we will be adding a config option in the future. This is tracked in separate issues. #10 and #637 for example.
 @dmitriiabramov the problem currently is that it only allows you to specify a directory. I'd like to deprecate this option and add a `testPattern` option where you can also make it a regex, for example to match "test.spec.js". Some people prefer having tests next to their files rather than a `__tests__` folder. If you'd like to take this on, that would be great :)
  Thanks!
  I'd recommend unmocking it by default.
  In React that just uses `console.warn`. Disabling the logging across the board is probably a bad idea (and actually internally, we make warnings fail tests). Instead when we know a component will warn and that it's _ok_, we `spyOn(console, 'warn')` and then check that the warning was fired. With some exceptions (this particular one for example), it's we think generally a good idea to consider warnings as something you _must_ fix.

In your case it might make sense to do that as well, just when testing the components using `contentEditable`. In React itself we'll consider making that warning a little less noisy so it's easier to use when you know what you're doing.
 Yep, this is best handled inside of tests themselves. Another solution is to set the global **DEV** to false.
  Thanks again but same as what I said in #284 
  Thanks! However, can you make the changes to the raw markdown and against the master branch? https://github.com/facebook/jest/blob/master/docs/Tutorial.md

GitHub will force you to make to make a new PR so I'm just going to close this out ahead of time.
  Yea, you probably want lower case and not refer to the git repo.

Filesystems are fun aren't they üò¢
 Thanks!
  Unfortunately we won't be able to support this natively anytime soon. I recommend moving away from require.extensions and using a preprocessor to do any kind of extra processing.
 The next version of Jest supports a "transforms" configuration option that you can use to run custom preprocessors on your files and wrap around babel-jest. That should also solve your problem.
 @supasate you can make use of [`transformIgnorePatterns`](http://facebook.github.io/jest/docs/configuration.html#transformignorepatterns-array-string). And another example from RN tutorial: http://facebook.github.io/jest/docs/tutorial-react-native.html#transformignorepatterns-customization  jest has some problems with 0.12 so for the time being that node preferred version checking is actually a good thing. We're tracking that in #243.
  I don't think this should have anything to do with jest - `scryRenderedComponentsWithType` is a part of ReactTestUtils.
  Please use Object.freeze in your test.

``` js
Object.freeze(require('data.json'));
```
  This shouldn't be an issue any more with Jest 0.9.0.
  @clentfort would you mind rebasing this on top of master? :)
 @facebook-github-bot shipit
 Thanks for importing. If you are an FB employee go to https://our.intern.facebook.com/intern/opensource/github/pull_request/575519355918914/int_phab to review.
 I cannot do that @cpojer, because @clentfort does not have an active CLA on file.
  OK, looks reasonable, thanks.
  I haven't seen this issue with jest 0.5. If you have a repro for a current version of jest, please reopen this issue.
  Looks to be a 0.12 issue. Going to close out in favor of #243 
  I think this is outdated and without a repro I can't do much here.
  Yeah this is using static analysis to analyze the require statements, a constraint we cannot change actually. Please don't use variables to require modules.
  The fact that it no longer works in Node at all I s pretty disappointing and makes it a challenge to consider upgrading :(

This means we're leaving a large chunk of users in the dust either way we go. I'd hope that jsdom (or some alternative) can come up with a pragmatic way of supporting both platforms.
 I don't have a lot of....context...here, but it would be nice if it were possible for contextify to implement a compatibility layer that defers to `vm` for node versions that support it.
 See also #221, which I guess now has more to consider.
 0.5 updates to jsdom 5.x so closing out.
  Merging into #243 
  OK, looks good, thanks!
  Weird, Travis says 'failed' here in github...but when you go over to the travis build page it says passed...

Anyway, sweet thanks!
 Ohh...this seems to be that SIGSEV issue...
I think we should probably figure out what's going on there before we declare support for 0.12

(also we should get https://github.com/facebook/jest/pull/261 in)
 @fkling - I don't think that's true, we have a huge list of people telling us Jest isn't working in #243 
 Trying to cleanup some PRs, this one doesn't seem valid because of https://github.com/facebook/jest/issues/243. Shall we close this PR?
  Squashed and merged in https://github.com/facebook/jest/commit/dfa70e773ab7c67565b91027d4d69089a39d207b

Thanks again!
  Should be fixed via #540 (will go out with version 0.6). Please reopen if that's not the case. 
  Just published `0.3.0` which includes this update. Thanks a ton for sending this over!
  Yes! Check out the `testRunner` config option and the jasmine2 integration here: https://github.com/facebook/jest/blob/master/src/testRunners/jasmine/jasmine2.js
 @mnpenner it was removed yes. you can still use it with another assertion library if you replace the global expect in a setup file you should add something like 
```js
global.expect = require('my-custom-expect');
```
in here https://facebook.github.io/jest/docs/configuration.html#setupfiles-array  This should be resolved with 0.9.
  Hello @emmenko,

thank you so much for building this example. I'd prefer to keep this repository lightweight and not opinionated. Would you mind putting this example into a separate repo (like jest-react-flux-example)? We can then link to it from the README.

Thank you!
  I think this looks good. Anything else @sebmarkbage, @jeffmo? We'll still hold off until we ship 0.13 final.
 We shipped final! Can you update from rc2 and then we'll merge this.
 Thanks!
  Have you gained/tested performance improvements with this applied?
 OK, sounds good, thanks!
  OK, this seems reasonable, thanks.
  did this never work?
 Thanks!
  Thanks!
  Woohoo! Thanks a ton for this...
 Merged here https://github.com/facebook/jest/commit/96c898d81d76c66bcaf4701757b022f368cc7538
  It's known and has to do with JSDOM + contextify mostly. Please stop with the +1s.
 Mixed feelings. There's some more discussion in #267
 @atridgedcosta (and anybody else doing that) just FYI. `npm rebuild` will rebuild binary packages for the current version of node so you don't have to `rm -rf node_modules`.
 For the most part we use 0.10.
 I believe io.js has the same problem as node v0.12 so I don't expect jest works there either.
 Locking the issue is the nuclear option and shouldn't have to be required. It should be fairly obvious that this is a known issue and that +1 is noisy and adds zero to the conversation. I can understand that you're frustrated but +1 does nothing except annoy 49 people.

:lock:
 FYI: We're going to invest into io.js update, and 0.10 will likely be the final version for legacy node (since new jsdom version which we also updating doesn't support 0.12 and below). It's likely be an update for jest 0.5, and 0.4 will still work with 0.10.
 As of https://github.com/facebook/jest/pull/374, Jest should work on latest io.js. It's currently in a separate branch, https://github.com/facebook/jest/tree/0.5.x, and can also be installed via npm `facebook/jest#0.5.x`. Later on we'll consider moving to io.js, and making this branch as master (and when Node 2.0 will fully be merged with io.js, it automatically work with node). If you use io.js, we'll be glad to get the feedback on the experience with `0.5.x`.
 @chapinkapa, would you consider switching to `io.js` (and installing Jest form `0.5.x` branch), or do you have some blockers in other software that don't run on `io.js`? We had dependencies issus with 0.12, especially with jsdom which doesn't support 0.12 either.
 I'm going to close this out as we won't be able to support node 0.12 unfortunately. A decision that was made for us by jsdom. We'll likely be able to reconcile once node v4 comes out, which should support a reasonable upgrade path from node 0.12.

More explanation: https://github.com/facebook/jest/issues/469#issuecomment-135504161
 @mull @harryworld indeed, you need to define all variables. I think jsdom became stricter in how it handles the global scope.
 @binarykitchen How does gulp-jest work on node 0.12?

@nkbt your option is to use:
- jest 0.4 with node 0.10
- jest 0.5 with iojs 2+
- in the future it will be jest 0.6+ with node 4.0+ only.
 @chiedojohn jest 0.5.2 and up works with node 4
 Haven't tried npm3 yet. Seems like this should be its own issue, mind creating one, @felix-d ?
  yeah we should probably just say "0 tests found" or something like it.
 We added a message for 0.9.0.
  Hmm, I'm curious what this changes that solved your problem... Are you using `react` somewhere outside of `node_modules/react`?
 This shouldn't be necessary any longer.
  cc @sebmarkbage

Mind reviewing this really quickly?
 Review by committee! Let's add the semicolons. All of our code uses them.
  This will be fixed by #713 in 0.9.0 so I'm closing this issue out.
 No it is not. Mocking an array will give you an empty array. If that is not what you expect, you can explicitly define it or unmock it.
  Thanks for sending this! A thought:

I know others have wanted the ability to intervene with the module name -> module path lookup process as well; Would it be possible to generalize the module-alias-lookup code into a configurable plugin (rather than building webpack-specific support directly into the module loader)? We've done this in Jest in a few other places and its worked out pretty well. For example: https://github.com/facebook/jest/blob/master/src/TestRunner.js#L139

Specifically if we could move the existing logic in `HasteModuleLoader.p._moduleNameToPath` out to another module, then callsites for that function could be updated to do something like `var moduleNameToPath = require(config.moduleToPathResolver)` and it would be possible to build a webpack plugin (as well as any other arbitrary plugin as others have requested) that does alias resolution in general way.

Although we should probably keep the current lookup algorithm as the default, I'd be happy to take the webpack plugin you've essentially written here and include it so it ships with Jest such that webpack alias support is only a minor config-entry away.
 We now have documentation on how to integrate jest with webpack. For aliases, there is a `moduleNameMapper` config option. I don't think this particular PR is still relevant.

See #599 for the work tracking node-haste2. There'll be more features to better integrate jest with webpack in the near future.
  I'm going to close this out. I'm replacing node-haste in #599. I'm not sure if this issue will still be applicable then and what the plan is for symlinks on react-native but I'm open to adding support for this.
 This might not actually be needed any more. Have you tried using jest 0.8.2?
  Bummer. Please keep us updated. When a version of JSDom and Contextify are ready that support io.js and modern node, we'll make sure they work with jest.
  Is this still an issue in jest 0.5?
  @jeffmo do you know if this was for correctness or perf reasons?

The underscore prefix usually means "private to object" by convention which is I believe why this check exists. 
 I don't think we can enforce this, per ES6 "_" doesn't make it a real private name, it's just a convention, we can merge it.
 I'm trying to pull this change in at FB but unfortunately we have a few tests that depend on this behavior, ugh, I'm trying to clean them up.
 Finally done. I merged this for 0.9.0. You can try it today with `jest-cli@next`.
  @kentaromuria this might be a good ask to look into to get started with Jest! Absolutely agree we should make this better soon.
 I think this issue can be safely closed. The issue described here should be resolved with Jest 0.9. Previous versions were always a little bit confused about node_modules. If this problem persists for anyone I'm happy to take a closer look at this issue ‚Äì please provide me with a repository that has a failure case.

A few things to keep in mind: `jest.setMock` will likely not work when a module has already been required as a transitive dependency:

``` js
jest.unmock('Bar');
const Bar = require('Bar'); // assume this will require Foo
jest.setMock('Foo', {‚Ä¶})
const Foo = require('Foo'); // Foo was already required before `setMock` was called.
```

It therefore is required to call APIs like `setMock` before all other APIs.

Manual mocks for node modules can also be created by creating a `__mocks__` folder and putting a `node-module-name.js` file in it. To mock `react`, for example, you'd create a `__mocks__/react.js` file.

The next version of Jest will introduce a new API `jest.mock('Foo', () => {moduleExports})` that gets hoisted at the top of the block, when used together with `babel-jest`.

Please let me know if any of this doesn't make sense or if this is still an issue :)
  @dmnd, @spicyj, this looks reasonable. Do we have an existing JSON test to confirm the change is OK?
 Yes: https://github.com/facebook/jest/blob/v0.4.1/src/HasteModuleLoader/__tests__/HasteModuleLoader-requireModule-test.js#L106-L137
 OK, sounds good, thanks!
  this should work fine in jest 0.6.0.
  Yeah the solution here is to use jest.mock. We are unlikely to extend manual mocks to have sub folders for now but I might revisit this decision in the future.
  OK, thank you.
  Thanks!
  The mock that people are using here is working well, so closing this issue.
  jest now has a `--watch` command.
  This isn't ready BUT I wanted to get this started. I think we should go all the way to current jsdom and skip any intermediate versions. We're just going to get stuck again unless we fix the underlying dependency issues.
- [ ] Stop using our compat layer
  - [ ] Do we need `CSSPropertyParsers`?
  - [ ] Ensure `HTMLMediaElement` is supported upstream
  - [ ] Ensure `HTMLVideoElement` is supported upstream
  - [x] Ensure fix for `HTMLInputElement.checked` is supported upstream (https://github.com/tmpvar/jsdom/pull/1007)
  - [ ] Ensure fix for `HTMLSelectElement` and `multiple` selection is supported upstream
  - [ ] Add tests for the things we had in our compat layer?
- [ ] Ensure all of FB's internal tests pass and aren't depending on old jsdom behavior

cc @domenic who may be able to answer some of the above about support (I bet I could look at changelogs/code, but I know you're interested anyway :smile:). And @nhunzaker who was working on getting us to jsdom@1.5

If anybody wants to help out, let's do PRs against this branch.
 cc @DmitrySoshnikov 
 cc @ide to double-check that all dependency checkmarks mentioned here are considered in #374.
 0.5 uses iojs and jsdom 5.x so closing out
  Hi, yes this is on me. I don't have a great excuse other than that I've taken on quite a bit more work than I've been able to keep up with. You've prompted me to actively start reaching out to a few people and see if I can get some more hands on deck here to help keep Jest moving forward...so hopefully we can make that happen very soon.

In the meantime: I'm on a plane all day tomorrow -- so barring plane wifi issues, I will try to go through all of the pending PRs and hopefully we can get them sorted out as soon as possible.
  This should be resolved with Jest 0.9.2 or the next release after that :)
  Thanks for your patience @wwalser - this is great work.
  This stuff has changed quite a lot so I don't think this pull request is appropriate any longer. Feel free to re-open if you think this still makes sense and please rebase on master!
  This will be fixed in 0.9.0. You can try it with `jest-cli@next` already. Otherwise I recommend unmocking it using `unmockedModulePathPatterns`.
  Just to verify: Can you confirm which version of jest you're using?

Secondly: Could you post a gist of that file (`node_modules/request/node_modules/tough-cookie/lib/cookie.js`)? I took a look at the file in the `tough-cookie` repo, but I don't even see any references to `'buffer'` in there (wondering if it's a different version from master?)
https://github.com/goinstant/tough-cookie/blob/master/lib/cookie.js
 Please feel free to reopen if this is still a problem with jest 0.5
  Please do! I'll happily look at a pr
 setImmediate is defined with different semantics on different platforms (it's not a standard) -- so it wouldn't be possible to define one that works properly for everyone.

Specifically, it doesn't exist at all in Chrome or Firefox, but worse it exists in both node and IE with slightly different timing rules
 @wwalser: `process.nextTick` doesn't have competing, observably-different implementations like `setImmediate` does. Tests are either running on a platform that has process.nextTick, or not -- but if you are using it, there's no question as to what it does and how it works. It turns out the underlying differences between implementations of `setImmediate` do have important, observable differences that can make the same code behave differently on different platforms. (Which platform it was written for is unclear).

In terms of finding a workable solution: What if, rather than baking `setImmediate` support into the existing timers APIs, we just created a couple new APIs specifically for `setImmediate` that allow specification of the scheduling algorithm you intend (ie vs node)? It's not magically delicious by any means, but I think it would at least get a workable solution while also making it very explicit which platform you intended to support. Let's say `jest.runAllSetImmediates(schedulingAlgo)` and `jest.runOnlyPendingSetImmediates(schedulingAlgo)` (where `schedulingAlgo="ie"|"node"` (default="node").

Thoughts?
 Also just to reassure that I'm not trying to play the hypothetical-edge-case card: We have actually run into problems stemming from platform-specific differences like this at Facebook :/
 Would it suffice to just enqueue the callbacks in a separate queue such that `setImmediate`s and `nextTick`s are not interleaved? @wwalser I like the simplicity of your mock and would love to see any changes reduce rather than add API surface area. `jest.runAllImmediates` actually seems a bit dangerous to me as it could make it easy to accidentally skip over an enqueued `nextTick`.

As per the edge-cases, I think as long as the described execution order is upheld then you're in good shape. I can't seem to find any documentation that IE/W3C vs Node real implementations would cause the execution order to differ dramatically, so I agree with you on this @wwalser that the difference shouldn't mean much for mocking. If they did differ dramatically in execution order and behavior, then we're fucked anyway for using setImmediate in both environments and it's use in Jest is the least of our worries. Also: `nextTick` and `setTimeout` do not co-exist in any browser, so we only need to consider Node's behavior for the interaction between these two.

This doc http://nodejs.org/api/timers.html#timers_setimmediate_callback_arg seems to suggest that all nextTick will fire before scheduled setInterval.
 No worries! Thanks for keeping on this. This is a great addition.
 Just released this in v0.2.2
  Hmm, oops! That does seem wrong...
This code is pretty old, but I don't see a reason for skipping in this case

Want to send a PR? :)
  Does adding it to the `config.modulePathIgnorePatterns` config entry work?
  Let's close this and focus on #221, which I could probably use some help with if you're interested. I know you looked into it already so I think you have some insight.
  Because of the custom internals of React.createClass, this is pretty tricky to solve. We've been thinking about how to make testing React components much easier, and that was one of the many reasons behind embracing standard ES6 class syntax that we just released as 0.13.0-beta. If you write your classes in ES6 form, Jest will be able to mock them correctly.
 I think

```
LoginForm.prototype.handleSubmit = jest.genMockFunction();
```

should work. We don't have plans to change how createClass works here, but you should be able to mock plain-class functions like this without trouble.
 Yes, the recommended solution is to do `MyClass.prototype.myFn = jest.fn()`.
  Yea this has come up a few times before. It's a bit of a tricky subject which mostly boils down to the fact that modules and their closure state are shared between other modules. So, while it may be advantageous to deep-mock one module, that may mean you are unintentionally mocking a deep-recursive dependency module that a 3rd module might expect not to be mocked (or maybe you've even explicitly `.mock()`'d it).

The above situation, of course, assumes that mocking is a global concept -- as it is today in Jest. But we could also consider the idea that it's not, and that deep `mock()` and deep `dontMock()`s are states that only persist while executing that particular module, but not others. The problem here again comes back to the fact that modules persist state, and so it can quickly become confusing when some module state generated by `A` (which, let's say, was deep `mock()`ed) isn't being reflected deep down in `B`'s dependency graph somewhere which was, say, deep `dontMock()`ed.

Ultimately it's a trade-off: Do we deal with a pretty annoying number of explicit `dontMock()`s? Or do we deal with a pretty annoying, edge-casey situation where modules get implicitly mocked for (probably) unexpected reasons? We decided to go with the first of the two evils because it's at least explicit and the cost of writing all those `dontMock()`s is one you only pay "once" and up-front (rather than later, when you might not remember all the intricacies of the module under test -- which includes all of their recursive dependencies, etc).

I'd really love to find a good solution here, but between the two options we haven't thought of a good one yet.
 Jest 0.9 should work much better in all of these cases. node_modules are now by default deep-unmocked as well, as that was a frequent source of issues with npm3. We have also updated the documentation to be more clear and we are exploring more ways of improving (un)mocking. I think this task is resolved but I'm happy to reopen if there is anything left to do here for now.
 Hey! `unmockedModulePathPatterns` unmocks everything inside of a specific path. Right now, unmocking a node_module in any way should transitively unmock all of its dependencies. If that doesn't work, then that seems like a bug. Would you mind sharing your specific Jest configuration and what was mocked and what wasn't? :)
 They should be unmocked. Although I recommend specifying something like `node_modules/enzyme` to make clear it is a path. Are you using the latest version of Jest?
 That's weird, which version of Jest are you using? npm modules should definitely have transitive dependencies unmocked. If that's not the case, then that is a bug (the test for this is passing in Jest right now, though).
 Oh I see. Can you upgrade to Jest 12 and let me know if this problem still persists? We fixed something around this issue :)
  :+1: Thanks!
  You might be able to just directly set `window.scrollTop` and `window.scrollLeft`. If that doesn't work, try `Object.defineProperty(window, 'scrollTop', {value: 10, writable: true})`
  I'm going to close this because it is unlikely we'll add this to Jest any time soon. Of course, if anyone wants to build this, I'm very happy to reopen this and accept pull requests.

At Facebook we solve this kind of stuff during code review on a social level. We also do have a coverage reporter (in PHP that takes info from JS) that reports that the coverage of certain files is 0 % ‚Äì however that knowledge hasn't generally been useful and we don't rely on it too much.

@ondrejhanslik I would recommend giving Jest another try. We have essentially rewritten Jest to be much better and easier to use, although some of the areas you mentioned we are still working on at the moment :)
 I'll reopen it as i'm currently working on getting the coverage report for untested files.
before everyone used to have a `require`-all setup file that would just require every file in the codebase and add an empty coverage object to it, but that solution doesn't scale.

the solution i was thinking about is to have a separate step after the full test run + coverage that takes two arguments - **existing generated goverage** and **list of all source files**, and returns a modified coverage object with missing files added to it
 @massick exactly. although it makes sense that requiring files gives you 40% coverage, because you actually run that code when you require a file.
requiring all files at once is very slow though, and there's always going to be a module with a side effect that will ruin the whole test run :) so i'd really want to avoid doing it
 This is now part of the latest Jest pre-release and will be in Jest 15. @dmitriiabramov rewrote Jest's code coverage support. Please try with `jest@test` or `jest@14.2.2-alpha.22bd3c33` to see if this issue still persists. If it does, we'll reopen this issue.

The new option is `collectCoverageFrom` and it takes glob patterns. @dmitriiabramov can you make sure this is part of the API documentation before 15 comes out?
 @cpojer before i do that i wanted to do two things:
1. Make sure globs are fast enough
2. Add glob config options for other paths 
  I'm experiencing an issue with Jest and here is a simple test case that I have made.

You can also clone this simple test case from here: https://github.com/bjfletcher/jest-issue
## EDITED

(Old test case removed.  Please see the aforementioned repo for a better test case.)

Error:

``` bash
$ jest
Using Jest CLI v0.2.1
 FAIL  __tests__/Authenticator.js
TypeError: /Users/ben/projects/jest-issue/__tests__/Authenticator.js: /Users/ben/projects/jest-issue/lib/Authenticator.js: /Users/ben/projects/jest-issue/node_modules/body-parser/index.js: Cannot call method 'function' of undefined
1 test failed, 0 tests passed (1 total)
Run time: 0.312s
$
```
 Hi @awei01, appreciate your time/effort on this, really do.  This issue was happening in a bigger, more complicated AngularJS program, and definitely not because of the exports. I quickly cut it down to this test case and as you saw it was a bad job.  I'll go back to the AngularJS program and see if I can put together a better test case.  I'll close this and re-open if I get around to doing this.  Thanks. :)
 @awei01 You're very kind. :) I have just gone and made a better test case.  Please pull the latest from:

https://github.com/bjfletcher/jest-issue
 Hi @awei01, with that example I get the following which looks like a more elaborate error than the earlier one:

```
[snipped]
Using Jest CLI v0.2.1
 FAIL  __tests__/Authenticator.js (0.051s)
‚óè Authenticator module ‚Ä∫ it when .doSomethingOnApp() called with app, should call .use() on app with BodyParser.json(), call .isAuthenticated() on app and return its result
  - TypeError: /Users/ben/projects/jest-issue/node_modules/body-parser/index.js: Cannot call method 'function' of undefined
        at /Users/ben/projects/jest-issue/node_modules/body-parser/index.js:29:46
[snipped]
```

If you `npm install` you will install the `body-parser` which is a component used for ExpressJS apps.

The reason `Authenticator.js` is empty in my test case is because this `body-parser` I noticed was the problem. :/  If I cut out all the irrelevant code, it comes down to this module.

I'm hoping that there's something we can fix on the `Jest` side rather than on the `body-parser` side - although admittedly `body-parser` really shouldn't be using `function` as a method name.
 This seems like it was resolved.
  Yes we will do this from now on. Thank you for bringing it to our attention :)
  There is a `moduleNameMapper` option now that is made for this use-case. It should work well in the 0.9 release of Jest.
  w00t
  FYI preprocessor output is already cached:
https://github.com/facebook/jest/blob/master/src/lib/utils.js#L314
 Granted, that cache exists 1-instance per worker in the worker pool -- so, for each worker, a file is only read and pre-processed once (and the cache is even shared between tests). But if another worker picks up a test that needs that file, it will need to preprocess once itself as well.

Solving the cross-worker memoization would be interesting, but it never seemed like it'd result in a win that justifies it's complexity/effort. I'd be happy to entertain data that proves the wins significant.
 #commentraceconditions

:)
 It's very possible it's the tree traversal (I assume by that you mean the recursive execution of require()s?). I've seen sporadic reports before of the React module (namely TestUtils stuff, IIRC) taking quite a bit of time to execute in jest, but I was never able to narrow the cause down.
 [depending on how smart the transpiler is] That's not even correct semantics for es6 modules... 

(EDIT: to clarify what I meant -- without derailing -- ES6 modules have mutable bindings in the case of circular dependencies. So grabbing a ref to a named export in the toplevel scope isn't generally accurate)

In any case, the results of require("a.js") should be memoized by jest as well, so it shouldn't be too expensive after the first time it's called... Maybe I'm missing something?
 It could get tricky to move preprocessing into the main thread (and that seems like it'd be even slower -- given that many workers would be blocked on the main thread preprocessing all of their files for them...not to mention time spent serializing and deserializing the comms).

As I mentioned though, it's not completely obvious yet that sharing preprocessor results between test workers is the highest order bit here in terms of perf... It'd be really nice to understand the timeline of whats going on from start -> end of the jest run (including in all the parallel worker processes).

One way you might empirically show that this is worthwhile would be to try implementing this shared-memory caching in the preprocessor script itself. This would free you from the worry of all the hairy threadpool internals and refactoring up front that'd be necessary just to see if the effort is even worth it in your case.

For example, maybe you could have your preprocessor script implement a read-through cache on disk (for example) -- and then results get shared between workers that way.
 Ok, yea let's close this out then. I think we need to come up with a better (or perhaps more lazy) way of scanning the dependency tree.

Thanks for taking the time to look into this!
  That's a lot of stuff for just the test. How about only including the resulting .node file?
 also, CI is choking on the .node file
 The test looks fine to me
 ![youreawesomehd](https://cloud.githubusercontent.com/assets/498293/5285165/04bbd850-7ae8-11e4-85af-659476c85427.gif)
  Please do!
 Sorry about that @SegFaultx64 - it should be fixed now.
 I think that @fdecampredon commit looks good -- please send a PR!
 Sweet!
  The performance problems were fixed with #599.

To answer your question (and sorry I never saw this issue before :) ), jest gives you test isolation. It resets the module registry on every call to `it` to make sure you get a fresh environment. You can require React either on the top level (once) or inside of your beforeEach calls (for every test).
  I think the problem here is that React is being mocked. I recommend going through the example tutorial again (we just recently updated it) and it should work properly now!
  I'll take a look at this
  Seems resolved.
  Support with Node v0.12 (what 0.11 became as a supported branch) and iojs is a known issue. Going to merge this into #243.
 Node 2.1 is actually iojs. The published jest probably doesn't work there. The 0.5 branch will but isn't published to npm yet (you can use it explicitly with `"jest-cli": "facebook/jest#0.5.x"`).
 Node 0.12 is not supported, sorry. We're no longer providing support for 0.10 either. We're mostly committed to supporting LTS releases >= 4 since that is our primary use case. Newer versions of Jest have an updated jsdom and other upgrades which hopefully work past any issues you might have. It's likely that you're hitting an issue where the old version of jsdom we had just wasn't compatible with jquery.

Jest is annoying to do simple things with and as we continue forward, we're working on making that easier.
 I would go to node 4.x (LTS) and jest-cli@latest (8.x I think)
  I am not necessarily opposed to this, but I would like to understand a few things first:

Can you talk me through what issues you had with existing coverage collector? I realize coverage information isn't currently exposed outward very well...but it seems like that should just be a matter of a few tweaks to expose it better.

When I originally went through coverage collectors (including Istanbul), I found `cover` to be the fastest (they're all pretty slow) and the most flexible in terms of providing raw information with a simple-as-possible API. It doesn't present `lcov`-formatted coverage info, but that's more a responsibility of the output printer/whatever system takes in the raw coverage information and wants to format it.

Anyway, like I said: If there's a good reason to do this I'm onboard with driving it through...but I'd like to understand the shortcomings of the existing system first.
 Got it, I didn't realize cover wasn't catching everything. Ok, I will take a closer look at this on Monday.

Thanks for diving in, here!
 Hey all, sorry for the delays -- I was away for a few weeks for the holidays there for a bit.

I am still interested in pursuing this, I'm just pretty swamped with catching up from those two weeks now. Please bear with me -- I'm hopeful that I can come back to this mid-to-late next week.

Again, my apologies about how long this is taking me :(
 @hankhsiao : Any chance you could hop on IRC (#jestjs in freenode) so we could chat for a bit at some point? I have a couple of questions that might be easier to run through in a little more synchronous chat environment than here...

Specifically: I'm curious about how we could shim an interface in between coverage collection and coverage reporting so that the two aren't necessarily so coupled. Right now it seems that Istanbul does this sort of with it's own internal interfaces...but it could be tricky to maintain those interfaces for other coverage reporting formats (For example: we have our own compressed coverage format that we need to be able to output).

At first glance it doesn't appear that Istanbul does a great job of exposing raw coverage data without digging into internal APIs...but now that you've dived into it more, I'm curious as to your thoughts here.

I'll idle on freenode for the day and Monday. I'm hopeful we can get something working here...I just want to make sure we're considering all the use cases.
 I think we're good to go here. Thanks 1000x to @hankhsiao for putting up with my questions and requests :) This is most excellent
 Just published `0.3.0` which includes this merge. Thanks again!
 @hankhsiao 

> I also made a change of not mocking node core modules, because it is too easy to get errors when mocking these modules

Hey guys, wondering, was it a real issue to turn off mocking of core modules? We've just updated to the new version of jest, and several our tests started to fail because of this.

If there was a good reason not to mock the core modules, I can fix the tests (by explicit mocking, e.g. `jest.mock('fs')`), otherwise, if there is no real practical issues, I'll probably consider adding an option for this, `--forceCoreMock`.
  This shouldn't be an issue any more.
  `testPathDirs` is meant to limit the places Jest looks both for all modules and all tests. It is improperly named and I'm planning on changing this configuration option soon. This issue isn't really actionable. I'll provide a new matcher against tests and simplify the testPathDirs configuration option.
  cc @kentaromiura this might be good to do too? :)
 This will be fixed in the next Jest release.
  Just shows stack trace (made of jsdom and contextify) which is not very helpful.
 Assigning to @DmitrySoshnikov. I also have a feeling it should be simple.
 This should be fixed with 0.6.0.
  https://www.youtube.com/watch?v=EncVtoGLi5Q
 nice! will this support building the internal cli with?
  #herostatus
  :dancer:  
  Hmm, I think I'm confused? The tests were passing in master before this diff -- and with this diff, Travis is showing them as failing...
  Currently, if you're running a large number of tests and one of those
tests is very slow, sometimes it's possible that Jest looks like it has
hung (when really it's just waiting for that slow test to finish).

This adds a feature to the test runner that prints/logs out pending test
info if no test results have come back for a while (5 seconds, for now).
Hopefully this should help give better feedback to users as to what's
going on when this happens.
 It's definitely not ideal that we're doing any printing inside `TestRunner.js` (that's supposed to just be a simple library utility -- all printing is supposed to happen at the CLI level).

However, given that TestRunner.js encapsulates the info needed do this level of notifications, there'd need to be some pretty significant refactoring to expose this kind of detail up to the CLI (I have grand visions in my head of a better API for TestRunner.js that I'd love to implement one of these days); But rather than doing such a large refactoring right now, this solves the problem of keeping TestRunner.js library-only by allowing you to pass an `infoLogger` callback (whose default is just `console.log`) in, which will be used to print out these log messages.
 This will be subsumed by @leebyron 's work on cleaning things up.

Half of the work here is covered already by #169 (which prints remaining test count after each test output as test results stream in). The other half of work (printing more detailed info if output stalls for any significant period of time) will be much easier to implement in a nicer way after that PR.
  Want to bump the package.json version of the jasmine-pit dependency here too, so we don't regress?
 woo!
  FWIW: In general I don't care much about this level of stylistic detail. I appreciate the close eye, though :)
  (1) Mocking Utilities - At some point I think it'd be good to explore Sinon for mocking utilities. I haven't looked in to this yet, though, so I don't know if there are any blockers here.

(2) The Module System/require() - There are quite a few requests to support module systems other than just the node-commonjs variant that we support right now. As part of solving that, I'd like for us to make the module system pluggable -- and eventually have these module system plugins exist as their own npm packages (where the current system is just a pacakge.json dependency in order to exist as a "sane default")

(3) Mock timers - My initial thoughts: It seems likely to be more work than it's worth to maintain a separate package for FakeTimers + express all of the (fairly jest-oriented) guarantees and features; Therefore I don't know if this would be a good idea or high value. If you feel strongly about this, I'd be willing to talk more about specifics if you could outline exactly what aspects want to use in isolation?

(4) The runner - This piece is really the center of the wheel spokes, so I don't think it makes sense to generalize here.

(5) Coverage stuff - Currently Jest just uses the `cover` package for collecting coverage info. The biggest issue at the moment is just finding a good way to surface that info (it needs to be available through the library APIs as well as the default CLI utility)

(6) Sugary stuff - Not sure what you mean by this, can you clarify? Do you mean things like syntax transforms for ES6/coffee-script/etc? If so, jest has no opinion on this -- but it does support pre-processor plugin scripts through the `config.scriptPreprocessor` config option
 This is, at last, happening. We are filling up the new `/packages/` folder: https://github.com/facebook/jest/tree/master/packages

Next up is the mocking feature, which will be launched as `jest-mock`, cc @abramovdmitrii 
Alex Juarez has started refactoring Jest itself, which will make further work here easier as well.
 We have now split off `jest-mock` and the test assertion library plugins `jest-jasmine1` and `jest-jasmine2`. We will continue making Jest more modular, which helps us rethink the boundaries of Jest and will eventually allow us to build cleaner APIs. While we haven't made everything modular, I think the original intent of this issue has been achieved and further work will be done in smaller internal/external tasks that are tracked individually. I'll close this issue but feel free to open new ones about things you'd like to be more abstract.
  Awesome, thanks for fixing this!
  jshint is pointing out that this diff kills our dependence on `node-find-files`:
https://travis-ci.org/facebook/jest/builds/38944080

Could you pull that out of the `package.json` dependency list and remove the `require()` from this file as well?
  How does this work for CommonJS, where file reads/pre-processes have to be synchronous to work correctly?
 The high-level goal here is indeed a tricky one -- but one fundamental constraint we have is that node's implementation of CommonJS forces things like reading from the fs (and pre-processing) to be done synchronously. At some point I'd like for us to support other kinds of module systems than just CommonJS such that we can do asynchronous `require()`s as you're aiming for here.

Additionally one could imagine a more ES6-style async loading pipeline where jest simply blocks the top-level execution of the test script until after all of the recursive dependencies have been (asynchronously) loaded. The only requirement there is that we have a fully statically analyzeable way of expressing dependencies in the module system -- of which node's implementation of `require()` is not [necessarily]. However, if the module system were pluggable, it would be possible to build a module system plugin that simply punts on this generality and requires that you always pass in string literals to `require()` rather than variables.

In any case, I really appreciate the thought behind this!
  If you can fix the minor indentation thing, I think this looks good
 Woo! Thanks a ton :)
  This shouldn't be an issue with jest 0.9 any more. Let me know if this still comes up and I'll re-open and take a look.
  Thanks!
  Closing out because it's not clear this is necessary. Let me know if I've missed something and we can re-open
  This would be cool to have documentation about. Is anyone interested in making a pull request? :)
 I haven't tried bugger. What makes it so much faster? I also had trouble with inspector and node-debug, they seemed quite slow.
 I think there isn't anything actionable left to do here. If anyone wants to provide some documentation for the jest website, that would be fantastic. I'm gonna close this issue for now.
  This shouldn't be an issue any more. Please feel free to reopen with a concrete example against jest 0.8 or 0.9.
  jest 0.5 will use jsdom 5.x so we can close this out.
  Please post questions on StackOverflow only.
  Thanks!
  I thought `console.warn` worked too, I'm pretty sure we've used that.

But cc @amasad who hooked these up.
 Yea, #162 added everything so this should work.
  This is probably not going to be worked on by Facebook unless we are going to receive a community contribution. Might be fixed in `0.9.0` actually.
  This'll be done soon as part of #161.
  derp...

thanks for this :)
  Nothing done here yet, as the auto-mocking requires the node runtime environment.
 Oh I haven't commented here. The new architecture of jest proposed in #599 will make it easier to build a server environment around Jest. This is unfortunately not a priority for Facebook however, so I'm not going to actively push for this. If anyone wants to work on it, I'd be happy to help.
 Seems like that is the same concept?
 Merging this task into #848.
 @vvo Hey! I'm happy to share some thoughts. Five years ago we actually used to have a browser unit test suite (that I used to work on, hah!) but it wasn't good, slow to use and not how people built code at FB.

We then built a command line testing utility with a mock-dom and people loved the iteration speed and how well it worked. The browser test suite was killed and we never looked back. To cover browser testing we do a lot of things ranging from web driver tests, manual QA and especially employee dogfooding. These things have in general provided more value than a flaky browser test engine that is hard to scale for thousands of tests.

However, I do recognize that people enjoy writing tests using a browser environment. Node's debugging story is getting a lot better and JS frameworks provide the necessary abstractions to take care of this. There is an ongoing conversation about the potential of Jest running in the browser some day: #848.  Thanks for this!
  Thanks!
  Merging in #243 
  webpack alias seems like a good solution for this use case.
 @mwolson if you would like to add some documentation or even an example to jest for this, that would be awesome if you have time to send a PR :)
  Is it possible to add tests? Or a manual test case please :)
 how about a test case. Just let me know what's the best way to test it manually
 Unit tests would be great!
 #246 went in and shipped so closing this out.
  Yeah, https://github.com/atecarlos/webpack-babel-jest seems like a reasonable solution. Jest 0.6.0 will also allow to specify `moduleNameMapper` that maps a module regex to a stub module. That way you can match all `.css` files that you require to a `CSSStub` for example.
  If a module cannot be mocked for some reason it is best to unmock it explicitly.
  I hear your pain, but I'm super oversubscribed at the moment and likely won't have time to investigate for a little while :(

If anyone wants to try diving in to this and send a pull request, I'll do everything I can to help get it pulled in.
  Running with `--bail` should stop running and show the first error. When doing TDD it's nice to have to not weight for the rest of the tests.
 that doesn't work exactly as expected currently it thinks `path/to/file_test.js` is a pattern and matches all files against it. Secondly, what I'm suggested is within the same test to bail at the first error. Currently what I end up doing is a bunch of `iit` to focus on the failing test and not flood my screen with all the other failing tests
 This is done. Thanks to @PhilVargas!
  This was implemented in #370 as `--verbose`.
  fuckyeadancingbear
 (website re-published)
  To workaround this I used `mockImpl` but it seems like it should work.
 I think this isn't currently possible with JS without some hackery. Jest now has new APIs, like `jest.fn(() => returnValue)` which will always work and should be sufficient.
  This is awesome, thanks!
  @adaschevici are you still interested in providing a proper fix for this issue?
  I also would want this. Jasmine currently check the message value. I would also like to pass it a regexp instead of the exact message. Can you please open this issue for Jasmine? https://github.com/pivotal/jasmine/
  Unfortunately I don't think there is anything we can do about this. I'm going to close it out but feel free to reopen if you can think of a good fix for this! I agree it would be great if we could have a solution here.
  I'd recommend doing that, yes, and then setting up the matchers in your setup env file.
  Thanks!
  > Either way, I really really need my tests to be fast for my workflow. I still need to figure out how to at least run a single suite. In jasmine I could use "ddescribe" or "iit" instead of "describe" and "it" to run a single test or suite. Jest is SO nice, I just need a fast workflow now.

You can definitely write `it.only` and I believe you can do `describe.only` as well.
 Hi! I'm working on `--watch` for jest and generally trying to make this go faster. Will report back soon.
 Haste supports a flavor of CommonJS module format were the module names are top-level rather than relative. That means we need to know the modules (and dependancies) ahead of time before running the program otherwise it would be incredibly inefficient to traverse the filesystem to look for a module on each `require`. However we realize that most people are using relative module format (a la node.js) and we want to remove the implicit dependency on Haste (unless an option is provided) and this should make it faster.
 @songawee It doesn't but want to send a PR to have it as an option? I don't think we should have it on by default because it's sometimes impossible to know when to break the cache. For example, if you change your compiler options, the cache should reset. Another option is to have a reset-cache option in addition to caching.

@doodzik are you sure it's the worker-pool and not the `node-haste` stating and reading of modules?
 We'll be focusing on this soon. We are a little swamped with work on jest right now but we are committed to make it more awesome.
 The biggest help right now would actually be improving the documentation, website and going through issues and helping out people in open source.
 We are currently working on replacing node-haste with a new module resolver, which should fix this issue.
 This work is happening in #599.
 Good news everyone, I'm merging #599 today and it should do away with the slow startup, finally.
 Ok, this should finally be fixed in Jest 0.9. Sorry that this took so long but there was some clowniness in Jest :)

See https://github.com/facebook/react/pull/6052 on how the React tests themselves were sped up. If you'd like to try this improvement, check out the comments in #599. It is currently tagged as `jest-cli@next` until to see if there are any bugs that people in open source might encounter. I'll close this issue as resolved.
 oh yeah, I always make this mistake :) I edited my original comment.
 @steinbachr that should probably go into a separate issue. Would be great if you could provide a repro, haven't seen this issue come up at FB!
  Nice catch, thanks!
  These days most people use `babel-jest` which retains line information. I'm probably not going to add support for anything else because at FB we are only using babel and it works well for us. If you still need this for CoffeeScript feel free to reopen this issue and send a pull request.
  Going to close this out since, as pointed out, it should already work.
It's true that the default is to accept a regexp pattern -- but I believe that also covers the case where you pass a specific path (it would just be a very specific "pattern").

Feel free to comment further if you think this is still strictly necessary.
  I _think_ it should be possible by adding these paths to the `NODE_PATH` environment variable before calling Jest. Agree that's not ideal, but it should work sufficiently well for now.
 After all this time we have finally implemented this. I'm sorry for the long wait. `modulePaths` and `moduleDirectories` is now part of Jest 12.1.0. We'll be adding some more documentation for the website but it should match the implementation in webpack. See http://facebook.github.io/jest/docs/api.html#moduledirectories-array-string
  I think we're just waiting on the update to the PR per the inline comment.
@malonecj: Did you want to finish this out?
 In the code change I commented on, we want the jest CLI to stop then-and-there if `--help` was passed
(i.e. not print the help and go on to continue executing whatever command it might have if `--help` weren't specified)
 Also I'm not quite sure what you meant by tests executing synchronously -- but test files themselves run asynchronously, so a failing test would not stop the Jest cli in it's tracks
 I am happy to take this, but it's in a place where it needs some refactoring (and bin/jest.js has changed since this was written). I would go in and just finish this up myself (seems fairly straightforward), but I don't have a working Windows machine to try to port this to the latest code...so I wouldn't feel comfortable doing so without being able to verify and test.

Could either @malonecj or someone else who's running on windows finish this out and confirm that it fixes things? I'm happy to take it if we can get the stop-execution problem worked out (the thing I commented inline)
 Awesome, thanks a ton @jquense !
  Updated merge in https://github.com/facebook/jest/pull/224
  You can add this using `jest.addMatchers` and custom Jasmine matchers yourself, see jasmine.github.io/2.0/custom_matcher.html :)

Feel free to publish it as a jest extension and I'll mention it on the website.
  I think this isn't an issue with jasmine2. Feel free to reopen if this still happens after switching to jasmine2 through the `testRunner` option.
  Core modules are now being unmocked by default, so this shouldn't be an issue any longer.
 Yes, use version 0.9 or probably any version we released last year. Core modules aren't mocked by default.
  I suspect that you need to `jest.dontMock()` something...perhaps one of the node built-in modules?
What happens if you disable automocking right before `require('jasmine-reporters')`?

Also, in terms of debugging: The best way to do this is to run jest with `--runInBand` in order to force jest to run entirely inside a single process (rather than having jest boot a bunch of worker processes and having to guess which child process is running the test). Then you can use something like `node-inspector` to inspect the running process.
 Please feel free to reopen this if there is anything in jest that needs to be changed to support this.
 we've been working on our reporting system and now we can actually generate junit\xunit using a separate jest-reporter plugin. I think we're going to have a plugin for junit in a couple of weeks
 @noahpeters our internal reporters are here https://github.com/facebook/jest/tree/master/packages/jest-cli/src/reporters
but the thing is.. right now we don't have a mechanism to configure which reporters are used by jest without dealing with jest internals. As soon as we get that done, we'll be able to use any custom reporting system with jest
 There hasn't been any progress on this. Please feel free to send a PR to add this feature.
  Just published 0.1.18 with this
  Thanks for the issue! Re-opening because the original topic still applies: Jest should probably respect the `NODE_PATH` env variable in it's resolution algorithm since that's what Node does.

I'm personally strapped on resources at the moment myself, but I'd love to see support for this happen. Hopefully when I can get some time I can dive in to this -- otherwise would be happy to consider a pull request.
 Hey everyone, very sorry. I've been missing out on all the latest updates to this thread but this basically just slipped my radar.

I will go commandeer that initial pull request and bring it up to date tomorrow when I get back to the office.

Sorry for dropping the ball here everyone, my bad.
 Thanks @carrbs. Just merged #246 and published `jest-cli@0.4.0` with it
 Jest definitely respects the NODE_PATH and has for a year at least. You are probably running into some other issue.
  @SevaUA: What happens if you run istanbul with single-process jest? (i.e. with the `--runInBand` command line option)

I'm not completely sure how istanbul gathers coverage, but jest boots several processes by default and runs tests in a worker pool, so those child processes may be getting past it?
 @sbrekken: Good to know, WRT async tests -- we should look into that. I've been pretty pre-occupied with vacation/travel the last month or so...but I'm ramping back up now so hopefully I can devote some more time to this stuff again in the next couple of weeks.
 @ezequiel : I don't know of anyone working on this at the moment and unfortunately I'm spread pretty thin on my team these days :/ That said, I'd be happy to try to find some time to look at pull requests if you want to take a crack at this?
 @ronjouch : I think so, yes. I'd be happy to take a pull request that includes some kind of printed coverage info in the CLI output if `--collectCoverage` is specified!
  Interesting, I wonder if there's a normalization problem when rootDir isn't left at the default...

I'm coming back from a pretty long vacation and I have quite a few issues to slog through, so it may be a bit of time before I can dive into this myself. However, if you want to dive in I'd be happy take answer questions or take any PRs in the meantime :)

Pro-tip: If you run `jest --runInBand`, jest will execute all within a single process...making it much easier to debug (i.e. using something like `node-inspector`)
 `unmockedModulePathPatterns` will only work with absolute paths or partial path patterns, but no relative paths. This is by design and will most likely not be changed.
  Could you just do this in your preprocessor function? This is what I've recommended to everyone else when they ask how to skip processing of certain files.

I also prefer that to a config option because it gives you full control over deciding _how_ to short-circuit preprocessing without polluting the config API and/or asserting that regex is the only way. It also keeps the solution to the problem in the "one way to do it" zone.
 Well, I guess this seems to be a question that pops up a lot (and it actually doesn't hurt that much), so I won't fight it.
 Any updates here? I'm happy to take this, but I think we just need to switch it to a regexp match instead of an indexOf
 Merged in #303 
  Thanks for the description! There is nothing actionable here so I'm closing the issue. If there is anything you'd like to be changed in jest, please feel free to reopen.
 In case you want to extend the documentation please feel free to send a pull request!
  It may be failing if you're not also including the Traceur runtime.

Your transform should also concat the traceur runtime to the top of the file.

I have no idea where the error about defining `require` is coming from. That seems like a bad idea on Traceur's part if they're doing that.
  Whoa I hadn't even seen this -- I will take a look when I get back in on Thurs
 It looks like we left this in a place where some of the code needed to be moved around. I know @leebyron did a pretty big refactoring of the CLI code a month or so ago... @amasad: Think we could rebase this and get it in with the updated CLI?

Seems like lots of people are really interested in this
 Cool, I think I'll send a new PR shortly
 @amasad are you still working on this?
  Just going to merge in to #243 (since node v0.11 was unstable)
  This appears to happen if you call console.error with a DOM node argument.
 @spicyj if this is still happening please reopen the issue.
  I'm sorry it took so long to get back on this -- I've been moving and vacationing (and now, hitting the ground running/catching up on all the things I missed in that time).

In any case, this looks great. Also, here's come context around how things are structured that are relevant to this change:

One of the reasons the bin/jest.js file is mostly separate from TestRunner.js is because I wanted Jest to be built as a library...right up until the very top level where you need to actually interface with it somehow (via a CLI, in 99% of the cases). In the interest of completeness I included the bin/jest.js CLI as the default interface. However, it should still be possible (and normal) for various platforms to be able to define their own interfaces and CLIs using those libraries. For example, you could imagine a CLI that reports results through a page served up over a web server rather than through a command interface...or even one that reports results out to a back-end test result aggregation system (which is similar to what we have at FB).

So with that context in mind, the goal for src/defaultTestResultHandler.js was to be be a result handler used for that default CLI (bin/jest.js). If someone needed to write their own CLI, they might use it....but they might also not use it at all (as is the case for Facebook, where we have fb-specific flags and output formats that we need to support -- as well as those test result logging/aggregation systems I mentioned a little earlier).

Anyway, I think it's fine if we want to generalize `defaultTestResultHandler` a bit, but I think it'll be hard to support every possible way various platforms want to surface results...so I don't want us to go too far and try to support all the things we could imagine here. As such, it's good that defaultTestResultHandler (or your new version of it) only supports the things that are directly needed/supported by bin/jest.js now.

Specifically, it doesn't appear that it's necessary (given what you've built here) to have a class instead of just a module that exports a simple function or two. Instead, how about just a module that exports a `printConciseTestResult()` and a `printDetailedTestResult()` function? That way the switching logic that decides which one of those two output formats stays closer to the CLI code, and doesn't wind up bleeding down into other parts of the library.
 I didn't actually look at logic but I think @jeffmo did so I was just the linter. We need a rebase but otherwise I'm inclined to just take this pretty much as is with style fixes.
 Finally this was implemented (in #370). I guess we can close this PR safely now?
 Closing this one, feel free to open a new issue/PR if this needs something in addition.
  (Hopefully) fixes #87.
  Certainly! Unfortunately it is hard to auto-mock something at runtime that uses meta-programming for its implementation without ES2015 Proxies which aren't properly implemented in any engine yet. For these cases there are always two solutions:
- Create a manual mock instead
- Do not mock that module at all

In a lot of cases you don't actually want mocking. You probably always want an unmocked version of bluebird; there is no point in mocking a Promise library.
 The proper solution to this problem is to put "bluebird" into the "unmockedModulePathPatterns" config.
 See my last comment in #471. The documentation is also improved in #763.
  If you do something like this:

```
var checkbox = TestUtils.renderIntoDocument(
  <CheckboxWithLabel labelOn="On" labelOff="Off" />; 
); 
```

your code will work correctly. The object returned by `<CheckboxWithLabel />` only describes what component you want to render; you could reuse it and call renderIntoDocument multiple times, but a new component instance is returned each time. To get a handle on that instance, just store the result of renderIntoDocument.
 Fixed the example in db003d5dc76b966199f8072343de1f18231d82e3 -- thanks for reporting.
  If you run `npm install` inside the examples/react directory, then `react` and `react-tools` will be installed there, causing them to be properly unmocked from the path specified in examples/react/package.json; you'll get this output:

```
jest/examples/react$ npm test

> node ../../bin/jest.js

Using Jest CLI v0.1.17
Found 1 matching test...
 PASS  __tests__/CheckboxWithLabel-test.js (1.9s)
1 test passed (1 total)
Run time: 3.029s
```
  That seems like a bug that should be fixed in Jest.
  This is a question and should be posted on StackOverflow instead.
  This is great, thanks!
  I'm not able to repro this exact error message, but I do get a slightly different one:

```
TypeError:   d3_issue/__tests__/d3include-test.js:   d3_issue/d3include:   d3_issue/node_modules/d3/index.js:   d3_issue/node_module
s/d3/node_modules/jsdom/lib/jsdom.js:   d3_issue/node_modules/d3/node_modules/jsdom/lib/jsdom/level3/index.js:   d3_issue/node_modules/d3/node_modules/jsdom/lib/jsdom/l
evel3/core.js:   d3_issue/node_modules/d3/node_modules/jsdom/lib/jsdom/level2/core.js: Cannot read property 'length' of undefined
    at Object.firstChild (  d3_issue/node_modules/d3/node_modules/jsdom/lib/jsdom/level1/core.js:435:28)
    at _getMetadata (jest-cli/src/lib/moduleMocker.js:279:49)
    at _getMetadata (jest-cli/src/lib/moduleMocker.js:286:23)
    at _getMetadata (jest-cli/src/lib/moduleMocker.js:279:27)
    at _getMetadata (jest-cli/src/lib/moduleMocker.js:279:27)
    at _getMetadata (jest-cli/src/lib/moduleMocker.js:279:27)
    at _getMetadata (jest-cli/src/lib/moduleMocker.js:279:27)
    at Object.module.exports.getMetadata (jest-cli/src/lib/moduleMocker.js:388:20)
    at Loader._generateMock (jest-cli/src/HasteModuleLoader/HasteModuleLoader.js:280:56)
    at Loader.requireMock (jest-cli/src/HasteModuleLoader/HasteModuleLoader.js:790:43)
    at Loader.requireModuleOrMock (jest-cli/src/HasteModuleLoader/HasteModuleLoader.js:905:17)
    at   d3_issue/node_modules/d3/node_modules/jsdom/lib/jsdom/level2/core.js:1:99
[...]
```

In my case, the stack trace suggests that jest is attempting to generate an automock for `node_modules/d3/node_modules/jsdom/lib/jsdom/level1/core.js` (when it's require()'d on line 1 in `level2/core.js`) -- which is definitely the wrong behavior considering that that file's path is inside `<rootDir>/node_modules/` -- which is the default entry for `config.unmockedModulePathPatterns`.

(Note that you can tell that jest has decided to mock because the stack goes from `Loader.requireModuleOrMock` to `Loader.requireMock` instead of to `Loader.requireModule`)

I should mention that I've been super swamped with other work lately and haven't had a ton of time to devote to jest issues -- so apologies in advance for any delays here. It might be a bit before I can dig into this too much, but if you'd want to try and debug a bit before I can get a chance, you might start with the logic in the `Loader.requireModuleOrMock` method (inside `src/HasteModuleLoader/HasteModuleLoader.js`) and see if you can figure out why jest thinks it should mock that module.
 More specifically, for your particular repro, it seems the `fs` object being returned by `require('fs')` inside jsdom.js doesn't have a `readFileSync` property -- which is obviously not supposed to happen. You might start by digging in to see what is being returned by require('fs') in that file?
  Sounds like a great idea!
 @fkling are you ever going to build this?
  I can't reproduce this. I made a file `__tests__/foo-test.js` with the following contents:

```
describe('footest', function() {
  it('checks the foo', function() {
    var x = {};
    console.log(x.y === undefined);
  });
});
```

and running `jest` gives the output:

```
Using Jest CLI v0.1.15
Found 1 matching tests...
 PASS  __tests__/foo-test.js (0.012s)
true
1 tests passed (1 total)
Run time: 0.71s
```

Let me know if I'm missing something.
 Odd that Firebase breaks it, but this seems like a bug in jest. If I write

```
undefined = 2;
console.log(typeof undefined);
```

then I get `undefined` when executing the code directly but `number` within jest.
 Yeah unfortunately I don't think we'll be fixing this in jest. Feel free to reopen if you feel strongly.
  Yeah; this is a React bug: facebook/react#1297.
  Running `require('tty')` from any test appears to give the same problem.
 This shouldn't be a problem any longer. `jest.mock()` or `jest.unmock()` should work properly with jest 0.9.0.
  Seems like there is a workaround and this is specific to React tests? Also might have been fixed in jsdom.
  Just wanted to follow up here to say that I don't have any immediate plans to build out Jasmine2 support, but only for lack of cycles myself. However, if someone wanted to take a crack at building a `jasmine2TestRunner`, I'd happily take a PR for such a thing.

You can take a look at the existing `jasmineTestRunner`:
https://github.com/facebook/jest/blob/master/src/jasmineTestRunner/jasmineTestRunner.js

It should be possible to build a `jasmine2TestRunner` that matches the same API as that runner function. Then it'll be easy to toggle between the two test runners (and even other test runners!) via this config option: 

https://github.com/facebook/jest/blob/master/src/lib/utils.js#L29
 Yes yes, we are working on this. There is a lot of work that we need to do to make jest awesome and I'm still working through the backlog of things we need to do at Facebook. Please have a little bit more patience and I will make sure jest is great soon!

(I assigned this issue to me, hoping that will shut up our bot. cc @vjeux)
 jest 0.8.0 was published just now with optional jasmine2 support! Thanks everyone and I'm deeply sorry for the long wait.
 See http://facebook.github.io/jest/docs/api.html#config-testrunner-string 
 You need `--testRunner`.
  I'm going to assume this issue has resolved itself in the last few minor versions.
  Let me know if this is still an issue. It should definitely work as expected in node 4.
  Thanks!
  I suppose they're probably not taking bug fixes for Jasmine 1.3 still?

https://github.com/pivotal/jasmine/blob/1_3_x/src/core/Spec.js#L124
  What browser are you in? The "Familiar Approach"/"Mock by Default"/"Short Feedback Lop" boxes are supposed to be side-by-side; they are meant to overflow the window instead of wrap on the left as your screenshot shows.
 Odd. I see this on a narrow window:

![image](https://cloud.githubusercontent.com/assets/6820/3225282/7f10fcba-f04c-11e3-9348-845251e44110.png)
 I agree with your style change here though.
  This should not be an issue any more with `jest 0.7+`.
  Test Plan: jest
 Oops, my mistake. I meant to save it in _moduleRegistry; fixed now and the test works as I expected it to.
 @vjeux Yeah, I wanted `===`.
 (Otherwise this looks good -- apologies for the super late response)
  This was fixed a while ago :)
  superagent should be unmocked or use a manual mock as suggested.
  Thanks!
  I'd recommend not mocking Backbone. It probably uses some meta programming that we can't mock properly.
  Not sure I understand? Starting a line with `#` would be invalid JS syntax... Here we have a comment
 Ohhh gotcha -- I knew I was missing something :p

Nice catch!
  Hey Jason!

Thanks for this -- looks great. Mind touching up the nit? Then I'll go ahead and merge
  I'm trying to find a way to repro this, but it's pretty tricky since I don't have access to a sizeable coffeescript codebase...

When I set up a very basic scenario it doesn't seem to cause any observable speed issues when I add another `it` spec: https://gist.github.com/jeffmo/f9db99b6c197327a30a7

Here's 3 runs of the test with 2 specs: https://gist.github.com/jeffmo/37220916b440d20a465a
Here's 3 runs of the test with 1 spec: https://gist.github.com/jeffmo/2e80968193c89a8a9e97

It would be good if we could narrow this down to where the time is spent. Any chance you could either point me somewhere where I might be able to repro this or try digging in to see if you could narrow it down?
 Ok, after a little investigation it seems the bulk of the time for each `it` spec is spent in your `beforeEach`. And, in there, it seems the majority of the time is spent running `require('react/addons)`

I'm still digging in to what's taking so much time in there, but the gist of the problem here seems to be that every `it()` has to re-`require('react/addons')`
 I tried moving the `require()` out into the top-level (so it doesn't have to run each time), but that seems to break stuff (I'm guessing there's some state in the module that needs to be reset between tests somehow)
 The easiest solution here would be to identify what the shared state is and just find a way to reset it in the `beforeEach` (rather than re-requiring the whole module).

It seems, however, that if you isolate the `react/addons` module (even just in raw node...no jest or anything) it takes about 130-150ms just to `require()` (!?!?) -- so maybe there's something someone can do over on the React side of things to make that module faster
 Going to go ahead and close this issue out because I'm not sure there's anything to be done from the Jest side of things
 (Possibly related to https://github.com/facebook/react/issues/812, but I'm guessing a different issue.)
  Thanks for catching this!

I think you¬†also need to update `examples/tutorial/fetchCurrentUser.js` and line 17 of the test to use `success` instead of `done` as well.
  Yea, I've been tracking this confusing error message here: https://github.com/facebook/jest/issues/14

This week and last have been super busy for me, so I haven't had a chance to dive in to it just yet, but I'll throw it to the top of the queue since I think it should be a fairly simple fix.

If you have further questions or concerns, lets continue the thread in https://github.com/facebook/jest/issues/14 to keep things centralized.
 That's a good point -- I'll update the title
  @luismreis: I just pushed 0.1.14 with https://github.com/facebook/jest/commit/aec987565f145f21af3f0344ba04cd93ae08413e

In my repro case that commit appears to fix the JSONStream issues.
Here's a gist of my repro case for reference: https://gist.github.com/jeffmo/2d0f41bbbe617118ea70

Mind pulling that in and confirming?
  Ah, yea this is probably an error that we should just swallow when doing the dependency calculation inside `HasteModuleLoader.getDependentsFromPath()`, I guess.
 Ok, I believe this should be fixed in https://github.com/facebook/jest/commit/d397b4ee871a149f2aa685289f4fe83af63b4076

It will still console.warn() to tell you that it couldn't find the module -- but it won't fatal
  Nice, this is even pretty clean
  Thanks a ton, @harshadsabne!
  Fixed via the console implementation https://github.com/facebook/jest/blob/98fbf3f28fbff2181cb4450366e0163106755756/src/Console.js
  We might be able to work some crazy `child_process` hackery in the bin/jest.js file if we detect that `--harmony` wasn't used to execute the file...
  I don't think I'll be adding support for this in jest. If you need this, feel free to send a pull request.
  Sorry for the delay -- this looks pretty great...thank you so much for this!
I know a lot of people are pretty excited about getting this in

It looks like you might need to rebase though. Mind doing that so I can merge this in?
 Merged -- thanks again!
  @luismreis: I haven't seen this -- mind posting the errors that are thrown? If they point to specific uses of `fs`, `graceful-fs` might be a good solution as @spicyj points out
 Just pushed out https://github.com/facebook/jest/commit/dbd9eb2eb2de1d04fb9510dc653bdfc063715ead which switches things from using `fs` to `graceful-fs`.

Unfortunately this one is a bit hard to repro, so it's tricky for me to verify the fix -- mind confirming that it solves your scenario?
 I take it this is not an issue any longer?
  See [`jasmine-pit`](https://www.npmjs.org/package/jasmine-pit) docs for more info on that, btw.
 @gbbr Are you trying to mock $.ajax or have it actually perform the network request?
 See http://jasmine.github.io/2.0/introduction.html#section-Asynchronous_Support

jasmine 2, pit and `runAllTimers` should provide enough options for async testing.
 We have extensive documentation on how to work with async/await and Promises: http://facebook.github.io/jest/docs/tutorial-async.html#content
  nice, thanks!
  We now have `moduleNameMapper` and both the resolver and runtime can be entirely swapped out. For now, I don't believe there is much need for anyone to add this feature, so I'll close out this task. We can add it anytime through a pull request, though :)
  Jasmine indeed
  Thanks for this!
  Going to close this out for now. @jbaiter: Feel free to re-open if you're still having issues here
  Yea, this sounds like an oversight.
Easy fix: https://github.com/facebook/jest/commit/bedd9660ae62a713a24c1eaab048c01d47e783a4
 `jest` probably makes sense, but it'll take a little more hackery: The `jest` object comes from inside the module loader -- and the setupEnvFile get's executed outside the module loader (...although maybe it shouldn't be executing from outside the module loader...)

Feel free to send a PR if you want to take a go at it -- otherwise I can take a look a little later
  Hmm, I just ran it and it seems to work for me (fresh clone of the repo, fresh `npm install`).

Random guess: Are you by chance on a windows machine?
(we haven't tested much running on windows -- but there are a couple people looking in to fixing that up)
 Whoa I haven't seen that error before...that looks like a node/v8 error message...
Can you maybe make a gist with each of the files you have set up?

It sounds like you typed up the examples from the site yourself -- do you have the same issues if you run `npm install` + `npm test` in the examples/react directory?

(Also -- if you want to hop in #jestjs on freenode, it might be a little easier to chat and debug there than here)
 Ok, for posterity after debugging together in IRC:

It looks like Evan was running node 0.11 (which is an unstable version of node).
When he downgraded to 0.10 (the latest stable release), this seemed to fix things.
  Having something faster than jsdom does sound intriguing -- this is worth looking into (I hadn't seen it before).

Even if we were to switch though, we'd still want to be able to run tests in Contextify contexts/Realms (so we can quickly and cheaply dispose/construct new ones) -- so I think a native dependency there would continue to be necessary for the foreseeable future
 This should be possible by providing the `testEnvironment_EXPERIMENTAL` config option. I'm going to close this because it isn't on Jest's roadmap but I will most certainly welcome contributions to Jest around this. See the JSDOMEnvironment and NodeEnvironment for examples.
  cc @vjeux -- it seems like the react-build versions of the MD files is confusing people when they want to fix typos/update. Any way we could just exclude them from the repo and only build them when publishing the website?
 Oh, cool!
 Ohh -- you meant that we manually copy-paste the example files (not that the script copy/pastes them)...oops

(just pushed an update for the .md file)
  Yea I'm seeing this too -- it seems npm is a bit flaky right now. If you try a couple of times it eventually seems to go through
 Not much I can do here until npm gets it's ducks in order :/
 FYI: This seems to have been fixed after I bumped the version and published again: https://github.com/facebook/node-haste/issues/15
  Ok, I think this should be fixed by https://github.com/facebook/jest/commit/56c4f5569ef771531f5dae35ac78f991e6ac9385
(I was able to confirm that it fixes your repro-case -- feel free to re-open if you're seeing any other related issues)
 Thanks a ton for the report and narrowing the issue down to `HasteModuleLoader._getNormalizedModuleID()` by the way -- that was really helpful!
  The problem with writing platform-specific tests is that they won't fail if someone is developing on another platform and breaks something. It would be much better if the tests mocked out platform-specific APIs and used that to test instead
 I'm pretty happy with this now -- just want to address the two comments I just now mentioned and I think we're ready to merge
 Heya @kl3ryk, thanks a ton for working through this with me. This is going to make a lot of win devs happy :)

I've been swamped the last couple of weeks so I haven't had a chance to follow up. If you can split out the `'utils-pathNormalize` test into it's own file (out of the `utils-normalizeConfig-test.js` file), I'll go ahead and merge this.
  It's on our roadmap to support module system add-ons for Jest (like require.js, es6 modules, etc), but unfortunately we're not quite there yet.

Let's leave this issue open to track progress on this, though -- I think it would be pretty useful to support require.js loaders
 Hey guys this is really awesome. I like the idea of Jestpack and I've been meaning to make it much easier to support additional module resolvers. Finally I also want to revamp the website and recommend solutions like Jestpack as part of the Getting Started guide (that I have in my head :) ). @richardscarrott and @sterpe please let me know if you need anything.

Also cc @mwolson and @ColCh 

(To everyone else: please stop upvoting comments, it is not helpful. If you want something built for jest, please send a pull request. Code wins arguments! Personally I can't prioritize features only because people in the community need them and I don't use _all the module loaders_ that are out there myself.).
 preprocessors are only run once and you can provide a cache key function. jest won't re-run your preprocessor if a file hasn't changed.
 Agreed that that isn't fast. At FB the first run takes almost twice as long as subsequent runs but personally I don't see any other to solve this ‚Äì we are using babel and other custom transforms at FB; we can't run tests without a preprocessor :)
 It should work fine with 0.5!
 `moduleLoader` can already be specified as part of the config, actually.
 Is anyone from the community interested in working on this? I'd be happy to support people through this and make an official Jest plugin. It is unlikely we will heavily invest into this at FB anytime soon. The Jest team is very small (1.5 people) and we can't get to work on all these features, unfortunately.
 Based on the current state of the JavaScript community and standard it doesn't seem like require js itself has a huge future for authoring JavaScript code. We now have a standardized module system in ES2015. Babel and Jest are now fully integrated and work well together. I will recommend anyone to switch to CommonJS or ES2015 modules, which will make more tooling available to you out of the box.

require JS also has a document here on how to convert CommonJS to require.js which can be used for production deploys, see: http://requirejs.org/docs/commonjs.html

Personally I see no upside in writing code using require JS. I'd also be happy to help write a [codemod](https://www.youtube.com/watch?v=d0pOgY8__JM) that can help transform require JS codebases to CommonJS. Another challenge could be to write a requireJS to CommonJS babel plugin and pluck it into Jest's preprocessor.
 I agree, I see little value in using RequireJS for authoring code. It makes sense to me to compile CommonJS/ES2015 module code to requirejs for production, but it doesn't seem great to write code with this style manually.
 @tendant nice! That is exactly what I was talking about before :) Glad it worked so well for you.
 If by Facebook you mean me, then yes, it is unlikely there will be "official" support. That shouldn't prevent you from contributing to Jest and getting this feature in but I believe most people have moved on to ES modules or CommonJS these days. @msrose this is awesome. Thank you so much for sharing this.  It's really unintuitive that you should put your require()s either in your specs or in your beforeEach() (because jest clears the module registry cache in between each spec).

We should see if we can alleviate confusion here by console.warn()ing when a require() happens outside of an it() or a beforeEach() function
  It only happens every so often, but it's super confusing and hard to debug when it does:

If ever a module were to somehow clobber it's exports object with something that isn't an object, you get a nasty error like this:

```
TypeError: Cannot read property 'ref' of null

at mocks.js:285:11
at visit (mocks.js:275:5)
at removeUnusedRefs (mocks.js:284:3)
at Object.module.exports.getMetadata (mocks.js:364:5)
at mock-modules.js:153:16
at mock-modules.js:128:22
at _generateMock (mock-modules.js:162:20)
at _System._loadAutoMock (mock-modules.js:199:51)
at _System._moduleRequire (mock-modules.js:313:17)
```

Let's add an assertion earlier on to ensure that the error message is at least helpful.

A common scenario where people hit this is when they're trying to test a react component that look something like this:

``` javascript
var React = require('React');

module.exports = React.createClass({
  // ...
});
```

In this case, if you don't explicitly mark the `React` module as unmocked, `module.exports` is assigned the return value of `React.createClass()` -- which is a mock function, and thus returns `undefined`.
 I just committed https://github.com/facebook/jest/commit/3e5ddee1a15154e17a8d901fc4f61e0f329587db (and published v0.1.15) which should make the module mocker more accurately pass through `undefined` and `null` exports values to the mocked version of the exports.

I also considered making jest throw with an error that suggests that, when `undefined` is encountered as an `exports` object, you should refer to this issue as it's likely that you're doing something like:

``` javascript
var createClass = require('createClass');
module.exports = createClass({ /*...*/ });
```

But I suppose this could false positive in the extremely rare case where someone, for some reason, _intentionally_ (or non-erroneously) set their exports object to `undefined`...in which case the error message could be even more misleading.

I'm not necessarily unwilling to do this -- but I do think errors of this type should surface a more debuggable stack trace now with error messages more along the lines of `TypeError: undefined is not a function`. I do wonder if this will lead to people finding the source of the problem in a more reasonable way.

If this continues to be a source of pain and we keep getting questions about this, I'm willing to re-consider short-circuiting intentional `module.exports = undefined` scenarios in favor of a detailed explanation of why you _might_ need to unmock something.
  Thanks @wyze!

Mind signing our CLA here: https://code.facebook.com/cla, so I can merge this?

EDIT: Whoa, we have a github-bot for this now -- neat
  Yea this is a good point. Let's make a config option for this (update coming)
 Added `config.testDirectoryName`

https://github.com/facebook/jest/commit/fcc7b26b7a3bbac959e96438a97fffef59a8b35b
 @laurenskling unfortunately that isn't possible right now. I might add this feature in the future however, when I rewrite how config/setup of jest works.
 We have `testRegex` now. `testDirectoryName` was removed. @jackson-sandland not sure if that's the issue, but generally you should keep `react` and `react-test-renderer` on the same major version (so either 14 or 15, not both) You can use testMatch if you are more familiar with globs. ```json
{
  "testMatch": ["**/spec/**/*.spec.ts"]
}
```  lgtm, but it looks like you missed the getting-started docs page too:
http://localhost:8080/jest/docs/getting-started.html

(I'm not sure exactly why these use different css...but I bet @vjeux might know)
  We have this now! Yay.
  We'll converge on `toBeCalled` and make it work for spies, cc @kentaromiura.
 @kentaromiura if you'd like to run a codemod on www that changes `toHaveBeenCalled` and friends to `toBeCalled`, feel free to do it :)
  I support this -- but it might be good to have it toggeable via an option to make grepping the output results still possible
  I really like this idea -- hacking on it now
 https://github.com/facebook/jest/commit/39356ebb579f8071922121624fc0f23668f3c5d0
  @spicyj would you mind rebasing this diff and making sure everything is green? I'd like to pull this in as part of 0.6.0 (Also add it to the changelog please).
 Actually, it has been a while. I don't think it makes sense to break this behavior so we should probably support both patterns or keep only the one we are supporting currently.
 If you want to support both patterns, please update your PR. If not, feel free to close this PR.
