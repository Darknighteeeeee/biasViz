
---
title: "语言特征分析仪表盘"
runtime: shiny
output: 
  flexdashboard::flex_dashboard:
    orientation: rows
    vertical_layout: fill
    navbar:
      - { title: "热图分析", icon: "fas fa-th" }
      - { title: "English Variation", icon: "fas fa-language" }
      - { title: "词性特征分析", icon: "fas fa-project-diagram" }
---

```{r global, include=FALSE}
library(flexdashboard)
library(shiny)
library(dplyr)
library(tidyr)
library(purrr)
library(readr)
library(plotly)
library(DT)
library(jsonlite)
library(gt)

# ========= 热图部分数据 =========
load_project_data <- function(project_num) {
  file_path <- paste0("project", project_num, ".csv")
  if(!file.exists(file_path)) stop(paste("错误：文件不存在 -", file_path))
  data <- read_csv(file_path) %>% mutate(Project = paste("项目", project_num))
  heatmap_data <- data %>%
    pivot_wider(
      names_from = Word2, 
      values_from = c("Cosine Similarity", "Euclidean Distance"),
      names_sep = "_"
    ) %>% as.data.frame()
  
  cosine_matrix <- heatmap_data %>%
    select(starts_with("Cosine Similarity_")) %>% as.matrix()
  rownames(cosine_matrix) <- heatmap_data$Word1
  colnames(cosine_matrix) <- gsub("Cosine Similarity_", "", colnames(cosine_matrix))
  
  euclidean_matrix <- heatmap_data %>%
    select(starts_with("Euclidean Distance_")) %>% as.matrix()
  rownames(euclidean_matrix) <- heatmap_data$Word1
  colnames(euclidean_matrix) <- gsub("Euclidean Distance_", "", colnames(euclidean_matrix))
  
  return(list(
    raw_data = data,
    cosine_matrix = cosine_matrix,
    euclidean_matrix = euclidean_matrix,
    project_name = paste("项目", project_num)
  ))
}
project_numbers <- 1:20

# ========= English Variation 数据 =========
if (file.exists("sentence_statistics.json")) {
  ev_data <- fromJSON("sentence_statistics.json")
  df_ev <- tibble::enframe(ev_data, name = "project", value = "stats") %>% 
    unnest_wider(stats) %>% 
    pivot_longer(cols = c("african_english", "standard_english"), 
                 names_to = "type", values_to = "count") %>% 
    group_by(project) %>% 
    mutate(percentage = count / sum(count) * 100) %>% 
    ungroup()
} else {
  df_ev <- tibble(project = character(), type = character(),
                  count = numeric(), percentage = numeric())
}

# ========= 词性特征分析数据 =========
data_files <- list.files(pattern = "\\.[jJ][sS][oO][nN]$", full.names = TRUE)
all_data <- lapply(data_files, function(x) {
  tryCatch({
    raw_data <- fromJSON(readChar(x, file.info(x)$size))
    df <- data.frame(
      feature = names(raw_data),
      value = unlist(raw_data),
      project = tools::file_path_sans_ext(basename(x)),
      stringsAsFactors = FALSE
    )
    df
  }, error = function(e) NULL)
}) %>% Filter(Negate(is.null), .) %>% bind_rows()

feature_labels <- c(
  "adverb" = "副词", "conj" = "连词", "clout" = "影响力", 
  "auxverb" = "助动词", "analytic_thinking" = "分析思维",
  "article" = "冠词", "ipron" = "冲动词", "negate" = "否定词",
  "authentic" = "真实性", "tone" = "语气",
  "prep" = "介词", "ppron" = "人称代词", "lsm" = "语言风格匹配"
)
long_data <- all_data %>% mutate(feature_label = recode(feature, !!!feature_labels, .default = feature))
```

# 热图分析 {data-icon="fas fa-th"}

## 侧边栏 {.sidebar}

```{r}
selectInput("project", "选择项目:", 
            choices = paste("项目", project_numbers), selected = "项目 1")
radioButtons("metric", "选择指标:",
             choices = c("余弦相似度" = "cosine","欧氏距离" = "euclidean"),
             selected = "cosine")
checkboxInput("show_values", "显示数值", value = TRUE)
```

### 热图

```{r}
renderPlotly({
  data <- load_project_data(as.numeric(gsub("项目 ", "", input$project)))
  if (input$metric == "cosine") {
    mat <- data$cosine_matrix
    colors <- colorRampPalette(c("blue","white","red"))(100)
    limits <- c(-1,1)
    title <- paste(data$project_name, "- 余弦相似度")
  } else {
    mat <- data$euclidean_matrix
    colors <- colorRampPalette(c("white","red"))(100)
    limits <- c(0, max(mat, na.rm=TRUE))
    title <- paste(data$project_name, "- 欧氏距离")
  }
  plot_ly(z = mat, x = colnames(mat), y = rownames(mat), type = "heatmap",
          colorscale = colors, zmin = limits[1], zmax = limits[2]) %>%
    layout(title = title)
})
```

### 数据表

```{r}
renderDT({
  datatable(load_project_data(as.numeric(gsub("项目 ", "", input$project)))$raw_data,
            options = list(pageLength = 5))
})
```

# English Variation {data-icon="fas fa-language"}

## 侧边栏 {.sidebar}

```{r}
if (nrow(df_ev) > 0) {
  selectInput("ev_project", "选择项目:", 
              choices = unique(df_ev$project), 
              selected = unique(df_ev$project)[1])
}
```

### 百分比堆叠条形图

```{r}
if (nrow(df_ev) > 0) {
  renderPlotly({
    plot_ly(df_ev, x = ~project, y = ~percentage, color = ~type, 
            colors = c("african_english" = "#1f77b4", "standard_english" = "#ff7f0e"),
            type = "bar", hoverinfo = "text",
            text = ~paste0("Project: ", project, "<br>Type: ", type,
                           "<br>Count: ", count, "<br>Percentage: ", round(percentage,1), "%")) %>%
      layout(title = "Percentage of African English vs. Standard English",
             barmode = "stack")
  })
}
```

### 数据汇总

```{r}
if (nrow(df_ev) > 0) {
  summary_df <- df_ev %>% 
    select(project, type, count, percentage) %>% 
    pivot_wider(names_from = type, values_from = c(count, percentage)) %>% 
    arrange(project)
  
  summary_df %>%
    gt() %>%
    tab_header(title = md("**English Variation by Project**")) %>%
    fmt_number(columns = starts_with("percentage"), decimals = 1) %>%
    fmt_integer(columns = starts_with("count"))
}
```

# 词性特征分析 {data-icon="fas fa-project-diagram"}

## 侧边栏 {.sidebar}

```{r}
if (nrow(long_data) > 0) {
  selectInput("pos_project", "选择项目:",
              choices = unique(long_data$project),
              selected = unique(long_data$project)[1])
}
```

### 雷达图

```{r}
if (nrow(long_data) > 0) {
  renderPlotly({
    data <- long_data %>% filter(project == input$pos_project)
    radar_data <- data %>% arrange(factor(feature, levels = names(feature_labels))) %>%
      bind_rows(data[1,])
    plot_ly(type = 'scatterpolar', mode = 'lines') %>%
      add_trace(r = radar_data$value,
                theta = c(feature_labels[radar_data$feature[-nrow(radar_data)]],
                          feature_labels[radar_data$feature[1]]),
                fill = 'toself', name = input$pos_project)
  })
}
```

### 条形图

```{r}
if (nrow(long_data) > 0) {
  renderPlotly({
    data <- long_data %>% 
      filter(project == input$pos_project) %>%
      mutate(feature_label = factor(feature_label, levels = feature_labels))
    
    plot_ly(data, x = ~feature_label, y = ~value, type = "bar") %>%
      layout(title = paste(input$pos_project, "各词性特征值"),
             xaxis = list(title = "特征", tickangle = 45),
             yaxis = list(title = "值", range = c(0, 1)))
  })
}
```

### 数据表

```{r}
if (nrow(long_data) > 0) {
  renderDT({
    wide_data <- long_data %>%
      select(project, feature_label, value) %>%
      pivot_wider(names_from = feature_label, values_from = value) %>%
      arrange(project)
    
    datatable(wide_data, options = list(pageLength = 10), filter = "top")
  })
}
```

---


