---
title: "new3"
author: 'NULL'
date: "2025-09-03"
output: html_document
---




```{r}



library(shiny)
library(readr)
library(dplyr)
library(tidyr)
library(plotly)
library(DT)
library(jsonlite)

load_project_data <- function(project_num) {
  file_path <- paste0("project", project_num, ".csv")
  if (!file.exists(file_path)) {
    return(list(error = TRUE, message = paste0("Cannot find: ", file_path)))
  }
  raw <- tryCatch(read_csv(file_path, show_col_types = FALSE), error = function(e) NULL)
  if (is.null(raw)) return(list(error = TRUE, message = paste0("Failed to parse: ", file_path)))

  names(raw) <- gsub("\\n|\\r", " ", names(raw))
  cs_col <- grep("cosine|Cosine|cos_sim|cosine similarity", names(raw), ignore.case = TRUE, value = TRUE)[1]
  ed_col <- grep("euclid|Euclidean|euclid distance", names(raw), ignore.case = TRUE, value = TRUE)[1]
  w1_col <- grep("^word1$|^word_1$|^word$|^term1$", names(raw), ignore.case = TRUE, value = TRUE)[1]
  w2_col <- grep("^word2$|^word_2$|^adj$|^term2$", names(raw), ignore.case = TRUE, value = TRUE)[1]

  if (is.na(w1_col) || is.na(w2_col) || (is.na(cs_col) && is.na(ed_col))) {
    return(list(error = TRUE, message = paste0("CSV missing expected columns in ", file_path)))
  }

  df <- raw %>% rename(Word1 = !!w1_col, Word2 = !!w2_col)
  if (!is.na(cs_col)) df <- df %>% rename(Cosine = !!cs_col)
  if (!is.na(ed_col)) df <- df %>% rename(Euclid = !!ed_col)

  wide <- df %>%
    pivot_wider(names_from = Word2, values_from = c(Cosine, Euclid), names_sep = "_") %>%
    as.data.frame()

  cosine_matrix <- NULL
  euclid_matrix <- NULL

  if (any(startsWith(names(wide), "Cosine_"))) {
    cm <- wide %>% select(starts_with("Cosine_")) %>% as.matrix()
    rownames(cm) <- wide$Word1
    colnames(cm) <- gsub("Cosine_", "", colnames(cm))
    cosine_matrix <- cm
  }

  if (any(startsWith(names(wide), "Euclid_"))) {
    em <- wide %>% select(starts_with("Euclid_")) %>% as.matrix()
    rownames(em) <- wide$Word1
    colnames(em) <- gsub("Euclid_", "", colnames(em))
    euclid_matrix <- em
  }

  return(list(
    error = FALSE,
    raw_data = df,
    cosine_matrix = cosine_matrix,
    euclidean_matrix = euclid_matrix,
    project_name = paste("项目", project_num)
  ))
}

load_sentence_stats <- function(json_path = "sentence_statistics.json") {
  if (!file.exists(json_path)) return(NULL)
  tryCatch({
    data <- fromJSON(json_path)
    df <- tibble::enframe(data, name = "project", value = "stats") %>%
      unnest_wider(stats) %>%
      pivot_longer(cols = c("african_english", "standard_english"), names_to = "type", values_to = "count") %>%
      group_by(project) %>% mutate(percentage = count / sum(count) * 100) %>% ungroup()
    df
  }, error = function(e) NULL)
}

load_pos_all <- function() {
  files <- list.files(pattern = "\\.json$", full.names = TRUE)
  if (length(files) == 0) return(NULL)
  l <- lapply(files, function(f) {
    if (basename(f) == "sentence_statistics.json") return(NULL)
    js <- tryCatch(fromJSON(readChar(f, file.info(f)$size)), error = function(e) NULL)
    if (is.null(js)) return(NULL)
    data.frame(feature = names(js), value = as.numeric(unlist(js)), project = tools::file_path_sans_ext(basename(f)), stringsAsFactors = FALSE)
  })
  do.call(bind_rows, l) %>% mutate(value = as.numeric(value))
}

feature_labels <- c(
  adverb = "副词", conj = "连词", clout = "影响力",
  auxverb = "助动词", analytic_thinking = "分析思维",
  article = "冠词", ipron = "冲动词", negate = "否定词",
  authentic = "真实性", tone = "语气",
  prep = "介词", ppron = "人称代词", lsm = "语言风格匹配"
)

ui <- fluidPage(
  titlePanel("统一 Shiny 仪表盘"),
  sidebarLayout(
    sidebarPanel(
      h4("Heatmap 控件"),
      selectInput("project_select", "选择项目 (Heatmap):", choices = paste("项目", 1:20), selected = "项目 1"),
      radioButtons("metric", "指标:", choices = c("余弦相似度" = "cosine", "欧氏距离" = "euclidean"), selected = "cosine"),
      checkboxInput("show_values", "显示数值", value = TRUE),
      sliderInput("font_size", "字体大小", min = 8, max = 20, value = 12),
      hr(),
      h4("POS & 英语变体 控件"),
      uiOutput("pos_project_ui"),
      hr(),
      actionButton("refresh_all", "刷新数据")
    ),
    mainPanel(
      tabsetPanel(
        tabPanel("Heatmap",
                 plotlyOutput("heatmap_plot", height = "700px"),
                 DTOutput("heatmap_table")
        ),
        tabPanel("English Variation",
                 plotlyOutput("engvar_plot", height = "500px"),
                 DTOutput("engvar_table")
        ),
        tabPanel("POS Features",
                 plotlyOutput("pos_radar", height = "450px"),
                 plotlyOutput("pos_bar", height = "350px"),
                 DTOutput("pos_table")
        )
      )
    )
  )
)

server <- function(input, output, session) {
  proj_cache <- reactiveVal(list())
  sentence_stats <- reactiveVal(NULL)
  pos_long <- reactiveVal(NULL)

  observeEvent(input$refresh_all, {
    proj_cache(list())
    sentence_stats(NULL)
    pos_long(NULL)
  })

  observe({
    if (is.null(sentence_stats())) sentence_stats(load_sentence_stats())
  })

  observe({
    if (is.null(pos_long())) pos_long(load_pos_all())
  })

  output$pos_project_ui <- renderUI({
    pd <- pos_long()
    if (is.null(pd)) return(helpText("未找到 POS JSON 文件。"))
    selectInput("pos_project", "选择项目 (POS):", choices = unique(pd$project), selected = unique(pd$project)[1])
  })

  selected_data <- reactive({
    pnum <- as.numeric(gsub("项目\\s*", "", input$project_select))
    cache <- proj_cache()
    key <- as.character(pnum)
    if (!is.null(cache[[key]])) return(cache[[key]])
    res <- load_project_data(pnum)
    cache[[key]] <- res
    proj_cache(cache)
    res
  })

  output$heatmap_plot <- renderPlotly({
    dat <- selected_data()
    if (is.null(dat) || dat$error) {
      return(plot_ly() %>% layout(title = dat$message %||% "未加载数据"))
    }
    if (input$metric == "cosine") {
      mat <- dat$cosine_matrix
      if (is.null(mat)) return(plot_ly() %>% layout(title = "此项目没有余弦相似度数据"))
      zmin <- -1; zmax <- 1
      title <- paste(dat$project_name, "- 余弦相似度")
    } else {
      mat <- dat$euclidean_matrix
      if (is.null(mat)) return(plot_ly() %>% layout(title = "此项目没有欧氏距离数据"))
      zmin <- min(mat, na.rm = TRUE); zmax <- max(mat, na.rm = TRUE)
      title <- paste(dat$project_name, "- 欧氏距离")
    }

    p <- plot_ly(z = mat, x = colnames(mat), y = rownames(mat), type = "heatmap", zmin = zmin, zmax = zmax, colorscale = "Viridis") %>%
      layout(title = title, xaxis = list(title = "形容词"), yaxis = list(title = "词语"))
    p
  })

  output$heatmap_table <- renderDT({
    dat <- selected_data()
    if (is.null(dat) || dat$error) return(datatable(data.frame(Message = dat$message)))
    datatable(dat$raw_data, options = list(pageLength = 8))
  })

  output$engvar_plot <- renderPlotly({
    df <- sentence_stats()
    if (is.null(df)) return(plot_ly() %>% layout(title = "未找到 sentence_statistics.json"))
    df <- df %>% mutate(project = factor(project, levels = unique(project)))
    plot_ly(df, x = ~project, y = ~percentage, color = ~type, type = "bar", text = ~paste0(round(percentage,1), "%"), hoverinfo = "text") %>%
      layout(barmode = "stack", title = "English Variation", xaxis = list(title = "Project"), yaxis = list(title = "Percentage (%)"))
  })

  output$engvar_table <- renderDT({
    df <- sentence_stats()
    if (is.null(df)) return(datatable(data.frame(Message = "无数据")))
    wide <- df %>% select(project, type, count, percentage) %>% pivot_wider(names_from = type, values_from = c(count, percentage))
    datatable(wide, options = list(pageLength = 10))
  })

  output$pos_radar <- renderPlotly({
    pd <- pos_long()
    req(pd)
    proj <- input$pos_project
    req(proj)
    data <- pd %>% filter(project == proj)
    if (nrow(data) == 0) return(plot_ly() %>% layout(title = "无 POS 数据"))
    order_features <- intersect(names(feature_labels), data$feature)
    radar_df <- data %>% filter(feature %in% order_features) %>% arrange(match(feature, order_features))
    r_vals <- c(radar_df$value, radar_df$value[1])
    theta_vals <- c(unname(feature_labels[radar_df$feature]), unname(feature_labels[radar_df$feature[1]]))
    plot_ly(type = 'scatterpolar', r = r_vals, theta = theta_vals, fill = 'toself', name = proj) %>%
      layout(title = paste(proj, "词性特征雷达图"), polar = list(radialaxis = list(visible = TRUE, range = c(0, 1))))
  })

  output$pos_bar <- renderPlotly({
    pd <- pos_long()
    req(pd)
    data <- pd %>% filter(project == input$pos_project)
    req(nrow(data) > 0)
    data <- data %>% mutate(feature_label = recode(feature, !!!feature_labels, .default = feature)) %>% arrange(match(feature_label, unname(feature_labels)))
    plot_ly(data, x = ~feature_label, y = ~value, type = 'bar', text = ~round(value,3), hoverinfo = 'text') %>%
      layout(title = paste(input$pos_project, "各词性特征值"), xaxis = list(tickangle = 45), yaxis = list(range = c(0,1)))
  })

  output$pos_table <- renderDT({
    pd <- pos_long()
    req(pd)
    wide_data <- pd %>% mutate(feature_label = recode(feature, !!!feature_labels, .default = feature)) %>%
      select(project, feature_label, value) %>% pivot_wider(names_from = feature_label, values_from = value) %>% arrange(project)
    datatable(wide_data, options = list(pageLength = 10), filter = 'top')
  })
}

shinyApp(ui, server)

```






```{r}
library(shiny)
library(readr)
library(dplyr)
library(tidyr)
library(plotly)
library(DT)
library(jsonlite)

# ------------------------- Data Loaders -------------------------

load_project_data <- function(project_name) {
  file_path <- paste0(project_name, ".csv")
  if (!file.exists(file_path)) {
    return(list(error = TRUE, message = paste0("Cannot find: ", file_path)))
  }
  raw <- tryCatch(read_csv(file_path, show_col_types = FALSE), error = function(e) NULL)
  if (is.null(raw)) return(list(error = TRUE, message = paste0("Failed to parse: ", file_path)))

  names(raw) <- gsub("\\n|\\r", " ", names(raw))
  cs_col <- grep("cosine|Cosine|cos_sim|cosine similarity", names(raw), ignore.case = TRUE, value = TRUE)[1]
  ed_col <- grep("euclid|Euclidean|euclid distance", names(raw), ignore.case = TRUE, value = TRUE)[1]
  w1_col <- grep("^word1$|^word_1$|^word$|^term1$", names(raw), ignore.case = TRUE, value = TRUE)[1]
  w2_col <- grep("^word2$|^word_2$|^adj$|^term2$", names(raw), ignore.case = TRUE, value = TRUE)[1]

  if (is.na(w1_col) || is.na(w2_col) || (is.na(cs_col) && is.na(ed_col))) {
    return(list(error = TRUE, message = paste0("CSV missing expected columns in ", file_path)))
  }

  df <- raw %>% rename(Word1 = !!w1_col, Word2 = !!w2_col)
  if (!is.na(cs_col)) df <- df %>% rename(Cosine = !!cs_col)
  if (!is.na(ed_col)) df <- df %>% rename(Euclid = !!ed_col)

  wide <- df %>%
    pivot_wider(names_from = Word2, values_from = c(Cosine, Euclid), names_sep = "_") %>%
    as.data.frame()

  cosine_matrix <- NULL
  euclid_matrix <- NULL

  if (any(startsWith(names(wide), "Cosine_"))) {
    cm <- wide %>% select(starts_with("Cosine_")) %>% as.matrix()
    rownames(cm) <- wide$Word1
    colnames(cm) <- gsub("Cosine_", "", colnames(cm))
    cosine_matrix <- cm
  }

  if (any(startsWith(names(wide), "Euclid_"))) {
    em <- wide %>% select(starts_with("Euclid_")) %>% as.matrix()
    rownames(em) <- wide$Word1
    colnames(em) <- gsub("Euclid_", "", colnames(em))
    euclid_matrix <- em
  }

  return(list(
    error = FALSE,
    raw_data = df,
    cosine_matrix = cosine_matrix,
    euclidean_matrix = euclid_matrix,
    project_name = project_name
  ))
}

load_sentence_stats <- function(json_path = "sentence_statistics.json") {
  if (!file.exists(json_path)) return(NULL)
  tryCatch({
    data <- fromJSON(json_path)
    df <- tibble::enframe(data, name = "project", value = "stats") %>%
      unnest_wider(stats) %>%
      pivot_longer(cols = c("african_english", "standard_english"),
                   names_to = "type", values_to = "count") %>%
      group_by(project) %>%
      mutate(percentage = count / sum(count) * 100) %>%
      ungroup()
    df
  }, error = function(e) NULL)
}

load_pos_all <- function() {
  files <- list.files(pattern = "\\.json$", full.names = TRUE)
  if (length(files) == 0) return(NULL)
  l <- lapply(files, function(f) {
    if (basename(f) == "sentence_statistics.json") return(NULL)
    js <- tryCatch(fromJSON(readChar(f, file.info(f)$size)), error = function(e) NULL)
    if (is.null(js)) return(NULL)
    data.frame(
      feature = names(js),
      value = as.numeric(unlist(js)),
      project = tools::file_path_sans_ext(basename(f)),
      stringsAsFactors = FALSE
    )
  })
  do.call(bind_rows, l) %>% mutate(value = as.numeric(value))
}

feature_labels <- c(
  adverb = "Adverb", conj = "Conjunction", clout = "Clout",
  auxverb = "Aux Verb", analytic_thinking = "Analytic Thinking",
  article = "Article", ipron = "Impersonal Pronoun", negate = "Negation",
  authentic = "Authenticity", tone = "Tone",
  prep = "Preposition", ppron = "Personal Pronoun", lsm = "LSM"
)

# ------------------------- UI -------------------------

ui <- fluidPage(
  titlePanel("Unified Shiny Dashboard"),
  sidebarLayout(
    sidebarPanel(
      h4("Controls"),
      selectInput("project_select", "Select Project:",
                  choices = paste0("lsm_result", 0:19), selected = "lsm_result0"),
      radioButtons("metric", "Heatmap Metric:",
                   choices = c("Cosine Similarity" = "cosine", "Euclidean Distance" = "euclidean"),
                   selected = "cosine"),
      checkboxInput("show_values", "Show Values", value = TRUE),
      sliderInput("font_size", "Font Size", min = 8, max = 20, value = 12),
      hr(),
      actionButton("refresh_all", "Refresh All Data")
    ),
    mainPanel(
      # Unified single tab content
      h3("Heatmap"),
      plotlyOutput("heatmap_plot", height = "700px"),
      DTOutput("heatmap_table"),
      hr(),
      h3("English Variation"),
      plotlyOutput("engvar_plot", height = "500px"),
      DTOutput("engvar_table"),
      hr(),
      h3("POS Features"),
      plotlyOutput("pos_radar", height = "450px"),
      plotlyOutput("pos_bar", height = "350px"),
      DTOutput("pos_table")
    )
  )
)

# ------------------------- SERVER -------------------------

server <- function(input, output, session) {
  proj_cache <- reactiveVal(list())
  sentence_stats <- reactiveVal(NULL)
  pos_long <- reactiveVal(NULL)

  observeEvent(input$refresh_all, {
    proj_cache(list())
    sentence_stats(NULL)
    pos_long(NULL)
  })

  observe({
    if (is.null(sentence_stats())) sentence_stats(load_sentence_stats())
  })

  observe({
    if (is.null(pos_long())) pos_long(load_pos_all())
  })

  selected_data <- reactive({
    pname <- input$project_select
    cache <- proj_cache()
    key <- pname
    if (!is.null(cache[[key]])) return(cache[[key]])
    res <- load_project_data(pname)
    cache[[key]] <- res
    proj_cache(cache)
    res
  })

  # Heatmap
output$heatmap_plot <- renderPlotly({
  dat <- selected_data()
  if (is.null(dat) || dat$error) {
    return(plot_ly() %>% layout(title = if (is.null(dat$message)) "Data not loaded" else dat$message))
  }
  if (input$metric == "cosine") {
    mat <- dat$cosine_matrix
    if (is.null(mat)) return(plot_ly() %>% layout(title = "No cosine similarity data"))
    zmin <- -1; zmax <- 1
    title <- paste(dat$project_name, "- Cosine Similarity")
  } else {
    mat <- dat$euclidean_matrix
    if (is.null(mat)) return(plot_ly() %>% layout(title = "No Euclidean distance data"))
    zmin <- min(mat, na.rm = TRUE); zmax <- max(mat, na.rm = TRUE)
    title <- paste(dat$project_name, "- Euclidean Distance")
  }

  plot_ly(
    z = mat, x = colnames(mat), y = rownames(mat),
    type = "heatmap", zmin = zmin, zmax = zmax, colorscale = "Viridis"
  ) %>% layout(title = title, xaxis = list(title = "Word2"), yaxis = list(title = "Word1"))
})


  output$heatmap_table <- renderDT({
    dat <- selected_data()
    if (is.null(dat) || dat$error) return(datatable(data.frame(Message = dat$message)))
    datatable(dat$raw_data, options = list(pageLength = 8))
  })

  # English variation
  output$engvar_plot <- renderPlotly({
    df <- sentence_stats()
    if (is.null(df)) return(plot_ly() %>% layout(title = "sentence_statistics.json not found"))
    df <- df %>% mutate(project = factor(project, levels = unique(project)))
    plot_ly(df, x = ~project, y = ~percentage, color = ~type, type = "bar",
            text = ~paste0(round(percentage,1), "%"), hoverinfo = "text") %>%
      layout(barmode = "stack", title = "English Variation",
             xaxis = list(title = "Project"), yaxis = list(title = "Percentage (%)"))
  })

  output$engvar_table <- renderDT({
    df <- sentence_stats()
    if (is.null(df)) return(datatable(data.frame(Message = "No data")))
    wide <- df %>%
      select(project, type, count, percentage) %>%
      pivot_wider(names_from = type, values_from = c(count, percentage))
    datatable(wide, options = list(pageLength = 10))
  })

  # POS Features
  output$pos_radar <- renderPlotly({
    pd <- pos_long()
    req(pd)
    proj <- input$project_select
    data <- pd %>% filter(project == proj)
    if (nrow(data) == 0) return(plot_ly() %>% layout(title = "No POS data"))
    order_features <- intersect(names(feature_labels), data$feature)
    radar_df <- data %>% filter(feature %in% order_features) %>% arrange(match(feature, order_features))
    r_vals <- c(radar_df$value, radar_df$value[1])
    theta_vals <- c(unname(feature_labels[radar_df$feature]), unname(feature_labels[radar_df$feature[1]]))
    plot_ly(type = 'scatterpolar', r = r_vals, theta = theta_vals, fill = 'toself', name = proj) %>%
      layout(title = paste(proj, "POS Feature Radar"), polar = list(radialaxis = list(visible = TRUE, range = c(0, 1))))
  })

  output$pos_bar <- renderPlotly({
    pd <- pos_long()
    req(pd)
    proj <- input$project_select
    data <- pd %>% filter(project == proj)
    req(nrow(data) > 0)
    data <- data %>%
      mutate(feature_label = recode(feature, !!!feature_labels, .default = feature)) %>%
      arrange(match(feature_label, unname(feature_labels)))
    plot_ly(data, x = ~feature_label, y = ~value, type = 'bar',
            text = ~round(value,3), hoverinfo = 'text') %>%
      layout(title = paste(proj, "POS Feature Values"),
             xaxis = list(tickangle = 45), yaxis = list(range = c(0,1)))
  })

  output$pos_table <- renderDT({
    pd <- pos_long()
    req(pd)
    wide_data <- pd %>%
      mutate(feature_label = recode(feature, !!!feature_labels, .default = feature)) %>%
      select(project, feature_label, value) %>%
      pivot_wider(names_from = feature_label, values_from = value) %>%
      arrange(project)
    datatable(wide_data, options = list(pageLength = 10), filter = 'top')
  })
}

# ------------------------- Run App -------------------------
shinyApp(ui, server)

```






```{r}
library(shiny)
library(plotly)
library(DT)
library(dplyr)
library(tidyr)
library(jsonlite)
library(tools)

# ------------------------- Data Loaders -------------------------

load_project_data <- function(project_name) {
  file_path <- paste0(project_name, ".json")
  if (!file.exists(file_path)) {
    return(list(error = TRUE, message = paste0("Cannot find: ", file_path)))
  }
  
  js <- tryCatch(fromJSON(readChar(file_path, file.info(file_path)$size)), error = function(e) NULL)
  if (is.null(js)) {
    return(list(error = TRUE, message = paste0("Failed to parse: ", file_path)))
  }
  
  # 处理 JSON 结构
  # 这里假设 JSON 结构形如：
  # {
  #   "pairs": [
  #       {"word1": "a", "word2": "b", "cosine": 0.8, "euclid": 0.5},
  #       ...
  #   ]
  # }
  df <- NULL
  if (!is.null(js$pairs)) {
    df <- as.data.frame(js$pairs)
  } else {
    df <- as.data.frame(js)
  }
  
  # 检查列
  w1_col <- grep("word1", names(df), ignore.case = TRUE, value = TRUE)[1]
  w2_col <- grep("word2", names(df), ignore.case = TRUE, value = TRUE)[1]
  cs_col <- grep("cos", names(df), ignore.case = TRUE, value = TRUE)[1]
  ed_col <- grep("eucl", names(df), ignore.case = TRUE, value = TRUE)[1]
  
  if (is.na(w1_col) || is.na(w2_col) || (is.na(cs_col) && is.na(ed_col))) {
    return(list(error = TRUE, message = paste0("JSON missing expected fields in ", file_path)))
  }
  
  df <- df %>% rename(Word1 = !!w1_col, Word2 = !!w2_col)
  if (!is.na(cs_col)) df <- df %>% rename(Cosine = !!cs_col)
  if (!is.na(ed_col)) df <- df %>% rename(Euclid = !!ed_col)
  
  wide <- df %>%
    pivot_wider(names_from = Word2, values_from = c(Cosine, Euclid), names_sep = "_") %>%
    as.data.frame()
  
  cosine_matrix <- NULL
  euclid_matrix <- NULL
  
  if (any(startsWith(names(wide), "Cosine_"))) {
    cm <- wide %>% select(starts_with("Cosine_")) %>% as.matrix()
    rownames(cm) <- wide$Word1
    colnames(cm) <- gsub("Cosine_", "", colnames(cm))
    cosine_matrix <- cm
  }
  
  if (any(startsWith(names(wide), "Euclid_"))) {
    em <- wide %>% select(starts_with("Euclid_")) %>% as.matrix()
    rownames(em) <- wide$Word1
    colnames(em) <- gsub("Euclid_", "", colnames(em))
    euclid_matrix <- em
  }
  
  return(list(
    error = FALSE,
    raw_data = df,
    cosine_matrix = cosine_matrix,
    euclidean_matrix = euclid_matrix,
    project_name = project_name
  ))
}

load_sentence_stats <- function(json_path = "sentence_statistics.json") {
  if (!file.exists(json_path)) return(NULL)
  tryCatch({
    data <- fromJSON(json_path)
    df <- tibble::enframe(data, name = "project", value = "stats") %>%
      unnest_wider(stats) %>%
      pivot_longer(cols = c("african_english", "standard_english"),
                   names_to = "type", values_to = "count") %>%
      group_by(project) %>%
      mutate(percentage = count / sum(count) * 100) %>%
      ungroup()
    df
  }, error = function(e) NULL)
}

load_pos_all <- function() {
  files <- list.files(pattern = "\\.json$", full.names = TRUE)
  if (length(files) == 0) return(NULL)
  l <- lapply(files, function(f) {
    if (basename(f) == "sentence_statistics.json") return(NULL)
    js <- tryCatch(fromJSON(readChar(f, file.info(f)$size)), error = function(e) NULL)
    if (is.null(js)) return(NULL)
    # POS 特征 JSON：假设是简单的 key-value
    if (all(sapply(js, is.numeric))) {
      data.frame(
        feature = names(js),
        value = as.numeric(unlist(js)),
        project = tools::file_path_sans_ext(basename(f)),
        stringsAsFactors = FALSE
      )
    } else {
      NULL
    }
  })
  do.call(bind_rows, l) %>% mutate(value = as.numeric(value))
}

feature_labels <- c(
  adverb = "Adverb", conj = "Conjunction", clout = "Clout",
  auxverb = "Aux Verb", analytic_thinking = "Analytic Thinking",
  article = "Article", ipron = "Impersonal Pronoun", negate = "Negation",
  authentic = "Authenticity", tone = "Tone",
  prep = "Preposition", ppron = "Personal Pronoun", lsm = "LSM"
)

# ------------------------- UI -------------------------

ui <- fluidPage(
  titlePanel("Unified Shiny Dashboard (JSON Version)"),
  sidebarLayout(
    sidebarPanel(
      selectInput("project_select", "Select Project:",
                  choices = paste0("lsm_results", 0:19), selected = "lsm_results0"),
      radioButtons("metric", "Heatmap Metric:",
                   choices = c("Cosine Similarity" = "cosine", "Euclidean Distance" = "euclidean"),
                   selected = "cosine"),
      actionButton("refresh_all", "Refresh All Data")
    ),
    mainPanel(
      h3("Heatmap"),
      plotlyOutput("heatmap_plot", height = "600px"),
      DTOutput("heatmap_table"),
      hr(),
      h3("English Variation"),
      plotlyOutput("engvar_plot", height = "400px"),
      DTOutput("engvar_table"),
      hr(),
      h3("POS Features"),
      plotlyOutput("pos_radar", height = "400px"),
      plotlyOutput("pos_bar", height = "300px"),
      DTOutput("pos_table")
    )
  )
)

# ------------------------- SERVER -------------------------

server <- function(input, output, session) {
  proj_cache <- reactiveVal(list())
  sentence_stats <- reactiveVal(NULL)
  pos_long <- reactiveVal(NULL)
  
  observeEvent(input$refresh_all, {
    proj_cache(list())
    sentence_stats(NULL)
    pos_long(NULL)
  })
  
  observe({
    if (is.null(sentence_stats())) sentence_stats(load_sentence_stats())
  })
  
  observe({
    if (is.null(pos_long())) pos_long(load_pos_all())
  })
  
  selected_data <- reactive({
    pname <- input$project_select
    cache <- proj_cache()
    if (!is.null(cache[[pname]])) return(cache[[pname]])
    res <- load_project_data(pname)
    cache[[pname]] <- res
    proj_cache(cache)
    res
  })
  
  # Heatmap
  output$heatmap_plot <- renderPlotly({
    dat <- selected_data()
    if (is.null(dat) || dat$error) {
      return(plot_ly() %>% layout(title = dat$message))
    }
    if (input$metric == "cosine") {
      mat <- dat$cosine_matrix
      if (is.null(mat)) return(plot_ly() %>% layout(title = "No cosine similarity data"))
      zmin <- -1; zmax <- 1
      title <- paste(dat$project_name, "- Cosine Similarity")
    } else {
      mat <- dat$euclidean_matrix
      if (is.null(mat)) return(plot_ly() %>% layout(title = "No Euclidean distance data"))
      zmin <- min(mat, na.rm = TRUE); zmax <- max(mat, na.rm = TRUE)
      title <- paste(dat$project_name, "- Euclidean Distance")
    }
    
    plot_ly(
      z = mat, x = colnames(mat), y = rownames(mat),
      type = "heatmap", zmin = zmin, zmax = zmax, colorscale = "Viridis"
    ) %>% layout(title = title, xaxis = list(title = "Word2"), yaxis = list(title = "Word1"))
  })
  
  output$heatmap_table <- renderDT({
    dat <- selected_data()
    if (is.null(dat) || dat$error) return(datatable(data.frame(Message = dat$message)))
    datatable(dat$raw_data, options = list(pageLength = 8))
  })
  
  # English Variation
  output$engvar_plot <- renderPlotly({
    df <- sentence_stats()
    if (is.null(df)) return(plot_ly() %>% layout(title = "sentence_statistics.json not found"))
    df <- df %>% mutate(project = factor(project, levels = unique(project)))
    plot_ly(df, x = ~project, y = ~percentage, color = ~type, type = "bar",
            text = ~paste0(round(percentage,1), "%"), hoverinfo = "text") %>%
      layout(barmode = "stack", title = "English Variation",
             xaxis = list(title = "Project"), yaxis = list(title = "Percentage (%)"))
  })
  
  output$engvar_table <- renderDT({
    df <- sentence_stats()
    if (is.null(df)) return(datatable(data.frame(Message = "No data")))
    wide <- df %>%
      select(project, type, count, percentage) %>%
      pivot_wider(names_from = type, values_from = c(count, percentage))
    datatable(wide, options = list(pageLength = 10))
  })
  
  # POS Features
  output$pos_radar <- renderPlotly({
    pd <- pos_long()
    req(pd)
    proj <- input$project_select
    data <- pd %>% filter(project == proj)
    if (nrow(data) == 0) return(plot_ly() %>% layout(title = "No POS data"))
    order_features <- intersect(names(feature_labels), data$feature)
    radar_df <- data %>% filter(feature %in% order_features) %>% arrange(match(feature, order_features))
    r_vals <- c(radar_df$value, radar_df$value[1])
    theta_vals <- c(unname(feature_labels[radar_df$feature]), unname(feature_labels[radar_df$feature[1]]))
    plot_ly(type = 'scatterpolar', r = r_vals, theta = theta_vals, fill = 'toself', name = proj) %>%
      layout(title = paste(proj, "POS Feature Radar"), polar = list(radialaxis = list(visible = TRUE, range = c(0, 1))))
  })
  
  output$pos_bar <- renderPlotly({
    pd <- pos_long()
    req(pd)
    proj <- input$project_select
    data <- pd %>% filter(project == proj)
    req(nrow(data) > 0)
    data <- data %>%
      mutate(feature_label = recode(feature, !!!feature_labels, .default = feature)) %>%
      arrange(match(feature_label, unname(feature_labels)))
    plot_ly(data, x = ~feature_label, y = ~value, type = 'bar',
            text = ~round(value,3), hoverinfo = 'text') %>%
      layout(title = paste(proj, "POS Feature Values"),
             xaxis = list(tickangle = 45), yaxis = list(range = c(0,1)))
  })
  
  output$pos_table <- renderDT({
    pd <- pos_long()
    req(pd)
    wide_data <- pd %>%
      mutate(feature_label = recode(feature, !!!feature_labels, .default = feature)) %>%
      select(project, feature_label, value) %>%
      pivot_wider(names_from = feature_label, values_from = value) %>%
      arrange(project)
    datatable(wide_data, options = list(pageLength = 10), filter = 'top')
  })
}

# ------------------------- Run App -------------------------
shinyApp(ui, server)

```
```{r}
library(shiny)
library(readr)
library(dplyr)
library(tidyr)
library(plotly)
library(DT)
library(jsonlite)
library(tools)

# ------------------------- Data Loaders -------------------------

# ① CSV for Heatmap
load_project_data <- function(project_name) {
  file_path <- paste0(project_name, ".csv")
  if (!file.exists(file_path)) {
    return(list(error = TRUE, message = paste0("Cannot find: ", file_path)))
  }
  raw <- tryCatch(read_csv(file_path, show_col_types = FALSE), error = function(e) NULL)
  if (is.null(raw)) return(list(error = TRUE, message = paste0("Failed to parse: ", file_path)))

  names(raw) <- gsub("\\n|\\r", " ", names(raw))
  cs_col <- grep("cosine|Cosine|cos_sim|cosine similarity", names(raw), ignore.case = TRUE, value = TRUE)[1]
  ed_col <- grep("euclid|Euclidean|euclid distance", names(raw), ignore.case = TRUE, value = TRUE)[1]
  w1_col <- grep("^word1$|^word_1$|^word$|^term1$", names(raw), ignore.case = TRUE, value = TRUE)[1]
  w2_col <- grep("^word2$|^word_2$|^adj$|^term2$", names(raw), ignore.case = TRUE, value = TRUE)[1]

  if (is.na(w1_col) || is.na(w2_col) || (is.na(cs_col) && is.na(ed_col))) {
    return(list(error = TRUE, message = paste0("CSV missing expected columns in ", file_path)))
  }

  df <- raw %>% rename(Word1 = !!w1_col, Word2 = !!w2_col)
  if (!is.na(cs_col)) df <- df %>% rename(Cosine = !!cs_col)
  if (!is.na(ed_col)) df <- df %>% rename(Euclid = !!ed_col)

  wide <- df %>%
    pivot_wider(names_from = Word2, values_from = c(Cosine, Euclid), names_sep = "_") %>%
    as.data.frame()

  cosine_matrix <- NULL
  euclid_matrix <- NULL

  if (any(startsWith(names(wide), "Cosine_"))) {
    cm <- wide %>% select(starts_with("Cosine_")) %>% as.matrix()
    rownames(cm) <- wide$Word1
    colnames(cm) <- gsub("Cosine_", "", colnames(cm))
    cosine_matrix <- cm
  }

  if (any(startsWith(names(wide), "Euclid_"))) {
    em <- wide %>% select(starts_with("Euclid_")) %>% as.matrix()
    rownames(em) <- wide$Word1
    colnames(em) <- gsub("Euclid_", "", colnames(em))
    euclid_matrix <- em
  }

  return(list(
    error = FALSE,
    raw_data = df,
    cosine_matrix = cosine_matrix,
    euclidean_matrix = euclid_matrix,
    project_name = project_name
  ))
}

# ② sentence_statistics.json for English variation
load_sentence_stats <- function(json_path = "sentence_statistics.json") {
  if (!file.exists(json_path)) return(NULL)
  tryCatch({
    data <- fromJSON(json_path)
    df <- tibble::enframe(data, name = "project", value = "stats") %>%
      unnest_wider(stats) %>%
      pivot_longer(cols = c("african_english", "standard_english"),
                   names_to = "type", values_to = "count") %>%
      group_by(project) %>%
      mutate(percentage = count / sum(count) * 100) %>%
      ungroup()
    df
  }, error = function(e) NULL)
}

# ③ POS feature JSON for Radar/Bar
load_pos_json <- function(project_name) {
  # e.g. project_name = "lsm_result0" → file "lsm_results0.json"
  json_path <- paste0(gsub("result", "results", project_name), ".json")
  if (!file.exists(json_path)) return(NULL)
  js <- tryCatch(fromJSON(readChar(json_path, file.info(json_path)$size)), error = function(e) NULL)
  if (is.null(js)) return(NULL)
  data.frame(
    feature = names(js),
    value = as.numeric(unlist(js)),
    project = project_name,
    stringsAsFactors = FALSE
  )
}

feature_labels <- c(
  adverb = "Adverb", conj = "Conjunction", clout = "Clout",
  auxverb = "Aux Verb", analytic_thinking = "Analytic Thinking",
  article = "Article", ipron = "Impersonal Pronoun", negate = "Negation",
  authentic = "Authenticity", tone = "Tone",
  prep = "Preposition", ppron = "Personal Pronoun", lsm = "LSM"
)

# ------------------------- UI -------------------------

ui <- fluidPage(
  titlePanel("Unified LSM Dashboard"),
  sidebarLayout(
    sidebarPanel(
      h4("Controls"),
      selectInput("project_select", "Select Project:",
                  choices = paste0("lsm_result", 0:19), selected = "lsm_result0"),
      radioButtons("metric", "Heatmap Metric:",
                   choices = c("Cosine Similarity" = "cosine", "Euclidean Distance" = "euclidean"),
                   selected = "cosine"),
      sliderInput("font_size", "Font Size", min = 8, max = 20, value = 12),
      actionButton("refresh_all", "Refresh All")
    ),
    mainPanel(
      h3("Heatmap"),
      plotlyOutput("heatmap_plot", height = "700px"),
      DTOutput("heatmap_table"),
      hr(),
      h3("English Variation"),
      plotlyOutput("engvar_plot", height = "500px"),
      DTOutput("engvar_table"),
      hr(),
      h3("POS Features"),
      plotlyOutput("pos_radar", height = "450px"),
      plotlyOutput("pos_bar", height = "350px"),
      DTOutput("pos_table")
    )
  )
)

# ------------------------- SERVER -------------------------

server <- function(input, output, session) {
  proj_cache <- reactiveVal(list())
  sentence_stats_data <- reactiveVal(load_sentence_stats())

  observeEvent(input$refresh_all, {
    proj_cache(list())
    sentence_stats_data(load_sentence_stats())
  })

  # Heatmap reactive
  selected_data <- reactive({
    pname <- input$project_select
    cache <- proj_cache()
    if (!is.null(cache[[pname]])) return(cache[[pname]])
    res <- load_project_data(pname)
    cache[[pname]] <- res
    proj_cache(cache)
    res
  })

  # Heatmap Plot
  output$heatmap_plot <- renderPlotly({
    dat <- selected_data()
    if (is.null(dat) || dat$error) {
      return(plot_ly() %>% layout(title = dat$message %||% "Data not loaded"))
    }
    if (input$metric == "cosine") {
      mat <- dat$cosine_matrix
      if (is.null(mat)) return(plot_ly() %>% layout(title = "No cosine similarity data"))
      zmin <- -1; zmax <- 1
      title <- paste(dat$project_name, "- Cosine Similarity")
    } else {
      mat <- dat$euclidean_matrix
      if (is.null(mat)) return(plot_ly() %>% layout(title = "No Euclidean distance data"))
      zmin <- min(mat, na.rm = TRUE); zmax <- max(mat, na.rm = TRUE)
      title <- paste(dat$project_name, "- Euclidean Distance")
    }
    plot_ly(z = mat, x = colnames(mat), y = rownames(mat),
            type = "heatmap", zmin = zmin, zmax = zmax, colorscale = "Viridis") %>%
      layout(title = title, xaxis = list(title = "Word2"), yaxis = list(title = "Word1"))
  })

  # Heatmap Table
  output$heatmap_table <- renderDT({
    dat <- selected_data()
    if (is.null(dat) || dat$error) return(datatable(data.frame(Message = dat$message)))
    datatable(dat$raw_data, options = list(pageLength = 8))
  })

  # English Variation Plot
  output$engvar_plot <- renderPlotly({
    df <- sentence_stats_data()
    if (is.null(df)) return(plot_ly() %>% layout(title = "sentence_statistics.json not found"))
    plot_ly(df, x = ~project, y = ~percentage, color = ~type, type = "bar",
            text = ~paste0(round(percentage,1), "%"), hoverinfo = "text") %>%
      layout(barmode = "stack", title = "English Variation",
             xaxis = list(title = "Project"), yaxis = list(title = "Percentage (%)"))
  })

  output$engvar_table <- renderDT({
    df <- sentence_stats_data()
    if (is.null(df)) return(datatable(data.frame(Message = "No data")))
    wide <- df %>%
      select(project, type, count, percentage) %>%
      pivot_wider(names_from = type, values_from = c(count, percentage))
    datatable(wide, options = list(pageLength = 10))
  })

  # POS Radar + Bar
  output$pos_radar <- renderPlotly({
    pd <- load_pos_json(input$project_select)
    if (is.null(pd) || nrow(pd) == 0) return(plot_ly() %>% layout(title = "No POS data"))
    order_features <- intersect(names(feature_labels), pd$feature)
    radar_df <- pd %>% filter(feature %in% order_features) %>% arrange(match(feature, order_features))
    r_vals <- c(radar_df$value, radar_df$value[1])
    theta_vals <- c(unname(feature_labels[radar_df$feature]), unname(feature_labels[radar_df$feature[1]]))
    plot_ly(type = 'scatterpolar', r = r_vals, theta = theta_vals, fill = 'toself', name = input$project_select) %>%
      layout(title = paste(input$project_select, "POS Feature Radar"),
             polar = list(radialaxis = list(visible = TRUE, range = c(0, 1))))
  })

  output$pos_bar <- renderPlotly({
    pd <- load_pos_json(input$project_select)
    if (is.null(pd) || nrow(pd) == 0) return(plot_ly() %>% layout(title = "No POS data"))
    data <- pd %>%
      mutate(feature_label = recode(feature, !!!feature_labels, .default = feature)) %>%
      arrange(match(feature_label, unname(feature_labels)))
    plot_ly(data, x = ~feature_label, y = ~value, type = 'bar',
            text = ~round(value,3), hoverinfo = 'text') %>%
      layout(title = paste(input$project_select, "POS Feature Values"),
             xaxis = list(tickangle = 45), yaxis = list(range = c(0,1)))
  })

  output$pos_table <- renderDT({
    all_json <- lapply(paste0("lsm_result", 0:19), load_pos_json)
    all_data <- do.call(rbind, all_json)
    if (is.null(all_data)) return(datatable(data.frame(Message = "No POS data")))
    wide_data <- all_data %>%
      mutate(feature_label = recode(feature, !!!feature_labels, .default = feature)) %>%
      select(project, feature_label, value) %>%
      pivot_wider(names_from = feature_label, values_from = value) %>%
      arrange(project)
    datatable(wide_data, options = list(pageLength = 10), filter = 'top')
  })
}

# ------------------------- Run App -------------------------
shinyApp(ui, server)

```

